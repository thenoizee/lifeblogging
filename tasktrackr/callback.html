<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting... - TaskTrackr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .dark body { background-color: #111827; color: #f3f4f6; }
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-white">

    <div id="status-container" class="text-center p-8 rounded-2xl bg-gray-800 border border-gray-700 shadow-2xl max-w-sm w-full mx-4">
        <div id="loading-icon" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
        <div id="error-icon" class="hidden text-red-500 text-5xl mb-4"><i class="fa-solid fa-circle-exclamation"></i></div>
        <div id="success-icon" class="hidden text-green-500 text-5xl mb-4"><i class="fa-solid fa-check-circle"></i></div>
        
        <h2 id="status-title" class="text-xl font-bold mb-2">Connecting to TickTick</h2>
        <p id="status-message" class="text-gray-400 text-sm">Please wait while we verify your account...</p>
        
        <a id="return-btn" href="/" class="hidden mt-6 inline-block w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold transition">Return to App</a>
    </div>

    <script type="module">
        import { TICKTICK_CLIENT_ID, TICKTICK_CLIENT_SECRET, TICKTICK_REDIRECT_URI } from './api_keys.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8", authDomain: "sammy-7298f.firebaseapp.com", projectId: "sammy-7298f", storageBucket: "sammy-7298f.firebasestorage.app", messagingSenderId: "963185683535", appId: "1:963185683535:web:807df8941feba46c208e3a", measurementId: "G-JT1YF2ELN3" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const updateStatus = (title, msg, type = 'loading') => {
            document.getElementById('status-title').textContent = title;
            document.getElementById('status-message').textContent = msg;
            
            document.getElementById('loading-icon').classList.add('hidden');
            document.getElementById('error-icon').classList.add('hidden');
            document.getElementById('success-icon').classList.add('hidden');
            document.getElementById('return-btn').classList.remove('hidden');

            if (type === 'loading') {
                document.getElementById('loading-icon').classList.remove('hidden');
                document.getElementById('return-btn').classList.add('hidden');
            } else if (type === 'error') {
                document.getElementById('error-icon').classList.remove('hidden');
            } else if (type === 'success') {
                document.getElementById('success-icon').classList.remove('hidden');
            }
        };

        const processAuth = async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state') || '/'; // Default return path
            
            // Set the return button link just in case auto-redirect fails
            document.getElementById('return-btn').href = state;

            if (!code) {
                updateStatus("Error", "No authentication code found.", "error");
                return;
            }

            try {
                // 1. Exchange Code for Token
                const credentials = btoa(`${TICKTICK_CLIENT_ID}:${TICKTICK_CLIENT_SECRET}`);
                const response = await fetch('https://ticktick.com/oauth/token', { 
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', 
                        'Authorization': `Basic ${credentials}`
                    }, 
                    body: new URLSearchParams({
                        code: code, 
                        grant_type: 'authorization_code', 
                        scope: 'tasks:read tasks:write', 
                        redirect_uri: TICKTICK_REDIRECT_URI
                    }) 
                });
                
                const data = await response.json();

                if (!data.access_token) {
                    throw new Error(data.error_description || "Failed to retrieve access token.");
                }

                // 2. Save Token to Firebase
                // We need to wait for Auth to initialize to get the UID
                updateStatus("Saving...", "Linking to your account...");
                
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    unsubscribe(); // Only run once
                    if (user) {
                        try {
                            // Store token in Firestore under the user's ID
                            await setDoc(doc(db, 'users', user.uid, 'services', 'ticktick'), { 
                                token: data.access_token, 
                                updatedAt: new Date() 
                            }, { merge: true });
                            
                            // Also update local storage for immediate use
                            localStorage.setItem('ticktick_token', data.access_token);
                            
                            updateStatus("Success!", "Redirecting you back...", "success");
                            
                            // 3. Redirect back to origin
                            setTimeout(() => {
                                window.location.href = state;
                            }, 1500);

                        } catch (dbError) {
                            console.error(dbError);
                            updateStatus("Database Error", "Could not save token to cloud.", "error");
                        }
                    } else {
                        updateStatus("Authentication Error", "You must be logged in to Lifeblogging Hub.", "error");
                    }
                });

            } catch (error) {
                console.error(error);
                updateStatus("Connection Failed", error.message, "error");
            }
        };

        // Run on load
        processAuth();
    </script>
</body>
</html>