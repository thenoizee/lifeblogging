<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaskTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512' fill='%233b82f6'%3E%3Cpath d='M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; --primary-hover: #2563eb;
            --bg-dark: #111827; --card-dark: #1f2937; --text-dark: #f9fafb;
            --bg-light: #f3f4f6; --card-light: #ffffff; --text-light: #111827;
        }
        .dark { --bg: var(--bg-dark); --card: var(--card-dark); --text: var(--text-dark); }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); transition: 0.3s; padding-bottom: 0; overflow: hidden; }
        .card { background-color: var(--card); transition: all 0.2s; position: relative; overflow: hidden; }
        .btn-primary { background-color: var(--primary); color: white; transition: 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .nav-tab { padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 600; color: #6b7280; }
        .nav-tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        .nav-tab.active { color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .filter-chip.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        .task-checkbox { appearance: none; width: 1.25rem; height: 1.25rem; border: 2px solid #4b5563; border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s; }
        .task-checkbox:checked { background-color: var(--primary); border-color: var(--primary); }
        .task-checkbox:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; }
        
        /* Side Pane */
        #side-pane { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease; }
        .side-pane-mobile { transform: translateX(100%); position: fixed; top: 0; right: 0; bottom: 0; width: 100%; z-index: 50; }
        .side-pane-mobile.open { transform: translateX(0); }
        @media (min-width: 1024px) {
            .side-pane-desktop { position: static; width: 0; opacity: 0; overflow: hidden; border-left: 0; transform: none !important; }
            .side-pane-desktop.open { width: 600px; opacity: 1; border-left: 1px solid #374151; }
        }

        #side-pane-overlay { transition: opacity 0.3s ease; }
        
        /* Calendar Responsive Fixes */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #374151; border: 1px solid #374151; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day { min-height: 100px; background: var(--card); padding: 0.5rem; transition: background 0.2s; cursor: pointer; position: relative; }
        @media (max-width: 640px) {
            .calendar-day { min-height: 60px; padding: 2px; }
            .calendar-day .day-label { font-size: 0.65rem; }
            .calendar-day .task-dots-container { flex-direction: row; flex-wrap: wrap; gap: 2px; justify-content: center; }
        }
        .calendar-day:hover { background: var(--bg); }
        .calendar-day.today { background: rgba(59, 130, 246, 0.1); }
        .calendar-day.drag-over { background: rgba(59, 130, 246, 0.3); box-shadow: inset 0 0 0 2px var(--primary); }
        .calendar-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 2px; }

        .kanban-col { min-width: 300px; max-width: 320px; flex-shrink: 0; display: flex; flex-direction: column; background-color: rgba(31, 41, 55, 0.5); border-radius: 0.75rem; padding: 0.75rem; border: 1px solid rgba(75, 85, 99, 0.4); }
        /* Kanban Mobile Fix */
        @media (max-width: 640px) {
            .kanban-col { min-width: 85vw; max-width: 85vw; }
        }
        .kanban-body { flex-grow: 1; overflow-y: auto; min-height: 150px; }
        .kanban-header { font-weight: 700; font-size: 0.875rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; color: #9ca3af; }
        
        .sortable-ghost { opacity: 0.4; background: #374151; border: 2px dashed #4b5563; }
        .sortable-drag { cursor: grabbing; opacity: 1; transform: rotate(2deg); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }

        .filter-chip.drag-over { background-color: var(--primary) !important; transform: scale(1.1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); z-index: 50; }
        .card.dragging { opacity: 0.5; border: 2px dashed #4b5563; }
        .card.selected { background-color: rgba(30, 58, 138, 0.3); border-color: #3b82f6; }

        .pomo-widget { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pomo-widget.minimized { width: 50px; height: 50px; overflow: hidden; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .pomo-widget.minimized .pomo-content { display: none; }
        .pomo-widget.minimized .pomo-icon { display: block; font-size: 1.5rem; }
        .pomo-icon { display: none; }

        /* Compact Mode Logic - Updated for View Compatibility */
        .compact-mode #simple-list .card, 
        .compact-mode .task-group .card { padding: 0; margin-bottom: 2px; font-size: 0.85rem; display: flex; align-items: center; border-radius: 4px; height: 42px; }
        
        .compact-mode #simple-list .card .card-inner,
        .compact-mode .task-group .card .card-inner { padding: 0.25rem 0.75rem; display: flex; align-items: center; width: 100%; }
        
        .compact-mode #simple-list .card h3,
        .compact-mode .task-group .card h3 { font-size: 0.9rem; font-weight: 500; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .compact-mode #simple-list .card .task-checkbox,
        .compact-mode .task-group .card .task-checkbox { width: 1rem; height: 1rem; }
        
        .compact-mode #simple-list .card .task-details-wrapper,
        .compact-mode .task-group .card .task-details-wrapper { display: flex; align-items: center; width: 100%; gap: 8px; }
        
        .compact-mode #simple-list .card .desc-preview, 
        .compact-mode #simple-list .card .card-meta span.desc-hidden,
        .compact-mode .task-group .card .desc-preview,
        .compact-mode .task-group .card .card-meta span.desc-hidden { display: none !important; }
        
        .compact-mode #simple-list .card .card-meta,
        .compact-mode .task-group .card .card-meta { margin: 0 0 0 auto; gap: 6px; }
        
        .compact-mode .tag-badge { padding: 0 3px; font-size: 8px; }

        /* Overrides for Non-List Views in Compact Mode */
        .compact-mode .kanban-col .card,
        .compact-mode .quadrant .card {
            font-size: 0.85rem;
            padding: 0.5rem;
            display: block; /* Force block to prevent breaking layout */
            height: auto;
        }
        .compact-mode .kanban-col .card h3,
        .compact-mode .quadrant .card h3 {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: normal; /* Allow wrapping */
        }
        .compact-mode .kanban-col .card .desc-preview,
        .compact-mode .quadrant .card .desc-preview {
            display: none; /* Still hide description to be "compact" */
        }
        
        .eisenhower-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; height: calc(100vh - 180px); }
        @media (min-width: 768px) {
            .eisenhower-grid { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        }
        .quadrant { background: rgba(17, 24, 39, 0.6); border: 1px solid #374151; border-radius: 1rem; padding: 1rem; display: flex; flex-direction: column; overflow: hidden; }
        .quadrant-header { font-weight: 800; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; }
        .quadrant-body { overflow-y: auto; flex-grow: 1; padding-right: 4px; }
        
        .priority-5 { border-color: #ef4444; } .priority-5:checked { background-color: #ef4444; border-color: #ef4444; }
        .priority-3 { border-color: #eab308; } .priority-3:checked { background-color: #eab308; border-color: #eab308; }
        .priority-1 { border-color: #3b82f6; } .priority-1:checked { background-color: #3b82f6; border-color: #3b82f6; }

        .project-color-strip { width: 4px; height: 100%; position: absolute; left: 0; top: 0; bottom: 0; border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
        
        .group-header { font-size: 0.85rem; font-weight: 700; color: #9ca3af; margin: 1.5rem 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: flex-end; }
        .group-header:first-child { margin-top: 0; }
        .group-header.overdue { color: #ef4444; border-color: #7f1d1d; }
        .group-header.today { color: #3b82f6; border-color: #1e3a8a; }

        .fab-add { position: fixed; bottom: 2rem; right: 2rem; width: 3.5rem; height: 3.5rem; border-radius: 50%; background-color: var(--primary); color: white; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); z-index: 40; display: flex; items-center; justify-content: center; font-size: 1.5rem; transition: all 0.3s; }
        .fab-add:hover { transform: scale(1.1); background-color: var(--primary-hover); }
        .fab-add:active { transform: scale(0.95); }

        .timeline-line { position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, transparent, #374151 10%, #374151 90%, transparent); z-index: 0; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="sticky top-0 bg-[var(--card)] shadow-lg z-30 shrink-0">
    <div class="container mx-auto px-4 py-2">
        <div class="flex items-center justify-between mb-2 mt-1">
            <div class="flex items-center space-x-4">
                <a href="/" class="btn-primary text-xs font-bold py-1.5 px-3 rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-1">
                    <i class="fa-solid fa-arrow-left"></i> Hub
                </a>
                <a href="#" class="flex items-center space-x-2 text-2xl font-bold text-[var(--primary)]">
                    <i class="fa-solid fa-check-double"></i>
                    <span class="hidden sm:inline tracking-tight">TaskTrackr</span>
                </a>
                <div class="hidden sm:flex items-center bg-gray-800/50 px-3 py-1 rounded-full border border-gray-700/50">
                    <span id="header-task-count" class="text-sm font-bold text-[var(--primary)]">0</span>
                    <span class="text-xs text-gray-500 ml-1">tasks</span>
                </div>
            </div>

            <nav class="flex space-x-1 bg-gray-800/30 p-1 rounded-lg">
                <button onclick="window.setView('classic')" class="nav-tab active text-xs sm:text-sm" id="tab-classic"><i class="fa-solid fa-list mr-1"></i> List</button>
                <button onclick="window.setView('eisenhower')" class="nav-tab text-xs sm:text-sm" id="tab-eisenhower"><i class="fa-solid fa-border-all mr-1"></i> Matrix</button>
                <button onclick="window.setView('kanban')" class="nav-tab text-xs sm:text-sm" id="tab-kanban"><i class="fa-brands fa-trello mr-1"></i> Board</button>
                <button onclick="window.setView('calendar')" class="nav-tab text-xs sm:text-sm" id="tab-calendar"><i class="fa-regular fa-calendar mr-1"></i> Calendar</button>
                <button onclick="window.setView('timeline')" class="nav-tab text-xs sm:text-sm" id="tab-timeline"><i class="fa-solid fa-timeline mr-1"></i> Timeline</button>
            </nav>

            <div class="flex items-center space-x-2">
                <select id="sort-filter" onchange="window.updateFilter('sortMode', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded-lg px-2 py-1.5 outline-none focus:border-[var(--primary)] hidden lg:block">
                    <option value="date">By Date</option>
                    <option value="alpha">A-Z</option>
                </select>

                <div class="relative hidden md:block">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="search-input" placeholder="Search..." class="bg-gray-800 border border-gray-700 rounded-lg py-1.5 pl-8 pr-4 text-xs focus:border-blue-500 focus:outline-none w-32 transition-all focus:w-48 text-gray-200" oninput="window.handleSearch(this.value)">
                </div>

                <button onclick="window.toggleCompactMode()" class="p-2 rounded-lg hover:bg-gray-800 transition text-gray-400" title="Toggle Compact View">
                    <i class="fa-solid fa-compress" id="compact-icon"></i>
                </button>
                <button onclick="window.togglePomo()" class="p-2 rounded-lg hover:bg-gray-800 transition text-gray-400 hover:text-red-400" title="Focus Timer"><i class="fa-solid fa-stopwatch"></i></button>
                <button onclick="window.refreshData()" class="p-2 rounded-lg hover:bg-gray-800 transition"><i class="fa-solid fa-arrows-rotate text-gray-400 hover:text-[var(--primary)]"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-2 overflow-x-auto hide-scroll pb-1 pt-1 lg:hidden">
            <div class="flex gap-2" id="filter-container">
                <button onclick="window.setFilter('focus')" class="filter-chip px-3 py-1 rounded-full border border-orange-500/30 text-orange-400 text-xs font-bold transition whitespace-nowrap bg-orange-900/10 hover:bg-orange-900/20" data-drop-action="today"><i class="fa-solid fa-fire mr-1"></i> Focus</button>
                <button onclick="window.setFilter('inbox')" class="filter-chip active px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]" data-drop-action="inbox">Inbox</button>
                <button onclick="window.setFilter('today')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]" data-drop-action="today">Today</button>
                <button onclick="window.setFilter('tomorrow')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]" data-drop-action="tomorrow">Tomorrow</button>
                <button onclick="window.setFilter('overdue')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-red-500">Overdue</button>
                <button onclick="window.setFilter('completed')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-green-500">Completed</button>
                <button onclick="window.setFilter('all')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]">All Active</button>
                <button onclick="window.setFilter('projects')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-purple-500">Projects</button>
            </div>
            
            <div class="w-px h-5 bg-gray-700 mx-1 flex-shrink-0"></div>
            
            <select onchange="window.updateFilter('sortMode', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded-lg px-2 py-1 outline-none focus:border-[var(--primary)] max-w-[100px]">
                <option value="date">By Date</option>
                <option value="alpha">A-Z</option>
            </select>

            <select id="project-filter" onchange="window.updateFilter('projectId', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded-lg px-2 py-1 outline-none focus:border-[var(--primary)] max-w-[100px]">
                <option value="all">All Lists</option>
            </select>
            
            <button onclick="window.resetFilters()" class="text-xs text-gray-500 hover:text-white whitespace-nowrap ml-auto" title="Reset Filters"><i class="fa-solid fa-filter-circle-xmark"></i></button>
        </div>
    </div>
</header>

    <main class="flex-grow container mx-auto px-4 py-4 relative flex items-start gap-4 overflow-hidden h-[calc(100vh-100px)]">
    
    <div id="project-sidebar" class="w-64 bg-[#1f2937] h-full rounded-xl flex flex-col hidden lg:flex shrink-0 border border-gray-800 shadow-xl overflow-hidden">
        <div class="p-4 border-b border-gray-700 bg-gray-800/50">
             <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Navigation</h2>
        </div>
        <div class="overflow-y-auto flex-grow p-3 space-y-1" id="sidebar-list">
            </div>
        <div class="p-3 border-t border-gray-700 bg-gray-800/50">
            <button onclick="window.openProjectModal()" class="w-full py-2 flex items-center justify-center gap-2 text-sm font-bold text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition border border-dashed border-gray-600 hover:border-gray-500">
                <i class="fa-solid fa-plus"></i> Add Project
            </button>
        </div>
    </div>

    <div id="main-content-wrapper" class="flex-grow flex flex-col h-full min-w-0 transition-all duration-300">
        <div id="quick-add-container" class="mb-4 relative group z-0 shrink-0">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="fa-solid fa-plus text-gray-500 group-focus-within:text-[var(--primary)] transition-colors"></i>
            </div>
            <input type="text" 
                   id="quick-add-input"
                   class="w-full bg-[var(--card)] border border-gray-700 text-gray-200 text-sm rounded-xl pl-10 pr-16 py-3 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-gray-500" 
                   placeholder="Add a task to 'Inbox'..."
                   onkeydown="window.handleQuickAdd(event)">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <span class="text-[10px] text-gray-600 border border-gray-700 px-1.5 py-0.5 rounded bg-gray-800">↵</span>
            </div>
        </div>
        <div id="content" class="flex-grow overflow-y-auto pr-2 pb-20"></div>
    </div>
    
    <div id="side-pane" class="bg-[#1a202c] shadow-2xl flex flex-col transition-all duration-300 side-pane-desktop side-pane-mobile h-full rounded-xl">
        <div class="flex items-center justify-between p-6 border-b border-gray-800 bg-[#1f2937] shrink-0">
            <div>
                <span id="sp-project" class="text-[10px] font-bold uppercase tracking-widest text-blue-400 mb-1 block">Inbox</span>
                <h2 class="text-xl font-bold text-white">Task Details</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="window.closeSidePane()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
        </div>
        
        <div class="flex-grow p-6 overflow-y-auto space-y-6">
            <div class="flex items-start gap-3">
                <input type="checkbox" id="sp-checkbox" class="task-checkbox mt-1">
                <div class="flex-grow">
                     <textarea id="sp-title-edit" onblur="window.saveSidePaneChanges('title')" class="w-full bg-transparent border-none text-2xl font-bold text-white outline-none resize-none p-0 focus:ring-0 leading-tight" rows="1" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                </div>
            </div>

            <div class="flex flex-wrap gap-2" id="sp-tags-container"></div>
            
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Due Date</label>
                    <div class="flex items-center text-gray-300"><i class="fa-regular fa-clock mr-2 text-[var(--primary)]"></i><span id="sp-date">No date</span></div>
                </div>
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Priority</label>
                    <div id="sp-priority-container" class="text-gray-300">None</div>
                </div>
            </div>

            <div id="sp-recurring-container" class="hidden flex items-center p-3 rounded-lg bg-yellow-900/10 border border-yellow-700/30 text-yellow-500 text-sm">
                <i class="fa-solid fa-repeat mr-3"></i>
                <span id="sp-recurring">Recurring Task</span>
            </div>

            <div class="space-y-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase">Description</h3>
                <div class="bg-gray-800/30 p-4 rounded-xl border border-gray-700/50 min-h-[100px]">
                    <p id="sp-desc" onblur="window.saveSidePaneChanges('desc')" class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap placeholder-gray-600 outline-none" contenteditable="true" data-placeholder="Add notes..."></p>
                </div>
            </div>
            
            <div id="sp-checklist-section" class="space-y-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase">Subtasks</h3>
                <div id="sp-checklist-items" class="space-y-1"></div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-800 bg-[#1f2937] flex flex-col gap-3 shrink-0">
             <div class="flex gap-3">
                 <button id="sp-trash-btn" class="p-3 bg-gray-800 hover:bg-red-900/30 text-gray-400 hover:text-red-400 rounded-xl transition" title="Delete"><i class="fa-solid fa-trash"></i></button>
                 <button id="sp-edit-btn" class="p-3 bg-gray-800 hover:bg-blue-900/30 text-gray-400 hover:text-blue-400 rounded-xl transition" title="Full Edit"><i class="fa-solid fa-pen"></i></button>
                 <button id="sp-complete-btn" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition">
                    <i class="fa-solid fa-check"></i> Complete
                </button>
             </div>
             <button id="sp-stop-repeat-btn" class="hidden text-xs text-red-400 hover:text-red-300 text-center py-1">Stop Repeating</button>
        </div>
    </div>
    
    <button onclick="window.openAddTaskModal()" class="fab-add" title="Create New Task">
        <i class="fa-solid fa-plus"></i>
    </button>
</main>
<div id="pomo-widget" class="fixed bottom-6 left-6 z-50 bg-[var(--card)] border border-gray-700 shadow-2xl rounded-2xl p-4 pomo-widget w-64 hidden" onclick="window.maximizePomo()">
        <i class="fa-solid fa-stopwatch text-red-500 pomo-icon"></i>
        <div class="pomo-content">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold flex items-center gap-2"><i class="fa-solid fa-bullseye text-red-500"></i> Focus</h3>
                <button onclick="window.minimizePomo(event)" class="text-gray-500 hover:text-white"><i class="fa-solid fa-minus"></i></button>
            </div>
            <div class="text-4xl font-mono font-bold text-center mb-4 tracking-wider" id="pomo-timer">25:00</div>
            <div class="flex gap-2">
                <button id="pomo-toggle" onclick="window.togglePomoTimer(event)" class="flex-1 bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 rounded transition">Start</button>
                <button onclick="window.resetPomo(event)" class="px-3 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded transition"><i class="fa-solid fa-rotate-left"></i></button>
            </div>
        </div>
    </div>

    <div id="side-pane-overlay" class="fixed inset-0 bg-black/60 z-40 hidden opacity-0 lg:hidden" onclick="window.closeSidePane()"></div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700 animate-fade max-h-[90vh] overflow-y-auto flex flex-col">
            <h3 class="text-xl font-bold mb-4" id="modal-title">New Task</h3>
            <input type="hidden" id="modal-task-id">
            
            <div class="space-y-4 flex-grow overflow-y-auto pr-2">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Title</label><input type="text" id="modal-title-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm" placeholder="What needs to be done?"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Description</label><textarea id="modal-desc-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm resize-none" rows="2" placeholder="Details..."></textarea></div>
                
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Subtasks</label>
                        <button type="button" onclick="window.addChecklistItem()" class="text-xs text-[var(--primary)] hover:text-white font-bold">+ Add Item</button>
                    </div>
                    <div id="checklist-builder" class="space-y-2"></div>
                </div>

                <div><label class="text-xs font-bold text-gray-500 uppercase">Project</label>
                <select id="modal-project-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></select></div>

                <div><label class="text-xs font-bold text-gray-500 uppercase">Tags</label><input type="text" id="modal-tags-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm" placeholder="tag1, tag2"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Start Date</label><input type="datetime-local" id="modal-start-date" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Due Date</label><input type="datetime-local" id="modal-due-date" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Priority</label><select id="modal-priority-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"><option value="0">None</option><option value="1">Low</option><option value="3">Medium</option><option value="5">High</option></select></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Repeat</label><select id="modal-repeat-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"><option value="">None</option><option value="RRULE:FREQ=DAILY;INTERVAL=1">Daily</option><option value="RRULE:FREQ=WEEKLY;INTERVAL=1">Weekly</option><option value="RRULE:FREQ=MONTHLY;INTERVAL=1">Monthly</option><option value="RRULE:FREQ=YEARLY;INTERVAL=1">Yearly</option></select></div>
                </div>
                <div class="flex items-center"><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="modal-allday-input" class="task-checkbox"><span class="text-sm">All Day</span></label></div>
            </div>
            <div class="flex gap-3 mt-6 pt-4 border-t border-gray-700">
                <button onclick="document.getElementById('task-modal').classList.add('hidden')" class="w-full py-3 rounded-lg font-bold text-sm bg-gray-700 hover:bg-gray-600 text-white transition">Cancel</button>
                <button id="modal-submit-btn" onclick="window.submitTaskForm()" class="w-full py-3 rounded-lg font-bold text-sm btn-primary shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="project-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 animate-fade">
            <h3 class="text-xl font-bold mb-4" id="project-modal-title">Manage Project</h3>
            <input type="hidden" id="project-modal-id">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Name</label><input type="text" id="project-name-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('project-modal').classList.add('hidden')" class="w-full py-3 rounded-lg font-bold text-sm bg-gray-700 hover:bg-gray-600 text-white transition">Cancel</button>
                <button onclick="window.submitProjectForm()" class="w-full py-3 rounded-lg font-bold text-sm btn-primary shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="login-overlay" class="fixed inset-0 bg-[var(--bg)] z-40 hidden flex flex-col items-center justify-center p-6 text-center">
        <div class="p-6 rounded-full bg-blue-500/10 mb-6"><i class="fa-solid fa-check-double text-6xl text-[var(--primary)]"></i></div>
        <h1 class="text-4xl font-bold mb-2">TaskTrackr</h1>
        <p class="text-gray-500 mb-8 max-w-md">Connect your TickTick account to manage your tasks with style.</p>
        <button id="login-btn" class="btn-primary px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-blue-500/20 transition flex items-center gap-3"><i class="fa-solid fa-right-to-bracket"></i> Connect TickTick</button>
    </div>

    <div id="loader" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity">
        <div class="animate-spin rounded-full h-14 w-14 border-[5px] border-[var(--primary)] border-t-transparent"></div>
    </div>
    <div id="toast-container" class="fixed bottom-24 md:bottom-6 right-6 z-50 flex flex-col gap-3"></div>

    <div id="review-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex flex-col items-center justify-center p-4 backdrop-blur-md">
    <div class="w-full max-w-2xl flex flex-col h-full md:h-auto md:max-h-[80vh]">
        <div class="flex justify-between items-center mb-6 text-gray-400">
            <div class="flex items-center gap-3">
                <span class="bg-blue-900/30 text-blue-400 px-3 py-1 rounded-full text-xs font-bold tracking-wider uppercase border border-blue-500/20">Review Mode</span>
                <span id="review-counter" class="text-sm font-mono">0 left</span>
            </div>
            <button onclick="window.closeReviewMode()" class="hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div id="review-card-container" class="relative flex-grow flex items-center justify-center perspective-1000">
            <div id="review-empty-state" class="text-center hidden">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-500/10 mb-6">
                    <i class="fa-solid fa-check text-4xl text-green-500"></i>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">Inbox Zero!</h2>
                <p class="text-gray-500 mb-8">You've processed all tasks.</p>
                <button onclick="window.closeReviewMode()" class="btn-primary px-8 py-3 rounded-xl font-bold">Awesome</button>
            </div>
        </div>

        <div id="review-controls" class="mt-8 grid grid-cols-4 gap-4 transition-opacity duration-300">
            <button onclick="window.reviewAction('delete')" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gray-800 hover:bg-red-900/20 border border-gray-700 hover:border-red-500/50 group transition">
                <i class="fa-solid fa-trash text-xl text-gray-500 group-hover:text-red-500"></i>
                <span class="text-xs font-bold text-gray-500 group-hover:text-red-400">Delete</span>
                <span class="text-[10px] text-gray-600 bg-gray-900 px-1.5 rounded">Del</span>
            </button>
            
            <button onclick="window.reviewAction('skip')" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-gray-600 group transition">
                <i class="fa-solid fa-forward text-xl text-gray-500 group-hover:text-white"></i>
                <span class="text-xs font-bold text-gray-500 group-hover:text-gray-300">Skip</span>
                <span class="text-[10px] text-gray-600 bg-gray-900 px-1.5 rounded">→</span>
            </button>

            <div class="relative group">
                <button onclick="document.getElementById('review-date-picker').showPicker()" class="w-full h-full flex flex-col items-center gap-2 p-4 rounded-xl bg-gray-800 hover:bg-blue-900/20 border border-gray-700 hover:border-blue-500/50 transition">
                    <i class="fa-solid fa-calendar-day text-xl text-gray-500 group-hover:text-blue-500"></i>
                    <span class="text-xs font-bold text-gray-500 group-hover:text-blue-400">Schedule</span>
                    <span class="text-[10px] text-gray-600 bg-gray-900 px-1.5 rounded">S</span>
                </button>
                <input type="date" id="review-date-picker" onchange="window.reviewAction('schedule', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
            </div>

            <button onclick="window.reviewAction('complete')" class="flex flex-col items-center gap-2 p-4 rounded-xl bg-gray-800 hover:bg-green-900/20 border border-gray-700 hover:border-green-500/50 group transition">
                <i class="fa-solid fa-check text-xl text-gray-500 group-hover:text-green-500"></i>
                <span class="text-xs font-bold text-gray-500 group-hover:text-green-400">Done</span>
                <span class="text-[10px] text-gray-600 bg-gray-900 px-1.5 rounded">Enter</span>
            </button>
        </div>
        
        <div class="flex justify-center gap-4 mt-6 text-[10px] text-gray-600 font-mono uppercase tracking-widest">
            <span><span class="text-blue-500">T</span> Today</span>
            <span><span class="text-yellow-500">W</span> Tomorrow</span>
        </div>
    </div>
</div>

    <script type="module">
        import { TICKTICK_CLIENT_ID, TICKTICK_CLIENT_SECRET, TICKTICK_REDIRECT_URI } from './api_keys.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8", authDomain: "sammy-7298f.firebaseapp.com", projectId: "sammy-7298f", storageBucket: "sammy-7298f.firebasestorage.app", messagingSenderId: "963185683535", appId: "1:963185683535:web:807df8941feba46c208e3a", measurementId: "G-JT1YF2ELN3" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const API_BASE = 'https://api.ticktick.com/open/v1';
        let accessToken = localStorage.getItem('ticktick_token');
        
        const PROJECT_COLORS = [
             '#808080', '#EC6E66', '#F0A060', '#F1C40F', '#1ABC9C', '#2ECC71', '#3498DB', '#9B59B6',
             '#34495E', '#F39C12', '#D35400', '#C0392B', '#8E44AD', '#2980B9', '#27AE60', '#16A085'
        ];
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const docRef = doc(db, 'users', user.uid, 'services', 'ticktick');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().token) {
                        const dbToken = docSnap.data().token;
                        if (dbToken !== accessToken) {
                            accessToken = dbToken;
                            localStorage.setItem('ticktick_token', accessToken);
                            fetchAllData();
                        }
                    }
                } catch (e) { console.error("Error syncing with Firestore:", e); }
            }
        });
        
        let taskCache = [];
        let historyCache = [];
        try { const cached = localStorage.getItem('ticktrackr_tasks'); if (cached) taskCache = JSON.parse(cached); } catch(e) { console.error(e); }
        let projectMap = {}; // { id: { name, color } }
        let currentCalendarDate = new Date();
        let selectedTasks = new Set();
        let isSelectionMode = false;
        let lastSelectedId = null;
        let isCompactMode = localStorage.getItem('compactMode') === 'true';
        let currentState = { view: 'classic', filter: 'inbox', projectId: 'all', priority: 'all', tag: 'all', search: '', sortMode: 'date' };
        window.sectionStates = { overdue: false, today: false, tomorrow: false, later: false, noDate: false, completed: true };
        
        const els = { content: document.getElementById('content'), loader: document.getElementById('loader'), modal: document.getElementById('task-modal'), taskCounter: document.getElementById('header-task-count') };
        const escapeHtml = (unsafe) => !unsafe ? "" : unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        const stringToColor = (str) => { let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } return `hsl(${Math.abs(hash % 360)}, 70%, 25%)`; };
        const getTagBadge = (tag) => { const color = stringToColor(tag); return `<span class="tag-badge px-2 py-0.5 rounded border text-[10px] font-bold uppercase tracking-wider opacity-80" style="color: ${color}; border-color: ${color}40; background-color: ${color}10;">#${escapeHtml(tag)}</span>`; };

        const getProjectColor = (pid) => {
             const proj = projectMap[pid];
             if (!proj) return '#4b5563';
             if (proj.color) {
                 if(typeof proj.color === 'string' && proj.color.startsWith('#')) return proj.color;
                 if(typeof proj.color === 'number') return PROJECT_COLORS[proj.color % PROJECT_COLORS.length] || PROJECT_COLORS[0];
             }
             return stringToColor(pid || 'unknown');
        };

        function showLoader() { els.loader.classList.remove('hidden'); }
        function hideLoader() { els.loader.classList.add('hidden'); }
        const showToast = (msg, type = 'success', actionText = null, actionCallback = null) => {
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-900/90 border-green-500' : 'bg-red-900/90 border-red-500';
            toast.className = `p-4 rounded-xl border ${colors} text-white shadow-2xl animate-fade backdrop-blur-md min-w-[200px] flex items-center justify-between gap-4 pointer-events-auto`;
            let html = `<div class="flex items-center gap-3"><i class="fa-solid ${type==='success'?'fa-check':'fa-circle-exclamation'}"></i> <span>${msg}</span></div>`;
            if (actionText && actionCallback) html += `<button class="text-sm font-bold underline hover:text-white/80" id="toast-action-btn">${actionText}</button>`;
            toast.innerHTML = html;
            document.getElementById('toast-container').appendChild(toast);
            if (actionText && actionCallback) { toast.querySelector('#toast-action-btn').onclick = (e) => { e.stopPropagation(); actionCallback(); toast.remove(); }; }
            setTimeout(() => { if(toast.isConnected) toast.remove() }, 5000);
        };

        const api = async (endpoint, method = 'GET', body = null) => {
            if (!accessToken) return null;
            const opts = { method, headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, opts);
                if (res.status === 401) { localStorage.removeItem('ticktick_token'); location.reload(); return null; }
                const text = await res.text();
                return text ? JSON.parse(text) : {};
            } catch (e) { console.error(e); return null; }
        };

        const logTaskCompletion = async (task) => {
            if (!auth.currentUser) return;
            try { await addDoc(collection(db, 'users', auth.currentUser.uid, 'task_history'), { taskId: task.id, title: task.title, projectId: task.projectId, projectName: projectMap[task.projectId]?.name || 'Unknown', completedAt: new Date(), originalData: task }); } catch(e) {}
        };

        const fetchHistory = async () => { /* Same as previous */ 
             if (!auth.currentUser) return; showLoader(); try { const q = query(collection(db, 'users', auth.currentUser.uid, 'task_history'), orderBy('completedAt', 'desc'), limit(100)); const querySnapshot = await getDocs(q); historyCache = querySnapshot.docs.map(doc => { const data = doc.data(); const base = data.originalData || {}; return { ...base, id: data.taskId || doc.id, title: data.title || base.title || 'Untitled', projectId: data.projectId || base.projectId || 'inbox', status: 2, completedAt: data.completedAt ? (data.completedAt.toDate ? data.completedAt.toDate() : new Date(data.completedAt)) : new Date(), isHistory: true }; }); renderApp(); } catch (e) { console.error(e); showToast('Error loading history', 'error'); } hideLoader();
        };

        const fetchAllData = async () => { /* Same as previous */ 
            showLoader(); if(!document.getElementById('project-filter')) { setTimeout(fetchAllData, 100); return; } const projects = await api('/project'); if(!projects) { hideLoader(); return; } projectMap = projects.reduce((acc, p) => ({...acc, [p.id]: { name: p.name, color: p.color }}), {}); let inboxId = 'inbox'; const inboxProj = projects.find(p => p.kind === 'inbox' || p.name === 'Inbox'); if (inboxProj) inboxId = inboxProj.id; if(!projectMap[inboxId]) projectMap[inboxId] = { name: 'Inbox', color: '#3b82f6' }; const projectIds = new Set(projects.map(p => p.id)); projectIds.add(inboxId); let allActiveTasks = []; await Promise.all(Array.from(projectIds).map(async (pid) => { try { const data = await api(`/project/${pid}/data`); if(data && data.tasks) allActiveTasks.push(...data.tasks); } catch(e) {} })); const activeMap = new Map(allActiveTasks.map(t => [t.id, t])); const newCache = []; newCache.push(...allActiveTasks); taskCache.forEach(t => { if(t.status === 2 && !activeMap.has(t.id)) { newCache.push(t); } }); taskCache = Array.from(new Map(newCache.map(item => [item.id, item])).values()); localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache)); const pSelect = document.getElementById('project-filter'); if(pSelect) { pSelect.innerHTML = `<option value="all">All Lists</option>` + Object.entries(projectMap).map(([id, p]) => `<option value="${id}" ${currentState.projectId===id?'selected':''}>${escapeHtml(p.name)}</option>`).join(''); } hideLoader(); renderApp(); window.renderProjectSidebar();
        };

        let currentSidePaneTaskId = null;
        window.saveSidePaneChanges = async (field) => { /* Same as previous */ if (!currentSidePaneTaskId) return; const task = taskCache.find(t => t.id === currentSidePaneTaskId); if (!task) return; let newValue; if (field === 'title') { newValue = document.getElementById('sp-title-edit').value.trim(); if (newValue === task.title) return; task.title = newValue; } else if (field === 'desc') { newValue = document.getElementById('sp-desc').innerText; if (newValue === (task.content || '')) return; task.content = newValue; } renderApp(); try { const payload = { projectId: task.projectId, title: task.title, content: task.content }; await api(`/task/${task.id}`, 'POST', payload); } catch (e) { showToast('Failed to save changes', 'error'); console.error(e); } };

        window.renderProjectSidebar = () => {
    const listEl = document.getElementById('sidebar-list');
    if (!listEl) return;

    const renderItem = (id, label, icon, color, isAction = false, count = null) => {
        let isActive = false;
        if (currentState.filter === id) isActive = true;
        // Handle inbox specifically
        else if (currentState.filter === 'inbox' && id === 'inbox') isActive = true;
        
        const bgClass = isActive ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-800 hover:text-gray-200';
        const iconColor = isActive ? 'text-white' : (color || 'text-gray-500');
        
        let clickAction;
        if (isAction) {
            clickAction = `window.setFilter('${id}')`;
        } else {
            clickAction = `window.updateFilter('projectId', '${id}'); window.updateFilter('filter', 'all');`;
        }
        
        let countBadge = '';
        if (count !== null) {
            countBadge = `<span class="text-[10px] ml-auto opacity-60 font-mono">${count}</span>`;
        }

        return `
        <button onclick="${clickAction}" class="w-full text-left px-3 py-2 rounded-lg transition-all flex items-center gap-3 text-sm font-medium ${bgClass}">
            <i class="${icon} ${iconColor} w-4 text-center"></i>
            <span class="truncate">${escapeHtml(label)}</span>
            ${countBadge}
        </button>`;
    };

    let html = '';
    
    // START REVIEW BUTTON
    html += `<div class="mb-4 space-y-1">`;
    html += `<button onclick="window.startReviewMode()" class="w-full py-3 mb-2 flex items-center justify-center gap-2 text-xs font-bold text-white bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 rounded-xl shadow-lg transition transform active:scale-95 border border-blue-400/20">
                <i class="fa-solid fa-bolt"></i> Process Inbox
             </button>`;
    html += `</div>`;

    // STANDARD FILTERS
    html += renderItem('focus', 'Focus', 'fa-solid fa-fire', 'text-orange-500', true);
    html += renderItem('inbox', 'Inbox', 'fa-solid fa-inbox', 'text-blue-500', true);
    html += renderItem('today', 'Today', 'fa-solid fa-calendar-day', 'text-green-500', true);
    html += renderItem('tomorrow', 'Tomorrow', 'fa-solid fa-sun', 'text-yellow-500', true);
    html += renderItem('overdue', 'Overdue', 'fa-solid fa-circle-exclamation', 'text-red-500', true);
    html += renderItem('completed', 'Completed', 'fa-solid fa-check-double', 'text-gray-500', true);
    html += renderItem('all', 'All Active', 'fa-solid fa-layer-group', 'text-purple-500', true);
    
    html += `<div class="my-3 border-t border-gray-700/50"></div>`;
    
    // UPDATED PROJECTS HEADER: Includes Reset Button
    html += `<div class="px-3 py-1 text-[10px] font-bold text-gray-500 uppercase flex justify-between items-center">
                <span>Projects</span> 
                <div class="flex gap-2">
                    ${currentState.projectId !== 'all' ? 
                        `<button onclick="window.updateFilter('projectId', 'all')" class="text-[var(--primary)] hover:text-white transition" title="Clear Project Filter"><i class="fa-solid fa-filter-circle-xmark"></i></button>` 
                        : ''}
                    <button onclick="window.openProjectModal()" class="hover:text-white transition"><i class="fa-solid fa-plus"></i></button>
                </div>
             </div>`;

    // PROJECTS LIST
    const inboxId = Object.keys(projectMap).find(id => projectMap[id].name.toLowerCase() === 'inbox') || 'inbox';
    Object.entries(projectMap).forEach(([id, proj]) => {
        if (id === inboxId) return; 
        const color = getProjectColor(id);
        const iconStyle = `color: ${color}`;
        html += `<button onclick="window.updateFilter('projectId', '${id}'); window.updateFilter('filter', 'all')" 
                 class="w-full text-left px-3 py-2 rounded-lg transition-all flex items-center gap-3 text-sm font-medium ${currentState.projectId === id ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-gray-200'}">
            <i class="fa-solid fa-circle text-[10px]" style="${iconStyle}"></i>
            <span class="truncate">${escapeHtml(proj.name)}</span>
        </button>`;
    });

    listEl.innerHTML = html;
};


        /* Drag, Drop, Quick Add, Filters... (Same logic) */
        window.handleDragStart = (e, taskId) => { /*...*/ const taskEl = e.target.closest('.card'); if (!selectedTasks.has(taskId)) { if(!e.shiftKey) { selectedTasks.clear(); document.querySelectorAll('.card.selected').forEach(c => { c.classList.remove('selected'); c.querySelector('.fa-circle-check').className = 'fa-regular fa-circle text-gray-500 text-xl group-hover:text-gray-300 transition-colors'; }); } selectedTasks.add(taskId); taskEl.classList.add('selected'); const icon = taskEl.querySelector('.fa-circle, .fa-circle-check'); if(icon) icon.className = 'fa-solid fa-circle-check text-blue-400 text-xl drop-shadow-md'; updateBulkToolbar(); } taskEl.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; const tasksData = JSON.stringify(Array.from(selectedTasks)); e.dataTransfer.setData('text/plain', tasksData); };
        window.handleQuickAdd = async (e) => { /*...*/ if (e.key === 'Enter') { const input = document.getElementById('quick-add-input'); const title = input.value.trim(); if (!title) return; input.disabled = true; let pid = Object.keys(projectMap).find(id => projectMap[id].name.toLowerCase() === 'inbox') || 'inbox'; if (currentState.projectId !== 'all') { pid = currentState.projectId; } let newDateISO = null; const now = new Date(); if (currentState.filter === 'today' || currentState.filter === 'focus') { newDateISO = now.toISOString(); } else if (currentState.filter === 'tomorrow') { const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1); newDateISO = tmrw.toISOString(); } const payload = { title: title, projectId: pid, priority: 0 }; if (newDateISO) { payload.dueDate = newDateISO.replace(/\.\d{3}Z$/, '+0000'); payload.isAllDay = true; } try { await api('/task', 'POST', payload); input.value = ''; showToast('Task added'); fetchAllData(); } catch (err) { showToast('Failed to add task', 'error'); } finally { input.disabled = false; input.focus(); } } };
        const initDropZones = () => { /*...*/ const filters = document.querySelectorAll('.filter-chip'); filters.forEach(btn => { let action = btn.getAttribute('data-drop-action'); if(!action) { const text = btn.innerText.toLowerCase(); if (text.includes('today') || text.includes('focus')) action = 'today'; else if (text.includes('tomorrow')) action = 'tomorrow'; else if (text.includes('inbox')) action = 'inbox'; } if (!action) return; btn.setAttribute('data-drop-action', action); btn.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; btn.classList.add('drag-over'); }); btn.addEventListener('dragleave', (e) => { btn.classList.remove('drag-over'); }); btn.addEventListener('drop', (e) => { e.preventDefault(); btn.classList.remove('drag-over'); const actionType = btn.getAttribute('data-drop-action'); document.querySelectorAll('.card.dragging').forEach(c => c.classList.remove('dragging')); if (actionType) { window.bulkAction(actionType); } }); }); };
        document.addEventListener('dragend', () => { document.querySelectorAll('.card.dragging').forEach(c => c.classList.remove('dragging')); });

        window.toggleCompactMode = () => { isCompactMode = !isCompactMode; localStorage.setItem('compactMode', isCompactMode); const icon = document.getElementById('compact-icon'); if(isCompactMode) { els.content.classList.add('compact-mode'); icon.className = "fa-solid fa-expand"; } else { els.content.classList.remove('compact-mode'); icon.className = "fa-solid fa-compress"; } renderApp(); };

        window.setView = (view) => { currentState.view = view; document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${view}`).classList.add('active'); const quickAdd = document.getElementById('quick-add-container'); if(view === 'eisenhower' || view === 'calendar') quickAdd.classList.add('hidden'); else quickAdd.classList.remove('hidden'); renderApp(); };
        window.setFilter = (filter) => { currentState.filter = filter; document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active')); const btn = document.querySelector(`button[onclick="window.setFilter('${filter}')"]`); if(btn) btn.classList.add('active'); if (filter === 'completed') fetchHistory(); else renderApp(); };
        window.handleSearch = (text) => { currentState.search = text.toLowerCase(); renderApp(); };
        window.updateFilter = (key, val) => { currentState[key] = val; renderApp(); };
        window.resetFilters = () => { currentState.projectId = 'all'; currentState.priority = 'all'; currentState.tag = 'all'; currentState.sortMode = 'date'; document.getElementById('project-filter').value = 'all'; document.getElementById('sort-filter').value = 'date'; renderApp(); };
        window.toggleSection = (sectionName) => { window.sectionStates[sectionName] = !window.sectionStates[sectionName]; renderApp(); };

        const getFilteredTasks = () => { /* Same as previous */ if (currentState.filter === 'completed') { return historyCache; } const now = new Date(); const todayStr = now.toISOString().split('T')[0]; const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1); const tmrwStr = tmrw.toISOString().split('T')[0]; let tasks = taskCache; if (currentState.filter === 'inbox') { const inboxId = Object.keys(projectMap).find(id => projectMap[id].name.toLowerCase() === 'inbox') || 'inbox'; tasks = tasks.filter(t => (t.projectId === inboxId || t.projectId.startsWith('inbox')) && t.status === 0); } else if (currentState.filter === 'today') { tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate).toISOString().startsWith(todayStr)); } else if (currentState.filter === 'tomorrow') { tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate).toISOString().startsWith(tmrwStr)); } else if (currentState.filter === 'overdue') { tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate) < new Date(todayStr)); } else if (currentState.filter === 'focus') { tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate) < new Date(tmrwStr)); } else if (currentState.filter === 'projects') { return []; } else if (currentState.filter === 'all') { tasks = tasks.filter(t => t.status === 0); } if (currentState.projectId !== 'all') tasks = tasks.filter(t => t.projectId === currentState.projectId); if (currentState.priority !== 'all') tasks = tasks.filter(t => t.priority == currentState.priority); if (currentState.search) { tasks = tasks.filter(t => t.title.toLowerCase().includes(currentState.search) || (t.content && t.content.toLowerCase().includes(currentState.search))); } return tasks.sort((a,b) => { if (currentState.sortMode === 'alpha') { return a.title.localeCompare(b.title); } if(currentState.filter === 'focus') { const dateA = new Date(a.dueDate || '9999'); const dateB = new Date(b.dueDate || '9999'); return dateA - dateB; } if (b.priority !== a.priority) return b.priority - a.priority; return new Date(a.dueDate || '9999') - new Date(b.dueDate || '9999'); }); };
        // --- Context Menu Logic (UPDATED) ---
        let contextMenuTaskId = null;

        window.handleContextMenu = (e, taskId) => {
            e.preventDefault();
            contextMenuTaskId = taskId;
            const menu = document.getElementById('context-menu');
            
            // Boundary check
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const menuW = 200; 
            const menuH = 320; // Estimated height with new options
            
            const x = Math.min(e.clientX, winW - menuW - 10);
            const y = Math.min(e.clientY, winH - menuH - 10);
            
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.remove('hidden');
            menu.classList.add('flex');
        };

        window.handleContextAction = async (action) => {
            if (!contextMenuTaskId) return;
            const taskId = contextMenuTaskId;
            const task = taskCache.find(t => t.id === taskId);
            
            document.getElementById('context-menu').classList.add('hidden');
            if (!task) return;

            if (action === 'edit') {
                window.openSidePane(taskId);
            } else if (action === 'delete') {
                window.deleteTask(task.projectId, taskId);
            } else if (action === 'today' || action === 'tomorrow') {
                selectedTasks.clear(); selectedTasks.add(taskId);
                await window.bulkAction(action);
            } else if (action === 'complete') {
                window.completeTask(task.projectId, task.id, null);
            } else if (action === 'inbox') {
                // Move to inbox and clear date
                const inboxId = Object.keys(projectMap).find(id => projectMap[id].name.toLowerCase() === 'inbox') || 'inbox';
                task.projectId = inboxId;
                task.dueDate = null;
                renderApp(); // Optimistic
                try {
                    await api(`/task/${taskId}`, 'POST', { projectId: inboxId, dueDate: null });
                    showToast('Moved to Inbox');
                } catch(e) { showToast('Error moving task', 'error'); fetchAllData(); }
            } else if (action.startsWith('priority-')) {
                const newP = parseInt(action.split('-')[1]);
                task.priority = newP;
                renderApp();
                try {
                    await api(`/task/${taskId}`, 'POST', { projectId: task.projectId, priority: newP });
                } catch(e) { showToast('Error updating priority', 'error'); fetchAllData(); }
            }
        };

        /* Render App, Cards, Etc (Standard logic) */
        const renderApp = () => { /*...*/ if(!document.getElementById('content')) return; window.renderProjectSidebar(); const icon = document.getElementById('compact-icon'); if(isCompactMode) { els.content.classList.add('compact-mode'); icon.className = "fa-solid fa-expand"; } else { els.content.classList.remove('compact-mode'); icon.className = "fa-solid fa-compress"; } if (currentState.filter === 'projects') { renderProjectsManager(); els.taskCounter.textContent = '-'; return; } const tasks = getFilteredTasks(); els.taskCounter.textContent = tasks.length; if (currentState.view === 'eisenhower') renderEisenhower(tasks); else if (currentState.view === 'classic') renderClassic(tasks); else if (currentState.view === 'calendar') renderCalendar(tasks); else if (currentState.view === 'kanban') renderKanban(tasks); else if (currentState.view === 'timeline') renderTimeline(tasks); };

        const renderTaskCard = (task) => { /* Same as before, logic uses CSS classes now */
            const isSelected = selectedTasks.has(task.id); const now = new Date(); now.setHours(0,0,0,0); let dateBadgeHtml = ''; let isOverdue = false; if (task.dueDate) { const dueDate = new Date(task.dueDate); const dueTime = dueDate.getTime(); dueDate.setHours(0,0,0,0); const diffTime = dueDate - now; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); isOverdue = diffDays < 0 && task.status !== 2; const dateObj = new Date(task.dueDate); let dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); if (diffDays === 0) dateStr = 'Today'; else if (diffDays === 1) dateStr = 'Tomorrow'; else if (diffDays === -1) dateStr = 'Yesterday'; let timeStr = ''; let iconClass = 'fa-regular fa-clock'; if (task.isAllDay) { iconClass = 'fa-solid fa-calendar-day'; } else { timeStr = ', ' + dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } if (isOverdue) { dateBadgeHtml = `<span class="flex items-center px-2 py-0.5 rounded border bg-red-500/10 border-red-500/20 text-red-500 font-bold" title="Due on ${dateObj.toLocaleDateString()}"><i class="fa-solid fa-triangle-exclamation mr-1.5"></i><span>${dateStr}${timeStr}</span></span>`; } else { const bgClass = task.isAllDay ? 'bg-blue-500/10' : 'bg-indigo-500/10'; const textClass = task.isAllDay ? 'text-[var(--primary)]' : 'text-indigo-400'; dateBadgeHtml = `<span class="flex items-center px-2 py-0.5 rounded border ${bgClass} border-transparent ${textClass}"><i class="${iconClass} mr-1.5"></i> ${dateStr}${timeStr}</span>`; } }
            const wrapperClass = isSelected ? 'selected bg-blue-900/30 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.15)] z-10 select-none' : 'bg-[var(--card)] border-gray-800 hover:border-gray-600 hover:bg-gray-800/50 select-none';
            const isCompleted = task.status === 2; const completeIcon = isCompleted ? '<i class="fa-solid fa-circle-check text-green-500 text-xl drop-shadow-md"></i>' : `<i class="fa-regular fa-circle text-gray-500 text-xl group-hover:text-[var(--primary)] transition-colors priority-${task.priority || 0}"></i>`;
            const selectIcon = isSelected ? '<i class="fa-solid fa-square-check text-blue-400 text-lg"></i>' : '<i class="fa-regular fa-square text-gray-600 text-lg hover:text-gray-400 transition-colors"></i>';
            const project = projectMap[task.projectId] || { name: 'Unknown', color: '#4b5563' }; const pColor = getProjectColor(task.projectId); const projectBadge = `<span class="flex items-center text-gray-300 px-2 py-0.5 rounded border border-gray-700 whitespace-nowrap" style="background-color: ${pColor}20; border-color: ${pColor}40;"><i class="fa-solid fa-layer-group mr-1 opacity-50" style="color:${pColor}"></i> ${escapeHtml(project.name)}</span>`;
            const isRecurring = task.repeatFlag || (task.recurrence && task.recurrence.rule); const clickHandler = task.isHistory ? `window.openSidePane('${task.id}', true)` : `window.openSidePane('${task.id}')`;
            return `<div class="card p-0 rounded-xl border transition-all duration-200 flex group animate-fade mb-3 relative overflow-hidden ${wrapperClass}" draggable="true" ondragstart="window.handleDragStart(event, '${task.id}')" data-task-id="${task.id}" onclick="${clickHandler}" oncontextmenu="window.handleContextMenu(event, '${task.id}')"> <div class="project-color-strip" style="background-color: ${pColor}"></div> <div class="w-12 flex items-center justify-center cursor-pointer border-r border-white/5 hover:bg-white/5 transition-colors flex-shrink-0 ml-1 z-20" onclick="window.completeTask('${task.projectId}', '${task.id}', null, event)" title="Mark Completed"> ${completeIcon} </div> <div class="card-inner flex-grow p-4 min-w-0"> <div class="task-details-wrapper"> <div class="flex items-start gap-3 flex-grow min-w-0"> <div class="pt-1 flex-shrink-0 relative cursor-pointer z-20" onclick="window.toggleTaskSelection('${task.id}', event)" title="Select Task"> ${selectIcon} ${isRecurring ? '<i class="fa-solid fa-rotate-right text-[10px] absolute -right-1 -bottom-1 bg-gray-800 rounded-full px-0.5 text-yellow-500"></i>' : ''} </div> <div class="min-w-0 flex-grow"> <h3 class="font-bold text-gray-100 leading-tight mb-1 truncate ${task.status===2?'line-through text-gray-500':''}">${escapeHtml(task.title)}</h3> ${task.content ? `<p class="desc-preview text-xs text-gray-500 line-clamp-1 mb-2">${escapeHtml(task.content)}</p>` : ''} </div> </div> <div class="card-meta flex flex-wrap items-center gap-2 text-xs ml-8 mt-2 sm:ml-0 sm:mt-0"> ${dateBadgeHtml} ${projectBadge} </div> </div> </div></div>`;
        };

        window.toggleSelectionMode = () => { isSelectionMode = !isSelectionMode; renderApp(); };
        window.toggleTaskSelection = (id, event) => { /*...*/ if (event) event.stopPropagation(); if (event && event.shiftKey) event.preventDefault(); const visibleTasks = getFilteredTasks(); const currentIndex = visibleTasks.findIndex(t => t.id === id); if (event && event.shiftKey && lastSelectedId) { if(window.getSelection) window.getSelection().removeAllRanges(); const lastIndex = visibleTasks.findIndex(t => t.id === lastSelectedId); if (lastIndex !== -1 && currentIndex !== -1) { const start = Math.min(lastIndex, currentIndex); const end = Math.max(lastIndex, currentIndex); for(let i = start; i <= end; i++) { selectedTasks.add(visibleTasks[i].id); } } } else { if (selectedTasks.has(id)) { selectedTasks.delete(id); lastSelectedId = null; } else { selectedTasks.add(id); lastSelectedId = id; } } updateBulkToolbar(); renderApp(); };
        window.clearSelection = () => { selectedTasks.clear(); renderApp(); updateBulkToolbar(); };
        const updateBulkToolbar = () => { /*...*/ const bar = document.getElementById('bulk-toolbar'); const count = document.getElementById('bulk-count'); count.textContent = selectedTasks.size; if (selectedTasks.size > 0) { bar.classList.remove('translate-y-24', 'opacity-0'); } else { bar.classList.add('translate-y-24', 'opacity-0'); } };
        window.bulkAction = async (action, dateValue = null) => { /*...*/ if (selectedTasks.size === 0) return; showLoader(); const tasksToUpdate = Array.from(selectedTasks); let newDateISO = null; let shouldRemoveDate = false; const now = new Date(); if (action === 'today') { newDateISO = now.toISOString(); } else if (action === 'tomorrow') { const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1); newDateISO = tmrw.toISOString(); } else if (action === 'inbox') { shouldRemoveDate = true; } else if (action === 'specific' && dateValue) { newDateISO = new Date(dateValue).toISOString(); } try { await Promise.all(tasksToUpdate.map(async (tid) => { const task = taskCache.find(t => t.id === tid); if (!task) return; if (action === 'delete') { await api(`/project/${task.projectId}/task/${task.id}`, 'DELETE'); const idx = taskCache.findIndex(t => t.id === tid); if (idx > -1) taskCache.splice(idx, 1); } else { const payload = { projectId: task.projectId, title: task.title }; if (shouldRemoveDate) { task.dueDate = null; payload.dueDate = null; } else if (newDateISO) { task.dueDate = newDateISO; payload.dueDate = newDateISO.replace(/\.\d{3}Z$/, '+0000'); } await api(`/task/${tid}`, 'POST', payload); } })); localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache)); showToast(`Updated ${tasksToUpdate.length} tasks`); window.clearSelection(); renderApp(); } catch (e) { console.error(e); showToast('Error performing bulk action', 'error'); } hideLoader(); };

        const renderTimeline = (tasks) => { /*...*/ tasks.sort((a,b) => new Date(a.dueDate || '9999-12-31') - new Date(b.dueDate || '9999-12-31')); let html = '<div class="relative pl-8 space-y-8 min-h-[500px]">'; html += '<div class="timeline-line"></div>'; let lastDate = ''; if (tasks.length === 0) { html = `<div class="text-center p-12 text-gray-500"><p class="text-lg font-bold">No tasks to display on timeline.</p></div>`; } else { tasks.forEach(task => { let dateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }) : 'No Date'; if (dateStr !== lastDate) { const color = task.dueDate && new Date(task.dueDate) < new Date() ? 'text-red-400' : 'text-blue-400'; html += `<div class="relative mt-8"> <span class="absolute -left-[39px] mt-1.5 h-4 w-4 rounded-full border border-gray-700 bg-gray-900 z-10"></span> <h3 class="text-sm font-bold ${color} mb-4 ml-2 uppercase tracking-wider">${dateStr}</h3> </div>`; lastDate = dateStr; } html += `<div class="relative group ml-2 mb-4"> <span class="absolute -left-[45px] top-6 h-2 w-2 rounded-full bg-gray-600 group-hover:bg-[var(--primary)] transition z-10"></span> ${renderTaskCard(task)} </div>`; }); html += '</div>'; } els.content.innerHTML = html; };
        window.handleSortableDrop = async (evt) => { /*...*/ const taskId = evt.item.getAttribute('data-task-id'); const toSection = evt.to.getAttribute('data-section'); const fromSection = evt.from.getAttribute('data-section'); if (toSection === fromSection) return; const task = taskCache.find(t => t.id === taskId); if (!task) return; let newDate = null; let removeDate = false; const now = new Date(); if (toSection === 'today' || toSection === 'overdue') { newDate = now; } else if (toSection === 'tomorrow') { const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1); newDate = tmrw; } else if (toSection === 'later') { const nextWeek = new Date(now); nextWeek.setDate(nextWeek.getDate() + 7); newDate = nextWeek; } else if (toSection === 'noDate') { removeDate = true; } else if (toSection === 'completed') { window.completeTask(task.projectId, task.id, null); return; } if (newDate || removeDate) { if (removeDate) task.dueDate = null; else task.dueDate = newDate.toISOString().replace(/\.\d{3}Z$/, '+0000'); renderApp(); try { const payload = { projectId: task.projectId, title: task.title, dueDate: task.dueDate }; await api(`/task/${task.id}`, 'POST', payload); showToast(`Moved to ${toSection}`); } catch (e) { console.error(e); showToast('Failed to save changes', 'error'); } } };

        const renderClassic = (tasks) => { /*...*/ if(tasks.length === 0) { const msgs = { inbox: "Inbox Zero!", today: "All clear for today.", all: "No tasks found.", completed: "No completed tasks." }; els.content.innerHTML = `<div class="text-center p-12 text-gray-500 flex flex-col items-center"><div class="bg-gray-800/50 p-6 rounded-full mb-4"><i class="fa-solid fa-mug-hot text-4xl opacity-50 text-[var(--primary)]"></i></div><p class="text-lg font-bold text-gray-400">${msgs[currentState.filter] || "Nothing here."}</p></div>`; return; } if (currentState.sortMode === 'alpha' || currentState.filter === 'completed') { els.content.innerHTML = `<div id="simple-list">${tasks.map(renderTaskCard).join('')}</div>`; return; } const now = new Date(); now.setHours(0,0,0,0); const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1); const groups = { overdue: [], today: [], tomorrow: [], later: [], noDate: [], completed: [] }; tasks.forEach(t => { if (t.status === 2) { groups.completed.push(t); return; } if (!t.dueDate) { groups.noDate.push(t); return; } const d = new Date(t.dueDate); d.setHours(0,0,0,0); if (d < now) groups.overdue.push(t); else if (d.getTime() === now.getTime()) groups.today.push(t); else if (d.getTime() === tmrw.getTime()) groups.tomorrow.push(t); else groups.later.push(t); }); const renderSection = (key, label, customClass = '') => { const groupTasks = groups[key]; const alwaysShow = ['today', 'tomorrow', 'noDate']; if (groupTasks.length === 0 && !alwaysShow.includes(key)) return ''; const isCollapsed = window.sectionStates[key]; const icon = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'; let headerClass = 'group-header'; if (customClass) headerClass += ` ${customClass}`; headerClass += ' cursor-pointer hover:bg-gray-800/50 rounded px-2 select-none transition-colors'; return ` <div class="${headerClass}" onclick="window.toggleSection('${key}')"> <div class="flex items-center gap-2"> <i class="fa-solid ${icon} text-xs w-4 text-gray-500"></i> <span>${label}</span> </div> <span>${groupTasks.length}</span> </div> <div id="group-${key}" data-section="${key}" class="task-group ${isCollapsed ? 'hidden' : ''} min-h-[10px] pb-4 transition-all"> ${groupTasks.map(renderTaskCard).join('')} ${groupTasks.length === 0 ? '<div class="text-xs text-gray-700 italic py-2 pl-4 dashed-placeholder">Drag tasks here...</div>' : ''} </div>`; }; let html = ''; html += renderSection('overdue', 'Overdue', 'overdue'); html += renderSection('today', 'Today', 'today'); html += renderSection('tomorrow', 'Tomorrow'); html += renderSection('later', 'Later'); html += renderSection('noDate', 'No Date'); html += renderSection('completed', 'Completed'); els.content.innerHTML = html; setTimeout(() => { ['overdue', 'today', 'tomorrow', 'later', 'noDate', 'completed'].forEach(key => { const el = document.getElementById(`group-${key}`); if (el) { new Sortable(el, { group: 'classic-view', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 150, delayOnTouchOnly: true, onEnd: window.handleSortableDrop }); } }); }, 50); };
        
        const renderEisenhower = (tasks) => { /* Same */ const today = new Date().toISOString().split('T')[0]; const quadrants = { do: { title: 'Do First', subtitle: 'Urgent & Important', color: 'text-green-400', border: 'border-green-500/30', tasks: [] }, decide: { title: 'Schedule', subtitle: 'Not Urgent & Important', color: 'text-blue-400', border: 'border-blue-500/30', tasks: [] }, delegate: { title: 'Delegate', subtitle: 'Urgent & Not Important', color: 'text-orange-400', border: 'border-orange-500/30', tasks: [] }, delete: { title: 'Eliminate', subtitle: 'Not Urgent & Not Important', color: 'text-gray-400', border: 'border-gray-600/30', tasks: [] } }; tasks.forEach(t => { const isUrgent = t.dueDate && new Date(t.dueDate).toISOString().split('T')[0] <= today; const isImportant = t.priority >= 3; if (isUrgent && isImportant) quadrants.do.tasks.push(t); else if (!isUrgent && isImportant) quadrants.decide.tasks.push(t); else if (isUrgent && !isImportant) quadrants.delegate.tasks.push(t); else quadrants.delete.tasks.push(t); }); let html = `<div class="eisenhower-grid">`; Object.entries(quadrants).forEach(([key, q]) => { html += `<div class="quadrant ${q.border}"> <div class="quadrant-header ${q.color}"><span>${q.title}</span><span class="opacity-60 text-[10px]">${q.subtitle}</span></div> <div class="quadrant-body space-y-2">${q.tasks.map(renderTaskCard).join('')}</div> </div>`; }); html += `</div>`; els.content.innerHTML = html; };

        const renderProjectsManager = () => { /* Same */ const projects = Object.entries(projectMap).filter(([id]) => id !== 'inbox'); let html = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Projects</h1><button onclick="window.openProjectModal()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-bold border border-gray-700">Create List</button></div>`; html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`; html += projects.map(([id, p]) => { const color = getProjectColor(id); return `<div class="card p-5 rounded-xl border border-gray-800 flex justify-between items-center group shadow-md" style="border-left: 4px solid ${color};"><span class="font-bold text-lg">${escapeHtml(p.name)}</span><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="window.openProjectModal('${id}', '${escapeHtml(p.name)}')" class="p-2 text-blue-400 hover:bg-blue-900/30 rounded"><i class="fa-solid fa-pen"></i></button><button onclick="window.deleteProject('${id}')" class="p-2 text-red-400 hover:bg-red-900/30 rounded"><i class="fa-solid fa-trash"></i></button></div></div>` }).join(''); html += `</div>`; els.content.innerHTML = html; };

        window.addChecklistItem = (text = '') => { /* Same */ const container = document.getElementById('checklist-builder'); const div = document.createElement('div'); div.className = 'flex gap-2 items-center'; div.innerHTML = `<i class="fa-regular fa-square text-gray-500"></i><input type="text" value="${escapeHtml(text)}" class="checklist-input w-full bg-transparent border-b border-gray-700 focus:border-blue-500 outline-none text-sm py-1" placeholder="Subtask..."><button type="button" onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>`; container.appendChild(div); div.querySelector('input').focus(); };
        window.submitTaskForm = async () => { /* Same */ const id = document.getElementById('modal-task-id').value; const checklistItems = []; document.querySelectorAll('.checklist-input').forEach(input => { if(input.value.trim()) checklistItems.push({ title: input.value.trim(), status: 0 }); }); const payload = { title: document.getElementById('modal-title-input').value, content: document.getElementById('modal-desc-input').value, projectId: document.getElementById('modal-project-input').value, priority: parseInt(document.getElementById('modal-priority-input').value), isAllDay: document.getElementById('modal-allday-input').checked, tags: document.getElementById('modal-tags-input').value.split(',').map(t=>t.trim()).filter(t=>t), repeatFlag: document.getElementById('modal-repeat-input').value || null, items: checklistItems }; const dueVal = document.getElementById('modal-due-date').value; if(dueVal) payload.dueDate = new Date(dueVal).toISOString().replace(/\.\d{3}Z$/, '+0000'); const startVal = document.getElementById('modal-start-date').value; if(startVal) payload.startDate = new Date(startVal).toISOString().replace(/\.\d{3}Z$/, '+0000'); showLoader(); try { if(id) await api(`/task/${id}`, 'POST', payload); else await api('/task', 'POST', payload); showToast('Success!'); els.modal.classList.add('hidden'); window.closeSidePane(); fetchAllData(); } catch(e) { showToast('Error', 'error'); } hideLoader(); };
        window.openModal = (isEdit, taskId = null) => { /* Same */ const modal = document.getElementById('task-modal'); const pSelect = document.getElementById('modal-project-input'); const container = document.getElementById('checklist-builder'); container.innerHTML = ''; pSelect.innerHTML = Object.entries(projectMap).map(([id, p]) => `<option value="${id}">${escapeHtml(p.name)}</option>`).join(''); if(!Object.keys(projectMap).find(id => projectMap[id].name.toLowerCase() === 'inbox')) { pSelect.innerHTML = `<option value="inbox">Inbox</option>` + pSelect.innerHTML; } if (isEdit && taskId) { const task = taskCache.find(t => t.id === taskId); document.getElementById('modal-title').textContent = "Edit Task"; document.getElementById('modal-task-id').value = task.id; document.getElementById('modal-title-input').value = task.title; document.getElementById('modal-desc-input').value = task.content || ''; document.getElementById('modal-tags-input').value = (task.tags || []).join(', '); document.getElementById('modal-priority-input').value = task.priority || 0; document.getElementById('modal-project-input').value = task.projectId; document.getElementById('modal-allday-input').checked = !!task.isAllDay; document.getElementById('modal-repeat-input').value = task.repeatFlag || ""; if (task.items) task.items.forEach(item => window.addChecklistItem(item.title)); const fmtDate = (iso) => iso ? new Date(new Date(iso) - (new Date(iso).getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : ''; document.getElementById('modal-start-date').value = fmtDate(task.startDate); document.getElementById('modal-due-date').value = fmtDate(task.dueDate); } else { document.getElementById('modal-title').textContent = "New Task"; document.getElementById('modal-task-id').value = ''; document.getElementById('modal-title-input').value = ''; document.getElementById('modal-desc-input').value = ''; document.getElementById('modal-tags-input').value = ''; document.getElementById('modal-start-date').value = ''; document.getElementById('modal-due-date').value = ''; document.getElementById('modal-priority-input').value = 0; document.getElementById('modal-allday-input').checked = false; document.getElementById('modal-repeat-input').value = ""; } modal.classList.remove('hidden'); };

        /* Pomo, Keydown, Helper functions */
        let pomoInterval; let pomoSeconds = 25 * 60; let isPomoRunning = false;
        window.togglePomo = () => { document.getElementById('pomo-widget').classList.remove('hidden'); };
        window.minimizePomo = (e) => { e.stopPropagation(); document.getElementById('pomo-widget').classList.add('minimized'); };
        window.maximizePomo = () => { document.getElementById('pomo-widget').classList.remove('minimized'); };
        window.updatePomoDisplay = () => { const m = Math.floor(pomoSeconds / 60).toString().padStart(2, '0'); const s = (pomoSeconds % 60).toString().padStart(2, '0'); document.getElementById('pomo-timer').textContent = `${m}:${s}`; if(pomoSeconds === 0) { clearInterval(pomoInterval); isPomoRunning = false; document.getElementById('pomo-toggle').textContent = "Start"; showToast("Focus session complete!", "success"); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); } };
        window.togglePomoTimer = (e) => { e.stopPropagation(); const btn = document.getElementById('pomo-toggle'); if (isPomoRunning) { clearInterval(pomoInterval); isPomoRunning = false; btn.textContent = "Resume"; } else { isPomoRunning = true; btn.textContent = "Pause"; pomoInterval = setInterval(() => { if(pomoSeconds > 0) { pomoSeconds--; window.updatePomoDisplay(); } }, 1000); } };
        window.resetPomo = (e) => { e.stopPropagation(); clearInterval(pomoInterval); isPomoRunning = false; pomoSeconds = 25 * 60; document.getElementById('pomo-toggle').textContent = "Start"; window.updatePomoDisplay(); };

        document.addEventListener('keydown', (e) => { if (e.target.matches('input, textarea, select')) { if(e.key === 'Escape') e.target.blur(); return; } if (e.key.toLowerCase() === 'n') { e.preventDefault(); window.openAddTaskModal(); } if (e.key === '/') { e.preventDefault(); document.getElementById('quick-add-input').focus(); } if (e.key === 'Escape') { document.getElementById('task-modal').classList.add('hidden'); document.getElementById('project-modal').classList.add('hidden'); window.closeSidePane(); window.clearSelection(); } if (e.key.toLowerCase() === 'r' && !e.metaKey && !e.ctrlKey) { window.refreshData(); } if (e.key.toLowerCase() === 'j' || e.key.toLowerCase() === 'k') { const tasks = getFilteredTasks(); if(tasks.length === 0) return; let idx = -1; if(lastSelectedId) idx = tasks.findIndex(t => t.id === lastSelectedId); let newIdx = idx; if (e.key.toLowerCase() === 'j') newIdx = Math.min(tasks.length - 1, idx + 1); if (e.key.toLowerCase() === 'k') newIdx = Math.max(0, idx - 1); if(newIdx !== idx && tasks[newIdx]) { window.clearSelection(); const id = tasks[newIdx].id; selectedTasks.add(id); lastSelectedId = id; renderApp(); const el = document.querySelector(`[data-task-id="${id}"]`); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } } });
        const calculateNextOccurrence = (dueDate, repeatFlag) => { let nextDate = new Date(); if (dueDate) nextDate = new Date(dueDate); if (nextDate < new Date()) nextDate = new Date(); if (repeatFlag) { if (repeatFlag.includes('DAILY')) nextDate.setDate(nextDate.getDate() + 1); else if (repeatFlag.includes('WEEKLY')) nextDate.setDate(nextDate.getDate() + 7); else if (repeatFlag.includes('MONTHLY')) nextDate.setMonth(nextDate.getMonth() + 1); else if (repeatFlag.includes('YEARLY')) nextDate.setFullYear(nextDate.getFullYear() + 1); } const diffTime = nextDate - new Date(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const dateStr = nextDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); return `${dateStr} (in ${diffDays} days)`; };
        window.completeTask = async (pid, tid, checkbox, event) => { if(event) event.stopPropagation(); let task = taskCache.find(t => t.id === tid); if(!task) task = historyCache.find(t => t.id === tid); if(!task) return; if(event && event.target) { const rect = event.target.getBoundingClientRect(); const x = (rect.left + rect.width / 2) / window.innerWidth; const y = (rect.top + rect.height / 2) / window.innerHeight; confetti({ particleCount: 60, spread: 50, origin: { x, y }, colors: ['#3b82f6', '#10b981'] }); } const oldStatus = task.status; task.status = 2; localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache)); renderApp(); if(!task.isHistory) await logTaskCompletion(task); try { await api(`/project/${pid}/task/${tid}/complete`, 'POST'); const isRecurring = task.repeatFlag || (task.recurrence && task.recurrence.rule); if (isRecurring) { const nextStr = calculateNextOccurrence(task.dueDate, task.repeatFlag || (task.recurrence ? task.recurrence.rule : "")); showToast(`Session completed. Next: ${nextStr}`, 'success'); } else { showToast('Task completed', 'success', 'Undo', async () => { task.status = 0; localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache)); renderApp(); await api(`/task/${tid}`, 'POST', { projectId: task.projectId, title: task.title, status: 0 }); fetchAllData(); }); } setTimeout(fetchAllData, 1000); } catch(e) { task.status = oldStatus; if(checkbox) checkbox.checked = false; renderApp(); showToast('Failed to complete', 'error'); } };
        window.stopRepeating = async (taskId) => { if(!confirm("Stop this task from repeating? It will become a regular task.")) return; const task = taskCache.find(t => t.id === taskId); if(!task) return; showLoader(); try { const payload = { ...task, recurrence: null, repeatFlag: null }; await api(`/task/${taskId}`, 'POST', payload); showToast("Recurrence removed"); window.closeSidePane(); fetchAllData(); } catch(e) { showToast("Error updating task", "error"); } hideLoader(); };
        const renderKanban = (tasks) => { const cols = { 5: { title: 'High Priority', items: [] }, 3: { title: 'Medium Priority', items: [] }, 1: { title: 'Low Priority', items: [] }, 0: { title: 'No Priority', items: [] } }; tasks.forEach(t => { if(cols[t.priority]) cols[t.priority].items.push(t); else cols[0].items.push(t); }); let html = `<div class="flex gap-4 overflow-x-auto pb-4 h-[calc(100vh-180px)] px-2">`; [5, 3, 1, 0].forEach(p => { const col = cols[p]; html += `<div class="kanban-col"><div class="kanban-header"><span>${col.title}</span><span class="bg-gray-700 px-2 rounded-full text-xs">${col.items.length}</span></div><div class="kanban-body space-y-2" id="col-${p}" data-priority="${p}">${col.items.map(renderTaskCard).join('')}</div></div>`; }); html += `</div>`; els.content.innerHTML = html; setTimeout(() => { [5, 3, 1, 0].forEach(p => { new Sortable(document.getElementById(`col-${p}`), { group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: async (evt) => { const taskId = evt.item.dataset.taskId; const newPriority = parseInt(evt.to.dataset.priority); if (newPriority !== parseInt(evt.from.dataset.priority)) { const task = taskCache.find(t => t.id === taskId); showLoader(); await api(`/task/${taskId}`, 'POST', { ...task, priority: newPriority }); hideLoader(); task.priority = newPriority; } } }); }); }, 100); };
        const renderCalendar = (tasks) => { const date = currentCalendarDate; const year = date.getFullYear(); const month = date.getMonth(); const monthName = date.toLocaleString('default', { month: 'long' }); const tasksByDate = {}; tasks.forEach(t => { if(!t.dueDate) return; const dateKey = t.dueDate.split('T')[0]; if(!tasksByDate[dateKey]) tasksByDate[dateKey] = []; tasksByDate[dateKey].push(t); }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const todayKey = new Date().toISOString().split('T')[0]; let html = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${monthName} ${year}</h2><div class="flex gap-2"><button onclick="window.jumpToToday()" class="p-2 px-3 bg-gray-800 rounded hover:bg-gray-700 text-xs font-bold mr-2">Today</button><button onclick="window.changeMonth(-1)" class="p-2 bg-gray-800 rounded hover:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button><button onclick="window.changeMonth(1)" class="p-2 bg-gray-800 rounded hover:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button></div></div><div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-gray-500 uppercase"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div class="calendar-grid">`; for(let i=0; i<firstDay; i++) html += `<div class="calendar-day bg-gray-900/50 pointer-events-none"></div>`; for(let d=1; d<=daysInMonth; d++) { const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const dayTasks = tasksByDate[dateKey] || []; const dots = dayTasks.slice(0, 5).map(t => { let color = t.status===2 ? 'bg-green-500' : (t.priority===5 ? 'bg-red-500' : 'bg-blue-500'); return `<span class="calendar-dot ${color}" title="${escapeHtml(t.title)}"></span>`; }).join(''); html += `<div class="calendar-day ${dateKey === todayKey ? 'today' : ''}" onclick="window.showDayTasks('${dateKey}')" data-date="${dateKey}"><div class="flex justify-between items-start mb-1 pointer-events-none day-label"><span class="text-sm font-bold ${dateKey === todayKey ? 'text-[var(--primary)]' : 'text-gray-400'}">${d}</span>${dayTasks.length > 0 ? `<span class="text-[10px] text-gray-500 font-mono">${dayTasks.length}</span>` : ''}</div><div class="flex flex-wrap content-start h-full pb-4 pointer-events-none task-dots-container">${dots}</div></div>`; } html += `</div>`; els.content.innerHTML = html; window.dayTasksCache = tasksByDate; document.querySelectorAll('.calendar-day[data-date]').forEach(el => { el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('drag-over'); }); el.addEventListener('dragleave', () => el.classList.remove('drag-over')); el.addEventListener('drop', (e) => { e.preventDefault(); el.classList.remove('drag-over'); window.bulkAction('specific', el.dataset.date); }); }); };
        window.jumpToToday = () => { currentCalendarDate = new Date(); renderApp(); }; window.openSidePane = (taskId, isFromHistory = false) => { currentSidePaneTaskId = taskId; const task = isFromHistory ? historyCache.find(t => t.id === taskId) : taskCache.find(t => t.id === taskId); if (!task) return; const titleEl = document.getElementById('sp-title-edit'); titleEl.value = task.title; titleEl.style.height = 'auto'; titleEl.style.height = titleEl.scrollHeight + 'px'; const descEl = document.getElementById('sp-desc'); descEl.textContent = task.content || ""; const pName = projectMap[task.projectId]?.name || 'Unknown'; const spProj = document.getElementById('sp-project'); spProj.textContent = pName; spProj.className = "text-[10px] font-bold uppercase tracking-widest mb-1 block"; spProj.style.color = getProjectColor(task.projectId); document.getElementById('sp-date').textContent = task.dueDate ? new Date(task.dueDate).toLocaleString() : 'No due date'; const pCont = document.getElementById('sp-priority-container'); if(task.priority == 5) pCont.innerHTML = '<span class="text-red-500 font-bold"><i class="fa-solid fa-flag"></i> High</span>'; else if(task.priority == 3) pCont.innerHTML = '<span class="text-yellow-500 font-bold"><i class="fa-solid fa-flag"></i> Medium</span>'; else if(task.priority == 1) pCont.innerHTML = '<span class="text-blue-500 font-bold"><i class="fa-solid fa-flag"></i> Low</span>'; else pCont.textContent = "None"; const tCont = document.getElementById('sp-tags-container'); tCont.innerHTML = (task.tags||[]).map(t => `<span class="bg-gray-700/50 text-gray-300 px-2 py-1 rounded-md text-xs border border-gray-600">#${t}</span>`).join(''); const isRecurring = task.repeatFlag || (task.recurrence && task.recurrence.rule); const compBtn = document.getElementById('sp-complete-btn'); const stopBtn = document.getElementById('sp-stop-repeat-btn'); if(isRecurring) { document.getElementById('sp-recurring-container').classList.remove('hidden'); stopBtn.classList.remove('hidden'); stopBtn.onclick = () => window.stopRepeating(task.id); if (task.status === 2) { compBtn.className = "flex-grow bg-gray-700 text-gray-400 py-3 rounded-xl font-bold cursor-not-allowed"; compBtn.innerHTML = '<i class="fa-solid fa-check-double"></i> Session Done'; } else { compBtn.className = "flex-grow bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition"; compBtn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> Complete Session'; compBtn.onclick = () => { window.completeTask(task.projectId, task.id, null); window.closeSidePane(); }; } } else { document.getElementById('sp-recurring-container').classList.add('hidden'); stopBtn.classList.add('hidden'); if (task.status === 2) { compBtn.className = "flex-grow bg-gray-700 text-gray-400 py-3 rounded-xl font-bold cursor-not-allowed"; compBtn.innerHTML = '<i class="fa-solid fa-check"></i> Completed'; compBtn.onclick = null; } else { compBtn.className = "flex-grow bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition"; compBtn.innerHTML = '<i class="fa-solid fa-check"></i> Complete'; compBtn.onclick = () => { window.completeTask(task.projectId, task.id, null); window.closeSidePane(); }; } } const spCheck = document.getElementById('sp-checkbox'); spCheck.checked = task.status === 2; spCheck.onclick = (e) => window.completeTask(task.projectId, task.id, spCheck, e); window.renderSidePaneChecklist(task); document.getElementById('sp-trash-btn').onclick = () => { if(confirm("Trash this task?")) window.deleteTask(task.projectId, task.id); }; document.getElementById('sp-edit-btn').onclick = () => window.openModal(true, taskId); const overlay = document.getElementById('side-pane-overlay'); const pane = document.getElementById('side-pane'); pane.classList.remove('hidden'); if (window.innerWidth >= 1024) { pane.classList.add('open'); } else { overlay.classList.remove('hidden'); void overlay.offsetWidth; overlay.classList.remove('opacity-0'); pane.classList.add('open'); } };
        window.renderSidePaneChecklist = (task) => { const listEl = document.getElementById('sp-checklist-items'); if(!listEl) return; listEl.innerHTML = ''; if(task.items && task.items.length > 0) { task.items.forEach((item, idx) => { const icon = item.status === 1 ? 'fa-square-check text-green-500' : 'fa-square text-gray-500'; const textClass = item.status === 1 ? 'line-through text-gray-600' : 'text-gray-300'; listEl.innerHTML += `<div class="flex items-center gap-3 p-2 bg-gray-800/40 rounded-lg cursor-pointer hover:bg-gray-800 transition" onclick="window.toggleSubtask('${task.id}', ${idx})"><i class="fa-regular ${icon}"></i><span class="text-sm ${textClass}">${escapeHtml(item.title)}</span></div>`; }); } else { listEl.innerHTML = '<div class="text-xs text-gray-600 italic">No subtasks</div>'; } };
        window.toggleSubtask = async (taskId, itemIndex) => { const task = taskCache.find(t => t.id === taskId); if(!task || !task.items) return; const item = task.items[itemIndex]; const oldStatus = item.status; item.status = oldStatus === 1 ? 0 : 1; window.renderSidePaneChecklist(task); renderApp(); try { await api(`/task/${taskId}`, 'POST', { title: task.title, projectId: task.projectId, items: task.items }); } catch(e) { item.status = oldStatus; window.renderSidePaneChecklist(task); showToast('Subtask update failed', 'error'); } };
        window.closeSidePane = () => { const pane = document.getElementById('side-pane'); pane.classList.remove('open'); document.getElementById('side-pane-overlay').classList.add('opacity-0'); setTimeout(() => document.getElementById('side-pane-overlay').classList.add('hidden'), 300); };
        window.openAddTaskModal = () => window.openModal(false); window.openProjectModal = (id = null, name = '') => { document.getElementById('project-modal-id').value = id || ''; document.getElementById('project-name-input').value = name; document.getElementById('project-modal-title').textContent = id ? 'Edit Project' : 'New Project'; document.getElementById('project-modal').classList.remove('hidden'); }; window.submitProjectForm = async () => { const id = document.getElementById('project-modal-id').value; const name = document.getElementById('project-name-input').value; if(!name) return showToast('Name required', 'error'); showLoader(); try { if(id) await api(`/project/${id}`, 'POST', { name }); else await api('/project', 'POST', { name }); showToast('Project saved'); document.getElementById('project-modal').classList.add('hidden'); fetchAllData(); } catch(e) { showToast('Error', 'error'); } hideLoader(); }; window.deleteProject = async (id) => { if(confirm("Delete this project and all its tasks?")) { showLoader(); try { await api(`/project/${id}`, 'DELETE'); showToast('Project deleted'); fetchAllData(); } catch(e) { showToast('Error', 'error'); } hideLoader(); } }; window.deleteTask = async (pid, tid) => { if(confirm("Are you sure?")) { showLoader(); await api(`/project/${pid}/task/${tid}`, 'DELETE'); showToast('Deleted'); window.closeSidePane(); fetchAllData(); } }; window.refreshData = () => fetchAllData(); window.changeMonth = (o) => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+o); renderApp(); }; window.showDayTasks = (k) => { const tasks = window.dayTasksCache[k] || []; els.content.innerHTML = `<div class="flex items-center gap-4 mb-6"><button onclick="renderApp()" class="bg-gray-800 p-2 rounded-lg"><i class="fa-solid fa-arrow-left"></i> Back</button><h1 class="text-2xl font-bold">Tasks for ${k}</h1></div>` + tasks.map(renderTaskCard).join(''); }; 
        window.addEventListener('DOMContentLoaded', () => {
            // Update Login Button Logic to include state
            document.getElementById('login-btn').onclick = () => { 
                const state = encodeURIComponent(window.location.pathname); // Return here
                location.href = `https://ticktick.com/oauth/authorize?client_id=${TICKTICK_CLIENT_ID}&scope=tasks:read%20tasks:write&response_type=code&redirect_uri=${encodeURIComponent(TICKTICK_REDIRECT_URI)}&state=${state}`; 
            }; 
            
            if (accessToken) fetchAllData(); 
            else document.getElementById('login-overlay').classList.remove('hidden'); 
            
            initDropZones(); 
        });
        // --- REVIEW MODE WIZARD LOGIC ---
let reviewQueue = [];
let currentReviewIndex = 0;

window.startReviewMode = () => {
    // 1. Fetch tasks from inbox that have no due date (unprocessed)
    const inboxId = Object.keys(projectMap).find(id => projectMap[id].name.toLowerCase() === 'inbox') || 'inbox';
    
    reviewQueue = taskCache.filter(t => 
        (t.projectId === inboxId) && 
        t.status === 0 && 
        !t.dueDate // Only process things without dates
    );

    if (reviewQueue.length === 0) {
        showToast("Inbox is already empty!", "success");
        return;
    }

    currentReviewIndex = 0;
    document.getElementById('review-modal').classList.remove('hidden');
    document.getElementById('review-controls').classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('review-empty-state').classList.add('hidden');
    window.renderReviewCard();
};

window.renderReviewCard = () => {
    const container = document.getElementById('review-card-container');
    const counter = document.getElementById('review-counter');
    
    // Clear previous card
    const existing = container.querySelector('.review-card');
    if (existing) existing.remove();

    if (currentReviewIndex >= reviewQueue.length) {
        // Finished
        document.getElementById('review-controls').classList.add('opacity-0', 'pointer-events-none');
        document.getElementById('review-empty-state').classList.remove('hidden');
        counter.textContent = "All Done";
        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        return;
    }

    const task = reviewQueue[currentReviewIndex];
    counter.textContent = `${reviewQueue.length - currentReviewIndex} left`;

    const card = document.createElement('div');
    card.className = "review-card w-full max-w-md bg-[#1f2937] border border-gray-700 p-8 rounded-2xl shadow-2xl animate-fade flex flex-col items-center text-center absolute";
    card.innerHTML = `
        <div class="w-16 h-1 bg-gray-700 rounded-full mb-6"></div>
        <h2 class="text-2xl font-bold text-white mb-4 leading-tight">${escapeHtml(task.title)}</h2>
        <div class="text-gray-400 text-sm mb-6 max-h-32 overflow-y-auto w-full">${escapeHtml(task.content || "No details provided.")}</div>
        <div class="flex flex-wrap justify-center gap-2">
            ${(task.tags || []).map(t => `<span class="px-2 py-1 bg-gray-800 rounded text-xs text-gray-400">#${t}</span>`).join('')}
        </div>
    `;
    container.appendChild(card);
};

window.reviewAction = async (action, payload = null) => {
    const task = reviewQueue[currentReviewIndex];
    if (!task) return;

    // Visual feedback
    const card = document.querySelector('.review-card');
    if (card) {
        card.style.transform = action === 'delete' ? 'translateX(-100px) rotate(-10deg)' : 
                               action === 'complete' ? 'translateY(-100px) scale(0.9)' : 
                               'translateX(100px) rotate(10deg)';
        card.style.opacity = '0';
    }

    // Logic
    setTimeout(async () => {
        if (action === 'delete') {
            await api(`/project/${task.projectId}/task/${task.id}`, 'DELETE');
            // Remove from cache locally
            const idx = taskCache.findIndex(t => t.id === task.id);
            if(idx > -1) taskCache.splice(idx, 1);
        } 
        else if (action === 'complete') {
            await window.completeTask(task.projectId, task.id, null);
        }
        else if (action === 'schedule') {
            let newDate = payload;
            if (payload === 'today') newDate = new Date().toISOString();
            else if (payload === 'tomorrow') {
                 const d = new Date(); d.setDate(d.getDate() + 1);
                 newDate = d.toISOString();
            } else {
                 newDate = new Date(payload).toISOString();
            }
            
            // Optimistic update
            task.dueDate = newDate.replace(/\.\d{3}Z$/, '+0000');
            renderApp();
            
            await api(`/task/${task.id}`, 'POST', { projectId: task.projectId, dueDate: task.dueDate });
        }
        
        // Move next
        currentReviewIndex++;
        window.renderReviewCard();
        renderApp(); // Refresh background app
    }, 200);
};

window.closeReviewMode = () => {
    document.getElementById('review-modal').classList.add('hidden');
    fetchAllData(); // Ensure sync on close
};

// Keyboard shortcuts for Review Mode
document.addEventListener('keydown', (e) => {
    if (document.getElementById('review-modal').classList.contains('hidden')) return;
    
    if (e.key === 'Delete' || e.key === 'Backspace') window.reviewAction('delete');
    if (e.key === 'ArrowRight') window.reviewAction('skip');
    if (e.key === 'Enter') window.reviewAction('complete');
    if (e.key.toLowerCase() === 't') window.reviewAction('schedule', 'today');
    if (e.key.toLowerCase() === 'w') window.reviewAction('schedule', 'tomorrow'); 
    if (e.key.toLowerCase() === 's') document.getElementById('review-date-picker').showPicker();
});
        window.addEventListener('DOMContentLoaded', () => { document.getElementById('login-btn').onclick = () => { location.href = `https://ticktick.com/oauth/authorize?client_id=${TICKTICK_CLIENT_ID}&scope=tasks:read%20tasks:write&response_type=code&redirect_uri=${encodeURIComponent(TICKTICK_REDIRECT_URI)}`; }; if (accessToken) fetchAllData(); else if (location.search.includes('code=')) checkAuthCode(); else document.getElementById('login-overlay').classList.remove('hidden'); initDropZones(); });
    </script>

    <div id="bulk-toolbar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-[#1f2937] border border-gray-600 shadow-2xl rounded-full px-6 py-3 flex items-center gap-4 z-50 transition-all duration-300 translate-y-24 opacity-0">
        <div class="flex items-center gap-2 border-r border-gray-600 pr-4 mr-2"><span id="bulk-count" class="bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span><span class="text-sm font-bold text-gray-300">Selected</span></div>
        <button onclick="window.bulkAction('today')" class="text-gray-400 hover:text-white flex flex-col items-center group" title="Move to Today"><i class="fa-solid fa-calendar-day text-lg group-hover:text-blue-500 transition"></i><span class="text-[10px] font-bold mt-1">Today</span></button>
        <button onclick="window.bulkAction('tomorrow')" class="text-gray-400 hover:text-white flex flex-col items-center group" title="Move to Tomorrow"><i class="fa-solid fa-sun text-lg group-hover:text-yellow-500 transition"></i><span class="text-[10px] font-bold mt-1">Tomorrow</span></button>
        <div class="relative group"><button onclick="document.getElementById('bulk-date-picker').showPicker()" class="text-gray-400 hover:text-white flex flex-col items-center group" title="Pick Date"><i class="fa-regular fa-calendar text-lg group-hover:text-green-500 transition"></i><span class="text-[10px] font-bold mt-1">Pick Date</span></button><input type="date" id="bulk-date-picker" onchange="window.bulkAction('specific', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full"></div>
        <div class="w-px h-8 bg-gray-600 mx-1"></div>
        <button onclick="window.bulkAction('delete')" class="text-gray-400 hover:text-red-500 flex flex-col items-center group" title="Delete"><i class="fa-solid fa-trash text-lg transition"></i><span class="text-[10px] font-bold mt-1">Trash</span></button>
        <button onclick="window.clearSelection()" class="ml-4 text-xs font-bold text-gray-500 hover:text-white border border-gray-600 px-2 py-1 rounded hover:bg-gray-700 transition">Cancel</button>
    </div>

    <div id="context-menu" class="fixed z-50 bg-[#1f2937] border border-gray-700 rounded-lg shadow-2xl py-1 w-48 hidden flex-col max-h-[90vh] overflow-y-auto">
        <button onclick="window.handleContextAction('complete')" class="text-left px-4 py-2 text-sm text-green-400 hover:bg-green-900/20 transition flex items-center gap-2">
            <i class="fa-solid fa-check text-xs w-4"></i> Complete
        </button>
        <div class="h-px bg-gray-700 my-1"></div>
        <button onclick="window.handleContextAction('edit')" class="text-left px-4 py-2 text-sm text-gray-200 hover:bg-blue-600 hover:text-white transition flex items-center gap-2">
            <i class="fa-solid fa-pen text-xs w-4"></i> Edit
        </button>
        <div class="h-px bg-gray-700 my-1"></div>
        <button onclick="window.handleContextAction('inbox')" class="text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-solid fa-inbox text-xs w-4 text-blue-400"></i> Move to Inbox
        </button>
        <button onclick="window.handleContextAction('today')" class="text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-solid fa-calendar-day text-xs w-4 text-green-400"></i> Set to Today
        </button>
        <button onclick="window.handleContextAction('tomorrow')" class="text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-solid fa-sun text-xs w-4 text-yellow-400"></i> Set to Tomorrow
        </button>
        <div class="h-px bg-gray-700 my-1"></div>
        <div class="px-3 py-1 text-[10px] font-bold text-gray-500 uppercase">Priority</div>
        <button onclick="window.handleContextAction('priority-5')" class="text-left px-4 py-1.5 text-sm text-red-400 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-solid fa-flag text-xs w-4"></i> High
        </button>
        <button onclick="window.handleContextAction('priority-3')" class="text-left px-4 py-1.5 text-sm text-yellow-400 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-solid fa-flag text-xs w-4"></i> Medium
        </button>
        <button onclick="window.handleContextAction('priority-1')" class="text-left px-4 py-1.5 text-sm text-blue-400 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-solid fa-flag text-xs w-4"></i> Low
        </button>
        <button onclick="window.handleContextAction('priority-0')" class="text-left px-4 py-1.5 text-sm text-gray-400 hover:bg-gray-700 transition flex items-center gap-2">
            <i class="fa-regular fa-flag text-xs w-4"></i> None
        </button>
        <div class="h-px bg-gray-700 my-1"></div>
        <button onclick="window.handleContextAction('delete')" class="text-left px-4 py-2 text-sm text-red-400 hover:bg-red-900/20 transition flex items-center gap-2">
            <i class="fa-solid fa-trash text-xs w-4"></i> Delete
        </button>
    </div>

    <script>
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.card') && !e.target.closest('#context-menu')) {
                document.getElementById('context-menu').classList.add('hidden');
            }
        });
    </script>
</body>
</html>