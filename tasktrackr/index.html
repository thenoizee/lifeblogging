<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaskTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512' fill='%233b82f6'%3E%3Cpath d='M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; --primary-hover: #2563eb;
            --bg-dark: #111827; --card-dark: #1f2937; --text-dark: #f9fafb;
            --bg-light: #f3f4f6; --card-light: #ffffff; --text-light: #111827;
            --priority-high: #ef4444; --priority-med: #f59e0b; --priority-low: #3b82f6;
        }
        .dark { --bg: var(--bg-dark); --card: var(--card-dark); --text: var(--text-dark); }
        .light { --bg: var(--bg-light); --card: var(--card-light); --text: var(--text-light); }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); transition: 0.3s; padding-bottom: 80px; }
        .card { background-color: var(--card); transition: 0.3s; }
        .btn-primary { background-color: var(--primary); color: white; transition: 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .filter-chip.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .task-checkbox { appearance: none; width: 1.25rem; height: 1.25rem; border: 2px solid #4b5563; border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s; }
        .task-checkbox:checked { background-color: var(--primary); border-color: var(--primary); }
        .task-checkbox:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; }
        
        #side-pane { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #side-pane-overlay { transition: opacity 0.3s ease; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #374151; border: 1px solid #374151; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day { min-height: 100px; background: var(--card); padding: 0.5rem; transition: background 0.2s; cursor: pointer; }
        .calendar-day:hover { background: var(--bg); }
        .calendar-day.today { background: rgba(59, 130, 246, 0.1); }
        .calendar-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 2px; }

        .kanban-col { min-width: 280px; max-width: 320px; flex-shrink: 0; display: flex; flex-direction: column; }
        .kanban-body { flex-grow: 1; overflow-y: auto; min-height: 200px; }
        .sortable-ghost { opacity: 0.4; background: #1f2937; border: 2px dashed #4b5563; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: var(--card); transform: rotate(2deg); }

        /* Add this to your style section */
.filter-chip.drag-over {
    background-color: var(--primary) !important;
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    z-index: 50;
}
.card.dragging {
    opacity: 0.5;
    border: 2px dashed #4b5563;
}

    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="sticky top-0 bg-[var(--card)] shadow-lg z-30">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-4">
                    <a href="#" class="flex items-center space-x-2 text-2xl font-bold text-[var(--primary)]">
                        <i class="fa-solid fa-check-double"></i>
                        <span class="hidden sm:inline">TaskTrackr</span>
                    </a>
                    <div class="hidden sm:flex items-center bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                        <span id="header-task-count" class="text-sm font-bold text-[var(--primary)]">0</span>
                        <span class="text-xs text-gray-500 ml-1">tasks</span>
                    </div>
                </div>

                <nav class="flex space-x-6 text-sm font-medium">
                    <button onclick="window.setView('classic')" class="nav-tab active py-2 transition" id="tab-classic">Classic</button>
                    <button onclick="window.setView('calendar')" class="nav-tab py-2 transition" id="tab-calendar">Calendar</button>
                    <button onclick="window.setView('kanban')" class="nav-tab py-2 transition" id="tab-kanban">Kanban</button>
                </nav>

                <div class="relative hidden md:block mx-4">
    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
    <input type="text" 
           id="search-input" 
           placeholder="Search tasks..." 
           class="bg-gray-800 border border-gray-700 rounded-full py-1.5 pl-8 pr-4 text-xs focus:border-blue-500 focus:outline-none w-48 transition-all focus:w-64 text-gray-200"
           oninput="window.handleSearch(this.value)">
</div>

                <div class="flex items-center space-x-3">
                    <button onclick="window.refreshData()" class="p-2 rounded-full hover:bg-[var(--bg)] transition group"><i class="fa-solid fa-arrows-rotate text-gray-400 group-hover:text-[var(--primary)]"></i></button>
                    <button onclick="window.openAddTaskModal()" class="btn-primary w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--bg)]"><i class="fa-solid fa-moon text-xl"></i></button>
                </div>
            </div>

            <div class="flex items-center gap-4 overflow-x-auto hide-scroll pb-2 border-t border-gray-800 pt-3">
                <div class="flex gap-2" id="filter-container">
                    <button onclick="window.setFilter('inbox')" class="filter-chip active px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]">Inbox</button>
                    <button onclick="window.setFilter('today')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]">Today</button>
                    <button onclick="window.setFilter('tomorrow')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]">Tomorrow</button>
                    <button onclick="window.setFilter('overdue')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-red-500">Overdue</button>
                    <button onclick="window.setFilter('all')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-[var(--primary)]">All Active</button>
                    <button onclick="window.setFilter('projects')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-purple-500">Projects</button>
                    <button onclick="window.setFilter('completed')" class="filter-chip px-3 py-1 rounded-full border border-gray-700 text-xs font-bold transition whitespace-nowrap bg-gray-800 hover:border-green-500">Completed & Won't Do</button>
                </div>
                
                <div class="w-px h-6 bg-gray-700 mx-2 flex-shrink-0"></div>
                
                <select id="project-filter" onchange="window.updateFilter('projectId', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded-lg px-2 py-1 outline-none focus:border-[var(--primary)] max-w-[120px]">
                    <option value="all">All Lists</option>
                </select>
                <select id="tag-filter" onchange="window.updateFilter('tag', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded-lg px-2 py-1 outline-none focus:border-[var(--primary)] max-w-[120px]">
                    <option value="all">All Tags</option>
                </select>
                <select id="priority-filter" onchange="window.updateFilter('priority', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded-lg px-2 py-1 outline-none focus:border-[var(--primary)]">
                    <option value="all">Any Prio</option>
                    <option value="5">High</option>
                    <option value="3">Med</option>
                    <option value="1">Low</option>
                </select>
                
                <button onclick="window.resetFilters()" class="text-xs text-gray-500 hover:text-white whitespace-nowrap ml-auto" title="Reset Filters"><i class="fa-solid fa-filter-circle-xmark mr-1"></i> Reset</button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="mb-6 relative group z-0">
    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
        <i class="fa-solid fa-plus text-gray-500 group-focus-within:text-[var(--primary)] transition-colors"></i>
    </div>
    <input type="text" 
           id="quick-add-input"
           class="w-full bg-[var(--card)] border border-gray-700 text-gray-200 text-sm rounded-xl pl-10 pr-16 py-4 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-gray-500" 
           placeholder="Add a task to 'Inbox'..."
           onkeydown="window.handleQuickAdd(event)">
    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
        <span class="text-xs text-gray-600 border border-gray-700 px-2 py-1 rounded bg-gray-800">Enter ↵</span>
    </div>
</div>
        <div id="content" class="min-h-[50vh]"></div>
    </main>

    <footer class="bg-[var(--card)] py-6 mt-auto text-center text-gray-500 text-sm border-t border-gray-800 mb-16 md:mb-0">
        <p>&copy; 2025 TaskTrackr. Powered by <a href="https://ticktick.com" target="_blank" class="text-[var(--primary)] hover:underline font-bold">TickTick</a>.</p>
    </footer>

    <div id="side-pane-overlay" class="fixed inset-0 bg-black/50 z-40 hidden opacity-0" onclick="window.closeSidePane()"></div>
    <div id="side-pane" class="fixed top-0 right-0 bottom-0 w-full sm:w-96 bg-[var(--card)] shadow-2xl z-50 transform translate-x-full flex flex-col border-l border-gray-800 transition-transform duration-300">
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <h2 class="text-lg font-bold">Task Details</h2>
            <button onclick="window.closeSidePane()" class="text-gray-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="flex-grow p-6 overflow-y-auto hide-scroll space-y-6">
            <div class="flex flex-wrap gap-2" id="sp-badges">
                <span id="sp-project" class="bg-gray-800 text-gray-400 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border border-gray-700">Project</span>
            </div>
            
            <div>
                <h1 id="sp-title" class="text-2xl font-bold leading-tight mb-2">Task Title</h1>
                <div id="sp-priority-container" class="flex gap-2 mb-2"></div>
                <div id="sp-tags-container" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="flex items-center text-gray-400 text-sm">
                <i class="fa-regular fa-clock mr-3 text-[var(--primary)] text-lg"></i>
                <span id="sp-date">No due date</span>
            </div>
            
            <div id="sp-recurring-container" class="hidden flex items-center text-yellow-500 text-sm">
                <i class="fa-solid fa-repeat mr-3 text-lg"></i>
                <span id="sp-recurring">Recurring Task</span>
            </div>

            <div id="sp-desc-container" class="bg-[var(--bg)] p-4 rounded-xl border border-gray-700/50 hidden">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Description</h3>
                <p id="sp-desc" class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap"></p>
            </div>
            
            <div id="sp-checklist-items" class="space-y-2"></div>
        </div>
        
        <div class="p-4 border-t border-gray-700 bg-[var(--card)] flex gap-3">
            <button id="sp-trash-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-300 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition" title="Move to Trash">
                <i class="fa-solid fa-trash"></i> Move to Trash
            </button>
            <button id="sp-complete-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition">
                <i class="fa-solid fa-check"></i> Complete
            </button>
            <button id="sp-edit-btn" class="w-12 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center transition">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700 animate-fade max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4" id="modal-title">New Task</h3>
            <input type="hidden" id="modal-task-id">
            
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Title</label><input type="text" id="modal-title-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm" placeholder="What needs to be done?"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Description</label><textarea id="modal-desc-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm resize-none" rows="3" placeholder="Details..."></textarea></div>
                
                <div><label class="text-xs font-bold text-gray-500 uppercase">Project</label>
                <select id="modal-project-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></select></div>

                <div><label class="text-xs font-bold text-gray-500 uppercase">Tags</label><input type="text" id="modal-tags-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm" placeholder="tag1, tag2"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Start Date</label><input type="datetime-local" id="modal-start-date" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Due Date</label><input type="datetime-local" id="modal-due-date" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Priority</label><select id="modal-priority-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"><option value="0">None</option><option value="1">Low</option><option value="3">Medium</option><option value="5">High</option></select></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Repeat</label><select id="modal-repeat-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"><option value="">None</option><option value="RRULE:FREQ=DAILY;INTERVAL=1">Daily</option><option value="RRULE:FREQ=WEEKLY;INTERVAL=1">Weekly</option><option value="RRULE:FREQ=MONTHLY;INTERVAL=1">Monthly</option><option value="RRULE:FREQ=YEARLY;INTERVAL=1">Yearly</option></select></div>
                </div>
                <div class="flex items-center"><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="modal-allday-input" class="task-checkbox"><span class="text-sm">All Day</span></label></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('task-modal').classList.add('hidden')" class="w-full py-3 rounded-lg font-bold text-sm bg-gray-700 hover:bg-gray-600 text-white transition">Cancel</button>
                <button id="modal-submit-btn" onclick="window.submitTaskForm()" class="w-full py-3 rounded-lg font-bold text-sm btn-primary shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="project-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 animate-fade">
            <h3 class="text-xl font-bold mb-4" id="project-modal-title">Manage Project</h3>
            <input type="hidden" id="project-modal-id">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Name</label><input type="text" id="project-name-input" class="w-full bg-[var(--bg)] border border-gray-600 rounded-lg p-3 outline-none focus:border-[var(--primary)] text-sm"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('project-modal').classList.add('hidden')" class="w-full py-3 rounded-lg font-bold text-sm bg-gray-700 hover:bg-gray-600 text-white transition">Cancel</button>
                <button onclick="window.submitProjectForm()" class="w-full py-3 rounded-lg font-bold text-sm btn-primary shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="login-overlay" class="fixed inset-0 bg-[var(--bg)] z-40 hidden flex flex-col items-center justify-center p-6 text-center">
        <div class="p-6 rounded-full bg-blue-500/10 mb-6"><i class="fa-solid fa-check-double text-6xl text-[var(--primary)]"></i></div>
        <h1 class="text-4xl font-bold mb-2">TaskTrackr</h1>
        <p class="text-gray-500 mb-8 max-w-md">Connect your TickTick account to manage your tasks with style.</p>
        <button id="login-btn" class="btn-primary px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-blue-500/20 transition flex items-center gap-3"><i class="fa-solid fa-right-to-bracket"></i> Connect TickTick</button>
    </div>

    <div id="loader" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity">
        <div class="animate-spin rounded-full h-14 w-14 border-[5px] border-[var(--primary)] border-t-transparent"></div>
    </div>
    <div id="toast-container" class="fixed bottom-24 md:bottom-6 right-6 z-50 flex flex-col gap-3"></div>

    <script type="module">
        import { TICKTICK_CLIENT_ID, TICKTICK_CLIENT_SECRET, TICKTICK_REDIRECT_URI } from './api_keys.js';

        const API_BASE = 'https://api.ticktick.com/open/v1';
        let accessToken = localStorage.getItem('ticktick_token');
        let taskCache = [];
        try {
            const cached = localStorage.getItem('ticktrackr_tasks');
            if (cached) taskCache = JSON.parse(cached);
        } catch(e) { console.error("Cache load failed", e); }
        
        let projectMap = {};
        let currentCalendarDate = new Date();
        
        let currentState = {
            view: 'classic', 
            filter: 'inbox', 
            projectId: 'all',
            priority: 'all',
            tag: 'all',
            search: ''
        };
        
        const els = {
            content: document.getElementById('content'),
            loader: document.getElementById('loader'),
            modal: document.getElementById('task-modal'),
            taskCounter: document.getElementById('header-task-count')
        };

        // Escaping Helper to prevent breaking HTML attributes
        const escapeHtml = (unsafe) => {
            if (!unsafe) return "";
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        // Generates a consistent HSL color from a string
const stringToColor = (str) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const hue = Math.abs(hash % 360);
    // Return HSL: Hue, 70% Saturation, 35% Lightness (Dark enough for text, or use as bg)
    return `hsl(${hue}, 70%, 25%)`; 
};

const getTagBadge = (tag) => {
    const color = stringToColor(tag);
    return `<span class="px-2 py-0.5 rounded border text-[10px] font-bold uppercase tracking-wider opacity-80" 
                  style="color: ${color}; border-color: ${color}40; background-color: ${color}10;">
            #${escapeHtml(tag)}
            </span>`;
};

        function showLoader() { els.loader.classList.remove('hidden'); }
        function hideLoader() { els.loader.classList.add('hidden'); }
        const showToast = (msg, type = 'success', actionText = null, actionCallback = null) => {
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-900/90 border-green-500' : 'bg-red-900/90 border-red-500';
            toast.className = `p-4 rounded-xl border ${colors} text-white shadow-2xl animate-fade backdrop-blur-md min-w-[200px] flex items-center justify-between gap-4 pointer-events-auto`;
            
            let html = `<div class="flex items-center gap-3"><i class="fa-solid ${type==='success'?'fa-check':'fa-circle-exclamation'}"></i> <span>${msg}</span></div>`;
            if (actionText && actionCallback) html += `<button class="text-sm font-bold underline hover:text-white/80" id="toast-action-btn">${actionText}</button>`;
            
            toast.innerHTML = html;
            document.getElementById('toast-container').appendChild(toast);
            if (actionText && actionCallback) {
                toast.querySelector('#toast-action-btn').onclick = (e) => { e.stopPropagation(); actionCallback(); toast.remove(); };
            }
            setTimeout(() => { if(toast.isConnected) toast.remove() }, 5000);
        };

        const api = async (endpoint, method = 'GET', body = null) => {
            if (!accessToken) return null;
            const opts = { method, headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, opts);
                if (res.status === 401) { localStorage.removeItem('ticktick_token'); location.reload(); return null; }
                const text = await res.text();
                return text ? JSON.parse(text) : {};
            } catch (e) { console.error(e); return null; }
        };

        const fetchAllData = async () => {
            showLoader();
            if(!document.getElementById('project-filter')) { setTimeout(fetchAllData, 100); return; }

            const projects = await api('/project');
            if(!projects) { hideLoader(); return; }
            
            projectMap = projects.reduce((acc, p) => ({...acc, [p.id]: p.name}), {});
            
            let inboxId = 'inbox';
            const inboxProj = projects.find(p => p.kind === 'inbox' || p.name === 'Inbox');
            if (inboxProj) inboxId = inboxProj.id;
            projectMap[inboxId] = 'Inbox';

            const projectIds = new Set(projects.map(p => p.id));
            projectIds.add(inboxId);
            
            let allActiveTasks = [];
            await Promise.all(Array.from(projectIds).map(async (pid) => {
                try {
                    const data = await api(`/project/${pid}/data`);
                    if(data && data.tasks) allActiveTasks.push(...data.tasks);
                } catch(e) {}
            }));
            
            const activeMap = new Map(allActiveTasks.map(t => [t.id, t]));
            const newCache = [];
            // 1. Add all currently active tasks
            newCache.push(...allActiveTasks);
            // 2. Persist previously completed tasks from cache (unless reactivated)
            taskCache.forEach(t => {
                if(t.status === 2 && !activeMap.has(t.id)) {
                    newCache.push(t);
                }
            });
            
            taskCache = Array.from(new Map(newCache.map(item => [item.id, item])).values());
            localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache));
            
            const pSelect = document.getElementById('project-filter');
            if(pSelect) {
                pSelect.innerHTML = `<option value="all">All Lists</option>` + 
                Object.entries(projectMap).map(([id, name]) => `<option value="${id}" ${currentState.projectId===id?'selected':''}>${escapeHtml(name)}</option>`).join('');
            }

            const allTags = new Set();
            taskCache.forEach(t => (t.tags || []).forEach(tag => allTags.add(tag)));
            const tSelect = document.getElementById('tag-filter');
            if(tSelect) {
                tSelect.innerHTML = `<option value="all">All Tags</option>` + 
                Array.from(allTags).map(t => `<option value="${t}" ${currentState.tag===t?'selected':''}>#${t}</option>`).join('');
            }

            hideLoader();
            renderApp();
        };

        // --- Drag and Drop Logic ---

window.handleDragStart = (e, taskId) => {
    // 1. If the item being dragged isn't in the selection, select it solely.
    if (!selectedTasks.has(taskId)) {
        window.clearSelection();
        selectedTasks.add(taskId);
        window.toggleTaskSelection(taskId, null); // Visually update this card
    }

    // 2. Set Visual feedback
    e.target.classList.add('dragging');
    
    // 3. Set Data (We technically just use the 'selectedTasks' global, 
    // but setting data is good practice for DnD)
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', JSON.stringify(Array.from(selectedTasks)));
    
    // Optional: Set a custom drag image if you want
};

window.handleQuickAdd = async (e) => {
    if (e.key === 'Enter') {
        const input = document.getElementById('quick-add-input');
        const title = input.value.trim();
        if (!title) return;

        input.disabled = true;
        
        // 1. Determine Project ID
        // Default to 'Inbox' ID first
        let pid = Object.keys(projectMap).find(id => projectMap[id].toLowerCase() === 'inbox') || 'inbox';
        
        // If the user has specifically filtered to a Project (e.g., "Work"), use that instead
        if (currentState.projectId !== 'all') {
            pid = currentState.projectId;
        }

        // 2. Determine Due Date (Context Aware)
        let newDateISO = null;
        const now = new Date();
        
        if (currentState.filter === 'today') {
            // Context: Today View -> Due Today
            newDateISO = now.toISOString();
        } else if (currentState.filter === 'tomorrow') {
            // Context: Tomorrow View -> Due Tomorrow
            const tmrw = new Date(now);
            tmrw.setDate(tmrw.getDate() + 1);
            newDateISO = tmrw.toISOString();
        } 
        // Context: 'inbox' or 'all' -> No Date (Default)

        const payload = {
            title: title,
            projectId: pid,
            priority: 0
        };

        // 3. Attach date if context requires it
        if (newDateISO) {
            payload.dueDate = newDateISO.replace(/\.\d{3}Z$/, '+0000');
            payload.isAllDay = true; // Usually smart adds feel better as 'All Day' items
        }

        try {
            await api('/task', 'POST', payload);
            
            input.value = '';
            showToast('Task added');
            fetchAllData(); 
        } catch (err) {
            showToast('Failed to add task', 'error');
        } finally {
            input.disabled = false;
            input.focus();
        }
    }
};

// Initialize Drop Zones (Call this once on load)
const initDropZones = () => {
    const filters = document.querySelectorAll('.filter-chip');
    
    filters.forEach(btn => {
        // We need to map the buttons to actions
        // Assuming your HTML structure matches, we can use the text content or add attributes
        // Let's add attributes dynamically for safety or you can add them in HTML
        const text = btn.innerText.toLowerCase();
        let action = null;
        
        if (text.includes('today')) action = 'today';
        else if (text.includes('tomorrow')) action = 'tomorrow';
        else if (text.includes('inbox')) action = 'inbox'; // We'll need to add 'inbox' support to bulkAction
        
        if (!action) return; // Skip buttons that aren't drop targets
        
        btn.setAttribute('data-drop-action', action);

        // Drag Over (Allows dropping)
        btn.addEventListener('dragover', (e) => {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
            btn.classList.add('drag-over');
        });

        // Drag Leave (Visual cleanup)
        btn.addEventListener('dragleave', (e) => {
            btn.classList.remove('drag-over');
        });

        // Drop (Execute Action)
        btn.addEventListener('drop', (e) => {
            e.preventDefault();
            btn.classList.remove('drag-over');
            const actionType = btn.getAttribute('data-drop-action');
            
            // Clean up dragging styles on cards
            document.querySelectorAll('.card.dragging').forEach(c => c.classList.remove('dragging'));
            
            if (actionType) {
                // Call the existing bulkAction function
                window.bulkAction(actionType);
            }
        });
    });
};

// Hook up the card drag-end cleanup globally
document.addEventListener('dragend', () => {
    document.querySelectorAll('.card.dragging').forEach(c => c.classList.remove('dragging'));
});

// --- IMPORTANT: Call initDropZones at the end of your script ---
// Put this inside the window.addEventListener('DOMContentLoaded', ...) block
// window.addEventListener('DOMContentLoaded', () => {
//    ... existing code ...
//    initDropZones(); 
// });

        window.setView = (view) => {
            currentState.view = view;
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${view}`).classList.add('active');
            renderApp();
        };

        window.setFilter = (filter) => {
            currentState.filter = filter;
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`button[onclick="window.setFilter('${filter}')"]`);
            if(btn) btn.classList.add('active');
            renderApp();
        };

        // Add this near window.setFilter or window.setView
window.handleSearch = (text) => {
    currentState.search = text.toLowerCase();
    renderApp();
};

        window.updateFilter = (key, val) => { currentState[key] = val; renderApp(); };
        window.resetFilters = () => {
            currentState.projectId = 'all'; currentState.priority = 'all'; currentState.tag = 'all';
            document.getElementById('project-filter').value = 'all';
            document.getElementById('priority-filter').value = 'all';
            document.getElementById('tag-filter').value = 'all';
            renderApp();
        };

        const getFilteredTasks = () => {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const tmrw = new Date(now); tmrw.setDate(tmrw.getDate() + 1);
            const tmrwStr = tmrw.toISOString().split('T')[0];

            let tasks = taskCache;

            if (currentState.filter === 'inbox') {
                const inboxId = Object.keys(projectMap).find(id => projectMap[id].toLowerCase() === 'inbox') || 'inbox';
                tasks = tasks.filter(t => (t.projectId === inboxId || t.projectId.startsWith('inbox')) && t.status === 0);
            } else if (currentState.filter === 'today') {
                tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate).toISOString().startsWith(todayStr));
            } else if (currentState.filter === 'tomorrow') {
                tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate).toISOString().startsWith(tmrwStr));
            } else if (currentState.filter === 'overdue') {
                tasks = tasks.filter(t => t.status === 0 && t.dueDate && new Date(t.dueDate) < new Date(todayStr));
            } else if (currentState.filter === 'completed') {
                tasks = tasks.filter(t => t.status === 2); 
            } else if (currentState.filter === 'projects') {
                return []; 
            } else if (currentState.filter === 'all') {
                tasks = tasks.filter(t => t.status === 0);
            }

            if (currentState.projectId !== 'all') tasks = tasks.filter(t => t.projectId === currentState.projectId);
            if (currentState.priority !== 'all') tasks = tasks.filter(t => t.priority == currentState.priority);
            if (currentState.tag !== 'all') tasks = tasks.filter(t => (t.tags||[]).includes(currentState.tag));

            if (currentState.search) {
        tasks = tasks.filter(t => 
            t.title.toLowerCase().includes(currentState.search) || 
            (t.content && t.content.toLowerCase().includes(currentState.search))
        );
    }

            return tasks.sort((a,b) => {
                if (b.priority !== a.priority) return b.priority - a.priority;
                return new Date(a.dueDate || '9999') - new Date(b.dueDate || '9999');
            });
        };

        const renderApp = () => {
            if(!document.getElementById('content')) return; 
            if (currentState.filter === 'projects') {
                renderProjectsManager();
                els.taskCounter.textContent = '-';
                return;
            }

            const tasks = getFilteredTasks();
            els.taskCounter.textContent = tasks.length;
            if (currentState.view === 'classic') renderClassic(tasks);
            else if (currentState.view === 'calendar') renderCalendar(tasks);
            else if (currentState.view === 'kanban') renderKanban(tasks);
        };

        const renderTaskCard = (task) => {
    const isSelected = selectedTasks.has(task.id);
    
    // --- DATE CALCULATIONS ---
    const now = new Date();
    // Reset "now" to midnight so we compare dates, not times
    now.setHours(0,0,0,0);
    
    let dateBadgeHtml = '';
    let isOverdue = false;

    if (task.dueDate) {
        const dueDate = new Date(task.dueDate);
        dueDate.setHours(0,0,0,0); // Reset due date to midnight
        
        const diffTime = now - dueDate;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        isOverdue = diffDays > 0 && task.status !== 2;
        const dateStr = new Date(task.dueDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });

        // --- BADGE STYLES ---
        if (isOverdue) {
            let overdueText = diffDays === 1 ? 'Yesterday' : `${diffDays} days overdue`;
            
            // Red Alert Badge with separator bullet
            dateBadgeHtml = `
            <span class="flex items-center px-2 py-0.5 rounded border bg-red-500/10 border-red-500/20 text-red-500 font-bold" title="Due on ${dateStr}">
                <i class="fa-solid fa-triangle-exclamation mr-1.5"></i>
                <span>${dateStr}</span>
                <span class="mx-1.5 opacity-50">•</span>
                <span class="uppercase text-[10px] tracking-wide">${overdueText}</span>
            </span>`;
        } else {
            // Standard Blue Badge (Unchanged)
            dateBadgeHtml = `
            <span class="flex items-center px-2 py-0.5 rounded border bg-blue-500/10 border-transparent text-[var(--primary)]">
                <i class="fa-regular fa-clock mr-1.5"></i> ${dateStr}
            </span>`;
        }
    }

    // --- WRAPPER STYLES ---
    const wrapperClass = isSelected 
        ? 'bg-blue-900/30 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.15)] z-10 select-none' 
        : 'bg-[var(--card)] border-gray-800 hover:border-gray-600 hover:bg-gray-800/50 select-none';

    // --- SELECTION ICON ---
    const selectIcon = isSelected
        ? '<i class="fa-solid fa-circle-check text-blue-400 text-xl drop-shadow-md"></i>' 
        : '<i class="fa-regular fa-circle text-gray-500 text-xl group-hover:text-gray-300 transition-colors"></i>';
    
    // --- PRIORITY ---
    const priorityClass = `priority-${task.priority || 0}`; 
    let badgeColor = 'bg-gray-700 text-gray-300';
    let priorityText = '';
    if (task.priority === 5) { badgeColor = 'bg-red-900/30 text-red-400 border border-red-900/50'; priorityText = 'High'; }
    if (task.priority === 3) { badgeColor = 'bg-yellow-900/30 text-yellow-400 border border-yellow-900/50'; priorityText = 'Medium'; }
    if (task.priority === 1) { badgeColor = 'bg-blue-900/30 text-blue-400 border border-blue-900/50'; priorityText = 'Low'; }
    
    const projectName = projectMap[task.projectId];

    return `
    <div class="card p-0 rounded-xl border transition-all duration-200 flex group animate-fade mb-3 relative overflow-hidden ${wrapperClass}" 
         draggable="true"
         ondragstart="window.handleDragStart(event, '${task.id}')"
         data-task-id="${task.id}"
         onclick="window.openSidePane('${task.id}')">
        
        <div class="w-14 flex items-center justify-center cursor-pointer border-r border-white/5 hover:bg-white/5 transition-colors"
             onclick="window.toggleTaskSelection('${task.id}', event)">
             ${selectIcon}
        </div>

        <div class="flex-grow p-4 min-w-0">
            <div class="flex justify-between items-start">
                <div class="flex items-start gap-3 flex-grow">
                    <div class="pt-1" onclick="event.stopPropagation()">
                         <input type="checkbox" class="task-checkbox ${priorityClass}" ${task.status===2?'checked':''} onclick="window.completeTask('${task.projectId}', '${task.id}', this)">
                    </div>
                    <div class="min-w-0 flex-grow">
                        <h3 class="font-bold text-gray-100 leading-tight mb-1 truncate ${task.isAllDay ? 'italic' : ''} ${task.status===2?'line-through text-gray-500':''}">${escapeHtml(task.title)}</h3>
                        ${task.content ? `<p class="text-xs text-gray-500 line-clamp-1 mb-2">${escapeHtml(task.content)}</p>` : ''}
                    </div>
                </div>
                ${task.repeatFlag ? '<i class="fa-solid fa-arrows-rotate text-xs text-yellow-500 ml-1 mt-1 shrink-0"></i>' : ''}
            </div>
            
            ${(() => {
                if (!task.items || task.items.length === 0) return '';
                const total = task.items.length;
                const done = task.items.filter(i => i.status === 1).length;
                const percent = Math.round((done / total) * 100);
                const colorClass = percent === 100 ? 'bg-green-500' : 'bg-[var(--primary)]';
                
                return `
                <div class="mt-3 mb-1 w-full max-w-[200px]">
                    <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-mono">
                        <span><i class="fa-solid fa-list-check mr-1"></i> ${done}/${total}</span>
                        <span>${percent}%</span>
                    </div>
                    <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                        <div class="${colorClass} h-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                </div>`;
            })()}

            <div class="flex flex-wrap items-center gap-2 text-xs ml-8 mt-2">
                ${dateBadgeHtml}
                
                ${projectName ? `<span class="flex items-center text-gray-400 bg-gray-800 px-2 py-0.5 rounded border border-gray-700"><i class="fa-solid fa-layer-group mr-1 opacity-50"></i> ${escapeHtml(projectName)}</span>` : ''}
                
                ${(task.tags || []).map(getTagBadge).join('')}

                ${task.priority > 0 ? `<span class="${badgeColor} px-2 py-0.5 rounded font-bold text-[10px] uppercase">${priorityText}</span>` : ''}
            </div>
        </div>
    </div>`;
};

        // --- Add these variables at the top near your other state variables ---
let selectedTasks = new Set();
let isSelectionMode = false;

// --- Add this Logic for Selection ---

window.toggleSelectionMode = () => {
    isSelectionMode = !isSelectionMode;
    // Visual cue if needed, or just rely on the UI updates
    renderApp();
};

// Add this variable near your other state variables (e.g., near 'selectedTasks')
let lastSelectedId = null;

window.toggleTaskSelection = (id, event) => {
    if (event) event.stopPropagation();

    // Prevent default browser selection behavior immediately
    if (event && event.shiftKey) {
        event.preventDefault();
    }

    const visibleTasks = getFilteredTasks();
    const currentIndex = visibleTasks.findIndex(t => t.id === id);

    if (event && event.shiftKey && lastSelectedId) {
        // Clear any text selection the browser might have tried to make
        if(window.getSelection) window.getSelection().removeAllRanges();

        const lastIndex = visibleTasks.findIndex(t => t.id === lastSelectedId);
        
        if (lastIndex !== -1 && currentIndex !== -1) {
            const start = Math.min(lastIndex, currentIndex);
            const end = Math.max(lastIndex, currentIndex);
            for(let i = start; i <= end; i++) {
                selectedTasks.add(visibleTasks[i].id);
            }
        }
    } else {
        if (selectedTasks.has(id)) {
            selectedTasks.delete(id);
            lastSelectedId = null; 
        } else {
            selectedTasks.add(id);
            lastSelectedId = id; 
        }
    }

    updateBulkToolbar();
    renderApp(); 
};

window.selectAllOverdue = () => {
    const tasks = getFilteredTasks(); // Assuming we are on the overdue filter
    tasks.forEach(t => selectedTasks.add(t.id));
    renderApp();
    updateBulkToolbar();
    showToast(`${tasks.length} overdue tasks selected`);
};

window.clearSelection = () => {
    selectedTasks.clear();
    renderApp();
    updateBulkToolbar();
};

const updateBulkToolbar = () => {
    const bar = document.getElementById('bulk-toolbar');
    const count = document.getElementById('bulk-count');
    count.textContent = selectedTasks.size;
    
    if (selectedTasks.size > 0) {
        bar.classList.remove('translate-y-24', 'opacity-0');
    } else {
        bar.classList.add('translate-y-24', 'opacity-0');
    }
};

window.bulkAction = async (action, dateValue = null) => {
    if (selectedTasks.size === 0) return;
    
    showLoader();
    const tasksToUpdate = Array.from(selectedTasks);
    let newDateISO = null;
    let shouldRemoveDate = false; // New Flag
    
    // Calculate Date
    const now = new Date();
    
    if (action === 'today') {
        newDateISO = now.toISOString();
    } else if (action === 'tomorrow') {
        const tmrw = new Date(now);
        tmrw.setDate(tmrw.getDate() + 1);
        newDateISO = tmrw.toISOString();
    } else if (action === 'inbox') {
        // Dragging to Inbox removes the date
        shouldRemoveDate = true;
    } else if (action === 'specific' && dateValue) {
        newDateISO = new Date(dateValue).toISOString();
    }

    try {
        await Promise.all(tasksToUpdate.map(async (tid) => {
            const task = taskCache.find(t => t.id === tid);
            if (!task) return;

            if (action === 'delete') {
               // ... existing delete logic ...
               await api(`/project/${task.projectId}/task/${task.id}`, 'DELETE');
               const idx = taskCache.findIndex(t => t.id === tid);
               if (idx > -1) taskCache.splice(idx, 1);
            } else {
                // Determine Payload
                const payload = { projectId: task.projectId, title: task.title };
                
                if (shouldRemoveDate) {
                    task.dueDate = null;
                    payload.dueDate = null;
                } else if (newDateISO) {
                    task.dueDate = newDateISO;
                    payload.dueDate = newDateISO.replace(/\.\d{3}Z$/, '+0000');
                }

                await api(`/task/${tid}`, 'POST', payload);
            }
        }));
        
        // ... existing cleanup logic ...
        localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache));
        showToast(`Moved ${tasksToUpdate.length} tasks to ${action}`); // Nice feedback
        window.clearSelection();
        renderApp();
    } catch (e) {
        console.error(e);
        showToast('Error performing bulk action', 'error');
    }
    hideLoader();
};

        const renderClassic = (tasks) => {
    let html = '';
    
    // --- NEW: Add Select All Button if Overdue Filter is Active ---
    if (currentState.filter === 'overdue' && tasks.length > 0) {
        html += `
        <div class="flex justify-between items-center mb-4 bg-red-900/20 p-3 rounded-lg border border-red-900/50">
            <div class="text-red-400 text-sm font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i> ${tasks.length} Overdue Tasks</div>
            <button onclick="window.selectAllOverdue()" class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded-full font-bold transition shadow-lg">
                Select All
            </button>
        </div>`;
    }
    // -------------------------------------------------------------

    if (currentState.filter === 'completed') {
        html += `<div class="bg-blue-900/30 border border-blue-800 p-4 rounded-xl mb-6 text-sm text-blue-200"><i class="fa-solid fa-info-circle mr-2"></i> Note: To see all historical data & abandoned tasks, visit <a href="https://ticktick.com/webapp/#q/all/abandoned" target="_blank" class="underline font-bold hover:text-white">TickTick Web</a>.</div>`;
    }
    if(tasks.length === 0) html += `<div class="text-center p-12 text-gray-500"><i class="fa-solid fa-clipboard-check text-4xl mb-4 opacity-20"></i><p>No tasks found.</p></div>`;
    else html += tasks.map(renderTaskCard).join('');
    els.content.innerHTML = html;
};

        const renderProjectsManager = () => {
            const projects = Object.entries(projectMap).filter(([id]) => id !== 'inbox'); 
            let html = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Projects</h1><button onclick="window.openProjectModal()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-bold border border-gray-700">Create List</button></div>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
            html += projects.map(([id, name]) => `
                <div class="card p-5 rounded-xl border border-gray-800 flex justify-between items-center group">
                    <span class="font-bold text-lg">${escapeHtml(name)}</span>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="window.openProjectModal('${id}', '${escapeHtml(name)}')" class="p-2 text-blue-400 hover:bg-blue-900/30 rounded"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="window.deleteProject('${id}')" class="p-2 text-red-400 hover:bg-red-900/30 rounded"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            html += `</div>`;
            els.content.innerHTML = html;
        };

        const renderKanban = (tasks) => {
            const cols = {
                5: { title: 'High Priority', class: 'border-red-500/50', items: [] },
                3: { title: 'Medium Priority', class: 'border-yellow-500/50', items: [] },
                1: { title: 'Low Priority', class: 'border-blue-500/50', items: [] },
                0: { title: 'No Priority', class: 'border-gray-700', items: [] }
            };
            tasks.forEach(t => { if(cols[t.priority]) cols[t.priority].items.push(t); else cols[0].items.push(t); });
            
            let html = `<div class="flex gap-4 overflow-x-auto pb-4 h-[calc(100vh-250px)]">`;
            [5, 3, 1, 0].forEach(p => {
                const col = cols[p];
                html += `
                <div class="kanban-col bg-[var(--card)] rounded-xl border ${col.class} flex flex-col p-3">
                    <h3 class="font-bold mb-3 uppercase text-xs text-gray-400 tracking-wider">${col.title} (${col.items.length})</h3>
                    <div class="kanban-body space-y-3" id="col-${p}" data-priority="${p}">
                        ${col.items.map(t => {
                            return `<div class="bg-[var(--bg)] p-3 rounded-lg border border-gray-700 cursor-move hover:border-gray-500 shadow-sm" data-id="${t.id}" onclick="window.openSidePane('${t.id}')">
                                <p class="text-sm font-bold text-gray-200 line-clamp-2 ${t.status===2?'line-through':''}">${escapeHtml(t.title)}</p>
                                ${t.dueDate ? `<p class="text-[10px] text-gray-500 mt-1"><i class="fa-regular fa-clock"></i> ${new Date(t.dueDate).toLocaleDateString()}</p>` : ''}
                            </div>`
                        }).join('')}
                    </div>
                </div>`;
            });
            html += `</div>`;
            els.content.innerHTML = html;
            
            setTimeout(() => {
                 [5, 3, 1, 0].forEach(p => {
                    new Sortable(document.getElementById(`col-${p}`), {
                        group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                        onEnd: async (evt) => {
                            const taskId = evt.item.dataset.id;
                            const newPriority = parseInt(evt.to.dataset.priority);
                            if (newPriority !== parseInt(evt.from.dataset.priority)) {
                                const task = taskCache.find(t => t.id === taskId);
                                showLoader();
                                await api(`/task/${taskId}`, 'POST', { ...task, priority: newPriority });
                                hideLoader();
                                task.priority = newPriority; 
                            }
                        }
                    });
                });
            }, 100);
        };

        const renderCalendar = (tasks) => {
            const date = currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthName = date.toLocaleString('default', { month: 'long' });
            
            const tasksByDate = {};
            tasks.forEach(t => {
                if(!t.dueDate) return;
                const dateKey = t.dueDate.split('T')[0];
                if(!tasksByDate[dateKey]) tasksByDate[dateKey] = [];
                tasksByDate[dateKey].push(t);
            });

            const firstDay = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayKey = new Date().toISOString().split('T')[0];
            
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">${monthName} ${year}</h2>
                    <div class="flex gap-2">
                        <button onclick="window.changeMonth(-1)" class="p-2 bg-gray-800 rounded hover:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="window.changeMonth(1)" class="p-2 bg-gray-800 rounded hover:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-gray-500 uppercase"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                <div class="calendar-grid">`;

            for(let i=0; i<firstDay; i++) html += `<div class="calendar-day bg-gray-900/50"></div>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayTasks = tasksByDate[dateKey] || [];
                const dots = dayTasks.slice(0, 5).map(t => {
                    let color = t.status===2 ? 'bg-green-500' : (t.priority===5 ? 'bg-red-500' : 'bg-blue-500');
                    return `<span class="calendar-dot ${color}" title="${escapeHtml(t.title)}"></span>`;
                }).join('');
                
                html += `<div class="calendar-day ${dateKey === todayKey ? 'today' : ''}" onclick="window.showDayTasks('${dateKey}')">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-sm font-bold ${dateKey === todayKey ? 'text-[var(--primary)]' : 'text-gray-400'}">${d}</span>
                        ${dayTasks.length > 0 ? `<span class="text-[10px] text-gray-500 font-mono">${dayTasks.length}</span>` : ''}
                    </div>
                    <div class="flex flex-wrap content-start h-full pb-4">${dots}</div>
                </div>`;
            }
            html += `</div>`;
            els.content.innerHTML = html;
            window.dayTasksCache = tasksByDate;
        };

        window.changeMonth = (offset) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderApp();
        };

        window.showDayTasks = (dateKey) => {
            const tasks = window.dayTasksCache[dateKey];
            if(!tasks || tasks.length === 0) return showToast('No tasks for this date');
            const html = `<div class="flex items-center gap-4 mb-6"><button onclick="window.refreshData()" class="bg-gray-800 p-2 rounded-lg hover:bg-gray-700"><i class="fa-solid fa-arrow-left"></i> Back</button><h1 class="text-2xl font-bold">Tasks for ${dateKey}</h1></div>` + 
                         tasks.map(renderTaskCard).join('');
            els.content.innerHTML = html;
        };

        window.openSidePane = (taskId) => {
            const task = taskCache.find(t => t.id === taskId);
            if (!task) return;
            
            document.getElementById('sp-title').textContent = task.title;
            
            const descEl = document.getElementById('sp-desc-container');
            if (task.content) {
                descEl.classList.remove('hidden');
                document.getElementById('sp-desc').textContent = task.content;
            } else {
                descEl.classList.add('hidden');
            }

            document.getElementById('sp-project').textContent = projectMap[task.projectId] || 'Unknown';
            document.getElementById('sp-date').textContent = task.dueDate ? new Date(task.dueDate).toLocaleString() : 'No date';
            
            const pCont = document.getElementById('sp-priority-container');
            if(task.priority > 0) pCont.innerHTML = `<span class="bg-gray-800 border border-gray-600 px-3 py-1 rounded text-xs font-bold uppercase">Priority ${task.priority}</span>`;
            else pCont.innerHTML = '';
            
            const tCont = document.getElementById('sp-tags-container');
            tCont.innerHTML = (task.tags||[]).map(t => `<span class="bg-gray-800 text-gray-400 px-2 py-1 rounded text-xs border border-gray-700">#${t}</span>`).join('');
            
            if(task.repeatFlag) document.getElementById('sp-recurring-container').classList.remove('hidden');
            else document.getElementById('sp-recurring-container').classList.add('hidden');
            
            window.renderSidePaneChecklist(task);

            document.getElementById('sp-trash-btn').onclick = () => { if(confirm("Trash this task?")) window.deleteTask(task.projectId, task.id); };
            document.getElementById('sp-edit-btn').onclick = () => window.openModal(true, taskId);
            
            const compBtn = document.getElementById('sp-complete-btn');
            if (task.status === 2) {
                compBtn.className = "flex-1 bg-gray-700 text-gray-400 py-3 rounded-xl font-bold cursor-not-allowed";
                compBtn.innerHTML = '<i class="fa-solid fa-check"></i> Completed';
                compBtn.onclick = null;
            } else {
                compBtn.className = "flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition";
                compBtn.innerHTML = '<i class="fa-solid fa-check"></i> Complete';
                compBtn.onclick = () => {
                    window.completeTask(task.projectId, task.id, null); 
                    window.closeSidePane();
                };
            }

            const overlay = document.getElementById('side-pane-overlay');
            const pane = document.getElementById('side-pane');
            overlay.classList.remove('hidden');
            void overlay.offsetWidth; overlay.classList.remove('opacity-0');
            pane.classList.remove('translate-x-full');
        };

        window.renderSidePaneChecklist = (task) => {
            const listEl = document.getElementById('sp-checklist-items');
            if(!listEl) return;
            
            listEl.innerHTML = '';
            if(task.items && task.items.length > 0) {
                listEl.innerHTML = '<h3 class="text-xs font-bold text-gray-500 uppercase mb-2 mt-6">Subtasks</h3>';
                task.items.forEach((item, idx) => {
                    const icon = item.status === 1 ? 'fa-square-check text-green-500' : 'fa-square text-gray-500';
                    const textClass = item.status === 1 ? 'line-through text-gray-600' : 'text-gray-300';
                    listEl.innerHTML += `<div class="flex items-center gap-3 p-2 bg-[var(--bg)] rounded-lg cursor-pointer hover:bg-gray-800 transition" onclick="window.toggleSubtask('${task.id}', ${idx})"><i class="fa-regular ${icon}"></i><span class="text-sm ${textClass}">${escapeHtml(item.title)}</span></div>`;
                });
            }
        };

        window.closeSidePane = () => {
            const pane = document.getElementById('side-pane');
            const overlay = document.getElementById('side-pane-overlay');
            pane.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        };

        window.openAddTaskModal = () => window.openModal(false);
        window.openModal = (isEdit, taskId = null) => {
            const modal = document.getElementById('task-modal');
            const pSelect = document.getElementById('modal-project-input');
            pSelect.innerHTML = Object.entries(projectMap).map(([id, name]) => `<option value="${id}">${escapeHtml(name)}</option>`).join('');
            if(!Object.keys(projectMap).find(id => projectMap[id].toLowerCase() === 'inbox')) {
                pSelect.innerHTML = `<option value="inbox">Inbox</option>` + pSelect.innerHTML;
            }

            if (isEdit && taskId) {
                const task = taskCache.find(t => t.id === taskId);
                document.getElementById('modal-title').textContent = "Edit Task";
                document.getElementById('modal-task-id').value = task.id;
                document.getElementById('modal-title-input').value = task.title;
                document.getElementById('modal-desc-input').value = task.content || '';
                document.getElementById('modal-tags-input').value = (task.tags || []).join(', ');
                document.getElementById('modal-priority-input').value = task.priority || 0;
                document.getElementById('modal-project-input').value = task.projectId;
                document.getElementById('modal-allday-input').checked = !!task.isAllDay;
                document.getElementById('modal-repeat-input').value = task.repeatFlag || "";
                
                const fmtDate = (iso) => iso ? new Date(new Date(iso) - (new Date(iso).getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
                document.getElementById('modal-start-date').value = fmtDate(task.startDate);
                document.getElementById('modal-due-date').value = fmtDate(task.dueDate);
            } else {
                document.getElementById('modal-title').textContent = "New Task";
                document.getElementById('modal-task-id').value = '';
                document.getElementById('modal-title-input').value = '';
                document.getElementById('modal-desc-input').value = '';
                document.getElementById('modal-tags-input').value = '';
                document.getElementById('modal-start-date').value = '';
                document.getElementById('modal-due-date').value = '';
                document.getElementById('modal-priority-input').value = 0;
                document.getElementById('modal-allday-input').checked = false;
                document.getElementById('modal-repeat-input').value = "";
            }
            modal.classList.remove('hidden');
        };

        // Project CRUD
        window.openProjectModal = (id = null, name = '') => {
            document.getElementById('project-modal-id').value = id || '';
            document.getElementById('project-name-input').value = name;
            document.getElementById('project-modal-title').textContent = id ? 'Edit Project' : 'New Project';
            document.getElementById('project-modal').classList.remove('hidden');
        };

        window.submitProjectForm = async () => {
            const id = document.getElementById('project-modal-id').value;
            const name = document.getElementById('project-name-input').value;
            if(!name) return showToast('Name required', 'error');
            
            showLoader();
            try {
                if(id) await api(`/project/${id}`, 'POST', { name });
                else await api('/project', 'POST', { name });
                showToast('Project saved');
                document.getElementById('project-modal').classList.add('hidden');
                fetchAllData();
            } catch(e) { showToast('Error', 'error'); }
            hideLoader();
        };

        window.deleteProject = async (id) => {
            if(confirm("Delete this project and all its tasks?")) {
                showLoader();
                try {
                    await api(`/project/${id}`, 'DELETE');
                    showToast('Project deleted');
                    fetchAllData();
                } catch(e) { showToast('Error', 'error'); }
                hideLoader();
            }
        };

        window.submitTaskForm = async () => {
            const id = document.getElementById('modal-task-id').value;
            const payload = {
                title: document.getElementById('modal-title-input').value,
                content: document.getElementById('modal-desc-input').value,
                projectId: document.getElementById('modal-project-input').value,
                priority: parseInt(document.getElementById('modal-priority-input').value),
                isAllDay: document.getElementById('modal-allday-input').checked,
                tags: document.getElementById('modal-tags-input').value.split(',').map(t=>t.trim()).filter(t=>t),
                repeatFlag: document.getElementById('modal-repeat-input').value || null
            };
            
            const dueVal = document.getElementById('modal-due-date').value;
            if(dueVal) payload.dueDate = new Date(dueVal).toISOString().replace(/\.\d{3}Z$/, '+0000');
            const startVal = document.getElementById('modal-start-date').value;
            if(startVal) payload.startDate = new Date(startVal).toISOString().replace(/\.\d{3}Z$/, '+0000');

            showLoader();
            try {
                if(id) await api(`/task/${id}`, 'POST', payload);
                else await api('/task', 'POST', payload);
                showToast('Success!');
                els.modal.classList.add('hidden');
                window.closeSidePane();
                fetchAllData();
            } catch(e) { showToast('Error', 'error'); }
            hideLoader();
        };

        window.completeTask = async (pid, tid, checkbox) => {
             const task = taskCache.find(t => t.id === tid);
             if(!task) return;
             const oldStatus = task.status;
             task.status = 2; // Optimistic
             localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache));
             renderApp();

             try {
                await api(`/project/${pid}/task/${tid}/complete`, 'POST');
                showToast('Task completed', 'success', 'Undo', async () => {
                     task.status = 0;
                     localStorage.setItem('ticktrackr_tasks', JSON.stringify(taskCache));
                     renderApp();
                     await api(`/task/${tid}`, 'POST', { projectId: task.projectId, title: task.title, status: 0 }); 
                     fetchAllData();
                });
                setTimeout(fetchAllData, 1000); 
            } catch(e) { 
                 task.status = oldStatus;
                 if(checkbox) checkbox.checked = false;
                 renderApp();
                 showToast('Failed to complete', 'error'); 
             }
        };

        window.toggleSubtask = async (taskId, itemIndex) => {
            const task = taskCache.find(t => t.id === taskId);
            if(!task || !task.items) return;
            const item = task.items[itemIndex];
            const oldStatus = item.status;
            const newStatus = oldStatus === 1 ? 0 : 1;
            item.status = newStatus; 
            window.renderSidePaneChecklist(task);
            renderApp(); 
            try {
                const payload = { title: task.title, projectId: task.projectId, items: task.items };
                await api(`/task/${taskId}`, 'POST', payload);
            } catch(e) {
                item.status = oldStatus;
                window.renderSidePaneChecklist(task);
                showToast('Subtask update failed', 'error');
            }
        };

        window.deleteTask = async (pid, tid) => {
            if(confirm("Are you sure?")) {
                showLoader();
                await api(`/project/${pid}/task/${tid}`, 'DELETE');
                showToast('Deleted');
                window.closeSidePane();
                fetchAllData();
            }
        };

        window.refreshData = () => fetchAllData();
        window.changeMonth = (o) => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+o); renderApp(); };
        window.showDayTasks = (k) => { 
            const tasks = window.dayTasksCache[k] || [];
            els.content.innerHTML = `<div class="flex items-center gap-4 mb-6"><button onclick="renderApp()" class="bg-gray-800 p-2 rounded-lg"><i class="fa-solid fa-arrow-left"></i> Back</button><h1 class="text-2xl font-bold">Tasks for ${k}</h1></div>` + tasks.map(renderTaskCard).join('');
        };

        const checkAuthCode = async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                showLoader();
                window.history.replaceState({}, document.title, window.location.pathname);
                try {
                    const credentials = btoa(`${TICKTICK_CLIENT_ID}:${TICKTICK_CLIENT_SECRET}`);
                    const response = await fetch('https://ticktick.com/oauth/token', {
                        method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': `Basic ${credentials}`},
                        body: new URLSearchParams({code, grant_type: 'authorization_code', scope: 'tasks:read tasks:write', redirect_uri: TICKTICK_REDIRECT_URI})
                    });
                    const data = await response.json();
                    if (data.access_token) {
                        accessToken = data.access_token;
                        localStorage.setItem('ticktick_token', accessToken);
                        fetchAllData();
                    } 
                } catch(e) { console.error(e); }
                hideLoader();
            }
        };
        
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').onclick = () => {
                location.href = `https://ticktick.com/oauth/authorize?client_id=${TICKTICK_CLIENT_ID}&scope=tasks:read%20tasks:write&response_type=code&redirect_uri=${encodeURIComponent(TICKTICK_REDIRECT_URI)}`;
            };
            document.getElementById('theme-toggle').onclick = () => { document.documentElement.classList.toggle('dark'); };

            // --- KEYBOARD SHORTCUTS ---
    document.addEventListener('keydown', (e) => {
        // Ignore shortcuts if user is typing in an input box
        if (e.target.matches('input, textarea, select')) {
            // Allow "Escape" to blur input
            if(e.key === 'Escape') e.target.blur();
            return;
        }

        // 'N' => Open New Task Modal
        if (e.key.toLowerCase() === 'n') {
            e.preventDefault();
            window.openAddTaskModal();
        }

        // '/' => Focus Search or Quick Add
        if (e.key === '/') {
            e.preventDefault();
            document.getElementById('quick-add-input').focus();
        }

        // 'Escape' => Close Modal or Sidebar
        if (e.key === 'Escape') {
            document.getElementById('task-modal').classList.add('hidden');
            document.getElementById('project-modal').classList.add('hidden');
            window.closeSidePane();
            window.clearSelection();
        }
        
        // 'R' => Refresh
        if (e.key.toLowerCase() === 'r' && !e.metaKey && !e.ctrlKey) {
            window.refreshData();
        }
    });

            if (accessToken) fetchAllData();
            else if (location.search.includes('code=')) checkAuthCode();
            else document.getElementById('login-overlay').classList.remove('hidden');
            initDropZones();
        });
    </script>

    <div id="bulk-toolbar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-[#1f2937] border border-gray-600 shadow-2xl rounded-full px-6 py-3 flex items-center gap-4 z-50 transition-all duration-300 translate-y-24 opacity-0">
    <div class="flex items-center gap-2 border-r border-gray-600 pr-4 mr-2">
        <span id="bulk-count" class="bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
        <span class="text-sm font-bold text-gray-300">Selected</span>
    </div>
    
    <button onclick="window.bulkAction('today')" class="text-gray-400 hover:text-white flex flex-col items-center group" title="Move to Today">
        <i class="fa-solid fa-calendar-day text-lg group-hover:text-blue-500 transition"></i>
        <span class="text-[10px] font-bold mt-1">Today</span>
    </button>
    
    <button onclick="window.bulkAction('tomorrow')" class="text-gray-400 hover:text-white flex flex-col items-center group" title="Move to Tomorrow">
        <i class="fa-solid fa-sun text-lg group-hover:text-yellow-500 transition"></i>
        <span class="text-[10px] font-bold mt-1">Tomorrow</span>
    </button>

    <div class="relative group">
        <button onclick="document.getElementById('bulk-date-picker').showPicker()" class="text-gray-400 hover:text-white flex flex-col items-center group" title="Pick Date">
            <i class="fa-regular fa-calendar text-lg group-hover:text-green-500 transition"></i>
            <span class="text-[10px] font-bold mt-1">Pick Date</span>
        </button>
        <input type="date" id="bulk-date-picker" onchange="window.bulkAction('specific', this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
    </div>

    <div class="w-px h-8 bg-gray-600 mx-1"></div>

    <button onclick="window.bulkAction('delete')" class="text-gray-400 hover:text-red-500 flex flex-col items-center group" title="Delete">
        <i class="fa-solid fa-trash text-lg transition"></i>
        <span class="text-[10px] font-bold mt-1">Trash</span>
    </button>

    <button onclick="window.clearSelection()" class="ml-4 text-xs font-bold text-gray-500 hover:text-white border border-gray-600 px-2 py-1 rounded hover:bg-gray-700 transition">
        Cancel
    </button>
</div>
</body>
</html>