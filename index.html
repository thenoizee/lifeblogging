<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 420px; /* Mobile-first design */
            padding: 1rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 1rem; /* Added margin for separation */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="auth-container" class="container" style="display: none;">
    <div class="card">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Daily Logger</h1>
        <p class="text-gray-600 text-center mb-4">Please log in to continue.</p>
        <div class="mb-4">
            <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
            <input type="email" id="email" placeholder="you@example.com" class="w-full bg-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
            <input type="password" id="password" placeholder="********" class="w-full bg-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex flex-col space-y-4">
            <div class="flex space-x-4">
                <button id="sign-up-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg flex-1">Sign Up</button>
                <button id="sign-in-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out shadow-lg flex-1">Log In</button>
            </div>
            <button id="google-sign-in-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 ease-in-out shadow-lg flex-1">
                Sign in with Google
            </button>
        </div>
    </div>
</div>

<div id="main-app-container" class="container space-y-4" style="display: none;">
    <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Sleep Quality</h2>
        <div class="flex justify-between items-center space-x-2">
            <span class="text-sm text-gray-600">Poor</span>
            <div class="flex-1 flex justify-center space-x-2">
                <button data-key="sleep_quality" data-value="1" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">1</button>
                <button data-key="sleep_quality" data-value="2" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">2</button>
                <button data-key="sleep_quality" data-value="3" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">3</button>
                <button data-key="sleep_quality" data-value="4" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">4</button>
                <button data-key="sleep_quality" data-value="5" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">5</button>
            </div>
            <span class="text-sm text-gray-600">Great</span>
        </div>
    </div>

    <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Productiveness</h2>
        <div class="flex justify-between items-center space-x-2">
            <span class="text-sm text-gray-600">Low</span>
            <div class="flex-1 flex justify-center space-x-2">
                <button data-key="productiveness" data-value="1" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">1</button>
                <button data-key="productiveness" data-value="2" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">2</button>
                <button data-key="productiveness" data-value="3" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">3</button>
                <button data-key="productiveness" data-value="4" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">4</button>
                <button data-key="productiveness" data-value="5" class="rating-btn bg-gray-200 text-gray-700 font-bold w-10 h-10 rounded-full hover:bg-blue-600 hover:text-white transition-colors duration-200">5</button>
            </div>
            <span class="text-sm text-gray-600">High</span>
        </div>
    </div>
    
    <div class="card">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Quick Log</h1>
        <p class="text-gray-600 text-center mb-4">Log a single data point to your database.</p>
        
        <div class="mb-4">
            <label for="manual-key" class="block text-gray-700 font-semibold mb-2">Attribute Name</label>
            <input type="text" id="manual-key" placeholder="e.g., mood, coffee_cups" class="w-full bg-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-4">
            <label for="manual-value" class="block text-gray-700 font-semibold mb-2">Value</label>
            <input type="text" id="manual-value" placeholder="e.g., 8 (for mood) or 'great'" class="w-full bg-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-6">
            <label for="manual-tags" class="block text-gray-700 font-semibold mb-2">Tags (comma-separated)</label>
            <input type="text" id="manual-tags" placeholder="e.g., work, personal" class="w-full bg-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <button id="manual-add-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg flex items-center justify-center">
            <div id="add-spinner" class="spinner hidden"></div>
            <span id="add-text">Add Data Point</span>
        </button>
    </div>
</div>

<div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300 opacity-0" role="alert"></div>


<!-- Firebase Scripts -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        signInWithPopup, 
        GoogleAuthProvider,
        signInWithCustomToken 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        collection, 
        serverTimestamp,
        addDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase Initialization ---
    let app, auth, db;
    let userId;
    let manualSourceId;

    async function initFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing.");
            showMessage("Firebase is not configured. Data persistence will not work.", 'error', 0);
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, async (user) => {
                const mainAppContainer = document.getElementById('main-app-container');
                const authContainer = document.getElementById('auth-container');

                if (user) {
                    userId = user.uid;
                    authContainer.style.display = 'none';
                    mainAppContainer.style.display = 'block';
                    await getOrCreateManualSource();
                } else {
                    userId = null;
                    authContainer.style.display = 'block';
                    mainAppContainer.style.display = 'none';
                }
            });

            // Handle the custom auth token for the canvas environment
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            }
        } catch (error) {
            console.error("Error during Firebase initialization or sign-in:", error);
            showMessage(`Authentication Error: ${error.message}`, 'error', 0);
        }
    }

    async function getOrCreateManualSource() {
        if (!userId) return;
        const sourcesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/sources`);
        const manualDocRef = doc(sourcesCollectionRef, 'Manual');
        
        try {
            // We can't use getDoc due to platform limitations, so we will create it directly.
            // If it already exists, setDoc will just update it.
            await setDoc(manualDocRef, {
                name: 'Manual',
                createdAt: serverTimestamp()
            }, { merge: true });
            manualSourceId = 'Manual';
            console.log("Manual source ensured to exist.");
        } catch (e) {
            console.error("Error ensuring Manual source:", e);
            showMessage(`Failed to get or create 'Manual' source: ${e.message}`, 'error');
        }
    }

    // --- Utility Functions ---
    function showMessage(message, type = 'success', duration = 3000) {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        
        // Remove previous type classes
        msgBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500');
        
        switch(type) {
            case 'success':
                msgBox.classList.add('bg-green-500');
                break;
            case 'error':
                msgBox.classList.add('bg-red-500');
                break;
            case 'info':
                msgBox.classList.add('bg-blue-500');
                break;
            default:
                msgBox.classList.add('bg-gray-500');
                break;
        }
        
        // Make it visible
        msgBox.classList.remove('opacity-0');
        msgBox.classList.add('opacity-100');

        if (duration > 0) {
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, duration);
        }
    }

    // --- Data Handling ---
    async function addDataPoint(key, value, tags) {
        if (!userId || !manualSourceId) {
            showMessage("Not signed in or manual source not ready.", 'error');
            return;
        }

        if (!key || !value) {
            showMessage("Attribute Name and Value are required.", 'error');
            return;
        }

        const today = new Date();
        const dateString = today.toISOString().split('T')[0];

        // This is the function that handles the actual data push
        const pushData = async (data) => {
            const dataCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/data`);
            const docData = {
                date: dateString,
                key: data.key.toLowerCase(),
                value: data.value,
                tags: data.tags,
                sourceId: manualSourceId,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(dataCollectionRef, docData);
                showMessage(`Logged ${data.key}: ${data.value} successfully!`, 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage(`Error adding data point: ${e.message}`, 'error');
            }
        };

        // If 'value' is a number, store it as a float, otherwise as a string.
        const parsedValue = isNaN(value) ? value : parseFloat(value);
        await pushData({ key, value: parsedValue, tags });
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        initFirebase();

        // Auth listeners (unchanged)
        document.getElementById('sign-up-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Account created successfully! You are now signed in.");
            } catch (error) {
                showMessage(`Sign Up failed: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('sign-in-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Signed in successfully!");
            } catch (error) {
                showMessage(`Log In failed: ${error.message}`, 'error');
            }
        });

        document.getElementById('google-sign-in-btn').addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Signed in with Google successfully!");
            } catch (error) {
                showMessage(`Google sign in failed: ${error.message}`, 'error');
            }
        });

        // Event listener for the new rating buttons
        const ratingButtons = document.querySelectorAll('.rating-btn');
        ratingButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const key = button.getAttribute('data-key');
                const value = parseInt(button.getAttribute('data-value'), 10);
                const tags = []; // No tags for these quick logs
                
                await addDataPoint(key, value, tags);
            });
        });

        // Main app listener for the free-form input
        document.getElementById('manual-add-btn').addEventListener('click', async () => {
            const key = document.getElementById('manual-key').value;
            const value = document.getElementById('manual-value').value;
            const tags = document.getElementById('manual-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            
            const addButton = document.getElementById('manual-add-btn');
            const spinner = document.getElementById('add-spinner');
            const buttonText = document.getElementById('add-text');
            
            // Show loading state
            buttonText.textContent = '';
            spinner.classList.remove('hidden');
            addButton.disabled = true;

            await addDataPoint(key, value, tags);
            
            // Hide loading state
            spinner.classList.add('hidden');
            buttonText.textContent = 'Add Data Point';
            addButton.disabled = false;
            
            // Clear input fields
            document.getElementById('manual-key').value = '';
            document.getElementById('manual-value').value = '';
            document.getElementById('manual-tags').value = '';
        });
    });

</script>

</body>
</html>
