<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecipeManagr</title>
    <link rel="icon" href="/favicons/utensils.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
    /* Theme Variables (Copied from VidTrackr, Primary set to Teal) */
    :root {
        --primary: #0d9488; /* teal-600 */
        --primary-hover: #0f766e; /* teal-700 */
        --bg-dark: #111827; --card-dark: #1f2937; --text-dark: #f9fafb;
        --bg-light: #f3f4f6; --card-light: #ffffff; --text-light: #111827;
    }
    .dark { --bg: var(--bg-dark); --card: var(--card-dark); --text: var(--text-dark); }
    /* Default to light mode variables if class is missing, or add .light class to body if needed */
    :root:not(.dark) { --bg: var(--bg-light); --card: var(--card-light); --text: var(--text-light); }

    body { background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
    .card { background-color: var(--card); transition: background-color 0.3s; }

    /* Button & Nav Styles */
    .btn-primary { background-color: var(--primary); color: white; transition: 0.2s; }
    .btn-primary:hover { background-color: var(--primary-hover); }

    .nav-tab { 
        padding: 0.5rem 1rem; 
        border-radius: 0.5rem; 
        transition: all 0.2s; 
        font-weight: 600; 
        color: #9ca3af; /* Gray-400 */
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
    }
    .nav-tab:hover { color: var(--text); background: rgba(0,0,0,0.05); }
    .dark .nav-tab:hover { background: rgba(255,255,255,0.05); }
    .nav-tab.active { 
        color: var(--primary); 
        background: rgba(13, 148, 136, 0.1); /* Teal with opacity */
    }

    /* Print Styles */
    @media print {
        body > *:not(#print-area) { display: none !important; }
        body, html { height: auto !important; overflow: visible !important; background-color: white !important; }
        #print-area { display: block !important; width: 100% !important; color: black !important; padding: 20px; }
        .print-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; }
        .timer-btn { border: 1px solid #ddd; }
    }
/* Safe Area Padding for iPhone Home Bar */
.pb-safe {
    padding-bottom: env(safe-area-inset-bottom, 20px);
}

/* Hide Scrollbar for cleaner UI */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}
    /* Cook Mode Animations */
@keyframes fadeInSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

#cook-active-card {
    animation: fadeInSlide 0.3s ease-out;
}

/* Custom Scrollbar for the card text */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 20px;
}
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <header class="sticky top-0 bg-[var(--card)] shadow-lg z-50 shrink-0">
    <div class="container mx-auto px-4 py-2">
        <div class="flex items-center justify-between mb-2 mt-1">
            
            <div class="flex items-center space-x-4">
                <a href="/" class="btn-primary text-xs font-bold py-1.5 px-3 rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i> Hub
                </a>
                <a href="/" class="flex items-center space-x-2 text-2xl font-bold text-[var(--primary)]">
                    <i class="fas fa-book-open"></i>
                    <span class="hidden sm:inline tracking-tight">RecipeManagr</span>
                </a>
            </div>

            <nav id="main-nav" class="hidden md:flex space-x-1 bg-gray-100 dark:bg-gray-800/30 p-1 rounded-lg">
                <button id="recipes-tab-btn" class="nav-tab text-xs sm:text-sm active" data-tab="recipes">
                    <i class="fas fa-book-open mr-1"></i> Recipes
                </button>
                <button id="add-recipe-tab-btn" class="nav-tab text-xs sm:text-sm" data-tab="add-recipe">
                    <i class="fas fa-plus-circle mr-1"></i> Add
                </button>
                <button id="timeline-tab-btn" class="nav-tab text-xs sm:text-sm" data-tab="timeline">
                    <i class="fas fa-history mr-1"></i> Timeline
                </button>
            </nav>

            <div class="flex items-center space-x-2">
                <div id="options-menu-container" class="relative">
                    <button id="options-btn" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition text-gray-500 dark:text-gray-400">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                    <div id="options-panel" class="hidden absolute right-0 mt-2 w-72 bg-[var(--card)] rounded-lg shadow-xl p-4 space-y-4 border dark:border-gray-700 z-50">
                        <h4 class="font-bold text-lg">Options</h4>
                        <div class="flex justify-between items-center">
                            <label>Layout</label>
                            <select id="layout-select" class="p-1 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm">
                                <option value="tiles">Tiles</option>
                                <option value="list">List</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="show-images-toggle" class="text-sm">Show Images</label>
                            <input type="checkbox" id="show-images-toggle" class="accent-[var(--primary)]" checked/>
                        </div>
                         <div class="flex justify-between items-center">
                            <label for="show-labels-toggle" class="text-sm">Show Labels</label>
                            <input type="checkbox" id="show-labels-toggle" class="accent-[var(--primary)]" checked/>
                        </div>
                        <div class="border-t dark:border-gray-700 pt-4 space-y-2">
                             <button id="multi-select-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">
                                <i class="fas fa-check-square"></i> Select Multiple
                            </button>
                             <button id="shopping-list-mode-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-shopping-cart"></i> Shopping List Mode
                            </button>
                            <button id="manage-appliances-btn" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 text-sm">
                                <i class="fas fa-blender"></i> Manage Appliances
                            </button>
                             <button id="manage-books-btn" class="w-full bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 text-sm">
                                <i class="fas fa-book"></i> Manage Books
                            </button>
                            <button id="select-by-label-btn" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 text-sm mt-2">
    <i class="fas fa-tags"></i> Select all in Label
</button>
                        </div>
                    </div>
                </div>

                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition text-gray-500 dark:text-gray-400" title="Toggle Theme">
                    <i class="fas fa-moon text-lg"></i>
                </button>
            </div>
        </div>
    </div>
</header>
<nav class="md:hidden fixed bottom-0 left-0 right-0 bg-[var(--card)] border-t border-gray-800 z-50 flex justify-around py-3 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
    <button class="mobile-nav-link text-gray-400 flex flex-col items-center text-xs" onclick="switchTab('recipes'); window.scrollTo(0,0)">
        <i class="fas fa-book-open text-lg mb-1"></i><span>Recipes</span>
    </button>
    <button class="mobile-nav-link text-gray-400 flex flex-col items-center text-xs" onclick="switchTab('add-recipe'); window.scrollTo(0,0)">
        <i class="fas fa-plus-circle text-lg mb-1"></i><span>Add</span>
    </button>
    <button class="mobile-nav-link text-gray-400 flex flex-col items-center text-xs" onclick="switchTab('timeline'); window.scrollTo(0,0)">
        <i class="fas fa-history text-lg mb-1"></i><span>Timeline</span>
    </button>
</nav>

    <div id="app-container" class="container mx-auto p-2 md:p-4">
         <div id="bulk-actions-bar" class="hidden bg-teal-100 dark:bg-teal-900 p-2 rounded-lg mb-4 flex flex-wrap gap-2 justify-between items-center">
    <span id="selection-count" class="font-bold text-teal-900 dark:text-teal-100 px-2">0 selected</span>
    <div class="flex flex-wrap gap-2">
        <button id="generate-shopping-list-btn" class="hidden bg-green-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-green-600 text-sm">
            <i class="fas fa-list-check mr-1"></i> Shop List
        </button>
        <button id="bulk-add-label-btn" class="bg-teal-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-teal-700 text-sm">
            <i class="fas fa-tag mr-1"></i> Add Label
        </button>
        <button id="bulk-assign-book-btn" class="bg-orange-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-orange-700 text-sm">
            <i class="fas fa-book mr-1"></i> Collection
        </button>
        <button id="bulk-delete-btn" class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">
            <i class="fas fa-trash mr-1"></i> Delete
        </button>
        <button id="cancel-selection-btn" class="bg-gray-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-gray-600 text-sm">Cancel</button>
    </div>
</div>

        

        <div id="tab-content-container">
            <div id="recipes-tab-panel">
    <div class="sticky top-[60px] md:top-[70px] z-30 bg-gray-100 dark:bg-gray-900 pt-2 pb-3 mb-2">
        <input type="text" id="search-bar" placeholder="ðŸ”Ž Search recipes..." class="w-full p-3 shadow-sm border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base focus:ring-2 focus:ring-teal-500 outline-none transition-shadow">
    </div>

    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
    <div class="flex justify-between items-center mb-2 md:mb-4">
        <h3 class="text-xl font-bold">Filter & Sort</h3>
        <button id="mobile-filter-toggle" class="md:hidden text-teal dark:text-teal-400 font-semibold text-sm">
            <i class="fas fa-filter mr-1"></i> Show/Hide
        </button>
    </div>
    


<div id="filter-container" class="hidden md:block mt-4 pt-4 border-t dark:border-gray-700">    
    <div class="flex flex-col md:flex-row gap-4 mb-4 border-b dark:border-gray-600 pb-4">
        <div class="flex items-center gap-2 flex-shrink-0 w-full md:w-auto">
             <label class="text-sm font-bold">Min Rating:</label>
             <select id="filter-rating" class="p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                <option value="0">Any</option>
                <option value="3">3+</option>
                <option value="4">4+</option>
                <option value="5">5 Only</option>
            </select>
        </div>
        <button id="clear-filters-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 flex-shrink-0">Reset All</button>
    </div>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-sm">
        
        <div>
            <h4 class="font-bold mb-2 text-teal-600 dark:text-teal-400 border-b border-gray-300 dark:border-gray-600 pb-1">Flavour</h4>
            <div class="space-y-1">
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-flavor" value="Savoury" class="rounded text-teal-600"><span>Savoury</span></label>
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-flavor" value="Sweet" class="rounded text-teal-600"><span>Sweet</span></label>
            </div>
        </div>

        <div>
            <h4 class="font-bold mb-2 text-teal-600 dark:text-teal-400 border-b border-gray-300 dark:border-gray-600 pb-1">Meal Type</h4>
            <div class="space-y-1">
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-meal" value="Breakfast" class="rounded text-teal-600"><span>Breakfast</span></label>
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-meal" value="Lunch" class="rounded text-teal-600"><span>Lunch</span></label>
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-meal" value="Dinner" class="rounded text-teal-600"><span>Dinner</span></label>
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-meal" value="Snack" class="rounded text-teal-600"><span>Snack</span></label>
                <label class="flex items-center space-x-2"><input type="checkbox" name="filter-meal" value="Dessert" class="rounded text-teal-600"><span>Dessert</span></label>
            </div>
        </div>

        <div>
            <h4 class="font-bold mb-2 text-teal-600 dark:text-teal-400 border-b border-gray-300 dark:border-gray-600 pb-1">Cuisine</h4>
            <div id="filter-cuisine-list" class="space-y-1 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                </div>
        </div>

        <div>
            <h4 class="font-bold mb-2 text-teal-600 dark:text-teal-400 border-b border-gray-300 dark:border-gray-600 pb-1">Labels</h4>
            <div id="filter-label-list" class="space-y-1 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                </div>
        </div>
    </div>
</div>
</div>

                <div>
                    <h2 class="text-2xl font-bold mb-4">Your Recipes</h2>
                    <div id="recipe-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>
            </div>

            <div id="add-recipe-tab-panel" class="hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                    <h2 class="text-2xl font-bold mb-4">Import Recipes</h2>
                     <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Import from RecipeSage TXT URL</label>
                            <div class="flex flex-col md:flex-row gap-2">
                                <input type="url" id="import-txt-url-input" placeholder="Enter RecipeSage TXT export URL" class="flex-grow p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                                <button id="fetch-txt-url-btn" type="button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Fetch TXT</button>
                            </div>
                        </div>
                        <div class="text-center text-sm font-semibold">OR</div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Import from URL (JSON-LD)</label>
                            <div id="import-form" class="flex flex-col md:flex-row gap-2">
                                <input type="url" id="import-url-input" placeholder="Enter recipe URL" class="flex-grow p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                                <button id="fetch-url-btn" type="button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Fetch JSON-LD</button>
                            </div>
                        </div>
                        <div class="text-center text-sm font-semibold">OR</div>
                        <div>
                            <label for="import-file-input" class="block text-sm font-medium mb-1">Import from File (.txt or .jsonld)</label>
                            <input type="file" id="import-file-input" accept=".txt,.jsonld,.json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                        </div>
                    </div>
                    <div id="import-review-section" class="hidden mt-4 p-4 border-t dark:border-gray-700">
                        <p id="import-summary-text" class="font-semibold mb-4"></p>
                        <div class="flex flex-col md:flex-row gap-2">
                             <button id="batch-import-btn" type="button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center">
                                <i class="fas fa-file-import mr-2"></i> Import All Recipes
                            </button>
                             <button id="load-first-recipe-btn" type="button" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 flex items-center justify-center">
                                <i class="fas fa-edit mr-2"></i> Load First Recipe in Editor
                            </button>
                        </div>
                    </div>
                </div>
                 <div id="add-recipe-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                    <h2 id="form-summary" class="text-2xl font-bold">Add a New Recipe</h2>
                    <form id="add-recipe-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    
    <div class="lg:col-span-3 bg-teal-50 dark:bg-teal-900/30 p-3 rounded-lg border border-teal-100 dark:border-teal-800 mb-2">
        <label class="block text-sm font-bold text-teal-900 dark:text-teal-200 mb-2">Recipe Type</label>
        <div class="flex flex-wrap gap-4">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="recipe-type" value="standard" checked class="text-teal-600 focus:ring-teal-500 w-4 h-4">
                <span class="text-sm font-medium">Standard Recipe</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="recipe-type" value="food_item" class="text-teal-600 focus:ring-teal-500 w-4 h-4">
                <span class="text-sm font-medium">Ingredient / Food Item</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="recipe-type" value="howto" class="text-teal-600 focus:ring-teal-500 w-4 h-4">
                <span class="text-sm font-medium">How-to / Guide</span>
            </label>
        </div>
        <p id="type-description" class="text-xs text-teal-700 dark:text-teal-300 mt-2">Standard cooking recipe with ingredients and steps.</p>
    </div>

    <div>
        <label for="recipe-book-select" class="block text-sm font-medium mb-1">Recipe Book / Collection</label>
        <select id="recipe-book-select" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
            <option value="">Unassigned</option>
        </select>
    </div>

    <div class="lg:col-span-2"> <label for="adapted-from-select" class="block text-sm font-medium mb-1">Adapted From (Parent Recipe)</label>
        <select id="adapted-from-select" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
            <option value="">None (Original)</option>
        </select>
    </div>

    <div class="lg:col-span-3">
        <label for="recipe-name" class="block text-sm font-medium mb-1">Title</label>
        <input type="text" id="recipe-name" placeholder="e.g., Spicy Chicken Curry" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
    </div>
                        <div class="lg:col-span-3">
                            <label for="recipe-description" class="block text-sm font-medium mb-1">Description</label>
                            <textarea id="recipe-description" placeholder="A short summary of the dish" rows="3" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full"></textarea>
                        </div>
                        <div>
                            <label for="recipe-cuisine" class="block text-sm font-medium mb-1">Cuisine</label>
                            <input type="text" id="recipe-cuisine" placeholder="e.g., Italian" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                        </div>
                        <div>
                             <label class="block text-sm font-medium mb-1">Yield</label>
                            <div class="flex gap-2">
                                <input type="number" id="recipe-yield-quantity" placeholder="Quantity" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-1/2">
                                <select id="recipe-yield-unit" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-1/2">
                                    <optgroup label="Portions"><option>servings</option><option>small servings</option><option>regular servings</option><option>large servings</option><option>child portions</option><option>adult portions</option></optgroup>
                                    <optgroup label="Items"><option>items</option><option>pieces</option><option>cookies</option><option>muffins</option><option>pancakes</option><option>skewers</option><option>pie</option><option>pudding</option><option>bag</option><option>cut (thin)</option><option>cut (medium)</option><option>cut (thick)</option></optgroup>
                                    <optgroup label="Containers"><option>container</option><option>plates</option><option>bowls</option><option>glasses</option><option>scoops</option><option>bowl-fuls</option></optgroup>
                                    <optgroup label="Weights/Volumes"><option>grams (g)</option><option>kilograms (kg)</option><option>ounces (oz)</option><option>pounds (lb)</option><option>cup</option></optgroup>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="recipe-prep-time" class="block text-sm font-medium mb-1">Prep Time (mins)</label>
                            <input type="number" id="recipe-prep-time" placeholder="e.g., 15" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                        </div>
                        <div>
                            <label for="recipe-cook-time" class="block text-sm font-medium mb-1">Cook Time (mins)</label>
                            <input type="number" id="recipe-cook-time" placeholder="e.g., 30" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                        </div>
                        <div>
    <label for="recipe-resting-time" class="block text-sm font-medium mb-1">Resting Time (mins)</label>
    <input type="number" id="recipe-resting-time" placeholder="e.g., 10" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
</div>
                        <div>
                             <label for="recipe-total-time" class="block text-sm font-medium mb-1">Total Time (mins)</label>
                            <input type="number" id="recipe-total-time" placeholder="e.g., 45" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                        </div>
                         <div>
                            <label for="recipe-discovered-date" class="block text-sm font-medium mb-1">Date Discovered</label>
                            <input type="date" id="recipe-discovered-date" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                        </div>
                        <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="recipe-source-name" class="block text-sm font-medium mb-1">Source Name</label>
                                <input type="text" id="recipe-source-name" placeholder="e.g., Chetna Makan" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                            </div>
                             <div>
                                <label for="recipe-source-url" class="block text-sm font-medium mb-1">Source URL</label>
                                <input type="text" id="recipe-source-url" placeholder="https://..." class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                            </div>
                        </div>
                        <div class="lg:col-span-3">
                            <label class="flex items-center gap-2 text-sm mb-1">
                                Ingredients 
                                <i class="fas fa-info-circle text-gray-400" title="Use [Section Name] for headings and ## for inline tips."></i>
                            </label>
                            <textarea id="recipe-ingredients" placeholder="e.g., [Sauce]&#10;1 cup tomatoes ## fresh is best" rows="5" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full"></textarea>
                        </div>
                        <div class="lg:col-span-3">
    <label class="flex items-center gap-2 text-sm mb-2">
        Instructions
        <i class="fas fa-info-circle text-gray-400" title="Add steps and optional timers."></i>
    </label>
    
    <div id="instructions-builder" class="space-y-2 mb-2">
        </div>

    <div class="flex gap-2">
        <button type="button" id="add-step-btn" class="text-sm bg-teal-50 text-teal-700 border border-teal-200 py-1 px-3 rounded hover:bg-teal-100">
            <i class="fas fa-plus"></i> Add Step
        </button>
        <button type="button" id="add-section-btn" class="text-sm bg-gray-50 text-gray-700 border border-gray-200 py-1 px-3 rounded hover:bg-gray-100">
            <i class="fas fa-heading"></i> Add Section
        </button>
    </div>
</div>
                        <div class="lg:col-span-3">
                            <label for="recipe-notes" class="block text-sm font-medium mb-1">General Notes</label>
                            <textarea id="recipe-notes" placeholder="Any other notes about this recipe" rows="3" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full"></textarea>
                        </div>
                         <div class="lg:col-span-3">
                            <label for="linked-recipes-select" class="block text-sm font-medium mb-1">Linked Recipes</label>
                            <select id="linked-recipes-select" multiple class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full h-24"></select>
                        </div>
                        <div>
                            <label for="recipe-labels" class="block text-sm font-medium mb-1">Labels</label>
                            <input type="text" id="recipe-labels" placeholder="e.g., quick, spicy, vegan" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                        </div>
                        <div>
                             <label for="recipe-meal-type" class="block text-sm font-medium mb-1">Meal Type</label>
                            <select id="recipe-meal-type" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                                <option value="">Select Meal Type</option>
                                <option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option><option>Dessert</option>
                            </select>
                        </div>
                        <div>
                             <label for="recipe-category" class="block text-sm font-medium mb-1">Category</label>
                            <select id="recipe-category" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 w-full">
                                <option value="">Select Category</option>
                                <option>Food</option><option>Drink</option>
                            </select>
                        </div>
                        <div class="lg:col-span-3">
    <label class="block text-sm font-medium mb-1">Flavor Profile</label>
    <div class="flex gap-4">
        <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="flavor-sweet" class="rounded text-teal-600 focus:ring-teal-500 dark:bg-gray-700 dark:border-gray-600">
            <span>Sweet</span>
        </label>
        <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="flavor-savoury" class="rounded text-teal-600 focus:ring-teal-500 dark:bg-gray-700 dark:border-gray-600">
            <span>Savoury</span>
        </label>
    </div>
</div>
                        <div>
                            <label for="recipe-image-upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recipe Image</label>
                            <div class="flex items-center gap-4">
                                <input type="file" id="recipe-image-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                                <img id="image-preview" src="" alt="Image Preview" class="w-16 h-16 object-cover rounded-md hidden">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Initial Rating</label>
                            <div id="add-recipe-rating" class="flex items-center gap-1"></div>
                        </div>
                        <div id="form-buttons" class="lg:col-span-3 flex gap-4">
                            <button id="add-recipe-btn" type="button" class="flex-grow bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Add Recipe</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="timeline-tab-panel" class="hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Recipe Timeline</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">A chronological history of every time you've cooked a recipe.</p>
                    <div id="timeline-container" class="space-y-8"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="recipe-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="history-modal-container" class="fixed inset-0 bg-black bg-opacity-75 z-[60] hidden items-center justify-center p-4"></div>
    <div id="appliances-modal-container" class="fixed inset-0 bg-black bg-opacity-75 z-[60] hidden items-center justify-center p-4"></div>
    <div id="books-modal-container" class="fixed inset-0 bg-black bg-opacity-75 z-[60] hidden items-center justify-center p-4"></div>
    <div id="next-import-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4">Recipe Saved!</h3>
            <p id="next-import-prompt-text" class="mb-6"></p>
            <div class="flex gap-4">
                <button id="next-import-confirm-btn" class="flex-grow bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Load Next</button>
                <button id="next-import-cancel-btn" class="flex-grow bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <div id="shopping-planner-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[70] hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full h-full md:h-auto md:max-h-[90vh] md:max-w-4xl flex flex-col transition-all duration-300">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-teal-600 text-white rounded-t-lg flex-shrink-0">
            <div>
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-shopping-basket"></i> <span id="planner-title">Shopping List</span>
                </h3>
                <p class="text-xs text-teal-100" id="planner-subtitle">Review items you have at home</p>
            </div>
            <button id="close-planner-btn" class="text-white hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
        </div>

        <div class="flex-grow overflow-hidden flex flex-col md:flex-row">
            <div id="planner-sidebar" class="hidden md:block w-1/3 border-r dark:border-gray-700 p-4 overflow-y-auto bg-gray-50 dark:bg-gray-900/50 flex-shrink-0">
                <h4 class="font-bold mb-3 text-gray-500 text-xs uppercase tracking-wider">Selected Recipes</h4>
                <ul id="planner-recipe-list" class="space-y-2 text-sm text-gray-700 dark:text-gray-300"></ul>
            </div>

            <div class="flex-grow flex flex-col h-full min-h-0">
                <div id="planner-toolbar" class="p-2 border-b dark:border-gray-700 flex gap-2 overflow-x-auto bg-gray-100 dark:bg-gray-900 flex-shrink-0">
                    <button data-filter="all" class="planner-filter-btn px-4 py-1.5 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-full text-sm font-bold shadow-sm text-teal-600 dark:text-teal-400 ring-2 ring-teal-500">All</button>
                    <button data-filter="need" class="planner-filter-btn px-4 py-1.5 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-full text-sm shadow-sm text-gray-500 hover:bg-gray-50">To Buy</button>
                    <button data-filter="have" class="planner-filter-btn px-4 py-1.5 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-full text-sm shadow-sm text-gray-500 hover:bg-gray-50">Have</button>
                </div>
                
                <div id="planner-list-container" class="flex-grow overflow-y-auto p-0 md:p-2 custom-scrollbar bg-white dark:bg-gray-800">
                    </div>

                <div id="planner-footer" class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex-shrink-0 pb-safe">
                    <button id="start-shopping-mode-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 md:py-4 rounded-xl shadow-lg flex items-center justify-center text-lg transition-transform active:scale-95">
                        <i class="fas fa-person-walking mr-2"></i> Start Shopping
                    </button>
                    <button id="copy-text-btn" class="mt-3 w-full text-teal-600 dark:text-teal-400 text-xs font-semibold hover:underline text-center">
                        <i class="fas fa-copy mr-1"></i> Copy Text List
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="cook-mode-modal" class="fixed inset-0 bg-gray-900 z-[90] hidden flex-col h-[100dvh] w-screen overflow-hidden touch-manipulation">
    
    <div class="flex justify-between items-center p-3 md:p-4 text-white shrink-0 bg-gray-900/95 backdrop-blur-md z-30 border-b border-gray-800">
        <div class="flex items-center gap-3 min-w-0">
            <button onclick="window.closeCookMode()" class="hover:bg-gray-800 p-2 rounded-full transition flex-shrink-0 text-gray-400 hover:text-white" aria-label="Close">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div class="min-w-0 flex flex-col">
                <h3 id="cook-recipe-title" class="font-bold text-base md:text-lg leading-tight truncate">Recipe Title</h3>
                <p id="cook-step-counter" class="text-[10px] md:text-xs text-teal-500 font-mono tracking-wide">STEP 1 / 5</p>
            </div>
        </div>
        <div class="flex gap-2 flex-shrink-0 items-center">
             <button onclick="window.resetCookIngredients()" class="hidden md:block text-xs font-bold text-gray-500 hover:text-white border border-gray-700 hover:border-gray-500 px-2 py-1 rounded transition">RESET</button>
             <button id="cook-wakelock-btn" class="text-gray-500 hover:text-yellow-400 p-2 transition-colors" title="Keep Screen Awake"><i class="fas fa-lightbulb"></i></button>
        </div>
    </div>

    <div class="flex-grow flex overflow-hidden relative">
        
        <div class="hidden md:flex flex-col w-72 shrink-0 border-r border-gray-800 bg-gray-900/50 backdrop-blur-sm z-20">
            <div class="p-4 border-b border-gray-800 bg-gray-900/80">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex justify-between items-center">
                    Ingredients
                    <span id="cook-ing-count-desktop" class="bg-gray-800 text-teal-500 px-2 py-0.5 rounded-full text-[10px] border border-gray-700">0/0</span>
                </h4>
            </div>
            <div id="cook-sidebar-list" class="flex-grow overflow-y-auto p-2 space-y-1 custom-scrollbar pb-20">
                </div>
        </div>

        <div class="flex-grow relative flex flex-col items-center justify-center w-full h-full overflow-y-auto custom-scrollbar bg-gray-50 dark:bg-gray-900" 
             onclick="window.toggleMobileDrawer(false)"> <div class="h-4 md:hidden shrink-0"></div>

            <div id="cook-active-card" class="w-full max-w-xl bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-10 relative z-10 flex flex-col gap-5 border border-gray-200 dark:border-gray-700 mx-4 transition-all duration-300">
                
                <div class="flex justify-between items-start border-b border-gray-100 dark:border-gray-700/50 pb-3">
                    <span id="cook-step-section" class="text-[10px] md:text-xs font-black uppercase tracking-widest text-teal-600 dark:text-teal-400 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded">Instructions</span>
                    <div class="md:hidden flex items-center gap-1 text-[10px] text-gray-400 font-mono">
                         <i class="fas fa-basket-shopping"></i> <span id="cook-ing-count-mobile">0/0</span>
                    </div>
                </div>

                <div id="cook-step-text" class="text-lg md:text-2xl font-medium leading-relaxed text-gray-800 dark:text-gray-100 select-text">
                    </div>

                <div id="cook-step-image" class="hidden rounded-xl overflow-hidden border border-gray-200 dark:border-gray-600 bg-gray-100">
                    <img src="" class="w-full h-48 md:h-64 object-cover">
                </div>
            </div>

            <div class="h-32 md:h-40 shrink-0 w-full"></div>
        </div>
    </div>

    <div id="cook-mobile-drawer" class="md:hidden fixed inset-x-0 bottom-0 max-h-[70dvh] bg-gray-800 border-t border-gray-600 rounded-t-3xl z-50 transform translate-y-full transition-transform duration-300 ease-out shadow-[0_-10px_40px_rgba(0,0,0,0.7)] flex flex-col">
        
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-3xl shrink-0" onclick="window.toggleMobileDrawer(false)">
            <div class="flex items-center gap-2">
                <i class="fas fa-basket-shopping text-teal-400"></i>
                <h4 class="font-bold text-gray-200 text-sm">Ingredients for this Recipe</h4>
            </div>
            <button class="text-gray-400 bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-down text-xs"></i></button>
        </div>

        <div id="cook-mobile-list" class="overflow-y-auto p-4 space-y-3 pb-safe bg-gray-900/50">
            </div>
    </div>

    <div class="absolute bottom-0 inset-x-0 z-40 pointer-events-none flex flex-col justify-end pb-safe">
        
        <div class="h-20 w-full bg-gradient-to-t from-gray-900 via-gray-900/90 to-transparent absolute bottom-0 -z-10"></div>

        <div class="p-4 flex flex-col items-center gap-3 pointer-events-auto">
            
            <div class="flex justify-between items-end w-full max-w-md px-2 mb-2">
                <button onclick="window.toggleMobileDrawer(true)" class="md:hidden bg-gray-700 text-teal-400 hover:bg-gray-600 w-12 h-12 rounded-full shadow-lg border border-gray-600 flex items-center justify-center transition active:scale-95">
                    <i class="fas fa-list-check text-lg"></i>
                </button>

                <button id="cook-timer-btn" class="hidden flex-grow ml-3 bg-gray-800 hover:bg-gray-700 text-teal-400 border border-teal-500/30 h-12 rounded-full font-bold text-sm flex items-center justify-center gap-2 shadow-lg transition active:scale-95 animate-in fade-in slide-in-from-bottom-4">
                    <i class="fas fa-stopwatch"></i> <span class="timer-label">Start Timer</span>
                </button>
            </div>

            <div class="flex justify-between gap-4 w-full max-w-md bg-gray-800/90 backdrop-blur rounded-2xl p-2 border border-gray-700 shadow-2xl">
                <button onclick="window.changeCookStep(-1)" class="w-16 h-14 rounded-xl flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 transition active:scale-90 active:bg-gray-700">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                
                <button onclick="window.changeCookStep(1)" class="flex-grow h-14 bg-teal-600 hover:bg-teal-500 text-white rounded-xl flex items-center justify-center gap-2 font-bold text-lg shadow-lg shadow-teal-900/20 active:scale-95 transition">
                    <span id="cook-next-btn-text">Next Step</span> <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
    
    <div id="print-area" class="hidden"></div>

    <div id="notification-container" class="fixed top-5 right-5 z-[100] w-full max-w-sm space-y-2"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, serverTimestamp, updateDoc, deleteDoc, limit, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };
        
        const CONVERSIONS = {
            TSP_TO_ML: { 'us_customary': 4.92892, 'metric': 5 },
            TBSP_TO_ML: { 'us_customary': 14.7868, 'uk_metric': 15, 'au_metric': 20 },
            CUP_TO_ML: { 'us_customary': 236.59, 'metric': 250 },
            G_TO_OZ: 0.035274,
            OZ_TO_G: 28.3495,
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let userId = null;
        let recipesCache = [];
        let appliancesCache = [];
        let currentRating = 0;
        let editingRecipeId = null;
        let importedImageUrl = null;
        let fetchedRecipesCache = [];
        let currentLayout = 'tiles';
        let currentSort = 'title-asc';
        let displayOptions = {
            showImages: true,
            showLabels: true,
            showSource: false,
            showDescription: false,
        };
        let isMultiSelectMode = false;
        let isShoppingListMode = false;
        let booksCache = [];
        let selectedRecipeIds = new Set();
        let openRecipeIds = []; // Tracks recipes open in Quick Access tabs
        
        document.addEventListener('DOMContentLoaded', () => {
            const recipeList = document.getElementById('recipe-list');
            const addRecipeBtn = document.getElementById('add-recipe-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const searchBar = document.getElementById('search-bar');
            const modalContainer = document.getElementById('recipe-detail-modal');
            const historyModalContainer = document.getElementById('history-modal-container');
            const appliancesModalContainer = document.getElementById('appliances-modal-container');
            const nextImportModalEl = document.getElementById('next-import-modal');
            const form = document.getElementById('add-recipe-form');
            const filterRating = document.getElementById('filter-rating');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const optionsBtn = document.getElementById('options-btn');
            const optionsPanel = document.getElementById('options-panel');
            const layoutSelect = document.getElementById('layout-select');
            const sortBySelect = document.getElementById('sort-by-select');
            const multiSelectBtn = document.getElementById('multi-select-btn');
            const appContainer = document.getElementById('app-container');
            const bulkActionsBar = document.getElementById('bulk-actions-bar');
            const selectionCountEl = document.getElementById('selection-count');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
            const shoppingListModeBtn = document.getElementById('shopping-list-mode-btn');
            const generateShoppingListBtn = document.getElementById('generate-shopping-list-btn');
            const manageAppliancesBtn = document.getElementById('manage-appliances-btn');
            const fetchUrlBtn = document.getElementById('fetch-url-btn');
            const fetchTxtUrlBtn = document.getElementById('fetch-txt-url-btn');
            const importReviewSection = document.getElementById('import-review-section');
            const batchImportBtn = document.getElementById('batch-import-btn');
            const loadFirstRecipeBtn = document.getElementById('load-first-recipe-btn');
            const importSummaryText = document.getElementById('import-summary-text');
            const importFileInput = document.getElementById('import-file-input');
            const timelineContainer = document.getElementById('timeline-container');
            const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
            const filterContainer = document.getElementById('filter-container');
            const manageBooksBtn = document.getElementById('manage-books-btn');

            // --- AUTHENTICATION LISTENER (THE FIX) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            
            // --- ADD THIS LINE HERE ---
            loadPreferences(); 
            // --------------------------

            loadRecipes();
            loadBooks();
            loadAppliances();
        } else {
            signInAnonymously(auth).catch((error) => console.error(error));
        }
    });

    // --- EXPOSE FUNCTIONS TO WINDOW (CRITICAL FIX) ---
// This allows HTML onclick="..." attributes to see these functions
window.showRecipeDetailsModal = showRecipeDetailsModal;
window.printRecipe = printRecipe; 
// switchTab was likely already exposed, but ensuring it is here doesn't hurt:
window.switchTab = switchTab; 

// If you use these in inline HTML onclicks, expose them too:
window.handleFetchFromUrl = handleFetchFromUrl;
window.handleFileImport = handleFileImport;
window.handleBatchImport = handleBatchImport;

manageBooksBtn.addEventListener('click', () => {
    document.getElementById('options-panel').classList.add('hidden');
    showBooksModal();
});

// [INSERT] Handle URL Hash changes for Deep Linking
function handleRouting() {
    const hash = window.location.hash;
    if (hash.startsWith('#recipe/')) {
        const recipeId = hash.replace('#recipe/', '');
        if (recipeId) {
            // Prevent infinite loop if already open
            if (!document.getElementById('recipe-detail-modal').classList.contains('flex')) {
                showRecipeDetailsModal(recipeId);
            }
        }
    } else {
        // Close modal if hash is cleared (e.g. Back button)
        const modal = document.getElementById('recipe-detail-modal');
        if (modal.classList.contains('flex')) {
            // Close logic without clearing hash again
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            window.openRecipeIds = []; // Optional: clear tabs on back
        }
    }
}

window.addEventListener('hashchange', handleRouting);
// Initial check on load
setTimeout(handleRouting, 500); // Small delay to ensure recipesCache is loaded

// --- MISSING APPLIANCE MODAL FUNCTION ---
function showAppliancesModal() {
    const container = document.getElementById('appliances-modal-container');
    container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-none md:rounded-lg shadow-2xl w-full h-full md:h-auto md:max-h-[90vh] max-w-lg flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold">Manage Appliances</h3>
                <button id="close-appliances-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <form id="add-appliance-form" class="space-y-4 mb-6">
                    <input type="text" id="appliance-name-input" placeholder="Appliance Name (e.g. Air Fryer)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700">Add Appliance</button>
                </form>
                <h4 class="text-xl font-bold mb-2">Your Appliances</h4>
                <div id="appliance-list" class="space-y-2"></div>
            </div>
        </div>
    `;

    const listEl = container.querySelector('#appliance-list');

    function renderAppliancesList() {
        if (appliancesCache.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500">No appliances saved.</p>';
            return;
        }
        listEl.innerHTML = appliancesCache.map(app => `
            <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-900 rounded-lg">
                <span class="font-semibold">${app.name}</span>
                <button data-id="${app.id}" class="delete-appliance-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
        
        listEl.querySelectorAll('.delete-appliance-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (confirm('Delete this appliance?')) {
                    await deleteDoc(doc(db, 'users', userId, 'appliances', e.currentTarget.dataset.id));
                    await loadAppliances();
                    renderAppliancesList();
                }
            });
        });
    }

    renderAppliancesList();

    container.querySelector('#add-appliance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('appliance-name-input').value.trim();
        if (name) {
            await addDoc(collection(db, 'users', userId, 'appliances'), { name, createdAt: serverTimestamp() });
            e.target.reset();
            await loadAppliances();
            renderAppliancesList();
        }
    });

    container.querySelector('#close-appliances-modal-btn').addEventListener('click', () => {
        container.classList.add('hidden');
        container.classList.remove('flex');
    });

    container.classList.remove('hidden');
    container.classList.add('flex');
}

// --- COOK MODE LOGIC (CORRECTED) ---
let cookState = {
    steps: [],
    currentIdx: 0,
    ingredients: [], 
    wakelock: null
};

// Updated startCookMode signature
window.startCookMode = async (recipeId, scale = 1, unitSystem = 'original') => {
    if (!document.getElementById('cook-mode-modal')) return alert("Cook Mode HTML missing!");

    const recipe = recipesCache.find(r => r.id === recipeId);
    if (!recipe) return;

    // Store settings in state
    cookState.scale = parseFloat(scale) || 1;
    cookState.unitSystem = unitSystem || 'original';

    // 1. Prepare Instructions
    const rawInstr = processData(recipe.instructions, 'Instructions');
    cookState.steps = [];
    rawInstr.forEach(sec => {
        (sec.items || []).forEach(item => {
            cookState.steps.push({
                section: sec.section,
                ...((typeof item === 'string') ? { text: item } : item)
            });
        });
    });

    if(cookState.steps.length === 0) return alert("No instructions found to cook!");

    // 2. Prepare Ingredients (Apply Scaling Here!)
    const rawIng = processData(recipe.ingredients, 'Ingredients');
    cookState.ingredients = [];
    rawIng.forEach(sec => {
        (sec.items || []).forEach(item => {
            let txt = typeof item === 'string' ? item : item.text;
            
            // Clean name for matching
            let cleanName = txt.replace(/^([\d\/\.\s\-]+)?(g|kg|ml|l|oz|lb|cups?|tbsp|tsp|tablespoons?|teaspoons?|grams?|cloves?|slices?|pinch)\s+/i, '')
                               .replace(/\(.*\)/g, '').trim().toLowerCase();
            if(cleanName.endsWith('s') && cleanName.length > 3) cleanName = cleanName.slice(0, -1);
            
            // Apply Scale & Conversion
            // Note: Ensure scaleIngredientString and convertIngredientString are exposed or copied into scope if modules are strict
            let displayTxt = scaleIngredientString(txt, cookState.scale);
            if (cookState.unitSystem !== 'original') {
                displayTxt = convertIngredientString(displayTxt, cookState.unitSystem);
            }

            cookState.ingredients.push({
                text: displayTxt, // Show the scaled version
                clean: cleanName,
                used: false,
                active: false 
            });
        });
    });

    // 3. UI Init
    cookState.currentIdx = 0;
    document.getElementById('cook-recipe-title').textContent = recipe.name;
    document.getElementById('cook-mode-modal').classList.remove('hidden');
    document.getElementById('cook-mode-modal').classList.add('flex');
    
    if ('wakeLock' in navigator) {
        try { cookState.wakelock = await navigator.wakeLock.request('screen'); } 
        catch (err) { console.log('Wakelock failed', err); }
    }

    window.renderCookStep();
};

// Add this Event Listener for Cook Mode Timers (Paste near other listeners)
document.getElementById('cook-active-card').addEventListener('click', (e) => {
    const btn = e.target.closest('.timer-btn');
    if (!btn) return;
    
    // Simple Timer Logic (Visual Only)
    if (btn.classList.contains('running')) return; // Already running
    
    const millis = parseInt(btn.dataset.millis);
    const end = Date.now() + millis;
    
    btn.classList.add('running', 'text-teal-600', 'font-bold');
    btn.classList.remove('text-gray-700'); // Remove default color if needed

    const interval = setInterval(() => {
        const remaining = end - Date.now();
        if (remaining <= 0) {
            clearInterval(interval);
            btn.innerHTML = `<i class="fas fa-check"></i> Done!`;
            btn.classList.remove('running', 'text-teal-600');
            btn.classList.add('text-green-600', 'line-through');
            // Optional: Play beep
        } else {
            const secs = Math.ceil(remaining / 1000);
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            btn.innerHTML = `<i class="fas fa-hourglass-half fa-spin"></i> ${m}m ${s}s`;
        }
    }, 1000);
});

window.renderCookStep = () => {
    const step = cookState.steps[cookState.currentIdx];
    const total = cookState.steps.length;

    // 1. Text & Meta
    document.getElementById('cook-step-counter').textContent = `STEP ${cookState.currentIdx + 1} / ${total}`;
    document.getElementById('cook-step-section').textContent = step.section || 'Step';
    document.getElementById('cook-step-text').innerHTML = renderTextWithTimers(step.text);

    // 2. Image
    const imgDiv = document.getElementById('cook-step-image');
    if (step.imageUrl) {
        imgDiv.querySelector('img').src = step.imageUrl;
        imgDiv.classList.remove('hidden');
    } else {
        imgDiv.classList.add('hidden');
    }

    // 3. Auto-Detect Ingredients
    const stepTextLower = step.text.toLowerCase();
    cookState.ingredients.forEach(ing => {
        ing.active = false;
        if (ing.clean.length >= 3 && stepTextLower.includes(ing.clean)) {
            ing.active = true;
            ing.used = true; // Auto-cross off
        }
    });

    // 4. Render Ingredients (Sidebar & Mobile Drawer)
    const renderIngItem = (ing, idx) => {
        let cls = "p-2 rounded-lg flex items-start gap-3 cursor-pointer transition-all border text-sm ";
        let icon = "fas fa-circle text-[10px] mt-1.5 ml-1 text-gray-600";
        
        if (ing.active) { 
            cls += "bg-teal-900/40 border-teal-500/50 text-teal-50 shadow-sm"; 
            icon = "fas fa-check-circle text-teal-400 text-base"; 
        } else if (ing.used) { 
            cls += "opacity-50 text-gray-500 line-through decoration-gray-600 border-transparent"; 
            icon = "fas fa-check text-gray-600"; 
        } else { 
            cls += "text-gray-400 hover:bg-gray-800 border-transparent"; 
        }

        return `<div onclick="window.toggleCookIngredient(${idx})" class="${cls}">
            <div class="shrink-0 w-6 flex justify-center"><i class="${icon}"></i></div>
            <span class="leading-tight select-none">${ing.text}</span>
        </div>`;
    };

    const listHtml = cookState.ingredients.map((ing, i) => renderIngItem(ing, i)).join('');
    document.getElementById('cook-sidebar-list').innerHTML = listHtml;
    document.getElementById('cook-mobile-list').innerHTML = listHtml;

    // Update Counts
    const counts = `${cookState.ingredients.filter(i => i.used).length}/${cookState.ingredients.length}`;
    document.getElementById('cook-ing-count-desktop').textContent = counts;
    document.getElementById('cook-ing-count-mobile').textContent = counts;

    // 5. Timer Button
    const timerBtn = document.getElementById('cook-timer-btn');
    if (step.timer) {
        timerBtn.classList.remove('hidden');
        timerBtn.querySelector('.timer-label').textContent = `Start ${step.timer.val}${step.timer.unit} Timer`;
        
        const newBtn = timerBtn.cloneNode(true);
        timerBtn.parentNode.replaceChild(newBtn, timerBtn);
        
        newBtn.onclick = () => {
             const inlineBtn = document.getElementById('cook-step-text').querySelector('.timer-btn');
             if(inlineBtn) inlineBtn.click();
             newBtn.classList.add('opacity-50', 'cursor-not-allowed');
        };
    } else {
        timerBtn.classList.add('hidden');
    }
    
    // 6. Next Button Text
    document.getElementById('cook-next-btn-text').textContent = (cookState.currentIdx < total - 1) ? "Next Step" : "Finish";
};

window.toggleCookIngredient = (idx) => {
    cookState.ingredients[idx].used = !cookState.ingredients[idx].used;
    window.renderCookStep();
};

window.resetCookIngredients = () => {
    if(confirm("Reset all ingredients?")) {
        cookState.ingredients.forEach(i => i.used = false);
        window.renderCookStep();
    }
};

window.toggleMobileDrawer = (show) => {
    const d = document.getElementById('cook-mobile-drawer');
    if(!d) return;
    if(show === undefined) d.classList.toggle('translate-y-full');
    else if(show) d.classList.remove('translate-y-full');
    else d.classList.add('translate-y-full');
};

window.changeCookStep = (dir) => {
    window.toggleMobileDrawer(false); // Close drawer on nav
    const newIdx = cookState.currentIdx + dir;
    if (newIdx >= 0 && newIdx < cookState.steps.length) {
        cookState.currentIdx = newIdx;
        window.renderCookStep();
    } else if (newIdx >= cookState.steps.length) {
        window.closeCookMode();
    }
};

window.closeCookMode = () => {
    document.getElementById('cook-mode-modal').classList.add('hidden');
    document.getElementById('cook-mode-modal').classList.remove('flex');
    if (cookState.wakelock) cookState.wakelock.release();
};

// Keyboard Support
document.addEventListener('keydown', (e) => {
    if (!document.getElementById('cook-mode-modal').classList.contains('hidden')) {
        if (e.key === 'ArrowRight' || e.key === 'Space') window.changeCookStep(1);
        if (e.key === 'ArrowLeft') window.changeCookStep(-1);
        if (e.key === 'Escape') window.closeCookMode();
    }
});

// Bulk Add Label
document.getElementById('bulk-add-label-btn').addEventListener('click', async () => {
    const label = prompt("Enter label to add to selected recipes:");
    if (!label) return;
    
    const batch = writeBatch(db);
    let count = 0;
    
    selectedRecipeIds.forEach(id => {
        const recipe = recipesCache.find(r => r.id === id);
        if (recipe) {
            const currentLabels = recipe.labels || [];
            if (!currentLabels.includes(label)) {
                const ref = doc(db, 'users', userId, 'recipes', id);
                batch.update(ref, { 
                    labels: [...currentLabels, label],
                    updatedAt: serverTimestamp() 
                });
                count++;
            }
        }
    });

    if (count > 0) {
        await batch.commit();
        await loadRecipes(); // Refresh cache
        showNotification(`Added "${label}" to ${count} recipes.`);
        document.getElementById('cancel-selection-btn').click(); // Exit mode
    } else {
        showNotification("No recipes needed updating.", "info");
    }
});

// Bulk Assign to Collection (Book)
document.getElementById('bulk-assign-book-btn').addEventListener('click', async () => {
    // Simple implementation using prompt for ID, or we could show a mini-modal.
    // For simplicity here, we cycle books names in a prompt.
    if (booksCache.length === 0) return showNotification("No collections found.", "error");
    
    const bookList = booksCache.map((b, i) => `${i + 1}. ${b.name}`).join('\n');
    const selection = prompt(`Enter the number of the collection to assign:\n${bookList}`);
    const index = parseInt(selection) - 1;
    
    if (!isNaN(index) && booksCache[index]) {
        const bookId = booksCache[index].id;
        const batch = writeBatch(db);
        selectedRecipeIds.forEach(id => {
            const ref = doc(db, 'users', userId, 'recipes', id);
            batch.update(ref, { bookId: bookId, updatedAt: serverTimestamp() });
        });
        await batch.commit();
        await loadRecipes();
        showNotification(`Assigned to "${booksCache[index].name}".`);
        document.getElementById('cancel-selection-btn').click();
    }
});

// UPDATE: Replace existing foodModeToggle event listener with this
const handleTypeChange = () => {
    const type = document.querySelector('input[name="recipe-type"]:checked').value;
    const descEl = document.getElementById('type-description');
    
    // Visibility mapping
    const visibility = {
        'standard': { times: 'block', instr: 'block', yield: 'block', ingredientsLabel: 'Ingredients' },
        'food_item': { times: 'none', instr: 'none', yield: 'block', ingredientsLabel: 'Components/Ingredients' },
        'howto': { times: 'none', instr: 'block', yield: 'none', ingredientsLabel: 'Tools & Requirements' }
    };

    const settings = visibility[type];
    
    // Toggle Time Fields
    ['recipe-prep-time', 'recipe-cook-time', 'recipe-resting-time', 'recipe-total-time'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.closest('div').style.display = settings.times;
    });

    // Toggle Instructions
    const instrBuilder = document.getElementById('instructions-builder');
    if(instrBuilder) {
        instrBuilder.parentElement.style.display = settings.instr;
        // Also hide the label for instructions
        const label = instrBuilder.parentElement.querySelector('label');
        if(label) label.style.display = settings.instr;
    }

    // Toggle Yield
    const yieldInput = document.getElementById('recipe-yield-quantity');
    if(yieldInput) yieldInput.closest('div').parentElement.style.display = settings.yield;

    // Update Ingredients Label
    const ingLabel = document.querySelector('label[for="recipe-ingredients"]');
    if(ingLabel) ingLabel.innerHTML = `${settings.ingredientsLabel} <i class="fas fa-info-circle text-gray-400"></i>`;

    // Update Description Text
    if (type === 'standard') descEl.textContent = "Standard cooking recipe with ingredients and steps.";
    else if (type === 'food_item') descEl.textContent = "A component (e.g., 'Cooked Rice') used in other recipes. No instructions.";
    else if (type === 'howto') descEl.textContent = "General advice, technique guide, or manual. 'Ingredients' list becomes Tools/Requirements.";
};

document.querySelectorAll('input[name="recipe-type"]').forEach(radio => {
    radio.addEventListener('change', handleTypeChange);
});


            // Instruction Builder Listeners
    document.getElementById('add-step-btn').addEventListener('click', () => {
        document.getElementById('instructions-builder').appendChild(createInstructionRow());
    });
    
    document.getElementById('add-section-btn').addEventListener('click', () => {
        document.getElementById('instructions-builder').appendChild(createSectionRow());
    });

            if (mobileFilterToggle) {
        mobileFilterToggle.addEventListener('click', () => {
            filterContainer.classList.toggle('hidden');
        });
    }
            
            // Tab Elements
            const recipesTabBtn = document.getElementById('recipes-tab-btn');
            const addRecipeTabBtn = document.getElementById('add-recipe-tab-btn');
            const timelineTabBtn = document.getElementById('timeline-tab-btn');
            const recipesTabPanel = document.getElementById('recipes-tab-panel');
            const addRecipeTabPanel = document.getElementById('add-recipe-tab-panel');
            const timelineTabPanel = document.getElementById('timeline-tab-panel');
            const formSummary = document.getElementById('form-summary');

            function showNotification(message, type = 'success') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
                notification.className = `p-4 rounded-lg text-white ${bgColor} shadow-lg animate-pulse`;
                notification.textContent = message;
                container.appendChild(notification);
                setTimeout(() => {
                    notification.classList.remove('animate-pulse');
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }, 500);
            }

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeToggle.innerHTML = '<i class="fas fa-sun text-xl"></i>';
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggle.innerHTML = '<i class="fas fa-moon text-xl"></i>';
                }
            };

            function createSafeKey(str) {
                    if (typeof str !== 'string') return '';
                    return str.replace(/[.$#[\]/]/g, '_');
                }

                 const renderNote = (note) => note ? `<div class="mt-1 p-2 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 rounded-md text-xs italic cursor-pointer"><i class="fas fa-thumbtack mr-2"></i>${note}</div>` : '';
            
            const processData = (data, defaultSectionName) => {
                if (!data) return [];
                let sections;

                if (typeof data === 'string') {
                    sections = parseSections(data);
                } else if (Array.isArray(data)) {
                    if (data.length === 0) return [];
                    if (typeof data[0] === 'object' && data[0] !== null && 'items' in data[0]) {
                        sections = data;
                    } else { // Handle flat array of strings by parsing for sections
                        const parsedFromFlatArray = [];
                        let currentSectionForFlatArray = { section: defaultSectionName, items: [] };
                        data.forEach(line => {
                            const match = line.trim().match(/^\[(.*?)\]:?$/);
                            if (match && line.trim().endsWith(']')) {
                                if (currentSectionForFlatArray.items.length > 0) {
                                    parsedFromFlatArray.push(currentSectionForFlatArray);
                                }
                                currentSectionForFlatArray = { section: match[1].trim(), items: [] };
                            } else {
                                currentSectionForFlatArray.items.push(line);
                            }
                        });
                        if (currentSectionForFlatArray.items.length > 0 || parsedFromFlatArray.length === 0) {
                            parsedFromFlatArray.push(currentSectionForFlatArray);
                        }
                        sections = parsedFromFlatArray;
                    }
                } else {
                    return [];
                }

                // Normalize items to ensure they are objects with a .text property
                return sections.map(section => {
                    if (!section || !Array.isArray(section.items)) {
                        return { section: (section && section.section) || defaultSectionName, items: [] };
                    }
                    const normalizedItems = section.items.map(item => {
                        if (typeof item === 'string') {
                            return { text: item };
                        }
                        if (typeof item === 'object' && item !== null && typeof item.text === 'string') {
                            return item;
                        }
                        return null; 
                    }).filter(Boolean);

                    return {
                        section: section.section,
                        items: normalizedItems
                    };
                });
            };


            function switchTab(tabName) {
    localStorage.setItem('activeTab', tabName);
    
    // Update both Desktop and Mobile tabs
    const desktopTabs = [
        { btn: document.getElementById('recipes-tab-btn'), name: 'recipes' },
        { btn: document.getElementById('add-recipe-tab-btn'), name: 'add-recipe' },
        { btn: document.getElementById('timeline-tab-btn'), name: 'timeline' }
    ];
    
    // Desktop styling
    desktopTabs.forEach(tab => {
        if (tab.btn) { // Safety check
            if (tab.name === tabName) tab.btn.classList.add('active');
            else tab.btn.classList.remove('active');
        }
    });

    // Mobile styling
    document.querySelectorAll('.mobile-nav-link').forEach(link => {
        if(link.onclick && link.onclick.toString().includes(tabName)) {
             link.classList.add('text-[var(--primary)]');
             link.classList.remove('text-gray-400');
        } else {
             link.classList.remove('text-[var(--primary)]');
             link.classList.add('text-gray-400');
        }
    });

    // Panels
    const recipesPanel = document.getElementById('recipes-tab-panel');
    const addRecipePanel = document.getElementById('add-recipe-tab-panel');
    const timelinePanel = document.getElementById('timeline-tab-panel');

    if (recipesPanel) recipesPanel.classList.toggle('hidden', tabName !== 'recipes');
    if (addRecipePanel) addRecipePanel.classList.toggle('hidden', tabName !== 'add-recipe');
    if (timelinePanel) timelinePanel.classList.toggle('hidden', tabName !== 'timeline');

    if (tabName === 'timeline') renderTimeline();
}

// *** CRITICAL FIX: Expose function to window so HTML onclick works ***
window.switchTab = switchTab;


            async function loadRecipes() {
                if (!userId) return;
                try {
                    const recipesCol = collection(db, 'users', userId, 'recipes');
                    const q = query(recipesCol, orderBy("createdAt", "desc"));
                    const recipeSnapshot = await getDocs(q);
                    recipesCache = recipeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateFilters();
                    filterRecipes(); 
                } catch (error) {
                    console.error("Error loading recipes:", error);
                    showNotification("Failed to load recipes.", 'error');
                }
            }

            async function loadAppliances() {
                if (!userId) return;
                try {
                    const appliancesCol = collection(db, 'users', userId, 'appliances');
                    const q = query(appliancesCol, orderBy("createdAt", "desc"));
                    const applianceSnapshot = await getDocs(q);
                    appliancesCache = applianceSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Error loading appliances:", error);
                    showNotification("Failed to load appliances.", 'error');
                }
            }

            function renderRecipeCards(recipes) {
                recipeList.innerHTML = '';
                
                if (currentLayout === 'list') {
                    recipeList.className = 'flex flex-col gap-4';
                } else {
                    recipeList.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                }
                
                if (recipes.length === 0) {
                    recipeList.innerHTML = `<p class="text-center col-span-full text-gray-500">No recipes found. Try adjusting your filters!</p>`;
                    return;
                }
                recipes.forEach(recipe => {
                    const recipeCard = document.createElement('div');
                    const isSelected = selectedRecipeIds.has(recipe.id);
                    recipeCard.className = `bg-white dark:bg-gray-800 rounded-lg shadow cursor-pointer hover:shadow-xl transition-shadow relative recipe-card-selectable ${isSelected ? 'selected' : ''}`;
                    recipeCard.dataset.recipeId = recipe.id;
                    
                    if (currentLayout === 'list') {
                        recipeCard.innerHTML = `
                            <div class="flex items-center gap-4 p-4">
                                ${displayOptions.showImages ? `<img src="${recipe.imageUrl || 'https://placehold.co/150x150'}" alt="${recipe.name}" class="w-24 h-24 object-cover rounded-md flex-shrink-0">` : ''}
                                <div class="flex-grow">
                                    <h3 class="text-xl font-bold">${recipe.name}</h3>
                                    ${displayOptions.showDescription ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${recipe.description || ''}</p>` : ''}
                                    ${displayOptions.showSource ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Source: ${recipe.sourceName || 'N/A'}</p>` : ''}
                                    ${displayOptions.showLabels && recipe.labels && recipe.labels.length > 0 ? `<div class="mt-2 flex flex-wrap gap-1">${recipe.labels.map(l => `<span class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${l}</span>`).join('')}</div>` : ''}
                                </div>
                                 <button class="add-to-meal-plan-btn bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center absolute top-2 right-2 hover:bg-green-600" title="Add to Meal Plan"><i class="fas fa-calendar-plus"></i></button>
                            </div>
                        `;
                    } else {
                        const totalTime = recipe.totalTime || 0;
                        recipeCard.innerHTML = `
                             <div class="relative">
                                ${displayOptions.showImages ? `<img src="${recipe.imageUrl || 'https://placehold.co/400x300'}" alt="${recipe.name}" class="w-full h-40 object-cover rounded-t-lg">` : ''}
                                <button class="add-to-meal-plan-btn bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center absolute top-2 right-2 hover:bg-green-600" title="Add to Meal Plan"><i class="fas fa-calendar-plus"></i></button>
                            </div>
                            <div class="p-4">
                                <h3 class="text-xl font-bold">${recipe.name}</h3>
                                <p class="text-gray-600 dark:text-gray-400">${recipe.cuisine || 'Unspecified Cuisine'}</p>
                                <div class="mt-2 text-sm text-gray-500">
                                    <i class="fas fa-clock"></i>
                                    ${totalTime > 0 ? totalTime + ' mins' : 'N/A'}
                                </div>
                            </div>
                        `;
                    }

                    recipeCard.addEventListener('click', (e) => {
                        if (e.target.closest('.add-to-meal-plan-btn')) {
                            e.stopPropagation();
                            showNotification(`${recipe.name} added to meal plan (feature coming soon)!`, 'info');
                            return;
                        }

                        if (isMultiSelectMode || isShoppingListMode) {
                            if (selectedRecipeIds.has(recipe.id)) {
                                selectedRecipeIds.delete(recipe.id);
                            } else {
                                selectedRecipeIds.add(recipe.id);
                            }
                            recipeCard.classList.toggle('selected');
                            selectionCountEl.textContent = `${selectedRecipeIds.size} recipes selected`;
                        } else {
                            showRecipeDetailsModal(recipe.id);
                        }
                    });
                    recipeList.appendChild(recipeCard);
                });
            }
            
// REPLACEMENT JS FUNCTIONS

function populateFilters() {
    const cuisines = new Set();
    const labels = new Set();
    
    recipesCache.forEach(recipe => {
        if (recipe.cuisine) cuisines.add(recipe.cuisine);
        if (recipe.labels) recipe.labels.forEach(label => labels.add(label));
    });

    // Populate Cuisines Checkboxes
    const cuisineContainer = document.getElementById('filter-cuisine-list');
    cuisineContainer.innerHTML = '';
    [...cuisines].sort().forEach(c => {
        cuisineContainer.innerHTML += `
            <label class="flex items-center space-x-2">
                <input type="checkbox" name="filter-cuisine" value="${c}" class="rounded text-teal-600 focus:ring-teal-500">
                <span class="truncate" title="${c}">${c}</span>
            </label>`;
    });

    // Populate Labels Checkboxes
    const labelContainer = document.getElementById('filter-label-list');
    labelContainer.innerHTML = '';
    [...labels].sort().forEach(l => {
        labelContainer.innerHTML += `
            <label class="flex items-center space-x-2">
                <input type="checkbox" name="filter-label" value="${l}" class="rounded text-teal-600 focus:ring-teal-500">
                <span class="truncate" title="${l}">${l}</span>
            </label>`;
    });

    // Add event listeners to all new checkboxes to trigger filtering immediately
    document.querySelectorAll('#filter-container input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', filterRecipes);
    });
}

function filterRecipes() {
    const searchTerm = document.getElementById('search-bar').value.toLowerCase();
    const minRating = Number(document.getElementById('filter-rating').value);

    // Get checked values as arrays
    const selectedFlavors = [...document.querySelectorAll('input[name="filter-flavor"]:checked')].map(cb => cb.value);
    const selectedMeals = [...document.querySelectorAll('input[name="filter-meal"]:checked')].map(cb => cb.value);
    const selectedCuisines = [...document.querySelectorAll('input[name="filter-cuisine"]:checked')].map(cb => cb.value);
    const selectedLabels = [...document.querySelectorAll('input[name="filter-label"]:checked')].map(cb => cb.value);

    let filtered = recipesCache.filter(recipe => {
        // 1. Text Search
        const matchesSearch = searchTerm === '' || 
            recipe.name.toLowerCase().includes(searchTerm) ||
            (recipe.description && recipe.description.toLowerCase().includes(searchTerm));
        
        // 2. Rating
        const matchesRating = (recipe.rating || 0) >= minRating;

        // 3. Flavor (Show if recipe has ANY of the selected flavors, or if no flavors selected)
        // Note: flavorProfile is an array e.g. ['Sweet', 'Savoury']
        const matchesFlavor = selectedFlavors.length === 0 || 
            (recipe.flavorProfile && recipe.flavorProfile.some(f => selectedFlavors.includes(f)));

        // 4. Meal Type (Show if recipe matches ANY selected meal type)
        const matchesMeal = selectedMeals.length === 0 || 
            selectedMeals.includes(recipe.mealType);

        // 5. Cuisine (Show if recipe matches ANY selected cuisine)
        const matchesCuisine = selectedCuisines.length === 0 || 
            selectedCuisines.includes(recipe.cuisine);

        // 6. Labels (Show if recipe matches ANY selected label)
        const matchesLabel = selectedLabels.length === 0 || 
            (recipe.labels && recipe.labels.some(l => selectedLabels.includes(l)));

        return matchesSearch && matchesRating && matchesFlavor && matchesMeal && matchesCuisine && matchesLabel;
    });

    const sorted = sortRecipes(filtered);
    renderRecipeCards(sorted);
}
            
            function sortRecipes(recipes) {
                return [...recipes].sort((a, b) => {
                    switch(currentSort) {
                        case 'date-desc':
                            return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
                        case 'date-asc':
                            return (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0);
                        case 'rating-desc':
                            return (b.rating || 0) - (a.rating || 0);
                        case 'title-asc':
                        default:
                            return a.name.localeCompare(b.name);
                    }
                });
            }

            function renderAddRatingStars(rating = 0) {
                const container = document.getElementById('add-recipe-rating');
                container.innerHTML = '';
                currentRating = rating;
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('i');
                    star.className = 'fas fa-star cursor-pointer text-2xl';
                    star.dataset.value = i;
                    star.classList.toggle('text-yellow-400', i <= currentRating);
                    star.classList.toggle('text-gray-300', i > currentRating);
                    star.addEventListener('click', () => {
                        currentRating = i;
                        const stars = container.querySelectorAll('i');
                        stars.forEach(s => {
                            s.classList.toggle('text-yellow-400', s.dataset.value <= currentRating);
                            s.classList.toggle('text-gray-300', s.dataset.value > currentRating);
                        });
                    });
                    container.appendChild(star);
                }
            }
            
            const parseSections = (text) => {
                if (!text) return [];
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const sections = [];
                let currentSection = { section: 'General', items: [] };

                for (const line of lines) {
                    const match = line.trim().match(/^\[(.*?)\]:?$/);
                    // A line is a heading if it consists only of the bracketed text (and optional colon)
                    if (match && match[0] === line.trim()) {
                        if (currentSection.items.length > 0) {
                            sections.push(currentSection);
                        }
                        currentSection = { section: match[1].trim(), items: [] };
                    } else {
                        const parts = line.split('##');
                        const itemText = parts[0].trim();
                        if (itemText) {
                            const item = { text: itemText };
                            if (parts.length > 1) {
                                item.tip = parts[1].trim();
                            }
                            currentSection.items.push(item);
                        }
                    }
                }
                if (currentSection.items.length > 0 || sections.length === 0) {
                    sections.push(currentSection);
                }
                return sections;
            };

            const formatSections = (sectionsArray) => {
                 if (!Array.isArray(sectionsArray)) return '';
                 return sectionsArray.map(sec => {
                     if (!sec || !Array.isArray(sec.items)) return ''; 
                     const header = sec.section && sec.section !== 'General' ? `[${sec.section}]\n` : '';
                     const items = sec.items.map(item => {
                         if (typeof item === 'string') return item;
                         if (typeof item === 'object' && item.text) return item.text + (item.tip ? ` ## ${item.tip}` : '');
                         return '';
                     }).join('\n');
                     return header + items;
                 }).join('\n\n');
            }

async function handleAddOrUpdateRecipe() {
    if (!userId) {
        return showNotification("Please log in to add recipes.", "error");
    }

    const name = document.getElementById('recipe-name').value;
    if (!name) {
        return showNotification("Please fill out the Title.", "error");
    }

    const recipeType = document.querySelector('input[name="recipe-type"]:checked').value;
const bookId = document.getElementById('recipe-book-select').value;
const adaptedFromId = document.getElementById('adapted-from-select').value;
    
    addRecipeBtn.disabled = true;
    addRecipeBtn.textContent = "Saving...";

    try {
        let imageUrl = editingRecipeId ? (recipesCache.find(r => r.id === editingRecipeId)?.imageUrl || '') : '';
        const imageFile = document.getElementById('recipe-image-upload').files[0];

        if (imageFile) {
            const imageRef = ref(storage, `users/${userId}/recipes/${Date.now()}_${imageFile.name}`);
            await uploadBytes(imageRef, imageFile);
            imageUrl = await getDownloadURL(imageRef);
        } else if (importedImageUrl) {
            imageUrl = importedImageUrl;
        }

        const linkedRecipesSelect = document.getElementById('linked-recipes-select');
        const linkedRecipeIds = [...linkedRecipesSelect.selectedOptions].map(option => option.value);

        const flavorProfile = [];
        if (document.getElementById('flavor-sweet').checked) flavorProfile.push('Sweet');
        if (document.getElementById('flavor-savoury').checked) flavorProfile.push('Savoury');
        
        // --- Process Instructions and Step Images ---
        let rawInstructions = getInstructionsFromBuilder();
        
        // Recursively upload images for steps
        for (const section of rawInstructions) {
            if (section.items) {
                for (const item of section.items) {
                    if (item.imageFile) {
                        const stepImgRef = ref(storage, `users/${userId}/recipes/steps/${Date.now()}_${item.imageFile.name}`);
                        await uploadBytes(stepImgRef, item.imageFile);
                        item.imageUrl = await getDownloadURL(stepImgRef);
                        delete item.imageFile; // Don't save the file object to Firestore
                    }
                }
            }
        }

        const isFoodItem = document.getElementById('is-food-item-toggle')?.checked || false;

        const recipeData = {
            name,
            description: document.getElementById('recipe-description').value,
            cuisine: document.getElementById('recipe-cuisine').value,
            sourceName: document.getElementById('recipe-source-name').value,
            sourceUrl: document.getElementById('recipe-source-url').value,
            yield: {
                quantity: Number(document.getElementById('recipe-yield-quantity').value) || null,
                unit: document.getElementById('recipe-yield-unit').value
            },
            prepTime: Number(document.getElementById('recipe-prep-time').value) || 0,
            cookTime: Number(document.getElementById('recipe-cook-time').value) || 0,
            restingTime: Number(document.getElementById('recipe-resting-time').value) || 0,
            totalTime: Number(document.getElementById('recipe-total-time').value) || 0,
            discoveredDate: document.getElementById('recipe-discovered-date').value,
            mealType: document.getElementById('recipe-meal-type').value,
            category: document.getElementById('recipe-category').value,
            flavorProfile: flavorProfile,
            ingredients: parseSections(document.getElementById('recipe-ingredients').value),
            instructions: rawInstructions,
            notes: document.getElementById('recipe-notes').value,
            labels: document.getElementById('recipe-labels').value.split(',').map(l => l.trim()).filter(Boolean),
            rating: currentRating,
            imageUrl,
            linkedRecipeIds,
            type: recipeType, // Replaces isFoodItem logic (though you can keep isFoodItem for legacy compat if needed)
    isFoodItem: recipeType === 'food_item', // Keep for backward compatibility
    bookId: bookId || null,
    adaptedFromId: adaptedFromId || null,
            updatedAt: serverTimestamp(),
            updatedBy: userId,
            approvals: editingRecipeId ? (recipesCache.find(r => r.id === editingRecipeId)?.approvals || []) : []
        };

        if (!editingRecipeId) {
            const discoveredDate = document.getElementById('recipe-discovered-date').value;
            recipeData.createdAt = discoveredDate ? new Date(discoveredDate) : serverTimestamp();
            recipeData.ingredientNotes = {};
            recipeData.instructionNotes = {};
            recipeData.createdBy = userId;
            if (importedImageUrl) {
                recipeData.importedFromUrl = document.getElementById('import-url-input').value;
                recipeData.importedAt = serverTimestamp();
                if (!recipeData.labels.includes('imported')) {
                    recipeData.labels.push('imported');
                }
            }
        }

        if (editingRecipeId) {
            const recipeRef = doc(db, 'users', userId, 'recipes', editingRecipeId);
            await updateDoc(recipeRef, recipeData);
            showNotification("Recipe updated successfully!");
        } else {
            const recipesCol = collection(db, 'users', userId, 'recipes');
            await addDoc(recipesCol, recipeData);
            showNotification("Recipe added successfully!");
        }
        
        await loadRecipes();

        if (!editingRecipeId && fetchedRecipesCache.length > 0) {
            fetchedRecipesCache.shift();
            if (fetchedRecipesCache.length > 0) {
                showNextImportModal();
            } else {
                resetForm();
            }
        } else {
            resetForm();
        }

    } catch (error) {
        console.error("Error saving recipe:", error);
        showNotification("Failed to save recipe.", "error");
    } finally {
        addRecipeBtn.disabled = false;
        addRecipeBtn.textContent = editingRecipeId ? "Save Changes" : "Add Recipe";
    }
}



            function resetForm() {
                switchTab('recipes');
                form.reset();
                document.getElementById('recipe-discovered-date').valueAsDate = new Date();
                currentRating = 0;
                renderAddRatingStars();
                
                // FIX: Clear the dynamic instruction builder
                renderInstructionBuilder([]); 

                editingRecipeId = null;
                importedImageUrl = null;
                fetchedRecipesCache = [];
                importReviewSection.classList.add('hidden');
                document.getElementById('import-url-input').value = '';
                document.getElementById('import-txt-url-input').value = '';
                formSummary.textContent = "Add a New Recipe";
                addRecipeBtn.textContent = "Add Recipe";
                document.getElementById('form-buttons').querySelector('#cancel-edit-btn')?.remove();
                document.getElementById('image-preview').classList.add('hidden');
                populateLinkedRecipesSelect();
            }
            function populateFormForEdit(recipeOrId) {
                const isEditing = typeof recipeOrId === 'string';
                const recipe = isEditing
                    ? recipesCache.find(r => r.id === recipeOrId)
                    : recipeOrId;
                
                if (!recipe) return;

                // --- NEW CODE STARTS HERE (After recipe is defined) ---
                // Set Type
                const type = recipe.type || (recipe.isFoodItem ? 'food_item' : 'standard');
                const radio = document.querySelector(`input[name="recipe-type"][value="${type}"]`);
                if(radio) radio.checked = true;
                handleTypeChange(); 

                // Set Books
                populateBooksSelect(recipe.bookId);

                // Set Adapted From
                populateAdaptedFromSelect(recipe.id, recipe.adaptedFromId);
                // --- NEW CODE ENDS ---

                editingRecipeId = isEditing ? recipeOrId : null;
                // ... rest of the function ...
                
                if (!recipe) return;

                editingRecipeId = isEditing ? recipeOrId : null;

                const ingredientsForForm = processData(recipe.ingredients, 'Ingredients');
                const instructionsForForm = processData(recipe.instructions, 'Instructions');

                const flavors = recipe.flavorProfile || [];
document.getElementById('flavor-sweet').checked = flavors.includes('Sweet');
document.getElementById('flavor-savoury').checked = flavors.includes('Savoury');

                document.getElementById('recipe-name').value = recipe.name || '';
                document.getElementById('recipe-description').value = recipe.description || '';
                document.getElementById('recipe-cuisine').value = recipe.cuisine || '';
                document.getElementById('recipe-source-name').value = recipe.sourceName || '';
                document.getElementById('recipe-source-url').value = recipe.sourceUrl || '';
                if (typeof recipe.yield === 'object' && recipe.yield !== null) {
                    document.getElementById('recipe-yield-quantity').value = recipe.yield.quantity || '';
                    document.getElementById('recipe-yield-unit').value = recipe.yield.unit || 'servings';
                } else {
                    document.getElementById('recipe-yield-quantity').value = recipe.yield || ''; 
                    document.getElementById('recipe-yield-unit').value = 'servings';
                }
                document.getElementById('recipe-prep-time').value = recipe.prepTime || '';
                document.getElementById('recipe-cook-time').value = recipe.cookTime || '';
                document.getElementById('recipe-resting-time').value = recipe.restingTime || '';
                document.getElementById('recipe-total-time').value = recipe.totalTime || '';
                document.getElementById('recipe-discovered-date').value = recipe.discoveredDate || '';
                document.getElementById('recipe-meal-type').value = recipe.mealType || '';
                document.getElementById('recipe-category').value = recipe.category || '';
                document.getElementById('recipe-notes').value = recipe.notes || '';
                document.getElementById('recipe-labels').value = (recipe.labels || []).join(', ');
                document.getElementById('recipe-ingredients').value = formatSections(ingredientsForForm);
                // Use the raw object data, not the formatted text string
    renderInstructionBuilder(recipe.instructions || []);
                renderAddRatingStars(recipe.rating || 0);
                populateLinkedRecipesSelect(recipe.linkedRecipeIds);
                
                if (isEditing) {
                    formSummary.textContent = `Editing: ${recipe.name}`;
                    addRecipeBtn.textContent = "Save Changes";
                } else {
                    formSummary.textContent = `Adding New Recipe (from copy): ${recipe.name}`;
                    addRecipeBtn.textContent = "Add Recipe";
                }
                
                switchTab('add-recipe');
                window.scrollTo({ top: 0, behavior: 'smooth' });

                if (!document.getElementById('cancel-edit-btn')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-edit-btn';
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600';
                    cancelBtn.addEventListener('click', resetForm);
                    document.getElementById('form-buttons').appendChild(cancelBtn);
                }
            }

            function printRecipe(recipe) {
                const printArea = document.getElementById('print-area');
                
                // Process data for display
                const ingredientsData = processData(recipe.ingredients, 'Ingredients');
                const instructionsData = processData(recipe.instructions, 'Instructions');

                // Format Ingredients for Print (with checkboxes)
                const ingredientsHtml = ingredientsData.map(section => `
                    <h3 class="font-bold mt-4 uppercase text-sm border-b border-gray-300 mb-2">${section.section}</h3>
                    <ul class="space-y-1 text-sm">
                        ${(section.items || []).map(item => {
                            const text = typeof item === 'string' ? item : item.text;
                            const tip = (typeof item === 'object' && item.tip) ? ` <i class="text-xs">(${item.tip})</i>` : '';
                            return `<li class="flex items-start gap-2">
                                <span class="inline-block w-4 h-4 border border-gray-400 rounded-sm mt-0.5 flex-shrink-0"></span>
                                <span>${text}${tip}</span>
                            </li>`;
                        }).join('')}
                    </ul>
                `).join('');

                // Format Instructions for Print
                const instructionsHtml = instructionsData.map(section => `
                    <h3 class="font-bold mt-4 uppercase text-sm border-b border-gray-300 mb-2">${section.section}</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        ${(section.items || []).map(item => {
                            const text = typeof item === 'string' ? item : item.text;
                            const tip = (typeof item === 'object' && item.tip) ? ` <i class="text-xs">(${item.tip})</i>` : '';
                            return `<li class="mb-2 pl-2 border-l-2 border-gray-100">${text}${tip}</li>`;
                        }).join('')}
                    </ol>
                `).join('');

                // Generate Layout
                const yieldText = typeof recipe.yield === 'object' && recipe.yield !== null 
                    ? `${recipe.yield.quantity || ''} ${recipe.yield.unit || ''}` 
                    : recipe.yield || 'N/A';

                printArea.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-start justify-between mb-6 border-b-2 border-black pb-4">
                            <div>
                                <h1 class="text-3xl font-bold mb-2">${recipe.name}</h1>
                                <div class="text-sm space-y-1 text-gray-600">
                                    <p><strong>Source:</strong> ${recipe.sourceName || 'N/A'}</p>
                                    <p><strong>Cuisine:</strong> ${recipe.cuisine || 'N/A'}</p>
                                </div>
                            </div>
                            ${recipe.imageUrl ? `<img src="${recipe.imageUrl}" class="w-32 h-32 object-cover rounded-lg border border-gray-300">` : ''}
                        </div>

                        <div class="grid grid-cols-4 gap-4 mb-6 text-sm bg-gray-50 p-4 rounded border border-gray-200">
                            <div><span class="font-bold block text-gray-500 text-xs uppercase">Prep Time</span>${recipe.prepTime || '-'} mins</div>
                            <div><span class="font-bold block text-gray-500 text-xs uppercase">Cook Time</span>${recipe.cookTime || '-'} mins</div>
                            <div><span class="font-bold block text-gray-500 text-xs uppercase">Total Time</span>${recipe.totalTime || '-'} mins</div>
                            <div><span class="font-bold block text-gray-500 text-xs uppercase">Yield</span>${yieldText}</div>
                        </div>

                        <div class="print-grid">
                            <div>
                                <h2 class="text-xl font-bold mb-2">Ingredients</h2>
                                ${ingredientsHtml}
                                
                                ${recipe.notes ? `
                                    <div class="mt-8 pt-4 border-t border-gray-300">
                                        <h3 class="font-bold text-sm uppercase mb-2">Notes</h3>
                                        <p class="text-sm italic text-gray-600">${recipe.notes}</p>
                                    </div>
                                ` : ''}
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-2">Instructions</h2>
                                ${instructionsHtml}
                            </div>
                        </div>
                        
                        <div class="mt-12 pt-4 border-t border-gray-300 text-center text-xs text-gray-400">
                            Printed via SH's RecipeManagr on ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;

                // Trigger Browser Print
                window.print();
            }

            // --- Timer Helper Functions (MOVED HERE) ---

            const parseDurationToMillis = (val, unit) => {
                let multiplier = 1000; // seconds
                if (unit.startsWith('m')) multiplier *= 60;
                else if (unit.startsWith('h')) multiplier *= 3600;
                return val * multiplier;
            };

            // Converts text like "(10 mins)" into clickable timer HTML
            const renderTextWithTimers = (text) => {
                // Regex matches: ( number space unit ) e.g. (5 mins), (1.5 h), (30s)
                const regex = /\((\d+(?:\.\d+)?)\s*(m|min|mins|minutes?|h|hr|hrs|hours?|s|sec|secs?|seconds?)\)/gi;
                
                return text.replace(regex, (match, val, unit) => {
                    const millis = parseDurationToMillis(parseFloat(val), unit.toLowerCase());
                    const displayUnit = unit.toLowerCase().startsWith('h') ? 'h' : (unit.toLowerCase().startsWith('m') ? 'm' : 's');
                    return `<button class="timer-btn" data-original-text="${val}${displayUnit}" data-millis="${millis}"><i class="fas fa-stopwatch"></i> ${val}${displayUnit}</button>`;
                });
            };

            // --- Instruction Builder Helpers ---

const createInstructionRow = (data = {}) => {
    const row = document.createElement('div');
    row.className = 'instruction-row flex flex-col md:flex-row gap-2 items-start bg-gray-50 dark:bg-gray-700/50 p-2 rounded border border-gray-200 dark:border-gray-600';
    row.dataset.type = 'step';

    const text = data.text || '';
    const timeVal = data.timer ? data.timer.val : '';
    const timeUnit = data.timer ? data.timer.unit : 'm';
    const imageUrl = data.imageUrl || '';

    row.innerHTML = `
        <div class="flex-grow w-full space-y-2">
            <textarea placeholder="Step instruction..." rows="2" class="step-text w-full p-2 text-sm border rounded dark:bg-gray-700 dark:border-gray-600 resize-y">${text}</textarea>
            ${imageUrl ? `<div class="step-image-preview relative w-fit"><img src="${imageUrl}" class="h-20 rounded border"><button type="button" class="remove-img-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fas fa-times"></i></button></div>` : ''}
        </div>
        <div class="flex flex-col gap-2 flex-shrink-0">
            <div class="flex items-center border rounded dark:border-gray-600 bg-white dark:bg-gray-700 overflow-hidden">
                <div class="px-2 text-gray-400 text-xs"><i class="fas fa-stopwatch"></i></div>
                <input type="number" placeholder="0" value="${timeVal}" class="step-time w-12 p-1 text-sm text-center outline-none dark:bg-gray-700 border-r dark:border-gray-600 appearance-none">
                <select class="step-unit p-1 text-sm bg-gray-50 dark:bg-gray-700 outline-none cursor-pointer">
                    <option value="s" ${timeUnit === 's' ? 'selected' : ''}>s</option>
                    <option value="m" ${timeUnit === 'm' ? 'selected' : ''}>m</option>
                    <option value="h" ${timeUnit === 'h' ? 'selected' : ''}>h</option>
                </select>
            </div>
            <label class="cursor-pointer bg-teal-50 dark:bg-teal-900/50 hover:bg-teal-100 text-teal-600 dark:text-teal-300 border border-teal-200 dark:border-teal-700 p-1 rounded text-xs text-center flex items-center justify-center gap-1 transition-colors">
                <i class="fas fa-camera"></i> <span>Add Img</span>
                <input type="file" class="step-image-input hidden" accept="image/*">
            </label>
            <button type="button" class="remove-row-btn text-red-400 hover:text-red-600 p-1 text-center"><i class="fas fa-trash-alt"></i></button>
        </div>
    `;

    // Handle image file selection preview
    const fileInput = row.querySelector('.step-image-input');
    fileInput.addEventListener('change', (e) => {
        if (fileInput.files && fileInput.files[0]) {
             const lbl = row.querySelector('label span');
             lbl.textContent = 'Selected';
             lbl.parentElement.classList.add('bg-green-50', 'text-green-600', 'border-green-200');
        }
    });

    // Handle removing existing image
    const removeImgBtn = row.querySelector('.remove-img-btn');
    if (removeImgBtn) {
        removeImgBtn.addEventListener('click', () => {
            row.dataset.removeImage = 'true';
            row.querySelector('.step-image-preview').remove();
        });
    }

    row.querySelector('.remove-row-btn').addEventListener('click', () => row.remove());
    return row;
};



const createSectionRow = (title = '') => {
    const row = document.createElement('div');
    row.className = 'instruction-row flex gap-2 items-center mt-4 mb-1';
    row.dataset.type = 'section';

    row.innerHTML = `
        <div class="flex-grow bg-gray-200 dark:bg-gray-600 h-px"></div>
        <input type="text" placeholder="Section Name (e.g. Sauce)" value="${title}" class="section-title font-bold text-sm text-center bg-transparent border-b border-gray-300 dark:border-gray-500 focus:border-teal-500 outline-none w-1/2">
        <div class="flex-grow bg-gray-200 dark:bg-gray-600 h-px"></div>
        <button type="button" class="remove-row-btn text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
    `;

    row.querySelector('.remove-row-btn').addEventListener('click', () => row.remove());
    return row;
};

const renderInstructionBuilder = (sections) => {
    const container = document.getElementById('instructions-builder');
    container.innerHTML = '';

    if (!sections || sections.length === 0) {
        // Add one empty step by default
        container.appendChild(createInstructionRow());
        return;
    }

    sections.forEach(section => {
        // Only render section header if it's not the default "Instructions" or "General"
        if (section.section && section.section !== 'Instructions' && section.section !== 'General') {
            container.appendChild(createSectionRow(section.section));
        }
        
        if (section.items) {
            section.items.forEach(item => {
                // Handle legacy string items vs object items
                const data = typeof item === 'string' ? { text: item } : item;
                container.appendChild(createInstructionRow(data));
            });
        }
    });
};

const getInstructionsFromBuilder = () => {
    const container = document.getElementById('instructions-builder');
    const rows = container.querySelectorAll('.instruction-row');
    
    const sections = [];
    let currentSection = { section: 'Instructions', items: [] };

    rows.forEach(row => {
        if (row.dataset.type === 'section') {
            if (currentSection.items.length > 0) sections.push(currentSection);
            const title = row.querySelector('.section-title').value.trim() || 'Section';
            currentSection = { section: title, items: [] };
        } else {
            const text = row.querySelector('.step-text').value.trim();
            // We include items even if text is empty if they have an image
            const fileInput = row.querySelector('.step-image-input');
            const hasFile = fileInput && fileInput.files.length > 0;
            const existingImg = row.querySelector('.step-image-preview');

            if (text || hasFile || existingImg) {
                const item = { text };
                const timeVal = row.querySelector('.step-time').value;
                const timeUnit = row.querySelector('.step-unit').value;
                
                if (timeVal) {
                    item.timer = { val: parseFloat(timeVal), unit: timeUnit };
                }
                
                // Attach file object to item for processing in handleAddOrUpdateRecipe
                if (hasFile) {
                    item.imageFile = fileInput.files[0];
                }
                
                // Persist existing URL unless removed
                if (existingImg && !row.dataset.removeImage) {
                    const imgTag = existingImg.querySelector('img');
                    if (imgTag) item.imageUrl = imgTag.src;
                }

                currentSection.items.push(item);
            }
        }
    });

    if (currentSection.items.length > 0 || sections.length === 0) {
        sections.push(currentSection);
    }
    
    return sections;
};

            const playTimerSound = () => {
                // Simple beep using AudioContext
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } catch(e) { console.error("Audio play failed", e); }
            };

async function showHistoryModal(recipeId, recipeName) {
    const container = document.getElementById('history-modal-container');
    container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4 relative flex flex-col max-h-[90vh]">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" onclick="document.getElementById('history-modal-container').classList.add('hidden'); document.getElementById('history-modal-container').classList.remove('flex');">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold mb-1 truncate pr-8">${recipeName}</h3>
            <h4 class="text-sm text-gray-500 uppercase font-bold mb-4">Cooking History</h4>
            
            <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg mb-4 border border-gray-200 dark:border-gray-600">
                <div class="flex gap-2 mb-2">
                    <input type="date" id="history-date" class="p-2 rounded border dark:bg-gray-700 dark:border-gray-600 text-sm" value="${new Date().toISOString().split('T')[0]}">
                    <div class="flex items-center gap-1 bg-white dark:bg-gray-700 border dark:border-gray-600 px-2 rounded">
                        ${[1,2,3,4,5].map(i => `<i class="fas fa-star cursor-pointer text-gray-300 hover:text-yellow-400 transition-colors" data-rating="${i}"></i>`).join('')}
                    </div>
                </div>
                <textarea id="history-notes" placeholder="Notes (e.g. 'Too salty', 'Cooked 5 mins longer')" class="w-full p-2 text-sm border rounded dark:bg-gray-700 dark:border-gray-600 mb-2" rows="2"></textarea>
                <button id="save-history-btn" class="w-full bg-green-600 text-white font-bold py-1.5 rounded text-sm hover:bg-green-700">Log Cook</button>
            </div>

            <div id="history-list" class="flex-grow overflow-y-auto space-y-3 custom-scrollbar">
                <p class="text-center text-gray-500 text-sm py-4">Loading history...</p>
            </div>
        </div>
    `;

    container.classList.remove('hidden');
    container.classList.add('flex');

    // Logic for Star Rating in Form
    let selectedRating = 0;
    const starContainer = container.querySelector('.flex.items-center.gap-1');
    const updateFormStars = (r) => {
        selectedRating = r;
        const stars = starContainer.querySelectorAll('i');
        stars.forEach((s, idx) => {
            s.className = `fas fa-star cursor-pointer text-lg transition-colors ${idx < r ? 'text-yellow-400' : 'text-gray-300'}`;
        });
    };
    starContainer.querySelectorAll('i').forEach(s => {
        s.addEventListener('click', () => updateFormStars(parseInt(s.dataset.rating)));
    });

    // Load History
    const loadHistory = async () => {
        const listContainer = container.querySelector('#history-list');
        try {
            const historyCol = collection(db, 'users', userId, 'recipes', recipeId, 'history');
            const q = query(historyCol, orderBy('cookedAt', 'desc'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 text-sm italic py-2">No logs yet.</p>';
                return;
            }

            listContainer.innerHTML = snapshot.docs.map(doc => {
                const data = doc.data();
                const date = data.cookedAt ? new Date(data.cookedAt).toLocaleDateString() : 'Unknown Date';
                const stars = Array.from({length: 5}, (_, i) => 
                    `<i class="fas fa-star text-xs ${i < data.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`
                ).join('');
                
                return `
                    <div class="p-3 bg-white dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600 text-sm group relative">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-700 dark:text-gray-300">${date}</span>
                            <div class="flex">${stars}</div>
                        </div>
                        ${data.notes ? `<p class="text-gray-600 dark:text-gray-400 italic">"${data.notes}"</p>` : ''}
                        <button class="delete-history-btn absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity" data-id="${doc.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');

            // Bind Delete Buttons
            listContainer.querySelectorAll('.delete-history-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm('Delete this log?')) {
                        await deleteDoc(doc(db, 'users', userId, 'recipes', recipeId, 'history', btn.dataset.id));
                        loadHistory();
                    }
                });
            });

        } catch (e) {
            console.error(e);
            listContainer.innerHTML = '<p class="text-red-500 text-sm">Error loading history.</p>';
        }
    };

    loadHistory();

    // Save New Log
    container.querySelector('#save-history-btn').onclick = async () => {
        const dateVal = container.querySelector('#history-date').value;
        const notes = container.querySelector('#history-notes').value;
        if (!dateVal) return alert('Please select a date');

        try {
            await addDoc(collection(db, 'users', userId, 'recipes', recipeId, 'history'), {
                cookedAt: dateVal, // Storing as YYYY-MM-DD string is fine for sorting usually, or convert to Date
                rating: selectedRating,
                notes: notes,
                timestamp: serverTimestamp()
            });
            // Reset form
            container.querySelector('#history-notes').value = '';
            updateFormStars(0);
            loadHistory();
            showNotification('Log saved');
        } catch (e) {
            console.error(e);
            showNotification('Failed to save log', 'error');
        }
    };
}

async function showRecipeDetailsModal(recipeId) {
    window.location.hash = `recipe/${recipeId}`;
    
    // 1. Manage Quick Access Tabs State
    if (typeof window.openRecipeIds === 'undefined') window.openRecipeIds = [];
    
    if (!window.openRecipeIds.includes(recipeId)) {
        window.openRecipeIds.push(recipeId);
    }
    
    // Save state
    localStorage.setItem('openRecipeIds', JSON.stringify(window.openRecipeIds));
    localStorage.setItem('openRecipeId', recipeId);

    let recipe = recipesCache.find(r => r.id === recipeId);
    if (!recipe) return;
    
    // Ensure data structures exist
    recipe.ingredientNotes = recipe.ingredientNotes || {};
    recipe.instructionNotes = recipe.instructionNotes || {};
    recipe.approvals = recipe.approvals || [];

    // Helper to keep screen awake
    let wakeLock = null;

    const toggleWakeLock = async (btn, shouldLock) => {
        if (!('wakeLock' in navigator)) return;
        try {
            if (shouldLock) {
                wakeLock = await navigator.wakeLock.request('screen');
                if(btn) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-yellow-400'); // Active color
                }
            } else {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                }
                if(btn) {
                    btn.classList.remove('text-yellow-400');
                    btn.classList.add('text-gray-400');
                }
            }
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    };

    // Helper for Native Sharing
    const shareRecipe = async () => {
        const shareData = {
            title: recipe.name,
            text: `Check out this recipe for ${recipe.name}!`,
            url: window.location.href
        };
        if (navigator.share) {
            try { await navigator.share(shareData); } catch (err) { console.log('Share canceled'); }
        } else {
            navigator.clipboard.writeText(`${recipe.name}\n\n${recipe.description || ''}`);
            showNotification("Recipe info copied to clipboard.");
        }
    };

    // Process Content
    const ingredientsData = processData(recipe.ingredients, 'Ingredients');
    const instructionsData = processData(recipe.instructions, 'Instructions');

    // Calculate Active Time
    let totalActiveMillis = 0;
    instructionsData.forEach(section => {
        (section.items || []).forEach(item => {
            if(item && item.timer) {
                totalActiveMillis += parseDurationToMillis(item.timer.val, item.timer.unit);
            }
        });
    });
    const activeTimeMins = Math.round(totalActiveMillis / 60000);

    // Fetch History for "Last Cooked" block
    let lastCookedHtml = '';
    try {
        const historyCol = collection(db, 'users', userId, 'recipes', recipeId, 'history');
        const q = query(historyCol, orderBy('cookedAt', 'desc'), limit(1));
        const historySnapshot = await getDocs(q);
        if (!historySnapshot.empty) {
            const lastLog = historySnapshot.docs[0].data();
            const lastCookedDate = lastLog.cookedAt ? new Date(lastLog.cookedAt).toLocaleDateString() : 'N/A';
            const lastCookedRatingHtml = Array.from({length: 5}, (_, i) => 
                `<i class="fas fa-star ${i < lastLog.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`
            ).join('');

            lastCookedHtml = `
            <div class="mt-4 p-3 bg-teal-50 dark:bg-teal-900/50 rounded-lg border border-teal-200 dark:border-teal-800 text-sm">
                <h5 class="font-bold text-teal-800 dark:text-teal-200 flex items-center"><i class="fas fa-history mr-2"></i>Last Cooked (${lastCookedDate})</h5>
                <div class="flex items-center my-1 text-xs">${lastCookedRatingHtml}</div>
                <p class="text-gray-600 dark:text-gray-400 italic">"${lastLog.notes || 'No notes were left.'}"</p>
            </div>`;
        }
    } catch(e) { console.error("Could not fetch last cooked history", e); }

    // Get Related Names
    const book = booksCache.find(b => b.id === recipe.bookId);
    const bookName = book ? book.name : null;
    const parentRecipe = recipesCache.find(r => r.id === recipe.adaptedFromId);
    
    // HTML Generators
    const ingredientsHtml = ingredientsData.map(section => `
        <h5 class="font-bold mt-3 text-gray-500 dark:text-gray-400 uppercase text-xs tracking-wider">${section.section}</h5>
        <ul class="list-none space-y-2 mt-1 pl-2">
            ${(section.items || []).map(item => {
                const itemText = (typeof item === 'object') ? item.text : item;
                if (!itemText) return '';
                const itemTip = (typeof item === 'object' && item.tip) ? item.tip : '';
                
                return `<li data-type="ingredient" data-key="${itemText}" class="relative pl-8 group transition-opacity duration-300">
                <button class="shopping-status-btn absolute left-0 top-0.5 text-gray-300 hover:text-green-500 w-6 h-6 flex items-center justify-center transition-colors" title="Toggle: Have / Need to Buy">
                    <i class="fas fa-check-circle"></i>
                </button>
                <span class="ingredient-text cursor-pointer hover:text-gray-500">${itemText} ${itemTip ? `<span class="text-xs text-gray-400 italic">(${itemTip})</span>` : ''}</span>
                <button class="add-note-btn opacity-0 group-hover:opacity-100 transition-opacity text-teal-500 hover:text-teal-700 ml-2"><i class="fas fa-plus-circle"></i></button>
                ${renderNote(recipe.ingredientNotes[createSafeKey(itemText)])}
            </li>`}).join('')}
        </ul>
    `).join('');

    const instructionsHtml = instructionsData.map(section => `
    <h5 class="font-bold mt-3 text-gray-500 dark:text-gray-400 uppercase text-xs tracking-wider">${section.section}</h5>
    <ol class="list-decimal list-inside space-y-3 mt-1">
            ${(section.items || []).map(item => {
                const itemText = typeof item === 'object' ? item.text : item;
                const itemTip = (typeof item === 'object' && item.tip) ? item.tip : '';
                const itemImg = (typeof item === 'object' && item.imageUrl) ? item.imageUrl : '';

                let contentHtml = renderTextWithTimers(itemText);

                if (typeof item === 'object' && item.timer) {
                    const millis = parseDurationToMillis(item.timer.val, item.timer.unit);
                    const display = `${item.timer.val}${item.timer.unit}`;
                    contentHtml += ` <button class="timer-btn ml-2" data-original-text="${display}" data-millis="${millis}"><i class="fas fa-stopwatch"></i> ${display}</button>`;
                }

                return `<li data-type="instruction" data-key="${itemText}" class="group pl-1">
            <div class="inline-block">
                <span class="cursor-pointer hover:text-gray-500 transition-colors">${contentHtml} ${itemTip ? `<span class="text-xs text-gray-400 italic">(${itemTip})</span>` : ''}</span>
                <button class="add-note-btn opacity-0 group-hover:opacity-100 transition-opacity text-teal-500 hover:text-teal-700 ml-2"><i class="fas fa-plus-circle"></i></button>
                ${itemImg ? `<div class="mt-2"><img src="${itemImg}" class="max-h-48 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"></div>` : ''}
                ${renderNote(recipe.instructionNotes[createSafeKey(itemText)])}
            </div>
        </li>`}).join('')}
    </ol>
    `).join('');
    
    const yieldText = typeof recipe.yield === 'object' && recipe.yield !== null ? `${recipe.yield.quantity || ''} ${recipe.yield.unit || ''}` : recipe.yield || 'N/A';

    // --- GENERATE TABS HTML ---
    const tabsHtml = window.openRecipeIds.map(id => {
        const r = recipesCache.find(x => x.id === id);
        if (!r) return '';
        const isActive = id === recipeId;
        const activeClass = isActive 
            ? 'bg-white dark:bg-gray-800 text-teal-600 dark:text-teal-300 border-t-2 border-l border-r border-gray-200 dark:border-gray-700 rounded-t-lg font-bold shadow-[0_2px_0_white] dark:shadow-[0_2px_0_#1f2937] z-10' 
            : 'bg-gray-100 dark:bg-gray-900 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 border-b border-gray-200 dark:border-gray-700';
        
        return `
            <div class="group flex items-center gap-2 px-4 py-2 text-sm cursor-pointer transition-all select-none min-w-[120px] max-w-[200px] ${activeClass}"
                 onclick="showRecipeDetailsModal('${id}')">
                <span class="truncate flex-grow">${r.name}</span>
                <button onclick="event.stopPropagation(); window.closeRecipeTab('${id}', '${recipeId}')" 
                    class="opacity-0 group-hover:opacity-100 hover:text-red-500 transition-opacity px-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');

    // --- MAIN MODAL TEMPLATE ---
    const modalContainer = document.getElementById('recipe-detail-modal');
    modalContainer.innerHTML = `
<div class="bg-gray-100 dark:bg-gray-900 rounded-none md:rounded-lg shadow-2xl w-full h-full md:h-auto md:max-h-[95vh] md:max-w-6xl flex flex-col">
    
    <div class="flex items-end px-2 pt-2 bg-gray-200 dark:bg-black/20 border-b dark:border-gray-700 overflow-x-auto custom-scrollbar flex-shrink-0 gap-1">
        ${tabsHtml}
    </div>

    <div class="p-3 bg-white dark:bg-gray-800 shadow-sm z-10 flex-shrink-0 border-b dark:border-gray-700">
        <div class="flex items-center gap-3">
            <img src="${recipe.imageUrl || 'https://placehold.co/150x150/e2e8f0/adb5bd?text=No+Image'}" alt="${recipe.name}" class="w-12 h-12 md:w-16 md:h-16 object-cover rounded-md flex-shrink-0 border border-gray-200 dark:border-gray-600">
            <div class="flex-grow min-w-0">
                <h2 class="text-lg md:text-2xl font-bold truncate leading-tight">${recipe.name}</h2>
                <div class="flex items-center flex-wrap gap-x-3 gap-y-1 mt-1">
                    <div class="modal-rating-stars flex items-center gap-1 text-sm"></div>
                    <button id="wakelock-btn" class="text-gray-400 p-1 rounded-full transition-colors hover:bg-gray-100 dark:hover:bg-gray-700" title="Keep Screen Awake">
                        <i class="fas fa-lightbulb"></i> <span class="text-xs hidden md:inline">Screen Awake</span>
                    </button>
                </div>
            </div>
            <button class="modal-close-btn p-2 -mr-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full flex-shrink-0"><i class="fas fa-times text-xl"></i></button>
        </div>
    </div>

    <div class="p-4 md:p-6 overflow-y-auto flex-grow custom-scrollbar" id="modal-content-area">
        ${recipe.description ? `<p class="mb-4 text-sm md:text-base text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 p-3 rounded-lg border dark:border-gray-700 italic">${recipe.description}</p>` : ''}
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 relative">
            
            <div class="md:col-span-2 order-1 md:order-2">
                
                <details open class="group bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border dark:border-gray-700 mb-6">
                    <summary class="flex justify-between items-end mb-2 border-b dark:border-gray-700 pb-2 cursor-pointer list-none select-none">
                        <h4 class="text-lg md:text-xl font-bold flex items-center">
                            <i class="fas fa-carrot text-orange-500 mr-2"></i>Ingredients
                            <i class="fas fa-chevron-down ml-2 text-xs text-gray-400 transition-transform group-open:rotate-180"></i>
                        </h4>
                        
                        <div class="flex items-center gap-2 text-xs" onclick="event.preventDefault()">
                            <select id="scale-select" class="bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded px-1 py-1">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="4">4x</option>
                            </select>
                            <select id="unit-system-select" class="bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded px-1 py-1 max-w-[80px]">
                                <option value="original">Orig</option>
                                <option value="us_customary">US</option>
                                <option value="uk_metric">Metric</option>
                                <option value="au_metric">AU Met</option>
                            </select>
                        </div>
                    </summary>
                    <div id="modal-ingredients" class="text-sm md:text-base leading-relaxed mt-2">${ingredientsHtml}</div>
                </details>

                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border dark:border-gray-700">
                        <h4 class="text-lg md:text-xl font-bold mb-2 border-b dark:border-gray-700 pb-2"><i class="fas fa-list-ol text-teal-500 mr-2"></i>Instructions</h4>
                        ${lastCookedHtml}
                        <div id="modal-instructions" class="text-sm md:text-base leading-relaxed">${instructionsHtml}</div>
                </div>
            </div>

            <div class="md:col-span-1 order-2 md:order-1 md:sticky md:top-0 md:self-start h-fit">
                <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700 overflow-hidden" ${window.innerWidth > 768 ? 'open' : ''}>
                    <summary class="flex justify-between items-center p-3 font-bold cursor-pointer bg-gray-50 dark:bg-gray-700 select-none">
                        <span><i class="fas fa-info-circle mr-2 text-teal-500"></i>Details</span>
                        <span class="transition-transform group-open:rotate-180"><i class="fas fa-chevron-down"></i></span>
                    </summary>
                    
                    <div class="p-4 space-y-4 text-sm max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <div>
                            <h4 class="text-lg font-bold mb-2 border-b dark:border-gray-700 pb-1 hidden md:block">Details</h4>
                            <div class="space-y-2 text-gray-700 dark:text-gray-300">
                                <p class="flex justify-between"><strong>Yield:</strong> <span>${yieldText}</span></p>
                                <p class="flex justify-between"><strong>Prep Time:</strong> <span>${recipe.prepTime || 'N/A'} min</span></p>
                                <p class="flex justify-between"><strong>Cook Time:</strong> <span>${recipe.cookTime || 'N/A'} min</span></p>
                                ${activeTimeMins > 0 ? `<p class="flex justify-between text-teal-600 dark:text-teal-400"><strong>Active Step Time:</strong> <span>${activeTimeMins} min</span></p>` : ''}
                                <p class="flex justify-between"><strong>Resting Time:</strong> <span>${recipe.restingTime || '0'} min</span></p>
                                <p class="flex justify-between"><strong>Total Time:</strong> <span>${recipe.totalTime || 'N/A'} min</span></p>
                                <p class="flex justify-between"><strong>Flavor:</strong> <span>${(recipe.flavorProfile || []).join(', ') || '-'}</span></p>
                                <p class="flex justify-between"><strong>Meal Type:</strong> <span>${recipe.mealType || '-'}</span></p>
                                <p class="flex justify-between"><strong>Category:</strong> <span>${recipe.category || '-'}</span></p>
                                ${bookName ? `<p class="flex justify-between"><strong>Collection:</strong> <span class="text-orange-600 dark:text-orange-400 font-semibold"><i class="fas fa-book mr-1"></i>${bookName}</span></p>` : ''}
                                ${parentRecipe ? `<p class="flex justify-between"><strong>Adapted from:</strong> <span class="cursor-pointer text-blue-500 hover:underline" onclick="document.querySelector('.modal-close-btn').click(); setTimeout(() => document.querySelector('[data-recipe-id=\\'${parentRecipe.id}\\']').click(), 100);">${parentRecipe.name}</span></p>` : ''}
                                <p class="flex justify-between"><strong>Discovered:</strong> <span>${recipe.discoveredDate || '-'}</span></p>
                                ${recipe.sourceName ? `
                                    <p class="flex justify-between">
                                        <strong>Source:</strong> 
                                        <span>
                                            ${recipe.sourceUrl ? `<a href="${recipe.sourceUrl}" target="_blank" class="text-teal-500 hover:underline">${recipe.sourceName} <i class="fas fa-external-link-alt text-xs"></i></a>` : recipe.sourceName}
                                        </span>
                                    </p>
                                ` : ''}
                            </div>
                            <div class="mt-4">
                                <strong class="block mb-1 text-xs uppercase text-gray-500">Labels</strong>
                                <div id="modal-labels-container" class="flex flex-wrap gap-1"></div>
                            </div>
                        </div>

                        <div id="linked-recipes-section" class="pt-4 border-t dark:border-gray-700">
                            <h4 class="font-bold mb-2">Related Recipes</h4>
                            <div id="linked-recipes-list" class="space-y-1"></div>
                        </div>

                        <div id="approvals-section" class="pt-4 border-t dark:border-gray-700">
                            <h4 class="font-bold mb-2">Approved By</h4>
                            <div id="approvals-list" class="flex flex-wrap gap-2 mb-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="approval-name-input" placeholder="Name" class="p-1.5 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm flex-grow min-w-0">
                                <button id="add-approval-btn" class="bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 font-bold px-3 rounded text-sm hover:bg-green-200"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <div class="p-3 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex flex-col md:flex-row gap-3 md:items-center justify-between rounded-b-none md:rounded-b-lg safe-area-pb flex-shrink-0">
        <div class="text-xs text-gray-400 order-2 md:order-1 text-center md:text-left hidden md:block">
            <span>Updated: ${recipe.updatedAt ? recipe.updatedAt.toDate().toLocaleDateString() : 'N/A'}</span>
        </div>
        <div class="flex flex-nowrap gap-2 overflow-x-auto pb-1 md:pb-0 justify-start md:justify-end order-1 md:order-2 w-full md:w-auto px-1 md:px-0">
            <button onclick="window.startCookMode(localStorage.getItem('openRecipeId'), document.getElementById('scale-select')?.value, document.getElementById('unit-system-select')?.value)" class="flex-shrink-0 bg-orange-100 hover:bg-orange-200 dark:bg-orange-900/40 dark:hover:bg-orange-800 text-orange-700 dark:text-orange-300 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-fire-burner"></i> Cook</button>
            <button id="modal-log-btn" class="flex-shrink-0 bg-green-100 hover:bg-green-200 dark:bg-green-900/40 dark:hover:bg-green-800 text-green-700 dark:text-green-300 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-check-circle"></i> Log</button>
            <button id="modal-edit-btn" class="flex-shrink-0 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-edit mr-1"></i> Edit</button>
            <button id="modal-share-btn" class="flex-shrink-0 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/40 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-share-alt"></i></button>
            <button id="modal-view-history-btn" class="flex-shrink-0 bg-purple-100 hover:bg-purple-200 dark:bg-purple-900/40 dark:hover:bg-purple-800 text-purple-700 dark:text-purple-300 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-history"></i></button>
            <button id="modal-print-btn" class="flex-shrink-0 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-print"></i></button>
            <button id="modal-duplicate-btn" class="flex-shrink-0 bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/40 dark:hover:bg-yellow-800 text-yellow-700 dark:text-yellow-300 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-copy"></i></button>
            <button id="modal-delete-btn" class="flex-shrink-0 bg-red-100 hover:bg-red-200 dark:bg-red-900/40 dark:hover:bg-red-800 text-red-600 dark:text-red-300 font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-trash"></i></button>
            <button class="modal-close-btn flex-shrink-0 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg text-sm">Close</button>
        </div>
    </div>
</div>`;


    
    // --- Define Tab Close Logic Globally (or Reuse if exists) ---
    window.closeRecipeTab = (idToClose, activeId) => {
        window.openRecipeIds = window.openRecipeIds.filter(id => id !== idToClose);
        localStorage.setItem('openRecipeIds', JSON.stringify(window.openRecipeIds));
        
        if (window.openRecipeIds.length === 0) {
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
            localStorage.removeItem('openRecipeId');
            if (wakeLock) wakeLock.release();
            history.pushState("", document.title, window.location.pathname + window.location.search);
        } else if (idToClose === activeId) {
            // Switch to the last opened recipe
            showRecipeDetailsModal(window.openRecipeIds[window.openRecipeIds.length - 1]);
        } else {
            // Refresh to update tab bar
            showRecipeDetailsModal(activeId);
        }
    };

    // --- Initial Render Logic ---
    renderReadOnlyRating(recipe.rating || 0);
    renderModalLabels(recipe);
    renderApprovals(recipe.id, recipe.approvals);
    renderLinkedRecipes(recipe.id);

    // --- Event Listeners ---
    const closeModal = () => {
        if (wakeLock) wakeLock.release(); 
        // We do NOT clear openRecipeIds here, allowing tabs to persist if user re-opens
        // But we hide the modal
        modalContainer.classList.add('hidden');
        modalContainer.classList.remove('flex');
    };
    
    modalContainer.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
    
    // Feature: Wake Lock
    // 1. Trigger the lock immediately
    toggleWakeLock(modalContainer.querySelector('#wakelock-btn'), true);

    // 2. Update the click listener
    modalContainer.querySelector('#wakelock-btn').addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const isCurrentlyActive = !!wakeLock;
        toggleWakeLock(btn, !isCurrentlyActive);
    });

    // Close when clicking background
    modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer) closeModal();
    });

    // Share
    modalContainer.querySelector('#modal-share-btn').addEventListener('click', shareRecipe);

    // Log & History
    modalContainer.querySelector('#modal-log-btn').addEventListener('click', () => showHistoryModal(recipe.id, recipe.name));
    modalContainer.querySelector('#modal-view-history-btn').addEventListener('click', () => showHistoryModal(recipe.id, recipe.name));
    
    // Print
    modalContainer.querySelector('#modal-print-btn').addEventListener('click', () => printRecipe(recipe));

    // Edit
    modalContainer.querySelector('#modal-edit-btn').addEventListener('click', () => {
        closeModal();
        populateFormForEdit(recipeId);
    });

    // Duplicate
    modalContainer.querySelector('#modal-duplicate-btn').addEventListener('click', () => {
        closeModal();
        const recipeCopy = JSON.parse(JSON.stringify(recipe));
        delete recipeCopy.id; delete recipeCopy.createdAt; delete recipeCopy.updatedAt; 
        delete recipeCopy.createdBy; delete recipeCopy.updatedBy; 
        delete recipeCopy.importedAt; delete recipeCopy.importedFromUrl;
        recipeCopy.name = `Copy of ${recipe.name}`;
        populateFormForEdit(recipeCopy);
    });

    // Delete
    modalContainer.querySelector('#modal-delete-btn').addEventListener('click', async () => {
        if (confirm(`Delete "${recipe.name}"?`)) {
            try {
                await deleteDoc(doc(db, 'users', userId, 'recipes', recipeId));
                // Remove from tabs if deleted
                window.closeRecipeTab(recipeId, recipeId);
                showNotification("Deleted.");
                loadRecipes(); 
            } catch (error) { 
                console.error("Error deleting:", error); 
                showNotification("Failed to delete.", "error"); 
            }
        }
    });
    
    // Notes & Strikethrough
    // [UPDATE] Replace the existing 'modal-content-area' click listener
modalContainer.querySelector('#modal-content-area').addEventListener('click', async (e) => {
    const listItem = e.target.closest('li');
    if (!listItem) return;

    // 1. Handle "Shopping Status" Toggle (Have vs Need)
    if (e.target.closest('.shopping-status-btn')) {
        e.stopPropagation();
        const btn = e.target.closest('.shopping-status-btn');
        const icon = btn.querySelector('i');
        const textSpan = listItem.querySelector('.ingredient-text');

        // Toggle State: Default (Gray Check) -> Need (Red Cart) -> Have (Green Check) -> Default
        if (btn.classList.contains('status-need')) {
            // Switch to "Have"
            btn.classList.remove('status-need', 'text-red-500');
            btn.classList.add('status-have', 'text-green-500');
            icon.className = 'fas fa-check-circle';
            textSpan.classList.add('line-through', 'opacity-50'); // Visually mark as "Have/Done"
        } else if (btn.classList.contains('status-have')) {
            // Switch to Default
            btn.classList.remove('status-have', 'text-green-500');
            btn.classList.add('text-gray-300');
            icon.className = 'fas fa-check-circle'; // Reset icon
            textSpan.classList.remove('line-through', 'opacity-50');
        } else {
            // Switch to "Need to Buy"
            btn.classList.remove('text-gray-300');
            btn.classList.add('status-need', 'text-red-500');
            icon.className = 'fas fa-shopping-cart';
            textSpan.classList.remove('line-through', 'opacity-50');
        }
        return;
    }

    // 2. Handle Step Completion & Auto-Cross Out
    if (listItem.dataset.type === 'instruction') {
        // Toggle strikethrough on the step itself
        const stepContent = listItem.querySelector('div') || listItem;
        stepContent.classList.toggle('opacity-50');
        // Check if we just marked it as done (low opacity)
        const isDone = stepContent.classList.contains('opacity-50');

        if (isDone) {
            const stepText = listItem.dataset.key.toLowerCase();
            // Find all ingredients
            const allIngredients = modalContainer.querySelectorAll('li[data-type="ingredient"]');
            
            allIngredients.forEach(ingLi => {
                const ingName = ingLi.dataset.key.toLowerCase();
                // Simple matching: if the ingredient name appears in the step text
                if (stepText.includes(ingName) || ingName.split(' ').some(word => word.length > 3 && stepText.includes(word))) {
                    const btn = ingLi.querySelector('.shopping-status-btn');
                    const textSpan = ingLi.querySelector('.ingredient-text');
                    
                    // Safety check: Ensure elements exist before modifying
                    if (btn && textSpan) {
                        // Visually mark ingredient as "used/have"
                        btn.classList.remove('status-need', 'text-red-500', 'text-gray-300');
                        btn.classList.add('status-have', 'text-green-500');
                        textSpan.classList.add('line-through', 'opacity-50');
                    }
                }
            });
        }
    }

        const noteDiv = e.target.closest('.italic');
        const isNoteClick = noteDiv && noteDiv.parentElement === listItem;

        if (e.target.closest('.add-note-btn') || isNoteClick) {
            e.stopPropagation();
            const type = listItem.dataset.type;
            const key = listItem.dataset.key;
            const encodedKey = createSafeKey(key);
            const noteMap = type === 'ingredient' ? 'ingredientNotes' : 'instructionNotes';
            
            const currentNote = recipe[noteMap][encodedKey] || '';
            const newNote = prompt(`Enter reminder for:\n"${key}"`, currentNote);

            if (newNote !== null) {
                try {
                    const recipeRef = doc(db, 'users', userId, 'recipes', recipeId);
                    const updatePayload = {};
                    updatePayload[`${noteMap}.${encodedKey}`] = newNote;
                    await updateDoc(recipeRef, updatePayload);
                    
                    recipe[noteMap][encodedKey] = newNote;
                    const noteContainer = listItem.querySelector('div');
                    if (noteContainer) noteContainer.remove();
                    if (newNote) {
                        listItem.insertAdjacentHTML('beforeend', renderNote(newNote));
                    }
                    showNotification("Note saved!");
                } catch (error) {
                    console.error("Error saving note: ", error);
                    showNotification("Failed to save note.", "error");
                }
            }
        } 
        else if (e.target.closest('span')) {
            listItem.classList.toggle('strikethrough');
        }
    });

    // Conversion and Scaling
    const unitSelect = modalContainer.querySelector('#unit-system-select');
    const scaleSelect = modalContainer.querySelector('#scale-select');

    const updateIngredientsDisplay = () => {
        const system = unitSelect.value;
        const scale = parseFloat(scaleSelect.value);
        convertAndRenderIngredients(recipe, system, scale);
    };

    unitSelect.addEventListener('change', updateIngredientsDisplay);
    scaleSelect.addEventListener('change', updateIngredientsDisplay);

    // Timers
    const activeIntervals = new Map();
    modalContainer.addEventListener('click', (e) => {
        const timerBtn = e.target.closest('.timer-btn');
        if (!timerBtn) return;
        
        e.stopPropagation();

        if (timerBtn.classList.contains('running')) {
            clearInterval(activeIntervals.get(timerBtn));
            activeIntervals.delete(timerBtn);
            timerBtn.classList.remove('running');
            timerBtn.innerHTML = `<i class="fas fa-stopwatch"></i> ${timerBtn.dataset.originalText}`;
        } else if (timerBtn.classList.contains('finished')) {
            timerBtn.classList.remove('finished');
            timerBtn.innerHTML = `<i class="fas fa-stopwatch"></i> ${timerBtn.dataset.originalText}`;
        } else {
            const duration = parseInt(timerBtn.dataset.millis);
            const endTime = Date.now() + duration;
            
            timerBtn.classList.add('running');
            
            const updateTimer = () => {
                const remaining = endTime - Date.now();
                if (remaining <= 0) {
                    clearInterval(activeIntervals.get(timerBtn));
                    activeIntervals.delete(timerBtn);
                    timerBtn.classList.remove('running');
                    timerBtn.classList.add('finished');
                    timerBtn.innerHTML = `<i class="fas fa-bell"></i> Done!`;
                    // playTimerSound(); // Assuming global function
                    if (Notification.permission === "granted") {
                        new Notification(`Timer Done: ${recipe.name}`, { body: "Step timer finished!" });
                    }
                } else {
                    const totalSeconds = Math.ceil(remaining / 1000);
                    const m = Math.floor(totalSeconds / 60);
                    const s = totalSeconds % 60;
                    const timeStr = m > 0 ? `${m}m ${s}s` : `${s}s`;
                    timerBtn.innerHTML = `<i class="fas fa-hourglass-half"></i> ${timeStr}`;
                }
            };
            
            updateTimer();
            const intervalId = setInterval(updateTimer, 1000);
            activeIntervals.set(timerBtn, intervalId);

            if (Notification.permission === "default") Notification.requestPermission();
        }
    });

    const originalCloseModal = closeModal;
    const cleanupAndClose = () => {
        activeIntervals.forEach(id => clearInterval(id));
        activeIntervals.clear();
        originalCloseModal();
    };
    modalContainer.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.removeEventListener('click', closeModal);
        btn.addEventListener('click', cleanupAndClose);
    });

    modalContainer.classList.remove('hidden');
    modalContainer.classList.add('flex');
}

            // UPDATE: Add to existing load functions
async function loadBooks() {
    if (!userId) return;
    try {
        const booksCol = collection(db, 'users', userId, 'books');
        const q = query(booksCol, orderBy("name", "asc"));
        const snapshot = await getDocs(q);
        booksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateBooksSelect();
    } catch (error) {
        console.error("Error loading books:", error);
    }
}

// UPDATE: Add helper to populate the select dropdown
function populateBooksSelect(selectedId = null) {
    const select = document.getElementById('recipe-book-select');
    if (!select) return;
    select.innerHTML = '<option value="">Unassigned</option>';
    booksCache.forEach(book => {
        const option = document.createElement('option');
        option.value = book.id;
        option.textContent = book.name;
        if (book.id === selectedId) option.selected = true;
        select.appendChild(option);
    });
}

// UPDATE: Add helper to populate 'Adapted From' (exclude current recipe to avoid loops)
function populateAdaptedFromSelect(currentId = null, selectedParentId = null) {
    const select = document.getElementById('adapted-from-select');
    if (!select) return;
    select.innerHTML = '<option value="">None (Original)</option>';
    
    // Sort recipes alphabetically
    const sortedRecipes = [...recipesCache].sort((a, b) => a.name.localeCompare(b.name));
    
    sortedRecipes.forEach(r => {
        if (r.id === currentId) return; // Don't link to self
        const option = document.createElement('option');
        option.value = r.id;
        option.textContent = r.name;
        if (r.id === selectedParentId) option.selected = true;
        select.appendChild(option);
    });
}

// UPDATE: New Modal Logic for Books
function showBooksModal() {
    const container = document.getElementById('books-modal-container');
    container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-none md:rounded-lg shadow-2xl w-full h-full md:h-auto md:max-h-[90vh] max-w-lg flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold">Manage Recipe Books</h3>
                <button id="close-books-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <form id="add-book-form" class="space-y-4 mb-6">
                    <input type="text" id="book-name-input" placeholder="Collection Name (e.g. Grandma's Favorites)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                    <input type="text" id="book-desc-input" placeholder="Description (Optional)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <button type="submit" class="w-full bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700">Add Collection</button>
                </form>
                <h4 class="text-xl font-bold mb-2">Your Collections</h4>
                <div id="book-list" class="space-y-2"></div>
            </div>
        </div>
    `;

    const listEl = container.querySelector('#book-list');

    function renderBooksList() {
        if (booksCache.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500">No collections created.</p>';
            return;
        }
        listEl.innerHTML = booksCache.map(book => `
            <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-900 rounded-lg">
                <div>
                    <p class="font-semibold">${book.name}</p>
                    <p class="text-sm text-gray-500">${book.description || ''}</p>
                </div>
                <button data-id="${book.id}" class="delete-book-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
        
        listEl.querySelectorAll('.delete-book-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (confirm('Delete this collection? Recipes will not be deleted.')) {
                    await deleteDoc(doc(db, 'users', userId, 'books', e.currentTarget.dataset.id));
                    await loadBooks();
                    renderBooksList();
                }
            });
        });
    }

    renderBooksList();

    container.querySelector('#add-book-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('book-name-input').value.trim();
        const description = document.getElementById('book-desc-input').value.trim();
        if (name) {
            await addDoc(collection(db, 'users', userId, 'books'), { name, description, createdAt: serverTimestamp() });
            e.target.reset();
            await loadBooks();
            renderBooksList();
        }
    });

    container.querySelector('#close-books-modal-btn').addEventListener('click', () => {
        container.classList.add('hidden');
        container.classList.remove('flex');
    });

    container.classList.remove('hidden');
    container.classList.add('flex');
}

            function renderModalRating(recipeId, rating) {
                const container = modalContainer.querySelector('.modal-rating-stars');
                if(!container) return;
                container.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('i');
                    star.className = `fas fa-star cursor-pointer text-2xl ${i <= rating ? 'text-yellow-400' : 'text-gray-300'}`;
                    star.dataset.value = i;
                    star.addEventListener('click', async () => {
                        const newRating = Number(star.dataset.value);
                        try {
                            const recipeRef = doc(db, 'users', userId, 'recipes', recipeId);
                            await updateDoc(recipeRef, { rating: newRating, updatedAt: serverTimestamp() });
                            const recipeInCache = recipesCache.find(r => r.id === recipeId);
                            if(recipeInCache) recipeInCache.rating = newRating;
                            renderModalRating(recipeId, newRating);
                            showNotification("Rating updated!");
                        } catch (error) { console.error("Error updating rating:", error); showNotification("Failed to update rating.", "error"); }
                    });
                    container.appendChild(star);
                }
            }

            function renderModalLabels(recipe) {
                const container = modalContainer.querySelector('#modal-labels-container');
                container.innerHTML = '';
                (recipe.labels || []).forEach(label => {
                    container.innerHTML += `<span class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${label}</span>`;
                });
                container.innerHTML += `<button id="modal-edit-labels-btn" class="text-teal-500 hover:text-teal-700 ml-2 text-xs"><i class="fas fa-edit"></i></button>`;
                
                modalContainer.querySelector('#modal-edit-labels-btn').addEventListener('click', () => {
                    const currentLabels = (recipe.labels || []).join(', ');
                    const newLabelsStr = prompt('Edit labels (comma-separated):', currentLabels);
                    if (newLabelsStr !== null) {
                        const newLabels = newLabelsStr.split(',').map(l => l.trim()).filter(Boolean);
                        updateRecipeField(recipe.id, { labels: newLabels }).then(() => {
                            let recipeInCache = recipesCache.find(r => r.id === recipe.id);
                            if (recipeInCache) recipeInCache.labels = newLabels;
                            recipe.labels = newLabels;
                            renderModalLabels(recipe);
                            showNotification('Labels updated!');
                        });
                    }
                });
            }

             function renderLinkedRecipes(recipeId) {
                const recipe = recipesCache.find(r => r.id === recipeId);
                const container = document.getElementById('linked-recipes-list');
                container.innerHTML = '';
                if (recipe && recipe.linkedRecipeIds && recipe.linkedRecipeIds.length > 0) {
                    recipe.linkedRecipeIds.forEach(linkedId => {
                        const linkedRecipe = recipesCache.find(r => r.id === linkedId);
                        if (linkedRecipe) {
                            const linkEl = document.createElement('a');
                            linkEl.href = '#';
                            linkEl.textContent = linkedRecipe.name;
                            linkEl.className = 'block text-sm text-teal-500 hover:underline';
                            linkEl.addEventListener('click', (e) => {
                                e.preventDefault();
                                showRecipeDetailsModal(linkedId);
                            });
                            container.appendChild(linkEl);
                        }
                    });
                } else {
                    container.innerHTML = '<p class="text-sm text-gray-500">No linked recipes.</p>';
                }
            }

function renderReadOnlyRating(rating) {
    const container = modalContainer.querySelector('.modal-rating-stars');
    if(!container) return;
    container.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('i');
        // Removed 'cursor-pointer' and click listener
        star.className = `fas fa-star text-lg ${i <= rating ? 'text-yellow-400' : 'text-gray-300'}`;
        container.appendChild(star);
    }
}

            function renderApprovals(recipeId, approvals) {
                const container = document.getElementById('approvals-list');
                container.innerHTML = '';
                (approvals || []).forEach(name => {
                    const approvalEl = document.createElement('span');
                    approvalEl.className = 'bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 text-xs px-2 py-1 rounded-full flex items-center gap-1';
                    approvalEl.innerHTML = `${name} <button data-name="${name}" class="remove-approval-btn text-red-500 hover:text-red-700 text-xs"><i class="fas fa-times-circle"></i></button>`;
                    container.appendChild(approvalEl);
                });

                container.querySelectorAll('.remove-approval-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const nameToRemove = e.currentTarget.dataset.name;
                        const newApprovals = (approvals || []).filter(name => name !== nameToRemove);
                        await updateRecipeField(recipeId, { approvals: newApprovals });
                        let recipeInCache = recipesCache.find(r => r.id === recipeId);
                        if (recipeInCache) recipeInCache.approvals = newApprovals;
                        renderApprovals(recipeId, newApprovals);
                        showNotification('Approval removed!');
                    });
                });

                document.getElementById('add-approval-btn').onclick = async () => {
                    const input = document.getElementById('approval-name-input');
                    const newName = input.value.trim();
                    if (newName) {
                        const newApprovals = [...(approvals || []), newName];
                        await updateRecipeField(recipeId, { approvals: newApprovals });
                        let recipeInCache = recipesCache.find(r => r.id === recipeId);
                        if (recipeInCache) recipeInCache.approvals = newApprovals;
                        renderApprovals(recipeId, newApprovals);
                        input.value = '';
                        showNotification('Approval added!');
                    }
                };
            }

            async function updateRecipeField(recipeId, fieldsToUpdate) {
                if (!userId || !recipeId) return;
                try {
                    const recipeRef = doc(db, 'users', userId, 'recipes', recipeId);
                    await updateDoc(recipeRef, { ...fieldsToUpdate, updatedAt: serverTimestamp() });
                } catch (error) {
                    console.error("Error updating recipe field:", error);
                    showNotification("Failed to update recipe.", "error");
                    throw error;
                }
            }
            
            function convertAndRenderIngredients(recipe, system, scale = 1) {
    const ingredientsData = processData(recipe.ingredients, 'Ingredients');
    let convertedHtml = '';

    ingredientsData.forEach(section => {
        convertedHtml += `<h5 class="font-bold mt-3 text-gray-500 dark:text-gray-400 uppercase text-sm">${section.section}</h5>`;
        convertedHtml += `<ul class="list-none space-y-2 mt-1 pl-2">`;
        (section.items || []).forEach(item => {
            const originalText = (typeof item === 'string') ? item : item.text;
            if (!originalText) return;

            // ... (keep your existing scaling/conversion logic here) ...
            let processedText = scaleIngredientString(originalText, scale);
            if (system !== 'original') {
                processedText = convertIngredientString(processedText, system);
            }
            
            const tipHtml = (typeof item === 'object' && item.tip) ? `<span class="text-xs text-gray-400 italic">(${item.tip})</span>` : '';
            const noteKey = (typeof item === 'object') ? item.text : item;
            const noteHtml = recipe.ingredientNotes && recipe.ingredientNotes[createSafeKey(noteKey)] ? renderNote(recipe.ingredientNotes[createSafeKey(noteKey)]) : '';
            
            // [UPDATE] Added 'shopping-status-btn' and data attributes
            convertedHtml += `<li data-type="ingredient" data-key="${noteKey}" class="relative pl-8 group transition-opacity duration-300">
                <button class="shopping-status-btn absolute left-0 top-0.5 text-gray-300 hover:text-green-500 w-6 h-6 flex items-center justify-center transition-colors" title="Toggle: Have / Need to Buy">
                    <i class="fas fa-check-circle"></i>
                </button>
                <span class="ingredient-text cursor-pointer hover:text-gray-500">${processedText} ${tipHtml}</span>
                <button class="add-note-btn opacity-0 group-hover:opacity-100 transition-opacity text-teal-500 hover:text-teal-700 ml-2"><i class="fas fa-plus-circle"></i></button>
                ${noteHtml}
            </li>`;
        });
        convertedHtml += `</ul>`;
    });
    
    document.getElementById('modal-ingredients').innerHTML = convertedHtml;
}

            function scaleIngredientString(itemText, scaleFactor) {
    if (typeof itemText !== 'string' || scaleFactor === 1) return itemText;

    // Regex to find numbers at the start of the string (integers, decimals, fractions like 1/2 or 1 1/2)
    // This looks for: start of line -> optional number -> optional space -> fraction OR standard decimal/int
    const regex = /^((?:\d+\s+)?\d+\/\d+|\d+(\.\d+)?)/;
    
    const match = itemText.match(regex);
    if (!match) return itemText;

    let originalNumber = 0;
    const numberStr = match[0].trim();

    // Handle Fractions (e.g., "1/2" or "1 1/2")
    if (numberStr.includes('/')) {
        const parts = numberStr.split(' ');
        let fraction = parts.length > 1 ? parts[1] : parts[0];
        let whole = parts.length > 1 ? parseFloat(parts[0]) : 0;
        
        const [num, den] = fraction.split('/').map(parseFloat);
        originalNumber = whole + (num / den);
    } else {
        // Handle decimals/integers
        originalNumber = parseFloat(numberStr);
    }

    if (isNaN(originalNumber)) return itemText;

    // Calculate new amount
    let newAmount = originalNumber * scaleFactor;

    // formatting: if it's a whole number, don't show decimals. If decimal, max 2 places.
    // Ideally, convert 0.5 back to 1/2, but for simplicity, we'll stick to decimals for now.
    let formattedAmount = Number.isInteger(newAmount) ? newAmount.toString() : newAmount.toFixed(2).replace(/\.00$/, '').replace(/0+$/, '');

    // Replace the old number with the new scaled number
    return itemText.replace(numberStr, formattedAmount);
}
            
            function convertIngredientString(itemText, system) {
                if (typeof itemText !== 'string') return itemText;

                const regex = /(\d+\.?\d*|\d+)\s*(g|grams|tsp|teaspoons|tbsp|tablespoons|cup|cups)\b/i;
                const match = itemText.match(regex);
                if (!match) return itemText;

                const quantity = parseFloat(match[1]);
                const unit = match[2].toLowerCase();
                let convertedQuantity, newUnit;

                switch(unit) {
                    case 'g': case 'grams':
                        if (system === 'us_customary') {
                            convertedQuantity = (quantity * CONVERSIONS.G_TO_OZ).toFixed(1);
                            newUnit = 'oz';
                            return itemText.replace(match[0], `${convertedQuantity} ${newUnit}`);
                        }
                        break;
                    case 'tsp': case 'teaspoons':
                        if (system !== 'original') {
                            convertedQuantity = (quantity * CONVERSIONS.TSP_TO_ML.metric).toFixed(1);
                            newUnit = 'mL';
                            return itemText.replace(match[0], `${convertedQuantity} ${newUnit}`);
                        }
                        break;
                    case 'tbsp': case 'tablespoons':
                        if (CONVERSIONS.TBSP_TO_ML[system]) {
                            convertedQuantity = (quantity * CONVERSIONS.TBSP_TO_ML[system]).toFixed(1);
                            newUnit = 'mL';
                            return itemText.replace(match[0], `${convertedQuantity} ${newUnit}`);
                        }
                        break;
                    case 'cup': case 'cups':
                        if (system === 'us_customary' || system === 'uk_metric' || system === 'au_metric') {
                            const targetSystem = (system === 'us_customary') ? 'us_customary' : 'metric';
                            convertedQuantity = (quantity * CONVERSIONS.CUP_TO_ML[targetSystem]).toFixed(0);
                            newUnit = 'mL';
                            return itemText.replace(match[0], `${convertedQuantity} ${newUnit}`);
                        }
                        break;
                }
                return itemText;
            }

            async function loadPreferences() {
    // 1. Load Theme (Local Storage)
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    // 2. Load Layout & Sort (Local Storage)
    currentLayout = localStorage.getItem('recipeLayout') || 'tiles';
    currentSort = localStorage.getItem('recipeSort') || 'title-asc';
    
    const savedOptions = localStorage.getItem('recipeDisplayOptions');
    if (savedOptions) displayOptions = JSON.parse(savedOptions);

    // 3. Update UI Controls to match data
    if (layoutSelect) layoutSelect.value = currentLayout;
    if (sortBySelect) sortBySelect.value = currentSort;
    
    Object.keys(displayOptions).forEach(key => {
        // Convert camelCase (showImages) to hyphenated-id (show-images-toggle)
        const toggleId = key.replace(/([A-Z])/g, "-$1").toLowerCase() + '-toggle';
        const toggle = document.getElementById(toggleId);
        if (toggle) toggle.checked = displayOptions[key];
    });

    // 4. (Optional) Sync Theme from Database if logged in
    if (userId) {
        try {
            const settingsRef = doc(db, 'users', userId, 'settings', 'theme');
            const settingsSnap = await getDoc(settingsRef);
            if (settingsSnap.exists()) {
                const remoteTheme = settingsSnap.data().theme;
                // If database has a different theme, update local
                if (remoteTheme && remoteTheme !== savedTheme) {
                    applyTheme(remoteTheme);
                    localStorage.setItem('theme', remoteTheme);
                }
            }
        } catch (e) {
            console.log("Could not sync remote settings yet.");
        }
    }
}

            function savePreferences() {
                localStorage.setItem('recipeLayout', currentLayout);
                localStorage.setItem('recipeSort', currentSort);
                localStorage.setItem('recipeDisplayOptions', JSON.stringify(displayOptions));
            }

            function updateMultiSelectUI() {
                appContainer.classList.toggle('multi-select-mode', isMultiSelectMode);
                bulkActionsBar.classList.toggle('hidden', !isMultiSelectMode);
                multiSelectBtn.textContent = isMultiSelectMode ? 'Cancel Selection' : 'Select Multiple Recipes';
                if (!isMultiSelectMode) {
                    optionsPanel.classList.add('hidden');
                }
                selectionCountEl.textContent = `${selectedRecipeIds.size} recipes selected`;
            }

            function parseISODurationToMinutes(isoDuration) {
                if (!isoDuration || typeof isoDuration !== 'string') return 0;
                const regex = /PT(?:(\d+)H)?(?:(\d+)M)?/;
                const matches = isoDuration.match(regex);
                if (!matches) return 0;
                const hours = parseInt(matches[1] || 0, 10);
                const minutes = parseInt(matches[2] || 0, 10);
                return (hours * 60) + minutes;
            }

            function getImageUrl(image) {
                if (!image) return null;
                if (typeof image === 'string') return image;
                if (Array.isArray(image)) {
                    const firstImage = image[0];
                    if(typeof firstImage === 'string') return firstImage;
                    if(typeof firstImage === 'object' && firstImage.url) return firstImage.url;
                }
                if (typeof image === 'object' && image.url) return image.url;
                return null;
            }
            
            function textDurationToISO(text) {
                if (!text || typeof text !== 'string') return null;
                let hours = 0;
                let minutes = 0;
                const hourMatch = text.match(/(\d+)\s*(?:hours?|hr)/i);
                const minMatch = text.match(/(\d+)\s*(?:minutes?|mins?)/i);
                
                if (hourMatch) hours = parseInt(hourMatch[1], 10);
                if (minMatch) minutes = parseInt(minMatch[1], 10);
                
                if (!hourMatch && !minMatch && /^\d+$/.test(text.trim())) {
                    minutes = parseInt(text.trim(), 10);
                }
                
                if (hours === 0 && minutes === 0) return null;

                let duration = 'PT';
                if (hours > 0) duration += `${hours}H`;
                if (minutes > 0) duration += `${minutes}M`;
                return duration;
            }

            function normalizeJsonLdStructure(data, defaultSectionName) {
                if (!Array.isArray(data)) return [{ section: defaultSectionName, items: [] }];

                const sections = [];
                let currentSection = { section: defaultSectionName, items: [] };

                data.forEach(item => {
                    if (typeof item === 'object' && item !== null && item['@type'] === 'HowToSection') {
                        if (currentSection.items.length > 0) {
                            sections.push(currentSection);
                        }
                        currentSection = { section: item.text.replace(/\[|\]|:/g, '').trim(), items: [] };
                    } else if (typeof item === 'object' && item !== null && item['@type'] === 'HowToStep') {
                        currentSection.items.push({ text: item.text });
                    } else if (typeof item === 'string') {
                        const match = item.trim().match(/^\[(.*?)\]:?$/);
                        if (match && item.trim().endsWith(']')) {
                             if (currentSection.items.length > 0) {
                                sections.push(currentSection);
                            }
                            currentSection = { section: match[1].trim(), items: [] };
                        } else {
                            currentSection.items.push({ text: item });
                        }
                    }
                });
                
                if (currentSection.items.length > 0 || sections.length === 0) {
                    sections.push(currentSection);
                }
                return sections;
            }
            
            function parseRecipeSageTxt(txtContent) {
                const recipes = [];
                let content = txtContent.trim().replace(/\r\n/g, '\n');
                
                const lines = content.split('\n');
                let firstRecipeTitleFromHeader = '';
                if (lines.length > 0 && lines[0].trim().startsWith('==== Recipes ====')) {
                    firstRecipeTitleFromHeader = lines[0].replace(/^==== Recipes ====/, '').replace(/^-/, '').trim();
                    lines.shift();
                    content = lines.join('\n');
                }

                const recipeBlocks = content.split(/^\s*---\s*$/m);

                recipeBlocks.forEach((block, index) => {
                    const trimmedBlock = block.trim();
                    if (!trimmedBlock) return;

                    const recipe = {
                        recipeIngredient: [],
                        recipeInstructions: [],
                        comment: [],
                        keywords: []
                    };
                    let blockLines = trimmedBlock.split('\n');
                    let currentSection = 'meta';
                    let currentSectionData = null;

                    // Handle Title
                    if (index === 0 && firstRecipeTitleFromHeader) {
                        recipe.name = firstRecipeTitleFromHeader;
                    } else {
                        const titleLineIndex = blockLines.findIndex(line => line.trim() !== '');
                        if (titleLineIndex !== -1) {
                            recipe.name = blockLines[titleLineIndex].trim();
                            blockLines = blockLines.slice(titleLineIndex + 1);
                        } else {
                            return; 
                        }
                    }
                    if (recipe.name.toLowerCase().startsWith('title:')) {
                        recipe.name = recipe.name.substring(6).trim();
                    }

                    for (const line of blockLines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) {
                            currentSection = 'meta';
                            continue;
                        }

                        const separatorIndex = trimmedLine.indexOf(':');
                        if (currentSection === 'meta' && separatorIndex > 0) {
                            const key = trimmedLine.substring(0, separatorIndex).toLowerCase().trim();
                            const value = trimmedLine.substring(separatorIndex + 1).trim();
                            
                            let keyProcessed = true;
                            switch (key) {
                                case 'description': recipe.description = value; break;
                                case 'source': recipe.creditText = value; break;
                                case 'url': recipe.url = value; break;
                                case 'yield': case 'servings': recipe.recipeYield = value; break;
                                case 'prep time': case 'prep': recipe.prepTime = textDurationToISO(value); break;
                                case 'cook time': case 'cook': recipe.cookTime = textDurationToISO(value); break;
                                case 'total time': case 'total': recipe.totalTime = textDurationToISO(value); break;
                                case 'tags': case 'folders': recipe.keywords = value.split(/[,/]/).map(k => k.trim()).filter(Boolean); break;
                                case 'createdat': recipe.datePublished = new Date(value).toISOString(); break;
                                case 'updatedat': recipe.dateModified = new Date(value).toISOString(); break;
                                case 'rating': recipe.rating = parseInt(value, 10) || 0; break;
                                default: keyProcessed = false; break;
                            }
                            if (keyProcessed) continue;
                        }

                        const lowerLine = trimmedLine.toLowerCase();
                        if (lowerLine === 'ingredients') {
                            currentSection = 'ingredients';
                            currentSectionData = { section: 'Ingredients', items: [] };
                            if (!recipe.recipeIngredient.find(s => s.section === 'Ingredients')) recipe.recipeIngredient.push(currentSectionData);
                            continue;
                        }
                        if (lowerLine.startsWith('direction') || lowerLine === 'instructions') {
                            currentSection = 'instructions';
                            currentSectionData = { section: 'Instructions', items: [] };
                            if (!recipe.recipeInstructions.find(s => s.section === 'Instructions')) recipe.recipeInstructions.push(currentSectionData);
                            continue;
                        }
                        if (lowerLine === 'notes') {
                            currentSection = 'notes';
                            currentSectionData = [];
                            recipe.comment = currentSectionData;
                            continue;
                        }

                        if (trimmedLine === trimmedLine.toUpperCase() && !trimmedLine.match(/\d/) && separatorIndex === -1 && trimmedLine.length > 1) {
                            if (currentSection !== 'instructions') {
                                currentSection = 'ingredients';
                                currentSectionData = { section: trimmedLine, items: [] };
                                recipe.recipeIngredient.push(currentSectionData);
                            } else {
                                currentSection = 'instructions';
                                currentSectionData = { section: trimmedLine, items: [] };
                                recipe.recipeInstructions.push(currentSectionData);
                            }
                            continue;
                        }
                        
                        if (currentSection === 'ingredients' && currentSectionData) {
                            currentSectionData.items.push({ text: trimmedLine.replace(/^- /, '') });
                        } else if (currentSection === 'instructions' && currentSectionData) {
                            currentSectionData.items.push({ text: trimmedLine.replace(/^\d+\.\s*/, '') });
                        } else if (currentSection === 'notes' && currentSectionData) {
                            currentSectionData.push({ text: trimmedLine });
                        }
                    }

                    if (recipe.name) {
                        recipes.push(recipe);
                    }
                });

                return recipes;
            }

            async function handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const btnToDisable = event.target.id === 'import-file-input' ? fetchUrlBtn : importFileInput;
                btnToDisable.disabled = true;
                showNotification(`Processing ${file.name}...`, 'info');
                importReviewSection.classList.add('hidden');

                try {
                    const content = await file.text();
                    const fileType = file.name.split('.').pop().toLowerCase();
                    
                    if (fileType === 'txt') {
                        fetchedRecipesCache = parseRecipeSageTxt(content);
                    } else if (fileType === 'json' || fileType === 'jsonld') {
                        const data = JSON.parse(content);
                        fetchedRecipesCache = data.recipes || (Array.isArray(data) ? data : [data]);
                    } else {
                        throw new Error("Unsupported file type.");
                    }

                    if (!fetchedRecipesCache || fetchedRecipesCache.length === 0) {
                        showNotification('No recipes found in the file.', 'error');
                        return;
                    }

                    importSummaryText.textContent = `Found ${fetchedRecipesCache.length} recipe(s) in this file.`;
                    batchImportBtn.textContent = `Import All (${fetchedRecipesCache.length} recipes)`;
                    importReviewSection.classList.remove('hidden');

                } catch (error) {
                    console.error('File import failed:', error);
                    showNotification(`Failed to process file: ${error.message}`, 'error');
                } finally {
                    btnToDisable.disabled = false;
                    event.target.value = ''; // Reset file input
                }
            }


            function populateFormWithImportedData(recipe) {
                form.reset();
                currentRating = 0;
                renderAddRatingStars();
                editingRecipeId = null;
                importedImageUrl = null;
                document.getElementById('form-buttons').querySelector('#cancel-edit-btn')?.remove();

                const imagePreview = document.getElementById('image-preview');
                importedImageUrl = getImageUrl(recipe.image);
                if (importedImageUrl) {
                    imagePreview.src = importedImageUrl;
                    imagePreview.classList.remove('hidden');
                } else {
                    imagePreview.classList.add('hidden');
                }

                document.getElementById('recipe-name').value = recipe.name || '';
                document.getElementById('recipe-description').value = recipe.description || '';
                document.getElementById('recipe-cuisine').value = recipe.recipeCuisine || '';
                document.getElementById('recipe-source-url').value = recipe.isBasedOn || recipe.url || '';
                
                let sourceName = '';
                if(typeof recipe.author === 'object' && recipe.author !== null) {
                    sourceName = recipe.author.name || '';
                } else if (recipe.author) {
                    sourceName = recipe.author;
                } else if (recipe.creditText) {
                    sourceName = recipe.creditText;
                }
                document.getElementById('recipe-source-name').value = sourceName;
                
                if (recipe.recipeYield) {
                    const yieldString = Array.isArray(recipe.recipeYield) ? recipe.recipeYield[0] : recipe.recipeYield;
                    const yieldParts = yieldString.toString().match(/(\d+\.?\d*)\s*(.*)/);
                    if (yieldParts) {
                        document.getElementById('recipe-yield-quantity').value = yieldParts[1] || '';
                        document.getElementById('recipe-yield-unit').value = yieldParts[2].trim() || 'servings';
                    }
                }

                document.getElementById('recipe-prep-time').value = parseISODurationToMinutes(recipe.prepTime) || '';
                document.getElementById('recipe-cook-time').value = parseISODurationToMinutes(recipe.cookTime) || '';
                document.getElementById('recipe-total-time').value = parseISODurationToMinutes(recipe.totalTime) || '';

                if (recipe.datePublished) {
                    document.getElementById('recipe-discovered-date').value = new Date(recipe.datePublished).toISOString().split('T')[0];
                }
                
                document.getElementById('recipe-ingredients').value = formatSections(normalizeJsonLdStructure(recipe.recipeIngredient, 'Ingredients'));
                
                // FIX: Define and process instructions before rendering
                const instructions = normalizeJsonLdStructure(recipe.recipeInstructions, 'Instructions');
                renderInstructionBuilder(instructions);
                
                let notes = '';
                if (Array.isArray(recipe.comment)) {
                    notes = recipe.comment.map(c => c.text).join('\n\n');
                } else if (typeof recipe.comment === 'object' && recipe.comment !== null && recipe.comment.text) {
                    notes = recipe.comment.text;
                }
                document.getElementById('recipe-notes').value = notes;

                let labels = [];
                if (recipe.keywords) {
                    const keywords = Array.isArray(recipe.keywords) ? recipe.keywords : recipe.keywords.split(',').map(k => k.trim());
                    labels.push(...keywords);
                }
                if (recipe.recipeCategory) {
                    const categories = Array.isArray(recipe.recipeCategory) ? recipe.recipeCategory : [recipe.recipeCategory];
                    labels.push(...categories);
                }
                if (!labels.some(l => l.toLowerCase() === 'imported')) {
                    labels.push('imported');
                }
                document.getElementById('recipe-labels').value = [...new Set(labels)].join(', ');
                
                renderAddRatingStars(0);
                formSummary.textContent = `Importing: ${recipe.name}`;
                addRecipeBtn.textContent = "Add Recipe";
            }

            function prepareRecipeDataForImport(recipe, importUrl) {
                let sourceName = '';
                if (recipe.creditText) {
                    sourceName = recipe.creditText;
                } else if (typeof recipe.author === 'object' && recipe.author !== null) {
                    sourceName = recipe.author.name || '';
                } else if (recipe.author) {
                    sourceName = recipe.author;
                }

                let yieldQuantity = null;
                let yieldUnit = 'servings';
                if (recipe.recipeYield) {
                    const yieldString = Array.isArray(recipe.recipeYield) ? recipe.recipeYield[0] : recipe.recipeYield;
                    const yieldParts = yieldString.toString().match(/(\d+\.?\d*)\s*(.*)/);
                    if (yieldParts) {
                        yieldQuantity = Number(yieldParts[1]) || null;
                        yieldUnit = yieldParts[2].trim() || 'servings';
                    }
                }

                let labels = [];
                if (recipe.keywords) {
                    const keywords = Array.isArray(recipe.keywords) ? recipe.keywords : recipe.keywords.split(/[,/]/).map(k => k.trim()).filter(Boolean);
                    labels.push(...keywords);
                }
                if (recipe.recipeCategory) {
                    const categories = Array.isArray(recipe.recipeCategory) ? recipe.recipeCategory : [recipe.recipeCategory];
                    labels.push(...categories);
                }
                if(!labels.some(l => l.toLowerCase() === 'imported')) {
                    labels.push('imported');
                }

                const ingredients = normalizeJsonLdStructure(recipe.recipeIngredient, 'Ingredients');
                const instructions = normalizeJsonLdStructure(recipe.recipeInstructions, 'Instructions');
                
                let notes = '';
                if (Array.isArray(recipe.comment)) {
                    notes = recipe.comment.map(c => c.text).join('\n\n');
                } else if (typeof recipe.comment === 'object' && recipe.comment !== null && recipe.comment.text) {
                    notes = recipe.comment.text;
                }

                return {
                    name: recipe.name || 'Untitled Recipe',
                    description: recipe.description || '',
                    cuisine: recipe.recipeCuisine || '',
                    sourceUrl: recipe.isBasedOn || recipe.url || importUrl,
                    sourceName: sourceName,
                    yield: { quantity: yieldQuantity, unit: yieldUnit },
                    prepTime: parseISODurationToMinutes(recipe.prepTime) || 0,
                    cookTime: parseISODurationToMinutes(recipe.cookTime) || 0,
                    totalTime: parseISODurationToMinutes(recipe.totalTime) || 0,
                    discoveredDate: recipe.datePublished ? new Date(recipe.datePublished).toISOString().split('T')[0] : '',
                    ingredients: ingredients,
                    instructions: instructions,
                    notes: notes,
                    labels: [...new Set(labels)],
                    imageUrl: getImageUrl(recipe.image) || '',
                    rating: recipe.rating || 0,
                    ingredientNotes: {},
                    instructionNotes: {},
                    approvals: [],
                    createdAt: recipe.datePublished ? new Date(recipe.datePublished) : serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    createdBy: userId,
                    updatedBy: userId,
                    importedFromUrl: importUrl,
                    importedAt: serverTimestamp()
                };
            }

            async function handleFetchFromUrl(url, type) {
                if (!url) {
                    showNotification('Please enter a URL.', 'error');
                    return;
                }
                const btn = type === 'txt' ? fetchTxtUrlBtn : fetchUrlBtn;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Fetching...';
                importReviewSection.classList.add('hidden');

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    if (type === 'txt') {
                        const textContent = await response.text();
                        fetchedRecipesCache = parseRecipeSageTxt(textContent);
                        showNotification('Successfully parsed TXT data.', 'success');
                    } else { // jsonld
                        const data = await response.json();
                        fetchedRecipesCache = data.recipes || (Array.isArray(data) ? data : [data]);
                        showNotification('Successfully parsed JSON-LD data.', 'success');
                    }
                    
                    if (!fetchedRecipesCache || fetchedRecipesCache.length === 0) {
                        showNotification('No recipes found at that URL or in the file.', 'error');
                        return;
                    }
                    
                    importSummaryText.textContent = `Found ${fetchedRecipesCache.length} recipe(s) in this file.`;
                    batchImportBtn.textContent = `Import All (${fetchedRecipesCache.length} recipes)`;
                    importReviewSection.classList.remove('hidden');

                } catch (error) {
                    console.error('Import failed:', error);
                    showNotification('Failed to fetch recipe data. Check the URL and file type.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = type === 'txt' ? 'Fetch TXT' : 'Fetch JSON-LD';
                }
            }


            async function handleBatchImport() {
                if(fetchedRecipesCache.length === 0) {
                    showNotification('No recipes to import.', 'error');
                    return;
                }

                showNotification(`Importing ${fetchedRecipesCache.length} recipes...`, 'info', 0);
                const url = document.getElementById('import-url-input').value.trim() || document.getElementById('import-txt-url-input').value.trim();
                const batch = writeBatch(db);
                const recipesCol = collection(db, `users/${userId}/recipes`);

                fetchedRecipesCache.forEach(recipeJson => {
                    const recipeData = prepareRecipeDataForImport(recipeJson, url);
                    const newRecipeRef = doc(recipesCol);
                    batch.set(newRecipeRef, recipeData);
                });

                try {
                    await batch.commit();
                    showNotification(`Successfully imported ${fetchedRecipesCache.length} recipes!`, 'success');
                    resetForm();
                    await loadRecipes();
                    switchTab('recipes');
                } catch(error) {
                    console.error("Batch import error:", error);
                    showNotification("An error occurred during the batch import.", "error");
                }
            }
            
            function showNextImportModal() {
                const promptText = document.getElementById('next-import-prompt-text');
                promptText.textContent = `You have ${fetchedRecipesCache.length} more recipes to import. Load the next one into the editor?`;
                nextImportModalEl.classList.remove('hidden');
                nextImportModalEl.classList.add('flex');
            }

             async function renderTimeline() {
                timelineContainer.innerHTML = '<p class="text-gray-500">Loading timeline...</p>';
                if (!userId) return;

                try {
                    let allHistory = [];
                    for (const recipe of recipesCache) {
                        const historyCol = collection(db, 'users', userId, 'recipes', recipe.id, 'history');
                        const historySnapshot = await getDocs(historyCol);
                        historySnapshot.forEach(doc => {
                            allHistory.push({ recipeName: recipe.name, recipeId: recipe.id, ...doc.data() });
                        });
                    }

                    allHistory.sort((a, b) => new Date(b.cookedAt) - new Date(a.cookedAt));

                    if (allHistory.length === 0) {
                        timelineContainer.innerHTML = '<p class="text-gray-500">No cooking history to display.</p>';
                        return;
                    }

                    const groupedByYear = allHistory.reduce((acc, log) => {
                        const year = new Date(log.cookedAt).getFullYear();
                        if (!acc[year]) acc[year] = [];
                        acc[year].push(log);
                        return acc;
                    }, {});

                    timelineContainer.innerHTML = '';
                    const sortedYears = Object.keys(groupedByYear).sort((a, b) => b - a);

                    sortedYears.forEach(year => {
                        const yearSection = document.createElement('div');
                        yearSection.innerHTML = `<h3 class="text-2xl font-bold mb-4">${year}</h3>`;
                        const yearGrid = document.createElement('div');
                        yearGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                        
                        groupedByYear[year].forEach(log => {
                            const cookedDate = new Date(log.cookedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                            const ratingHtml = Array.from({length: 5}, (_, i) => `<i class="fas fa-star text-xs ${i < log.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`).join('');
                            
                            const logCard = document.createElement('div');
                            logCard.className = 'bg-gray-100 dark:bg-gray-700 p-4 rounded-lg';
                            logCard.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold cursor-pointer hover:underline" data-recipe-id="${log.recipeId}">${log.recipeName}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${cookedDate}</p>
                                    </div>
                                    <div class="flex">${ratingHtml}</div>
                                </div>
                                ${log.imageUrl ? `<img src="${log.imageUrl}" class="w-full h-32 object-cover rounded-md my-2">` : ''}
                                <p class="text-sm mt-2 italic">"${log.notes || 'No notes.'}"</p>
                            `;
                             logCard.querySelector('.font-bold').addEventListener('click', (e) => {
                                showRecipeDetailsModal(e.target.dataset.recipeId);
                            });
                            yearGrid.appendChild(logCard);
                        });
                        yearSection.appendChild(yearGrid);
                        timelineContainer.appendChild(yearSection);
                    });

                } catch (error) {
                    console.error("Error rendering timeline:", error);
                    timelineContainer.innerHTML = '<p class="text-red-500">Could not load timeline.</p>';
                }
            }

            function populateLinkedRecipesSelect(selectedIds = []) {
                const select = document.getElementById('linked-recipes-select');
                select.innerHTML = '';
                recipesCache
                    .filter(r => r.id !== editingRecipeId)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(recipe => {
                        const option = document.createElement('option');
                        option.value = recipe.id;
                        option.textContent = recipe.name;
                        if (selectedIds.includes(recipe.id)) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
            }
            
            // --- Event Listeners ---
            // --- Safe Event Listeners ---

            // Tab Navigation
            if (recipesTabBtn) recipesTabBtn.addEventListener('click', () => switchTab('recipes'));
            if (addRecipeTabBtn) addRecipeTabBtn.addEventListener('click', () => {
                resetForm();
                switchTab('add-recipe');
            });
            if (timelineTabBtn) timelineTabBtn.addEventListener('click', () => switchTab('timeline'));

            // Import & Fetch Buttons
            if (fetchUrlBtn) fetchUrlBtn.addEventListener('click', () => handleFetchFromUrl(document.getElementById('import-url-input').value.trim(), 'jsonld'));
            if (fetchTxtUrlBtn) fetchTxtUrlBtn.addEventListener('click', () => handleFetchFromUrl(document.getElementById('import-txt-url-input').value.trim(), 'txt'));
            if (importFileInput) importFileInput.addEventListener('change', handleFileImport);
            if (batchImportBtn) batchImportBtn.addEventListener('click', handleBatchImport);
            
            if (loadFirstRecipeBtn) {
                loadFirstRecipeBtn.addEventListener('click', () => {
                    if(fetchedRecipesCache.length > 0) {
                        populateFormWithImportedData(fetchedRecipesCache[0]);
                    }
                });
            }

            // Next Import Modal
            const nextImportConfirm = document.getElementById('next-import-confirm-btn');
            const nextImportCancel = document.getElementById('next-import-cancel-btn');
            if (nextImportConfirm) {
                nextImportConfirm.addEventListener('click', () => {
                    nextImportModalEl.classList.add('hidden');
                    nextImportModalEl.classList.remove('flex');
                    if (fetchedRecipesCache.length > 0) {
                        populateFormWithImportedData(fetchedRecipesCache[0]);
                    }
                });
            }
            if (nextImportCancel) {
                nextImportCancel.addEventListener('click', () => {
                    nextImportModalEl.classList.add('hidden');
                    nextImportModalEl.classList.remove('flex');
                    resetForm();
                });
            }

            // Theme Toggle
            if (themeToggle) {
                themeToggle.addEventListener('click', async () => {
                    const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                    applyTheme(newTheme);
                    localStorage.setItem('theme', newTheme);
                    if (userId) {
                        try {
                            await setDoc(doc(db, 'users', userId, 'settings', 'theme'), { theme: newTheme }, { merge: true });
                        } catch (e) { console.error(e); }
                    }
                });
            }

            // Options Menu
            if (optionsBtn) {
                optionsBtn.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    if(optionsPanel) optionsPanel.classList.toggle('hidden'); 
                });
            }
            // Close options when clicking outside
            document.addEventListener('click', (e) => { 
                if (optionsPanel && !optionsPanel.contains(e.target) && !optionsBtn.contains(e.target)) { 
                    optionsPanel.classList.add('hidden'); 
                }
            });

            // Feature Buttons (Wrapped in IF checks to prevent crashes)
            if (manageAppliancesBtn) {
                manageAppliancesBtn.addEventListener('click', () => {
                    if (optionsPanel) optionsPanel.classList.add('hidden');
                    showAppliancesModal();
                });
            }
            
            if (layoutSelect) {
                layoutSelect.addEventListener('change', () => { currentLayout = layoutSelect.value; savePreferences(); filterRecipes(); });
            }
            
            if (sortBySelect) {
                sortBySelect.addEventListener('change', () => { currentSort = sortBySelect.value; savePreferences(); filterRecipes(); });
            }

            document.querySelectorAll('[id$="-toggle"]').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const key = e.target.id.replace(/-toggle$/, '').replace(/-(\w)/g, (match, p1) => p1.toUpperCase());
                    displayOptions[key] = e.target.checked;
                    savePreferences();
                    filterRecipes();
                });
            });

            // 1. "Select Multiple" Button (Blue)
            if (multiSelectBtn) {
    multiSelectBtn.addEventListener('click', () => {
        isMultiSelectMode = true;
        isShoppingListMode = false;
        
        // FIX: Use document.getElementById to find the LIVE button, not the old variable
        const liveShopBtn = document.getElementById('generate-shopping-list-btn');
        if(liveShopBtn) liveShopBtn.classList.remove('hidden');
                    
                    // FIX: Force the Shop List button to SHOW
                    if(generateShoppingListBtn) generateShoppingListBtn.classList.remove('hidden'); 
                    
                    // Ensure Delete button is also shown
                    if(bulkDeleteBtn) bulkDeleteBtn.classList.remove('hidden'); 
                    
                    updateMultiSelectUI(); 
                    filterRecipes(); 
                });
            }

            // 2. "Shopping List Mode" Button (Green)
            if (shoppingListModeBtn) {
                shoppingListModeBtn.addEventListener('click', () => { 
                    isMultiSelectMode = true; 
                    isShoppingListMode = true; 

                    const liveShopBtn = document.getElementById('generate-shopping-list-btn');
        if(liveShopBtn) liveShopBtn.classList.remove('hidden');
                    
                    // FIX: Force the Shop List button to SHOW
                    if(generateShoppingListBtn) generateShoppingListBtn.classList.remove('hidden'); 
                    
                    // Hide delete button in this specific mode (optional safety)
                    if(bulkDeleteBtn) bulkDeleteBtn.classList.add('hidden'); 
                    
                    updateMultiSelectUI(); 
                    filterRecipes(); 
                });
            }

            // 3. "Select by Label" Button
            const selectByLabelBtn = document.getElementById('select-by-label-btn');
            if (selectByLabelBtn) {
                selectByLabelBtn.addEventListener('click', () => {
                    const selectedLabel = prompt("Enter the label to select:");
                    if (!selectedLabel) return;

                    const recipesToSelect = recipesCache.filter(recipe => recipe.labels && recipe.labels.includes(selectedLabel));

                    const liveShopBtn = document.getElementById('generate-shopping-list-btn');
        if(liveShopBtn) liveShopBtn.classList.remove('hidden');
                    
                    if (recipesToSelect.length === 0) {
                        showNotification('No recipes found with that label.', 'info');
                        return;
                    }

                    isMultiSelectMode = true;
                    isShoppingListMode = false;
                    
                    // FIX: Force the Shop List button to SHOW
                    if(generateShoppingListBtn) generateShoppingListBtn.classList.remove('hidden');
                    
                    if(bulkDeleteBtn) bulkDeleteBtn.classList.remove('hidden');
                    
                    recipesToSelect.forEach(recipe => selectedRecipeIds.add(recipe.id));
                    
                    updateMultiSelectUI();
                    filterRecipes();
                    if(optionsPanel) optionsPanel.classList.add('hidden');
                    showNotification(`${recipesToSelect.length} recipes with label "${selectedLabel}" selected.`, 'success');
                });
            }
            

            if (cancelSelectionBtn) {
                cancelSelectionBtn.addEventListener('click', () => { isMultiSelectMode = false; isShoppingListMode = false; selectedRecipeIds.clear(); updateMultiSelectUI(); filterRecipes(); });
            }

            if (bulkDeleteBtn) {
                bulkDeleteBtn.addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to delete ${selectedRecipeIds.size} recipes? This action cannot be undone.`)) {
                        const deletePromises = Array.from(selectedRecipeIds).map(id => deleteDoc(doc(db, 'users', userId, 'recipes', id)));
                        try {
                            await Promise.all(deletePromises);
                            showNotification(`${selectedRecipeIds.size} recipes deleted successfully.`);
                            isMultiSelectMode = false; selectedRecipeIds.clear(); updateMultiSelectUI(); loadRecipes();
                        } catch (error) { showNotification("Failed to delete recipes.", "error"); console.error("Bulk delete error:", error); }
                    }
                });
            }

            // [UPDATE] Logic for 'generate-shopping-list-btn'
if (generateShoppingListBtn) {
    generateShoppingListBtn.addEventListener('click', () => {
        let itemsToBuy = [];
        
        // Check if we are inside a specific recipe modal looking for specific marked items
        const openModal = document.getElementById('recipe-detail-modal');
        if (openModal && !openModal.classList.contains('hidden')) {
            const markedNeeds = openModal.querySelectorAll('.status-need');
            if (markedNeeds.length > 0) {
                markedNeeds.forEach(btn => {
                    const li = btn.closest('li');
                    itemsToBuy.push(li.dataset.key); // Use the raw key (ingredient name)
                });
            }
        }

        // Fallback: If no specific items marked "Need" in modal, or we are in bulk mode, use standard logic
        if (itemsToBuy.length === 0) {
            selectedRecipeIds.forEach(id => {
                const recipe = recipesCache.find(r => r.id === id);
                if (recipe) {
                    const ingredientsData = processData(recipe.ingredients, 'Ingredients');
                    ingredientsData.forEach(section => {
                        (section.items || []).forEach(item => {
                            const mainItem = item.text.split('##')[0].trim();
                            if (mainItem) itemsToBuy.push(mainItem);
                        });
                    });
                }
            });
        }

        if (itemsToBuy.length === 0) return showNotification("No items found to buy.", "info");

        // Consolidate duplicates
        let consolidated = {};
        itemsToBuy.forEach(item => {
            consolidated[item] = (consolidated[item] || 0) + 1;
        });

        let shoppingListText = 'Shopping List:\n\n' + Object.entries(consolidated).sort().map(([key, count]) => {
            return count > 1 ? `- ${key} (x${count})` : `- ${key}`;
        }).join('\n');

        navigator.clipboard.writeText(shoppingListText);
        showNotification(`${itemsToBuy.length} items copied to clipboard!`);
    });
}

// --- Shopping List Logic ---
let shoppingListItems = [];
let shoppingModeActive = false;

// 1. Process Ingredients from Recipes
function aggregateShoppingList() {
    let itemsMap = {};

    selectedRecipeIds.forEach(id => {
        const recipe = recipesCache.find(r => r.id === id);
        if (!recipe) return;

        const ingredients = processData(recipe.ingredients, 'Ingredients');
        ingredients.forEach(section => {
            (section.items || []).forEach(item => {
                // Determine ingredient name
                let rawText = typeof item === 'string' ? item : item.text;
                if (!rawText) return;
                
                // Clean up name (remove quantities for aggregation grouping)
                // This regex removes leading numbers/fractions and units like "200g", "1/2 cup"
                let name = rawText.replace(/^([\d\/\.\s]+)?(g|kg|ml|l|oz|lb|cups?|tbsp|tsp|tablespoons?|teaspoons?|grams?)?\s+/i, '').trim();
                // Remove bracketed tips
                name = name.replace(/\s*\(.*?\)/g, '').trim().toLowerCase();
                // Simple singularization (remove trailing 's' if >3 chars)
                if(name.endsWith('s') && name.length > 3) name = name.slice(0, -1);

                if (!itemsMap[name]) {
                    itemsMap[name] = { 
                        name: name, // Display name (lowercase)
                        original: [rawText], 
                        count: 1, 
                        status: 'need', // 'need', 'have', 'cart'
                        recipes: [recipe.name] 
                    };
                } else {
                    itemsMap[name].count++;
                    itemsMap[name].original.push(rawText);
                    if (!itemsMap[name].recipes.includes(recipe.name)) {
                        itemsMap[name].recipes.push(recipe.name);
                    }
                }
            });
        });
    });

    // Convert map to array and sort
    shoppingListItems = Object.values(itemsMap).sort((a, b) => a.name.localeCompare(b.name));
}

// 2. Render List Items
function renderPlannerList(filter = 'all') { // filter: 'all', 'need', 'have'
    const container = document.getElementById('planner-list-container');
    container.innerHTML = '';

    if (shoppingListItems.length === 0) {
        container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400 p-8"><i class="fas fa-carrot text-4xl mb-4"></i><p>No ingredients found.</p></div>';
        return;
    }

    let itemsToShow = shoppingListItems;
    if (filter === 'need') itemsToShow = shoppingListItems.filter(i => i.status === 'need');
    if (filter === 'have') itemsToShow = shoppingListItems.filter(i => i.status === 'have');

    // Create List HTML
    itemsToShow.forEach((item, index) => {
        // Find actual index in main array to update state correctly
        const realIndex = shoppingListItems.indexOf(item); 
        
        const el = document.createElement('div');
        
        // Dynamic Styling based on Shopping Mode vs Planning Mode
        if (shoppingModeActive) {
            // SHOPPING MODE: Big clickable rows
            el.className = `p-4 border-b dark:border-gray-700 flex items-center justify-between cursor-pointer transition-colors ${item.status === 'cart' ? 'bg-green-50 dark:bg-green-900/20' : 'bg-white dark:bg-gray-800'}`;
            el.onclick = () => toggleItemStatus(realIndex, 'cart');
            
            const isChecked = item.status === 'cart';
            el.innerHTML = `
                <div class="flex items-center gap-4 flex-grow">
                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isChecked ? 'bg-green-500 border-green-500' : 'border-gray-300 dark:border-gray-500'}">
                        ${isChecked ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                    </div>
                    <div class="${isChecked ? 'line-through text-gray-400' : 'text-gray-800 dark:text-gray-100'}">
                        <span class="font-bold text-lg capitalize">${item.name}</span>
                        ${item.count > 1 ? `<span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full ml-2">x${item.count}</span>` : ''}
                        <div class="text-xs text-gray-400 font-normal mt-0.5">${item.original.join(', ')}</div>
                    </div>
                </div>
            `;
        } else {
            // PLANNING MODE: Toggle Have/Need
            const isHave = item.status === 'have';
            el.className = `p-3 border-b dark:border-gray-700 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors ${isHave ? 'opacity-60' : ''}`;
            
            el.innerHTML = `
                <div class="flex-grow pr-2">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold capitalize text-base ${isHave ? 'line-through text-gray-400' : 'text-gray-800 dark:text-gray-200'}">${item.name}</span>
                        ${item.recipes.length > 1 ? `<span class="text-[10px] bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200 px-1.5 py-0.5 rounded">${item.recipes.length} recipes</span>` : ''}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate w-full max-w-[250px]">${item.original[0]} ${item.count > 1 ? `(+${item.count-1} more)` : ''}</div>
                </div>
                <button class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-bold transition-colors ${isHave ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200'}" onclick="toggleItemStatus(${realIndex}, 'have')">
                    ${isHave ? '<i class="fas fa-check-circle"></i> Have' : '<i class="fas fa-shopping-basket"></i> Need'}
                </button>
            `;
        }
        container.appendChild(el);
    });
    
    if (itemsToShow.length === 0 && shoppingModeActive) {
        container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-green-500 p-8"><i class="fas fa-check-circle text-6xl mb-4"></i><p class="text-xl font-bold">All Done!</p><p>You have collected all items.</p></div>';
    }
}

// 3. Toggle Logic
function toggleItemStatus(index, type) {
    if (type === 'have') {
        // Toggle between 'need' and 'have'
        shoppingListItems[index].status = shoppingListItems[index].status === 'have' ? 'need' : 'have';
        // Refresh Planning view
        const currentFilter = document.querySelector('.planner-filter-btn.ring-2')?.dataset.filter || 'all';
        renderPlannerList(currentFilter);
    } else if (type === 'cart') {
        // Toggle between 'need' and 'cart' (bought)
        shoppingListItems[index].status = shoppingListItems[index].status === 'cart' ? 'need' : 'cart';
        // Refresh Shopping view (stay on current list, effectively moves item to bottom or crosses it out)
        renderPlannerList('need'); 
    }
}

// 4. Update UI Buttons (Filters)
document.querySelectorAll('.planner-filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.planner-filter-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-teal-500', 'text-teal-600', 'dark:text-teal-400');
            b.classList.add('text-gray-500');
        });
        e.target.classList.add('ring-2', 'ring-teal-500', 'text-teal-600', 'dark:text-teal-400');
        e.target.classList.remove('text-gray-500');
        
        renderPlannerList(e.target.dataset.filter);
    });
});

// 5. Replace existing Shop List Button Logic
if (generateShoppingListBtn) {
    // Remove old listeners (by cloning node if needed, but simple reassignment is easier if not named function)
    // Since we added an anonymous function before, let's just override or use a new ID if possible. 
    // Best practice: Cloning the node to strip listeners
    const newBtn = generateShoppingListBtn.cloneNode(true);
    generateShoppingListBtn.parentNode.replaceChild(newBtn, generateShoppingListBtn);
    
    newBtn.addEventListener('click', () => {
        if (selectedRecipeIds.size === 0) return showNotification("Select recipes first!", "error");
        
        aggregateShoppingList();
        
        // Reset UI to Planning Mode
        shoppingModeActive = false;
        document.getElementById('shopping-planner-modal').classList.remove('hidden');
        document.getElementById('shopping-planner-modal').classList.add('flex');
        
        // Populate Sidebar
        const recipeListEl = document.getElementById('planner-recipe-list');
        recipeListEl.innerHTML = '';
        selectedRecipeIds.forEach(id => {
            const r = recipesCache.find(rec => rec.id === id);
            if(r) recipeListEl.innerHTML += `<li class="truncate">â€¢ ${r.name}</li>`;
        });

        // Set Filter to All
        document.querySelector('[data-filter="all"]').click();
        
        // Reset Header & Footer
        document.getElementById('planner-title').textContent = "Shopping List Planner";
        document.getElementById('planner-subtitle').textContent = `Ingredients for ${selectedRecipeIds.size} recipes`;
        document.getElementById('planner-toolbar').classList.remove('hidden');
        document.getElementById('planner-sidebar').classList.remove('hidden');
        document.getElementById('start-shopping-mode-btn').classList.remove('hidden');
    });
}

// 6. Start Shopping Mode Button
document.getElementById('start-shopping-mode-btn').addEventListener('click', () => {
    shoppingModeActive = true;
    
    // Switch UI
    document.getElementById('planner-title').textContent = "In Store Mode";
    document.getElementById('planner-subtitle').textContent = "Tap items as you put them in the basket";
    
    // Hide Planning elements
    document.getElementById('planner-toolbar').classList.add('hidden'); // No filters, just show 'Need'
    document.getElementById('planner-sidebar').classList.add('hidden'); // Hide recipe list for more space
    document.getElementById('start-shopping-mode-btn').classList.add('hidden'); // Hide self
    
    renderPlannerList('need'); // Show only items marked as 'need'
});

// 7. Copy Text
document.getElementById('copy-text-btn').addEventListener('click', () => {
    const itemsToBuy = shoppingListItems.filter(i => i.status === 'need');
    if (itemsToBuy.length === 0) return showNotification("Nothing to buy!", "info");
    
    const text = "Shopping List:\n\n" + itemsToBuy.map(i => {
        return `- ${i.name.toUpperCase()} ${i.count > 1 ? `(x${i.count})` : ''}`;
    }).join('\n');
    
    navigator.clipboard.writeText(text);
    showNotification("Shopping list copied!");
});

// Close Modal
document.getElementById('close-planner-btn').addEventListener('click', () => {
    document.getElementById('shopping-planner-modal').classList.add('hidden');
    document.getElementById('shopping-planner-modal').classList.remove('flex');
});

            if (addRecipeBtn) addRecipeBtn.addEventListener('click', handleAddOrUpdateRecipe);
            if (searchBar) searchBar.addEventListener('input', filterRecipes);
            if (filterRating) filterRating.addEventListener('change', filterRecipes);
            
            const clearFilters = document.getElementById('clear-filters-btn');
            if (clearFilters) {
                clearFilters.addEventListener('click', () => {
                    if(searchBar) searchBar.value = '';
                    if(filterRating) filterRating.value = '0';
                    document.querySelectorAll('#filter-container input[type="checkbox"]').forEach(cb => cb.checked = false);
                    filterRecipes();
                });
            } // <--- This } closes the IF statement. It was missing.

        }); // <--- This closes the DOMContentLoaded listener.
    </script>
</body>
</html>