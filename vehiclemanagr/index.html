<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VehicleManagr</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1f2937; --text-muted: #6b7280;
            --border-light: #e5e7eb; --primary: #3b82f6; --primary-hover: #2563eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 0.75rem;
        }
        .dark-mode {
            --bg-body: #111827; --bg-card: #1f2937; --text-main: #f9fafb; --text-muted: #9ca3af;
            --border-light: #374151; --primary: #60a5fa; --primary-hover: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; transition: 0.3s; padding-bottom: 80px; }
        .card { background-color: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-light); }
        
        input, select, textarea {
            background-color: var(--bg-body); border: 1px solid var(--border-light); color: var(--text-main);
            border-radius: 0.5rem; padding: 0.625rem; width: 100%; transition: 0.2s; outline: none;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        input:disabled, select:disabled { opacity: 0.6; cursor: not-allowed; background-color: rgba(0,0,0,0.05); }

        .btn { padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; position: relative; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-secondary { background-color: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-light); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--border-light); }

        /* Update/Ensure these fit the new header */
    .vehicle-pill { padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: 999px; border: 1px solid var(--border-light); white-space: nowrap; cursor: pointer; transition: 0.2s; }
    .vehicle-pill.active { background-color: var(--primary); color: white; border-color: var(--primary); }
    .vehicle-pill:hover:not(.active) { background-color: var(--border-light); }

        .loader { width: 1rem; height: 1rem; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: none; animation: spin 0.6s linear infinite; }
        .btn.loading .loader { display: block; }
        .btn.loading span { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Replace existing .tab-btn styles with this: */
    .nav-tab { 
        padding: 0.5rem 0.75rem; 
        border-radius: 0.5rem; 
        transition: all 0.2s; 
        font-weight: 600; 
        color: #9ca3af; 
        text-decoration: none; 
        display: inline-flex; 
        align-items: center;
        cursor: pointer;
        font-size: 0.85rem;
    }
    .nav-tab:hover { color: var(--text-main); background: rgba(0,0,0,0.05); }
    .dark-mode .nav-tab:hover { background: rgba(255,255,255,0.05); }
    .nav-tab.active { color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        
        .tyre-container { position: relative; width: 140px; height: 180px; margin: 0 auto; background: var(--bg-body); border-radius: 20px; border: 2px solid var(--border-light); }
        .tyre-input { position: absolute; width: 50px !important; text-align: center; font-weight: bold; padding: 4px !important; font-size: 0.8rem; z-index: 10; }
        .tyre-fl { top: 20px; left: -20px; } .tyre-fr { top: 20px; right: -20px; }
        .tyre-rl { bottom: 20px; left: -20px; } .tyre-rr { bottom: 20px; right: -20px; }
        .axle { position: absolute; width: 80%; height: 4px; background: var(--border-light); left: 10%; }
        .axle-front { top: 35px; } .axle-rear { bottom: 35px; }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .fab-container { position: fixed; bottom: 24px; right: 24px; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .fab-main { width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: transform 0.3s; border: none; }
        .fab-mini { width: 48px; height: 48px; border-radius: 50%; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: none; border: none; }
        .fab-container.open .fab-main { transform: rotate(45deg); }
        .fab-container.open .fab-mini { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .edit-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .edit-full-width { grid-column: span 2; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="auth-container" class="card max-w-md w-full p-8 text-center fade-in">
        <div class="mb-6 bg-blue-100 dark:bg-blue-900 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-blue-600 dark:text-blue-300 text-2xl">
            <i class="fa-solid fa-car-burst"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2">VehicleManagr</h1>
        <p class="text-gray-500 mb-6">Fleet management made simple.</p>
        <div class="space-y-4 text-left">
            <div><label class="text-xs font-bold uppercase text-gray-500">Email</label><input id="email" type="email" placeholder="driver@example.com" /></div>
            <div><label class="text-xs font-bold uppercase text-gray-500">Password</label><input id="password" type="password" placeholder="••••••••" /></div>
            <div class="flex gap-3 mt-4">
                <button id="sign-in-btn" class="btn btn-primary flex-1"><span>Log In</span><div class="loader"></div></button>
                <button id="sign-up-btn" class="btn btn-secondary flex-1"><span>Sign Up</span><div class="loader"></div></button>
            </div>
        </div>
    </div>
    <div id="main-app-container" class="hidden w-full fade-in pb-10">
    
    <header class="sticky top-0 bg-[var(--bg-card)] border-b border-[var(--border-light)] shadow-sm z-30 shrink-0 mb-6 transition-colors duration-300">
        
        <div class="max-w-5xl mx-auto px-4 py-2">
            <div class="flex items-center justify-between gap-4">
                
                <div class="flex items-center gap-3 shrink-0">
                    <a href="../index.html" class="btn btn-primary text-xs font-bold py-1.5 px-3 rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-1">
                        <i class="fa-solid fa-arrow-left"></i> Hub
                    </a>
                    <div class="flex items-center gap-2 hidden sm:flex">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fa-solid fa-car-tunnel"></i>
                        </div>
                        <span class="font-bold text-lg tracking-tight">VehicleManagr</span>
                    </div>
                </div>

                <nav class="flex space-x-1 bg-gray-100 dark:bg-gray-800/50 p-1 rounded-lg overflow-x-auto scrollbar-hide mask-linear">
                    <button class="nav-tab active" data-tab="dashboard"><i class="fa-solid fa-house mr-1"></i> Dashboard</button>
                    <button class="nav-tab" data-tab="log"><i class="fa-solid fa-pen-to-square mr-1"></i> Log</button>
                    <button class="nav-tab" data-tab="history"><i class="fa-solid fa-clock-rotate-left mr-1"></i> History</button>
                    <button class="nav-tab" data-tab="trips"><i class="fa-solid fa-route mr-1"></i> Trips</button>
                    <button class="nav-tab" data-tab="settings"><i class="fa-solid fa-gear mr-1"></i> Settings</button>
                </nav>

                <div class="flex items-center gap-2 shrink-0">
                    <div class="w-24 sm:w-32 md:w-40 overflow-hidden flex items-center justify-end">
                        <div id="vehicle-list-container" class="flex items-center gap-2 overflow-x-auto scrollbar-hide px-1 justify-end">
                            <div class="text-xs text-gray-400">Loading...</div>
                        </div>
                    </div>
                    <div class="h-5 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
                    <button id="toggle-archive-view" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition text-gray-500 dark:text-gray-400" title="Show Archived"><i class="fa-solid fa-box-archive"></i></button>
                    <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition text-gray-500 dark:text-gray-400"><i class="fa-solid fa-sun sun-icon hidden"></i><i class="fa-solid fa-moon moon-icon"></i></button>
                    <button id="logout-btn" class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 transition"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4">
        
        <div id="tab-content-dashboard" class="tab-content active space-y-6">
            <div id="reminders-container" class="hidden bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 flex items-start gap-3 animate-pulse">
                <i class="fa-solid fa-triangle-exclamation text-yellow-600 dark:text-yellow-400 mt-1"></i>
                <div>
                    <h4 class="font-bold text-yellow-800 dark:text-yellow-200 text-sm">Action Required</h4>
                    <p id="reminder-text" class="text-sm text-yellow-700 dark:text-yellow-300 mt-1"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="card p-5 border-l-4 border-green-500 md:col-span-1 relative overflow-hidden group">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-xs font-bold uppercase text-gray-500 mb-1">Total Lifecycle Cost</p>
                            <h2 id="total-cost-display" class="text-3xl font-bold tracking-tight text-gray-800 dark:text-white">--</h2>
                        </div>
                        <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600">
                            <i class="fa-solid fa-sterling-sign text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2">
                        <input type="checkbox" id="include-purchase-toggle" class="w-4 h-4 text-green-600 rounded cursor-pointer">
                        <label for="include-purchase-toggle" class="text-xs font-medium text-gray-500 cursor-pointer select-none">Include Purchase Price</label>
                    </div>
                </div>

                <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div class="card p-4 flex flex-col justify-center border-b-4 border-purple-500">
                        <p class="text-[10px] font-bold uppercase text-gray-400">Cost / Mile</p>
                        <div class="text-xl font-bold text-gray-700 dark:text-gray-200 mt-1" id="cost-mile-display">--</div>
                    </div>
                    <div class="card p-4 flex flex-col justify-center border-b-4 border-red-500">
                        <p class="text-[10px] font-bold uppercase text-gray-400">Daily Cost</p>
                        <div class="text-xl font-bold text-gray-700 dark:text-gray-200 mt-1" id="stat-daily-cost">--</div>
                    </div>
                    <div class="card p-4 flex flex-col justify-center border-b-4 border-blue-500">
                        <p class="text-[10px] font-bold uppercase text-gray-400">Avg MPG</p>
                        <div class="text-xl font-bold text-gray-700 dark:text-gray-200 mt-1" id="avg-mpg-display">--</div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold uppercase text-gray-400 mb-3 ml-1">Vehicle Health</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-3" id="compliance-container">
                        </div>

                    <div class="lg:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-3" id="consumables-status-container">
                        </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-5 border-t-4 border-pink-500">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200">Tyre Status</h3>
                        <div id="maintenance-badges" class="flex gap-1"></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <p class="text-xs text-gray-500 mb-1">Tread Prediction</p>
                            <h2 id="tread-prediction" class="text-lg font-bold">Calculating...</h2>
                        </div>
                        <div class="bg-pink-50 dark:bg-pink-900/20 p-3 rounded-full text-pink-500">
                            <i class="fa-solid fa-road"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-5 border-t-4 border-cyan-500 flex flex-col justify-center">
                    <div class="grid grid-cols-3 gap-2 text-center sm:text-left">
                        
                        <div>
                            <p class="text-[10px] font-bold uppercase text-gray-400 truncate">Miles Driven</p>
                            <div class="flex flex-col sm:flex-row items-baseline gap-0.5 sm:gap-1 mt-1">
                                <span class="text-lg sm:text-xl font-bold" id="stat-miles-owned">--</span>
                                <span class="text-[10px] text-gray-500 hidden sm:inline">total</span>
                            </div>
                        </div>

                        <div class="sm:border-l sm:pl-3 border-gray-100 dark:border-gray-700">
                            <p class="text-[10px] font-bold uppercase text-gray-400 truncate">Real Range</p>
                            <div class="flex flex-col sm:flex-row items-baseline gap-0.5 sm:gap-1 mt-1">
                                <span class="text-lg sm:text-xl font-bold" id="stat-range">--</span>
                                <span class="text-[10px] text-gray-500 hidden sm:inline">mi</span>
                            </div>
                        </div>

                        <div class="sm:border-l sm:pl-3 border-gray-100 dark:border-gray-700">
                            <p class="text-[10px] font-bold uppercase text-gray-400 truncate">Proj. Annual</p>
                            <div class="flex flex-col sm:flex-row items-baseline gap-0.5 sm:gap-1 mt-1">
                                <span class="text-lg sm:text-xl font-bold" id="stat-projection">--</span>
                                <span class="text-[10px] text-gray-500 hidden sm:inline">mi</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="font-bold mb-4 text-sm uppercase text-gray-500">Fuel Efficiency Trend</h3>
                    <div class="h-64 relative"><canvas id="mpg-chart"></canvas></div>
                </div>
                <div class="card p-6">
                    <h3 class="font-bold mb-4 text-sm uppercase text-gray-500">Monthly Spending</h3>
                    <div class="h-64 relative"><canvas id="cost-breakdown-chart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="tab-content-log" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <div id="card-fuel" class="card p-6 border-t-4 border-blue-500">
    <div class="flex items-center gap-2 mb-4 text-blue-600 font-bold text-lg"><i class="fa-solid fa-gas-pump"></i> Fuel Log</div>
    <div class="space-y-3">
        <div class="flex gap-2">
    <input id="fuel-date" type="date" class="flex-grow" />
    <input id="fuel-time" type="time" class="w-24" />
</div>
        
        <input id="fuel-driver" type="text" placeholder="Driver Name (Optional)" />

        <div class="relative"><i class="fa-solid fa-road absolute left-3 top-3.5 text-gray-400 text-xs"></i><input id="odometer" type="number" placeholder="Odometer (Total)" class="pl-8" /></div>
        
        <div class="grid grid-cols-2 gap-2">
            <input id="fuel-quantity" type="number" step="0.01" placeholder="Volume (L/Gal)" />
            <input id="fuel-cost" type="number" step="0.01" placeholder="Total Cost (£)" />
        </div>
        
        <div class="grid grid-cols-2 gap-2">
    <div class="relative">
        <span class="absolute left-3 top-3 text-gray-400 text-[10px] font-bold">@</span>
        <input id="fuel-price-unit" type="number" step="0.001" placeholder="Auto Calc" class="pl-8 text-sm" disabled />
    </div>
    <div class="relative">
        <span class="absolute left-3 top-3 text-gray-400 text-[10px] font-bold">@</span>
        <input id="fuel-price-standard" type="number" step="0.001" placeholder="Std Price" class="pl-8 text-sm" />
    </div>
</div>
<div class="text-[9px] text-gray-400 mt-0.5 text-right mb-2">Left: Paid/L (Auto) | Right: Standard/L (Enter to check Loyalty)</div>

        <div class="grid grid-cols-2 gap-2">
            <input id="fuel-company" type="text" placeholder="Company (Req)*" class="border-l-2 border-l-blue-500" />
            <input id="fuel-location" type="text" placeholder="Venue (Opt)" />
        </div>

        <select id="fuel-type" class="text-sm">
            <option value="Petrol">Petrol (Regular/E10)</option>
            <option value="Premium Petrol">Premium Petrol (Super/E5)</option>
            <option value="Diesel">Diesel</option>
            <option value="Premium Diesel">Premium Diesel</option>
            <option value="Electric">Electric</option>
            <option value="LPG">LPG</option>
            <option value="AdBlue">AdBlue</option>
        </select>

        <select id="fuel-payment" class="text-sm text-gray-600">
            <option value="Card">Debit/Credit Card</option>
            <option value="Cash">Cash</option>
            <option value="Corporate">Corporate Card</option>
        </select>
        
        <select id="fuel-context" class="text-sm">
            <option value="Mixed">Mixed Driving</option>
            <option value="City">Mostly City / Traffic</option>
            <option value="Highway">Mostly Highway</option>
            <option value="Sport">Sport / Heavy Foot</option>
        </select>
        
        <div class="flex flex-wrap items-center gap-3 bg-gray-50 dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-2">
                <input type="checkbox" id="fuel-partial" class="w-4 h-4 text-blue-600 rounded !w-auto" />
                <label for="fuel-partial" class="text-xs cursor-pointer select-none">Partial Fill</label>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="fuel-loyalty" class="w-4 h-4 text-green-600 rounded !w-auto" />
                <label for="fuel-loyalty" class="text-xs cursor-pointer select-none text-green-600 font-bold">Loyalty Used</label>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="fuel-estimate" class="w-4 h-4 text-yellow-600 rounded !w-auto" />
                <label for="fuel-estimate" class="text-xs cursor-pointer select-none text-yellow-600">Vol. Est.</label>
            </div>
        </div>

        <div class="text-xs text-gray-500 font-bold uppercase mt-2">Receipt (Optional)</div>
        <input type="file" id="fuel-receipt" accept="image/*" class="text-xs" />
        <button id="log-fuel-btn" class="btn btn-primary w-full"><span>Save Entry</span><div class="loader"></div></button>
    </div>
</div>

                <div id="card-service" class="card p-6 border-t-4 border-orange-500">
                    <div class="flex items-center gap-2 mb-4 text-orange-600 font-bold text-lg"><i class="fa-solid fa-screwdriver-wrench"></i> Service</div>
                    <div class="space-y-3">
                        <div class="flex gap-2">
    <input id="service-date" type="date" class="flex-grow" />
    <input id="service-time" type="time" class="w-24" />
</div>
                        <input id="service-odometer" type="number" placeholder="Odometer" />
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input id="service-company" type="text" placeholder="Provider (Req)*" class="border-l-2 border-l-orange-500" />
                            <input id="service-location" type="text" placeholder="Venue (Opt)" />
                        </div>

                        <select id="service-type">
                            <option value="Maintenance">Routine Maintenance</option>
                            <option value="Oil Change">Oil & Filter Change</option>
                            <option value="Repair">Repair</option>
                            <option value="MOT">MOT / Inspection</option>
                            <option value="Tyres">New Tyres</option>
                            <option value="Brake Fluid">Brake Fluid Flush</option>
                        </select>
                        <div class="relative"><span class="absolute left-3 top-3 text-gray-400">£</span><input id="service-cost" type="number" step="0.01" placeholder="0.00" class="pl-7" /></div>
                        
                        <select id="service-payment" class="text-sm text-gray-600">
                            <option value="Card">Debit/Credit Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Corporate">Corporate Card</option>
                        </select>

                        <textarea id="service-notes" placeholder="Describe work done..." rows="2"></textarea>
                        <div class="text-xs text-gray-500 font-bold uppercase mt-2">Document / Receipt</div>
                        <input type="file" id="service-receipt" accept="image/*,application/pdf" class="text-xs" />
                        <button id="log-service-btn" class="btn btn-primary w-full bg-orange-600 hover:bg-orange-700"><span>Save Entry</span><div class="loader"></div></button>
                    </div>
                </div>

                <div id="card-consumables" class="card p-6 border-t-4 border-teal-500">
                    <div class="flex items-center gap-2 mb-4 text-teal-600 font-bold text-lg"><i class="fa-solid fa-spray-can-sparkles"></i> Consumables</div>
                    <div class="space-y-3">
                        <div class="flex gap-2">
    <input id="consumable-date" type="date" class="flex-grow" />
    <input id="consumable-time" type="time" class="w-24" />
</div>
                        <select id="consumable-type">
                            <option value="Air Freshener">Air Freshener</option>
                            <option value="Wiper Blades">Wiper Blades</option>
                            <option value="Cabin Filter">Cabin Air Filter</option>
                            <option value="Light Bulb">Light Bulb</option>
                            <option value="Car Wash">Car Wash / Detail</option>
                        </select>
                        <div class="relative"><span class="absolute left-3 top-3 text-gray-400">£</span><input id="consumable-cost" type="number" step="0.01" placeholder="0.00" class="pl-7" /></div>
                        <input id="consumable-notes" type="text" placeholder="Brand / Store / Details" />
                        <button id="log-consumable-btn" class="btn btn-primary w-full bg-teal-600 hover:bg-teal-700"><span>Save Update</span><div class="loader"></div></button>
                    </div>
                </div>

                <div id="card-expense" class="card p-6 border-t-4 border-green-500">
                    <div class="flex items-center gap-2 mb-4 text-green-600 font-bold text-lg"><i class="fa-solid fa-receipt"></i> Expense</div>
                    <div class="space-y-3">
                        <div class="flex gap-2">
    <input id="expense-date" type="date" class="flex-grow" />
    <input id="expense-time" type="time" class="w-24" />
</div>
                        <select id="expense-category">
                            <option value="Road Tax">Road Tax</option>
                            <option value="Car Insurance">Car Insurance</option>
                            <option value="Breakdown Cover">Breakdown Cover</option>
                            <option value="Toll/Parking">Toll / Parking</option>
                            <option value="Fine">Fine / Penalty</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Other">Other</option>
                        </select>

                        <div class="grid grid-cols-2 gap-2">
                            <input id="expense-company" type="text" placeholder="Payee (Req)*" class="border-l-2 border-l-green-500" />
                            <input id="expense-location" type="text" placeholder="Venue (Opt)" />
                        </div>

                        <div class="relative"><span class="absolute left-3 top-3 text-gray-400">£</span><input id="expense-cost" type="number" step="0.01" placeholder="0.00" class="pl-7" /></div>
                        
                        <select id="expense-payment" class="text-sm text-gray-600">
                            <option value="Card">Debit/Credit Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Corporate">Corporate Card</option>
                        </select>

                        <div class="text-xs text-gray-500 font-bold uppercase mt-2">Proof of Purchase</div>
                        <input type="file" id="expense-receipt" accept="image/*" class="text-xs" />
                        <button id="log-expense-btn" class="btn btn-primary w-full bg-green-600 hover:bg-green-700"><span>Save Entry</span><div class="loader"></div></button>
                    </div>
                </div>

                <div class="card p-6 border-t-4 border-purple-500">
                    <div class="flex items-center gap-2 mb-4 text-purple-600 font-bold text-lg"><i class="fa-solid fa-heart-pulse"></i> Health & Tyres</div>
                    <div class="space-y-4">
                        <div class="flex gap-2">
    <input id="health-date" type="date" class="flex-grow" />
    <input id="health-time" type="time" class="w-24" />
</div>
                        <div class="flex gap-3">
                            <div class="flex-1 p-3 border rounded-lg flex items-center gap-2 cursor-pointer hover:bg-gray-50 transition" onclick="document.getElementById('check-washer').click()">
                                <input type="checkbox" id="check-washer" class="w-4 h-4" />
                                <div class="text-xs font-bold uppercase text-gray-500">Washer Fluid</div>
                            </div>
                            <div class="flex-1 p-3 border rounded-lg flex items-center gap-2 cursor-pointer hover:bg-gray-50 transition" onclick="document.getElementById('check-air').click()">
                                <input type="checkbox" id="check-air" class="w-4 h-4" />
                                <div class="text-xs font-bold uppercase text-gray-500">Tyre Air</div>
                            </div>
                        </div>
                        <div class="text-xs font-bold text-center text-gray-400 uppercase tracking-wide mb-2">Pressure (PSI) & Tread (mm)</div>
                        <div class="tyre-container" style="height: 220px;">
                            <input id="tyre-fl" type="number" class="tyre-input tyre-fl pressure-input" placeholder="PSI" />
                            <input id="tyre-fr" type="number" class="tyre-input tyre-fr pressure-input" placeholder="PSI" />
                            <input id="tyre-rl" type="number" class="tyre-input tyre-rl pressure-input" placeholder="PSI" />
                            <input id="tyre-rr" type="number" class="tyre-input tyre-rr pressure-input" placeholder="PSI" />
                            <input id="tread-fl" type="number" step="0.1" class="tyre-input" style="top: 50px; left: -20px; font-size: 0.7rem; opacity: 0.8;" placeholder="mm" />
                            <input id="tread-fr" type="number" step="0.1" class="tyre-input" style="top: 50px; right: -20px; font-size: 0.7rem; opacity: 0.8;" placeholder="mm" />
                            <input id="tread-rl" type="number" step="0.1" class="tyre-input" style="bottom: 50px; left: -20px; font-size: 0.7rem; opacity: 0.8;" placeholder="mm" />
                            <input id="tread-rr" type="number" step="0.1" class="tyre-input" style="bottom: 50px; right: -20px; font-size: 0.7rem; opacity: 0.8;" placeholder="mm" />
                            <div class="axle axle-front"></div>
                            <div class="axle axle-rear"></div>
                        </div>
                        <textarea id="health-notes" placeholder="General condition..." rows="2"></textarea>
                        <button id="log-health-btn" class="btn btn-primary w-full bg-purple-600 hover:bg-purple-700"><span>Save Check</span><div class="loader"></div></button>
                    </div>
                </div>

            </div>
        </div>

        <div id="tab-content-trips" class="tab-content hidden space-y-6">
            <div id="card-trip" class="card p-6 border-l-4 border-cyan-500">
                <h3 class="font-bold mb-4 text-lg">Log a Trip</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex gap-2">
    <input id="trip-date" type="date" class="flex-grow" />
    <input id="trip-time" type="time" class="w-24" />
</div>
                    <select id="trip-type"><option value="Business">Business</option><option value="Personal">Personal</option><option value="Commute">Commute</option></select>
                    <input id="trip-from" type="text" placeholder="Start Location" />
                    <input id="trip-to" type="text" placeholder="End Location" />
                    <div class="relative"><i class="fa-solid fa-road absolute left-3 top-3.5 text-gray-400 text-xs"></i><input id="trip-miles" type="number" step="0.1" placeholder="Distance (Miles)" class="pl-8" /></div>
                </div>
                <button id="log-trip-btn" class="btn btn-primary w-full bg-cyan-600 hover:bg-cyan-700"><span>Save Trip</span><div class="loader"></div></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="card p-4">
                    <p class="text-xs font-bold uppercase text-gray-500">Business Miles</p>
                    <h2 id="stats-biz-miles" class="text-2xl font-bold mt-1">0</h2>
                </div>
                <div class="card p-4">
                    <p class="text-xs font-bold uppercase text-gray-500">Total Trips</p>
                    <h2 id="stats-total-trips" class="text-2xl font-bold mt-1">0</h2>
                </div>
            </div>
        </div>
        <div id="tab-content-history" class="tab-content hidden">
            <div class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                    <h2 class="font-bold text-lg">Activity Log</h2>
                    <input type="text" id="history-search" placeholder="Search logs..." class="max-w-xs text-sm" />
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 dark:bg-gray-800 text-gray-500 uppercase font-bold text-xs">
                            <tr id="history-table-header"></tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-content-settings" class="tab-content hidden space-y-6">
            
            <div class="card p-6">
                <h3 class="font-bold text-lg mb-4 border-b pb-2 border-gray-100 dark:border-gray-700">My Vehicles</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-500">Rename Current Vehicle</label>
                        <div class="flex gap-2 mt-1">
                            <input id="rename-vehicle-input" type="text" />
                            <button id="rename-vehicle-btn" class="btn btn-secondary whitespace-nowrap">Rename</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-500">Add New Vehicle</label>
                        <div class="flex gap-2 mt-1">
                            <input id="new-vehicle-name" type="text" placeholder="e.g. Mazda MX-5" />
                            <button id="add-vehicle-btn" class="btn btn-primary">Add</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-bold text-lg">
                        <i class="fa-solid fa-box-archive"></i> Virtual Glovebox
                    </div>
                    <button id="toggle-glovebox-btn" class="text-sm text-blue-500 font-semibold hover:text-blue-700"><i class="fa-solid fa-lock mr-1"></i> Unlock to Edit</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="glovebox-form">
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-500">VIN / Chassis No.</label>
                        <input id="meta-vin" type="text" placeholder="WBA..." class="uppercase" disabled />
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-500">License Plate</label>
                        <input id="meta-plate" type="text" class="uppercase font-mono" placeholder="AB12 CDE" disabled />
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-500">Oil Type</label>
                        <input id="meta-oil" type="text" placeholder="e.g. 5W-30 Synthetic" disabled />
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-500">Tyre Size</label>
                        <input id="meta-tyres" type="text" placeholder="e.g. 225/45 R17" disabled />
                    </div>

                    <div class="col-span-1 md:col-span-2 mt-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                        <label class="text-xs font-bold uppercase text-red-500 mb-2 block">Legal Expiry Dates</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">MOT Due</label>
                                <input id="meta-mot" type="date" disabled />
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">Road Tax Due</label>
                                <input id="meta-tax" type="date" disabled />
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">Insurance Due</label>
                                <input id="meta-ins" type="date" disabled />
                            </div>
                        </div>
                    </div>

                    <div class="col-span-1 md:col-span-2 mt-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                        <label class="text-xs font-bold uppercase text-indigo-500 mb-2 block">Purchase Info (For Stats)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">Purchase Price (£)</label>
                                <input id="meta-price" type="number" placeholder="e.g. 15000" disabled />
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">Purchase Date</label>
                                <input id="meta-date" type="date" disabled />
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">Tank Size (Gal)</label>
                                <input id="meta-tank" type="number" step="0.1" placeholder="e.g. 12.5" disabled />
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400">Start Mileage</label>
                                <input id="meta-start-odo" type="number" placeholder="Mileage at purchase" disabled />
                            </div>
                        </div>
                    </div>
                </div>
                <button id="save-metadata-btn" class="btn btn-primary mt-4 w-full bg-indigo-600 hover:bg-indigo-700 hidden"><span>Save Changes</span><div class="loader"></div></button>
            </div>

            <div class="card p-6">
                <h3 class="font-bold text-lg mb-4">Data Management</h3>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button id="export-json-btn" class="btn btn-secondary"><i class="fa-solid fa-file-code"></i> JSON Backup</button>
                    <button id="export-csv-btn" class="btn btn-secondary"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                </div>
                <div class="border-t pt-4">
                    <label class="btn btn-secondary cursor-pointer w-full text-center block">
                        <i class="fa-solid fa-file-import mr-2"></i> Import CSV Data
                        <input type="file" id="import-csv" class="hidden" accept=".csv">
                    </label>
                    <p class="text-xs text-gray-400 mt-2 text-center">CSV must have headers: Date, Type, Cost, Odometer</p>
                </div>
            </div>

            <div class="card p-6 border-red-100 dark:border-red-900/30 border">
                <h3 class="font-bold text-lg mb-4 text-red-600">Danger Zone</h3>
                
                <div class="flex flex-col space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">Archive Vehicle</p>
                            <p class="text-xs text-gray-500">Hide from main list but keep data.</p>
                        </div>
                        <button id="archive-vehicle-btn" class="btn btn-secondary text-orange-600 border-orange-200 hover:bg-orange-50"><span>Archive</span><div class="loader"></div></button>
                    </div>

                    <div class="h-px bg-gray-100 dark:bg-gray-800"></div>

                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">Delete Vehicle</p>
                            <p class="text-xs text-gray-500">Permanently remove vehicle and history.</p>
                        </div>
                        <button id="delete-vehicle-btn" class="btn btn-danger"><span>Delete</span><div class="loader"></div></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="fab-container" class="fab-container hidden">
        <button class="fab-mini bg-purple-500" onclick="window.quickLog('health')"><i class="fa-solid fa-heart-pulse"></i></button>
        <button class="fab-mini bg-cyan-500" onclick="window.quickLog('trip')"><i class="fa-solid fa-route"></i></button>
        <button class="fab-mini bg-teal-500" onclick="window.quickLog('consumables')"><i class="fa-solid fa-spray-can-sparkles"></i></button>
        <button class="fab-mini bg-orange-500" onclick="window.quickLog('service')"><i class="fa-solid fa-screwdriver-wrench"></i></button>
        <button class="fab-mini bg-blue-500" onclick="window.quickLog('fuel')"><i class="fa-solid fa-gas-pump"></i></button>
        <button id="fab-main" class="fab-main"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div id="message-box" class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-semibold transition-all duration-300 opacity-0 pointer-events-none z-[100]"></div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[60] backdrop-blur-sm overflow-y-auto py-10">
        <div class="card p-6 w-full max-w-lg mx-4 shadow-2xl animate-scaleIn my-auto">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-pen-to-square"></i> Edit Entry</h2>
                <button class="close-btn text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
            </div>
            <div id="edit-modal-content" class="mb-6 space-y-3"></div>
            <div class="flex gap-3 pt-2 border-t border-gray-100 dark:border-gray-700">
                <button id="modal-delete-btn" class="btn btn-danger flex-1"><span>Delete</span><div class="loader"></div></button>
                <button id="modal-save-btn" class="btn btn-primary flex-1"><span>Save Changes</span><div class="loader"></div></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp, doc, deleteDoc, setDoc, getDocs, query, orderBy, onSnapshot, writeBatch, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const app = initializeApp({ apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8", authDomain: "sammy-7298f.firebaseapp.com", projectId: "sammy-7298f", storageBucket: "sammy-7298f.firebasestorage.app", messagingSenderId: "963185683535", appId: "1:963185683535:web:807df8941feba46c208e3a" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const appState = { user: null, vehicles: [], currentVehicleId: null, history: [], vehicleData: {}, charts: { mpg: null, cost: null }, modalId: null, listeners: [], showArchived: false };
        const ui = { body: document.body, vehicleContainer: document.getElementById('vehicle-list-container'), msgBox: document.getElementById('message-box') };

        const showMessage = (msg, type = "success") => {
            ui.msgBox.textContent = msg;
            ui.msgBox.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-semibold transition-all duration-300 z-[100] ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            ui.msgBox.style.opacity = '1'; ui.msgBox.style.top = '30px';
            setTimeout(() => { ui.msgBox.style.opacity = '0'; ui.msgBox.style.top = '5px'; }, 3000);
        };

        const setLoading = (btnId, isLoading) => {
            const btn = document.getElementById(btnId); if(!btn) return;
            if(isLoading) { btn.classList.add('loading'); btn.disabled = true; } 
            else { btn.classList.remove('loading'); btn.disabled = false; }
        };

        // Add this helper function near the top of your script (e.g., after 'const ui = ...')
const getTimestamp = (prefix) => {
    const d = document.getElementById(`${prefix}-date`).value;
    const t = document.getElementById(`${prefix}-time`).value;
    if(!d) return null;
    return `${d}T${t || '12:00'}`; // Default to 12:00 if time is empty
};

// REPLACE the setDefaults function
const setDefaults = () => {
    const now = new Date();
    const current = now.toISOString().slice(0, 10);
    
    ['fuel','service','expense','health','trip','consumable'].forEach(prefix => { 
        const el = document.getElementById(`${prefix}-date`); 
        if(el) {
            el.value = current;
            el.max = current;
        }
        // We leave the time field blank by default
    });
};

        const toggleTheme = () => {
            const isDark = ui.body.classList.toggle('dark-mode');
            document.querySelector('.sun-icon').classList.toggle('hidden', !isDark);
            document.querySelector('.moon-icon').classList.toggle('hidden', isDark);
            if(appState.user) setDoc(doc(db, 'users', appState.user.uid, 'settings', 'theme'), { theme: isDark ? 'dark' : 'light' }, { merge: true });
        };

        const uploadImage = async (file, type) => {
            if(!file) return null;
            const storageRef = ref(storage, `receipts/${appState.user.uid}/${appState.currentVehicleId}/${type}_${Date.now()}`);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        };

        const renderGlovebox = () => {
            if(!appState.currentVehicleId) return;
            const v = appState.vehicles.find(v => v.id === appState.currentVehicleId) || {};
            appState.vehicleData = v; 
            
            const renameInput = document.getElementById('rename-vehicle-input');
            if(renameInput) renameInput.value = v.name || "";

            const map = {
                'meta-vin': 'vin', 'meta-plate': 'plate', 'meta-oil': 'oil', 'meta-tyres': 'tyres',
                'meta-price': 'purchasePrice', 'meta-date': 'purchaseDate', 'meta-tank': 'tankSize', 'meta-start-odo': 'startOdometer',
                'meta-mot': 'motExpiry', 'meta-tax': 'taxExpiry', 'meta-ins': 'insuranceExpiry'
            };
            for(const [id, key] of Object.entries(map)) {
                const el = document.getElementById(id);
                if(el) el.value = v[key] || '';
            }
            lockGlovebox();
        };

        const lockGlovebox = () => {
            document.querySelectorAll('#glovebox-form input').forEach(i => i.disabled = true);
            document.getElementById('save-metadata-btn').classList.add('hidden');
            document.getElementById('toggle-glovebox-btn').innerHTML = '<i class="fa-solid fa-lock mr-1"></i> Unlock to Edit';
        };

        document.getElementById('toggle-glovebox-btn').onclick = () => {
            const isLocked = document.getElementById('meta-vin').disabled;
            if(isLocked) {
                document.querySelectorAll('#glovebox-form input').forEach(i => i.disabled = false);
                document.getElementById('save-metadata-btn').classList.remove('hidden');
                document.getElementById('toggle-glovebox-btn').innerHTML = '<i class="fa-solid fa-lock-open mr-1"></i> Cancel Edit';
            } else { renderGlovebox(); }
        };

        const saveMetadata = async () => {
            if(!appState.currentVehicleId) return showMessage("No vehicle selected", "error");
            setLoading('save-metadata-btn', true);
            try {
                const data = {
                    vin: document.getElementById('meta-vin').value,
                    plate: document.getElementById('meta-plate').value,
                    oil: document.getElementById('meta-oil').value,
                    tyres: document.getElementById('meta-tyres').value,
                    purchasePrice: parseFloat(document.getElementById('meta-price').value),
                    purchaseDate: document.getElementById('meta-date').value,
                    tankSize: parseFloat(document.getElementById('meta-tank').value),
                    startOdometer: parseFloat(document.getElementById('meta-start-odo').value),
                    motExpiry: document.getElementById('meta-mot').value,
                    taxExpiry: document.getElementById('meta-tax').value,
                    insuranceExpiry: document.getElementById('meta-ins').value,
                    datapointUpdatedBy: auth.currentUser.uid,
                    datapointUpdatedTime: serverTimestamp()
                };
                await setDoc(doc(db, `users/${appState.user.uid}/vehicles`, appState.currentVehicleId), data, { merge: true });
                showMessage("Glovebox Updated");
                lockGlovebox();
            } catch(e) { showMessage(e.message, "error"); }
            setLoading('save-metadata-btn', false);
        };

        const loadVehicles = async (uid) => {
            let q = query(collection(db, `users/${uid}/vehicles`), orderBy('createdAt', 'asc'));
            
            onSnapshot(q, async (snap) => {
                const allVehicles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                appState.vehicles = appState.showArchived 
                    ? allVehicles 
                    : allVehicles.filter(v => !v.isArchived);

                if (allVehicles.length === 0) { 
                    await addDoc(collection(db, `users/${uid}/vehicles`), { 
                        name: "My Car", 
                        createdAt: serverTimestamp(), 
                        isArchived: false,
                        uploadedBy: auth.currentUser.email,
                        uploadedApp: 'VehicleManagr'
                    }); 
                    return; 
                }

                const currentExists = appState.vehicles.find(v => v.id === appState.currentVehicleId);
                if (!appState.currentVehicleId || !currentExists) { 
                    if(appState.vehicles.length > 0) appState.currentVehicleId = appState.vehicles[0].id;
                    else appState.currentVehicleId = null;
                }

                ui.vehicleContainer.innerHTML = '';
                
                if(appState.vehicles.length === 0) {
                      ui.vehicleContainer.innerHTML = '<span class="text-xs text-gray-400 italic">No active vehicles.</span>';
                }

                appState.vehicles.forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = `vehicle-pill ${v.id === appState.currentVehicleId ? 'active' : ''} ${v.isArchived ? 'opacity-50 border-dashed' : ''}`;
                    btn.innerHTML = v.isArchived ? `<i class="fa-solid fa-box-archive mr-1"></i> ${v.name}` : v.name;
                    btn.onclick = () => { appState.currentVehicleId = v.id; loadVehicles(uid); };
                    ui.vehicleContainer.appendChild(btn);
                });
                
                const addBtn = document.createElement('button');
                addBtn.className = "w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center shrink-0 hover:bg-gray-300 transition text-sm";
                addBtn.innerHTML = "<i class='fa-solid fa-plus'></i>";
                addBtn.onclick = () => { document.querySelector('[data-tab="settings"]').click(); document.getElementById('new-vehicle-name').focus(); };
                ui.vehicleContainer.appendChild(addBtn);

                if(appState.currentVehicleId) {
                    loadHistory(uid, appState.currentVehicleId);
                    renderGlovebox();
                } else {
                    document.getElementById('total-cost-display').textContent = "--";
                    appState.history = [];
                    renderHistoryTable();
                }
            });
        };

        const handleRenameVehicle = async () => {
            const inputEl = document.getElementById('rename-vehicle-input');
            const newName = inputEl.value.trim();
            if (!appState.currentVehicleId) return showMessage("No vehicle selected to rename", "error");
            if (!newName) return showMessage("Please enter a valid name", "error");
            const currentVehicle = appState.vehicles.find(v => v.id === appState.currentVehicleId);
            if (currentVehicle && currentVehicle.name === newName) return showMessage("Name is unchanged", "error");

            setLoading('rename-vehicle-btn', true);
            try {
                await updateDoc(doc(db, `users/${appState.user.uid}/vehicles`, appState.currentVehicleId), { 
                    name: newName,
                    datapointUpdatedBy: auth.currentUser.uid,
                    datapointUpdatedTime: serverTimestamp()
                });
                showMessage("Vehicle Renamed");
            } catch(e) { showMessage(e.message, "error"); }
            setLoading('rename-vehicle-btn', false);
        };

        const handleAddVehicle = async () => {
            const name = document.getElementById('new-vehicle-name').value;
            if(!name) return showMessage("Enter a vehicle name", "error");
            setLoading('add-vehicle-btn', true);
            try { 
                await addDoc(collection(db, `users/${appState.user.uid}/vehicles`), { 
                    name, 
                    createdAt: serverTimestamp(), 
                    isArchived: false,
                    uploadedBy: auth.currentUser.email,
                    uploadedApp: 'VehicleManagr'
                }); 
                document.getElementById('new-vehicle-name').value = ''; 
                showMessage("Vehicle Added"); 
            } catch(e) { showMessage(e.message, "error"); }
            setLoading('add-vehicle-btn', false);
        };

        const handleArchiveVehicle = async () => {
            if(!appState.currentVehicleId) return;
            const v = appState.vehicles.find(v => v.id === appState.currentVehicleId);
            const action = v.isArchived ? "Unarchive" : "Archive";
            if(!confirm(`${action} ${v.name}?`)) return;

            setLoading('archive-vehicle-btn', true);
            try {
                await updateDoc(doc(db, `users/${appState.user.uid}/vehicles`, appState.currentVehicleId), { 
                    isArchived: !v.isArchived,
                    datapointUpdatedBy: auth.currentUser.uid,
                    datapointUpdatedTime: serverTimestamp()
                });
                showMessage(`Vehicle ${action}d`);
                if(!v.isArchived && !appState.showArchived) appState.currentVehicleId = null;
            } catch(e) { showMessage("Error: " + e.message, "error"); }
            setLoading('archive-vehicle-btn', false);
        };

        const handleDeleteVehicle = async () => {
            if(!confirm(`PERMANENTLY DELETE ${appState.vehicles.find(v=>v.id===appState.currentVehicleId).name} and ALL its data? This cannot be undone.`)) return;
            setLoading('delete-vehicle-btn', true);
            try {
                const historyRef = collection(db, `users/${appState.user.uid}/vehicles/${appState.currentVehicleId}/history`);
                const snapshot = await getDocs(historyRef);
                const batch = writeBatch(db);
                snapshot.docs.forEach((doc) => batch.delete(doc.ref));
                await batch.commit();
                await deleteDoc(doc(db, `users/${appState.user.uid}/vehicles`, appState.currentVehicleId));
                showMessage("Vehicle Deleted");
                appState.currentVehicleId = null;
            } catch(e) { showMessage("Error: " + e.message, "error"); }
            setLoading('delete-vehicle-btn', false);
        };

        const loadHistory = (uid, vid) => {
            appState.listeners.forEach(unsub => unsub()); appState.listeners = [];
            const q = query(collection(db, `users/${uid}/vehicles/${vid}/history`), orderBy('date', 'desc'));
            const unsub = onSnapshot(q, (snap) => {
                appState.history = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDashboard();
                renderHistoryTable();
            });
            appState.listeners.push(unsub);
        };

        const renderDashboard = () => {
            const history = appState.history;
            const v = appState.vehicleData || {};

            const getNum = (val) => { const n = parseFloat(val); return isNaN(n) ? 0 : n; };

            // 1. Prepare Valid Fuel Logs
            // We sort by Odometer to ensure the timeline is correct
            const fuelLogs = history
                .filter(d => (d.type === 'fuel-up' || d.type === 'fuel') && getNum(d.odometer) > 0)
                .sort((a,b) => getNum(a.odometer) - getNum(b.odometer));

            // 2. Financial Totals (Unchanged)
            const costs = { fuel: 0, service: 0, expense: 0, consumable: 0 };
            const validOdos = history.map(h => getNum(h.odometer)).filter(o => o > 0);
            const currentOdo = validOdos.length ? Math.max(...validOdos) : 0;
            const includePurchase = document.getElementById('include-purchase-toggle')?.checked || false;
            const purchaseCost = (includePurchase && v.purchasePrice) ? getNum(v.purchasePrice) : 0;

            history.forEach(d => {
                if(d.type === 'fuel-up') costs.fuel += getNum(d.fuelCost);
                if(d.type === 'service') costs.cost += getNum(d.cost);
                if(d.type === 'expense') costs.expense += getNum(d.expenseCost);
                if(d.type === 'consumable') costs.consumable += getNum(d.cost);
            });
            const totalSpent = costs.fuel + costs.service + costs.expense + costs.consumable + purchaseCost;
            document.getElementById('total-cost-display').textContent = `£${totalSpent.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // 3. LIFETIME MPG CALCULATION (UK GALLONS)
            let avgMpg = 0;
            let chartPts = [];
            const UK_GAL_CONVERSION = 4.54609; // Liters to UK Gallons

            if (fuelLogs.length > 0) {
                const firstLog = fuelLogs[0];
                const lastLog = fuelLogs[fuelLogs.length - 1];
                const startOdo = getNum(v.startOdometer);

                // A. Determine Distance
                // Use Glovebox mileage if it's valid and lower than the first log
                // Otherwise, use the first log as the start point.
                let effectiveStartOdo = (startOdo > 0 && startOdo < getNum(firstLog.odometer)) 
                                        ? startOdo 
                                        : getNum(firstLog.odometer);

                const totalDist = getNum(lastLog.odometer) - effectiveStartOdo;
                
                // B. Determine Fuel Used
                // If we used the Glovebox start, we include ALL fuel logs (because the first log replaced fuel used since purchase).
                // If we used the First Log start, we skip the first log (because that fuel replaced miles driven BEFORE tracking started).
                const startIndex = (effectiveStartOdo === startOdo) ? 0 : 1;
                const totalLiters = fuelLogs.slice(startIndex).reduce((acc, d) => acc + getNum(d.fuelQuantity), 0);
                
                // C. Convert to Gallons & Calculate
                const totalGallons = totalLiters / UK_GAL_CONVERSION;

                if (totalDist > 0 && totalGallons > 0) {
                    avgMpg = totalDist / totalGallons;
                }
                
                // Chart: Trend Line
                let runOdo = effectiveStartOdo;
                let runLiters = 0;
                fuelLogs.forEach(d => {
                    runLiters += getNum(d.fuelQuantity);
                    if(!d.isPartial) {
                         const dist = getNum(d.odometer) - runOdo;
                         // Calculate Segment MPG
                         const segmentGal = runLiters / UK_GAL_CONVERSION;
                         
                         if(dist > 0 && segmentGal > 0) {
                             chartPts.push({ x: new Date(d.date), y: (dist/segmentGal) });
                         }
                         runOdo = getNum(d.odometer);
                         runLiters = 0;
                    }
                });
            }
            
            // Display Result
            if(avgMpg === 0 && fuelLogs.length > 0) {
                 // Still 0? Probably missing volume data (Import Bug)
                 document.getElementById('avg-mpg-display').innerHTML = '<span class="text-xs text-red-500">Data Err</span>';
            } else {
                 document.getElementById('avg-mpg-display').textContent = avgMpg ? avgMpg.toFixed(1) : '--';
            }

            // 4. Cost Per Mile
            let minOdo = (fuelLogs.length > 0) ? getNum(fuelLogs[0].odometer) : 0;
            if(v.startOdometer && v.startOdometer < minOdo) minOdo = v.startOdometer;
            const totalDistOwned = (currentOdo - minOdo);
            document.getElementById('cost-mile-display').textContent = (totalDistOwned > 0 && totalSpent > 0) ? `£${(totalSpent/totalDistOwned).toFixed(2)}` : '--';

            // 5. Daily Cost (Unchanged)
            if(v && v.purchaseDate) {
                const daysOwned = (new Date() - new Date(v.purchaseDate)) / (1000 * 60 * 60 * 24);
                if(daysOwned > 0) {
                    let daily = 0;
                    if(includePurchase) {
                        daily = totalSpent / daysOwned;
                    } else {
                        const pPrice = getNum(v.purchasePrice);
                        const depr = pPrice * 0.15 * (daysOwned/365); 
                        daily = (depr + totalSpent) / daysOwned;
                    }
                    document.getElementById('stat-daily-cost').textContent = `£${daily.toFixed(2)}`;
                }
            } else { document.getElementById('stat-daily-cost').textContent = "--"; }

            // 6. Consumables (Unchanged)
            const consumablesContainer = document.getElementById('consumables-status-container');
            consumablesContainer.innerHTML = '';
            const findLast = (type, subType, isService = false) => history.find(d => (d.type === type) && (isService ? d.serviceType === subType : d.item === subType));
            const statusItems = [
                { name: "Oil Life", type: "service", sub: "Oil Change", icon: "fa-oil-can" },
                { name: "Air Fresh.", type: "consumable", sub: "Air Freshener", icon: "fa-wind" },
                { name: "Wipers", type: "consumable", sub: "Wiper Blades", icon: "fa-cloud-rain" },
                { name: "Cabin Air", type: "consumable", sub: "Cabin Filter", icon: "fa-fan" }
            ];
            statusItems.forEach(i => {
                const last = findLast(i.type, i.sub, i.type === "service");
                let label = "No Data";
                let color = "text-gray-400 bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700";
                if (last) {
                    const lastOdo = parseFloat(last.odometer);
                    if (i.name === "Oil Life" && !isNaN(lastOdo)) {
                        const miles = currentOdo - lastOdo;
                        label = `${miles} mi`;
                        color = miles > 8000 ? "text-red-600 bg-red-50 border-red-200" : (miles > 5000 ? "text-orange-600 bg-orange-50 border-orange-200" : "text-green-600 bg-green-50 border-green-200");
                    } else {
                        const days = Math.ceil((new Date() - new Date(last.date)) / (1000 * 60 * 60 * 24));
                        label = `${days}d ago`;
                        color = "text-teal-600 bg-teal-50 border-teal-200";
                    }
                }
                consumablesContainer.innerHTML += `<div class="card p-3 border-l-4 ${color.split(' ')[2]} flex flex-col justify-between"><div class="flex justify-between items-start mb-1"><p class="text-[10px] font-bold uppercase text-gray-500">${i.name}</p><i class="fa-solid ${i.icon} ${color.split(' ')[0]} opacity-80"></i></div><p class="text-sm font-bold ${color.split(' ')[0]}">${label}</p></div>`;
            });

            // 7. Compliance (Unchanged)
            const compContainer = document.getElementById('compliance-container');
            compContainer.innerHTML = '';
            const deadlines = [{ label: 'MOT', date: v.motExpiry, icon: 'fa-screwdriver-wrench' }, { label: 'Road Tax', date: v.taxExpiry, icon: 'fa-sterling-sign' }, { label: 'Insurance', date: v.insuranceExpiry, icon: 'fa-shield-halved' }];
            deadlines.forEach(item => {
                if(item.date) {
                    const diffDays = Math.ceil((new Date(item.date) - new Date()) / (1000 * 60 * 60 * 24));
                    let color = diffDays < 0 ? 'bg-red-100 text-red-800 border-red-200' : (diffDays < 30 ? 'bg-orange-100 text-orange-800 border-orange-200' : 'bg-green-100 text-green-800 border-green-200');
                    compContainer.innerHTML += `<div class="card p-3 flex items-center justify-between border-l-4 ${color.split(' ')[2]}"><div><p class="text-[10px] font-bold uppercase text-gray-500">${item.label}</p><h4 class="font-bold text-sm text-gray-800 dark:text-gray-200">${new Date(item.date).toLocaleDateString()}</h4><p class="text-[10px] mt-0.5">${diffDays} days left</p></div><div class="w-8 h-8 rounded-full ${color.split(' ').slice(0,2).join(' ')} flex items-center justify-center text-sm"><i class="fa-solid ${item.icon}"></i></div></div>`;
                }
            });

            // 8. Alerts (Unchanged)
            const lastSvc = history.filter(d=>d.type==='service').sort((a,b) => new Date(b.date)-new Date(a.date))[0];
            if(lastSvc) {
                const diff = currentOdo - getNum(lastSvc.odometer);
                if(diff > 10000) { document.getElementById('reminders-container').classList.remove('hidden'); document.getElementById('reminder-text').textContent = `Service overdue by ${diff - 10000} miles.`; }
                else document.getElementById('reminders-container').classList.add('hidden');
            }

            // 9. Ownership
            const milesDriven = Math.max(0, currentOdo - getNum(v.startOdometer));
            if(document.getElementById('stat-miles-owned')) document.getElementById('stat-miles-owned').textContent = milesDriven.toLocaleString();
            if(v.purchaseDate && milesDriven > 0) {
                const days = (new Date() - new Date(v.purchaseDate)) / (86400000);
                document.getElementById('stat-projection').textContent = Math.round((milesDriven/days)*365).toLocaleString();
            }
            if(v && v.tankSize && avgMpg > 0) document.getElementById('stat-range').textContent = Math.round(avgMpg * getNum(v.tankSize));

            // 10. Charts
            if(appState.charts.mpg) appState.charts.mpg.destroy();
            appState.charts.mpg = new Chart(document.getElementById('mpg-chart'), { type: 'line', data: { datasets: [{ data: chartPts, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month' } } }, plugins: { legend: { display: false } } } });

            const months = {};
            history.forEach(d => { if(d.date) months[d.date.substring(0, 7)] = (months[d.date.substring(0, 7)]||0) + (getNum(d.fuelCost)+getNum(d.cost)+getNum(d.expenseCost)); });
            if(includePurchase && v.purchaseDate) months[v.purchaseDate.substring(0, 7)] = (months[v.purchaseDate.substring(0, 7)]||0) + getNum(v.purchasePrice);
            if(appState.charts.cost) appState.charts.cost.destroy();
            appState.charts.cost = new Chart(document.getElementById('cost-breakdown-chart'), { type: 'bar', data: { labels: Object.keys(months).sort(), datasets: [{ label:'Cost', data: Object.keys(months).sort().map(m=>months[m]), backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        };

        const renderHistoryTable = () => {
            const tbody = document.getElementById('history-table-body');
            const thead = document.getElementById('history-table-header');
            tbody.innerHTML = ''; thead.innerHTML = '';
            
            ['Date', 'Type', 'Details', 'Cost', 'Edit'].forEach(h => { const th = document.createElement('th'); th.className = "px-6 py-3"; th.textContent = h; thead.appendChild(th); });
            
            const term = document.getElementById('history-search').value.toLowerCase();
            const getNumDisplay = (val) => {
                if(val === undefined || val === null || isNaN(parseFloat(val))) return '<span class="text-red-500 font-bold" title="Invalid Data">!--</span>';
                return `£${parseFloat(val).toFixed(2)}`;
            };
            
            let displayList = [...appState.history];
            const v = appState.vehicleData;
            
            if(v && v.purchaseDate && v.purchasePrice) {
                displayList.push({
                    id: 'purchase-event',
                    date: `${v.purchaseDate}T12:00`,
                    type: 'purchase',
                    cost: parseFloat(v.purchasePrice),
                    odometer: v.startOdometer,
                    company: 'Vehicle Purchase',
                    details: 'Initial Purchase'
                });
            }

            displayList.sort((a,b) => new Date(b.date) - new Date(a.date));

            displayList.filter(d => JSON.stringify(d).toLowerCase().includes(term)).forEach(d => {
                const tr = document.createElement('tr'); 
                tr.className = "bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                if(d.type === 'purchase') tr.className += " border-l-4 border-green-500 bg-green-50/50 dark:bg-green-900/10";

                let icon = '', details = '', cost = '-';
                let companyInfo = d.company ? `<div class="text-xs font-bold text-gray-500 uppercase">${d.company}${d.location ? ' (' + d.location + ')' : ''}</div>` : '';
                
                let dateDisplay = d.date;
                if(d.date && d.date.includes('T')) {
                    const [datePart, timePart] = d.date.split('T');
                    dateDisplay = `<div class="flex flex-col"><span class="font-semibold">${datePart}</span><span class="text-xs text-gray-400">${timePart}</span></div>`;
                }

                if(d.type === 'fuel-up') { 
                    icon = "fa-gas-pump text-blue-500"; 
                    const fuelType = d.fuelType ? `<span class="text-[10px] font-bold text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded mr-1">${d.fuelType}</span>` : '';
                    const odoDisplay = (d.odometer && !isNaN(d.odometer)) ? `${d.odometer}mi` : '<span class="text-red-400">!--mi</span>';
                    const qty = d.fuelQuantity ? ` • ${d.fuelQuantity}L` : '';
                    const rate = d.fuelUnitPrice ? ` @ ${parseFloat(d.fuelUnitPrice).toFixed(3)}` : '';
                    details = `${companyInfo}${fuelType}${odoDisplay}${qty}${rate} <span class="text-gray-400 text-xs">(${d.drivingContext || 'Mixed'})</span>`;
                    if(d.hasLoyaltySaving) details += ` <span class="text-[10px] text-green-600 bg-green-100 px-1 rounded ml-1">Loyalty</span>`;
                    cost = getNumDisplay(d.fuelCost); 
                }
                else if(d.type === 'service') { icon = "fa-screwdriver-wrench text-orange-500"; details = `${companyInfo}${d.serviceType}`; cost = getNumDisplay(d.cost); }
                else if(d.type === 'trip') { 
                    const miles = isNaN(d.miles) ? 0 : d.miles;
                    icon = "fa-route text-cyan-500"; 
                    details = `${d.category}: ${miles}mi`; 
                }
                else if(d.type === 'health-check') { icon = "fa-heart-pulse text-purple-500"; details = "Check-up"; }
                else if(d.type === 'consumable') { icon = "fa-spray-can-sparkles text-teal-500"; details = d.item; cost = getNumDisplay(d.cost); }
                else if(d.type === 'purchase') { 
                     icon = "fa-car text-green-600"; 
                     details = `${companyInfo}Start Mileage: ${d.odometer || 0}mi`; 
                     cost = `£${(d.cost||0).toLocaleString()}`; 
                }
                else { icon = "fa-receipt text-green-500"; details = `${companyInfo}${d.expenseItem}`; cost = getNumDisplay(d.expenseCost); }
                
                if(d.receiptUrl) details += ` <a href="${d.receiptUrl}" target="_blank" class="text-blue-500 hover:underline ml-2"><i class="fa-solid fa-paperclip"></i></a>`;
                
                const editBtn = d.type === 'purchase' 
                    ? `<button class="text-gray-300 cursor-not-allowed" title="Edit in Glovebox"><i class="fa-solid fa-lock"></i></button>`
                    : `<button class="text-gray-400 hover:text-blue-500 edit-btn" data-id="${d.id}"><i class="fa-solid fa-pen"></i></button>`;

                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${dateDisplay}</td><td class="px-6 py-4"><i class="fa-solid ${icon} mr-2"></i></td><td class="px-6 py-4">${details}</td><td class="px-6 py-4 font-medium">${cost}</td><td class="px-6 py-4">${editBtn}</td>`;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-btn').forEach(b => b.onclick = (e) => openModal(e.currentTarget.dataset.id));
        };

        const saveEntry = async (btnId, data, fileInputId) => {
            if(!appState.currentVehicleId) return showMessage("No vehicle selected", "error");
            if(!data.date) return showMessage("Date is required", "error");
            
            // Validation for Company field
            if((data.type === 'fuel-up' || data.type === 'service' || data.type === 'expense') && !data.company) {
                return showMessage("Company/Provider is required", "error");
            }

            setLoading(btnId, true);
            try {
                if(fileInputId) {
                    const file = document.getElementById(fileInputId).files[0];
                    if(file) {
                        const url = await uploadImage(file, data.type);
                        data.receiptUrl = url;
                    }
                }
                
                // Add Standard Metadata
                data.createdAt = serverTimestamp();
                data.uploadedBy = auth.currentUser.email;
                data.uploadedApp = 'VehicleManagr';
                data.datapointUpdatedBy = auth.currentUser.uid;
                data.datapointUpdatedTime = serverTimestamp();

                await addDoc(collection(db, `users/${appState.user.uid}/vehicles/${appState.currentVehicleId}/history`), data);
                showMessage("Entry Saved");
                document.querySelectorAll(`#tab-content-log input:not([type=date])`).forEach(i => i.value = '');
            } catch(e) { showMessage(e.message, "error"); }
            setLoading(btnId, false);
        };

        document.getElementById('import-csv').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file || !appState.currentVehicleId) return;
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const batch = writeBatch(db);
                    let count = 0;
                    
                    results.data.forEach(row => {
                        // Normalize keys to lowercase to be forgiving
                        const keys = Object.keys(row).reduce((acc, k) => { acc[k.toLowerCase()] = row[k]; return acc; }, {});
                        
                        // We need at least Date AND (Cost OR Odo)
                        const dateVal = keys['date'];
                        if(dateVal) {
                            const ref = doc(collection(db, `users/${appState.user.uid}/vehicles/${appState.currentVehicleId}/history`));
                            
                            // Try to find volume in common header names
                            const vol = parseFloat(keys['volume'] || keys['liters'] || keys['litres'] || keys['quantity'] || keys['gallons'] || 0);
                            const cost = parseFloat(keys['cost'] || keys['total'] || keys['price'] || 0);
                            const odo = parseFloat(keys['odometer'] || keys['mileage'] || keys['miles'] || 0);
                            const typeRaw = (keys['type'] || 'expense').toLowerCase();
                            
                            // Sanitize Type
                            let type = typeRaw;
                            if(type.includes('fuel') || type.includes('gas') || type.includes('petrol')) type = 'fuel-up';
                            else if(type.includes('service') || type.includes('repair')) type = 'service';
                            
                            batch.set(ref, {
                                date: dateVal,
                                type: type,
                                cost: (type !== 'fuel-up') ? cost : 0, // Store cost in 'cost' for non-fuel
                                fuelCost: (type === 'fuel-up') ? cost : 0, // Store fuel cost here
                                fuelQuantity: vol, // CRITICAL: Now importing volume
                                odometer: odo,
                                company: keys['company'] || keys['payee'] || 'Unknown',
                                notes: keys['notes'] || '',
                                imported: true,
                                createdAt: serverTimestamp()
                            });
                            count++;
                        }
                    });
                    
                    if(count > 0) { 
                        await batch.commit(); 
                        showMessage(`Imported ${count} entries with Volume!`); 
                    } else { 
                        showMessage("No valid rows found. Check CSV headers.", "error"); 
                    }
                }
            });
        });

        document.getElementById('fab-main').onclick = () => document.getElementById('fab-container').classList.toggle('open');
        window.quickLog = (type) => {
            document.querySelector('[data-tab="log"]').click();
            document.getElementById('fab-container').classList.remove('open');
            setTimeout(() => { document.getElementById(`card-${type}`).scrollIntoView({ behavior: 'smooth' }); }, 100);
        };

// Update log-fuel-btn handler
document.getElementById("log-fuel-btn").onclick = () => {
    // ... (keep existing qty/total/unit logic) ...
    const qty = parseFloat(document.getElementById('fuel-quantity').value); // Re-declare for context
    const total = parseFloat(document.getElementById('fuel-cost').value);
    let unit = parseFloat(document.getElementById('fuel-price-unit').value);
    if (isNaN(unit) && qty > 0 && total > 0) unit = total / qty;

    saveEntry("log-fuel-btn", {
        type: 'fuel-up', 
        date: getTimestamp('fuel'), // UPDATED
        driver: document.getElementById('fuel-driver').value,
        odometer: parseFloat(document.getElementById('odometer').value),
        fuelQuantity: qty,
        fuelCost: total,
        fuelUnitPrice: parseFloat(document.getElementById('fuel-price-unit').value), // Captures the auto-calculated value
    standardUnitPrice: parseFloat(document.getElementById('fuel-price-standard').value),
        fuelType: document.getElementById('fuel-type').value,
        company: document.getElementById('fuel-company').value,
        location: document.getElementById('fuel-location').value,
        paymentMethod: document.getElementById('fuel-payment').value,
        drivingContext: document.getElementById('fuel-context').value,
        isPartial: document.getElementById('fuel-partial').checked,
        hasLoyaltySaving: document.getElementById('fuel-loyalty').checked,
        isEstimate: document.getElementById('fuel-estimate').checked
    }, 'fuel-receipt');
};

// Add or Replace this function in your script
const calculateFuelLoyalty = () => {
    const qty = parseFloat(document.getElementById('fuel-quantity').value);
    const total = parseFloat(document.getElementById('fuel-cost').value);
    const stdPrice = parseFloat(document.getElementById('fuel-price-standard').value);
    
    const paidUnitEl = document.getElementById('fuel-price-unit');
    const loyaltyBox = document.getElementById('fuel-loyalty');

    if (qty > 0 && total > 0) {
        // 1. Calculate and round to 3 decimals (to match the visual display)
        // This prevents floating point errors (e.g. 1.499999 vs 1.5)
        const rawUnit = total / qty;
        const calculatedUnit = parseFloat(rawUnit.toFixed(2)); 
        
        paidUnitEl.value = calculatedUnit.toFixed(2);

        // 2. Strict Comparison
        if (!isNaN(stdPrice) && stdPrice > 0) {
            // "If auto-calculated is less than standard -> Loyalty Used"
            // "If equal (or greater) -> Loyalty NOT Used"
            if (calculatedUnit < stdPrice) {
                loyaltyBox.checked = true;
            } else {
                loyaltyBox.checked = false;
            }
        }
    } else {
        paidUnitEl.value = '';
    }
};

// Ensure listeners are attached to the inputs that affect the calc
['fuel-quantity', 'fuel-cost', 'fuel-price-standard'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', calculateFuelLoyalty);
});

// Update log-service-btn handler
document.getElementById("log-service-btn").onclick = () => saveEntry("log-service-btn", {
    type: 'service', 
    date: getTimestamp('service'), // UPDATED
    odometer: parseFloat(document.getElementById('service-odometer').value),
    serviceType: document.getElementById('service-type').value,
    company: document.getElementById('service-company').value,
    location: document.getElementById('service-location').value,
    cost: parseFloat(document.getElementById('service-cost').value),
    paymentMethod: document.getElementById('service-payment').value,
    notes: document.getElementById('service-notes').value
}, 'service-receipt');

// Update log-consumable-btn handler
document.getElementById("log-consumable-btn").onclick = () => saveEntry("log-consumable-btn", {
    type: 'consumable', 
    date: getTimestamp('consumable'), // UPDATED
    item: document.getElementById('consumable-type').value,
    cost: parseFloat(document.getElementById('consumable-cost').value),
    notes: document.getElementById('consumable-notes').value
});

// Update log-trip-btn handler
document.getElementById("log-trip-btn").onclick = () => saveEntry("log-trip-btn", {
    type: 'trip', 
    date: getTimestamp('trip'), // UPDATED
    category: document.getElementById('trip-type').value,
    from: document.getElementById('trip-from').value,
    to: document.getElementById('trip-to').value,
    miles: parseFloat(document.getElementById('trip-miles').value)
});

// Update log-health-btn handler
document.getElementById("log-health-btn").onclick = () => saveEntry("log-health-btn", {
    type: 'health-check', 
    date: getTimestamp('health'), // UPDATED
    tyres: { fl: document.getElementById('tyre-fl').value, fr: document.getElementById('tyre-fr').value, rl: document.getElementById('tyre-rl').value, rr: document.getElementById('tyre-rr').value },
    tread: { fl: document.getElementById('tread-fl').value, fr: document.getElementById('tread-fr').value, rl: document.getElementById('tread-rl').value, rr: document.getElementById('tread-rr').value },
    checkedWasher: document.getElementById('check-washer').checked, checkedAir: document.getElementById('check-air').checked,
    notes: document.getElementById('health-notes').value
});

// Update log-expense-btn handler
document.getElementById("log-expense-btn").onclick = () => saveEntry("log-expense-btn", {
    type: 'expense', 
    date: getTimestamp('expense'), // UPDATED
    expenseItem: document.getElementById('expense-category').value, 
    company: document.getElementById('expense-company').value,
    location: document.getElementById('expense-location').value,
    expenseCost: parseFloat(document.getElementById('expense-cost').value),
    paymentMethod: document.getElementById('expense-payment').value
}, 'expense-receipt');

        document.getElementById('save-metadata-btn').onclick = saveMetadata;

        const openModal = (id) => {
            appState.modalId = id;
            const item = appState.history.find(i => i.id === id);
            const content = document.getElementById('edit-modal-content');
            
            const mkInput = (l, k, t, v) => `
                <div>
                    <label class="text-xs font-bold uppercase text-gray-500 block mb-1">${l}</label>
                    <input id="edit-${k}" type="${t}" value="${v !== undefined && v !== null ? v : ''}" class="w-full p-2 border rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500 bg-white dark:bg-gray-800 dark:border-gray-700">
                </div>`;
            
            const mkSelect = (l, k, opts, sel) => `
                <div>
                    <label class="text-xs font-bold uppercase text-gray-500 block mb-1">${l}</label>
                    <select id="edit-${k}" class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
                        ${opts.map(o => `<option value="${o}" ${sel === o ? 'selected' : ''}>${o}</option>`).join('')}
                    </select>
                </div>`;

            const mkCheckbox = (l, k, v) => `
                <div class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                    <input type="checkbox" id="edit-${k}" class="w-4 h-4 text-blue-600 rounded" ${v ? 'checked' : ''}>
                    <label for="edit-${k}" class="text-sm font-semibold select-none cursor-pointer">${l}</label>
                </div>`;

            let html = `<div class="edit-form-grid">`;
            
            // Handle date format for datetime-local
            // 1. Logic to split the date string
const datePart = item.date ? item.date.split('T')[0] : '';
// Get time if exists (HH:MM), otherwise empty
const timePart = item.date && item.date.includes('T') ? item.date.split('T')[1].substring(0,5) : '';

// 2. Generate HTML for split fields (Replaces the old 'mkInput' for date)
html += `<div class="flex gap-2">
    <div class="flex-grow">
        <label class="text-xs font-bold uppercase text-gray-500 block mb-1">Date</label>
        <input id="edit-date" type="date" value="${datePart}" class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
    </div>
    <div class="w-24">
        <label class="text-xs font-bold uppercase text-gray-500 block mb-1">Time</label>
        <input id="edit-time" type="time" value="${timePart}" class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
    </div>
</div>`;

            if (item.type === 'fuel-up') {
    html += mkInput('Driver', 'driver', 'text', item.driver); // NEW
    html += mkInput('Odometer', 'odometer', 'number', item.odometer);
    html += mkInput('Cost (£)', 'fuelCost', 'number', item.fuelCost);
    html += mkInput('Volume', 'fuelQuantity', 'number', item.fuelQuantity);
    html += mkInput('Company', 'company', 'text', item.company);
    html += mkInput('Location', 'location', 'text', item.location);
    html += mkSelect('Fuel Type', 'fuelType', ['Petrol', 'Premium Petrol', 'Diesel', 'Premium Diesel', 'Electric', 'LPG', 'AdBlue'], item.fuelType || 'Petrol');
    html += mkSelect('Payment', 'paymentMethod', ['Card', 'Cash', 'Corporate'], item.paymentMethod);
    html += mkSelect('Context', 'drivingContext', ['Mixed', 'City', 'Highway', 'Sport'], item.drivingContext);
    html += `</div><div class="grid grid-cols-3 gap-2 mt-3">`; // Changed grid cols to 3
    html += mkCheckbox('Partial Fill', 'isPartial', item.isPartial);
    html += mkCheckbox('Loyalty Used', 'hasLoyaltySaving', item.hasLoyaltySaving);
    html += mkCheckbox('Vol. Est.', 'isEstimate', item.isEstimate); // NEW
}
            else if (item.type === 'service') {
                html += mkInput('Odometer', 'odometer', 'number', item.odometer);
                html += mkInput('Cost (£)', 'cost', 'number', item.cost);
                html += mkSelect('Type', 'serviceType', ['Maintenance', 'Oil Change', 'Repair', 'MOT', 'Tyres', 'Brake Fluid'], item.serviceType);
                html += mkInput('Provider', 'company', 'text', item.company);
                html += mkInput('Location', 'location', 'text', item.location);
                html += `</div><div class="mt-3">`;
                html += `<label class="text-xs font-bold uppercase text-gray-500 block mb-1">Notes</label><textarea id="edit-notes" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700" rows="3">${item.notes || ''}</textarea>`;
            }
            else if (item.type === 'expense') {
                html += mkInput('Cost (£)', 'expenseCost', 'number', item.expenseCost);
                html += mkSelect('Category', 'expenseItem', ['Road Tax', 'Car Insurance', 'Breakdown Cover', 'Toll/Parking', 'Fine', 'Accessories', 'Other'], item.expenseItem);
                html += mkInput('Payee', 'company', 'text', item.company);
                html += mkInput('Location', 'location', 'text', item.location);
                html += mkSelect('Payment', 'paymentMethod', ['Card', 'Cash', 'Corporate'], item.paymentMethod);
            }
            else if (item.type === 'consumable') {
                html += mkSelect('Item', 'item', ['Air Freshener', 'Wiper Blades', 'Cabin Filter', 'Light Bulb', 'Car Wash'], item.item);
                html += mkInput('Cost (£)', 'cost', 'number', item.cost);
                html += `</div><div class="mt-3">`;
                html += `<label class="text-xs font-bold uppercase text-gray-500 block mb-1">Notes</label><input id="edit-notes" type="text" value="${item.notes || ''}" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700">`;
            }
            else if (item.type === 'trip') {
                html += mkSelect('Type', 'category', ['Business', 'Personal', 'Commute'], item.category);
                html += mkInput('From', 'from', 'text', item.from);
                html += mkInput('To', 'to', 'text', item.to);
                html += mkInput('Distance (mi)', 'miles', 'number', item.miles);
            }
            else if (item.type === 'health-check') {
                html += `</div>`; // Close grid for custom layout
                html += `<div class="grid grid-cols-2 gap-3 mt-3">
                    ${mkCheckbox('Washer Fluid', 'checkedWasher', item.checkedWasher)}
                    ${mkCheckbox('Tyre Air', 'checkedAir', item.checkedAir)}
                </div>
                <div class="mt-4 border-t pt-2 dark:border-gray-700">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2 text-center">Tyres (Pressure / Tread)</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                             <div class="text-xs text-center font-bold">Front Left</div>
                             <input id="edit-tyre-fl" type="number" placeholder="PSI" value="${item.tyres?.fl || ''}" class="w-full p-1 border rounded text-center text-sm">
                             <input id="edit-tread-fl" type="number" placeholder="mm" value="${item.tread?.fl || ''}" class="w-full p-1 border rounded text-center text-sm">
                        </div>
                        <div class="space-y-2">
                             <div class="text-xs text-center font-bold">Front Right</div>
                             <input id="edit-tyre-fr" type="number" placeholder="PSI" value="${item.tyres?.fr || ''}" class="w-full p-1 border rounded text-center text-sm">
                             <input id="edit-tread-fr" type="number" placeholder="mm" value="${item.tread?.fr || ''}" class="w-full p-1 border rounded text-center text-sm">
                        </div>
                         <div class="space-y-2">
                             <div class="text-xs text-center font-bold">Rear Left</div>
                             <input id="edit-tyre-rl" type="number" placeholder="PSI" value="${item.tyres?.rl || ''}" class="w-full p-1 border rounded text-center text-sm">
                             <input id="edit-tread-rl" type="number" placeholder="mm" value="${item.tread?.rl || ''}" class="w-full p-1 border rounded text-center text-sm">
                        </div>
                         <div class="space-y-2">
                             <div class="text-xs text-center font-bold">Rear Right</div>
                             <input id="edit-tyre-rr" type="number" placeholder="PSI" value="${item.tyres?.rr || ''}" class="w-full p-1 border rounded text-center text-sm">
                             <input id="edit-tread-rr" type="number" placeholder="mm" value="${item.tread?.rr || ''}" class="w-full p-1 border rounded text-center text-sm">
                        </div>
                    </div>
                </div>
                <div class="mt-3">`;
                html += `<label class="text-xs font-bold uppercase text-gray-500 block mb-1">Notes</label><textarea id="edit-notes" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700" rows="2">${item.notes || ''}</textarea>`;
            }

            if (!html.endsWith('</div>')) html += `</div>`; // Close if not closed
            content.innerHTML = html;
            
            // Re-bind Save Button Logic
            const saveBtn = document.getElementById("modal-save-btn"); 
            saveBtn.replaceWith(saveBtn.cloneNode(true));
            document.getElementById("modal-save-btn").onclick = async () => {
                const getVal = (k) => {
                    const el = document.getElementById(`edit-${k}`);
                    return el ? el.value : null;
                };
                const getCheck = (k) => {
                    const el = document.getElementById(`edit-${k}`);
                    return el ? el.checked : false;
                };

                let data = { 
                    datapointUpdatedBy: auth.currentUser.uid,
                    datapointUpdatedTime: serverTimestamp()
                };

                // Common
                // COMBINE Date and Time back into a single string
const dVal = getVal('date');
const tVal = getVal('time');

if(dVal) {
    // If a time is provided, use it; otherwise default to 12:00
    data.date = `${dVal}T${tVal || '12:00'}`;
}

                if(item.type === 'fuel-up') {
    data.driver = getVal('driver'); // NEW
    data.odometer = parseFloat(getVal('odometer'));
    data.fuelCost = parseFloat(getVal('fuelCost'));
    data.fuelQuantity = parseFloat(getVal('fuelQuantity'));
    data.company = getVal('company');
    data.location = getVal('location');
    data.fuelType = getVal('fuelType');
    data.paymentMethod = getVal('paymentMethod');
    data.drivingContext = getVal('drivingContext');
    data.isPartial = getCheck('isPartial');
    data.hasLoyaltySaving = getCheck('hasLoyaltySaving');
    data.isEstimate = getCheck('isEstimate'); // NEW
} else if(item.type === 'service') {
                    data.odometer = parseFloat(getVal('odometer'));
                    data.cost = parseFloat(getVal('cost'));
                    data.serviceType = getVal('serviceType');
                    data.company = getVal('company');
                    data.location = getVal('location');
                    data.notes = getVal('notes');
                } else if(item.type === 'expense') {
                    data.expenseCost = parseFloat(getVal('expenseCost'));
                    data.expenseItem = getVal('expenseItem');
                    data.company = getVal('company');
                    data.location = getVal('location');
                    data.paymentMethod = getVal('paymentMethod');
                } else if(item.type === 'consumable') {
                    data.item = getVal('item');
                    data.cost = parseFloat(getVal('cost'));
                    data.notes = getVal('notes');
                } else if(item.type === 'trip') {
                    data.category = getVal('category');
                    data.from = getVal('from');
                    data.to = getVal('to');
                    data.miles = parseFloat(getVal('miles'));
                } else if(item.type === 'health-check') {
                    data.checkedWasher = getCheck('checkedWasher');
                    data.checkedAir = getCheck('checkedAir');
                    data.notes = getVal('notes');
                    data.tyres = {
                        fl: getVal('tyre-fl'), fr: getVal('tyre-fr'),
                        rl: getVal('tyre-rl'), rr: getVal('tyre-rr')
                    };
                    data.tread = {
                        fl: getVal('tread-fl'), fr: getVal('tread-fr'),
                        rl: getVal('tread-rl'), rr: getVal('tread-rr')
                    };
                }

                setLoading("modal-save-btn", true);
                try { 
                    await setDoc(doc(db, `users/${appState.user.uid}/vehicles/${appState.currentVehicleId}/history`, id), data, { merge: true }); 
                    showMessage("Updated"); 
                    document.getElementById('edit-modal').classList.add('hidden'); 
                } catch(e) { showMessage(e.message, "error"); }
                setLoading("modal-save-btn", false);
            };

            // Re-bind Delete Button Logic
            const delBtn = document.getElementById("modal-delete-btn");
            delBtn.replaceWith(delBtn.cloneNode(true));
            document.getElementById("modal-delete-btn").onclick = async () => {
                if(!confirm("Are you sure?")) return;
                setLoading("modal-delete-btn", true);
                try { 
                    await deleteDoc(doc(db, `users/${appState.user.uid}/vehicles/${appState.currentVehicleId}/history`, id)); 
                    document.getElementById('edit-modal').classList.add('hidden'); 
                    showMessage("Deleted"); 
                } catch(e) { showMessage(e.message, "error"); }
                setLoading("modal-delete-btn", false);
            };

            document.getElementById('edit-modal').classList.remove('hidden');
        };

        document.getElementById("sign-in-btn").onclick = async () => { setLoading('sign-in-btn', true); try { await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); } catch(e) { showMessage(e.message, "error"); setLoading('sign-in-btn', false); } };
        document.getElementById("sign-up-btn").onclick = async () => { setLoading('sign-up-btn', true); try { await createUserWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); } catch(e) { showMessage(e.message, "error"); setLoading('sign-up-btn', false); } };
        document.getElementById("logout-btn").onclick = () => signOut(auth);
        document.getElementById("theme-toggle").onclick = toggleTheme;
        document.getElementById("add-vehicle-btn").onclick = handleAddVehicle;
        document.getElementById("delete-vehicle-btn").onclick = handleDeleteVehicle;
        document.getElementById("archive-vehicle-btn").onclick = handleArchiveVehicle;
        document.getElementById("rename-vehicle-btn").onclick = handleRenameVehicle;
        document.getElementById("toggle-archive-view").onclick = (e) => { 
            appState.showArchived = !appState.showArchived; 
            e.currentTarget.classList.toggle('bg-blue-100'); e.currentTarget.classList.toggle('text-blue-600'); 
            loadVehicles(appState.user.uid); 
        };

        document.getElementById("export-json-btn").onclick = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(appState.history,null,2)], {type:"application/json"})); a.download = "data.json"; a.click(); };
        document.getElementById("export-csv-btn").onclick = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([Papa.unparse(appState.history)], {type:"text/csv"})); a.download = "data.csv"; a.click(); };
        document.getElementById("history-search").oninput = renderHistoryTable;
        document.getElementById('include-purchase-toggle').addEventListener('change', renderDashboard);
        document.querySelectorAll('.nav-tab').forEach(b => b.onclick = (e) => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            e.currentTarget.classList.add('active'); document.getElementById(`tab-content-${e.currentTarget.dataset.tab}`).classList.remove('hidden');
        });
        document.querySelector('.close-btn').onclick = () => document.getElementById('edit-modal').classList.add('hidden');
        
        onAuthStateChanged(auth, (user) => {
            if(user) {
                appState.user = user;
                document.getElementById("auth-container").classList.add("hidden"); document.getElementById("main-app-container").classList.remove("hidden"); document.getElementById("fab-container").classList.remove("hidden");
                setDefaults();
                onSnapshot(doc(db, 'users', user.uid, 'settings', 'theme'), (s) => { if(s.data()?.theme === 'dark' && !ui.body.classList.contains('dark-mode')) toggleTheme(); });
                loadVehicles(user.uid);
            } else {
                appState.user = null;
                document.getElementById("auth-container").classList.remove("hidden"); document.getElementById("main-app-container").classList.add("hidden"); document.getElementById("fab-container").classList.add("hidden");
                ui.body.classList.remove('dark-mode');
            }
        });

        document.querySelectorAll('.pressure-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const val = parseInt(e.target.value); e.target.className = "tyre-input pressure-input " + e.target.classList[2];
                if (!val) return;
                if (val < 30) e.target.style.backgroundColor = "#fee2e2"; 
                else if (val > 36) e.target.style.backgroundColor = "#ffedd5"; 
                else e.target.style.backgroundColor = "#dcfce7";
            });
        });
    </script>
</body>
</html>
