<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VidTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512' fill='%23ed2224'%3E%3Cpath d='M0 128C0 92.7 28.7 64 64 64H512c35.3 0 64 28.7 64 64v96h-8c-26.5 0-48 21.5-48 48s21.5 48 48 48h8v96c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V320h8c26.5 0 48-21.5 48-48s-21.5-48-48-48H0V128z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ed2224; --primary-hover: #c01e1f;
            --bg-dark: #111827; --card-dark: #1f2937; --text-dark: #f9fafb;
            --bg-light: #f3f4f6; --card-light: #ffffff; --text-light: #111827;
        }
        .dark { --bg: var(--bg-dark); --card: var(--card-dark); --text: var(--text-dark); }
        .light { --bg: var(--bg-light); --card: var(--card-light); --text: var(--text-light); }
        
        body { background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; padding-bottom: 80px; /* Space for mobile nav */ }
        .card { background-color: var(--card); transition: background-color 0.3s; }
        .btn-primary { background-color: var(--primary); color: white; transition: 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #4b5563; border-radius: 2px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .nav-btn {
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5); 
            color: white;
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(4px); 
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 20; 
            opacity: 0; 
            cursor: pointer;
        }
        .group:hover .nav-btn { opacity: 1; }
        .nav-btn:hover { background: var(--primary); transform: translateY(-50%) scale(1.1); }
        .nav-prev { left: 20px; }
        .nav-next { right: 20px; } 
        
        /* Mobile Nav Styles */
        .mobile-nav-link { color: #9ca3af; flex-direction: column; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; gap: 4px; }
        .mobile-nav-link.active { color: var(--primary); }
        .mobile-nav-link i { font-size: 1.25rem; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="sticky top-0 bg-[var(--card)] shadow-lg z-30">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-3">
                <div class="flex items-center space-x-6">
                    <a href="#dashboard" class="flex items-center space-x-2 text-2xl font-bold text-[var(--primary)] hover:scale-105 transition">
                        <i class="fa-solid fa-ticket"></i>
                        <span class="inline">VidTrackr</span>
                    </a>
                    <nav id="main-nav" class="hidden md:flex space-x-6 text-sm font-medium">
                        <a href="#dashboard" class="nav-link py-4 border-b-2 border-transparent hover:text-[var(--primary)] transition">Dashboard</a>
                        <a href="#library" class="nav-link py-4 border-b-2 border-transparent hover:text-[var(--primary)] transition">Library</a>
                        <a href="#progress" class="nav-link py-4 border-b-2 border-transparent hover:text-[var(--primary)] transition">Progress</a>
                        <a href="#history" class="nav-link py-4 border-b-2 border-transparent hover:text-[var(--primary)] transition">History</a>
                        <a href="#settings" class="nav-link py-4 border-b-2 border-transparent hover:text-[var(--primary)] transition">Settings</a>
                    </nav>
                </div>

                <div class="flex items-center space-x-4">
                    <div id="search-container" class="relative hidden sm:block">
                        <div class="flex items-center bg-[var(--bg)] rounded-full px-3 py-1 border border-transparent focus-within:border-[var(--primary)] focus-within:ring-1 focus-within:ring-[var(--primary)] transition-all">
                            <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                            <input type="search" id="search-input" placeholder="Search..." 
                                   class="bg-transparent border-none text-sm w-32 md:w-48 focus:ring-0 placeholder-gray-500 text-[var(--text)] ml-2 outline-none">
                            <button id="search-filter-btn" class="ml-2 text-gray-400 hover:text-[var(--primary)] transition relative">
                                <i class="fa-solid fa-sliders"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--bg)] transition transform hover:rotate-12"><i class="fa-solid fa-moon text-xl"></i></button>
                    <div id="auth-container"></div>
                </div>
            </div>
        </div>
    </header>

    <div class="sm:hidden px-4 py-2 bg-[var(--card)] border-b border-gray-800">
        <div class="flex items-center bg-[var(--bg)] rounded-lg px-3 py-2">
             <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
             <input type="search" id="mobile-search-input" placeholder="Search movies & shows..." class="bg-transparent border-none text-sm w-full focus:ring-0 text-[var(--text)] ml-2 outline-none">
        </div>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8">
        <div id="content" class="min-h-[50vh]"></div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-[var(--card)] border-t border-gray-800 z-50 flex justify-around py-3 pb-safe">
        <a href="#dashboard" class="mobile-nav-link active"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#library" class="mobile-nav-link"><i class="fa-solid fa-layer-group"></i><span>Library</span></a>
        <a href="#progress" class="mobile-nav-link"><i class="fa-solid fa-chart-pie"></i><span>Progress</span></a>
        <a href="#history" class="mobile-nav-link"><i class="fa-solid fa-clock-rotate-left"></i><span>History</span></a>
        <a href="#settings" class="mobile-nav-link"><i class="fa-solid fa-user"></i><span>Profile</span></a>
    </nav>

    <footer class="bg-[var(--card)] py-6 mt-auto text-center text-gray-500 text-sm border-t border-gray-800 mb-16 md:mb-0">
        <p>&copy; 2025 VidTrackr. Data provided by <a href="https://trakt.tv" class="text-[var(--primary)] hover:underline">Trakt.tv</a>.</p>
    </footer>
    <div id="loader" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity">
        <div class="animate-spin rounded-full h-14 w-14 border-[5px] border-[var(--primary)] border-t-transparent"></div>
    </div>
    <div id="scrobble-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 md:p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 animate-fade">
            <h3 class="text-2xl font-bold mb-1">Log & Rate</h3>
            <p id="modal-title" class="text-gray-400 mb-6 text-sm truncate"></p>
            
            <div class="mb-6 bg-[var(--bg)] p-4 rounded-xl border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-gray-300">Rating</label>
                    <span id="rating-value" class="text-[var(--primary)] font-bold text-lg">10</span>
                </div>
                <input type="range" id="rating-slider" min="1" max="10" value="10" class="w-full">
            </div>

            <div class="space-y-3 mb-6">
                <label class="text-sm font-bold text-gray-300">Watched On</label>
                <div class="grid grid-cols-2 gap-3">
                    <button class="date-option p-3 rounded-lg border border-gray-600 hover:border-[var(--primary)] hover:bg-[var(--bg)] transition text-center group bg-[var(--bg)]" data-date="now">
                        <span class="block text-xs text-gray-400">Today</span>
                        <i class="fa-solid fa-clock text-[var(--primary)]"></i>
                    </button>
                    <button class="date-option p-3 rounded-lg border border-gray-600 hover:border-[var(--primary)] hover:bg-[var(--bg)] transition text-center group bg-[var(--bg)]" data-date="yesterday">
                        <span class="block text-xs text-gray-400">Yesterday</span>
                    </button>
                </div>
                <input type="datetime-local" id="custom-date" class="w-full p-3 rounded-lg bg-[var(--bg)] border border-gray-600 focus:border-[var(--primary)] outline-none text-sm">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="confirm-log" class="bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold transition">Log Only</button>
                <button id="confirm-rate-log" class="btn-primary py-3 rounded-lg font-bold shadow-lg shadow-red-900/30">Rate & Log</button>
            </div>
            <button id="close-modal" class="w-full mt-4 text-sm text-gray-500 hover:text-white">Cancel</button>
        </div>
    </div>

    <div id="list-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 animate-fade">
            <h3 class="text-xl font-bold mb-4">Add to List</h3>
            <div id="list-modal-content" class="space-y-2 max-h-60 overflow-y-auto hide-scroll mb-4">
                </div>
            <button onclick="document.getElementById('list-modal').classList.add('hidden')" class="w-full text-sm text-gray-500 hover:text-white mt-2">Cancel</button>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-20 md:bottom-6 right-6 z-50 flex flex-col gap-3"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { TRAKT_CLIENT_ID } from './api_keys.js';

        // --- Config ---
        const app = initializeApp({
          apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
          authDomain: "sammy-7298f.firebaseapp.com",
          projectId: "sammy-7298f",
          storageBucket: "sammy-7298f.firebasestorage.app",
          messagingSenderId: "963185683535",
          appId: "1:963185683535:web:807df8941feba46c208e3a"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const TRAKT_API_URL = 'https://api.trakt.tv';
        const PLACEHOLDER_IMG = 'https://placehold.co/400x600/1f2937/FFF?text=No+Image';

        // --- AUTH & TOKEN HANDLING ---
        const REDIRECT_URI = window.location.href.split('#')[0].split('?')[0];

        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        if (hashParams.has('access_token')) {
            const newToken = hashParams.get('access_token');
            console.log("New Token Received:", newToken);
            localStorage.setItem('trakt_token', newToken); 
            window.history.replaceState({}, document.title, REDIRECT_URI);
            window.location.reload(); 
        }

        // --- State ---
        let currentUser = null;
        let traktAccessToken = localStorage.getItem('trakt_token');
        let currentModalItem = null;
        let selectedDate = new Date().toISOString();
        let userRatings = new Map();
        let historyPage = 1;
        let isFetchingHistory = false;
        let progressChartInstance = null;
        let isAuthErrorHandling = false;

        // --- DOM ---
        const els = {
            content: document.getElementById('content'),
            auth: document.getElementById('auth-container'),
            searchContainer: document.getElementById('search-container'),
            loader: document.getElementById('loader'),
            modal: document.getElementById('scrobble-modal'),
            ratingSlider: document.getElementById('rating-slider'),
            ratingValue: document.getElementById('rating-value'),
            toastContainer: document.getElementById('toast-container')
        };

        // --- Helpers ---
        const showLoader = () => els.loader.classList.remove('hidden');
        const hideLoader = () => els.loader.classList.add('hidden');
        const getTypeColor = (t) => (t === 'show' || t === 'episode') ? 'text-yellow-500' : 'text-[var(--primary)]';
        const getBorderColor = (t) => (t === 'show' || t === 'episode') ? 'border-yellow-500' : 'border-[var(--primary)]';
        const getBgColor = (t) => (t === 'show' || t === 'episode') ? 'bg-yellow-500' : 'bg-[var(--primary)]';

        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const showToast = (msg, type = 'success') => {
            const toast = document.createElement('div');
            const colors = type === 'success' 
                ? 'bg-green-900/90 border-green-500 text-white shadow-[0_0_20px_rgba(34,197,94,0.3)]' 
                : 'bg-red-900/90 border-red-500 text-white shadow-[0_0_20px_rgba(239,68,68,0.3)]';
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
            
            toast.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 md:bottom-10 md:right-10 md:left-auto md:translate-x-0 flex items-center gap-4 px-6 py-4 rounded-xl border ${colors} shadow-2xl z-[100] animate-fade backdrop-blur-md min-w-[300px] justify-center md:justify-start`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} text-2xl"></i>
                <div class="flex flex-col">
                    <span class="font-bold text-lg">${type === 'success' ? 'Success!' : 'Error'}</span>
                    <span class="text-sm opacity-90">${msg}</span>
                </div>
            `;
            
            toast.onclick = () => toast.remove();
            document.body.appendChild(toast);
            setTimeout(() => { 
                toast.style.transition = 'all 0.5s ease';
                toast.style.opacity = '0'; 
                toast.style.transform = 'translate(-50%, 20px)'; 
                setTimeout(()=>toast.remove(), 500); 
            }, 3000);
        };

        // --- NEW: Custom List Logic ---
        window.openAddToList = async (traktId, type) => {
            currentItemForList = { ids: { trakt: traktId }, type: type };
            const modal = document.getElementById('list-modal');
            const content = document.getElementById('list-modal-content');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-2 border-[var(--primary)] border-t-transparent"></div></div>';
            
            try {
                const lists = await fetchDirect(`/users/me/lists`);
                if(lists.length === 0) {
                    content.innerHTML = '<p class="text-gray-500 text-center">No custom lists found.</p>';
                    return;
                }
                content.innerHTML = lists.map(l => `
                    <button onclick="window.saveToList('${l.ids.trakt}')" class="w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-[var(--primary)] hover:text-white transition flex justify-between items-center group">
                        <span class="font-bold text-sm">${l.name}</span>
                        <span class="text-xs bg-black/30 px-2 py-1 rounded group-hover:bg-white/20">${l.item_count}</span>
                    </button>
                `).join('');
            } catch(e) {
                content.innerHTML = '<p class="text-red-500 text-center">Failed to load lists.</p>';
            }
        };

        window.saveToList = async (listId) => {
            if(!currentItemForList) return;
            showLoader();
            document.getElementById('list-modal').classList.add('hidden');
            try {
                const type = currentItemForList.type;
                const payload = {
                    [type === 'episode' ? 'episodes' : (type === 'show' ? 'shows' : 'movies')]: [currentItemForList]
                };
                
                await fetch(`${TRAKT_API_URL}/users/me/lists/${listId}/items`, {
                    method: 'POST', headers: traktHeader(), body: JSON.stringify(payload)
                });
                showToast('Added to list!');
            } catch(e) { showToast('Failed to add', 'error'); }
            hideLoader();
        };

        // --- NEW: Fix Navigation Buttons ---
        window.navigateEpisode = async (showId, currentSeason, targetNumber) => {
            showLoader();
            try {
                if (targetNumber > 0) {
                    const ep = await fetchDirect(`/shows/${showId}/seasons/${currentSeason}/episodes/${targetNumber}`);
                    location.hash = `#detail/episode/${ep.ids.trakt}`;
                } else if (targetNumber <= 0 && currentSeason > 1) {
                    const prevSeasonData = await fetchDirect(`/shows/${showId}/seasons/${currentSeason - 1}?extended=full`);
                    const lastEpNum = prevSeasonData.episode_count;
                    const ep = await fetchDirect(`/shows/${showId}/seasons/${currentSeason - 1}/episodes/${lastEpNum}`);
                    location.hash = `#detail/episode/${ep.ids.trakt}`;
                } else {
                    showToast('No previous episodes', 'error');
                }
            } catch (e) {
                showToast('Episode not found', 'error');
            }
            hideLoader();
        };

        function getImage(item, typeOverride = null, preferLandscape = false) {
            const type = typeOverride || item.type;
            const data = (type && item[type]) ? item[type] : item;
            const extract = (val) => {
                if (!val) return null;
                if (Array.isArray(val)) return extract(val[0]);
                if (typeof val === 'string') return val;
                return null;
            };

            if (!data.images) return PLACEHOLDER_IMG;
            let url = null;

            if (preferLandscape) {
                if (type === 'episode') {
                    url = extract(data.images.screenshot?.medium) || extract(data.images.screenshot?.full);
                } else {
                    url = extract(data.images.fanart?.medium) || extract(data.images.fanart?.full);
                }
                if (!url) url = extract(data.images.thumb?.full);
            }

            if (!url) {
                if (type === 'episode') {
                    url = extract(data.images.screenshot?.medium) || extract(data.images.screenshot?.full) || extract(data.images.screenshot);
                } else if (type === 'person') {
                      url = extract(data.images.headshot?.medium) || extract(data.images.headshot?.full) || extract(data.images.headshot);
                } else {
                    url = extract(data.images.poster?.medium) || extract(data.images.poster?.full) || extract(data.images.poster);
                }
            }
            
            if (!url) url = extract(data.images.thumb);
            if (!url) url = extract(data.images.fanart);
            
            if (!url) return PLACEHOLDER_IMG;
            if (!url.startsWith('http') && !url.startsWith('//')) return `https://${url}`;
            return url;
        }

        // --- Card Component ---
        const createCardHtml = (item, typeOverride = null) => {
            const type = typeOverride || item.type;
            const data = item[type] || item;
            const img = getImage(data);
            const typeColor = getTypeColor(type);
            const targetId = data.ids.trakt;
            const myRating = userRatings.get(parseInt(data.ids.trakt));
            const ratingHtml = myRating 
                ? `<span class="text-green-400 font-bold flex items-center gap-1"><i class="fa-solid fa-user-check"></i> ${myRating}</span>`
                : `<span class="text-white/80 flex items-center gap-1"><i class="fa-solid fa-star text-yellow-500"></i> ${(data.rating || 0).toFixed(1)}</span>`;

            return `
            <div class="group relative card rounded-xl overflow-hidden shadow-lg hover:shadow-2xl hover:scale-[1.02] transition duration-300 cursor-pointer border border-gray-800" onclick="location.hash='#detail/${type}/${targetId}'">
                <div class="aspect-[2/3] relative bg-gray-800">
                    <img src="${img}" class="w-full h-full object-cover object-center transition duration-500 group-hover:opacity-60" loading="lazy" onerror="this.src='${PLACEHOLDER_IMG}'">
                    <div class="absolute inset-0 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                        <span class="${getBgColor(type)} text-white px-4 py-2 rounded-full font-bold text-sm shadow-lg mb-2 transform translate-y-4 group-hover:translate-y-0 transition">View Details</span>
                    </div>
                    <div class="absolute top-2 right-2 bg-black/70 px-2 py-1 rounded-md text-xs font-bold backdrop-blur-md border border-white/10 shadow-sm">
                        ${ratingHtml}
                    </div>
                </div>
                <div class="p-4 border-t border-gray-800">
                    <h3 class="font-bold text-sm truncate text-gray-100 group-hover:${typeColor} transition-colors" title="${data.title}">${data.title}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-400 font-medium">${data.year || 'N/A'}</p>
                        <p class="text-[10px] ${typeColor} border ${getBorderColor(type)} px-1.5 py-0.5 rounded uppercase font-bold tracking-wide opacity-70">${type}</p>
                    </div>
                </div>
            </div>`;
        };

        // --- API & AUTH RECOVERY ---
        const traktHeader = () => ({ 'Content-Type': 'application/json', 'trakt-api-version': '2', 'trakt-api-key': TRAKT_CLIENT_ID, 'Authorization': `Bearer ${traktAccessToken}` });

        const handleAuthError = () => {
            if (isAuthErrorHandling) return;
            isAuthErrorHandling = true;
            showToast('Trakt Session Expired! Redirecting...', 'error');
            setTimeout(() => {
                if(confirm("Your Trakt connection has expired. Click OK to re-connect.")) {
                    const authUrl = `https://trakt.tv/oauth/authorize?response_type=token&client_id=${TRAKT_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
                    window.location.href = authUrl;
                } else {
                    isAuthErrorHandling = false; 
                }
            }, 1000);
        };

        async function fetchDirect(endpoint) {
            if (!traktAccessToken) { handleAuthError(); throw new Error("No Token"); }
            const res = await fetch(`${TRAKT_API_URL}${endpoint}`, { headers: traktHeader() });
            
            if (res.status === 401) {
                handleAuthError();
                throw new Error('API Error 401: Unauthorized');
            }
            if (!res.ok) throw new Error('API Error ' + res.status);
            return await res.json();
        }

        async function fetchSmart(endpoint, renderFn, cacheKey = null) {
            const key = cacheKey || `trakt_cache_${endpoint}`;
            const cached = localStorage.getItem(key);
            if (cached) { try { renderFn(JSON.parse(cached), true); } catch(e){} } else showLoader();
            try {
                const freshData = await fetchDirect(endpoint); 
                if (JSON.stringify(freshData) !== cached) {
                    localStorage.setItem(key, JSON.stringify(freshData));
                    renderFn(freshData, false);
                }
            } catch (e) { 
                if(!cached && e.message !== 'API Error 401: Unauthorized') showToast("Connection error", 'error'); 
            } 
            finally { if(!cached) hideLoader(); }
        }

        async function syncUserRatings() {
            try {
                // ADDED: fetchDirect('/sync/ratings/episodes')
                const [movies, shows, episodes] = await Promise.all([ 
                    fetchDirect('/sync/ratings/movies'), 
                    fetchDirect('/sync/ratings/shows'),
                    fetchDirect('/sync/ratings/episodes') 
                ]);
                
                userRatings.clear();
                movies.forEach(r => userRatings.set(r.movie.ids.trakt, r.rating));
                shows.forEach(r => userRatings.set(r.show.ids.trakt, r.rating));
                
                // ADDED: Map episode ratings to your storage
                episodes.forEach(r => userRatings.set(r.episode.ids.trakt, r.rating));
            } catch(e) { console.warn("Could not sync ratings", e); }
        }

        // --- Renderers ---
        function renderGrid(title, items, append = false, containerId = 'content') {
            const gridHtml = `${!append && title ? `<h2 class="text-2xl font-bold mb-6 mt-8 px-2 border-l-4 border-[var(--primary)] animate-fade">${title}</h2>` : ''}<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6 mb-8 animate-fade">${items.map(item => createCardHtml(item)).join('')}</div>`;
            const container = document.getElementById(containerId) || els.content;
            if (append) container.insertAdjacentHTML('beforeend', gridHtml); else container.innerHTML = gridHtml;
        }

        async function renderDashboard() {
            els.content.innerHTML = `
                <div class="mb-8 p-6 md:p-8 rounded-3xl bg-gradient-to-br from-[var(--primary)] to-purple-900 text-white shadow-2xl relative overflow-hidden animate-fade">
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                        <div>
                            <h1 class="text-3xl md:text-4xl font-bold mb-2">Welcome Back!</h1>
                            <p class="opacity-90 text-lg">Your personal media tracking hub.</p>
                        </div>
                        <div id="quick-stats" class="flex gap-4 md:gap-6 text-center bg-black/20 p-4 rounded-xl backdrop-blur-md w-full md:w-auto justify-around md:justify-start"></div>
                    </div>
                    <i class="fa-solid fa-chart-line absolute -bottom-6 -right-6 text-[8rem] md:text-[10rem] opacity-10 rotate-12"></i>
                </div>
                <div id="up-next-container" class="mb-12 hidden animate-fade"></div>
                <div id="last-watched-container" class="mb-12 hidden animate-fade"></div>
                <div id="calendar-container" class="mb-12 hidden animate-fade"></div>
                <div id="trending-container"></div>
            `;
            loadUpNext();
            loadLastWatched();
            loadCalendar();
            fetchSmart('/movies/trending?extended=images', (movies) => {
                fetchSmart('/shows/trending?extended=images', (shows) => {
                    const combined = [...movies.map(m=>({...m, type:'movie'})), ...shows.map(s=>({...s, type:'show'}))].sort(()=>0.5-Math.random());
                    renderGrid('Trending Now', combined, false, 'trending-container');
                }, 'cache_shows_trending');
            }, 'cache_movies_trending');
            try {
                const stats = await fetchDirect('/users/me/stats');
                document.getElementById('quick-stats').innerHTML = `<div><p class="text-2xl font-bold">${stats.movies.watched}</p><p class="text-xs uppercase opacity-75">Movies</p></div><div><p class="text-2xl font-bold">${stats.episodes.watched}</p><p class="text-xs uppercase opacity-75">Episodes</p></div><div><p class="text-2xl font-bold">${Math.round(stats.network.friends)}</p><p class="text-xs uppercase opacity-75">Mutuals</p></div>`;
            } catch(e){}
        }

        async function loadLastWatched() {
            const container = document.getElementById('last-watched-container');
            try {
                const history = await fetchDirect('/sync/history?limit=6&extended=images');
                if (!history.length) return;
                const grid = history.map(h => {
                    const type = h.type;
                    const data = h[type];
                    const img = getImage(data, type === 'episode' ? 'episode' : 'movie', true);
                    const title = type === 'episode' ? `${h.show.title}: ${h.episode.title}` : h.movie.title;
                    const subTitle = type === 'episode' ? `S${h.episode.season}E${h.episode.number}` : h.movie.year;
                    const targetHash = type === 'episode' ? `#detail/episode/${h.episode.ids.trakt}` : `#detail/movie/${h.movie.ids.trakt}`;
                    const dateObj = new Date(h.watched_at);
                    const dateTimeDisplay = `${dateObj.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})} @ ${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

                    return `
                        <div class="relative card rounded-xl overflow-hidden shadow-lg border border-gray-800 group cursor-pointer" onclick="location.hash='${targetHash}'">
                            <div class="aspect-video relative">
                                <img src="${img}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" onerror="this.src='${PLACEHOLDER_IMG}'">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-4 w-full">
                                    <h4 class="text-white font-bold truncate shadow-black drop-shadow-md text-sm md:text-base">${title}</h4>
                                    <div class="flex items-center justify-between mt-1">
                                        <span class="text-xs text-gray-300 font-mono">${subTitle}</span>
                                        <span class="text-[10px] bg-[var(--primary)] text-white px-1.5 py-0.5 rounded font-bold uppercase">${type}</span>
                                    </div>
                                    <div class="mt-2 text-[10px] text-gray-400 font-montserrat border-t border-gray-700 pt-1 flex items-center">
                                        <i class="fa-regular fa-clock mr-1 text-[var(--primary)]"></i> ${dateTimeDisplay}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                container.innerHTML = `<h2 class="text-2xl font-bold mb-6 px-2 border-l-4 border-purple-500">Recently Watched</h2><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">${grid}</div>`;
                container.classList.remove('hidden');
            } catch (e) { console.error("Last Watched Error", e); }
        }

        async function loadCalendar() {
            const container = document.getElementById('calendar-container');
            try {
                const today = new Date().toISOString().split('T')[0];
                const calendar = await fetchDirect(`/calendars/my/shows/${today}/7?extended=images`);
                if(calendar.length > 0) {
                    container.innerHTML = `<h2 class="text-2xl font-bold mb-6 px-2 border-l-4 border-green-500">Airing This Week</h2><div class="flex gap-4 overflow-x-auto pb-4 hide-scroll">${calendar.map(item => `<div class="flex-shrink-0 w-64 card p-4 rounded-xl border border-gray-700 hover:border-green-500 transition cursor-pointer" onclick="location.hash='#detail/episode/${item.episode.ids.trakt}'"><div class="flex gap-3 mb-3"><img src="${getImage(item.show)}" class="w-12 h-16 object-cover rounded shadow"><div><p class="font-bold text-sm text-green-400">${new Date(item.first_aired).toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'})}</p><p class="font-bold text-sm leading-tight line-clamp-2 w-40 mb-1">${item.show.title}</p><p class="text-xs text-gray-500">S${item.episode.season}E${item.episode.number}</p></div></div><p class="text-xs text-gray-300 truncate">${item.episode.title}</p></div>`).join('')}</div>`;
                    container.classList.remove('hidden');
                }
            } catch(e){}
        }

        window.rateDirect = async (id, type, rating) => {
            event.stopPropagation();
            showLoader();
            try {
                const ids = { ids: { trakt: id } };
                const rootKey = type === 'episode' ? 'episodes' : 'movies';
                const payloadLog = { [rootKey]: [{ ...ids, watched_at: new Date().toISOString() }] };
                const payloadRate = { [rootKey]: [{ ...ids, rating: parseInt(rating), rated_at: new Date().toISOString() }] };
                await fetch(`${TRAKT_API_URL}/sync/history`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadLog) });
                await fetch(`${TRAKT_API_URL}/sync/ratings`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadRate) });
                showToast(`Rated ${rating}/10 & Logged!`);
                userRatings.set(id, parseInt(rating)); 
                loadUpNext();
            } catch(e) { showToast('Action failed', 'error'); } 
            hideLoader();
        }
        
        async function loadUpNext() {
            const container = document.getElementById('up-next-container');
            try {
                const watchedShows = await fetchDirect('/sync/watched/shows?limit=10&extended=noseasons');
                if (!watchedShows.length) return;
                const uniqueShowIds = watchedShows.slice(0, 3).map(s => s.show.ids.trakt);
                const nextEpisodes = [];
                await Promise.all(uniqueShowIds.map(async (id) => {
                    try {
                        const progress = await fetchDirect(`/shows/${id}/progress/watched?hidden=false&specials=false&count_specials=false&extended=full`);
                        if (progress.next_episode) {
                            const showTitle = watchedShows.find(s => s.show.ids.trakt == id).show.title;
                            nextEpisodes.push({ type: 'episode', show: { title: showTitle, ids: { trakt: id } }, episode: progress.next_episode, ids: progress.next_episode.ids, title: `${progress.next_episode.season}x${progress.next_episode.number}: ${progress.next_episode.title}`, images: progress.next_episode.images });
                        }
                    } catch (err) {}
                }));
                nextEpisodes.sort((a, b) => uniqueShowIds.indexOf(a.show.ids.trakt) - uniqueShowIds.indexOf(b.show.ids.trakt));

                if (nextEpisodes.length > 0) {
                    container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 px-2 border-l-4 border-blue-500">Continue Watching</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${nextEpisodes.map(ep => {
                        const rateBtns = Array.from({length: 10}, (_, i) => 10 - i).map(n => 
                            `<button onclick="rateDirect(${ep.ids.trakt}, 'episode', ${n})" class="block w-full text-left px-4 py-4 h-12 hover:bg-[var(--primary)] text-sm font-bold text-gray-300 hover:text-white transition flex justify-between items-center border-b border-gray-700 last:border-0 active:bg-[var(--primary)]">
                                <span>${n}</span> <i class="fa-solid fa-star text-[10px] text-yellow-500"></i>
                             </button>`
                        ).join('');

                        return `
                        <div class="card p-0 rounded-xl flex overflow-visible border border-gray-700 hover:border-blue-500 transition cursor-pointer shadow-lg group relative" onclick="location.hash='#detail/episode/${ep.ids.trakt}'">
                            <div class="w-1/3 relative overflow-hidden rounded-l-xl">
                                <img src="${getImage(ep, 'episode')}" class="w-full h-full object-cover" onerror="this.src='${PLACEHOLDER_IMG}'">
                                <div class="absolute inset-0 bg-black/30 group-hover:bg-transparent transition"></div>
                            </div>
                            <div class="w-2/3 p-4 flex flex-col justify-center bg-[var(--card)] rounded-r-xl">
                                <h4 class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-1">Up Next</h4>
                                <h3 class="font-bold text-lg leading-tight mb-1 line-clamp-1 text-white">${ep.show.title}</h3>
                                <p class="text-gray-400 text-sm mb-4">S${ep.episode.season} E${ep.episode.number} - ${ep.episode.title}</p>
                                <div class="mt-auto">
                                    <div class="relative group/rate w-full" onclick="event.stopPropagation()">
                                        <button class="w-full bg-[var(--primary)] hover:bg-red-700 text-white font-bold py-2 rounded-lg transition shadow-md flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-star text-yellow-300"></i> Rate & Mark Watched Now
                                        </button>
                                        <div class="absolute bottom-full left-0 right-0 mb-2 hidden group-hover/rate:flex flex-col bg-gray-900 border border-gray-700 rounded-lg shadow-2xl z-50 max-h-64 overflow-y-auto hide-scroll">
                                            ${rateBtns}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                    </div>`;
                    container.classList.remove('hidden');
                }
            } catch (e) { console.error("Up Next Error", e); }
        }

        async function renderProgress() {
            els.content.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Your Progress</h1>
                <div class="card p-6 rounded-2xl mb-10 border border-gray-800 shadow-xl">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-simple text-[var(--primary)]"></i> Watch Activity (Last 7 Days)</h2>
                    <div class="h-64 relative w-full"><canvas id="activityChart"></canvas></div>
                </div>
                <h2 class="text-2xl font-bold mb-6 border-l-4 border-yellow-500 px-2">Show Progress</h2>
                <div id="progress-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade"></div>
            `;
            showLoader();
            try {
                const today = new Date();
                const historyPromises = [];
                const labels = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date(today); d.setDate(today.getDate() - i);
                    labels.push(d.toLocaleDateString(undefined, {weekday:'short'}));
                    historyPromises.push(fetchDirect(`/sync/history?start_at=${d.toISOString().split('T')[0]}T00:00:00.000Z&end_at=${d.toISOString().split('T')[0]}T23:59:59.000Z&limit=100`));
                }
                const dailyData = await Promise.all(historyPromises);
                const chartData = dailyData.map(d => d.length);
                if(progressChartInstance) progressChartInstance.destroy();
                const ctx = document.getElementById('activityChart').getContext('2d');
                progressChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Items', data: chartData, backgroundColor: '#ed2224', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af', precision: 0 } }, x: { grid: { display: false }, ticks: { color: '#9ca3af' } } } } } );

                const watchedShows = await fetchDirect('/sync/watched/shows?extended=noseasons');
                watchedShows.sort((a,b) => new Date(b.last_watched_at) - new Date(a.last_watched_at));
                const topShows = watchedShows.slice(0, 12);
                const cards = await Promise.all(topShows.map(async (item) => {
                    try {
                        const showInfo = await fetchDirect(`/shows/${item.show.ids.trakt}?extended=full,images`);
                        const aired = showInfo.aired_episodes || 0;
                        const percent = aired > 0 ? Math.min(100, Math.round((item.plays / aired) * 100)) : 0;
                        const img = getImage(showInfo, 'show', true);
                        return `<div class="card rounded-xl overflow-hidden border border-gray-800 hover:border-yellow-500 transition cursor-pointer group relative" onclick="location.hash='#detail/show/${showInfo.ids.trakt}'"><div class="h-32 relative"><img src="${img}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition" onerror="this.src='${PLACEHOLDER_IMG}'"><div class="absolute inset-0 bg-gradient-to-t from-[var(--card)] to-transparent"></div><div class="absolute bottom-2 left-4"><h3 class="font-bold text-lg leading-tight shadow-black drop-shadow-md truncate w-64">${showInfo.title}</h3><p class="text-xs text-gray-400">Watched ${item.plays} of ${aired}</p></div><div class="absolute top-2 right-2 font-bold text-xl text-yellow-500 shadow-black drop-shadow-md">${percent}%</div></div><div class="px-4 pb-4 pt-1"><div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden"><div class="bg-[var(--primary)] h-full transition-all duration-1000" style="width: ${percent}%"></div></div><p class="text-[10px] text-gray-500 mt-2 text-right">Last watched: ${new Date(item.last_watched_at).toLocaleDateString()}</p></div></div>`;
                    } catch(e) { return ''; }
                }));
                document.getElementById('progress-list').innerHTML = cards.join('');
            } catch(e) { console.error(e); } hideLoader();
        }

        async function renderDetail(type, id, initialSeason = null) {
            showLoader(); els.content.innerHTML = '';
            try {
                const noteKey = `${type}_${id}`;
                const isEpisode = type === 'episode';
                
                let item, notes, history = [], related = [], showInfo = null, people = null;
                let showProgress = null; 
                
                if (isEpisode) {
                    const searchResults = await fetchDirect(`/search/trakt/${id}?type=episode&extended=full,images`);
                    if(searchResults && searchResults[0]) {
                        item = searchResults[0].episode;
                        showInfo = searchResults[0].show;
                    } else { throw new Error('Episode not found'); }
                    const userData = await fetchDirect(`/episodes/${id}?extended=user_data`);
                    item.user_rating = userData.user_rating;
                    item.user_data = userData.user_data;
                    history = await fetchDirect(`/users/me/history/episodes/${id}?limit=20`);
                } else {
                    [item, notes, history, related, people] = await Promise.all([
                        fetchDirect(`/${type}s/${id}?extended=full,images,user_data`),
                        getDoc(doc(db, `users/${currentUser.uid}/notes`, noteKey)),
                        (type === 'movie' ? fetchDirect(`/users/me/history/movies/${id}?limit=20`) : []),
                        fetchDirect(`/${type}s/${id}/related?limit=5&extended=images`),
                        fetchDirect(`/${type}s/${id}/people?extended=images`) 
                    ]);
                }
                if(isEpisode) notes = await getDoc(doc(db, `users/${currentUser.uid}/notes`, noteKey));

                const userNote = notes.exists() ? notes.data().text : '';
                const myRating = item.user_rating;
                const isWatched = (item.user_data?.plays > 0) || (history.length > 0);
                const titleText = isEpisode ? `${item.season}x${item.number}: ${item.title}` : item.title;
                const fullTitle = isEpisode ? `${showInfo.title}: ${item.title}` : item.title;
                const runtimeStr = item.runtime ? `${Math.floor(item.runtime/60)}h ${item.runtime%60}m` : 'N/A';
                
                const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
                const genresHtml = item.genres ? item.genres.map(g => {
                    const val = typeof g === 'string' ? g : g.name; 
                    return `<span class="bg-gray-800 border border-gray-700 text-xs px-2 py-1 rounded-md text-gray-300">${capitalize(val)}</span>`;
                }).join(' ') : '';

                const cert = item.certification || 'NR';
                const network = item.network || (item.production_countries ? item.production_countries[0]?.name : 'N/A');
                const trailerUrl = item.trailer ? (item.trailer.includes('youtube') ? item.trailer : null) : null;
                const language = item.language ? item.language.toUpperCase() : 'EN';
                const studios = item.production_companies ? item.production_companies.slice(0,2).map(c => c.name).join(', ') : 'N/A';
                let director = 'N/A';
                if(people && people.crew && people.crew.directing) {
                    director = people.crew.directing[0]?.person?.name || 'N/A';
                }

                // NEW: Stream Link
                const watchLink = `https://trakt.tv/${type === 'episode' ? 'shows' : type + 's'}/${id}/watchnow`;

                const watchedBadge = isWatched 
                    ? `<span class="bg-green-500/20 text-green-400 border border-green-500/50 px-3 py-1 rounded-md text-sm font-bold flex items-center shadow-[0_0_15px_rgba(74,222,128,0.2)]"><i class="fa-solid fa-circle-check mr-2"></i> Watched</span>`
                    : `<span class="bg-gray-800 text-gray-400 border border-gray-700 px-3 py-1 rounded-md text-sm font-bold flex items-center"><i class="fa-regular fa-circle mr-2"></i> Not Watched</span>`;

                const myRatingHtml = myRating 
                    ? `<span class="bg-yellow-500/20 text-yellow-500 border border-yellow-500/50 px-3 py-1 rounded-md text-sm font-bold flex items-center shadow-[0_0_15px_rgba(234,179,8,0.2)]"><i class="fa-solid fa-star mr-2"></i> ${myRating}</span>`
                    : `<button class="bg-gray-800 hover:bg-white hover:text-black border border-gray-700 px-3 py-1 rounded-md text-sm font-bold flex items-center transition" onclick="document.querySelector('.scrobble-btn').click()"><i class="fa-regular fa-star mr-2"></i> Rate</button>`;

                let historyHtml = '';
                if (history.length > 0) {
                      historyHtml = `<div class="bg-gray-900/50 p-5 rounded-2xl border border-gray-800 mb-8 backdrop-blur-sm animate-fade"><h3 class="text-xs font-bold text-gray-500 mb-4 uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> Watch History</h3><div class="space-y-2">${history.map(h => `<div class="history-row flex justify-between items-center text-sm border-b border-gray-800/50 pb-2 last:border-0 last:pb-0 hover:bg-white/5 p-2 rounded transition"><div class="flex items-center gap-3"><span class="font-medium text-gray-200"><i class="fa-solid fa-calendar-day text-[var(--primary)] mr-2 opacity-70"></i> ${new Date(h.watched_at).toLocaleDateString()}</span><span class="text-gray-500 font-mono text-xs">${new Date(h.watched_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><div class="flex gap-2"><button class="text-xs bg-blue-900/30 text-blue-400 p-2 rounded hover:bg-blue-500 hover:text-white transition" onclick="window.editHistoryItem('${id}', '${fullTitle.replace(/'/g, "&apos;")}', '${type}', '${h.watched_at}')" title="Edit Date"><i class="fa-solid fa-pen"></i></button><button class="text-xs bg-red-900/30 text-red-400 p-2 rounded hover:bg-red-500 hover:text-white transition" onclick="window.deleteHistoryItem('${id}', '${type}', '${h.watched_at}', this)" title="Delete Entry"><i class="fa-solid fa-trash"></i></button></div></div>`).join('')}</div></div>`;
                }

                let castHtml = '';
                if (people && people.cast && people.cast.length > 0) {
                    castHtml = `
                    <h3 class="text-xs font-bold text-[var(--primary)] mb-4 uppercase tracking-widest mt-8">Top Cast</h3>
                    <div class="flex gap-4 overflow-x-auto pb-6 hide-scroll">
                        ${people.cast.slice(0, 10).map(person => {
                             const pImg = getImage(person.person, 'person'); 
                             return `
                             <div class="flex-shrink-0 w-28 group relative">
                                <div class="w-24 h-24 mx-auto rounded-full bg-gray-800 border-2 border-gray-700 overflow-hidden mb-3 shadow-lg group-hover:border-[var(--primary)] transition">
                                     <img src="${pImg}" class="w-full h-full object-cover" onerror="this.src='${PLACEHOLDER_IMG}'">
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-xs truncate text-white group-hover:text-[var(--primary)] transition">${person.person.name}</p>
                                    <p class="text-[10px] text-gray-500 truncate">${person.characters[0]}</p>
                                </div>
                             </div>`
                        }).join('')}
                    </div>`;
                }

                let html = `<div class="animate-fade max-w-6xl mx-auto">`;

                if (isEpisode) {
                    const bgImg = getImage(item, 'episode', true); 
                    html += `
                    <button onclick="history.back()" class="absolute top-24 left-4 z-20 text-sm bg-black/50 hover:bg-black/80 text-white px-4 py-2 rounded-full backdrop-blur-md transition"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="relative w-full min-h-[200px] h-auto rounded-3xl overflow-hidden shadow-2xl border border-gray-800 group mb-8 bg-black">
                        <img src="${bgImg}" class="w-full h-auto max-h-[60vh] object-contain mx-auto">
                        <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg)] via-transparent to-transparent pointer-events-none"></div>
                        <div class="nav-btn nav-prev" onclick="window.navigateEpisode('${showInfo.ids.trakt}', ${item.season}, ${item.number - 1})"><i class="fa-solid fa-chevron-left"></i></div>
                        <div class="nav-btn nav-next" onclick="window.navigateEpisode('${showInfo.ids.trakt}', ${item.season}, ${item.number + 1})"><i class="fa-solid fa-chevron-right"></i></div>
                        <div class="absolute bottom-0 left-0 p-6 md:p-10 w-full bg-gradient-to-t from-black via-black/50 to-transparent">
                            <h4 class="text-lg md:text-xl font-bold text-gray-300 mb-1 flex items-center gap-2">
                                <span class="bg-[var(--primary)] text-white px-2 py-0.5 rounded text-xs">EPISODE</span> ${showInfo.title}
                            </h4>
                            <h1 class="text-3xl md:text-5xl font-bold text-white mb-4 leading-tight shadow-black drop-shadow-md">${titleText}</h1>
                            <div class="flex flex-wrap items-center gap-3 text-sm font-medium">
                                <span class="bg-gray-800/80 backdrop-blur text-white px-3 py-1 rounded border border-gray-600">S${item.season} E${item.number}</span>
                                ${watchedBadge} ${myRatingHtml}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2">
                             <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-400 border-b border-gray-800 pb-4">
                                <span class="flex items-center"><i class="fa-regular fa-clock mr-2"></i> ${runtimeStr}</span>
                                <span class="flex items-center"><i class="fa-regular fa-calendar mr-2"></i> ${new Date(item.first_aired).toLocaleDateString()}</span>
                            </div>

                            <h3 class="text-xs font-bold text-[var(--primary)] mb-2 uppercase tracking-widest">Overview</h3>
                            <p class="text-lg text-gray-300 leading-relaxed mb-8">${item.overview || 'No overview available.'}</p>
                            ${historyHtml}
                            <div class="flex flex-col sm:flex-row gap-4 mb-8">
    <button class="scrobble-btn bg-[var(--primary)] hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 flex-1 justify-center transition" data-json='${JSON.stringify({ids: item.ids, title: fullTitle, type: 'episode'}).replace(/'/g, "&apos;")}' data-type="show"><i class="fa-solid fa-check"></i> Log / Rate Again</button>
    
    <button onclick="window.openAddToList('${item.ids.trakt}', 'episode')" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-bold border border-gray-600 transition flex items-center justify-center" title="Add to List"><i class="fa-solid fa-list-ul"></i></button>
    
    <button onclick="location.hash='#detail/show/${showInfo.ids.trakt}/season/${item.season}'" class="bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-bold border border-gray-700 transition flex items-center justify-center gap-2">Season ${item.season}</button>
</div>
                             <div class="bg-[var(--card)] p-6 rounded-2xl border border-gray-700 shadow-lg mb-8">
                                <h3 class="font-bold mb-3 flex items-center"><i class="fa-solid fa-note-sticky mr-2 text-yellow-500"></i> Notes</h3>
                                <textarea id="note-input" class="w-full bg-[var(--bg)] border border-gray-700 rounded-lg p-3 text-sm outline-none resize-none" rows="2" placeholder="Private note...">${userNote}</textarea>
                                <div class="flex justify-end mt-3"><button id="save-note" class="text-xs bg-gray-700 hover:bg-[var(--primary)] text-white px-5 py-2 rounded-md transition font-bold shadow">Save</button></div>
                            </div>
                        </div>
                        <div class="md:col-span-1 space-y-6"></div>
                    </div>`;

                } else {
                    const img = getImage(item, null, true);
                    html += `
                    <button onclick="history.back()" class="mb-6 text-sm text-gray-400 hover:text-white flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition w-fit"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="flex flex-col md:flex-row gap-8 mb-12">
                        <div class="md:w-1/3 lg:w-1/4 flex-shrink-0">
                            <div class="rounded-2xl overflow-hidden shadow-2xl relative group border border-gray-800">
                                <img src="${img}" class="w-full object-cover">
                                ${type === 'movie' ? `<div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center backdrop-blur-sm"><button class="scrobble-btn ${getBgColor(type)} text-white px-8 py-3 rounded-full font-bold transform scale-90 group-hover:scale-100 transition shadow-xl" data-json='${JSON.stringify({ids: item.ids, title: item.title, type: type}).replace(/'/g, "&apos;")}' data-type="${type}"><i class="fa-solid fa-check mr-2"></i> Log Movie</button></div>` : ''}
                            </div>
                            
                            <div class="mt-6 flex flex-col gap-3">
    <a href="${watchLink}" target="_blank" class="w-full text-center bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-sm transition shadow-lg flex items-center justify-center gap-2">
        <i class="fa-solid fa-play"></i> Stream Now
    </a>

    <button onclick="window.openAddToList('${item.ids.trakt}', '${type}')" class="w-full text-center bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-bold text-xs transition border border-gray-600 flex items-center justify-center gap-2">
        <i class="fa-solid fa-list-ul"></i> Add to List
    </button>

    ${item.homepage ? `<a href="${item.homepage}" target="_blank" class="w-full text-center bg-gray-800 hover:bg-gray-700 text-gray-300 py-2 rounded-lg font-bold text-xs transition border border-gray-700">Official Website <i class="fa-solid fa-up-right-from-square ml-1"></i></a>` : ''}
    ${trailerUrl ? `<a href="${trailerUrl}" target="_blank" class="w-full text-center bg-red-900/20 hover:bg-red-900/40 text-red-500 py-2 rounded-lg font-bold text-xs transition border border-red-900/30"><i class="fa-brands fa-youtube mr-1"></i> Watch Trailer</a>` : ''}
</div>

                            <div class="mt-6 bg-[var(--card)] p-4 rounded-xl border border-gray-800 text-sm space-y-3">
                                <h4 class="font-bold text-gray-400 text-xs uppercase mb-2">Production Info</h4>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Director/Creator</span>
                                    <span class="text-gray-200 font-medium">${director}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Studio</span>
                                    <span class="text-gray-200 font-medium truncate max-w-[120px]" title="${studios}">${studios}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Language</span>
                                    <span class="text-gray-200 font-medium">${language}</span>
                                </div>
                                ${item.revenue ? `<div class="flex justify-between"><span class="text-gray-500">Revenue</span><span class="text-green-400 font-medium">$${(item.revenue/1000000).toFixed(1)}M</span></div>` : ''}
                            </div>
                        </div>
                        <div class="md:w-2/3 lg:w-3/4">
                            <h1 class="text-4xl md:text-6xl font-bold mb-2 leading-tight tracking-tight">${item.title}</h1>
                            ${item.tagline ? `<p class="text-xl text-gray-400 italic mb-4">"${item.tagline}"</p>` : ''}
                            
                            ${type === 'show' ? await (async () => { try { showProgress = await fetchDirect(`/shows/${id}/progress/watched`); const percent = showProgress.aired > 0 ? Math.round((showProgress.completed / showProgress.aired) * 100) : 0; return `<div class="mb-6 bg-gray-800 rounded-full h-4 w-full overflow-hidden border border-gray-700 relative group"><div class="bg-gradient-to-r from-green-600 to-green-400 h-full transition-all duration-1000" style="width: ${percent}%"></div><div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md">${percent}% WATCHED</div></div>`; } catch(e){ return ''; } })() : ''}
                            
                            <div class="flex flex-wrap items-center gap-4 text-gray-300 mb-6 text-sm md:text-base font-medium">
                                <span class="bg-gray-800 px-3 py-1 rounded-md border border-gray-700 text-white">${item.year || 'N/A'}</span>
                                <span class="border border-gray-600 px-2 py-0.5 rounded text-xs uppercase text-gray-400">${cert}</span>
                                ${watchedBadge} ${myRatingHtml}
                                ${item.status ? `<span class="uppercase tracking-wider font-bold ${getTypeColor(type)} px-2 py-1 bg-gray-800 rounded text-xs">${item.status}</span>` : ''}
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 bg-gray-900/30 p-4 rounded-xl border border-gray-800/50 backdrop-blur-sm">
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Typical Runtime</p><p class="font-medium text-gray-300">${runtimeStr}</p></div>
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Network</p><p class="font-medium text-gray-300 truncate" title="${network}">${network}</p></div>
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Avg. Trakt Rating</p><p class="font-medium text-[var(--primary)]">${item.rating ? item.rating.toFixed(1) : '-'}/10</p></div>
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Total Trakt Votes</p><p class="font-medium text-gray-300">${item.votes || 0}</p></div>
                                <div class="col-span-2 md:col-span-4 border-t border-gray-800 mt-2 pt-2 flex flex-wrap gap-2 items-center">
                                    <span class="text-xs text-gray-500 uppercase font-bold mr-2">Genres:</span> ${genresHtml}
                                </div>
                            </div>

                            <h3 class="text-xs font-bold ${getTypeColor(type)} mb-2 uppercase tracking-widest">Overview</h3>
                            <p class="text-gray-300 text-lg leading-relaxed mb-6 max-w-3xl">${item.overview || 'No overview available.'}</p>
                            
                            ${castHtml}
                            ${historyHtml}
                            
                             <div class="bg-[var(--card)] p-6 rounded-2xl border border-gray-700 shadow-lg mb-8 mt-8">
                                <h3 class="font-bold mb-3 flex items-center"><i class="fa-solid fa-note-sticky mr-2 text-yellow-500"></i> Notes</h3>
                                <textarea id="note-input" class="w-full bg-[var(--bg)] border border-gray-700 rounded-lg p-3 text-sm outline-none resize-none" rows="2" placeholder="Your thoughts...">${userNote}</textarea>
                                <div class="flex justify-end mt-3"><button id="save-note" class="text-xs bg-gray-700 hover:bg-[var(--primary)] text-white px-5 py-2 rounded-md transition font-bold shadow">Save</button></div>
                            </div>
                        </div>
                    </div>
                    <div id="seasons-mount"></div>
                    ${related.length > 0 ? `<h2 class="text-2xl font-bold mb-6 mt-16 px-4 border-l-4 border-[var(--primary)]">You Might Also Like</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">${related.map(r => createCardHtml(r, type)).join('')}</div>` : ''}`;
                }

                html += `</div>`;
                els.content.innerHTML = html;

                const saveBtn = document.getElementById('save-note');
                if(saveBtn) saveBtn.onclick = async () => { 
                    saveBtn.innerText = 'Saving...';
                    await setDoc(doc(db, `users/${currentUser.uid}/notes`, noteKey), { text: document.getElementById('note-input').value, updatedAt: new Date() }, { merge: true }); 
                    saveBtn.innerText = 'Saved!'; setTimeout(()=>saveBtn.innerText='Save', 2000); showToast('Note saved'); 
                };

                if (type === 'show') {
                    const mount = document.getElementById('seasons-mount');
                    mount.innerHTML = `<div class="flex items-center gap-3 mb-6"><div class="animate-spin rounded-full h-6 w-6 border-2 border-yellow-500 border-t-transparent"></div> <span class="text-gray-400">Loading seasons...</span></div>`;
                    try {
                        const seasons = await fetchDirect(`/shows/${id}/seasons?extended=full,images`);
                        const mainShowPoster = getImage(item, null, true);
                        window.renderSeasonsGrid = () => { 
                            const validSeasons = seasons.filter(s => s.number > 0);
                            mount.innerHTML = `<h2 class="text-2xl font-bold mb-6 border-l-4 border-yellow-500 px-4">Seasons</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">${validSeasons.map(s => {
                                let sImg = getImage(s); if(sImg === PLACEHOLDER_IMG) sImg = mainShowPoster;
                                let isFullyWatched = false;
                                if(showProgress && showProgress.seasons) {
                                    const sp = showProgress.seasons.find(x => x.number === s.number);
                                    if(sp && sp.aired > 0 && sp.completed >= sp.aired) isFullyWatched = true;
                                }
                                const styleClasses = isFullyWatched ? "opacity-50 grayscale blur-[1px] hover:blur-0 hover:grayscale-0 hover:opacity-100 border-transparent" : "hover:border-yellow-500 border-transparent";
                                const checkIcon = isFullyWatched ? `<div class="absolute top-2 left-2 bg-green-500 text-black w-6 h-6 flex items-center justify-center rounded-full shadow-lg z-10"><i class="fa-solid fa-check text-xs"></i></div>` : '';
                                return `<div class="card rounded-xl overflow-hidden cursor-pointer border transition-all duration-300 group relative ${styleClasses}" onclick="window.loadEpisodes('${id}', '${s.number}')"><div class="aspect-[2/3] relative"><img src="${sImg}" class="w-full h-full object-cover" onerror="this.src='${PLACEHOLDER_IMG}'">${checkIcon}<div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded shadow">S${s.number}</div><div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center font-bold text-sm">View Episodes</div></div><div class="p-3 text-center"><h4 class="font-bold text-sm truncate">${s.title}</h4><p class="text-xs text-gray-500">${s.episode_count} Eps</p></div></div>`;
                            }).join('')}</div>`; 
                        };
                        window.renderSeasonsGrid();
                        window.loadEpisodes = async (showId, seasonNum) => {
                            mount.innerHTML = `<div class="flex items-center gap-3 mb-6"><div class="animate-spin rounded-full h-6 w-6 border-2 border-yellow-500 border-t-transparent"></div> <span class="text-gray-400">Loading Season ${seasonNum}...</span></div>`;
                            const episodes = await fetchDirect(`/shows/${showId}/seasons/${seasonNum}/episodes?extended=full,images,user_data`);
                            mount.innerHTML = `<div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold border-l-4 border-yellow-500 px-4">Season ${seasonNum}</h2><button onclick="window.renderSeasonsGrid()" class="text-sm text-gray-400 hover:text-white flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition"><i class="fa-solid fa-arrow-left"></i> Back to Seasons</button></div><div class="space-y-4">${episodes.map(ep => {
                                const epRating = ep.user_rating ? `<span class="text-green-400 text-xs font-bold ml-2 border border-green-500/50 px-1 rounded">You: ${ep.user_rating}</span>` : '';
                                return `<div class="card p-4 rounded-xl flex flex-col sm:flex-row gap-4 border border-gray-800 hover:border-gray-600 transition"><div class="sm:w-48 flex-shrink-0 relative cursor-pointer group" onclick="location.hash='#detail/episode/${ep.ids.trakt}'"><img src="${getImage(ep, 'episode')}" class="w-full h-32 object-cover rounded-lg shadow-md group-hover:opacity-80 transition" onerror="this.src='${PLACEHOLDER_IMG}'"><div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm px-2 py-1 rounded text-xs font-bold">Ep ${ep.number}</div></div><div class="flex-grow min-w-0 flex flex-col justify-between"><div><h4 class="font-bold text-lg text-gray-100 truncate hover:text-yellow-500 cursor-pointer transition" onclick="location.hash='#detail/episode/${ep.ids.trakt}'">${ep.title || 'Episode ' + ep.number}</h4><p class="text-gray-400 text-sm mt-1 line-clamp-2">${ep.overview || 'No description.'}</p></div><div class="flex items-center justify-between mt-4"><div><span class="text-xs text-gray-500"><i class="fa-solid fa-star text-yellow-500 mr-1"></i> ${ep.rating ? ep.rating.toFixed(1) : '-'}</span>${epRating}</div><button class="scrobble-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-bold shadow-md hover:shadow-yellow-900/40 flex items-center" data-json='${JSON.stringify({ids: ep.ids, title: `${item.title} ${seasonNum}x${ep.number}: ${ep.title}`, type: 'episode'}).replace(/'/g, "&apos;")}' data-type="show"><i class="fa-solid fa-check mr-2"></i> Log</button></div></div></div>`;
                            }).join('')}</div>`;
                            mount.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        };
                        if(initialSeason) { await window.loadEpisodes(id, initialSeason); }
                    } catch(e) { mount.innerHTML = `<p class="text-red-500">Failed to load seasons.</p>`; }
                }

            } catch(e) { console.error(e); showToast('Load error', 'error'); } 
            hideLoader();
        }

        // --- UPDATED: Render History with Filters & Grouping ---
        let currentHistoryFilter = 'all'; // State variable for filter

        window.setHistoryFilter = (filter) => {
            currentHistoryFilter = filter;
            renderHistory(1);
        };

        function renderHistory(page = 1) {
            if (page === 1) { 
                els.content.innerHTML = ''; 
                historyPage = 1; 
                // Added Filters UI
                els.content.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 mt-4 gap-4">
                    <h2 class="text-2xl font-bold">History</h2>
                    <div class="flex bg-gray-900 p-1 rounded-lg border border-gray-700">
                        <button onclick="window.setHistoryFilter('all')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'all' ? 'bg-[var(--primary)] text-white' : 'text-gray-400 hover:text-white'}">All</button>
                        <button onclick="window.setHistoryFilter('movies')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'movies' ? 'bg-[var(--primary)] text-white' : 'text-gray-400 hover:text-white'}">Movies</button>
                        <button onclick="window.setHistoryFilter('episodes')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'episodes' ? 'bg-[var(--primary)] text-white' : 'text-gray-400 hover:text-white'}">Episodes</button>
                    </div>
                </div>
                <div id="history-list-container" class="space-y-1 max-w-4xl mx-auto"></div>
                <div id="load-more-container" class="text-center mt-8 pb-8"></div>`;
            }
            
            isFetchingHistory = true; showLoader();
            
            let url = `/sync/history?limit=20&page=${page}&extended=images`;
            if (currentHistoryFilter !== 'all') url += `&type=${currentHistoryFilter}`;

            fetchSmart(url, (data, fromCache) => {
                 if (page === 1 && data.length === 0) {
                     document.getElementById('history-list-container').innerHTML = `<div class="text-center p-10 text-gray-500">No history found for this filter.</div>`;
                     hideLoader(); return;
                 }
                
                let lastDate = null;
                const listHtml = data.map(item => {
                    const type = item.type;
                    const navType = type === 'episode' ? 'episode' : 'movie';
                    const navId = type === 'episode' ? item.episode.ids.trakt : item.movie.ids.trakt;
                    const titleText = (type === 'episode') ? `<span class="text-gray-400 text-sm font-normal">${item.show.title}</span> <br> ${item.episode.season}x${item.episode.number}: <span class="text-gray-200">${item.episode.title}</span>` : item.movie.title;
                    const displayImageObj = type === 'episode' ? item.episode : item.movie;
                    const img = getImage(displayImageObj, type, true); 
                    const myRating = userRatings.get(parseInt(navId));
                    const rateDisplay = myRating ? `<span class="text-green-400 font-bold ml-auto text-xs"><i class="fa-solid fa-user-check"></i> ${myRating}</span>` : '';
                    
                    const wDate = new Date(item.watched_at);
                    const dateStr = wDate.toLocaleDateString();
                    const prettyDate = wDate.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
                    const timeStr = wDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    let headerHtml = '';
                    if (dateStr !== lastDate) {
                        const today = new Date().toLocaleDateString();
                        const yest = new Date(); yest.setDate(yest.getDate() - 1);
                        let label = prettyDate;
                        if (dateStr === today) label = "Today";
                        else if (dateStr === yest.toLocaleDateString()) label = "Yesterday";
                        
                        headerHtml = `<h3 class="text-xs font-bold text-[var(--primary)] uppercase tracking-widest mt-6 mb-2 ml-2 sticky top-20 z-10 bg-[var(--bg)]/90 backdrop-blur py-2 w-fit px-3 rounded-full border border-gray-800">${label}</h3>`;
                        lastDate = dateStr;
                    }

                    return `${headerHtml}
                    <div class="card p-3 rounded-xl flex items-center gap-4 hover:bg-[var(--card)] border border-transparent hover:border-gray-600 transition group relative animate-fade bg-[var(--card)]/40" onclick="location.hash='#detail/${navType}/${navId}'">
                        <div class="relative w-24 h-14 md:w-32 md:h-20 flex-shrink-0 overflow-hidden rounded-lg shadow-md bg-gray-800">
                            <img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='${PLACEHOLDER_IMG}'">
                            <div class="absolute bottom-0 right-0 bg-black/80 text-white text-[8px] px-1.5 py-0.5 rounded-tl font-bold uppercase tracking-wider">${type}</div>
                        </div>
                        <div class="flex-grow min-w-0 flex flex-col justify-center">
                            <div class="flex items-start">
                                <h3 class="font-bold text-sm md:text-base leading-tight cursor-pointer hover:text-[var(--primary)] transition mr-2 line-clamp-2">${titleText}</h3>
                                ${rateDisplay}
                            </div>
                            <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                                <span><i class="fa-solid fa-clock opacity-50 mr-1"></i> ${timeStr}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition px-2">
                             <button class="text-xs bg-red-900/20 text-red-400 p-2 rounded hover:bg-red-500 hover:text-white transition" onclick="event.stopPropagation(); window.deleteHistoryItem('${navId}', '${type}', '${item.watched_at}', this)" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
                
                document.getElementById('history-list-container').insertAdjacentHTML('beforeend', listHtml);
                
                const loadMoreContainer = document.getElementById('load-more-container');
                if (data.length === 20) {
                    loadMoreContainer.innerHTML = `<button id="btn-load-more" class="bg-gray-800 hover:bg-gray-700 text-white px-8 py-3 rounded-full font-bold transition shadow-lg border border-gray-600 hover:border-white">Load More</button>`;
                    document.getElementById('btn-load-more').onclick = () => { historyPage++; renderHistory(historyPage); };
                } else loadMoreContainer.innerHTML = `<p class="text-gray-600 text-sm italic opacity-50">End of history</p>`;
                
                isFetchingHistory = false; hideLoader();
            });
        }

        function renderSettings() { els.content.innerHTML = `<h1 class="text-3xl font-bold mb-6">Settings</h1><div class="grid gap-6 animate-fade"><div class="card p-8 rounded-2xl max-w-2xl border border-gray-800"><h2 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-file-export mr-3 text-[var(--primary)]"></i> Data Export</h2><p class="text-gray-400 mb-6">Download your entire listening/watching history as a CSV file for backup or analysis.</p><button id="export-btn" class="btn-primary px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-[var(--primary)]/30 transition">Export History to CSV</button></div><div class="card p-8 rounded-2xl max-w-2xl border border-gray-800"><h2 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-database mr-3 text-blue-500"></i> Storage</h2><p class="text-gray-400 mb-6">If images look broken or data is stale, try clearing the local cache.</p><button id="clear-cache-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition">Clear Local Cache</button></div></div>`; setTimeout(() => { const exportBtn = document.getElementById('export-btn'); const clearBtn = document.getElementById('clear-cache-btn'); if(exportBtn) exportBtn.onclick = async () => { showLoader(); try { const data = await fetchDirect('/sync/history?limit=10000'); if(!data.length) return showToast('No history', 'error'); const csv = "Title,Type,Year,TraktID,WatchedAt\n" + data.map(i => `${(i.type==='episode'?`${i.show.title}: ${i.episode.title}`:i.movie.title).replace(/,/g,'')},${i.type},${i.type==='episode'?i.show.year:i.movie.year},${i.type==='episode'?i.episode.ids.trakt:i.movie.ids.trakt},${i.watched_at}`).join("\n"); const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = "history.csv"; document.body.appendChild(link); link.click(); link.remove(); showToast('Exported'); } catch(e) { showToast('Export failed', 'error'); } hideLoader(); }; if(clearBtn) clearBtn.onclick = () => { localStorage.clear(); showToast('Cache Cleared! Refreshing...'); setTimeout(() => location.reload(), 1500); }; }, 100); }
        
        // --- LIBRARY RENDERERS (MERGED) ---
        function renderLibrary(activeTab = 'watchlist') {
            els.content.innerHTML = `
                <div class="flex items-center justify-between mb-8 mt-4 animate-fade">
                    <h2 class="text-2xl font-bold border-l-4 border-[var(--primary)] px-3">Your Library</h2>
                    <div class="flex bg-gray-900/50 p-1 rounded-lg border border-gray-700">
                        <button id="tab-wl" class="px-5 py-2 rounded-md text-sm font-bold transition ${activeTab === 'watchlist' ? 'bg-[var(--primary)] text-white shadow' : 'text-gray-400 hover:text-white'}" onclick="window.switchLib('watchlist')">Watchlist</button>
                        <button id="tab-lists" class="px-5 py-2 rounded-md text-sm font-bold transition ${activeTab === 'lists' ? 'bg-[var(--primary)] text-white shadow' : 'text-gray-400 hover:text-white'}" onclick="window.switchLib('lists')">Custom Lists</button>
                    </div>
                </div>
                <div id="lib-target"></div>
            `;
            
            // Helper to switch content without full page reload
            window.switchLib = (tab) => {
                const btnWl = document.getElementById('tab-wl');
                const btnLists = document.getElementById('tab-lists');
                
                if(tab === 'watchlist') {
                    btnWl.className = "px-5 py-2 rounded-md text-sm font-bold transition bg-[var(--primary)] text-white shadow";
                    btnLists.className = "px-5 py-2 rounded-md text-sm font-bold transition text-gray-400 hover:text-white";
                    renderWatchlist('added', 'lib-target');
                } else {
                    btnLists.className = "px-5 py-2 rounded-md text-sm font-bold transition bg-[var(--primary)] text-white shadow";
                    btnWl.className = "px-5 py-2 rounded-md text-sm font-bold transition text-gray-400 hover:text-white";
                    renderLists('lib-target');
                }
            };

            // Init the default tab
            if(activeTab === 'watchlist') renderWatchlist('added', 'lib-target');
            else renderLists('lib-target');
        }

        function renderWatchlist(sort = 'added', containerId = 'content') { 
            const container = document.getElementById(containerId) || els.content;
            // Only add headers/controls if we are rendering into a fresh container (not just updating grid)
            container.innerHTML = `<div class="flex justify-end mb-6 animate-fade"><select id="wl-sort" class="bg-gray-800 border border-gray-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-[var(--primary)]"><option value="added" ${sort==='added'?'selected':''}>Recently Added</option><option value="rank" ${sort==='rank'?'selected':''}>Rank</option><option value="title" ${sort==='title'?'selected':''}>Title</option><option value="released" ${sort==='released'?'selected':''}>Release Date</option><option value="runtime" ${sort==='runtime'?'selected':''}>Runtime</option></select></div><div id="wl-grid"></div>`; 
            
            showLoader(); 
            document.getElementById('wl-sort').onchange = (e) => renderWatchlist(e.target.value, containerId); 
            
            fetchSmart(`/sync/watchlist/movies?extended=images&sort=${sort},asc`, (movies) => { 
                fetchSmart(`/sync/watchlist/shows?extended=images&sort=${sort},asc`, (shows) => { 
                    let data = [...movies.map(m=>({...m, type:'movie'})), ...shows.map(s=>({...s, type:'show'}))]; 
                    if (sort === 'added' || sort === 'released') data.sort((a, b) => new Date(b[sort==='added'?'listed_at':'released']) - new Date(a[sort==='added'?'listed_at':'released'])); 
                    else if (sort === 'title') data.sort((a, b) => (a.movie||a.show).title.localeCompare((b.movie||b.show).title)); 
                    
                    if(data.length === 0) document.getElementById('wl-grid').innerHTML = `<div class="text-center p-20 text-gray-500 animate-fade"><i class="fa-solid fa-inbox text-6xl mb-4 opacity-50"></i><p>Your watchlist is empty.</p></div>`; 
                    else renderGrid('', data, false, 'wl-grid'); 
                    hideLoader(); 
                }, `cache_wl_shows_${sort}`); 
            }, `cache_wl_movies_${sort}`); 
        }

        async function renderLists(containerId = 'content') { 
            const container = document.getElementById(containerId) || els.content;
            container.innerHTML = ''; 
            showLoader(); 
            try { 
                const lists = await fetchDirect(`/users/me/lists?extended=full`); 
                if (lists.length === 0) container.innerHTML = `<div class="text-center p-20 text-gray-500"><i class="fa-solid fa-list-ul text-6xl mb-4 opacity-50"></i><p>You have no custom lists.</p></div>`; 
                else container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade">${lists.map(list => `<div class="card p-6 rounded-xl border border-gray-700 hover:border-purple-500 cursor-pointer transition group" onclick="location.hash='#lists/${list.ids.trakt}'"><div class="flex justify-between items-start mb-4"><h3 class="font-bold text-xl group-hover:text-purple-400 transition">${list.name}</h3><span class="bg-gray-800 text-xs px-2 py-1 rounded text-gray-400"><i class="fa-solid fa-layer-group mr-1"></i> ${list.item_count}</span></div><p class="text-gray-400 text-sm line-clamp-2 h-10 mb-4">${list.description || 'No description provided.'}</p><div class="flex items-center gap-4 text-xs text-gray-500"><span><i class="fa-solid fa-heart text-[var(--primary)] opacity-70"></i> ${list.likes}</span><span><i class="fa-solid fa-lock${list.privacy==='private'?'':'-open'}"></i> ${list.privacy}</span><span class="ml-auto text-purple-400 font-bold group-hover:translate-x-1 transition">View Items <i class="fa-solid fa-arrow-right"></i></span></div></div>`).join('')}</div>`; 
            } catch (e) { showToast('Could not load lists', 'error'); } 
            hideLoader(); 
        }

        async function handleAction(shouldRate) { els.modal.classList.add('hidden'); showLoader(); const dateStr = document.getElementById('custom-date').value; const date = dateStr ? new Date(dateStr).toISOString() : selectedDate; const rating = parseInt(els.ratingSlider.value); try { const ids = { ids: { trakt: currentModalItem.item.ids.trakt } }; const rootKey = currentModalItem.type === 'episode' ? 'episodes' : 'movies'; const payloadLog = { [rootKey]: [{ ...ids, watched_at: date }] }; await fetch(`${TRAKT_API_URL}/sync/history`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadLog) }); if (shouldRate) { const payloadRate = { [rootKey]: [{ ...ids, rating: rating, rated_at: new Date().toISOString() }] }; await fetch(`${TRAKT_API_URL}/sync/ratings`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadRate) }); showToast(`Logged & Rated ${rating}/10`); } else showToast(`Logged successfully`); } catch(e) { showToast('Action failed', 'error'); } hideLoader(); }
        async function loadSearch(query) { if (!query) return; showLoader(); els.content.innerHTML = ''; try { const data = await fetchDirect(`/search/movie,show?query=${encodeURIComponent(query)}&extended=images`); if (data.length === 0) els.content.innerHTML = `<div class="text-center p-20 text-gray-500 animate-fade"><i class="fa-solid fa-magnifying-glass text-6xl mb-4 opacity-50"></i><p>No results found.</p></div>`; else renderGrid(`Results: "${decodeURIComponent(query)}"`, data); } catch (e) { showToast('Search failed', 'error'); } hideLoader(); }
        async function renderListItems(listId) { els.content.innerHTML = ''; showLoader(); try { const [listInfo, items] = await Promise.all([fetchDirect(`/users/me/lists/${listId}`), fetchDirect(`/users/me/lists/${listId}/items?extended=images`)]); els.content.innerHTML = `<div class="flex items-center justify-between mb-6"><div><h2 class="text-3xl font-bold">${listInfo.name}</h2><p class="text-gray-400 text-sm mt-1">${listInfo.item_count} items</p></div><button onclick="location.hash='#library'" class="text-sm bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg transition"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Lists</button></div><div id="list-grid"></div>`; if (items.length > 0) renderGrid('', items, false, 'list-grid'); else document.getElementById('list-grid').innerHTML = `<p class="text-gray-500 italic">This list is empty.</p>`; } catch (e) { showToast('Could not load list items', 'error'); } hideLoader(); }

        function handleRoute() {
            const hash = location.hash || '#dashboard';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const link = document.querySelector(`a[href="${hash.split('/')[0]}"]`);
            if(link) link.classList.add('active');
            
            document.querySelectorAll('.mobile-nav-link').forEach(l => l.classList.remove('active'));
            const mobileLink = document.querySelector(`.mobile-nav-link[href="${hash.split('/')[0]}"]`);
            if(mobileLink) mobileLink.classList.add('active');

            if(hash.startsWith('#dashboard')) renderDashboard();
            else if(hash.startsWith('#library')) renderLibrary(); // CHANGED: Points to library
            else if(hash.startsWith('#watchlist')) renderLibrary('watchlist'); // Redirect old hash
            else if(hash.startsWith('#history')) renderHistory();
            else if(hash.startsWith('#progress')) renderProgress();
            else if(hash.startsWith('#settings')) renderSettings();
            else if(hash === '#lists') renderLibrary('lists'); // Redirect old hash
            else if(hash.startsWith('#lists/')) renderListItems(hash.split('/')[1]);
            else if(hash.startsWith('#search')) loadSearch(hash.split('/')[1]);
            else if(hash.startsWith('#detail')) {
                const parts = hash.split('/');
                if(parts[3] === 'season' && parts[4]) {
                    renderDetail(parts[1], parts[2], parts[4]);
                } else {
                    renderDetail(parts[1], parts[2]);
                }
            }
        }
        window.addEventListener('hashchange', handleRoute);

        // --- Auth & Events ---
        els.ratingSlider.oninput = (e) => els.ratingValue.innerText = e.target.value;
        const searchHandler = debounce((e) => {
            const val = e.target.value.trim();
            if (val.length > 1) location.hash = `#search/${val}`; else if (val.length === 0) history.back();
        }, 600);
        document.getElementById('search-input').addEventListener('input', searchHandler);
        document.getElementById('mobile-search-input').addEventListener('input', searchHandler);

        document.addEventListener('click', e => {
            const btn = e.target.closest('.scrobble-btn');
            if (btn) {
                const data = JSON.parse(btn.dataset.json);
                currentModalItem = { item: data, type: btn.dataset.type === 'show' ? 'episode' : 'movie' };
                document.getElementById('modal-title').innerText = data.title;
                els.modal.classList.remove('hidden');
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('custom-date').value = now.toISOString().slice(0, 16);
                selectedDate = new Date().toISOString();
            }
            if(e.target.closest('.date-option')) {
                const type = e.target.closest('.date-option').dataset.date;
                const d = new Date(); if(type === 'yesterday') d.setDate(d.getDate()-1);
                selectedDate = d.toISOString();
                document.querySelectorAll('.date-option').forEach(b => b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10'));
                e.target.closest('.date-option').classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10');
            }
            if(e.target.id === 'confirm-log') handleAction(false);
            if(e.target.id === 'confirm-rate-log') handleAction(true);
            if(e.target.id === 'close-modal') els.modal.classList.add('hidden');
        });

        onAuthStateChanged(auth, async user => {
            currentUser = user;
            if (user) {
                els.auth.innerHTML = `<button id="logout" class="text-xs text-red-500 hover:text-red-400 font-bold">Sign Out</button>`;
                document.getElementById('logout').onclick = () => signOut(auth);
                document.getElementById('main-nav').classList.remove('hidden'); els.searchContainer.classList.remove('hidden');

                if (!traktAccessToken) {
                    try {
                        const snap = await getDoc(doc(db, 'users', user.uid, 'services', 'trakt'));
                        if (snap.exists()) { 
                            traktAccessToken = snap.data().accessToken;
                            localStorage.setItem('trakt_token', traktAccessToken); 
                        }
                    } catch(e) { console.warn("Firestore token check failed", e); }
                }

                if (traktAccessToken) { await syncUserRatings(); }
                handleRoute();
            } else { 
                els.content.innerHTML = `<div class="max-w-md mx-auto card p-10 rounded-2xl shadow-2xl mt-12 text-center animate-fade"><div class="mb-6 inline-block p-4 rounded-full bg-[var(--primary)]/10"><i class="fa-solid fa-ticket text-5xl text-[var(--primary)]"></i></div><h1 class="text-4xl font-bold mb-2 text-[var(--primary)]">VidTrackr</h1><p class="text-gray-400 mb-8">Sign in to track your movies and shows.</p><button class="w-full bg-white text-gray-900 font-bold py-3 rounded-lg hover:bg-gray-200 transition mb-4 shadow-lg" onclick="document.getElementById('email-login').classList.remove('hidden'); this.classList.add('hidden');">Sign In / Sign Up</button><form id="email-login" class="space-y-4 hidden animate-fade"><input type="email" id="email" placeholder="Email" class="w-full p-4 rounded-lg bg-[var(--bg)] border border-gray-700 focus:border-[var(--primary)] outline-none transition" required><input type="password" id="password" placeholder="Password" class="w-full p-4 rounded-lg bg-[var(--bg)] border border-gray-700 focus:border-[var(--primary)] outline-none transition" required><div class="flex gap-3"><button type="submit" name="login" class="flex-1 btn-primary py-3 rounded-lg font-bold">Login</button><button type="submit" name="signup" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold transition">Sign Up</button></div></form></div>`; 
                document.getElementById('email-login').onsubmit = async (e) => { e.preventDefault(); try { if (e.submitter.name === 'signup') await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); else await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(err) { showToast(err.message, 'error'); } };
            }
        });
        document.getElementById('theme-toggle').onclick = () => { document.documentElement.classList.toggle('dark'); document.documentElement.classList.toggle('light'); };
    </script>
</body>
</html>