<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VidTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ed2224;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%234c1d95;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23g)' d='M0 128C0 92.7 28.7 64 64 64H512c35.3 0 64 28.7 64 64v96h-8c-26.5 0-48 21.5-48 48s21.5 48 48 48h8v96c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V320h8c26.5 0 48-21.5 48-48s-21.5-48-48-48H0V128z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ed2224; --primary-hover: #c01e1f;
            --bg-dark: #111827; --card-dark: #1f2937; --text-dark: #f9fafb;
            --bg-light: #f3f4f6; --card-light: #ffffff; --text-light: #111827;
        }
        .dark { --bg: var(--bg-dark); --card: var(--card-dark); --text: var(--text-dark); }
        .light { --bg: var(--bg-light); --card: var(--card-light); --text: var(--text-light); }
        
        body { background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
@media (max-width: 768px) {
    body { padding-bottom: 80px; }
}
        .card { background-color: var(--card); transition: background-color 0.3s; }
        .btn-primary { background-color: var(--primary); color: white; transition: 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

/* Add inside the <style> tag */
.nav-tab { 
    padding: 0.5rem 1rem; 
    border-radius: 0.5rem; 
    transition: all 0.2s; 
    font-weight: 600; 
    color: #9ca3af; /* Gray-400 */
    text-decoration: none;
    display: inline-flex;
    align-items: center;
}
.nav-tab:hover { 
    color: var(--text); 
    background: rgba(0,0,0,0.05); 
}
.dark .nav-tab:hover {
    background: rgba(255,255,255,0.05);
}
.nav-tab.active { 
    color: var(--primary); 
    background: rgba(237, 34, 36, 0.1); /* Primary color with opacity */
}
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #4b5563; border-radius: 2px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .nav-btn {
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5); 
            color: white;
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(4px); 
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 20; 
            opacity: 0; 
            cursor: pointer;
        }
        .group:hover .nav-btn { opacity: 1; }
        .nav-btn:hover { background: var(--primary); transform: translateY(-50%) scale(1.1); }
        .nav-prev { left: 20px; }
        .nav-next { right: 20px; } 
        
        /* Mobile Nav Styles */
        .mobile-nav-link { color: #9ca3af; flex-direction: column; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; gap: 4px; }
        .mobile-nav-link.active { color: var(--primary); }
        .mobile-nav-link i { font-size: 1.25rem; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">
    
    <div id="version-display" class="fixed top-2 right-2 text-[10px] text-gray-600 dark:text-gray-400 opacity-50 pointer-events-none z-50 font-mono"></div>

<header class="hidden md:block sticky top-0 bg-[var(--card)] shadow-lg z-30 shrink-0">
    <div class="container mx-auto px-4 py-2">
        <div class="flex items-center justify-between mb-2 mt-1">
            <div class="flex items-center space-x-4">
                <a href="../index.html" class="btn-primary text-xs font-bold py-1.5 px-3 rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-1">
                    <i class="fa-solid fa-arrow-left"></i> Hub
                </a>
                <a href="#dashboard" class="flex items-center space-x-2 text-2xl font-bold text-[var(--primary)]">
                    <i class="fa-solid fa-ticket"></i>
                    <span class="hidden sm:inline tracking-tight">VidTrackr</span>
                </a>
            </div>

            <nav id="main-nav" class="hidden md:flex space-x-1 bg-gray-100 dark:bg-gray-800/30 p-1 rounded-lg">
                <a href="#dashboard" class="nav-tab text-xs sm:text-sm active"><i class="fa-solid fa-house mr-1"></i> Dashboard</a>
                <a href="#library" class="nav-tab text-xs sm:text-sm"><i class="fa-solid fa-layer-group mr-1"></i> Library</a>
                <a href="#progress" class="nav-tab text-xs sm:text-sm"><i class="fa-solid fa-chart-pie mr-1"></i> Progress</a>
                <a href="#history" class="nav-tab text-xs sm:text-sm"><i class="fa-solid fa-clock-rotate-left mr-1"></i> History</a>
                <a href="#settings" class="nav-tab text-xs sm:text-sm"><i class="fa-solid fa-gear mr-1"></i> Settings</a>
            </nav>

            <div class="flex items-center space-x-2">
                <div id="search-container" class="hidden md:block relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input type="search" id="search-input" placeholder="Search..." 
                        class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-200 rounded-lg py-1.5 pl-8 pr-4 text-xs focus:ring-2 focus:ring-[var(--primary)] focus:outline-none w-32 transition-all focus:w-48 placeholder-gray-500">
                </div>

                <div id="header-watch-status" class="hidden mr-1 animate-pulse"></div>

                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition text-gray-500 dark:text-gray-400" title="Toggle Theme">
                    <i class="fa-solid fa-moon text-lg" id="theme-icon"></i>
                </button>
                
                <div id="auth-container" class="flex items-center"></div>
            </div>
        </div>
    </div>
</header>

    <div class="hidden px-4 py-2 bg-[var(--card)] border-b border-gray-800">
        <div class="flex items-center bg-[var(--bg)] rounded-lg px-3 py-2">
             <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
             <input type="search" id="mobile-search-input" placeholder="Search movies & shows..." class="bg-transparent border-none text-sm w-full focus:ring-0 text-[var(--text)] ml-2 outline-none">
        </div>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8">
        <div id="content" class="min-h-[50vh]"></div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-[var(--card)] border-t border-gray-800 z-50 flex justify-around py-3 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
        <a href="../index.html" class="mobile-nav-link"><i class="fa-solid fa-arrow-left"></i><span>Hub</span></a>
        <a href="#dashboard" class="mobile-nav-link active"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#library" class="mobile-nav-link"><i class="fa-solid fa-layer-group"></i><span>Library</span></a>
        <a href="#progress" class="mobile-nav-link"><i class="fa-solid fa-chart-pie"></i><span>Progress</span></a>
        <a href="#settings" class="mobile-nav-link"><i class="fa-solid fa-user"></i><span>Settings</span></a>
    </nav>

    <footer class="bg-[var(--card)] py-6 mt-auto text-center text-gray-500 text-sm border-t border-gray-800">
        <p>&copy; 2025 VidTrackr. Data provided by <a href="https://trakt.tv" class="text-[var(--primary)] hover:underline">Trakt.tv</a>.</p>
    </footer>
    <div id="loader" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity">
        <div class="animate-spin rounded-full h-14 w-14 border-[5px] border-[var(--primary)] border-t-transparent"></div>
    </div>
    <div id="scrobble-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 md:p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 animate-fade">
            <h3 class="text-2xl font-bold mb-1">Log & Rate</h3>
            <p id="modal-title" class="text-gray-400 mb-6 text-sm truncate"></p>
            
            <div class="mb-6 bg-[var(--bg)] p-4 rounded-xl border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-gray-300">Rating</label>
                    <span id="rating-value" class="text-[var(--primary)] font-bold text-lg">10</span>
                </div>
                <input type="range" id="rating-slider" min="1" max="10" value="10" class="w-full">
            </div>

            <div class="space-y-3 mb-6">
    <label class="text-sm font-bold text-gray-300">Watched On</label>
    <div class="grid grid-cols-2 gap-3">
        <button class="date-option p-3 rounded-lg border border-gray-600 hover:border-[var(--primary)] hover:bg-[var(--primary)]/10 transition text-center group bg-[var(--bg)]" data-date="now">
            <span class="block text-xs text-gray-400">Today</span>
            <i class="fa-solid fa-clock text-[var(--primary)]"></i>
        </button>
        <button class="date-option p-3 rounded-lg border border-gray-600 hover:border-[var(--primary)] hover:bg-[var(--primary)]/10 transition text-center group bg-[var(--bg)]" data-date="yesterday">
            <span class="block text-xs text-gray-400">Yesterday</span>
        </button>
    </div>

    <label class="text-sm font-bold text-gray-300">Progress</label>
    <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
        <div class="flex justify-between text-xs text-gray-400 mb-2">
            <span>0%</span>
            <span id="progress-percent-display" class="text-[var(--primary)] font-bold">0%</span>
            <span>100%</span>
        </div>
        <input type="range" id="progress-slider" min="0" max="100" value="0" class="w-full mb-3 accent-[var(--primary)]">
        <div class="flex gap-2">
            <input type="number" id="custom-progress" placeholder="Mins" class="w-1/3 p-2 rounded bg-[var(--bg)] border border-gray-600 text-xs focus:border-[var(--primary)] outline-none">
            <button id="btn-mark-watched" class="flex-grow bg-green-700 hover:bg-green-600 text-white text-xs font-bold rounded transition shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-check"></i> Mark 100% Watched
            </button>
        </div>
    </div>
    <input type="datetime-local" id="custom-date" class="w-full p-3 rounded-lg bg-[var(--bg)] border border-gray-600 focus:border-[var(--primary)] outline-none text-sm mt-2">
</div>

            <div class="grid grid-cols-3 gap-2">
                <button id="confirm-log" class="bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold transition text-xs">Log Only</button>
                <button id="confirm-rate-only" class="bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded-lg font-bold transition text-xs">Rate Only</button>
                <button id="confirm-rate-log" class="btn-primary py-3 rounded-lg font-bold shadow-lg shadow-red-900/30 text-xs">Rate & Log</button>
            </div>
            <button id="close-modal" class="w-full mt-4 text-sm text-gray-500 hover:text-white">Cancel</button>
        </div>
    </div>

    <div id="trailer-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[60] hidden backdrop-blur-md p-4 animate-fade">
        <div class="w-full max-w-5xl aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl relative border border-gray-800">
            <button onclick="window.closeTrailer()" class="absolute top-4 right-4 text-white hover:text-[var(--primary)] z-10 bg-black/50 rounded-full w-10 h-10 flex items-center justify-center backdrop-blur transition hover:scale-110"><i class="fa-solid fa-xmark text-xl"></i></button>
            <iframe id="trailer-frame" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>

    <div id="list-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm px-4">
        <div class="card p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 animate-fade">
            <h3 class="text-xl font-bold mb-4">Add to List</h3>
            <div id="list-modal-content" class="space-y-2 max-h-60 overflow-y-auto hide-scroll mb-4">
                </div>
            <button onclick="document.getElementById('list-modal').classList.add('hidden')" class="w-full text-sm text-gray-500 hover:text-white mt-2">Cancel</button>
        </div>
    </div>

    <div id="quick-rate-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[80] hidden backdrop-blur-xl animate-fade p-2 md:p-6">
        <div class="w-full max-w-5xl bg-gray-900/90 p-4 md:p-8 rounded-3xl border border-gray-700 shadow-2xl relative">
            <h3 class="text-xl md:text-3xl font-bold text-center mb-2 md:mb-6 text-white">Rate & Log</h3>
            <p class="text-center text-gray-400 text-xs md:text-base mb-4 md:mb-8 truncate px-2" id="quick-rate-title"></p>
            
            <div class="grid grid-cols-10 gap-1 md:gap-3 mb-4 md:mb-8">
                <button onclick="window.submitQuickRate(1)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-red-900 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">1</button>
                <button onclick="window.submitQuickRate(2)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-red-800 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">2</button>
                <button onclick="window.submitQuickRate(3)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-red-700 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">3</button>
                <button onclick="window.submitQuickRate(4)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-orange-700 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">4</button>
                <button onclick="window.submitQuickRate(5)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-orange-600 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">5</button>
                <button onclick="window.submitQuickRate(6)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-yellow-600 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">6</button>
                <button onclick="window.submitQuickRate(7)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-yellow-500 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">7</button>
                <button onclick="window.submitQuickRate(8)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-green-600 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">8</button>
                <button onclick="window.submitQuickRate(9)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-green-500 text-gray-300 hover:text-white font-bold text-sm md:text-2xl border border-gray-700 transition flex items-center justify-center">9</button>
                <button onclick="window.submitQuickRate(10)" class="aspect-square rounded-lg md:rounded-xl bg-gray-800 hover:bg-[var(--primary)] text-white font-bold text-sm md:text-2xl border border-gray-700 transition shadow-[0_0_15px_rgba(237,34,36,0.4)] flex items-center justify-center">10</button>
            </div>
            
            <button onclick="document.getElementById('quick-rate-modal').classList.add('hidden')" class="w-full py-3 md:py-5 bg-black/50 hover:bg-white/10 rounded-xl text-gray-400 hover:text-white font-bold border border-gray-700 transition text-sm md:text-lg">Cancel</button>
        </div>
    </div>

    <div id="active-checkin-banner" class="fixed bottom-[70px] md:bottom-0 left-0 right-0 bg-purple-900/95 border-t border-purple-500 text-white p-3 z-40 hidden animate-fade flex justify-between items-center backdrop-blur-md shadow-[0_-5px_20px_rgba(147,51,234,0.3)]"></div>
    <div id="toast-container" class="fixed bottom-20 md:bottom-6 right-6 z-50 flex flex-col gap-3"></div>
    <script type="module">
        // --- 1. Use Stable Firebase Version (10.13.1) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { TRAKT_CLIENT_ID, TRAKT_REDIRECT_URI } from './api_keys.js';
        import { changelogData } from '../changelog-data.js';

        // --- Config ---
        const app = initializeApp({
          apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
          authDomain: "sammy-7298f.firebaseapp.com",
          projectId: "sammy-7298f",
          storageBucket: "sammy-7298f.firebasestorage.app",
          messagingSenderId: "963185683535",
          appId: "1:963185683535:web:807df8941feba46c208e3a",
          measurementId: "G-JT1YF2ELN3"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const TRAKT_API_URL = 'https://api.trakt.tv';
        const PLACEHOLDER_IMG = 'https://placehold.co/400x600/1f2937/FFF?text=No+Image';

        // --- AUTH & TOKEN HANDLING ---
        const REDIRECT_URI = window.location.href.split('#')[0].split('?')[0];
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        if (hashParams.has('access_token')) {
            window.history.replaceState({}, document.title, REDIRECT_URI);
        }

        // --- State ---
        let currentUser = null;
        let traktAccessToken = localStorage.getItem('trakt_token');
        let currentModalItem = null;
        let selectedDate = new Date().toISOString();
        
        // --- 2. Add the missing userRatings definition here ---
        let userRatings = new Map(); 
        let userPlayback = new Map();

        // --- Add this function near syncUserRatings() ---
        async function syncPlayback() {
            try {
                const [movies, episodes] = await Promise.all([
                    fetchDirect('/sync/playback/movies?limit=50'),
                    fetchDirect('/sync/playback/episodes?limit=50')
                ]);
                userPlayback.clear();
                movies.forEach(p => userPlayback.set(p.movie.ids.trakt, p));
                episodes.forEach(p => userPlayback.set(p.episode.ids.trakt, p));
            } catch(e) { console.warn("Could not sync playback", e); }
        }
        
        let historyPage = 1;
        let isFetchingHistory = false;
        let progressChartInstance = null;
        let isAuthErrorHandling = false;
        let currentItemForList = null; // Added variable for list modal

        // --- DOM ---
        const els = {
            content: document.getElementById('content'),
            auth: document.getElementById('auth-container'),
            searchContainer: document.getElementById('search-container'),
            loader: document.getElementById('loader'),
            modal: document.getElementById('scrobble-modal'),
            ratingSlider: document.getElementById('rating-slider'),
            ratingValue: document.getElementById('rating-value'),
            toastContainer: document.getElementById('toast-container')
        };
        
        // --- Version Display ---
        if (changelogData && changelogData.length > 0) {
            document.getElementById('version-display').textContent = changelogData[0].version;
        }

        // --- Helpers ---
        const showLoader = () => els.loader.classList.remove('hidden');
        const hideLoader = () => els.loader.classList.add('hidden');
        const getTypeColor = (t) => (t === 'show' || t === 'episode') ? 'text-yellow-500' : 'text-[var(--primary)]';
        const getBorderColor = (t) => (t === 'show' || t === 'episode') ? 'border-yellow-500' : 'border-[var(--primary)]';
        const getBgColor = (t) => (t === 'show' || t === 'episode') ? 'bg-yellow-500' : 'bg-[var(--primary)]';

        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'success' 
                ? 'bg-green-900/90 border-green-500 text-white shadow-[0_0_20px_rgba(34,197,94,0.3)]' 
                : 'bg-red-900/90 border-red-500 text-white shadow-[0_0_20px_rgba(239,68,68,0.3)]';
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
            
            // REMOVED: fixed positioning (bottom-24 left-1/2 etc)
            // ADDED: pointer-events-auto to ensure clicks work
            toast.className = `flex items-center gap-4 px-6 py-4 rounded-xl border ${colors} shadow-2xl animate-fade backdrop-blur-md min-w-[300px] cursor-pointer pointer-events-auto`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} text-2xl"></i>
                <div class="flex flex-col">
                    <span class="font-bold text-lg">${type === 'success' ? 'Success!' : 'Error'}</span>
                    <span class="text-sm opacity-90">${msg}</span>
                </div>
            `;
            
            toast.onclick = () => toast.remove();
            
            // CHANGED: Append to container instead of body
            container.appendChild(toast);
            
            setTimeout(() => { 
                toast.style.transition = 'all 0.5s ease';
                toast.style.opacity = '0'; 
                toast.style.transform = 'translate(20px, 0)'; // Slide out to right
                setTimeout(()=>toast.remove(), 500); 
            }, 3000);
        };

        // --- NEW: Custom List Logic ---
        window.openAddToList = async (traktId, type) => {
            currentItemForList = { ids: { trakt: traktId }, type: type };
            const modal = document.getElementById('list-modal');
            const content = document.getElementById('list-modal-content');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-2 border-[var(--primary)] border-t-transparent"></div></div>';
            
            try {
                const lists = await fetchDirect(`/users/me/lists`);
                if(lists.length === 0) {
                    content.innerHTML = '<p class="text-gray-500 text-center">No custom lists found.</p>';
                    return;
                }
                content.innerHTML = lists.map(l => `
                    <button onclick="window.saveToList('${l.ids.trakt}')" class="w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-[var(--primary)] hover:text-white transition flex justify-between items-center group">
                        <span class="font-bold text-sm">${l.name}</span>
                        <span class="text-xs bg-black/30 px-2 py-1 rounded group-hover:bg-white/20">${l.item_count}</span>
                    </button>
                `).join('');
            } catch(e) {
                content.innerHTML = '<p class="text-red-500 text-center">Failed to load lists.</p>';
            }
        };

        window.saveToList = async (listId) => {
            if(!currentItemForList) return;
            showLoader();
            document.getElementById('list-modal').classList.add('hidden');
            try {
                const type = currentItemForList.type;
                const payload = {
                    [type === 'episode' ? 'episodes' : (type === 'show' ? 'shows' : 'movies')]: [currentItemForList]
                };
                
                await fetch(`${TRAKT_API_URL}/users/me/lists/${listId}/items`, {
                    method: 'POST', headers: traktHeader(), body: JSON.stringify(payload)
                });
                showToast('Added to list!');
            } catch(e) { showToast('Failed to add', 'error'); }
            hideLoader();
        };

        // --- NEW: Quick Rate Logic ---
        let quickRateTarget = null;
        
        window.openQuickRate = (id, type, title) => {
            quickRateTarget = { id, type };
            document.getElementById('quick-rate-title').innerText = title || 'Rate this item';
            document.getElementById('quick-rate-modal').classList.remove('hidden');
        };

        window.submitQuickRate = (rating) => {
            if(quickRateTarget) {
                window.rateDirect(quickRateTarget.id, quickRateTarget.type, rating);
                document.getElementById('quick-rate-modal').classList.add('hidden');
            }
        };

        window.deleteHistoryItem = async (traktId, type, watchedAt, btn) => {
            if(!confirm('Are you sure you want to remove this log from your history?')) return;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;
            try {
                const rootKey = type === 'episode' ? 'episodes' : 'movies';
                const payload = { [rootKey]: [{ ids: { trakt: traktId } }] };
                await fetch(`${TRAKT_API_URL}/sync/history/remove`, {
                    method: 'POST', headers: traktHeader(), body: JSON.stringify(payload)
                });
                showToast('Log removed successfully');
                const row = btn.closest('.card') || btn.closest('.history-row');
                if(row) { row.style.transition = "opacity 0.5s"; row.style.opacity = '0'; setTimeout(() => row.remove(), 500); }
            } catch(e) {
                console.error(e);
                showToast('Failed to remove log', 'error');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        };

        // --- New Helper Functions ---

// 1. Standalone function to open the modal (fixes the click propagation issue)
window.openScrobbleModal = (data) => {
    // Handle data if passed as string from HTML attribute
    const item = typeof data === 'string' ? JSON.parse(data) : data;
    const itemType = item.type || 'movie'; 
    
    currentModalItem = { item: item, type: itemType };
    document.getElementById('custom-progress').value = ''; 
    document.getElementById('modal-title').innerText = item.title;
    els.modal.classList.remove('hidden');
    
    // Auto-set date
    const now = new Date(); 
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('custom-date').value = now.toISOString().slice(0, 16);
    selectedDate = new Date().toISOString();

    // Auto-fill slider if Resume data exists
    if(item.runtime) {
         const existing = userPlayback.get(parseInt(item.ids.trakt));
         if(existing) {
             const currentPct = existing.progress;
             const slider = document.getElementById('progress-slider');
             if(slider) {
                 slider.value = Math.round(currentPct);
                 document.getElementById('progress-percent-display').innerText = `${Math.round(currentPct)}%`;
                 document.getElementById('custom-progress').value = Math.round((currentPct/100) * item.runtime);
             }
         }
    }
};

// Add/Update this global function
window.removeProgress = async (playbackId) => {
    if(!confirm('Drop this item from your "Continue Watching" list?')) return;
    
    // Find the button that was clicked to show a loading state
    const btn = document.querySelector(`button[onclick*="${playbackId}"]`);
    if(btn) btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

    try {
        // Use the Playback ID (e.g., 6530568), NOT the Trakt ID
        await fetch(`${TRAKT_API_URL}/sync/playback/${playbackId}`, { 
            method: 'DELETE', 
            headers: traktHeader() 
        });
        
        showToast('Item dropped successfully');
        
        // Remove from local map and refresh
        // We can't easily find the Trakt ID from just Playback ID here without a lookup, 
        // but reloading the list is safest to ensure UI consistency.
        loadUpNext(); 
        if(document.getElementById('history-resume-section')) renderHistory(1);
    } catch(e) {
        console.error(e);
        showToast('Failed to remove item', 'error');
        if(btn) btn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
    }
};

// --- Trailer Helpers ---
        window.openTrailer = (url) => {
            if (!url) return;
            // Extract Video ID from YouTube URLs
            let videoId = null;
            if (url.includes('youtube.com/watch?v=')) videoId = url.split('v=')[1].split('&')[0];
            else if (url.includes('youtu.be/')) videoId = url.split('.be/')[1];

            if (videoId) {
                document.getElementById('trailer-frame').src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
                document.getElementById('trailer-modal').classList.remove('hidden');
            } else {
                // Fallback for non-YouTube links
                window.open(url, '_blank'); 
            }
        };

        window.closeTrailer = () => {
            document.getElementById('trailer-modal').classList.add('hidden');
            document.getElementById('trailer-frame').src = ''; // Stop playback
        };
        // Close modal on background click
        document.getElementById('trailer-modal').addEventListener('click', (e) => {
            if (e.target.id === 'trailer-modal') window.closeTrailer();
        });

        window.navigateEpisode = async (showId, currentSeason, targetNumber) => {
            showLoader();
            try {
                if (targetNumber > 0) {
                    const ep = await fetchDirect(`/shows/${showId}/seasons/${currentSeason}/episodes/${targetNumber}`);
                    location.hash = `#detail/episode/${ep.ids.trakt}`;
                } else if (targetNumber <= 0 && currentSeason > 1) {
                    const prevSeasonData = await fetchDirect(`/shows/${showId}/seasons/${currentSeason - 1}?extended=full`);
                    const lastEpNum = prevSeasonData.episode_count;
                    const ep = await fetchDirect(`/shows/${showId}/seasons/${currentSeason - 1}/episodes/${lastEpNum}`);
                    location.hash = `#detail/episode/${ep.ids.trakt}`;
                } else {
                    showToast('No previous episodes', 'error');
                }
            } catch (e) { showToast('Episode not found', 'error'); }
            hideLoader();
        };

        function getImage(item, typeOverride = null, preferLandscape = false) {
            const type = typeOverride || item.type;
            const data = (type && item[type]) ? item[type] : item;
            const extract = (val) => { if (!val) return null; if (Array.isArray(val)) return extract(val[0]); if (typeof val === 'string') return val; return null; };

            if (!data.images) return PLACEHOLDER_IMG;
            let url = null;
            if (preferLandscape) {
                if (type === 'episode') url = extract(data.images.screenshot?.medium) || extract(data.images.screenshot?.full);
                else url = extract(data.images.fanart?.medium) || extract(data.images.fanart?.full);
                if (!url) url = extract(data.images.thumb?.full);
            }
            if (!url) {
                if (type === 'episode') url = extract(data.images.screenshot?.medium) || extract(data.images.screenshot?.full) || extract(data.images.screenshot);
                else if (type === 'person') url = extract(data.images.headshot?.medium) || extract(data.images.headshot?.full) || extract(data.images.headshot);
                else url = extract(data.images.poster?.medium) || extract(data.images.poster?.full) || extract(data.images.poster);
            }
            if (!url) url = extract(data.images.thumb);
            if (!url) url = extract(data.images.fanart);
            if (!url) return PLACEHOLDER_IMG;
            if (!url.startsWith('http') && !url.startsWith('//')) return `https://${url}`;
            return url;
        }

        const createCardHtml = (item, typeOverride = null) => {
            const type = typeOverride || item.type;
            const data = item[type] || item;
            const img = getImage(data);
            const typeColor = getTypeColor(type);
            const targetId = data.ids.trakt;
            const myRating = userRatings.get(parseInt(data.ids.trakt));
            const ratingHtml = myRating 
                ? `<span class="text-green-400 font-bold flex items-center gap-1"><i class="fa-solid fa-user-check"></i> ${myRating}</span>`
                : `<span class="text-white/80 flex items-center gap-1"><i class="fa-solid fa-star text-yellow-500"></i> ${(data.rating || 0).toFixed(1)}</span>`;

            return `
            <div class="group relative card rounded-xl overflow-hidden shadow-lg hover:shadow-2xl hover:scale-[1.02] transition duration-300 cursor-pointer border border-gray-800" onclick="location.hash='#detail/${type}/${targetId}'">
                <div class="aspect-[2/3] relative bg-gray-800">
                    <img src="${img}" class="w-full h-full object-cover object-center transition duration-500 group-hover:opacity-60" loading="lazy" onerror="this.src='${PLACEHOLDER_IMG}'">
                    <div class="absolute inset-0 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                        <span class="${getBgColor(type)} text-white px-4 py-2 rounded-full font-bold text-sm shadow-lg mb-2 transform translate-y-4 group-hover:translate-y-0 transition">View Details</span>
                    </div>
                    <div class="absolute top-2 right-2 bg-black/70 px-2 py-1 rounded-md text-xs font-bold backdrop-blur-md border border-white/10 shadow-sm">
                        ${ratingHtml}
                    </div>
                </div>
                <div class="p-4 border-t border-gray-800">
                    <h3 class="font-bold text-sm truncate text-gray-100 group-hover:${typeColor} transition-colors" title="${data.title}">${data.title}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-400 font-medium">${data.year || 'N/A'}</p>
                        <p class="text-[10px] ${typeColor} border ${getBorderColor(type)} px-1.5 py-0.5 rounded uppercase font-bold tracking-wide opacity-70">${type}</p>
                    </div>
                </div>
            </div>`;
        };

        // --- API & AUTH RECOVERY ---
        const traktHeader = () => ({ 'Content-Type': 'application/json', 'trakt-api-version': '2', 'trakt-api-key': TRAKT_CLIENT_ID, 'Authorization': `Bearer ${traktAccessToken}` });

        const handleAuthError = () => {
            if (isAuthErrorHandling) return;
            isAuthErrorHandling = true;
            showToast('Trakt Session Expired! Redirecting...', 'error');
            setTimeout(() => {
                if(confirm("Your Trakt connection has expired. Click OK to re-connect.")) {
                    const state = encodeURIComponent(window.location.pathname);
                    const authUrl = `https://trakt.tv/oauth/authorize?response_type=token&client_id=${TRAKT_CLIENT_ID}&redirect_uri=${encodeURIComponent(TRAKT_REDIRECT_URI)}&state=${state}`;
                    window.location.href = authUrl;
                } else {
                    isAuthErrorHandling = false; 
                }
            }, 1000);
        };

        async function fetchDirect(endpoint) {
            if (!traktAccessToken) { handleAuthError(); throw new Error("No Token"); }
            const res = await fetch(`${TRAKT_API_URL}${endpoint}`, { headers: traktHeader() });
            
            if (res.status === 401) {
                handleAuthError();
                throw new Error('API Error 401: Unauthorized');
            }
            if (!res.ok) throw new Error('API Error ' + res.status);
            return await res.json();
        }

        async function fetchSmart(endpoint, renderFn, cacheKey = null) {
            const key = cacheKey || `trakt_cache_${endpoint}`;
            const cached = localStorage.getItem(key);
            if (cached) { try { renderFn(JSON.parse(cached), true); } catch(e){} } else showLoader();
            try {
                const freshData = await fetchDirect(endpoint); 
                if (JSON.stringify(freshData) !== cached) {
                    localStorage.setItem(key, JSON.stringify(freshData));
                    renderFn(freshData, false);
                }
            } catch (e) { 
                if(!cached && e.message !== 'API Error 401: Unauthorized') showToast("Connection error", 'error'); 
            } 
            finally { if(!cached) hideLoader(); }
        }

        async function syncUserRatings() {
            try {
                const [movies, shows, episodes] = await Promise.all([ 
                    fetchDirect('/sync/ratings/movies?limit=1000'), 
                    fetchDirect('/sync/ratings/shows?limit=1000'), 
                    fetchDirect('/sync/ratings/episodes?limit=1000') 
                ]);
                userRatings.clear();
                movies.forEach(r => userRatings.set(r.movie.ids.trakt, r.rating));
                shows.forEach(r => userRatings.set(r.show.ids.trakt, r.rating));
                episodes.forEach(r => userRatings.set(r.episode.ids.trakt, r.rating));
            } catch(e) { console.warn("Could not sync ratings", e); }
        }

        // --- Renderers ---
        function renderGrid(title, items, append = false, containerId = 'content') {
            const gridHtml = `${!append && title ? `<h2 class="text-2xl font-bold mb-6 mt-8 px-2 border-l-4 border-[var(--primary)] animate-fade">${title}</h2>` : ''}<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6 mb-8 animate-fade">${items.map(item => createCardHtml(item)).join('')}</div>`;
            const container = document.getElementById(containerId) || els.content;
            if (append) container.insertAdjacentHTML('beforeend', gridHtml); else container.innerHTML = gridHtml;
        }

async function renderDashboard() {
    let greetingName = '';
    try {
        const profileSnap = await getDoc(doc(db, `users/${currentUser.uid}/settings/profile`));
        if (profileSnap.exists() && profileSnap.data().displayName) {
            greetingName = `, ${profileSnap.data().displayName}`;
        }
    } catch(e) {}

    els.content.innerHTML = `
        <div class="mb-8 p-6 md:p-8 rounded-3xl bg-gradient-to-br from-[var(--primary)] to-purple-900 text-white shadow-2xl relative overflow-hidden animate-fade">
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">Welcome Back${greetingName}!</h1>
                    <p class="opacity-90 text-lg">Your personal media tracking hub.</p>
                </div>
                <div id="quick-stats" class="flex gap-4 md:gap-6 text-center bg-black/20 p-4 rounded-xl backdrop-blur-md w-full md:w-auto justify-around md:justify-start"></div>
            </div>
            <i class="fa-solid fa-chart-line absolute -bottom-6 -right-6 text-[8rem] md:text-[10rem] opacity-10 rotate-12"></i>
        </div>

        <div id="up-next-container" class="mb-12 hidden animate-fade"></div>
        <div id="last-watched-container" class="mb-12 hidden animate-fade"></div>
        <div id="calendar-container" class="mb-12 hidden animate-fade"></div>
        <div id="trending-container"></div>
    `;

    // Call this FIRST to prioritize the network request
    loadUpNext();
    
    // Then load the rest
    loadLastWatched();
    loadCalendar();
    
    // (Existing stats & trending logic...)
    fetchSmart('/movies/trending?extended=images', (movies) => {
        fetchSmart('/shows/trending?extended=images', (shows) => {
            const combined = [...movies.map(m=>({...m, type:'movie'})), ...shows.map(s=>({...s, type:'show'}))].sort(()=>0.5-Math.random());
            renderGrid('Trending Now', combined, false, 'trending-container');
        }, 'cache_shows_trending');
    }, 'cache_movies_trending');
    
    try {
        const stats = await fetchDirect('/users/me/stats');
        document.getElementById('quick-stats').innerHTML = `<div><p class="text-2xl font-bold">${stats.movies.watched}</p><p class="text-xs uppercase opacity-75">Movies</p></div><div><p class="text-2xl font-bold">${stats.episodes.watched}</p><p class="text-xs uppercase opacity-75">Episodes</p></div><div><p class="text-2xl font-bold">${Math.round(stats.network.friends)}</p><p class="text-xs uppercase opacity-75">Mutuals</p></div>`;
    } catch(e){}
}

        async function loadLastWatched() {
            const container = document.getElementById('last-watched-container');
            try {
                const history = await fetchDirect('/sync/history?limit=12&extended=images');
                if (!history.length) return;

                const createCard = (h) => {
                    const type = h.type;
                    const data = h[type];
                    const id = type === 'episode' ? h.episode.ids.trakt : h.movie.ids.trakt;
                    const img = getImage(data, type === 'episode' ? 'episode' : 'movie', true);
                    const title = type === 'episode' ? `${h.show.title}: ${h.episode.title}` : h.movie.title;
                    const subTitle = type === 'episode' ? `S${h.episode.season}E${h.episode.number}` : h.movie.year;
                    const targetHash = type === 'episode' ? `#detail/episode/${h.episode.ids.trakt}` : `#detail/movie/${h.movie.ids.trakt}`;
                    const dateObj = new Date(h.watched_at);
                    const dateTimeDisplay = `${dateObj.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})} @ ${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    const myRating = userRatings.get(parseInt(id));
                    const ratingHtml = myRating ? `<span class="text-green-400 font-bold flex items-center gap-1 text-[10px] ml-2 bg-black/50 px-1.5 rounded"><i class="fa-solid fa-user-check"></i> ${myRating}</span>` : '';

                    return `
                        <div class="relative card rounded-xl overflow-hidden shadow-lg border border-gray-800 group cursor-pointer animate-fade" onclick="location.hash='${targetHash}'">
                            <div class="aspect-video relative">
                                <img src="${img}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" onerror="this.src='${PLACEHOLDER_IMG}'">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-4 w-full">
                                    <h4 class="text-white font-bold truncate shadow-black drop-shadow-md text-sm md:text-base">${title}</h4>
                                    <div class="flex items-center justify-between mt-1">
                                        <div class="flex items-center overflow-hidden">
                                            <span class="text-xs text-gray-300 font-mono truncate">${subTitle}</span>
                                            ${ratingHtml}
                                        </div>
                                        <span class="text-[10px] bg-[var(--primary)] text-white px-1.5 py-0.5 rounded font-bold uppercase flex-shrink-0 ml-2">${type}</span>
                                    </div>
                                    <div class="mt-2 text-[10px] text-gray-400 font-montserrat border-t border-gray-700 pt-1 flex items-center">
                                        <i class="fa-regular fa-clock mr-1 text-[var(--primary)]"></i> ${dateTimeDisplay}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                };

                const top3 = history.slice(0, 3).map(createCard).join('');
                const rest = history.slice(3).map(createCard).join('');

                let html = `<h2 class="text-2xl font-bold mb-6 px-2 border-l-4 border-purple-500">Recently Watched</h2>`;
                html += `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">${top3}</div>`;

                if (rest) {
                    html += `
                        <div id="hidden-history" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mt-6 hidden transition-all">
                            ${rest}
                        </div>
                        <div class="mt-6 flex justify-center">
                            <button onclick="const el = document.getElementById('hidden-history'); el.classList.toggle('hidden'); this.innerHTML = el.classList.contains('hidden') ? 'Show More <i class=&quot;fa-solid fa-chevron-down ml-2&quot;></i>' : 'Show Less <i class=&quot;fa-solid fa-chevron-up ml-2&quot;></i>'" 
                                class="bg-gray-800 hover:bg-gray-700 text-white text-xs font-bold py-2 px-6 rounded-full transition border border-gray-700 shadow-lg">
                                Show More <i class="fa-solid fa-chevron-down ml-2"></i>
                            </button>
                        </div>
                    `;
                }

                container.innerHTML = html;
                container.classList.remove('hidden');
            } catch (e) { console.error("Last Watched Error", e); }
        }

        async function loadCalendar() {
            const container = document.getElementById('calendar-container');
            try {
                const today = new Date().toISOString().split('T')[0];
                const calendar = await fetchDirect(`/calendars/my/shows/${today}/7?extended=images`);
                if(calendar.length > 0) {
                    container.innerHTML = `<h2 class="text-2xl font-bold mb-6 px-2 border-l-4 border-green-500">Airing This Week</h2><div class="flex gap-4 overflow-x-auto pb-4 hide-scroll">${calendar.map(item => `<div class="flex-shrink-0 w-64 card p-4 rounded-xl border border-gray-700 hover:border-green-500 transition cursor-pointer" onclick="location.hash='#detail/episode/${item.episode.ids.trakt}'"><div class="flex gap-3 mb-3"><img src="${getImage(item.show)}" class="w-12 h-16 object-cover rounded shadow"><div><p class="font-bold text-sm text-green-400">${new Date(item.first_aired).toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'})}</p><p class="font-bold text-sm leading-tight line-clamp-2 w-40 mb-1">${item.show.title}</p><p class="text-xs text-gray-500">S${item.episode.season}E${item.episode.number}</p></div></div><p class="text-xs text-gray-300 truncate">${item.episode.title}</p></div>`).join('')}</div>`;
                    container.classList.remove('hidden');
                }
            } catch(e){}
        }

        window.checkIn = async (id, type) => {
            showLoader();
            try {
                const payload = { [type === 'episode' ? 'episode' : 'movie']: { ids: { trakt: id } } };
                await fetch(`${TRAKT_API_URL}/checkin`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payload) });
                showToast("Checked in successfully!", "success");
                setTimeout(checkActiveWatching, 1000); // Update banner
            } catch (e) {
                showToast("Check-in failed (Already checked in?)", "error");
            }
            hideLoader();
        };

        window.rateDirect = async (id, type, rating) => {
            event.stopPropagation();
            showLoader();
            try {
                const ids = { ids: { trakt: id } };
                const rootKey = type === 'episode' ? 'episodes' : 'movies';
                const payloadLog = { [rootKey]: [{ ...ids, watched_at: new Date().toISOString() }] };
                const payloadRate = { [rootKey]: [{ ...ids, rating: parseInt(rating), rated_at: new Date().toISOString() }] };
                await fetch(`${TRAKT_API_URL}/sync/history`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadLog) });
                await fetch(`${TRAKT_API_URL}/sync/ratings`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadRate) });
                showToast(`Rated ${rating}/10 & Logged!`);
                userRatings.set(id, parseInt(rating)); 
                if (document.getElementById('up-next-container')) loadUpNext(); // FIX: Safety check
                if (document.getElementById('last-watched-container')) loadLastWatched();
            } catch(e) { showToast('Action failed', 'error'); } 
            hideLoader();
        }
        
async function loadUpNext() {
    const container = document.getElementById('up-next-container');
    if (!container) return;

    try {
        // 1. Get Resumable Items (Paused)
        const [resumeMovies, resumeEpisodes] = await Promise.all([
            fetchDirect('/sync/playback/movies?limit=10&extended=full,images'),
            fetchDirect('/sync/playback/episodes?limit=10&extended=full,images')
        ]);
        
        const resumeItems = [
            ...resumeMovies.map(m => ({...m, type: 'movie', isResume: true, playbackId: m.id})),
            ...resumeEpisodes.map(e => ({...e, type: 'episode', isResume: true, playbackId: e.id}))
        ].sort((a, b) => new Date(b.paused_at) - new Date(a.paused_at));

        // 2. Get "Up Next" (Next Episodes)
        const watchedShows = await fetchDirect('/sync/watched/shows?limit=50&extended=noseasons');
        const nextEpisodes = [];
        const uniqueShowIds = watchedShows.slice(0, 20).map(s => s.show.ids.trakt);
        
        await Promise.all(uniqueShowIds.map(async (id) => {
            try {
                if(resumeItems.find(r => r.type === 'episode' && r.show.ids.trakt == id)) return;
                const progress = await fetchDirect(`/shows/${id}/progress/watched?hidden=false&specials=false&count_specials=false&extended=full`);
                if (progress.next_episode) {
                     nextEpisodes.push({ 
                         type: 'episode', isResume: false,
                         show: { title: watchedShows.find(s => s.show.ids.trakt == id).show.title, ids: { trakt: id } }, 
                         episode: progress.next_episode, ids: progress.next_episode.ids, 
                         title: progress.next_episode.title, images: progress.next_episode.images 
                     });
                }
            } catch (err) {}
        }));
        nextEpisodes.sort((a, b) => uniqueShowIds.indexOf(a.show.ids.trakt) - uniqueShowIds.indexOf(b.show.ids.trakt));
        
        const combined = [...resumeItems, ...nextEpisodes].slice(0, 18);

        if (combined.length > 0) {
            const createCard = (item) => {
                const isMovie = item.type === 'movie';
                const data = isMovie ? (item.movie || item) : (item.episode || item.episode);
                const showTitle = !isMovie ? item.show.title : null;
                const title = isMovie ? (item.movie?.title || item.title) : data.title;
                const sub = isMovie ? (item.movie?.year || item.year) : `S${data.season} E${data.number}`;
                const img = getImage(item, null, true);
                const progress = item.progress || 0;
                
                const jsonStr = JSON.stringify({
                    ids: data.ids, 
                    title: isMovie ? title : `${showTitle}: ${title}`, 
                    type: item.type, 
                    runtime: data.runtime
                }).replace(/'/g, "&apos;");

                let actionBtns = '';
                
                if (item.isResume) {
                    // --- RESUME ITEMS ---
                    actionBtns = `
                    <div class="flex gap-2 w-full h-10">
                        <button onclick="event.stopPropagation(); window.rateDirect(${data.ids.trakt}, '${item.type}', 10)" class="h-full bg-gray-700 hover:bg-green-600 text-white text-xs px-3 rounded-lg transition font-bold shadow flex items-center justify-center" title="Mark Fully Watched"><i class="fa-solid fa-check"></i></button>
                        
                        <button onclick='event.stopPropagation(); window.openScrobbleModal(${jsonStr})' class="flex-grow h-full bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white text-xs font-bold rounded-lg border border-blue-600/30 transition flex items-center justify-center gap-2"><i class="fa-solid fa-sliders"></i> Update</button>
                        
                        <button onclick="event.stopPropagation(); window.removeProgress(${item.playbackId})" class="h-full bg-gray-700 hover:bg-red-600 text-white text-xs px-3 rounded-lg transition font-bold shadow flex items-center justify-center" title="Drop / Remove Progress"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
                } else {
                    // --- UP NEXT ITEMS (Updated for Quick Rate Modal) ---
                    actionBtns = `
                    <div class="flex gap-2 w-full relative z-20 h-10">
                         <button onclick='event.stopPropagation(); window.openScrobbleModal(${jsonStr})' class="flex-grow h-10 bg-[var(--primary)] hover:bg-red-700 text-white text-xs font-bold rounded-lg transition shadow-md flex items-center justify-center"><i class="fa-solid fa-play mr-1"></i> Log Watch</button>
                         
                         <button onclick="event.stopPropagation(); window.openQuickRate(${data.ids.trakt}, '${item.type}', '${(isMovie ? title : `${showTitle}: ${title}`).replace(/'/g, "\\'")}')" class="h-10 w-12 bg-gray-700 hover:bg-yellow-500 hover:text-black text-white rounded-lg font-bold transition shadow-md flex items-center justify-center border border-gray-600"><i class="fa-solid fa-star"></i></button>
                    </div>`;
                }

                return `
                <div class="card p-0 rounded-xl flex overflow-hidden border ${item.isResume ? 'border-blue-500/50 shadow-[0_0_10px_rgba(59,130,246,0.15)]' : 'border-gray-800'} hover:border-[var(--primary)] transition cursor-pointer shadow-lg group relative animate-fade" onclick="location.hash='#detail/${item.type}/${data.ids.trakt}'">
                    <div class="w-1/3 relative bg-gray-900">
                        <img src="${img}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" onerror="this.src='${PLACEHOLDER_IMG}'">
                        ${item.isResume ? `<div class="absolute bottom-0 left-0 right-0 h-1 bg-gray-700"><div class="bg-blue-500 h-full shadow-[0_0_5px_#3b82f6]" style="width: ${progress}%"></div></div>` : ''}
                        <div class="absolute top-2 left-2 ${item.isResume ? 'bg-blue-600' : 'bg-black/70'} text-white px-1.5 py-0.5 rounded text-[10px] font-bold shadow uppercase tracking-wider">${item.isResume ? 'Resume' : 'Up Next'}</div>
                    </div>
                    <div class="w-2/3 p-3 flex flex-col justify-center bg-[var(--card)] relative">
                        ${showTitle ? `<h4 class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-0.5 truncate">${showTitle}</h4>` : ''}
                        <h3 class="font-bold text-sm leading-tight mb-1 line-clamp-1 text-gray-200 group-hover:text-white transition">${title}</h3>
                        <p class="text-gray-500 text-xs mb-3">${sub} ${item.isResume ? `<span class="text-blue-400 ml-1">(${Math.round(progress)}%)</span>` : ''}</p>
                        <div class="mt-auto relative z-10">
                             ${actionBtns}
                        </div>
                    </div>
                </div>`;
            };

            const html = `<h2 class="text-2xl font-bold mb-6 px-2 border-l-4 border-blue-500">Continue Watching</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${combined.map(createCard).join('')}</div>`;
            container.innerHTML = html;
            container.classList.remove('hidden');
        }
    } catch (e) { console.error("Up Next Error", e); }
}

async function renderPerson(id) {
            showLoader();
            els.content.innerHTML = '';
            try {
                // 1. Fetch Person Details & Credits (Movies + Shows)
                const [person, movieCredits, showCredits] = await Promise.all([
                    fetchDirect(`/people/${id}?extended=full,images`),
                    fetchDirect(`/people/${id}/movies?extended=images`),
                    fetchDirect(`/people/${id}/shows?extended=images`)
                ]);

                // 2. Normalize and Combine Credits
                // Trakt returns wrappers like { character: "...", movie: {...} }
                const movies = (movieCredits.cast || []).map(c => ({ ...c.movie, type: 'movie', character: c.character }));
                const shows = (showCredits.cast || []).map(c => ({ ...c.show, type: 'show', character: c.character }));

                // 3. Sort by Year (Newest First)
                const allWorks = [...movies, ...shows]
                    .filter(w => w.year) // Remove unreleased/undated junk
                    .sort((a, b) => b.year - a.year);

                // 4. Render
                const img = getImage(person, 'person');
                els.content.innerHTML = `
                <div class="animate-fade">
                    <button onclick="history.back()" class="mb-6 text-sm text-gray-400 hover:text-white flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition w-fit"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    
                    <div class="flex flex-col md:flex-row gap-8 mb-12">
                        <div class="md:w-1/3 lg:w-1/4 flex-shrink-0 text-center md:text-left">
                            <div class="rounded-2xl overflow-hidden shadow-2xl border border-gray-800 mb-6 mx-auto md:mx-0 max-w-[200px] md:max-w-none">
                                <img src="${img}" class="w-full object-cover aspect-[2/3]" onerror="this.src='${PLACEHOLDER_IMG}'">
                            </div>
                            <h1 class="text-3xl font-bold mb-2 md:hidden">${person.name}</h1>
                            <div class="space-y-2 text-sm text-gray-400 bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                                ${person.birthday ? `<div><span class="block text-xs uppercase font-bold text-gray-600">Born</span> <span class="text-gray-200">${new Date(person.birthday).toLocaleDateString()}</span></div>` : ''}
                                ${person.birthplace ? `<div><span class="block text-xs uppercase font-bold text-gray-600">Place</span> <span class="text-gray-200">${person.birthplace}</span></div>` : ''}
                                ${person.death ? `<div><span class="block text-xs uppercase font-bold text-gray-600">Died</span> <span class="text-gray-200">${new Date(person.death).toLocaleDateString()}</span></div>` : ''}
                            </div>
                        </div>
                        
                        <div class="md:w-2/3 lg:w-3/4">
                            <h1 class="text-4xl md:text-5xl font-bold mb-4 hidden md:block">${person.name}</h1>
                            ${person.biography ? `<div class="prose prose-invert prose-sm max-w-none text-gray-300 mb-8"><p>${person.biography}</p></div>` : ''}
                            
                            <h2 class="text-2xl font-bold mb-6 border-l-4 border-[var(--primary)] px-3">Filmography <span class="text-sm font-normal text-gray-500 ml-2">(${allWorks.length} credits)</span></h2>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                ${allWorks.map(work => {
                                    // Custom card to show "Character Name"
                                    const workImg = getImage(work);
                                    const typeColor = getTypeColor(work.type);
                                    const myRating = userRatings.get(parseInt(work.ids.trakt));
                                    const ratingHtml = myRating ? `<div class="absolute top-2 right-2 bg-black/70 px-1.5 py-0.5 rounded text-[10px] font-bold text-green-400 border border-green-500/30"><i class="fa-solid fa-check"></i> ${myRating}</div>` : '';

                                    return `
                                    <div class="card rounded-xl overflow-hidden border border-gray-800 hover:border-gray-600 transition group cursor-pointer relative" onclick="location.hash='#detail/${work.type}/${work.ids.trakt}'">
                                        <div class="aspect-[2/3] relative bg-gray-900">
                                            <img src="${workImg}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy" onerror="this.src='${PLACEHOLDER_IMG}'">
                                            ${ratingHtml}
                                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-3 pt-8">
                                                <p class="font-bold text-xs text-white truncate">${work.title}</p>
                                                <p class="text-[10px] text-gray-400 truncate">${work.year || 'N/A'}</p>
                                            </div>
                                        </div>
                                        <div class="p-2 bg-[var(--card)] border-t border-gray-800">
                                            <p class="text-[10px] text-[var(--primary)] font-bold truncate uppercase tracking-wide">as ${work.character || 'Self'}</p>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            } catch (e) {
                console.error(e);
                showToast('Failed to load person details', 'error');
            }
            hideLoader();
        }

        async function renderDetail(type, id, initialSeason = null) {
            showLoader(); els.content.innerHTML = '';
            try {
                const noteKey = `${type}_${id}`;
                const isEpisode = type === 'episode';
                
                let item, notes, history = [], related = [], showInfo = null, people = null, comments = null;
                let showProgress = null; 
                let collectionList = null; 

                const fetchCommentsSafe = (url) => fetchDirect(url).catch(err => { console.warn("Comments unavailable", err); return []; });

                if (isEpisode) {
                    const searchResults = await fetchDirect(`/search/trakt/${id}?type=episode&extended=full,images`);
                    if(searchResults && searchResults[0]) {
                        item = searchResults[0].episode;
                        showInfo = searchResults[0].show;
                    } else { throw new Error('Episode not found'); }
                    const userData = await fetchDirect(`/episodes/${id}?extended=user_data`);
                    item.user_rating = userData.user_rating;
                    item.user_data = userData.user_data;
                    
                    const commentUrl = `/shows/${showInfo.ids.trakt}/seasons/${item.season}/episodes/${item.number}/comments/newest?limit=10`;
                    [history, comments] = await Promise.all([
                        fetchDirect(`/users/me/history/episodes/${id}?limit=20`),
                        fetchCommentsSafe(commentUrl)
                    ]);
                } else {
                    const commentUrl = `/${type}s/${id}/comments/newest?limit=10`;
                    [item, notes, history, related, people, comments] = await Promise.all([
                        fetchDirect(`/${type}s/${id}?extended=full,images,user_data`),
                        getDoc(doc(db, `users/${currentUser.uid}/notes`, noteKey)),
                        (type === 'movie' ? fetchDirect(`/users/me/history/movies/${id}?limit=20`) : []),
                        fetchDirect(`/${type}s/${id}/related?limit=5&extended=images`),
                        fetchDirect(`/${type}s/${id}/people?extended=images`),
                        fetchCommentsSafe(commentUrl)
                    ]);

                    if (type === 'movie') {
                        try {
                            const lists = await fetchDirect(`/movies/${id}/lists?type=official&sort=likes&limit=20`);
                            const officialList = lists.find(l => (l.user && l.user.username === 'official') || (l.name.toLowerCase().includes('collection') && l.likes > 10));
                            if (officialList && officialList.user) {
                                const userSlug = (officialList.user.ids && officialList.user.ids.slug) ? officialList.user.ids.slug : officialList.user.username;
                                if (userSlug) {
                                    const listItems = await fetchDirect(`/users/${userSlug}/lists/${officialList.ids.trakt}/items/movies?extended=images`);
                                    collectionList = listItems.map(li => li.movie);
                                }
                            }
                        } catch (err) { console.warn("Failed to fetch official collection", err); }
                    }
                }

                if(isEpisode) notes = await getDoc(doc(db, `users/${currentUser.uid}/notes`, noteKey));

                let navPrev = null, navNext = null;
                if (!isEpisode && type === 'movie') {
                    let navSet = [];
                    if (collectionList && collectionList.length > 0) {
                        navSet = collectionList;
                    } else if (related.length > 0) {
                        navSet = [item, ...related].filter(m => m.released).sort((a, b) => new Date(a.released) - new Date(b.released));
                        const unique = []; const seen = new Set(); for(const m of navSet) { if(!seen.has(m.ids.trakt)) { unique.push(m); seen.add(m.ids.trakt); } } navSet = unique;
                    }
                    if (navSet.length > 0) {
                        const idx = navSet.findIndex(m => m.ids.trakt == item.ids.trakt);
                        if (idx !== -1) { if (idx > 0) navPrev = navSet[idx - 1]; if (idx < navSet.length - 1) navNext = navSet[idx + 1]; }
                    }
                }

                const userNote = notes.exists() ? notes.data().text : '';

                // --- Shared Playback Logic (Detail Page) ---
const playback = userPlayback.get(parseInt(id));
let progressHtml = '';

if (playback) {
    // Prepare data for the Update Modal
    const jsonStr = JSON.stringify({
        ids: item.ids, 
        title: isEpisode ? `${showInfo.title}: ${item.title}` : item.title, 
        type: type, 
        runtime: item.runtime
    }).replace(/'/g, "&apos;");

    progressHtml = `
    <div class="mb-6 bg-gray-800/50 rounded-xl p-4 border border-blue-500/30 flex flex-col gap-3 shadow-[0_0_20px_rgba(59,130,246,0.1)] backdrop-blur-sm">
         <div class="flex items-center gap-4">
             <div class="bg-blue-900/30 p-3 rounded-full text-blue-400 shrink-0"><i class="fa-solid fa-play"></i></div>
             <div class="flex-grow min-w-0">
                 <div class="flex justify-between items-center mb-1">
                     <p class="text-xs text-blue-300 font-bold uppercase tracking-wider">Resume Watching</p>
                     <span class="text-xs text-gray-400 font-mono">${Math.round((playback.progress/100) * item.runtime)}m / ${item.runtime}m</span>
                 </div>
                 <div class="w-full bg-gray-700 rounded-full h-2">
                     <div class="bg-blue-500 h-2 rounded-full shadow-[0_0_10px_#3b82f6]" style="width: ${playback.progress}%"></div>
                 </div>
             </div>
         </div>
         
         <div class="flex gap-2 justify-end pt-2 border-t border-gray-700/50">
             <button onclick="window.rateDirect(${item.ids.trakt}, '${type}', 10)" class="bg-gray-700 hover:bg-green-600 text-white text-xs px-4 py-2 rounded-lg transition font-bold shadow flex items-center gap-2" title="Mark Fully Watched">
                <i class="fa-solid fa-check"></i> Finish
             </button>
             <button onclick='window.openScrobbleModal(${jsonStr})' class="bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white text-xs font-bold px-4 py-2 rounded-lg border border-blue-600/30 transition flex items-center gap-2">
                <i class="fa-solid fa-sliders"></i> Update Progress
             </button>
             <button onclick="window.removeProgress(${playback.id})" class="bg-gray-700 hover:bg-red-600 text-white text-xs px-3 py-2 rounded-lg transition font-bold shadow" title="Drop / Remove">
                <i class="fa-solid fa-xmark"></i>
             </button>
         </div>
    </div>`;
}

                const myRating = item.user_rating || userRatings.get(parseInt(id)); 
                const isWatched = (item.user_data?.plays > 0) || (history.length > 0);
                const titleText = isEpisode ? `${item.season}x${item.number}: ${item.title}` : item.title;
                const fullTitle = isEpisode ? `${showInfo.title}: ${item.title}` : item.title;
                const runtimeStr = item.runtime ? `${Math.floor(item.runtime/60)}h ${item.runtime%60}m` : 'N/A';
                
                const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
                const genresHtml = item.genres ? item.genres.map(g => {
                    const val = typeof g === 'string' ? g : g.name; 
                    return `<span class="bg-gray-800 border border-gray-700 text-xs px-2 py-1 rounded-md text-gray-300">${capitalize(val)}</span>`;
                }).join(' ') : '';

                const cert = item.certification || 'NR';
                const network = item.network || (item.production_countries ? item.production_countries[0]?.name : 'N/A');
                const trailerUrl = item.trailer ? (item.trailer.includes('youtube') ? item.trailer : null) : null;
                const language = item.language ? item.language.toUpperCase() : 'EN';
                const studios = item.production_companies ? item.production_companies.slice(0,2).map(c => c.name).join(', ') : 'N/A';
                let director = 'N/A';
                if(people && people.crew && people.crew.directing) {
                    director = people.crew.directing[0]?.person?.name || 'N/A';
                }

                const watchLink = `https://trakt.tv/${type === 'episode' ? 'shows' : type + 's'}/${id}/watchnow`;

// --- CORRECTED STREMIO URL LOGIC ---
                let stremioUrl = '';
                if (type === 'episode' && showInfo && showInfo.ids.imdb) {
                    // FIX: Stremio requires colons for episodes (ID:Season:Episode)
                    stremioUrl = `stremio:///detail/series/${showInfo.ids.imdb}/${showInfo.ids.imdb}:${item.season}:${item.number}`;
                } else if (item.ids.imdb) {
                    // Movies and Series main pages work with the standard format
                    stremioUrl = `stremio:///detail/${type === 'movie' ? 'movie' : 'series'}/${item.ids.imdb}`;
                }
                // -----------------------------------
                const watchedBadge = isWatched 
                    ? `<span class="bg-green-500/20 text-green-400 border border-green-500/50 px-3 py-1 rounded-md text-sm font-bold flex items-center shadow-[0_0_15px_rgba(74,222,128,0.2)]"><i class="fa-solid fa-circle-check mr-2"></i> Watched</span>`
                    : `<span class="bg-gray-800 text-gray-400 border border-gray-700 px-3 py-1 rounded-md text-sm font-bold flex items-center"><i class="fa-regular fa-circle mr-2"></i> Not Watched</span>`;
                const myRatingHtml = myRating 
                    ? `<span class="bg-yellow-500/20 text-yellow-500 border border-yellow-500/50 px-3 py-1 rounded-md text-sm font-bold flex items-center shadow-[0_0_15px_rgba(234,179,8,0.2)]"><i class="fa-solid fa-star mr-2"></i> ${myRating}</span>`
                    : `<button class="scrobble-btn bg-gray-800 hover:bg-white hover:text-black border border-gray-700 px-3 py-1 rounded-md text-sm font-bold flex items-center transition" data-json='${JSON.stringify({ids: item.ids, title: fullTitle, type: type, runtime: item.runtime}).replace(/'/g, "&apos;")}' data-type="${type}"><i class="fa-regular fa-star mr-2"></i> Rate</button>`;

                let historyHtml = '';
                if (history.length > 0) {
                      historyHtml = `<div class="bg-gray-900/50 p-5 rounded-2xl border border-gray-800 mb-8 backdrop-blur-sm animate-fade"><h3 class="text-xs font-bold text-gray-500 mb-4 uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> Watch History</h3><div class="space-y-2">${history.map(h => `<div class="history-row flex justify-between items-center text-sm border-b border-gray-800/50 pb-2 last:border-0 last:pb-0 hover:bg-white/5 p-2 rounded transition"><div class="flex items-center gap-3"><span class="font-medium text-gray-200"><i class="fa-solid fa-calendar-day text-[var(--primary)] mr-2 opacity-70"></i> ${new Date(h.watched_at).toLocaleDateString()}</span><span class="text-gray-500 font-mono text-xs">${new Date(h.watched_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><div class="flex gap-2"><button class="text-xs bg-red-900/30 text-red-400 p-2 rounded hover:bg-red-500 hover:text-white transition" onclick="window.deleteHistoryItem('${id}', '${type}', '${h.watched_at}', this)" title="Delete Entry"><i class="fa-solid fa-trash"></i></button></div></div>`).join('')}</div></div>`;
                }

                let castHtml = '';
                if (people && people.cast && people.cast.length > 0) {
                    castHtml = `
                    <h3 class="text-xs font-bold text-[var(--primary)] mb-4 uppercase tracking-widest mt-8">Top Cast</h3>
                    <div class="flex gap-4 overflow-x-auto pb-6 hide-scroll">
                        ${people.cast.slice(0, 10).map(person => {
                             const pImg = getImage(person.person, 'person'); 
                             // Added onclick to search for the person
                             return `
                             <div class="flex-shrink-0 w-28 group relative cursor-pointer" onclick="location.hash='#detail/person/${person.person.ids.trakt}'" title="View Filmography">
                                <div class="w-24 h-24 mx-auto rounded-full bg-gray-800 border-2 border-gray-700 overflow-hidden mb-3 shadow-lg group-hover:border-[var(--primary)] transition transform group-hover:scale-105">
                                     <img src="${pImg}" class="w-full h-full object-cover" onerror="this.src='${PLACEHOLDER_IMG}'">
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-xs truncate text-white group-hover:text-[var(--primary)] transition">${person.person.name}</p>
                                    <p class="text-[10px] text-gray-500 truncate">${person.characters[0]}</p>
                                </div>
                             </div>`
                        }).join('')}
                    </div>`;
                }

                let html = `<div class="animate-fade max-w-6xl mx-auto">`;

                if (isEpisode) {
                    const bgImg = getImage(item, 'episode', true); 
                    html += `
                    <button onclick="history.back()" class="absolute top-24 left-4 z-20 text-sm bg-black/50 hover:bg-black/80 text-white px-4 py-2 rounded-full backdrop-blur-md transition"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="relative w-full min-h-[200px] h-auto rounded-3xl overflow-hidden shadow-2xl border border-gray-800 group mb-8 bg-black">
                        <img src="${bgImg}" class="w-full h-auto max-h-[60vh] object-contain mx-auto">
                        <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg)] via-transparent to-transparent pointer-events-none"></div>
                        <div class="nav-btn nav-prev" onclick="window.navigateEpisode('${showInfo.ids.trakt}', ${item.season}, ${item.number - 1})"><i class="fa-solid fa-chevron-left"></i></div>
                        <div class="nav-btn nav-next" onclick="window.navigateEpisode('${showInfo.ids.trakt}', ${item.season}, ${item.number + 1})"><i class="fa-solid fa-chevron-right"></i></div>
                        <div class="absolute bottom-0 left-0 p-6 md:p-10 w-full bg-gradient-to-t from-black via-black/50 to-transparent">
                            <h4 class="text-lg md:text-xl font-bold text-gray-300 mb-1 flex items-center gap-2">
                                <span class="bg-[var(--primary)] text-white px-2 py-0.5 rounded text-xs">EPISODE</span> ${showInfo.title}
                            </h4>
                            <h1 class="text-3xl md:text-5xl font-bold text-white mb-4 leading-tight shadow-black drop-shadow-md">${titleText}</h1>
                            <div class="flex flex-wrap items-center gap-3 text-sm font-medium">
                                <span class="bg-gray-800/80 backdrop-blur text-white px-3 py-1 rounded border border-gray-600">S${item.season} E${item.number}</span>
                                ${watchedBadge} ${myRatingHtml}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2">
                             <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-400 border-b border-gray-800 pb-4">
                                <span class="flex items-center"><i class="fa-regular fa-clock mr-2"></i> ${runtimeStr}</span>
                                <span class="flex items-center"><i class="fa-regular fa-calendar mr-2"></i> First aired:</i> ${new Date(item.first_aired).toLocaleDateString()}</span>
                            </div>
                            <h3 class="text-xs font-bold text-[var(--primary)] mb-2 uppercase tracking-widest">Overview</h3>
                            <p class="text-lg text-gray-300 leading-relaxed mb-8">${item.overview || 'No overview available.'}</p>
                            ${progressHtml}
                            ${historyHtml}
                            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                                <button class="scrobble-btn bg-[var(--primary)] hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 flex-1 justify-center transition" data-json='${JSON.stringify({ids: item.ids, title: fullTitle, type: 'episode', runtime: item.runtime}).replace(/'/g, "&apos;")}' data-type="show"><i class="fa-solid fa-check"></i> Log / Rate Again</button>
                                <button onclick="window.checkIn('${item.ids.trakt}', 'episode')" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-3 rounded-lg font-bold border border-purple-500 transition flex items-center justify-center" title="Check In Now"><i class="fa-solid fa-map-pin"></i></button>
                                ${stremioUrl ? `<a href="${stremioUrl}" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded-lg font-bold border border-indigo-500 transition flex items-center justify-center" title="Open in Stremio"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>` : ''}
                                <button onclick="window.openAddToList('${item.ids.trakt}', 'episode')" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-bold border border-gray-600 transition flex items-center justify-center" title="Add to List"><i class="fa-solid fa-list-ul"></i></button>
                                <button onclick="location.hash='#detail/show/${showInfo.ids.trakt}/season/${item.season}'" class="bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-bold border border-gray-700 transition flex items-center justify-center gap-2">Season ${item.season}</button>
                            </div>
                             <div class="bg-[var(--card)] p-6 rounded-2xl border border-gray-700 shadow-lg mb-8">
                                <h3 class="font-bold mb-3 flex items-center"><i class="fa-solid fa-note-sticky mr-2 text-yellow-500"></i> Notes</h3>
                                <textarea id="note-input" class="w-full bg-[var(--bg)] border border-gray-700 rounded-lg p-3 text-sm outline-none resize-none" rows="2" placeholder="Private note...">${userNote}</textarea>
                                <div class="flex justify-end mt-3"><button id="save-note" class="text-xs bg-gray-700 hover:bg-[var(--primary)] text-white px-5 py-2 rounded-md transition font-bold shadow">Save</button></div>
                            </div>
                        </div>
                        <div class="md:col-span-1 space-y-6"></div>
                    </div>`;

                } else {
                    const img = getImage(item, null, true);
                    html += `
                    <button onclick="history.back()" class="mb-6 text-sm text-gray-400 hover:text-white flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition w-fit"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="flex flex-col md:flex-row gap-8 mb-12">
                        <div class="md:w-1/3 lg:w-1/4 flex-shrink-0">
                            <div class="rounded-2xl overflow-hidden shadow-2xl relative group border border-gray-800">
                                <img src="${img}" class="w-full object-cover">
                                ${type === 'movie' ? `<div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center backdrop-blur-sm"><button class="scrobble-btn ${getBgColor(type)} text-white px-8 py-3 rounded-full font-bold transform scale-90 group-hover:scale-100 transition shadow-xl" data-json='${JSON.stringify({ids: item.ids, title: item.title, type: type, runtime: item.runtime}).replace(/'/g, "&apos;")}' data-type="${type}"><i class="fa-solid fa-check mr-2"></i> Log Movie</button></div>` : ''}
                                
                                ${navPrev ? `<div class="nav-btn nav-prev" onclick="location.hash='#detail/movie/${navPrev.ids.trakt}'" title="Previous: ${navPrev.title.replace(/"/g, '&quot;')}"><i class="fa-solid fa-chevron-left"></i></div>` : ''}
                                ${navNext ? `<div class="nav-btn nav-next" onclick="location.hash='#detail/movie/${navNext.ids.trakt}'" title="Next: ${navNext.title.replace(/"/g, '&quot;')}"><i class="fa-solid fa-chevron-right"></i></div>` : ''}
                            </div>
                            
                            <div class="mt-6 flex flex-col gap-3">
                                <a href="${watchLink}" target="_blank" class="w-full text-center bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-sm transition shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> Stream Now</a>
                                ${stremioUrl ? `<a href="${stremioUrl}" class="w-full text-center bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold text-sm transition shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open in Stremio</a>` : ''}
                                <button onclick="window.checkIn('${item.ids.trakt}', '${type}')" class="w-full text-center bg-purple-900/40 hover:bg-purple-800 text-purple-300 py-2 rounded-lg font-bold text-xs transition border border-purple-800 flex items-center justify-center gap-2"><i class="fa-solid fa-map-pin"></i> Check In Now</button>
                                <button onclick="window.openAddToList('${item.ids.trakt}', '${type}')" class="w-full text-center bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-bold text-xs transition border border-gray-600 flex items-center justify-center gap-2"><i class="fa-solid fa-list-ul"></i> Add to List</button>
                                ${item.homepage ? `<a href="${item.homepage}" target="_blank" class="w-full text-center bg-gray-800 hover:bg-gray-700 text-gray-300 py-2 rounded-lg font-bold text-xs transition border border-gray-700">Official Website <i class="fa-solid fa-up-right-from-square ml-1"></i></a>` : ''}
                                ${trailerUrl ? `<button onclick="window.openTrailer('${trailerUrl}')" class="w-full text-center bg-red-900/20 hover:bg-red-900/40 text-red-500 py-2 rounded-lg font-bold text-xs transition border border-red-900/30 flex items-center justify-center gap-2"><i class="fa-brands fa-youtube text-lg"></i> Watch Trailer</button>` : ''}
                            </div>

                            <div class="mt-6 bg-[var(--card)] p-4 rounded-xl border border-gray-800 text-sm space-y-3">
                                <h4 class="font-bold text-gray-400 text-xs uppercase mb-2">Production Info</h4>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Director/Creator</span>
                                    <span class="text-gray-200 font-medium">${director}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Studio</span>
                                    <span class="text-gray-200 font-medium truncate max-w-[120px]" title="${studios}">${studios}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Language</span>
                                    <span class="text-gray-200 font-medium">${language}</span>
                                </div>
                                ${item.revenue ? `<div class="flex justify-between"><span class="text-gray-500">Revenue</span><span class="text-green-400 font-medium">$${(item.revenue/1000000).toFixed(1)}M</span></div>` : ''}
                            </div>
                        </div>
                        <div class="md:w-2/3 lg:w-3/4">
                            <h1 class="text-4xl md:text-6xl font-bold mb-2 leading-tight tracking-tight">${item.title}</h1>
                            ${item.tagline ? `<p class="text-xl text-gray-400 italic mb-4">"${item.tagline}"</p>` : ''}
                            ${type === 'show' ? await (async () => { try { showProgress = await fetchDirect(`/shows/${id}/progress/watched`); const percent = showProgress.aired > 0 ? Math.round((showProgress.completed / showProgress.aired) * 100) : 0; return `<div class="mb-6 bg-gray-800 rounded-full h-4 w-full overflow-hidden border border-gray-700 relative group"><div class="bg-gradient-to-r from-green-600 to-green-400 h-full transition-all duration-1000" style="width: ${percent}%"></div><div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md">${percent}% WATCHED</div></div>`; } catch(e){ return ''; } })() : ''}
                            <div class="flex flex-wrap items-center gap-4 text-gray-300 mb-6 text-sm md:text-base font-medium">
                                <span class="bg-gray-800 px-3 py-1 rounded-md border border-gray-700 text-white">${item.year || 'N/A'}</span>
                                <span class="border border-gray-600 px-2 py-0.5 rounded text-xs uppercase text-gray-400">${cert}</span>
                                ${watchedBadge} ${myRatingHtml}
                                ${item.status ? `<span class="uppercase tracking-wider font-bold ${getTypeColor(type)} px-2 py-1 bg-gray-800 rounded text-xs">${item.status}</span>` : ''}
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 bg-gray-900/30 p-4 rounded-xl border border-gray-800/50 backdrop-blur-sm">
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Typical Runtime</p><p class="font-medium text-gray-300">${runtimeStr}</p></div>
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Network</p><p class="font-medium text-gray-300 truncate" title="${network}">${network}</p></div>
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Avg. Trakt Rating</p><p class="font-medium text-[var(--primary)]">${item.rating ? item.rating.toFixed(1) : '-'}/10</p></div>
                                <div><p class="text-xs text-gray-500 uppercase font-bold">Total Trakt Votes</p><p class="font-medium text-gray-300">${item.votes || 0}</p></div>
                                <div class="col-span-2 md:col-span-4 border-t border-gray-800 mt-2 pt-2 flex flex-wrap gap-2 items-center">
                                    <span class="text-xs text-gray-500 uppercase font-bold mr-2">Genres:</span> ${genresHtml}
                                </div>
                            </div>
                            <h3 class="text-xs font-bold ${getTypeColor(type)} mb-2 uppercase tracking-widest">Overview</h3>
                            <p class="text-gray-300 text-lg leading-relaxed mb-6 max-w-3xl">${item.overview || 'No overview available.'}</p>
                            ${castHtml}
                            ${progressHtml}
                            ${historyHtml}
                             <div class="bg-[var(--card)] p-6 rounded-2xl border border-gray-700 shadow-lg mb-8 mt-8">
                                <h3 class="font-bold mb-3 flex items-center"><i class="fa-solid fa-note-sticky mr-2 text-yellow-500"></i> Notes</h3>
                                <textarea id="note-input" class="w-full bg-[var(--bg)] border border-gray-700 rounded-lg p-3 text-sm outline-none resize-none" rows="2" placeholder="Your thoughts...">${userNote}</textarea>
                                <div class="flex justify-end mt-3"><button id="save-note" class="text-xs bg-gray-700 hover:bg-[var(--primary)] text-white px-5 py-2 rounded-md transition font-bold shadow">Save</button></div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div id="seasons-mount"></div>
                    ${related.length > 0 ? `<h2 class="text-2xl font-bold mb-6 mt-16 px-4 border-l-4 border-[var(--primary)]">You Might Also Like</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">${related.map(r => createCardHtml(r, type)).join('')}</div>` : ''}`;
                }

                if (comments && comments.length > 0) {
                      html += `<h2 class="text-2xl font-bold mb-6 mt-16 px-4 border-l-4 border-gray-500">Community Comments</h2><div class="space-y-4 max-w-4xl">${comments.map(c => `
                        <div class="bg-[var(--card)] p-4 rounded-xl border border-gray-800">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-[var(--primary)] text-sm">${c.user.username}</span>
                                <span class="text-xs text-gray-500">${new Date(c.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="text-gray-300 text-sm leading-relaxed">${c.comment}</p>
                            ${c.spoiler ? '<span class="text-[10px] text-red-500 font-bold uppercase mt-2 block">Spoiler</span>' : ''}
                        </div>
                      `).join('')}</div>`;
                }

                html += `</div>`;
                els.content.innerHTML = html;

                const saveBtn = document.getElementById('save-note');
                if(saveBtn) saveBtn.onclick = async () => { 
                    saveBtn.innerText = 'Saving...';
                    await setDoc(doc(db, `users/${currentUser.uid}/notes`, noteKey), { text: document.getElementById('note-input').value, updatedAt: new Date() }, { merge: true }); 
                    saveBtn.innerText = 'Saved!'; setTimeout(()=>saveBtn.innerText='Save', 2000); showToast('Note saved'); 
                };

                if (type === 'show') {
                    const mount = document.getElementById('seasons-mount');
                    mount.innerHTML = `<div class="flex items-center gap-3 mb-6"><div class="animate-spin rounded-full h-6 w-6 border-2 border-yellow-500 border-t-transparent"></div> <span class="text-gray-400">Loading seasons...</span></div>`;
                    try {
                        const seasons = await fetchDirect(`/shows/${id}/seasons?extended=full,images`);
                        const mainShowPoster = getImage(item, null, true);
                        window.renderSeasonsGrid = () => { 
                            const validSeasons = seasons.filter(s => s.number > 0);
                            mount.innerHTML = `<h2 class="text-2xl font-bold mb-6 border-l-4 border-yellow-500 px-4">Seasons</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">${validSeasons.map(s => {
                                let sImg = getImage(s); if(sImg === PLACEHOLDER_IMG) sImg = mainShowPoster;
                                let isFullyWatched = false;
                                if(showProgress && showProgress.seasons) {
                                    const sp = showProgress.seasons.find(x => x.number === s.number);
                                    if(sp && sp.aired > 0 && sp.completed >= sp.aired) isFullyWatched = true;
                                }
                                const styleClasses = isFullyWatched ? "opacity-50 grayscale blur-[1px] hover:blur-0 hover:grayscale-0 hover:opacity-100 border-transparent" : "hover:border-yellow-500 border-transparent";
                                const checkIcon = isFullyWatched ? `<div class="absolute top-2 left-2 bg-green-500 text-black w-6 h-6 flex items-center justify-center rounded-full shadow-lg z-10"><i class="fa-solid fa-check text-xs"></i></div>` : '';
                                return `<div class="card rounded-xl overflow-hidden cursor-pointer border transition-all duration-300 group relative ${styleClasses}" onclick="window.loadEpisodes('${id}', '${s.number}')"><div class="aspect-[2/3] relative"><img src="${sImg}" class="w-full h-full object-cover" onerror="this.src='${PLACEHOLDER_IMG}'">${checkIcon}<div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded shadow">S${s.number}</div><div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center font-bold text-sm">View Episodes</div></div><div class="p-3 text-center"><h4 class="font-bold text-sm truncate">${s.title}</h4><p class="text-xs text-gray-500">${s.episode_count} Eps</p></div></div>`; 
                            }).join('')}</div>`; 
                        };
                        window.renderSeasonsGrid();
                        window.loadEpisodes = async (showId, seasonNum) => {
                            mount.innerHTML = `<div class="flex items-center gap-3 mb-6"><div class="animate-spin rounded-full h-6 w-6 border-2 border-yellow-500 border-t-transparent"></div> <span class="text-gray-400">Loading Season ${seasonNum}...</span></div>`;
                            const episodes = await fetchDirect(`/shows/${showId}/seasons/${seasonNum}/episodes?extended=full,images,user_data`);
                            mount.innerHTML = `<div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold border-l-4 border-yellow-500 px-4">Season ${seasonNum}</h2><button onclick="window.renderSeasonsGrid()" class="text-sm text-gray-400 hover:text-white flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition"><i class="fa-solid fa-arrow-left"></i> Back to Seasons</button></div><div class="space-y-4">${episodes.map(ep => {
                                const epRating = ep.user_rating ? `<span class="text-green-400 text-xs font-bold ml-2 border border-green-500/50 px-1 rounded">You: ${ep.user_rating}</span>` : '';
                                const epPlayback = userPlayback.get(parseInt(ep.ids.trakt));
                                const pbHtml = epPlayback ? `<div class="mt-2 w-full bg-gray-800 rounded-full h-1"><div class="bg-blue-500 h-1 rounded-full" style="width: ${epPlayback.progress}%"></div></div><p class="text-[10px] text-blue-400 mt-1">${Math.round(epPlayback.progress)}% resumed</p>` : '';
                                return `<div class="card p-4 rounded-xl flex flex-col sm:flex-row gap-4 border border-gray-800 hover:border-gray-600 transition"><div class="sm:w-48 flex-shrink-0 relative cursor-pointer group" onclick="location.hash='#detail/episode/${ep.ids.trakt}'"><img src="${getImage(ep, 'episode')}" class="w-full h-32 object-cover rounded-lg shadow-md group-hover:opacity-80 transition" onerror="this.src='${PLACEHOLDER_IMG}'"><div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm px-2 py-1 rounded text-xs font-bold">Ep ${ep.number}</div></div><div class="flex-grow min-w-0 flex flex-col justify-between"><div><h4 class="font-bold text-lg text-gray-100 truncate hover:text-yellow-500 cursor-pointer transition" onclick="location.hash='#detail/episode/${ep.ids.trakt}'">${ep.title || 'Episode ' + ep.number}</h4><p class="text-gray-400 text-sm mt-1 line-clamp-2">${ep.overview || 'No description.'}</p>${pbHtml}</div><div class="flex items-center justify-between mt-4"><div><span class="text-xs text-gray-500"><i class="fa-solid fa-star text-yellow-500 mr-1"></i> ${ep.rating ? ep.rating.toFixed(1) : '-'}</span>${epRating}</div><button class="scrobble-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-bold shadow-md hover:shadow-yellow-900/40 flex items-center" data-json='${JSON.stringify({ids: ep.ids, title: `${item.title} ${seasonNum}x${ep.number}: ${ep.title}`, type: 'episode', runtime: item.runtime}).replace(/'/g, "&apos;")}' data-type="show"><i class="fa-solid fa-check mr-2"></i> Log</button></div></div></div>`;
                            }).join('')}</div>`;
                            mount.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        };
                        if(initialSeason) { await window.loadEpisodes(id, initialSeason); }
                    } catch(e) { mount.innerHTML = `<p class="text-red-500">Failed to load seasons.</p>`; }
                }

            } catch(e) { console.error(e); showToast('Load error', 'error'); } 
            hideLoader();
        }

        let currentHistoryFilter = 'all'; 

        window.setHistoryFilter = (filter) => {
            currentHistoryFilter = filter;
            renderHistory(1);
        };

        window.cancelCheckIn = async () => {
             showLoader();
             try { 
                 await fetch(`${TRAKT_API_URL}/checkin`, { method: 'DELETE', headers: traktHeader() }); 
                 showToast('Check-in cancelled'); 
                 setTimeout(checkActiveWatching, 500);
             } catch(e){ showToast('Failed to cancel', 'error'); }
             hideLoader();
        };

        async function checkActiveWatching() {
            try {
                const banner = document.getElementById('active-checkin-banner');
                const headerStatus = document.getElementById('header-watch-status');
                
                const res = await fetch(`${TRAKT_API_URL}/users/me/watching`, { headers: traktHeader() });
                
                if(res.status === 204) { 
                    banner.classList.add('hidden'); 
                    headerStatus.classList.add('hidden');
                    return; 
                } 
                
                const data = await res.json();
                if (data && (data.movie || data.show)) {
                    const type = data.type;
                    const id = type === 'episode' ? data.episode.ids.trakt : data.movie.ids.trakt;
                    const navType = type === 'episode' ? 'episode' : 'movie';
                    const title = type === 'episode' ? `${data.show.title}: ${data.episode.title}` : data.movie.title;
                    const sub = type === 'episode' ? `S${data.episode.season}E${data.episode.number}` : data.movie.year;
                    
                    // Update Header Icon
                    headerStatus.innerHTML = `<button onclick="location.hash='#detail/${navType}/${id}'" class="text-red-500 hover:text-red-400 transition" title="Now Watching: ${title}"><i class="fa-solid fa-circle-play text-xl drop-shadow-[0_0_8px_rgba(239,68,68,0.6)]"></i></button>`;
                    headerStatus.classList.remove('hidden');

                    // Update Bottom Banner
                    banner.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden cursor-pointer" onclick="location.hash='#detail/${navType}/${id}'">
                            <div class="animate-pulse w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_red]"></div>
                            <div class="truncate">
                                <p class="text-[10px] text-purple-300 font-bold uppercase tracking-wider leading-none">Now Watching</p>
                                <p class="font-bold text-sm truncate leading-tight">${title} <span class="opacity-50 font-normal text-xs ml-1">${sub}</span></p>
                            </div>
                        </div>
                        <button onclick="window.cancelCheckIn()" class="ml-2 text-xs bg-black/30 hover:bg-black/50 px-3 py-1 rounded text-red-300 border border-red-900/50 transition whitespace-nowrap flex items-center"><i class="fa-solid fa-stop mr-1"></i> Stop</button>
                    `;
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                    headerStatus.classList.add('hidden');
                }
            } catch(e) {}
        }

        function renderHistory(page = 1) {
            if (page === 1) { 
    els.content.innerHTML = `
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 mt-4 gap-4">
        <h2 class="text-2xl font-bold">History</h2>
        <div class="flex bg-gray-900 p-1 rounded-lg border border-gray-700 flex-wrap justify-center">
            <button onclick="window.setHistoryFilter('all')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'all' ? 'bg-[var(--primary)] text-white' : 'text-gray-400 hover:text-white'}">All</button>
            <button onclick="window.setHistoryFilter('movies')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'movies' ? 'bg-[var(--primary)] text-white' : 'text-gray-400 hover:text-white'}">Movies</button>
            <button onclick="window.setHistoryFilter('episodes')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'episodes' ? 'bg-[var(--primary)] text-white' : 'text-gray-400 hover:text-white'}">Episodes</button>
            <button onclick="window.setHistoryFilter('unrated')" class="px-4 py-2 rounded-md text-xs font-bold transition ${currentHistoryFilter === 'unrated' ? 'bg-yellow-600 text-white' : 'text-gray-400 hover:text-yellow-500'}"><i class="fa-solid fa-star-half-stroke mr-1"></i> Unrated</button>
        </div>
    </div>
    
    <div id="history-resume-section" class="mb-10 hidden animate-fade"></div>
    <div id="history-list-container" class="space-y-1 max-w-4xl mx-auto"></div>
    <div id="load-more-container" class="text-center mt-8 pb-8"></div>`;
    
    // Logic to populate resume section
    if (userPlayback.size > 0) {
        const resumeContainer = document.getElementById('history-resume-section');
        const items = Array.from(userPlayback.values()).sort((a,b) => new Date(b.paused_at) - new Date(a.paused_at));
        
        if (items.length > 0) {
            resumeContainer.innerHTML = `
                <h3 class="font-bold text-gray-500 text-xs uppercase mb-4 tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-circle-pause"></i> In Progress / Paused
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${items.map(item => {
                            const isMovie = item.type === 'movie';
                            const data = isMovie ? item.movie : item.episode;
                            const title = isMovie ? data.title : `${item.show.title}: ${data.title}`;
                            const img = getImage(item, null, true);
                            return `
                            <div class="card p-3 rounded-xl flex items-center gap-4 border border-blue-900/30 bg-gradient-to-r from-blue-900/10 to-transparent cursor-pointer hover:border-blue-500/50 transition group" onclick="location.hash='#detail/${item.type}/${data.ids.trakt}'">
                                <div class="w-20 h-12 rounded-lg overflow-hidden relative flex-shrink-0 bg-gray-900 shadow-lg">
                                    <img src="${img}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                                    <div class="absolute bottom-0 w-full h-1 bg-gray-700"><div class="bg-blue-500 h-full shadow-[0_0_5px_#3b82f6]" style="width: ${item.progress}%"></div></div>
                                </div>
                                <div class="min-w-0 flex-grow">
                                    <p class="font-bold text-sm truncate text-blue-100 group-hover:text-white transition">${title}</p>
                                    <p class="text-xs text-blue-400 font-mono">${Math.round(item.progress)}% Watched</p>
                                </div>
                                <button class="scrobble-btn text-xs bg-gray-800 hover:bg-white hover:text-black px-3 py-2 rounded-lg font-bold transition shadow-md border border-gray-700" onclick="event.stopPropagation()" data-json='${JSON.stringify({ids: data.ids, title: title, type: item.type, runtime: data.runtime}).replace(/'/g, "&apos;")}' data-type="${item.type}">Update</button>
                            </div>`
                    }).join('')}
                </div>`;
            resumeContainer.classList.remove('hidden');
        }
    }
}
            
            isFetchingHistory = true; showLoader();
            
            // FETCH STRATEGY: If unrated, grab 100 at a time to increase odds of finding unrated items
            let limit = currentHistoryFilter === 'unrated' ? 100 : 20;
            
            let url = `/sync/history?limit=${limit}&page=${page}&extended=images`;
            if (currentHistoryFilter !== 'all' && currentHistoryFilter !== 'unrated') url += `&type=${currentHistoryFilter}`;

            if (page === 1) localStorage.removeItem(`trakt_cache_${url}`);

            fetchSmart(url, (data, fromCache) => {
                 // Client-side filter for unrated items
                 if (currentHistoryFilter === 'unrated') {
                     data = data.filter(item => {
                         const id = item.type === 'episode' ? item.episode.ids.trakt : item.movie.ids.trakt;
                         // Check global ratings map
                         return !userRatings.has(parseInt(id));
                     });
                 }

                 const container = document.getElementById('history-list-container');
                 const loadMoreContainer = document.getElementById('load-more-container');

                 if (data.length === 0) {
                     if(page === 1) container.innerHTML = `<div class="text-center p-10 text-gray-500">No history found for this filter.</div>`;
                     else loadMoreContainer.innerHTML = `<p class="text-gray-600 text-sm italic opacity-50">No more unrated items in this batch.</p><button id="btn-force-next" class="mt-2 text-xs text-[var(--primary)] hover:underline">Search Next Batch</button>`;
                     
                     const forceBtn = document.getElementById('btn-force-next');
                     if(forceBtn) forceBtn.onclick = () => { historyPage++; renderHistory(historyPage); };
                     
                     hideLoader(); return;
                 }
                
                let lastDate = null;
                // Basic date header logic logic reused...
                // (Using existing logic just simpler here)
                const listHtml = data.map(item => {
                    const type = item.type;
                    const navType = type === 'episode' ? 'episode' : 'movie';
                    const navId = type === 'episode' ? item.episode.ids.trakt : item.movie.ids.trakt;
                    const titleText = (type === 'episode') ? `<span class="text-gray-400 text-sm font-normal">${item.show.title}</span> <br> ${item.episode.season}x${item.episode.number}: <span class="text-gray-200">${item.episode.title}</span>` : item.movie.title;
                    const displayImageObj = type === 'episode' ? item.episode : item.movie;
                    const img = getImage(displayImageObj, type, true); 
                    const myRating = userRatings.get(parseInt(navId));
                    const rateDisplay = myRating ? `<span class="text-green-400 font-bold ml-auto text-xs"><i class="fa-solid fa-user-check"></i> ${myRating}</span>` : '';
                    
                    const wDate = new Date(item.watched_at);
                    const dateStr = wDate.toLocaleDateString();
                    const prettyDate = wDate.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
                    const timeStr = wDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    let headerHtml = '';
                    // Only show header if it's the first page OR date changed significantly
                    // Note: In append mode, this logic is imperfect but sufficient for lists
                    return `
                    <div class="card p-3 rounded-xl flex items-center gap-4 hover:bg-[var(--card)] border border-transparent hover:border-gray-600 transition group relative animate-fade bg-[var(--card)]/40 mb-1" onclick="location.hash='#detail/${navType}/${navId}'">
                        <div class="relative w-24 h-14 md:w-32 md:h-20 flex-shrink-0 overflow-hidden rounded-lg shadow-md bg-gray-800">
                            <img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='${PLACEHOLDER_IMG}'">
                            <div class="absolute bottom-0 right-0 bg-black/80 text-white text-[8px] px-1.5 py-0.5 rounded-tl font-bold uppercase tracking-wider">${type}</div>
                        </div>
                        <div class="flex-grow min-w-0 flex flex-col justify-center">
                            <div class="flex items-start">
                                <h3 class="font-bold text-sm md:text-base leading-tight cursor-pointer hover:text-[var(--primary)] transition mr-2 line-clamp-2">${titleText}</h3>
                                ${rateDisplay}
                            </div>
                            <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                                <span><i class="fa-solid fa-clock opacity-50 mr-1"></i> ${prettyDate} ${timeStr}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition px-2">
                             <button class="text-xs bg-red-900/20 text-red-400 p-2 rounded hover:bg-red-500 hover:text-white transition" onclick="event.stopPropagation(); window.deleteHistoryItem('${navId}', '${type}', '${item.watched_at}', this)" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
                
                container.insertAdjacentHTML('beforeend', listHtml);
                
                // Smart "Load More" - if we got full batch (20 or 100), show button
                // Even if we filtered down to 5 items, if the API returned 100, there might be more next page.
                loadMoreContainer.innerHTML = `<button id="btn-load-more" class="bg-gray-800 hover:bg-gray-700 text-white px-8 py-3 rounded-full font-bold transition shadow-lg border border-gray-600 hover:border-white">Load More</button>`;
                document.getElementById('btn-load-more').onclick = () => { historyPage++; renderHistory(historyPage); };
                
                isFetchingHistory = false; hideLoader();
            });
        }

        function renderSettings() { els.content.innerHTML = `<h1 class="text-3xl font-bold mb-6">Settings</h1><div class="grid gap-6 animate-fade"><div class="card p-8 rounded-2xl max-w-2xl border border-gray-800"><h2 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-file-export mr-3 text-[var(--primary)]"></i> Data Export</h2><p class="text-gray-400 mb-6">Download your entire listening/watching history as a CSV file for backup or analysis.</p><button id="export-btn" class="btn-primary px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-[var(--primary)]/30 transition">Export History to CSV</button></div><div class="card p-8 rounded-2xl max-w-2xl border border-gray-800"><h2 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-database mr-3 text-blue-500"></i> Storage</h2><p class="text-gray-400 mb-6">If images look broken or data is stale, try clearing the local cache.</p><button id="clear-cache-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition">Clear Local Cache</button></div></div>`; setTimeout(() => { const exportBtn = document.getElementById('export-btn'); const clearBtn = document.getElementById('clear-cache-btn'); if(exportBtn) exportBtn.onclick = async () => { showLoader(); try { const data = await fetchDirect('/sync/history?limit=10000'); if(!data.length) return showToast('No history', 'error'); const csv = "Title,Type,Year,TraktID,WatchedAt\n" + data.map(i => `${(i.type==='episode'?`${i.show.title}: ${i.episode.title}`:i.movie.title).replace(/,/g,'')},${i.type},${i.type==='episode'?i.show.year:i.movie.year},${i.type==='episode'?i.episode.ids.trakt:i.movie.ids.trakt},${i.watched_at}`).join("\n"); const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = "history.csv"; document.body.appendChild(link); link.click(); link.remove(); showToast('Exported'); } catch(e) { showToast('Export failed', 'error'); } hideLoader(); }; if(clearBtn) clearBtn.onclick = () => { localStorage.clear(); showToast('Cache Cleared! Refreshing...'); setTimeout(() => location.reload(), 1500); }; }, 100); }
        
        function renderLibrary(activeTab = 'watchlist') {
            els.content.innerHTML = `
                <div class="flex items-center justify-between mb-8 mt-4 animate-fade">
                    <h2 class="text-2xl font-bold border-l-4 border-[var(--primary)] px-3">Your Library</h2>
                    <div class="flex bg-gray-900/50 p-1 rounded-lg border border-gray-700">
                        <button id="tab-wl" class="px-5 py-2 rounded-md text-sm font-bold transition ${activeTab === 'watchlist' ? 'bg-[var(--primary)] text-white shadow' : 'text-gray-400 hover:text-white'}" onclick="window.switchLib('watchlist')">Watchlist</button>
                        <button id="tab-lists" class="px-5 py-2 rounded-md text-sm font-bold transition ${activeTab === 'lists' ? 'bg-[var(--primary)] text-white shadow' : 'text-gray-400 hover:text-white'}" onclick="window.switchLib('lists')">Custom Lists</button>
                    </div>
                </div>
                <div id="lib-target"></div>
            `;
            
            window.switchLib = (tab) => {
                const btnWl = document.getElementById('tab-wl');
                const btnLists = document.getElementById('tab-lists');
                
                if(tab === 'watchlist') {
                    btnWl.className = "px-5 py-2 rounded-md text-sm font-bold transition bg-[var(--primary)] text-white shadow";
                    btnLists.className = "px-5 py-2 rounded-md text-sm font-bold transition text-gray-400 hover:text-white";
                    renderWatchlist('added', 'lib-target');
                } else {
                    btnLists.className = "px-5 py-2 rounded-md text-sm font-bold transition bg-[var(--primary)] text-white shadow";
                    btnWl.className = "px-5 py-2 rounded-md text-sm font-bold transition text-gray-400 hover:text-white";
                    renderLists('lib-target');
                }
            };

            if(activeTab === 'watchlist') renderWatchlist('added', 'lib-target');
            else renderLists('lib-target');
        }

        async function renderProgress() {
            showLoader();
            els.content.innerHTML = '';
            
            try {
                // 1. Fetch Global Stats & Recent Activity in parallel
                const [stats, watchedShows, watchedMovies] = await Promise.all([
                    fetchDirect('/users/me/stats'),
                    fetchDirect('/sync/watched/shows?limit=12&extended=noseasons'), // Get last 12 active shows
                    fetchDirect('/sync/history/movies?limit=10&extended=images')     // Get last 10 movies
                ]);

                // 2. Fetch detailed progress for the shows (to get aired counts)
                // We map over the shows to get specific progress data for the bars
                const showProgressData = await Promise.all(watchedShows.map(async (item) => {
                    try {
                        const prog = await fetchDirect(`/shows/${item.show.ids.trakt}/progress/watched?hidden=false&specials=false&count_specials=false`);
                        return { ...item, stats: prog };
                    } catch(e) { return null; }
                }));
                const validShows = showProgressData.filter(s => s !== null);

                // 3. Build HTML
                els.content.innerHTML = `
                    <div class="animate-fade space-y-8">
                        
                        <div>
                            <h2 class="text-2xl font-bold mb-6 border-l-4 border-[var(--primary)] px-3">Lifetime Stats</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="card p-6 rounded-xl border border-gray-800 flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-[var(--primary)]/20 flex items-center justify-center text-[var(--primary)]"><i class="fa-solid fa-clock text-xl"></i></div>
                                    <div>
                                        <p class="text-xs text-gray-500 font-bold uppercase">Total Watch Time</p>
                                        <p class="text-2xl font-bold text-white">${Math.round((stats.movies.minutes + stats.episodes.minutes) / 60).toLocaleString()} <span class="text-sm font-normal text-gray-500">hours</span></p>
                                    </div>
                                </div>
                                <div class="card p-6 rounded-xl border border-gray-800 flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500"><i class="fa-solid fa-film text-xl"></i></div>
                                    <div>
                                        <p class="text-xs text-gray-500 font-bold uppercase">Movies</p>
                                        <p class="text-2xl font-bold text-white">${stats.movies.watched.toLocaleString()}</p>
                                    </div>
                                </div>
                                <div class="card p-6 rounded-xl border border-gray-800 flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-tv text-xl"></i></div>
                                    <div>
                                        <p class="text-xs text-gray-500 font-bold uppercase">Episodes</p>
                                        <p class="text-2xl font-bold text-white">${stats.episodes.watched.toLocaleString()}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-bars-progress mr-2 text-yellow-500"></i> Series Progress</h3>
                                <div class="space-y-4">
                                    ${validShows.map(item => {
                                        const aired = item.stats.aired;
                                        const completed = item.stats.completed;
                                        const percent = aired > 0 ? Math.round((completed / aired) * 100) : 0;
                                        const nextEp = item.stats.next_episode ? `Next: S${item.stats.next_episode.season}E${item.stats.next_episode.number}` : '<span class="text-green-500"><i class="fa-solid fa-check"></i> Up to date</span>';
                                        
                                        return `
                                        <div class="card p-4 rounded-xl border border-gray-800 hover:border-yellow-500 transition cursor-pointer group" onclick="location.hash='#detail/show/${item.show.ids.trakt}'">
                                            <div class="flex justify-between items-end mb-2">
                                                <h4 class="font-bold truncate text-gray-200 group-hover:text-yellow-500 transition">${item.show.title}</h4>
                                                <span class="text-xs text-gray-500">${completed} / ${aired} eps</span>
                                            </div>
                                            <div class="w-full bg-gray-900 rounded-full h-2.5 mb-2 overflow-hidden">
                                                <div class="bg-gradient-to-r from-yellow-600 to-yellow-400 h-2.5 rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="flex justify-between items-center text-xs">
                                                <span class="text-gray-400 font-mono">${percent}% Complete</span>
                                                <span class="text-gray-500">${nextEp}</span>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>

                            <div class="space-y-8">
                                <div>
                                    <h3 class="text-xl font-bold mb-4">Format Split</h3>
                                    <div class="card p-4 rounded-xl border border-gray-800 h-64">
                                        <canvas id="progress-chart"></canvas>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-ticket mr-2 text-[var(--primary)]"></i> Recent Films</h3>
                                    <div class="space-y-3">
                                        ${watchedMovies.map(h => {
                                            const myRating = userRatings.get(parseInt(h.movie.ids.trakt));
                                            const ratingDisplay = myRating 
                                                ? `<span class="text-green-400 text-xs font-bold"><i class="fa-solid fa-star"></i> ${myRating}</span>` 
                                                : `<span class="text-gray-600 text-xs">-</span>`;
                                            
                                            return `
                                            <div class="flex gap-3 items-center card p-2 pr-4 rounded-lg border border-transparent hover:border-gray-700 transition cursor-pointer" onclick="location.hash='#detail/movie/${h.movie.ids.trakt}'">
                                                <img src="${getImage(h.movie, 'movie')}" class="w-10 h-14 object-cover rounded bg-gray-800">
                                                <div class="min-w-0 flex-1">
                                                    <p class="font-bold text-sm truncate text-gray-200">${h.movie.title}</p>
                                                    <p class="text-xs text-gray-500">${h.movie.year}</p>
                                                </div>
                                                ${ratingDisplay}
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                // Render Chart
                if (progressChartInstance) progressChartInstance.destroy();
                const ctx = document.getElementById('progress-chart').getContext('2d');
                progressChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Movies', 'Episodes'],
                        datasets: [{
                            data: [stats.movies.minutes, stats.episodes.minutes],
                            backgroundColor: ['#ed2224', '#eab308'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#9ca3af', font: { size: 10 } } }
                        }
                    }
                });

            } catch(e) {
                console.error(e);
                showToast('Failed to load details', 'error');
            }
            hideLoader();
        }

        function renderWatchlist(sort = 'added', containerId = 'content') { 
            const container = document.getElementById(containerId) || els.content;
            container.innerHTML = `<div class="flex justify-end mb-6 animate-fade"><select id="wl-sort" class="bg-gray-800 border border-gray-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-[var(--primary)]"><option value="added" ${sort==='added'?'selected':''}>Recently Added</option><option value="rank" ${sort==='rank'?'selected':''}>Rank</option><option value="title" ${sort==='title'?'selected':''}>Title</option><option value="released" ${sort==='released'?'selected':''}>Release Date</option><option value="runtime" ${sort==='runtime'?'selected':''}>Runtime</option></select></div><div id="wl-grid"></div>`; 
            
            showLoader(); 
            document.getElementById('wl-sort').onchange = (e) => renderWatchlist(e.target.value, containerId); 
            
            fetchSmart(`/sync/watchlist/movies?extended=images&sort=${sort},asc`, (movies) => { 
                fetchSmart(`/sync/watchlist/shows?extended=images&sort=${sort},asc`, (shows) => { 
                    let data = [...movies.map(m=>({...m, type:'movie'})), ...shows.map(s=>({...s, type:'show'}))]; 
                    if (sort === 'added' || sort === 'released') data.sort((a, b) => new Date(b[sort==='added'?'listed_at':'released']) - new Date(a[sort==='added'?'listed_at':'released'])); 
                    else if (sort === 'title') data.sort((a, b) => (a.movie||a.show).title.localeCompare((b.movie||b.show).title)); 
                    
                    if(data.length === 0) document.getElementById('wl-grid').innerHTML = `<div class="text-center p-20 text-gray-500 animate-fade"><i class="fa-solid fa-inbox text-6xl mb-4 opacity-50"></i><p>Your watchlist is empty.</p></div>`; 
                    else renderGrid('', data, false, 'wl-grid'); 
                    hideLoader(); 
                }, `cache_wl_shows_${sort}`); 
            }, `cache_wl_movies_${sort}`); 
        }

        async function renderLists(containerId = 'content') { 
            const container = document.getElementById(containerId) || els.content;
            container.innerHTML = ''; 
            showLoader(); 
            try { 
                const lists = await fetchDirect(`/users/me/lists?extended=full`); 
                if (lists.length === 0) container.innerHTML = `<div class="text-center p-20 text-gray-500"><i class="fa-solid fa-list-ul text-6xl mb-4 opacity-50"></i><p>You have no custom lists.</p></div>`; 
                else container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade">${lists.map(list => `<div class="card p-6 rounded-xl border border-gray-700 hover:border-purple-500 cursor-pointer transition group" onclick="location.hash='#lists/${list.ids.trakt}'"><div class="flex justify-between items-start mb-4"><h3 class="font-bold text-xl group-hover:text-purple-400 transition">${list.name}</h3><span class="bg-gray-800 text-xs px-2 py-1 rounded text-gray-400"><i class="fa-solid fa-layer-group mr-1"></i> ${list.item_count}</span></div><p class="text-gray-400 text-sm line-clamp-2 h-10 mb-4">${list.description || 'No description provided.'}</p><div class="flex items-center gap-4 text-xs text-gray-500"><span><i class="fa-solid fa-heart text-[var(--primary)] opacity-70"></i> ${list.likes}</span><span><i class="fa-solid fa-lock${list.privacy==='private'?'':'-open'}"></i> ${list.privacy}</span><span class="ml-auto text-purple-400 font-bold group-hover:translate-x-1 transition">View Items <i class="fa-solid fa-arrow-right"></i></span></div></div>`).join('')}</div>`; 
            } catch (e) { showToast('Could not load lists', 'error'); } 
            hideLoader(); 
        }

        async function handleAction(actionType) {
            if (!currentModalItem || !currentModalItem.item || !currentModalItem.item.ids || !currentModalItem.item.ids.trakt) {
                showToast("Error: Invalid item data", "error");
                els.modal.classList.add('hidden');
                return;
            }

            els.modal.classList.add('hidden'); 
            showLoader(); 
            
            const traktId = currentModalItem.item.ids.trakt;
            const type = currentModalItem.type;
            const rootKey = type === 'episode' ? 'episodes' : (type === 'show' ? 'shows' : 'movies'); 
            const ids = { ids: { trakt: traktId } }; 
            
            // Get inputs
            const dateStr = document.getElementById('custom-date').value; 
            const date = dateStr ? new Date(dateStr).toISOString() : selectedDate; 
            const rating = parseInt(els.ratingSlider.value); 
            const minutes = parseInt(document.getElementById('custom-progress').value);
            const runtime = currentModalItem.item.runtime;

            try { 
                // 1. Handle Rating
                if (actionType === 'rate-only' || actionType === 'rate-log') {
                     const payloadRate = { [rootKey]: [{ ...ids, rating: rating, rated_at: new Date().toISOString() }] }; 
                     await fetch(`${TRAKT_API_URL}/sync/ratings`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadRate) }); 
                     userRatings.set(traktId, rating); 
                     if(actionType === 'rate-only') showToast(`Rated ${rating}/10`);
                }

                // 2. Handle Logging vs Scrobbling (Partial Watch)
                if (actionType !== 'rate-only') {
                    if (minutes > 0 && runtime > 0 && minutes < runtime) {
                        // Partial Watch: Use Scrobble Stop to set progress
                        const progress = Math.min(100, (minutes / runtime) * 100);
                        const payloadScrobble = { [type === 'episode' ? 'episode' : 'movie']: { ...ids }, progress: progress, app_version: "1.0" };
                        await fetch(`${TRAKT_API_URL}/scrobble/stop`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadScrobble) });
                        showToast(`Progress updated to ${Math.round(progress)}%`);
                    } else {
                        // Full Watch: Add to History
                        const payloadLog = { [rootKey]: [{ ...ids, watched_at: date }] }; 
                        await fetch(`${TRAKT_API_URL}/sync/history`, { method: 'POST', headers: traktHeader(), body: JSON.stringify(payloadLog) }); 
                        showToast(`Logged as Watched`); 
                    }
                }
                
                // Refresh Views
                if (location.hash.startsWith('#detail')) {
                     const parts = location.hash.split('/');
                     if(parts[3] === 'season' && parts[4]) renderDetail(parts[1], parts[2], parts[4]);
                     else renderDetail(parts[1], parts[2]);
                }
                if (document.getElementById('up-next-container')) loadUpNext(); 
                if (document.getElementById('last-watched-container')) loadLastWatched();

            } catch(e) { console.error(e); showToast('Action failed', 'error'); } 
            hideLoader(); 
        }

        async function loadSearch(rawQuery) {
            if (!rawQuery) return;
            showLoader();
            els.content.innerHTML = '';
            
            // Fix: Decode the query first to avoid double-encoding spaces (e.g., %20 -> %2520)
            const query = decodeURIComponent(rawQuery);

            try {
                // Fix: Use URLSearchParams to handle encoding correctly (spaces become + or %20 automatically)
                const searchParams = new URLSearchParams({ query: query, extended: 'images' });
                
                // Fix: Split into two valid API calls
                const [movies, shows] = await Promise.all([
                    fetchDirect(`/search/movie?${searchParams.toString()}`),
                    fetchDirect(`/search/show?${searchParams.toString()}`)
                ]);

                const data = [...movies, ...shows].sort((a, b) => (b.score || 0) - (a.score || 0));

                if (data.length === 0) {
                    els.content.innerHTML = `<div class="text-center p-20 text-gray-500 animate-fade"><i class="fa-solid fa-magnifying-glass text-6xl mb-4 opacity-50"></i><p>No results found.</p></div>`;
                } else {
                    renderGrid(`Results: "${query}"`, data);
                }
            } catch (e) {
                console.error(e);
                showToast('Search failed', 'error');
            }
            hideLoader();
        }
        async function renderListItems(listId) { els.content.innerHTML = ''; showLoader(); try { const [listInfo, items] = await Promise.all([fetchDirect(`/users/me/lists/${listId}`), fetchDirect(`/users/me/lists/${listId}/items?extended=images`)]); els.content.innerHTML = `<div class="flex items-center justify-between mb-6"><div><h2 class="text-3xl font-bold">${listInfo.name}</h2><p class="text-gray-400 text-sm mt-1">${listInfo.item_count} items</p></div><button onclick="location.hash='#library'" class="text-sm bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg transition"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Lists</button></div><div id="list-grid"></div>`; if (items.length > 0) renderGrid('', items, false, 'list-grid'); else document.getElementById('list-grid').innerHTML = `<p class="text-gray-500 italic">This list is empty.</p>`; } catch (e) { showToast('Could not load list items', 'error'); } hideLoader(); }

        function handleRoute() {
            const hash = location.hash || '#dashboard';
            document.querySelectorAll('.nav-link, .nav-tab').forEach(l => l.classList.remove('active'));
            const link = document.querySelector(`a[href="${hash.split('/')[0]}"]`);
            if(link) link.classList.add('active');
            
            document.querySelectorAll('.mobile-nav-link').forEach(l => l.classList.remove('active'));
            const mobileLink = document.querySelector(`.mobile-nav-link[href="${hash.split('/')[0]}"]`);
            if(mobileLink) mobileLink.classList.add('active');

            if(hash.startsWith('#dashboard')) renderDashboard();
            else if(hash.startsWith('#library')) renderLibrary(); 
            else if(hash.startsWith('#watchlist')) renderLibrary('watchlist'); 
            else if(hash.startsWith('#history')) renderHistory();
            else if(hash.startsWith('#progress')) renderProgress();
            else if(hash.startsWith('#settings')) renderSettings();
            else if(hash === '#lists') renderLibrary('lists'); 
            else if(hash.startsWith('#lists/')) renderListItems(hash.split('/')[1]);
            else if(hash.startsWith('#search')) loadSearch(hash.split('/')[1]);
            else if(hash.startsWith('#detail')) {
                const parts = hash.split('/');
                if (parts[1] === 'person') {
                    // NEW: Handle Person Route
                    renderPerson(parts[2]);
                } else if(parts[3] === 'season' && parts[4]) {
                    renderDetail(parts[1], parts[2], parts[4]);
                } else {
                    renderDetail(parts[1], parts[2]);
                }
            }
        }
        window.addEventListener('hashchange', handleRoute);

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if (location.hash.startsWith('#history')) {
                    renderHistory(1); 
                }
            }
        });

        // --- Progress Slider Logic ---
const slider = document.getElementById('progress-slider');
const numInput = document.getElementById('custom-progress');
const percentDisplay = document.getElementById('progress-percent-display');

// Sync Slider -> Number Input
slider.addEventListener('input', (e) => {
    const pct = parseInt(e.target.value);
    percentDisplay.innerText = `${pct}%`;
    if(currentModalItem && currentModalItem.item.runtime) {
        numInput.value = Math.round((pct / 100) * currentModalItem.item.runtime);
    }
});

// Sync Number Input -> Slider
numInput.addEventListener('input', (e) => {
    if(currentModalItem && currentModalItem.item.runtime) {
        const val = parseInt(e.target.value) || 0;
        const pct = Math.min(100, Math.round((val / currentModalItem.item.runtime) * 100));
        slider.value = pct;
        percentDisplay.innerText = `${pct}%`;
    }
});

// "Mark 100% Watched" Button Handler
document.getElementById('btn-mark-watched').onclick = () => {
    if(currentModalItem && currentModalItem.item.runtime) {
        slider.value = 100;
        numInput.value = currentModalItem.item.runtime;
        handleAction('log-only'); // This will trigger the "Full Watch" logic in handleAction
    }
};

        els.ratingSlider.oninput = (e) => els.ratingValue.innerText = e.target.value;
        const searchHandler = debounce((e) => {
            const val = e.target.value.trim();
            if (val.length > 1) location.hash = `#search/${val}`; else if (val.length === 0) history.back();
        }, 600);
        document.getElementById('search-input').addEventListener('input', searchHandler);
        document.getElementById('mobile-search-input').addEventListener('input', searchHandler);

        document.addEventListener('click', e => {
            const btn = e.target.closest('.scrobble-btn');
            if (btn) {
                const data = JSON.parse(btn.dataset.json);
                // FIX: Trust the type in the JSON data first. 
                // Only fall back to dataset logic if data.type is missing.
                const itemType = data.type || (btn.dataset.type === 'show' ? 'episode' : 'movie');
                
                currentModalItem = { item: data, type: itemType };
                document.getElementById('custom-progress').value = ''; // Add this line
document.getElementById('modal-title').innerText = data.title;
                els.modal.classList.remove('hidden');
                if(data.runtime) {
        // Check if we have existing progress in userPlayback map
        const existing = userPlayback.get(parseInt(data.ids.trakt));
        const currentPct = existing ? existing.progress : 0;
        
        slider.value = Math.round(currentPct);
        percentDisplay.innerText = `${Math.round(currentPct)}%`;
        numInput.value = Math.round((currentPct/100) * data.runtime);
    }
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('custom-date').value = now.toISOString().slice(0, 16);
                selectedDate = new Date().toISOString();
            }
            // ... (keep existing listeners for closing modal etc if you have them, otherwise just close the block)
            if(e.target.closest('.date-option')) {
                const type = e.target.closest('.date-option').dataset.date;
                const d = new Date(); if(type === 'yesterday') d.setDate(d.getDate()-1);
                selectedDate = d.toISOString();
                document.querySelectorAll('.date-option').forEach(b => b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10'));
                e.target.closest('.date-option').classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10');
            }
            if(e.target.closest('#confirm-log')) handleAction('log-only');
            if(e.target.closest('#confirm-rate-log')) handleAction('rate-log');
            if(e.target.closest('#confirm-rate-only')) handleAction('rate-only');
            if(e.target.closest('#close-modal')) els.modal.classList.add('hidden');
        });

        // --- AUTH INIT ---
        onAuthStateChanged(auth, async user => {
            currentUser = user;
            if (user) {
                els.auth.innerHTML = `<button id="logout" class="p-2 rounded-lg hover:bg-red-900/20 hover:text-red-500 transition text-gray-500 dark:text-gray-400" title="Sign Out"><i class="fa-solid fa-right-from-bracket"></i></button>`;
                document.getElementById('logout').onclick = () => signOut(auth);
                document.getElementById('main-nav').classList.remove('hidden'); els.searchContainer.classList.remove('hidden');

                // SYNC STRATEGY: Fetch from Firestore first. If it exists there, it's the source of truth.
                try {
                    const snap = await getDoc(doc(db, 'users', user.uid, 'services', 'trakt'));
                    if (snap.exists() && snap.data().accessToken) { 
                        const dbToken = snap.data().accessToken;
                        // If DB token differs from local, update local
                        if (traktAccessToken !== dbToken) {
                            traktAccessToken = dbToken;
                            localStorage.setItem('trakt_token', traktAccessToken);
                        }
                    } else if (traktAccessToken) {
                        // If we have local but no DB, push local to DB to sync
                        await setDoc(doc(db, 'users', user.uid, 'services', 'trakt'), { 
                            accessToken: traktAccessToken,
                            updatedAt: new Date()
                        }, { merge: true });
                    }
                } catch(e) { console.warn("Firestore sync error", e); }

                if (traktAccessToken) { 
    await Promise.all([syncUserRatings(), syncPlayback()]); // Updated line
}
                checkActiveWatching()
                handleRoute();
            } else { 
                els.content.innerHTML = `<div class="max-w-md mx-auto card p-10 rounded-2xl shadow-2xl mt-12 text-center animate-fade"><div class="mb-6 inline-block p-4 rounded-full bg-[var(--primary)]/10"><i class="fa-solid fa-ticket text-5xl text-[var(--primary)]"></i></div><h1 class="text-4xl font-bold mb-2 text-[var(--primary)]">VidTrackr</h1><p class="text-gray-400 mb-8">Sign in to track your movies and shows.</p><button class="w-full bg-white text-gray-900 font-bold py-3 rounded-lg hover:bg-gray-200 transition mb-4 shadow-lg" onclick="document.getElementById('email-login').classList.remove('hidden'); this.classList.add('hidden');">Sign In / Sign Up</button><form id="email-login" class="space-y-4 hidden animate-fade"><input type="email" id="email" placeholder="Email" class="w-full p-4 rounded-lg bg-[var(--bg)] border border-gray-700 focus:border-[var(--primary)] outline-none transition" required><input type="password" id="password" placeholder="Password" class="w-full p-4 rounded-lg bg-[var(--bg)] border border-gray-700 focus:border-[var(--primary)] outline-none transition" required><div class="flex gap-3"><button type="submit" name="login" class="flex-1 btn-primary py-3 rounded-lg font-bold">Login</button><button type="submit" name="signup" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold transition">Sign Up</button></div></form></div>`; 
                document.getElementById('email-login').onsubmit = async (e) => { e.preventDefault(); try { if (e.submitter.name === 'signup') await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); else await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(err) { showToast(err.message, 'error'); } };
            }
        });
        document.getElementById('theme-toggle').onclick = () => { document.documentElement.classList.toggle('dark'); document.documentElement.classList.toggle('light'); };
    </script>
</body>
</html>