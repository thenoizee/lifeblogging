<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetManagr</title>
    <link rel="icon" href="/favicons/paw.svg" type="image/svg+xml"> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
    <style>
        :root {
            --bg-color: #f7fafc;
            --card-bg-color: white;
            --text-color-primary: #1a202c;
            --text-color-secondary: #4a5568;
            --input-bg-color: #e2e8f0;
            --button-bg: #4c51bf;
            --button-hover: #434190;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --font-family: 'Inter', sans-serif;
            --stats-box-bg: #e0e7ff;
            --stats-box-text: #3730a3;
            --gold-border: #f59e0b;
            --gold-bg: #fef3c7;
        }

        .dark-mode {
            --bg-color: #1a202c;
            --card-bg-color: #2d3748;
            --text-color-primary: #edf2f7;
            --text-color-secondary: #a0aec0;
            --input-bg-color: #4a5568;
            --button-bg: #667eea;
            --button-hover: #5a67d8;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --stats-box-bg: #3730a3;
            --stats-box-text: #e0e7ff;
            --gold-border: #fcd34d;
            --gold-bg: #453310;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            background-color: var(--card-bg-color);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            width: 100%;
            max-width: 1024px; /* Widened slightly for pet info */
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        h1, h2 { color: var(--text-color-primary); font-weight: 700; }
        h1 { font-size: 28px; margin-bottom: 20px; }
        h2 { font-size: 20px; margin-bottom: 10px; }
        h3 { font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color-primary); }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); background-color: var(--input-bg-color);
            color: var(--text-color-primary); border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: all 0.2s ease;
        }
        .custom-select-wrapper { position: relative; }
        .custom-select-wrapper select { appearance: none; -webkit-appearance: none; -moz-appearance: none; }
        .custom-select-wrapper::after {
            content: '\f078'; /* Font Awesome caret-down */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-color-secondary);
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 0 2px rgba(76, 81, 191, 0.2); }
        .button-group { display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap; }
        .button-group button { flex-grow: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease; color: white; }
        .button-group button:disabled { opacity: 0.6; cursor: not-allowed; }
        .main-button { background-color: var(--button-bg); }
        .main-button:hover:not(:disabled) { background-color: var(--button-hover); }
        .destructive-button { background-color: #e53e3e; }
        .destructive-button:hover:not(:disabled) { background-color: #c53030; }
        .secondary-button { background-color: #4a5568; }
        .secondary-button:hover:not(:disabled) { background-color: #2d3748; }
        .user-info { margin-bottom: 20px; color: var(--text-color-secondary); display: flex; justify-content: space-between; align-items: center; gap: 10px; font-size: 0.9rem; }
        .user-info-text { color: var(--text-color-primary); font-weight: bold; }
        .section { margin-top: 2rem; text-align: left; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        
        .pet-list, .treatment-list, .event-list { list-style: none; padding: 0; margin: 0; }
        .pet-item, .treatment-item, .event-item { background-color: var(--input-bg-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
        .pet-item-details, .treatment-item-details, .event-item-details { flex-grow: 1; }
        .pet-item-name, .treatment-item-name { font-weight: bold; font-size: 1.1rem; }
        .pet-item-sub, .treatment-item-sub { color: var(--text-color-secondary); }
        .event-item-time { font-size: 0.8rem; color: var(--text-color-secondary); }
        .pet-actions, .treatment-actions, .event-actions { display: flex; gap: 8px; }
        .pet-actions button, .treatment-actions button, .event-actions button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }

        .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 16px 30px; border-radius: 8px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out, top 0.5s ease-in-out; display: none; font-size: 18px; font-weight: 600; color: white; }
        .message-box.show { display: block; opacity: 1; }
        .message-box.success { background-color: #48bb78; }
        .message-box.error { background-color: #e53e3e; }
        .message-box.info { background-color: #3182ce; }
        .tag { background-color: var(--input-bg-color); color: var(--text-color-primary); padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; margin-right: 4px; margin-bottom: 4px; display: inline-flex; align-items: center; cursor: pointer; }
        .tag:hover { background-color: #cbd5e0; }
        .dark-mode .tag:hover { background-color: #6a7181; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .table-container { overflow-x: auto; border-radius: 0.5rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: var(--input-bg-color); color: var(--text-color-secondary); font-weight: 600; cursor: pointer; position: sticky; top: 0; }
        tbody tr:hover { background-color: var(--input-bg-color); }
        .import-export-container { display: flex; gap: 10px; flex-wrap: wrap; }
        .import-export-container button, .import-export-container label { flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; position: relative; }
        .modal-content-lg { max-width: 800px; }
        .close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 2rem; cursor: pointer; color: var(--text-color-secondary); }
        .close-btn:hover { color: var(--text-color-primary); }
        
        .top-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1rem; flex-wrap: wrap; }
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        .theme-switcher { background-color: var(--card-bg-color); border: 1px solid var(--text-color-secondary); border-radius: 9999px; padding: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
        .theme-switcher:hover:not(:disabled) { opacity: 0.8; }
        .theme-switcher:disabled { cursor: not-allowed; opacity: 0.5; }
        .theme-icon { width: 1.5rem; height: 1.5rem; color: var(--text-color-primary); }
        .dark-mode .sun-icon { display: block; }
        .dark-mode .moon-icon { display: none; }
        .sun-icon { display: none; }
        .moon-icon { display: block; }
        .stats-box { background-color: var(--stats-box-bg); color: var(--stats-box-text); transition: all 0.3s ease; border: 2px solid transparent; }
        .stats-box.warning { border-color: #dd6b20; background-color: #feebc8; color: #9c4221; }
        .stats-box.danger { border-color: #c53030; background-color: #fed7d7; color: #822727; }
        .dark-mode .stats-box.warning { background-color: #9c4221; color: #feebc8; }
        .dark-mode .stats-box.danger { background-color: #822727; color: #fed7d7; }
        .dark-mode input[type="date"], .dark-mode input[type="datetime-local"] { color-scheme: dark; }

        /* Tab Styles */
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; flex-wrap: wrap;}
        .tab-button { padding: 1rem; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-color-secondary); border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .tab-button.active { color: var(--text-color-primary); border-bottom-color: var(--button-bg); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none !important; }

        input:disabled {
            background-color: var(--text-color-secondary);
            cursor: not-allowed;
        }

        /* Dashboard reminder styles */
        .reminder-card {
            background-color: var(--input-bg-color);
            border-left: 5px solid var(--button-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .reminder-card.due {
            border-color: #e53e3e; /* Red */
        }
        .reminder-card.soon {
            border-color: #f59e0b; /* Yellow */
        }

    </style>
</head>
<body>
    <div class="container">
      <div id="auth-container">
        <h1>Welcome</h1>
        <p>Please log in or sign up to manage your pets.</p>
        <div class="input-group">
          <label for="email">Email</label>
          <input id="email" type="text" placeholder="Your email address" />
        </div>
        <div class="input-group">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Your password" />
        </div>
        <div class="button-group">
          <button id="sign-in-btn" class="main-button">Log In</button>
          <button id="sign-up-btn" class="main-button">Sign Up</button>
        </div>
      </div>
      
      <div id="main-app-container" class="hidden">
        <div class="flex justify-between items-start mb-10">
            <h1 class="text-4xl font-bold">PetManagr</h1>
            <div class="flex items-center gap-4">
                <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
                <span id="version-display" class="text-sm font-semibold text-gray-500 dark:text-gray-400"></span>
                <p class="user-info text-sm font-semibold">Logged in as: <span id="user-email-display" class="font-bold">...</span></p>
                <button id="logout-btn" class="destructive-button">Log Out</button>
                <button id="theme-toggle" class="theme-switcher" title="Toggle dark mode" disabled>
                    <svg class="theme-icon sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg class="theme-icon moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
        </div>

        <nav class="tab-nav">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="pets">Pets</button>
            <button class="tab-button" data-tab="treatments">Treatments</button>
            <button class="tab-button" data-tab="log-event">Log Event</button>
            <button class="tab-button" data-tab="history">History</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </nav>

        <div id="tab-content-dashboard" class="tab-content active">
            <fieldset class="border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg">
                <legend class="text-2xl font-semibold px-2 mb-4">Dashboard</legend>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <section>
                        <h2 class="text-xl font-bold mb-3 text-left">Upcoming Reminders</h2>
                        <div id="dashboard-reminders-container" class="space-y-3 text-left">
                            </div>
                    </section>
                    <section>
                        <h2 class="text-xl font-bold mb-3 text-left">Recent Events</h2>
                        <div id="dashboard-recent-events-container" class="space-y-3">
                            </div>
                    </section>
                </div>
            </fieldset>
        </div>

        <div id="tab-content-pets" class="tab-content">
            <fieldset class="border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg">
                <legend class="text-2xl font-semibold px-2 mb-4">Manage Pets</legend>
                
                <details class="bg-[var(--input-bg-color)] p-4 rounded-lg mb-6">
                    <summary class="font-bold cursor-pointer">Add New Pet</summary>
                    <div class="mt-4">
                        <div class="input-group"><label for="new-pet-name">Pet's Name</label><input id="new-pet-name" type="text" placeholder="e.g., Fluffy" /></div>
                        <div class="input-group"><label for="new-pet-breed">Breed / Species</label><input id="new-pet-breed" type="text" placeholder="e.g., Domestic Shorthair" /></div>
                        <div class="input-group"><label for="new-pet-dob">Date of Birth</label><input id="new-pet-dob" type="date" /></div>
                        <div class="input-group">
                            <label for="new-pet-icon-button">Icon</label>
                            <div class="flex items-center gap-2">
                                <input id="new-pet-icon" type="hidden" value="fa-solid fa-paw" />
                                <i id="icon-preview" class="text-2xl fa-solid fa-paw" style="color: var(--button-bg);"></i>
                                <button id="new-pet-icon-button" type="button" class="secondary-button !flex-grow-0 py-2 px-4">Choose Icon</button>
                            </div>
                        </div>
                        <div class="button-group"><button id="add-pet-btn" class="main-button"><i class="fa-solid fa-plus"></i> Add New Pet</button></div>
                    </div>
                </details>
                
                <h3>Your Pets</h3>
                <ul id="pet-list" class="pet-list"></ul>
            </fieldset>
        </div>
        
        <div id="tab-content-treatments" class="tab-content">
            <fieldset class="border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg">
                <legend class="text-2xl font-semibold px-2 mb-4">Recurring Treatments</legend>
                <p class="text-sm text-[var(--text-color-secondary)] mb-4">Define recurring treatments (like flea or worming) here. You can then assign them to your pets.</p>
                
                <details class="bg-[var(--input-bg-color)] p-4 rounded-lg mb-6">
                    <summary class="font-bold cursor-pointer">Add New Treatment Type</summary>
                    <div class="mt-4">
                        <div class="input-group">
                            <label for="new-treatment-name">Treatment Name</label>
                            <input id="new-treatment-name" type="text" placeholder="e.g., Flea Treatment (Frontline)" />
                        </div>
                        <div class="input-group">
                            <label for="new-treatment-frequency">Frequency (in days)</label>
                            <input id="new-treatment-frequency" type="number" min="1" placeholder="e.g., 30" />
                        </div>
                        <div class="button-group">
                            <button id="add-treatment-btn" class="main-button"><i class="fa-solid fa-plus"></i> Add Treatment</button>
                        </div>
                    </div>
                </details>

                <h3 class="font-bold mb-2">Defined Treatments</h3>
                <ul id="treatment-list" class="treatment-list mt-4 space-y-2"></ul>
            </fieldset>
        </div>

        <div id="tab-content-log-event" class="tab-content">
            <fieldset class="border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg mt-4">
                <legend class="text-2xl font-semibold px-2 mb-4">Log a Pet Event</legend>
                 <div class="mt-4">
                    <div class="input-group">
                        <label for="log-event-pet-select">Select Pet</label>
                        <div class="custom-select-wrapper"><select id="log-event-pet-select"></select></div>
                    </div>
                    <div class="input-group">
                        <label for="log-event-type-select">Event Type</label>
                        <div class="custom-select-wrapper">
                            <select id="log-event-type-select">
                                <option value="Vet Visit">Vet Visit</option>
                                <option value="Weight">Weight</option>
                                <option value="Medication">Medication</option>
                                <option value="Note">Note</option>
                                </select>
                        </div>
                    </div>
                    <div class="input-group"><label for="event-datetime">Date and Time</label><input id="event-datetime" type="datetime-local" /></div>
                    <div class="input-group"><label for="event-notes">Notes / Details</label><textarea id="event-notes" placeholder="e.g., Annual booster. Weight: 4.5kg."></textarea></div>
                    <div class="input-group hidden" id="weight-input-group">
                        <label for="event-weight">Weight (kg)</label><input id="event-weight" type="number" step="0.01" placeholder="e.g., 4.5" />
                    </div>
                    <div class="input-group hidden" id="next-due-input-group">
                        <label for="event-next-due">Next Due Date (Optional)</label><input id="event-next-due" type="date" />
                    </div>
                    <div class="button-group"><button id="log-event-btn" class="main-button"><i class="fa-solid fa-save"></i> Log Event</button></div>
                </div>
            </fieldset>
        </div>

        <div id="tab-content-history" class="tab-content">
            <fieldset class="border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg">
                <legend class="text-2xl font-semibold px-2 mb-4">Event History</legend>
                <div class="input-group mt-4">
                    <label for="search-input">Search & Filter</label>
                    <input type="text" id="search-input" placeholder="Search by pet, event type, or notes..." />
                </div>
                <div class="table-container mt-4">
                    <table id="event-table">
                        <thead><tr id="event-table-header"></tr></thead>
                        <tbody id="event-table-body"></tbody>
                    </table>
                </div>
            </fieldset>
        </div>

        <div id="tab-content-settings" class="tab-content">
            <fieldset class="border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg">
                <legend class="text-2xl font-semibold px-2 mb-4">Data Management</legend>
                <div class="import-export-container">
                    <button id="export-json-btn" class="main-button"><i class="fa-solid fa-file-export"></i> Export All Data (JSON)</button>
                    <button id="export-csv-btn" class="main-button"><i class="fa-solid fa-file-export"></i> Export Events (CSV)</button>
                </div>
                 </fieldset>
        </div>
      </div>
    </div>
    <div id="message-box" class="message-box"></div>
    
    <div id="edit-event-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Event Entry</h2>
            <div class="input-group"><label for="modal-event-pet-name">Pet</label><input id="modal-event-pet-name" type="text" disabled /></div>
            <div class="input-group"><label for="modal-event-type">Type</label><input id="modal-event-type" type="text" disabled /></div>
            <div class="input-group"><label for="modal-event-datetime">Date and Time</label><input id="modal-event-datetime" type="datetime-local" /></div>
            <div class="input-group"><label for="modal-event-notes">Notes</label><textarea id="modal-event-notes"></textarea></div>
            <div class="button-group">
                <button id="modal-save-event-btn" class="main-button">Save Changes</button>
                <button id="modal-delete-event-btn" class="destructive-button">Delete Entry</button>
            </div>
        </div>
    </div>
    
    <div id="edit-pet-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Pet</h2>
            <div class="input-group"><label for="modal-pet-name">Pet's Name</label><input id="modal-pet-name" type="text" /></div>
            <div class="input-group"><label for="modal-pet-breed">Breed / Species</label><input id="modal-pet-breed" type="text" /></div>
            <div class="input-group"><label for="modal-pet-dob">Date of Birth</label><input id="modal-pet-dob" type="date" /></div>
            <div class="input-group">
                <label for="modal-pet-icon-button">Icon</label>
                <div class="flex items-center gap-2">
                    <input id="modal-pet-icon" type="hidden" />
                    <i id="modal-icon-preview" class="text-2xl"></i>
                    <button id="modal-pet-icon-button" type="button" class="secondary-button !flex-grow-0 py-2 px-4">Choose Icon</button>
                </div>
            </div>
            <div class="input-group">
                <label>Assigned Treatments</label>
                <div id="modal-pet-treatments-container" class="space-y-2">
                    </div>
            </div>
            <div class="button-group">
                <button id="modal-save-pet-btn" class="main-button">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="icon-picker-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Select an Icon</h2>
            <div id="icon-picker-grid" class="grid grid-cols-8 gap-4 overflow-y-auto max-h-64 p-2 bg-[var(--input-bg-color)] rounded">
                </div>
        </div>
    </div>
    
    <script type="module">
      import { changelogData } from '/changelog-data.js';
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, Timestamp, doc, deleteDoc, updateDoc, getDocs, setDoc, writeBatch, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Firebase Config (Same as your other apps) ---
      const firebaseConfig = {
        apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
        authDomain: "sammy-7298f.firebaseapp.com",
        projectId: "sammy-7298f",
        storageBucket: "sammy-7298f.firebasestorage.app",
        messagingSenderId: "963185683535",
        appId: "1:963185683535:web:807df8941feba46c208e3a",
        measurementId: "G-JT1YF2ELN3",
      };
      
      // --- App Initialization ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // --- Constants ---
      const REMINDER_THRESHOLD_SOON_DAYS = 7;
      const ICON_LIST = [
        'fa-solid fa-paw', 'fa-solid fa-cat', 'fa-solid fa-dog', 'fa-solid fa-syringe', 
        'fa-solid fa-pills', 'fa-solid fa-stethoscope', 'fa-solid fa-band-aid', 'fa-solid fa-heart-pulse',
        'fa-solid fa-weight-scale', 'fa-solid fa-bone', 'fa-solid fa-fish', 'fa-solid fa-bug'
      ];

      // --- App State ---
      const appState = {
          user: null,
          pets: [],
          treatments: [],
          events: [],
          eventTableSort: { column: 'date', direction: 'desc' },
          eventSearchFilter: '',
          currentModalEventId: null,
          currentModalPetId: null,
          currentIconPickerTarget: null, // 'new' or 'modal'
          unsubscribe: {
              theme: null,
              pets: null,
              treatments: null,
              events: null
          }
      };

      // --- UI Element References ---
      const ui = {
        body: document.body,
        versionDisplay: document.getElementById('version-display'),
        // Pet UI
        newPetIconButton: document.getElementById('new-pet-icon-button'),
        newPetIconInput: document.getElementById('new-pet-icon'),
        iconPreview: document.getElementById('icon-preview'),
        modalPetIconButton: document.getElementById('modal-pet-icon-button'),
        modalPetIconInput: document.getElementById('modal-pet-icon'),
        modalIconPreview: document.getElementById('modal-icon-preview'),
        petList: document.getElementById('pet-list'),
        logEventPetSelect: document.getElementById('log-event-pet-select'),
        // Event UI
        logEventTypeSelect: document.getElementById('log-event-type-select'),
        weightInputGroup: document.getElementById('weight-input-group'),
        nextDueInputGroup: document.getElementById('next-due-input-group'),
        // Treatment UI
        treatmentList: document.getElementById('treatment-list'),
        // Dashboard
        dashboardReminders: document.getElementById('dashboard-reminders-container'),
        dashboardRecentEvents: document.getElementById('dashboard-recent-events-container'),
        // History
        eventTableBody: document.getElementById('event-table-body'),
        eventTableHeader: document.getElementById('event-table-header'),
        searchInput: document.getElementById('search-input'),
      };

      // --- Helper Functions (Copied from MediManagr) ---
      const showMessage = (message, type = "success") => {
        const msgBox = document.getElementById("message-box");
        msgBox.textContent = message;
        msgBox.className = `message-box ${type} show`;
        setTimeout(() => { msgBox.classList.remove("show"); }, 3000);
      };

      const toLocalISOString = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      };
      
      const parseLocalDate = (dateString) => {
        if (!dateString) return null;
        try {
            const [datePart, timePart] = dateString.split('T');
            if (!datePart || !timePart) return new Date(dateString); // Handle date-only
            const [year, month, day] = datePart.split('-');
            const [hours, minutes] = timePart.split(':');
            return new Date(year, month - 1, day, hours, minutes);
        } catch (e) {
            console.error("Error parsing date:", dateString, e);
            return null;
        }
      };

      const setDefaultDateTime = () => {
        const now = new Date();
        document.getElementById("event-datetime").value = toLocalISOString(now);
      };

      // --- Theme Management (Copied from MediManagr) ---
      const applyTheme = (theme) => {
        if (theme === 'dark') ui.body.classList.add('dark-mode');
        else ui.body.classList.remove('dark-mode');
      };

      const toggleTheme = async () => {
          if (!appState.user) return;
          const newTheme = ui.body.classList.contains('dark-mode') ? 'light' : 'dark';
          try {
              const themeDocRef = doc(db, 'users', appState.user.uid, 'settings', 'theme');
              await setDoc(themeDocRef, { theme: newTheme }, { merge: true });
          } catch (error) {
              console.error("Error updating theme:", error);
              showMessage("Could not save theme preference.", "error");
          }
      };

      // --- Icon Picker Functions (Copied from MediManagr) ---
      const updateIconPreview = (inputElement, previewElement) => {
        const iconClass = inputElement.value || 'fa-solid fa-paw';
        previewElement.className = `text-2xl ${iconClass}`;
        previewElement.style.color = 'var(--button-bg)'; // Use button color
      };

      const populateIconPicker = () => {
        const grid = document.getElementById('icon-picker-grid');
        grid.innerHTML = '';
        ICON_LIST.forEach(iconClass => {
            const iconWrapper = document.createElement('div');
            iconWrapper.className = 'p-2 flex justify-center items-center cursor-pointer rounded hover:bg-[var(--border-color)]';
            iconWrapper.innerHTML = `<i class="${iconClass} text-3xl text-[var(--text-color-primary)]"></i>`;
            iconWrapper.addEventListener('click', () => {
                let targetInput, targetPreview;
                if (appState.currentIconPickerTarget === 'new') {
                    targetInput = ui.newPetIconInput;
                    targetPreview = ui.iconPreview;
                } else if (appState.currentIconPickerTarget === 'modal') {
                    targetInput = ui.modalPetIconInput;
                    targetPreview = ui.modalIconPreview;
                }

                if (targetInput) {
                    targetInput.value = iconClass;
                    updateIconPreview(targetInput, targetPreview);
                }
                document.getElementById('icon-picker-modal').classList.add('hidden');
            });
            grid.appendChild(iconWrapper);
        });
      };

      // --- Data Rendering ---
      const renderAll = () => {
          renderPets();
          renderTreatments();
          renderEventTable();
          renderDashboard();
          populateTreatmentDropdown();
      };
      
      const renderPets = () => {
          ui.petList.innerHTML = '';
          ui.logEventPetSelect.innerHTML = '';
          
          if (appState.pets.length === 0) {
              ui.petList.innerHTML = `<p class="text-center text-[var(--text-color-secondary)]">No pets added yet.</p>`;
              ui.logEventPetSelect.innerHTML = `<option value="">Add a pet first</option>`;
              return;
          }

          appState.pets.forEach(pet => {
              const icon = pet.icon || 'fa-solid fa-paw';
              const dob = pet.dob ? new Date(pet.dob).toLocaleDateString() : 'Unknown DOB';

              const listItem = document.createElement("li");
              listItem.className = "pet-item";
              listItem.innerHTML = `
                  <div class="pet-item-details">
                      <span class="pet-item-name"><i class="${icon}"></i> ${pet.name}</span>
                      <span class="pet-item-sub">${pet.breed || 'No breed'} - Born: ${dob}</span>
                  </div>
                  <div class="pet-actions">
                      <button class="secondary-button edit-pet-btn" data-id="${pet.id}"><i class="fa-solid fa-edit"></i></button>
                      <button class="destructive-button delete-pet-btn" data-id="${pet.id}"><i class="fa-solid fa-trash"></i></button>
                  </div>`;
              ui.petList.appendChild(listItem);
              
              const option = new Option(pet.name, pet.id);
              ui.logEventPetSelect.appendChild(option);
          });

          document.querySelectorAll(".delete-pet-btn").forEach(btn => btn.addEventListener("click", handleDeletePet));
          document.querySelectorAll(".edit-pet-btn").forEach(btn => btn.addEventListener("click", handleEditPet));
      };

      const renderTreatments = () => {
          ui.treatmentList.innerHTML = '';
          if (appState.treatments.length === 0) {
              ui.treatmentList.innerHTML = `<p class="text-center text-[var(--text-color-secondary)]">No treatment types defined.</p>`;
              return;
          }
          
          appState.treatments.forEach(treatment => {
              const listItem = document.createElement("li");
              listItem.className = "treatment-item";
              listItem.innerHTML = `
                  <div class="treatment-item-details">
                      <span class="treatment-item-name">${treatment.name}</span>
                      <span class="treatment-item-sub">Repeats every ${treatment.frequencyDays} days</span>
                  </div>
                  <div class="treatment-actions">
                      <button class="destructive-button delete-treatment-btn" data-id="${treatment.id}"><i class="fa-solid fa-trash"></i></button>
                  </div>`;
              ui.treatmentList.appendChild(listItem);
          });
          
          document.querySelectorAll(".delete-treatment-btn").forEach(btn => btn.addEventListener("click", handleDeleteTreatment));
      };
      
      const populateTreatmentDropdown = () => {
        // Clear existing treatment options (but keep the static ones)
        Array.from(ui.logEventTypeSelect.options).forEach(option => {
            if (option.dataset.dynamic) {
                option.remove();
            }
        });
        
        // Add treatments from state
        appState.treatments.forEach(treatment => {
            const option = new Option(treatment.name, treatment.name);
            option.dataset.dynamic = true; // Mark as dynamic
            option.dataset.frequency = treatment.frequencyDays;
            ui.logEventTypeSelect.appendChild(option);
        });
      };

      const renderDashboard = () => {
          ui.dashboardReminders.innerHTML = '';
          ui.dashboardRecentEvents.innerHTML = '';
          const now = new Date();
          
          let allReminders = [];

          // 1. Generate reminders from scheduled treatments
          appState.pets.forEach(pet => {
              if (!pet.assignedTreatments) return;
              
              pet.assignedTreatments.forEach(assigned => {
                  const treatment = appState.treatments.find(t => t.id === assigned.treatmentId);
                  if (!treatment) return;
                  
                  // Find the last event of this type for this pet
                  const lastEvent = appState.events
                      .filter(e => e.petId === pet.id && e.type === treatment.name)
                      .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                  
                  let lastEventDate = lastEvent ? parseLocalDate(lastEvent.date) : parseLocalDate(assigned.startDate);
                  if (!lastEventDate) return;

                  let nextDueDate = new Date(lastEventDate);
                  nextDueDate.setDate(nextDueDate.getDate() + parseInt(treatment.frequencyDays));
                  
                  allReminders.push({
                      petName: pet.name,
                      treatmentName: treatment.name,
                      dueDate: nextDueDate
                  });
              });
          });
          
          // 2. Generate reminders from one-off 'next due' dates
          appState.events.forEach(event => {
             if (event.nextDueDate) {
                 const dueDate = parseLocalDate(event.nextDueDate);
                 if (dueDate >= now) {
                     allReminders.push({
                         petName: event.petName,
                         treatmentName: `Follow-up for: ${event.type}`,
                         dueDate: dueDate
                     });
                 }
             }
          });

          // 3. Render Reminders
          allReminders.sort((a, b) => a.dueDate - b.dueDate);
          
          if (allReminders.length === 0) {
              ui.dashboardReminders.innerHTML = `<p class="text-sm text-[var(--text-color-secondary)]">No upcoming reminders.</p>`;
          }

          allReminders.forEach(reminder => {
              const diffTime = reminder.dueDate.getTime() - now.getTime();
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              let statusClass = '';
              let dueText = `Due in ${diffDays} days`;
              if (diffDays <= 0) {
                  statusClass = 'due'; // Overdue
                  dueText = `Due ${Math.abs(diffDays)} days ago`;
              } else if (diffDays <= REMINDER_THRESHOLD_SOON_DAYS) {
                  statusClass = 'soon'; // Due soon
              }
              
              if (diffDays <= 30) { // Only show reminders due within 30 days
                const card = document.createElement('div');
                card.className = `reminder-card ${statusClass}`;
                card.innerHTML = `
                    <p class="font-bold">${reminder.treatmentName}</p>
                    <p class="text-sm">${reminder.petName}</p>
                    <p class="text-sm font-bold mt-1">${dueText} (${reminder.dueDate.toLocaleDateString()})</p>
                `;
                ui.dashboardReminders.appendChild(card);
              }
          });
          
          // 4. Render Recent Events
          const recentEvents = [...appState.events]
              .sort((a, b) => parseLocalDate(b.date) - parseLocalDate(a.date))
              .slice(0, 5); // Get 5 most recent
              
          if (recentEvents.length === 0) {
              ui.dashboardRecentEvents.innerHTML = `<p class="text-sm text-[var(--text-color-secondary)]">No recent events logged.</p>`;
          }
          
          recentEvents.forEach(event => {
             const card = document.createElement('div');
             card.className = 'text-left p-3 bg-[var(--input-bg-color)] rounded-lg';
             card.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold">${event.type}</p>
                    <span class="text-xs font-semibold">${event.petName}</span>
                </div>
                <p class="text-sm text-[var(--text-color-secondary)]">${parseLocalDate(event.date).toLocaleString()}</p>
                <p class="text-sm mt-1">${event.notes || 'No notes'}</p>
             `;
             ui.dashboardRecentEvents.appendChild(card);
          });
      };
      
      const renderEventTable = () => {
        ui.eventTableBody.innerHTML = ui.eventTableHeader.innerHTML = '';

        if (appState.events.length === 0) {
            ui.eventTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-[var(--text-color-secondary)]">No event history found.</td></tr>`;
            return;
        }
        
        const toTitleCase = (str) => str.replace(/([A-Z])/g, ' $1').replace(/^./, (s) => s.toUpperCase());
        const headers = ['date', 'petName', 'type', 'notes', 'weight'];
        
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = toTitleCase(headerText);
            th.onclick = () => {
                appState.eventTableSort.direction = (appState.eventTableSort.column === headerText && appState.eventTableSort.direction === 'asc') ? 'desc' : 'asc';
                appState.eventTableSort.column = headerText;
                renderEventTable();
            };
            if (appState.eventTableSort.column === headerText) th.textContent += appState.eventTableSort.direction === 'asc' ? ' ▲' : ' ▼';
            ui.eventTableHeader.appendChild(th);
        });

        const sortedData = [...appState.events].sort((a, b) => {
            const { column, direction } = appState.eventTableSort;
            const aValue = a[column] || '';
            const bValue = b[column] || '';
            let comparison = 0;
            if (column === 'date') {
                comparison = parseLocalDate(aValue) - parseLocalDate(bValue);
            } else {
                comparison = String(aValue).localeCompare(String(bValue), undefined, { numeric: true });
            }
            return direction === 'asc' ? comparison : -comparison;
        }).filter(event => {
            const searchTerm = appState.eventSearchFilter.toLowerCase();
            return Object.values(event).some(value => String(value).toLowerCase().includes(searchTerm));
        });

        sortedData.forEach(event => {
            const row = document.createElement('tr');
            row.className = 'cursor-pointer';
            row.dataset.id = event.id;
            row.innerHTML = `
                <td>${event.date ? parseLocalDate(event.date).toLocaleString() : 'N/A'}</td>
                <td>${event.petName}</td>
                <td>${event.type}</td>
                <td>${event.notes || ''}</td>
                <td>${event.weight || ''} ${event.weight ? 'kg' : ''}</td>
            `;
            ui.eventTableBody.appendChild(row);
        });

        document.querySelectorAll('#event-table-body tr').forEach(row => {
            row.addEventListener('click', (e) => {
                const eventId = e.currentTarget.dataset.id;
                if (eventId) handleEditEvent(eventId);
            });
        });
      };

      // --- Data Handling ---
      const handleAddPet = async () => {
        const name = document.getElementById("new-pet-name").value.trim();
        const breed = document.getElementById("new-pet-breed").value.trim();
        if (!name) return showMessage("Pet's name is required.", "error");

        const newPet = {
            name,
            breed,
            dob: document.getElementById("new-pet-dob").value,
            icon: document.getElementById("new-pet-icon").value.trim() || 'fa-solid fa-paw',
            assignedTreatments: [], // Users can add these via the 'edit' modal
            petCreatedAt: Timestamp.now(),
            petCreatedBy: appState.user.uid,
        };

        try {
            await addDoc(collection(db, `users/${appState.user.uid}/pets`), newPet);
            showMessage("Pet added successfully!", "success");
            document.getElementById("new-pet-name").value = "";
            document.getElementById("new-pet-breed").value = "";
            document.getElementById("new-pet-dob").value = "";
            document.getElementById("new-pet-icon").value = "fa-solid fa-paw";
            ui.iconPreview.className = "text-2xl fa-solid fa-paw";
        } catch (err) { showMessage("Error adding pet: " + err.message, "error"); }
      };

      const handleAddTreatment = async () => {
        const name = document.getElementById("new-treatment-name").value.trim();
        const frequencyDays = parseInt(document.getElementById("new-treatment-frequency").value);
        if (!name || !frequencyDays || frequencyDays <= 0) {
            return showMessage("Treatment name and a valid frequency in days are required.", "error");
        }
        
        const newTreatment = {
            name,
            frequencyDays,
            treatmentCreatedAt: Timestamp.now(),
            treatmentCreatedBy: appState.user.uid,
        };
        
        try {
            await addDoc(collection(db, `users/${appState.user.uid}/pet_treatments`), newTreatment);
            showMessage("Treatment type added!", "success");
            document.getElementById("new-treatment-name").value = "";
            document.getElementById("new-treatment-frequency").value = "";
        } catch (err) {
            showMessage("Error adding treatment: " + err.message, "error");
        }
      };

      const handleLogEvent = async () => {
        const petId = document.getElementById("log-event-pet-select").value;
        const eventType = document.getElementById("log-event-type-select").value;
        const datetime = document.getElementById("event-datetime").value;
        const notes = document.getElementById("event-notes").value.trim();
        const weight = document.getElementById("event-weight").value.trim();
        const nextDueDate = document.getElementById("event-next-due").value;

        if (!petId || !eventType || !datetime) return showMessage("Please select a pet, event type, and date/time.", "error");

        const selectedPet = appState.pets.find(p => p.id === petId);
        if (!selectedPet) return showMessage("Selected pet not found.", "error");

        const logEntry = {
            petId,
            petName: selectedPet.name,
            type: eventType,
            date: datetime,
            notes,
            weight: eventType === 'Weight' ? weight : null,
            nextDueDate: nextDueDate || null,
            eventCreatedAt: Timestamp.now(),
            eventCreatedBy: appState.user.uid,
        };

        try {
            await addDoc(collection(db, `users/${appState.user.uid}/pet_events`), logEntry);
            showMessage(`Event logged for ${selectedPet.name}!`, "success");
            setDefaultDateTime();
            document.getElementById("event-notes").value = '';
            document.getElementById("event-weight").value = '';
            document.getElementById("event-next-due").value = '';
        } catch (err) { showMessage("Error logging event: " + err.message, "error"); }
      };

      const handleEditEvent = (eventId) => {
        const event = appState.events.find(e => e.id === eventId);
        if (!event) return;
        
        appState.currentModalEventId = eventId;
        document.getElementById('modal-event-pet-name').value = event.petName;
        document.getElementById('modal-event-type').value = event.type;
        document.getElementById('modal-event-datetime').value = event.date;
        document.getElementById('modal-event-notes').value = event.notes || '';
        
        document.getElementById('edit-event-modal').classList.remove('hidden');
      };
      
    const handleSaveEvent = async () => {
        if (!appState.currentModalEventId) return;
        
        const docRef = doc(db, `users/${appState.user.uid}/pet_events`, appState.currentModalEventId);
        const updateData = {
            date: document.getElementById('modal-event-datetime').value,
            notes: document.getElementById('modal-event-notes').value,
            eventUpdatedAt: Timestamp.now(),
        };
        
        try {
            await updateDoc(docRef, updateData);
            showMessage("Event updated successfully!", "success");
            document.getElementById('edit-event-modal').classList.add('hidden');
        } catch (err) {
            showMessage("Error updating event: " + err.message, "error");
        }
    };

      const handleDeleteEvent = async () => {
        if (!appState.currentModalEventId || !confirm("Delete this event entry?")) return;
        try {
            await deleteDoc(doc(db, `users/${appState.user.uid}/pet_events`, appState.currentModalEventId));
            showMessage("Event deleted.", "success");
            document.getElementById('edit-event-modal').classList.add('hidden');
        } catch (err) { showMessage("Error deleting event: " + err.message, "error"); }
      };

      const handleEditPet = (e) => {
          const petId = e.target.closest("button").dataset.id;
          const pet = appState.pets.find(p => p.id === petId);
          if (!pet) return;

          appState.currentModalPetId = petId;
          document.getElementById('modal-pet-name').value = pet.name;
          document.getElementById('modal-pet-breed').value = pet.breed || '';
          document.getElementById('modal-pet-dob').value = pet.dob || '';
          
          const iconClass = pet.icon || 'fa-solid fa-paw';
          ui.modalPetIconInput.value = iconClass;
          ui.modalIconPreview.className = `text-2xl ${iconClass}`;
          ui.modalIconPreview.style.color = 'var(--button-bg)';
          
          // Populate treatment checkboxes
          const treatmentsContainer = document.getElementById('modal-pet-treatments-container');
          treatmentsContainer.innerHTML = '';
          if (appState.treatments.length === 0) {
              treatmentsContainer.innerHTML = `<p class="text-sm text-[var(--text-color-secondary)]">No treatments defined. Go to the Treatments tab to add some.</p>`;
          }
          
          appState.treatments.forEach(treatment => {
              const assigned = (pet.assignedTreatments || []).find(at => at.treatmentId === treatment.id);
              const startDate = assigned ? assigned.startDate : '';
              
              const treatmentDiv = document.createElement('div');
              treatmentDiv.className = 'p-2 bg-[var(--input-bg-color)] rounded-lg';
              treatmentDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <label for="treatment-chk-${treatment.id}" class="font-semibold">${treatment.name}</label>
                    <input type="checkbox" id="treatment-chk-${treatment.id}" data-treatment-id="${treatment.id}" class="w-5 h-5" ${assigned ? 'checked' : ''}>
                </div>
                <div class_="mt-2">
                    <label for="treatment-date-${treatment.id}" class="text-sm">Start Date:</label>
                    <input type="date" id="treatment-date-${treatment.id}" data-treatment-id="${treatment.id}" class="w-full !p-2 !text-sm" value="${startDate}">
                </div>
              `;
              treatmentsContainer.appendChild(treatmentDiv);
          });

          document.getElementById('edit-pet-modal').classList.remove('hidden');
      };
      
      const handleSavePet = async () => {
          if (!appState.currentModalPetId) return;
          const name = document.getElementById("modal-pet-name").value.trim();
          if (!name) return showMessage("Name is required.", "error");

          // Collect assigned treatments
          const assignedTreatments = [];
          document.querySelectorAll('#modal-pet-treatments-container input[type="checkbox"]:checked').forEach(chk => {
              const treatmentId = chk.dataset.treatmentId;
              const startDateInput = document.getElementById(`treatment-date-${treatmentId}`);
              if (treatmentId && startDateInput.value) {
                  assignedTreatments.push({
                      treatmentId: treatmentId,
                      startDate: startDateInput.value
                  });
              } else {
                  showMessage("Please provide a start date for all checked treatments.", "error");
              }
          });

          const updatedData = {
              name,
              breed: document.getElementById("modal-pet-breed").value.trim(),
              dob: document.getElementById("modal-pet-dob").value,
              icon: document.getElementById("modal-pet-icon").value.trim() || 'fa-solid fa-paw',
              assignedTreatments: assignedTreatments,
              petUpdatedAt: Timestamp.now(),
          };

          try {
              const docRef = doc(db, `users/${appState.user.uid}/pets`, appState.currentModalPetId);
              await updateDoc(docRef, updatedData);
              showMessage("Pet updated successfully!", "success");
              document.getElementById('edit-pet-modal').classList.add('hidden');
          } catch (err) { showMessage("Error updating pet: " + err.message, "error"); }
      };

      const handleDeletePet = async (e) => {
        const petId = e.target.closest("button").dataset.id;
        if (!confirm("Delete this pet and all its event history? This cannot be undone.")) return;
        try {
            const batch = writeBatch(db);
            // Delete pet
            batch.delete(doc(db, `users/${appState.user.uid}/pets`, petId));
            // Delete all associated events
            appState.events.filter(ev => ev.petId === petId).forEach(ev => {
                batch.delete(doc(db, `users/${appState.user.uid}/pet_events`, ev.id));
            });
            await batch.commit();
            showMessage("Pet deleted successfully.", "success");
        } catch (err) { showMessage("Error deleting pet: " + err.message, "error"); }
      };
      
      const handleDeleteTreatment = async (e) => {
          const treatmentId = e.target.closest("button").dataset.id;
          // TODO: Add logic to check if treatment is assigned to any pets before deleting.
          // For now, simple delete.
          if (!confirm("Delete this treatment type? This will not remove it from pets it's already assigned to.")) return;
           try {
                await deleteDoc(doc(db, `users/${appState.user.uid}/pet_treatments`, treatmentId));
                showMessage("Treatment type deleted.", "success");
            } catch (err) {
                showMessage("Error deleting treatment: " + err.message, "error");
            }
      };
      

      // --- Auth & App Lifecycle (Copied from MediManagr) ---
      const cleanupListeners = () => {
          Object.values(appState.unsubscribe).forEach(unsub => unsub && unsub());
      };

      const setupRealtimeListeners = (user) => {
          cleanupListeners();
          const userId = user.uid;

          const themeDocRef = doc(db, 'users', userId, 'settings', 'theme');
          appState.unsubscribe.theme = onSnapshot(themeDocRef, (doc) => applyTheme(doc.data()?.theme || 'light'));

          const petsQuery = query(collection(db, `users/${userId}/pets`), orderBy('name'));
          appState.unsubscribe.pets = onSnapshot(petsQuery, (snapshot) => {
              appState.pets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              renderAll();
          }, (err) => { console.error("Pets listener error:", err); });

          const eventsQuery = query(collection(db, `users/${userId}/pet_events`), orderBy('date', 'desc'));
          appState.unsubscribe.events = onSnapshot(eventsQuery, (snapshot) => {
              appState.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              renderAll();
          }, (err) => { console.error("Events listener error:", err); });
          
          const treatmentsQuery = query(collection(db, `users/${userId}/pet_treatments`), orderBy('name'));
          appState.unsubscribe.treatments = onSnapshot(treatmentsQuery, (snapshot) => {
              appState.treatments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              renderAll();
          }, (err) => { console.error("Treatments listener error:", err); });
      };

      onAuthStateChanged(auth, (user) => {
        if (user) {
          appState.user = user;
          document.getElementById("user-email-display").textContent = user.email;
          document.getElementById("auth-container").classList.add("hidden");
          document.getElementById("main-app-container").classList.remove("hidden");
          document.getElementById('theme-toggle').disabled = false;
          setDefaultDateTime();
          setupRealtimeListeners(user);
        } else {
          appState.user = null;
          appState.pets = [];
          appState.events = [];
          appState.treatments = [];
          cleanupListeners();
          document.getElementById("auth-container").classList.remove("hidden");
          document.getElementById("main-app-container").classList.add("hidden");
          document.getElementById('theme-toggle').disabled = true;
          applyTheme('light');
          renderAll();
        }
      });
      
      // --- Event Listeners ---
      document.addEventListener('DOMContentLoaded', () => {
        const LATEST_VERSION = changelogData[0].version;
        ui.versionDisplay.textContent = LATEST_VERSION;
        populateIconPicker();
      });
      
      // Icon Listeners
      ui.newPetIconButton.addEventListener('click', () => {
          appState.currentIconPickerTarget = 'new';
          document.getElementById('icon-picker-modal').classList.remove('hidden');
      });
      ui.modalPetIconButton.addEventListener('click', () => {
          appState.currentIconPickerTarget = 'modal';
          document.getElementById('icon-picker-modal').classList.remove('hidden');
      });

      // Auth Listeners
      document.getElementById("sign-in-btn").addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        try { await signInWithEmailAndPassword(auth, email, password); } 
        catch (err) { showMessage("Login failed: " + err.message, "error"); }
      });
      document.getElementById("sign-up-btn").addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        try { await createUserWithEmailAndPassword(auth, email, password); } 
        catch (err) { showMessage("Sign-up failed: " + err.message, "error"); }
      });
      document.getElementById("logout-btn").addEventListener("click", () => signOut(auth));
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

      // Main App Listeners
      document.getElementById("add-pet-btn").addEventListener("click", handleAddPet);
      document.getElementById("add-treatment-btn").addEventListener("click", handleAddTreatment);
      document.getElementById("log-event-btn").addEventListener("click", handleLogEvent);

      ui.searchInput.addEventListener("input", (e) => {
          appState.eventSearchFilter = e.target.value;
          renderEventTable();
      });

      // Conditional form fields in "Log Event"
      ui.logEventTypeSelect.addEventListener('change', (e) => {
          const selectedOption = e.target.options[e.target.selectedIndex];
          ui.weightInputGroup.classList.toggle('hidden', e.target.value !== 'Weight');
          // Show "Next Due" for Vet Visits and dynamic treatments
          const isVetVisit = e.target.value === 'Vet Visit';
          const isDynamicTreatment = selectedOption.dataset.dynamic === 'true';
          ui.nextDueInputGroup.classList.toggle('hidden', !isVetVisit && !isDynamicTreatment);
      });

      // Tab navigation
      document.querySelector('.tab-nav').addEventListener('click', (e) => {
          if (e.target.matches('.tab-button')) {
              const tabId = e.target.dataset.tab;
              document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
              e.target.classList.add('active');
              document.getElementById(`tab-content-${tabId}`).classList.add('active');
          }
      });
      
      // Modal listeners
      document.querySelectorAll('.modal').forEach(modal => {
        const closeBtn = modal.querySelector('.close-btn');
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        });
        if(closeBtn) {
            closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
        }
      });

      document.getElementById('modal-save-pet-btn').addEventListener('click', handleSavePet);
      document.getElementById('modal-save-event-btn').addEventListener('click', handleSaveEvent);
      document.getElementById('modal-delete-event-btn').addEventListener('click', handleDeleteEvent);

      // --- Import/Export Logic ---
      const exportDataAsJSON = async () => {
          try {
              showMessage("Exporting all data as JSON...", "info");
              const petsSnap = await getDocs(collection(db, `users/${appState.user.uid}/pets`));
              const eventsSnap = await getDocs(collection(db, `users/${appState.user.uid}/pet_events`));
              const treatmentsSnap = await getDocs(collection(db, `users/${appState.user.uid}/pet_treatments`));

              const data = {
                  pets: petsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                  pet_events: eventsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                  pet_treatments: treatmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
              };

              const replacer = (key, value) => {
                  if (value && typeof value === 'object' && value.hasOwnProperty('seconds')) {
                      return new Date(value.seconds * 1000).toISOString();
                  }
                  return value;
              };

              const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, replacer, 2));
              const a = document.createElement('a');
              a.setAttribute("href", dataStr);
              a.setAttribute("download", `petmanagr_export_${new Date().toISOString().split('T')[0]}.json`);
              document.body.appendChild(a);
              a.click();
              a.remove();
              showMessage("Data exported successfully!", "success");
          } catch (err) {
              showMessage(`Export failed: ${err.message}`, "error");
          }
      };

      const exportDataAsCSV = async () => {
          try {
              showMessage("Exporting events as CSV...", "info");
              if (appState.events.length === 0) {
                  return showMessage("No event data to export.", "info");
              }
              
              const csvData = appState.events.map(event => ({
                  id: event.id,
                  date: event.date,
                  petId: event.petId,
                  petName: event.petName,
                  type: event.type,
                  notes: event.notes || '',
                  weight_kg: event.weight || '',
                  nextDueDate: event.nextDueDate || ''
              }));

              const csv = Papa.unparse(csvData);
              const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.setAttribute("href", url);
              a.setAttribute("download", `petmanagr_events_export_${new Date().toISOString().split('T')[0]}.csv`);
              document.body.appendChild(a);
              a.click();
              a.remove();
              showMessage("Event history exported to CSV!", "success");

          } catch (err) {
              showMessage(`CSV Export failed: ${err.message}`, "error");
          }
      };
      
      document.getElementById('export-json-btn').addEventListener('click', exportDataAsJSON);
      document.getElementById('export-csv-btn').addEventListener('click', exportDataAsCSV);

    </script>
</body>
</html>