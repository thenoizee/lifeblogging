<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Tools - Lifeblogging Hub</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'128'%20height%3D'128'%20viewBox%3D'0%200%20128%20128'%3E%3Cdefs%3E%3C%2Fdefs%3E%3Crect%20width%3D'128'%20height%3D'128'%20rx%3D'25.6'%20fill%3D'%234f46e5'%20fill-opacity%3D'0'%20%2F%3E%3Cg%20transform%3D'translate(0%2C%200)%20rotate(0%2C%2064%2C%2064)'%3E%3Csvg%20x%3D'16'%20y%3D'16'%20width%3D'96'%20height%3D'96'%20viewBox%3D'0%200%20512%20512'%3E%3Cpath%20fill%3D'%230400ff'%20fill-opacity%3D'1'%20d%3D'M32%2096l320%200V32c0-12.9%207.8-24.6%2019.8-29.6s25.7-2.2%2034.9%206.9l96%2096c6%206%209.4%2014.1%209.4%2022.6s-3.4%2016.6-9.4%2022.6l-96%2096c-9.2%209.2-22.9%2011.9-34.9%206.9s-19.8-16.6-19.8-29.6V160L32%20160c-17.7%200-32-14.3-32-32s14.3-32%2032-32zM480%20352c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032H160v64c0%2012.9-7.8%2024.6-19.8%2029.6s-25.7%202.2-34.9-6.9l-96-96c-6-6-9.4-14.1-9.4-22.6s3.4-16.6%209.4-22.6l96-96c9.2-9.2%2022.9-11.9%2034.9-6.9s19.8%2016.6%2019.8%2029.6l0%2064H480z'%20%2F%3E%3C%2Fsvg%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="manifest" href="/manifest.json" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker registered successfully:', registration))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
    <style>
        :root {
            --bg-color: #f7fafc;
            --card-bg-color: white;
            --text-color-primary: #1a202c;
            --text-color-secondary: #4a5568;
            --input-bg-color: #e2e8f0;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        .dark {
            --bg-color: #1a202c;
            --card-bg-color: #2d3748;
            --text-color-primary: #edf2f7;
            --text-color-secondary: #a0aec0;
            --input-bg-color: #4a5568;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        textarea {
            background-color: var(--input-bg-color);
            color: var(--text-color-primary);
            border-color: var(--border-color);
            min-height: 200px;
        }
        .theme-switcher {
            background-color: var(--card-bg-color);
            border: 1px solid var(--text-color-secondary);
        }

        /* NEW STYLES */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: var(--text-color-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        .tab-btn:hover {
            color: #3730a3; /* indigo-800 */
        }
        .tab-content {
            display: none;
            padding-top: 1.5rem;
        }
        .tab-content.active {
            display: block;
        }
        /* Editor Table styles */
        #csv-editor-table {
            width: 100%;
            border-collapse: collapse;
        }
        #csv-editor-table th, 
        #csv-editor-table td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
        }
        #csv-editor-table th {
            background-color: var(--input-bg-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #csv-editor-table td {
            background-color: var(--card-bg-color);
        }
        #csv-editor-table td[contenteditable="true"] {
            outline: 2px solid transparent;
        }
        #csv-editor-table td[contenteditable="true"]:focus {
            background-color: #e0e7ff; /* indigo-100 */
            outline: 2px solid #4f46e5; /* indigo-600 */
        }
        .dark #csv-editor-table td[contenteditable="true"]:focus {
            background-color: #3730a3; /* indigo-900 */
        }
    </style>
</head>
<body class="min-h-screen pt-12 pb-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto"> <div class="bg-[var(--card-bg-color)] shadow-lg rounded-xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold text-[var(--text-color-primary)] flex items-center"><i class="fas fa-cogs mr-3"></i>Data Tools</h1> <div class="flex items-center gap-4">
                    <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
                    <button id="theme-toggle" class="theme-switcher rounded-full p-2" title="Toggle dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <h2 class="text-3xl font-bold text-center mb-6">CSV &lt;-> JSON Converter</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">CSV</h2>
                    <textarea id="csv-input" class="w-full p-2 border rounded" placeholder="Paste CSV here..."></textarea>
                    <div class="mt-4 flex gap-2">
                        <button id="csv-to-json-btn" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">To JSON <i class="fas fa-arrow-right"></i></button>
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        <button id="upload-csv-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"><i class="fas fa-upload"></i></button>
                    </div>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold mb-2">JSON</h2>
                    <textarea id="json-input" class="w-full p-2 border rounded" placeholder="Paste JSON here..."></textarea>
                    <div class="mt-4 flex gap-2">
                        <button id="json-to-csv-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"><i class="fas fa-arrow-left"></i> To CSV</button>
                        <input type="file" id="json-file-input" class="hidden" accept=".json">
                        <button id="upload-json-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"><i class="fas fa-upload"></i></button>
                    </div>
                </div>
            </div>

            <hr class="my-10 border-t-2 border-[var(--border-color)]">
            
            <div>
                <h2 class="text-3xl font-bold text-center mb-6">Additional CSV Tools</h2>
                <p class="text-center text-[var(--text-color-secondary)] mb-6 -mt-4">These tools operate on the CSV data in the input box above.</p>
                
                <div class="mb-6 border-b border-[var(--border-color)]">
                    <nav class="flex flex-wrap justify-center -mb-px">
                        <button class="tab-btn active" data-tab="editor"><i class="fas fa-table-cells mr-2"></i>View / Editor</button>
                        <button class="tab-btn" data-tab="transpose"><i class="fas fa-retweet mr-2"></i>Transpose</button>
                        <button class="tab-btn" data-tab="pivot"><i class="fas fa-chart-pie mr-2"></i>Pivot</button>
                    </nav>
                </div>

                <div id="tab-content-container">
                    
                    <div id="editor" class="tab-content active">
                        <h3 class="text-2xl font-semibold mb-4">CSV Viewer & Editor</h3>
                        <p class="text-[var(--text-color-secondary)] mb-4">
                            Load data from the CSV input above to view/edit it in a table. Edits can be saved back to the CSV input.
                        </p>
                        <div class="flex gap-4 mb-4">
                            <button id="load-csv-editor-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-table-cells mr-2"></i> Load CSV to Editor</button>
                            <button id="save-csv-editor-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 hidden"><i class="fas fa-save mr-2"></i> Save Changes to CSV Input</button>
                        </div>
                        <div id="csv-editor-container" class="border border-[var(--border-color)] rounded-lg overflow-auto max-h-[60vh] relative">
                            <table id="csv-editor-table" class="w-full">
                                </table>
                        </div>
                    </div>

                    <div id="transpose" class="tab-content">
                        <h3 class="text-2xl font-semibold mb-4">Transpose CSV</h3>
                        <p class="text-[var(--text-color-secondary)] mb-4">
                            Swap rows and columns from the CSV input. The first row becomes the first column, etc.
                        </p>
                        <button id="transpose-csv-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700"><i class="fas fa-retweet mr-2"></i> Transpose CSV Data</button>
                        <p class="text-sm text-[var(--text-color-secondary)] mt-2">Result will be placed in the CSV input above.</p>
                    </div>

                    <div id="pivot" class="tab-content">
                        <h3 class="text-2xl font-semibold mb-4">Pivot CSV</h3>
                        <p class="text-[var(--text-color-secondary)] mb-4">
                            Summarize your CSV data. First, click "Load Headers" to populate the dropdowns from the CSV input.
                        </p>
                        <button id="load-pivot-headers-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 mb-4"><i class="fas fa-sync mr-2"></i> Load CSV Headers</button>
                        <div id="pivot-controls" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 hidden">
                            </div>
                        <button id="run-pivot-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 hidden"><i class="fas fa-play mr-2"></i> Run Pivot</button>
                        <p class="text-sm text-[var(--text-color-secondary)] mt-2">Result will be placed in the CSV input above.</p>
                    </div>
                </div>
            </div>

            <hr class="my-10 border-t-2 border-[var(--border-color)]">
            
            <div>
                <h2 class="text-3xl font-bold text-center mb-6">String Utilities</h2>
                <p class="text-center text-[var(--text-color-secondary)] mb-6 -mt-4">Convert text between different formats (Binary, Base64, Hex, etc.)</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="block text-lg font-semibold mb-2">Input</label>
                        <textarea id="string-input" class="w-full p-2 border rounded font-mono text-sm" placeholder="Enter text here..."></textarea>
                    </div>
                    <div>
                        <label class="block text-lg font-semibold mb-2">Output</label>
                        <textarea id="string-output" class="w-full p-2 border rounded font-mono text-sm bg-[var(--input-bg-color)]" placeholder="Result will appear here..." readonly></textarea>
                    </div>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <label class="font-semibold whitespace-nowrap">Mode:</label>
                        <select id="string-conversion-type" class="w-full p-2 border rounded bg-[var(--card-bg-color)] border-[var(--border-color)] text-[var(--text-color-primary)]">
                            <optgroup label="Binary">
                                <option value="text-to-binary">Text → Binary</option>
                                <option value="binary-to-text">Binary → Text</option>
                            </optgroup>
                            <optgroup label="Base64">
                                <option value="text-to-base64">Text → Base64</option>
                                <option value="base64-to-text">Base64 → Text</option>
                            </optgroup>
                            <optgroup label="Hexadecimal">
                                <option value="text-to-hex">Text → Hex</option>
                                <option value="hex-to-text">Hex → Text</option>
                            </optgroup>
                            <optgroup label="URL">
                                <option value="url-encode">URL Encode</option>
                                <option value="url-decode">URL Decode</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="run-string-conversion-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">
                        <i class="fas fa-magic mr-2"></i> Convert
                    </button>
                     <button id="swap-string-inputs-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" title="Move Output to Input">
                        <i class="fas fa-arrow-up sm:fa-arrow-left transform sm:rotate-90"></i> Use Result
                    </button>
                </div>
            </div>

            <hr class="my-10 border-t-2 border-[var(--border-color)]">
            <div class="mt-8">
                <h3 class="text-2xl font-semibold mb-4 text-center">Download Results</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="download-csv-btn" class="flex-1 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700"><i class="fas fa-download mr-2"></i> Download CSV</button>
                    <button id="download-json-btn" class="flex-1 bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700"><i class="fas fa-download mr-2"></i> Download JSON</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const csvInput = document.getElementById('csv-input');
        const jsonInput = document.getElementById('json-input');
        const csvToJsonBtn = document.getElementById('csv-to-json-btn');
        const jsonToCsvBtn = document.getElementById('json-to-csv-btn');
        const uploadCsvBtn = document.getElementById('upload-csv-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const uploadJsonBtn = document.getElementById('upload-json-btn');
        const jsonFileInput = document.getElementById('json-file-input');
        const themeToggle = document.getElementById('theme-toggle');

        // --- NEW Elements ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // Editor elements
        const loadCsvEditorBtn = document.getElementById('load-csv-editor-btn');
        const saveCsvEditorBtn = document.getElementById('save-csv-editor-btn');
        const csvEditorContainer = document.getElementById('csv-editor-container');
        const csvEditorTable = document.getElementById('csv-editor-table');

        // Transpose elements
        const transposeCsvBtn = document.getElementById('transpose-csv-btn');

        // Pivot elements
        const loadPivotHeadersBtn = document.getElementById('load-pivot-headers-btn');
        const pivotControls = document.getElementById('pivot-controls');
        const runPivotBtn = document.getElementById('run-pivot-btn');

        // Download buttons
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const downloadJsonBtn = document.getElementById('download-json-btn');
        
        let editorHeaders = [];
        let editorData = [];
        let csvHeaders = [];
        let csvData = []; // for pivot

        // --- Theme Toggle ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        };
        themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
        const currentTheme = localStorage.getItem('theme') || 'light';
        applyTheme(currentTheme);


        // --- Original Converters ---
        csvToJsonBtn.addEventListener('click', () => {
            if (csvInput.value.trim() === '') {
                alert('CSV input is empty.');
                return;
            }
            Papa.parse(csvInput.value, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    jsonInput.value = JSON.stringify(results.data, null, 2);
                },
                error: (err) => {
                    alert('Error parsing CSV: ' + err.message);
                }
            });
        });

        jsonToCsvBtn.addEventListener('click', () => {
            if (jsonInput.value.trim() === '') {
                alert('JSON input is empty.');
                return;
            }
            try {
                const json = JSON.parse(jsonInput.value);
                const csv = Papa.unparse(json);
                csvInput.value = csv;
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        });

        // --- Original File Uploads ---
        uploadCsvBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                csvInput.value = event.target.result;
            };
            reader.readAsText(file);
        });

        uploadJsonBtn.addEventListener('click', () => jsonFileInput.click());
        jsonFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                jsonInput.value = event.target.result;
            };
            reader.readAsText(file);
        });
        
        // --- NEW: Tab Switching ---
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');

                // Update buttons
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update content
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabId);
                });
            });
        });

        // --- NEW: CSV Editor ---
        loadCsvEditorBtn.addEventListener('click', () => {
            if (csvInput.value.trim() === '') {
                alert('CSV input is empty.');
                return;
            }
            Papa.parse(csvInput.value, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    editorHeaders = results.meta.fields;
                    editorData = results.data;
                    renderEditorTable();
                    saveCsvEditorBtn.classList.remove('hidden');
                },
                error: (err) => {
                    alert('Error parsing CSV: ' + err.message);
                }
            });
        });

        function renderEditorTable() {
            csvEditorTable.innerHTML = ''; // Clear table
            
            // Create Thead
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            editorHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            csvEditorTable.appendChild(thead);

            // Create Tbody
            const tbody = document.createElement('tbody');
            editorData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                editorHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    td.setAttribute('contenteditable', 'true');
                    // Add listener to update data array on edit
                    td.addEventListener('blur', (e) => {
                        editorData[rowIndex][header] = e.target.textContent;
                    });
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            csvEditorTable.appendChild(tbody);
        }

        saveCsvEditorBtn.addEventListener('click', () => {
            // Re-unparse the editorData, which was updated by 'blur' events
            const newCsv = Papa.unparse(editorData, {
                header: true,
                quotes: true
            });
            csvInput.value = newCsv;
            alert('CSV data saved to the textarea above!');
        });

        // --- NEW: Transpose CSV ---
        transposeCsvBtn.addEventListener('click', () => {
            if (csvInput.value.trim() === '') {
                alert('CSV input is empty.');
                return;
            }
            Papa.parse(csvInput.value, {
                header: false, // Important: treat as simple 2D array
                skipEmptyLines: true,
                complete: (results) => {
                    const originalData = results.data;
                    if (originalData.length === 0) return;

                    const transposedData = [];
                    const newRows = originalData[0].length;
                    const newCols = originalData.length;

                    for (let i = 0; i < newRows; i++) {
                        transposedData[i] = [];
                        for (let j = 0; j < newCols; j++) {
                            // Ensure originalData[j] exists and has index i
                            transposedData[i][j] = originalData[j] ? originalData[j][i] : undefined;
                        }
                    }
                    
                    const newCsv = Papa.unparse(transposedData);
                    csvInput.value = newCsv;
                    alert('CSV data has been transposed.');
                },
                error: (err) => {
                    alert('Error parsing CSV: ' + err.message);
                }
            });
        });

        // --- NEW: Pivot CSV ---
        loadPivotHeadersBtn.addEventListener('click', () => {
            if (csvInput.value.trim() === '') {
                alert('CSV input is empty.');
                return;
            }
            // Parse headers
            Papa.parse(csvInput.value, {
                header: true,
                skipEmptyLines: true,
                preview: 1, // Only need headers
                complete: (results) => {
                    csvHeaders = results.meta.fields;
                    if (csvHeaders && csvHeaders.length > 0) {
                        renderPivotControls();
                        pivotControls.classList.remove('hidden');
                        runPivotBtn.classList.remove('hidden');
                    } else {
                        alert('Could not parse headers from CSV.');
                    }
                }
            });
            // Parse full data for later
            Papa.parse(csvInput.value, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true, // Attempt to convert numbers
                complete: (results) => {
                    csvData = results.data;
                },
                error: (err) => {
                    alert('Error parsing CSV data: ' + err.message);
                }
            });
        });

        function renderPivotControls() {
            const optionsHtml = csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('');
            pivotControls.innerHTML = `
                <div>
                    <label for="pivot-row-field" class="block text-sm font-medium text-[var(--text-color-secondary)]">Row Field</label>
                    <select id="pivot-row-field" class="mt-1 block w-full p-2 border rounded bg-[var(--input-bg-color)] border-[var(--border-color)] text-[var(--text-color-primary)]">
                        ${optionsHtml}
                    </select>
                </div>
                <div>
                    <label for="pivot-col-field" class="block text-sm font-medium text-[var(--text-color-secondary)]">Column Field</label>
                    <select id="pivot-col-field" class="mt-1 block w-full p-2 border rounded bg-[var(--input-bg-color)] border-[var(--border-color)] text-[var(--text-color-primary)]">
                        ${optionsHtml}
                    </select>
                </div>
                <div>
                    <label for="pivot-val-field" class="block text-sm font-medium text-[var(--text-color-secondary)]">Value Field</label>
                    <select id="pivot-val-field" class="mt-1 block w-full p-2 border rounded bg-[var(--input-bg-color)] border-[var(--border-color)] text-[var(--text-color-primary)]">
                        <option value="">(None - for COUNT)</option>
                        ${optionsHtml}
                    </select>
                </div>
                <div>
                    <label for="pivot-agg-func" class="block text-sm font-medium text-[var(--text-color-secondary)]">Aggregation</label>
                    <select id="pivot-agg-func" class="mt-1 block w-full p-2 border rounded bg-[var(--input-bg-color)] border-[var(--border-color)] text-[var(--text-color-primary)]">
                        <option value="COUNT">COUNT</option>
                        <option value="SUM">SUM</option>
                        <option value="AVG">AVERAGE</option>
                        <option value="MIN">MIN</option>
                        <option value="MAX">MAX</option>
                    </select>
                </div>
            `;
        }

        runPivotBtn.addEventListener('click', () => {
            const rowField = document.getElementById('pivot-row-field').value;
            const colField = document.getElementById('pivot-col-field').value;
            const valField = document.getElementById('pivot-val-field').value;
            const aggFunc = document.getElementById('pivot-agg-func').value;

            if (rowField === colField) {
                alert('Row field and Column field cannot be the same.');
                return;
            }
            if (aggFunc !== 'COUNT' && !valField) {
                alert('Please select a Value Field for SUM, AVG, MIN, or MAX.');
                return;
            }
            if (aggFunc === 'COUNT' && valField) {
                console.log('Note: Value field is ignored for COUNT aggregation.');
            }

            try {
                const pivotData = createPivotTable(csvData, rowField, colField, valField, aggFunc);
                const newCsv = Papa.unparse(pivotData);
                csvInput.value = newCsv;
                alert('Pivot table generated and placed in CSV input.');
            } catch (e) {
                alert('Error generating pivot table: ' + e.message);
                console.error(e);
            }
        });

        function createPivotTable(data, rowField, colField, valField, aggFunc) {
            const pivot = {}; // { rowVal: { colVal1: [values], colVal2: [values] } }
            const allColValues = new Set();

            data.forEach(row => {
                const rVal = row[rowField];
                const cVal = row[colField];
                const vVal = (aggFunc === 'COUNT') ? 1 : row[valField];
                
                if (rVal === undefined || cVal === undefined) return;
                
                allColValues.add(cVal);
                if (!pivot[rVal]) {
                    pivot[rVal] = {};
                }
                if (!pivot[rVal][cVal]) {
                    pivot[rVal][cVal] = [];
                }

                if (aggFunc === 'COUNT' || (vVal !== undefined && vVal !== null && vVal !== '')) {
                     pivot[rVal][cVal].push(vVal);
                }
            });

            const sortedColValues = Array.from(allColValues).sort((a, b) => String(a).localeCompare(String(b), undefined, {numeric: true}));
            const result = [];

            // Header row
            const header = { [rowField]: rowField };
            sortedColValues.forEach(c => header[c] = c);
            
            // Re-map header to an array to maintain order
            const headerArray = [rowField, ...sortedColValues];

            // Data rows
            const sortedRowValues = Object.keys(pivot).sort((a, b) => String(a).localeCompare(String(b), undefined, {numeric: true}));
            
            sortedRowValues.forEach(rVal => {
                const newRow = { [rowField]: rVal };
                
                sortedColValues.forEach(cVal => {
                    const values = pivot[rVal][cVal];
                    if (values && values.length > 0) {
                        newRow[cVal] = aggregate(values, aggFunc);
                    } else {
                        newRow[cVal] = null; // Use null for empty cells
                    }
                });
                result.push(newRow);
            });

            // Prepend header row to the final array of objects for Papa.unparse
            return [headerArray, ...result.map(row => headerArray.map(field => row[field]))];
        }

        function aggregate(values, func) {
            if (func === 'COUNT') {
                return values.length;
            }
            
            // Filter out non-numeric values for other aggregations
            const numericValues = values.map(Number).filter(v => !isNaN(v));
            if (numericValues.length === 0) return null;

            switch (func) {
                case 'SUM':
                    return numericValues.reduce((a, b) => a + b, 0);
                case 'AVG':
                    return numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                case 'MIN':
                    return Math.min(...numericValues);
                case 'MAX':
                    return Math.max(...numericValues);
                default:
                    return null;
            }
        }

        // --- NEW: Download ---
        downloadCsvBtn.addEventListener('click', () => {
            download(csvInput.value, 'converted.csv', 'text/csv;charset=utf-8;');
        });

        downloadJsonBtn.addEventListener('click', () => {
            download(jsonInput.value, 'converted.json', 'application/json;charset=utf-8;');
        });

        function download(content, filename, mimeType) {
            if (content.trim() === '') {
                alert('Nothing to download.');
                return;
            }
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- NEW: String Utilities Logic ---
        const stringInput = document.getElementById('string-input');
        const stringOutput = document.getElementById('string-output');
        const stringConversionType = document.getElementById('string-conversion-type');
        const runStringConversionBtn = document.getElementById('run-string-conversion-btn');
        const swapStringInputsBtn = document.getElementById('swap-string-inputs-btn');

        runStringConversionBtn.addEventListener('click', () => {
            const input = stringInput.value;
            const type = stringConversionType.value;
            
            if (!input && input !== '') {
                // Allow empty string to clear output
                return;
            }

            let result = '';
            try {
                switch(type) {
                    case 'text-to-binary':
                        result = input.split('').map(c => c.charCodeAt(0).toString(2).padStart(8, '0')).join(' ');
                        break;
                    case 'binary-to-text':
                        // Remove everything that isn't 0, 1, or whitespace
                        const cleanBin = input.replace(/[^01\s]/g, '').trim();
                        if (!cleanBin) { result = ""; break; }
                        result = cleanBin.split(/\s+/).map(b => String.fromCharCode(parseInt(b, 2))).join('');
                        break;
                    case 'text-to-base64':
                        result = btoa(input);
                        break;
                    case 'base64-to-text':
                        result = atob(input);
                        break;
                    case 'text-to-hex':
                        result = input.split('').map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(' ');
                        break;
                    case 'hex-to-text':
                        // Remove whitespace and non-hex chars
                        const cleanHex = input.replace(/[^0-9a-fA-F]/g, '');
                        if (cleanHex.length % 2 !== 0) throw new Error('Hex string must have an even number of characters.');
                        result = cleanHex.match(/.{1,2}/g).map(byte => String.fromCharCode(parseInt(byte, 16))).join('');
                        break;
                    case 'url-encode':
                        result = encodeURIComponent(input);
                        break;
                    case 'url-decode':
                        result = decodeURIComponent(input);
                        break;
                }
                stringOutput.value = result;
            } catch (e) {
                stringOutput.value = 'Error: ' + e.message;
            }
        });

        swapStringInputsBtn.addEventListener('click', () => {
            stringInput.value = stringOutput.value;
            stringOutput.value = '';
            // Optional: Intelligent mode switching could go here
            // e.g., if mode was 'text-to-binary', switch to 'binary-to-text'
        });

    </script>
</body>
</html>