<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlantTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'128'%20height%3D'128'%20viewBox%3D'0%200%20128%20128'%3E%3Cdefs%3E%3ClinearGradient%20id%3D'g'%20x1%3D'85.35533905932738%25'%20y1%3D'85.35533905932738%25'%20x2%3D'14.644660940672615%25'%20y2%3D'14.64466094067263%25'%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'0%25'%20style%3D'stop-color%3A%234f46e5%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'100%25'%20style%3D'stop-color%3A%239333ea%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect%20width%3D'128'%20height%3D'128'%20rx%3D'25.6'%20fill%3D'url(%23g)'%20%2F%3E%3Cg%20transform%3D'translate(0%2C%200)%20rotate(0%2C%2064%2C%2064)'%3E%3Csvg%20x%3D'32'%20y%3D'32'%20width%3D'64'%20height%3D'64'%20viewBox%3D'0%200%20512%20512'%3E%3Cpath%20fill%3D'%2322c55e'%20fill-opacity%3D'1'%20d%3D'M272%2096c-78.6%200-145.1%2051.5-167.7%20122.5c33.6-17%2071.5-26.5%20111.7-26.5h88c8.8%200%2016%207.2%2016%2016s-7.2%2016-16%2016H288%20216s0%200%200%200c-16.6%200-32.7%201.9-48.3%205.4c-25.9%205.9-49.9%2016.4-71.4%2030.7c0%200%200%200%200%200C38.3%20298.8%200%20364.9%200%20440v16c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24V440c0-48.7%2020.7-92.5%2053.8-123.2C121.6%20392.3%20190.3%20448%20272%20448l1%200c132.1-.7%20239-130.9%20239-291.4c0-42.6-7.5-83.1-21.1-119.6c-2.6-6.9-12.7-6.6-16.2-.1C455.9%2072.1%20418.7%2096%20376%2096L272%2096z'%20%2F%3E%3C%2Fsvg%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="manifest" href="/manifest.json" />
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        green: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Standardized Variables for SharedNav Compatibility --- */
        :root {
            /* Light Mode Defaults */
            --bg: #f0fdf4;       /* Green-50 */
            --card: #ffffff;
            --text: #14532d;     /* Green-900 */
            --border: #bbf7d0;   /* Green-200 */
            --input-bg: #dcfce7; /* Green-100 */
            --primary: #16a34a;  /* Green-600 */
        }

        .dark {
            /* Dark Mode Defaults */
            --bg: #064e3b;       /* Green-900 */
            --card: #022c22;     /* Green-950 */
            --text: #ecfdf5;     /* Green-50 */
            --border: #14532d;
            --input-bg: #14532d; /* Green-900 */
            --primary: #22c55e;  /* Green-500 */
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Mobile Bottom Nav Spacing */
        @media (max-width: 768px) {
            body { padding-bottom: 80px; }
        }
        
        /* --- Component Styles --- */
        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .input-std {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            outline: none;
            transition: ring 0.2s;
        }
        .input-std:focus {
            ring: 2px solid var(--primary);
            border-color: var(--primary);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background-color: var(--input-bg);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .btn-secondary:hover { filter: brightness(0.95); }

        .plant-icon-circle {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem;
            background-color: var(--input-bg);
            color: var(--primary);
        }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
            position: relative;
        }

        /* Toast Message */
        .message-box {
            position: fixed; top: 6rem; left: 50%; transform: translateX(-50%);
            padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            color: white; z-index: 100; font-weight: 600;
            display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .message-box.show { display: block; animation: fadeIn 0.3s; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 0.75rem; color: var(--text); opacity: 0.7; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 0.75rem; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <div id="loading-state" class="fixed inset-0 flex flex-col items-center justify-center bg-[var(--bg)] z-50">
        <i class="fa-solid fa-leaf fa-spin text-5xl text-[var(--primary)] mb-4"></i>
        <p class="text-lg font-semibold opacity-70">Entering the greenhouse...</p>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8 hidden" id="main-app-container">
        
        <div id="tab-content-dashboard" class="tab-content animate-fade">
            <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <section class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-droplet text-blue-500"></i> Thirsty Plants
                    </h2>
                    <div id="dashboard-water-list" class="space-y-3">
                        <p class="text-sm opacity-60">Calculating water levels...</p>
                    </div>
                </section>

                <section class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-seedling text-orange-500"></i> Hungry Plants
                    </h2>
                    <div id="dashboard-fert-list" class="space-y-3">
                        <p class="text-sm opacity-60">Checking soil nutrients...</p>
                    </div>
                </section>
            </div>

            <section class="card p-6 mb-8">
    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-calendar-week text-purple-500"></i> Upcoming Tasks (Next 7 Days)
    </h2>
    <div id="dashboard-upcoming-list" class="space-y-1">
        <p class="text-sm opacity-60">Forecasting schedule...</p>
    </div>
</section>

<section>
    <h2 class="text-xl font-bold mb-4">Recent Activity</h2>
    <div id="dashboard-recent-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</section>
        </div>

        <div id="tab-content-plants" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold">My Garden</h1>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="plant-filter-location" class="input-std !w-auto">
                        <option value="all">All Locations</option>
                    </select>
                    <button id="open-add-plant-modal" class="btn-primary whitespace-nowrap">
                        <i class="fa-solid fa-plus mr-2"></i> Add Plant
                    </button>
                </div>
            </div>
            <div id="plants-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-content-log" class="tab-content hidden animate-fade">
            <div class="card max-w-2xl mx-auto p-6 md:p-8">
                <h1 class="text-2xl font-bold mb-6 text-center">Log Care Event</h1>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Select Plant</label>
                        <select id="log-plant-select" class="input-std"></select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">Action</label>
                            <select id="log-type-select" class="input-std">
                                <option value="Water">Watering</option>
                                <option value="Fertilize">Fertilizing</option>
                                <option value="Prune">Pruning</option>
                                <option value="Repot">Repotting</option>
                                <option value="Pest Control">Pest Control</option>
                                <option value="Note">Note / Observation</option>
                                <option value="Growth">Growth Check</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Date</label>
                            <input type="datetime-local" id="log-date" class="input-std">
                        </div>
                    </div>

                    <div id="log-growth-group" class="hidden" style="display: none;">
                        <label class="block text-sm font-bold mb-1">Height / Size (cm)</label>
                        <input type="number" id="log-growth-val" class="input-std" placeholder="e.g. 15.5">
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Notes</label>
                        <textarea id="log-notes" rows="3" class="input-std" placeholder="Any observations?"></textarea>
                    </div>

                    <button id="submit-log-btn" class="btn-primary w-full mt-4">
                        <i class="fa-solid fa-check mr-2"></i> Save Log
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-content-history" class="tab-content hidden animate-fade">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Care History</h1>
                <input type="text" id="history-search" class="input-std !w-64" placeholder="Search history...">
            </div>
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table id="history-table">
                        <thead><tr><th>Date</th><th>Plant</th><th>Action</th><th>Details</th><th></th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-content-settings" class="tab-content hidden animate-fade">
            <h1 class="text-3xl font-bold mb-6">Settings</h1>
            <div class="card p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Seasons</h2>
    <div class="flex items-center justify-between">
        <div>
            <p class="font-bold">Winter Mode</p>
            <p class="text-xs opacity-70">Reduces watering frequency by 50%</p>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="winter-mode-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
        </label>
    </div>
</div>
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Data Management</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="export-json-btn" class="btn-secondary"><i class="fa-solid fa-download mr-2"></i> Export JSON</button>
                    <button id="export-csv-btn" class="btn-secondary"><i class="fa-solid fa-file-csv mr-2"></i> Export CSV</button>
                </div>
            </div>
        </div>

    </main>

    <div id="plant-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Plant</h2>
            <input type="hidden" id="modal-plant-id">
            
            <div class="space-y-4">
                <div><label class="text-sm font-bold">Name</label><input type="text" id="plant-name" class="input-std" placeholder="e.g. Monstera"></div>
                
                <div class="grid grid-cols-2 gap-4">
    <div><label class="text-sm font-bold">Species</label><input type="text" id="plant-species" class="input-std"></div>
    <div><label class="text-sm font-bold">Room / Area</label><input type="text" id="plant-location" class="input-std"></div>
</div>

<div class="grid grid-cols-2 gap-4">
    <div>
        <label class="text-sm font-bold">Light Condition</label>
        <select id="plant-light" class="input-std">
            <option value="">-- Select --</option>
            <option value="low">‚òÅÔ∏è Low / Shadow</option>
            <option value="medium">‚õÖ Medium / Indirect</option>
            <option value="high">‚òÄÔ∏è Bright / Direct</option>
        </select>
    </div>
    <div>
        <label class="text-sm font-bold">Position Details</label>
        <input type="text" id="plant-position" class="input-std" placeholder="e.g. North Window Sill">
    </div>
</div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Water Every (Days)</label><input type="number" id="plant-water-freq" class="input-std"></div>
                    <div><label class="text-sm font-bold">Feed Every (Days)</label><input type="number" id="plant-fert-freq" class="input-std"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Acquired On</label><input type="date" id="plant-acquired" class="input-std"></div>
                    <div>
                        <label class="text-sm font-bold">Icon</label>
                        <select id="plant-icon" class="input-std">
                            <option value="fa-leaf">Leaf</option>
                            <option value="fa-seedling">Seedling</option>
                            <option value="fa-tree">Tree</option>
                            <option value="fa-cannabis">Broad</option>
                            <option value="fa-clover">Clover</option>
                            <option value="fa-spa">Lotus</option>
                            <option value="fa-apple-whole">Fruit</option>
                            <option value="fa-pepper-hot">Veg</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button id="save-plant-btn" class="btn-primary flex-1">Save Plant</button>
                    <button id="delete-plant-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden" style="display: none;"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { changelogData } from '../changelog-data.js'; // Import Version Data
        import { AppNavigation } from '../shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp, doc, deleteDoc, updateDoc, query, orderBy, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Theme Init (Immediate) ---
        if (localStorage.getItem('theme') === 'dark' || 
           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // --- State ---
        const state = {
            user: null,
            plants: [],
            logs: [],
            unsubPlants: null,
            unsubLogs: null,
            nav: null, 
            themeUnsubscribe: null 
        };

        // --- UI Utils ---
        const getEl = (id) => document.getElementById(id);
        const showMsg = (msg, type = "success") => {
            const box = getEl("message-box");
            box.textContent = msg;
            box.className = `message-box show ${type === 'error' ? 'bg-red-500' : 'bg-[var(--primary)]'}`;
            setTimeout(() => box.classList.remove("show"), 3000);
        };
        const toggleDisplay = (el, show) => {
            el.style.display = show ? 'block' : 'none';
        };

        const lightIcons = { low: 'fa-cloud', medium: 'fa-cloud-sun', high: 'fa-sun' };
const lightColors = { low: 'text-gray-400', medium: 'text-yellow-400', high: 'text-orange-500' };

        // --- Rendering Functions ---
        const renderPlants = () => {
            const list = getEl("plants-list-container");
            const select = getEl("log-plant-select");
            const filterLoc = getEl("plant-filter-location");
            
            select.innerHTML = "<option value=''>-- Select Plant --</option>";
            state.plants.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id; opt.textContent = p.name;
                select.appendChild(opt);
            });

            const currentFilter = filterLoc.value; 
            const locations = [...new Set(state.plants.map(p => p.location).filter(Boolean))].sort();
            filterLoc.innerHTML = '<option value="all">All Locations</option>';
            locations.forEach(loc => {
                const opt = document.createElement("option");
                opt.value = loc; opt.textContent = loc;
                if(loc === currentFilter) opt.selected = true;
                filterLoc.appendChild(opt);
            });

            let displayPlants = state.plants;
            if (filterLoc.value !== 'all') displayPlants = state.plants.filter(p => p.location === filterLoc.value);

            list.innerHTML = displayPlants.length ? '' : `<p class="opacity-50 text-center col-span-3 py-8">No plants found.</p>`;

            displayPlants.forEach(plant => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between h-full hover:shadow-lg transition";
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="plant-icon-circle"><i class="fa-solid ${plant.icon || 'fa-leaf'}"></i></div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">${plant.name}</h3>
                                <p class="text-xs opacity-70">${plant.species || 'Unknown'}</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-[var(--primary)] edit-plant-btn" data-id="${plant.id}"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    
                    <div class="space-y-2 mb-4 flex-grow">
    <div class="flex items-center gap-2 text-sm font-semibold">
        <i class="fa-solid fa-location-dot w-4 text-gray-400"></i> ${plant.location || 'No location'}
    </div>
    
    <div class="flex items-center gap-2 text-xs opacity-70 ml-6">
        ${plant.light ? `<i class="fa-solid ${lightIcons[plant.light] || 'fa-sun'} ${lightColors[plant.light] || ''}"></i>` : ''}
        <span>${plant.position || (plant.light ? 'Light set' : 'No details')}</span>
    </div>

    ${plant.waterFreq ? `<div class="flex items-center gap-2 text-sm text-blue-500 mt-2"><i class="fa-solid fa-droplet w-4"></i> Every ${plant.waterFreq} days</div>` : ''}
    ${plant.snoozeUntil && plant.snoozeUntil.toDate() > new Date() ? `<div class="inline-block px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs font-bold mt-1"><i class="fa-solid fa-clock"></i> Snoozed</div>` : ''}
</div>

                    <div class="grid grid-cols-2 gap-2 mt-auto">
                        <button class="btn-secondary text-sm quick-water-btn" data-id="${plant.id}"><i class="fa-solid fa-droplet text-blue-500"></i> Water</button>
                        <button class="btn-secondary text-sm" onclick="location.hash='#log'; document.getElementById('log-plant-select').value='${plant.id}';"><i class="fa-solid fa-plus text-green-500"></i> Log</button>
                    </div>
                `;
                list.appendChild(card);
            });

            document.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
            document.querySelectorAll(".quick-water-btn").forEach(b => b.onclick = (e) => quickWater(e.currentTarget.dataset.id));
        };

        const renderDashboard = () => {
    const waterList = getEl("dashboard-water-list");
    const fertList = getEl("dashboard-fert-list");
    const upcomingList = getEl("dashboard-upcoming-list"); // Select new element
    const recentList = getEl("dashboard-recent-list");
    
    waterList.innerHTML = ""; 
    fertList.innerHTML = ""; 
    upcomingList.innerHTML = ""; 
    recentList.innerHTML = "";

    const now = new Date();
    let thirstyCount = 0; 
    let hungryCount = 0;
    const upcomingTasks = []; // Array to store future tasks

    state.plants.forEach(plant => {
        const plantLogs = state.logs.filter(l => l.plantId === plant.id);
        const lastWater = plantLogs.find(l => l.type === 'Water');
        const lastFert = plantLogs.find(l => l.type === 'Fertilize');

        // --- Check Water ---
        if (plant.waterFreq) {
            let isSnoozed = plant.snoozeUntil && plant.snoozeUntil.toDate() > now;
            if (!isSnoozed) {
                const lastDate = lastWater ? new Date(lastWater.date) : new Date(plant.acquired || 0);
                const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                const daysOverdue = Math.floor(diffDays - plant.waterFreq);

                if (daysOverdue >= 0) {
                    // Existing Thirsty Logic
                    thirstyCount++;
                    const div = document.createElement("div");
                    div.className = "flex justify-between items-center bg-[var(--input-bg)] p-3 rounded-lg border border-[var(--border)]";
                    div.innerHTML = `
                        <div>
                            <p class="font-bold text-sm">${plant.name}</p>
                            <p class="text-xs text-red-500 font-bold">${daysOverdue === 0 ? 'Due Today' : `${daysOverdue} days late`}</p>
                        </div>
                        <div class="flex gap-1">
                            <button class="btn-secondary p-1.5 rounded text-xs snooze-btn" data-id="${plant.id}" title="Snooze 2 Days"><i class="fa-solid fa-clock text-yellow-500"></i></button>
                            <button class="btn-primary p-1.5 rounded text-xs quick-water-btn" data-id="${plant.id}"><i class="fa-solid fa-check"></i></button>
                        </div>
                    `;
                    waterList.appendChild(div);
                } else if (daysOverdue >= -7) {
                    // [NEW] Upcoming Water Logic
                    const daysUntil = Math.abs(daysOverdue);
                    const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                    upcomingTasks.push({
                        plant: plant,
                        type: 'Water',
                        daysUntil: daysUntil,
                        date: dueDate,
                        icon: 'fa-droplet',
                        color: 'text-blue-500',
                        bg: 'bg-blue-100 dark:bg-blue-900'
                    });
                }
            }
        }

        // --- Check Fertilizer ---
        if (plant.fertFreq) {
            const lastDate = lastFert ? new Date(lastFert.date) : new Date(plant.acquired || 0);
            const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
            const daysOverdue = Math.floor(diffDays - plant.fertFreq);

            if (daysOverdue >= 0) {
                // Existing Hungry Logic
                hungryCount++;
                const div = document.createElement("div");
                div.className = "flex justify-between items-center bg-[var(--input-bg)] p-3 rounded-lg border border-[var(--border)]";
                div.innerHTML = `
                    <div><p class="font-bold text-sm">${plant.name}</p><p class="text-xs text-orange-500 font-bold">${daysOverdue} days overdue</p></div>
                `;
                fertList.appendChild(div);
            } else if (daysOverdue >= -7) {
                 // [NEW] Upcoming Fert Logic
                 const daysUntil = Math.abs(daysOverdue);
                 const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                 upcomingTasks.push({
                     plant: plant,
                     type: 'Fertilize',
                     daysUntil: daysUntil,
                     date: dueDate,
                     icon: 'fa-seedling',
                     color: 'text-orange-500',
                     bg: 'bg-orange-100 dark:bg-orange-900'
                 });
            }
        }
    });

    // --- Render Empty States for Thirsty/Hungry ---
    if (thirstyCount === 0) waterList.innerHTML = `<div class="text-center p-4 bg-[var(--input-bg)] rounded-lg text-green-600"><i class="fa-solid fa-check-circle mb-1 text-2xl"></i><p class="text-sm font-bold">All plants watered!</p></div>`;
    if (hungryCount === 0) fertList.innerHTML = `<div class="text-center p-4 bg-[var(--input-bg)] rounded-lg text-green-600"><i class="fa-solid fa-check-circle mb-1 text-2xl"></i><p class="text-sm font-bold">All plants fed!</p></div>`;

    document.querySelectorAll("#dashboard-water-list .quick-water-btn").forEach(b => b.onclick = (e) => quickWater(e.currentTarget.dataset.id));
    document.querySelectorAll(".snooze-btn").forEach(b => b.onclick = (e) => snoozePlant(e.currentTarget.dataset.id));

    // --- [NEW] Render Upcoming Tasks ---
    upcomingTasks.sort((a, b) => a.daysUntil - b.daysUntil); // Sort by soonest

    if (upcomingTasks.length === 0) {
        upcomingList.innerHTML = `<p class="text-center py-4 opacity-50 text-sm">No tasks for the next 7 days. Relax! üåø</p>`;
    } else {
        upcomingTasks.forEach(task => {
            const row = document.createElement("div");
            row.className = "flex items-center justify-between p-3 border-b border-[var(--border)] last:border-0 hover:bg-[var(--input-bg)] transition-colors rounded";
            row.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full ${task.bg} flex items-center justify-center ${task.color}">
                        <i class="fa-solid ${task.icon}"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm">${task.plant.name}</p>
                        <p class="text-xs opacity-70">${task.type}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-sm text-[var(--primary)]">
                        ${task.daysUntil === 1 ? 'Tomorrow' : `In ${task.daysUntil} days`}
                    </p>
                    <p class="text-xs opacity-60">${task.date.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})}</p>
                </div>
            `;
            upcomingList.appendChild(row);
        });
    }

    // --- Render Recent Activity (Existing Logic) ---
    state.logs.slice(0, 6).forEach(log => {
        const plant = state.plants.find(p => p.id === log.plantId);
        const item = document.createElement("div");
        item.className = "card p-3 flex flex-col justify-center h-24";
        item.innerHTML = `
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold text-sm text-[var(--primary)]">${log.type}</span>
                <span class="text-xs opacity-60">${new Date(log.date).toLocaleDateString()}</span>
            </div>
            <p class="font-bold text-sm truncate">${plant ? plant.name : 'Unknown Plant'}</p>
            ${log.notes ? `<p class="text-xs italic opacity-70 truncate">"${log.notes}"</p>` : ''}
        `;
        recentList.appendChild(item);
    });
};

        const renderHistory = () => {
            const tbody = getEl("history-table-body");
            tbody.innerHTML = "";
            const filter = getEl("history-search").value.toLowerCase();

            state.logs.forEach(log => {
                const plant = state.plants.find(p => p.id === log.plantId);
                const plantName = plant ? plant.name : "Deleted Plant";
                if (!filter || `${plantName} ${log.type} ${log.notes}`.toLowerCase().includes(filter)) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${new Date(log.date).toLocaleDateString()}</td>
                        <td class="font-bold">${plantName}</td>
                        <td>${log.type}</td>
                        <td class="text-sm opacity-80">${log.value ? `<b>${log.value}cm</b> ` : ''}${log.notes || '-'}</td>
                        <td><button class="text-red-400 hover:text-red-600 delete-log-btn" data-id="${log.id}"><i class="fa-solid fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            document.querySelectorAll(".delete-log-btn").forEach(b => b.onclick = (e) => deleteLog(e.currentTarget.dataset.id));
        };

        // --- Logic Actions ---
        const quickWater = async (plantId) => {
            if (!confirm("Log watering now?")) return;
            try {
                await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                    plantId, type: "Water", date: new Date().toISOString(), notes: "Dashboard Quick Log", createdAt: Timestamp.now()
                });
                await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { snoozeUntil: null });
                showMsg("Watering logged!");
            } catch (e) { showMsg(e.message, "error"); }
        };

        const snoozePlant = async (plantId) => {
            try {
                const date = new Date(); date.setDate(date.getDate() + 2);
                await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { snoozeUntil: Timestamp.fromDate(date) });
                showMsg("Snoozed 2 days");
            } catch(e) { showMsg(e.message, "error"); }
        }

        const deleteLog = async (id) => {
            if(confirm("Delete this log?")) {
                await deleteDoc(doc(db, `users/${state.user.uid}/plant_logs`, id));
                showMsg("Log deleted");
            }
        };

        // --- Modal Logic ---
        const openPlantModal = (plantId = null) => {
            const modal = getEl("plant-modal");
            const title = getEl("modal-title");
            const delBtn = getEl("delete-plant-btn");
            const idInput = getEl("modal-plant-id");
            
            ['plant-name', 'plant-species', 'plant-location', 'plant-water-freq', 'plant-fert-freq'].forEach(id => getEl(id).value = '');
            getEl("plant-acquired").value = new Date().toISOString().split('T')[0];
            getEl("plant-icon").value = "fa-leaf";

            if (plantId) {
                const plant = state.plants.find(p => p.id === plantId);
                if (plant) {
                    title.textContent = "Edit Plant";
                    idInput.value = plant.id;
                    getEl("plant-name").value = plant.name;
                    getEl("plant-species").value = plant.species || "";
                    getEl("plant-location").value = plant.location || "";
                    getEl("plant-light").value = plant.light || "";
getEl("plant-position").value = plant.position || "";
                    getEl("plant-water-freq").value = plant.waterFreq || "";
                    getEl("plant-fert-freq").value = plant.fertFreq || "";
                    getEl("plant-acquired").value = plant.acquired || "";
                    getEl("plant-icon").value = plant.icon || "fa-leaf";
                    toggleDisplay(delBtn, true);
                }
            } else {
                title.textContent = "Add Plant";
                idInput.value = "";
                toggleDisplay(delBtn, false);
            }
            toggleDisplay(modal, true);
        };

        getEl("open-add-plant-modal").onclick = () => openPlantModal();
        document.querySelectorAll(".close-modal-btn").forEach(b => b.onclick = () => toggleDisplay(getEl("plant-modal"), false));

        getEl("save-plant-btn").onclick = async () => {
            const id = getEl("modal-plant-id").value;
            const data = {
                name: getEl("plant-name").value,
                species: getEl("plant-species").value,
                location: getEl("plant-location").value,
                light: getEl("plant-light").value,
    position: getEl("plant-position").value,
                waterFreq: parseInt(getEl("plant-water-freq").value) || 0,
                fertFreq: parseInt(getEl("plant-fert-freq").value) || 0,
                acquired: getEl("plant-acquired").value,
                icon: getEl("plant-icon").value,
                updatedAt: Timestamp.now()
            };
            if (!data.name) return showMsg("Name required", "error");

            try {
                if (id) {
                    await updateDoc(doc(db, `users/${state.user.uid}/plants`, id), data);
                    showMsg("Plant updated");
                } else {
                    data.createdAt = Timestamp.now();
                    await addDoc(collection(db, `users/${state.user.uid}/plants`), data);
                    showMsg("Plant added");
                }
                toggleDisplay(getEl("plant-modal"), false);
            } catch (e) { showMsg(e.message, "error"); }
        };

        getEl("delete-plant-btn").onclick = async () => {
            const id = getEl("modal-plant-id").value;
            if(id && confirm("Delete plant?")) {
                await deleteDoc(doc(db, `users/${state.user.uid}/plants`, id));
                showMsg("Plant deleted");
                toggleDisplay(getEl("plant-modal"), false);
            }
        };

        getEl("log-type-select").onchange = (e) => {
            toggleDisplay(getEl("log-growth-group"), e.target.value === "Growth");
        };

        getEl("submit-log-btn").onclick = async () => {
            const plantId = getEl("log-plant-select").value;
            const type = getEl("log-type-select").value;
            const date = getEl("log-date").value;
            if (!plantId || !date) return showMsg("Plant and Date required", "error");

            try {
                await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                    plantId, type, date,
                    notes: getEl("log-notes").value,
                    value: type === "Growth" ? getEl("log-growth-val").value : null,
                    createdAt: Timestamp.now()
                });
                showMsg("Log saved!");
                getEl("log-notes").value = "";
                getEl("log-growth-val").value = "";
            } catch (e) { showMsg(e.message, "error"); }
        };

        // --- Auth & Init ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;

                // 1. Initialize Navigation
                state.nav = new AppNavigation({
                    appName: 'PlantTrackr',
                    appIcon: 'fa-leaf',
                    themeColor: 'green',
                    userEmail: user.email,
                    version: changelogData && changelogData.length > 0 ? changelogData[0].version : '1.0.0',
                    activeTab: 'dashboard',
                    tabs: [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fa-border-all' },
                        { id: 'plants',    label: 'Garden',    icon: 'fa-seedling' },
                        { id: 'log',       label: 'Log Care',  icon: 'fa-pen-to-square' },
                        { id: 'history',   label: 'History',   icon: 'fa-clock-rotate-left' },
                        { id: 'settings',  label: 'Settings',  icon: 'fa-gear' }
                    ],
                    onThemeChange: async (newTheme) => {
                        await setDoc(doc(db, 'users', user.uid, 'settings', 'theme'), { theme: newTheme }, { merge: true });
                    }
                });

                // Inside your main script, add a listener for general settings
onSnapshot(doc(db, 'users', state.user.uid, 'settings', 'general'), (snap) => {
    state.winterMode = snap.exists() ? snap.data().winterMode : false;
    const toggle = getEl("winter-mode-toggle");
    if(toggle) toggle.checked = state.winterMode;
    renderDashboard(); // Re-calc dates when mode changes
});

// Add listener to the toggle itself
getEl("winter-mode-toggle").addEventListener('change', async (e) => {
    await setDoc(doc(db, 'users', state.user.uid, 'settings', 'general'), { 
        winterMode: e.target.checked 
    }, { merge: true });
});

                // 2. Setup Real-time Theme Sync
                const themeDocRef = doc(db, 'users', user.uid, 'settings', 'theme');
                if (state.themeUnsubscribe) state.themeUnsubscribe();
                
                state.themeUnsubscribe = onSnapshot(themeDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const isDark = data.theme === 'dark';
                        if (state.nav) state.nav.applyTheme(isDark);
                    }
                });

                window.addEventListener('tab-changed', (e) => {
                    const tabId = e.detail.tabId;
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                    const target = getEl(`tab-content-${tabId}`);
                    if(target) target.classList.remove('hidden');
                });

                getEl("loading-state").classList.add("hidden");
                getEl("main-app-container").classList.remove("hidden");

                state.unsubPlants = onSnapshot(query(collection(db, `users/${user.uid}/plants`), orderBy("name")), snap => {
                    state.plants = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderPlants(); renderDashboard();
                });

                state.unsubLogs = onSnapshot(query(collection(db, `users/${user.uid}/plant_logs`), orderBy("date", "desc")), snap => {
                    state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderDashboard(); renderHistory();
                });

                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                getEl("log-date").value = now.toISOString().slice(0, 16);

            } else {
                window.location.href = '/';
            }
        });

        getEl("history-search").oninput = renderHistory;

        getEl("export-json-btn").onclick = () => {
            const blob = new Blob([JSON.stringify({plants: state.plants, logs: state.logs}, null, 2)], {type: "application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "plants_backup.json"; a.click();
        };
        getEl("export-csv-btn").onclick = () => {
            const csv = Papa.unparse(state.logs.map(l => ({
                date: l.date, plant: state.plants.find(p=>p.id===l.plantId)?.name, type: l.type, notes: l.notes
            })));
            const blob = new Blob([csv], {type: "text/csv"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "plant_logs.csv"; a.click();
        };
    </script>
</body>
</html>