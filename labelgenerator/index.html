<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printing Label Generator</title>
    <link rel="icon" href="/favicons/print.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&family=Lora&family=Merriweather&family=Playfair+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper-width: 210mm;
            --paper-height: 297mm;
            --label-width: 80mm;
            --label-height: 50mm;
            --corner-radius: 0mm;
            --margin-top: 10mm;
            --margin-left: 10mm;
            --grid-row-gap: 2mm;
            --grid-column-gap: 2mm;
            --grid-justify-content: start;
            --grid-align-content: start;
            --cols: 2;
            --font-size: 12pt;
            --font-family: 'Inter', sans-serif;
            --align-items: center; /* vertical text align in label */
            --justify-content: center; /* horizontal text align in label */
            --font-weight: normal;
            --font-style: normal;
        }

        #print-area { position: fixed; top: -9999px; left: -9999px; }
        body { font-family: 'Inter', sans-serif; }
        
        #label-grid-container {
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
        }

        /* Common styles for both on-screen and print pages */
        #label-grid, .print-page {
            display: grid;
            grid-template-columns: repeat(var(--cols), var(--label-width));
            justify-content: var(--grid-justify-content);
            align-content: var(--grid-align-content);
            row-gap: var(--grid-row-gap);
            column-gap: var(--grid-column-gap);
            background-color: white;
            width: var(--paper-width);
            height: var(--paper-height);
            padding-top: var(--margin-top);
            padding-bottom: var(--margin-top);
            padding-left: var(--margin-left);
            padding-right: var(--margin-left);
            box-sizing: border-box;
        }

        /* On-screen preview has a shadow */
        #label-grid {
             box-shadow: 0 4px 12px rgba(0,0,0,0.1);
             overflow: hidden;
        }

        .label {
            height: var(--label-height);
            border-top: 1px solid #ddd;
            border-left: 1px solid #ddd;
            border-radius: var(--corner-radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: var(--align-items);
            justify-content: var(--justify-content);
            padding: 2mm;
            box-sizing: border-box;
            font-size: var(--font-size);
            font-family: var(--font-family);
            font-weight: var(--font-weight);
            font-style: var(--font-style);
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
        
        .label::before {
            content: attr(data-label-number);
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 8pt;
            color: #aaa;
            font-family: 'Roboto Mono', monospace;
        }

        .label.selected {
            background-color: #e0f2fe;
            border-color: #0ea5e9;
        }
        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }
        
        @page { size: auto; margin: 0mm; }

        @media print {
            #app { display: none; }
            body { margin: 0; background-color: #fff; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
            }
            .print-page { 
                page-break-after: always; 
                margin: 0 auto; /* Center the page horizontally */
                height: var(--paper-height);
            }
            #print-area .label::before { display: none; }
            .print-label { border: 1px solid transparent; page-break-inside: avoid; }
            .print-label.not-selected { visibility: hidden; }
            #print-area.print-borders-on .print-label.has-content { border: 1px dashed #999; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="flex flex-col lg:flex-row min-h-screen">
        <div id="controls" class="w-full lg:w-96 bg-white shadow-lg p-6 space-y-4 overflow-y-auto">
            <h1 class="text-2xl font-bold text-gray-900">Printing Label Generator</h1>
            
            <details class="p-4 border rounded-lg bg-gray-50 group" open>
                <summary class="text-lg font-semibold cursor-pointer flex justify-between items-center">
                    <span>Template Setup</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </summary>
                <div class="mt-4 pt-4 border-t space-y-3">
                    <div>
                        <label for="templateType" class="block text-sm font-medium text-gray-700">Template Type</label>
                        <select id="templateType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500">
                            <option value="labelSheet">Label Sheet</option>
                            <option value="suspensionTab">Suspension File Tab</option>
                            <option value="envelope">Envelope</option>
                        </select>
                    </div>
                    <div>
                        <label for="presets" class="block text-sm font-medium text-gray-700">Presets</label>
                        <select id="presets" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></select>
                    </div>
                    <div id="envelopeControls" class="hidden space-y-3">
                         <div class="grid grid-cols-2 gap-4">
                            <div><label for="envelopeWidth" class="block text-sm font-medium text-gray-700">Width (mm)</label><input type="number" id="envelopeWidth" value="220" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                            <div><label for="envelopeHeight" class="block text-sm font-medium text-gray-700">Height (mm)</label><input type="number" id="envelopeHeight" value="110" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                        </div>
                    </div>
                    <div id="suspensionTabControls" class="hidden pt-2">
                        <div class="flex items-center">
                            <input id="printCutLines" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500"><label for="printCutLines" class="ml-2 block text-sm font-medium text-gray-700">Print cut lines</label>
                        </div>
                    </div>
                </div>
            </details>

            <div id="labelSheetControls" class="space-y-4">
                <details class="p-4 border rounded-lg bg-gray-50 group" open>
                    <summary class="text-lg font-semibold cursor-pointer flex justify-between items-center">
                        <span>Paper & Margins</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="mt-4 pt-4 border-t space-y-3">
                         <div><label for="paperSize" class="block text-sm font-medium text-gray-700">Paper Size</label><select id="paperSize" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="A4">A4 (210 x 297mm)</option><option value="Letter">US Letter (8.5 x 11in)</option></select></div>
                        <div><label for="orientation" class="block text-sm font-medium text-gray-700">Orientation</label><select id="orientation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="portrait">Portrait</option><option value="landscape">Landscape</option></select></div>
                         <div class="grid grid-cols-2 gap-4">
                            <div><label for="marginTop" class="block text-sm font-medium text-gray-700">Margin Top (mm)</label><input type="number" id="marginTop" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                            <div><label for="marginLeft" class="block text-sm font-medium text-gray-700">Margin Left (mm)</label><input type="number" id="marginLeft" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                        </div>
                    </div>
                </details>
                <details class="p-4 border rounded-lg bg-gray-50 group" open>
                    <summary class="text-lg font-semibold cursor-pointer flex justify-between items-center">
                        <span>Grid Layout</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="mt-4 pt-4 border-t space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="rows" class="block text-sm font-medium text-gray-700">Rows</label><input type="number" id="rows" value="4" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                            <div><label for="cols" class="block text-sm font-medium text-gray-700">Columns</label><input type="number" id="cols" value="2" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="gridRowGap" class="block text-sm font-medium text-gray-700">Vertical Gap (mm)</label><input type="number" id="gridRowGap" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                            <div><label for="gridColumnGap" class="block text-sm font-medium text-gray-700">Horizontal Gap (mm)</label><input type="number" id="gridColumnGap" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                        </div>
                        <div>
                            <label for="gridAlignment" class="block text-sm font-medium text-gray-700">Grid Alignment</label>
                            <select id="gridAlignment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500">
                                <option value="start start">Top Left</option>
                                <option value="start center">Top Center</option>
                                <option value="start end">Top Right</option>
                                <option value="center start">Middle Left</option>
                                <option value="center center">Center</option>
                                <option value="center end">Middle Right</option>
                                <option value="end start">Bottom Left</option>
                                <option value="end center">Bottom Center</option>
                                <option value="end end">Bottom Right</option>
                            </select>
                        </div>
                         <div><label for="startPosition" class="block text-sm font-medium text-gray-700">Start filling at Label #</label><input type="number" id="startPosition" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                         <p class="text-xs text-gray-500">Used for CSV import on partial sheets.</p>
                    </div>
                </details>
                <details class="p-4 border rounded-lg bg-gray-50 group">
                     <summary class="text-lg font-semibold cursor-pointer flex justify-between items-center">
                         <span>Label Size (mm)</span>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                     </summary>
                    <div class="mt-4 pt-4 border-t space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="labelWidth" class="block text-sm font-medium text-gray-700">Width</label><input type="number" id="labelWidth" value="80" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                            <div><label for="labelHeight" class="block text-sm font-medium text-gray-700">Height</label><input type="number" id="labelHeight" value="50" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                        </div>
                        <div class="flex items-center mt-3">
                            <input id="maximizeLayout" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                            <label for="maximizeLayout" class="ml-2 block text-sm font-medium text-gray-700">Maximize layout from label size</label>
                        </div>
                         <div class="mt-3"><label for="cornerRadius" class="block text-sm font-medium text-gray-700">Corner Radius (mm)</label><input type="number" id="cornerRadius" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                    </div>
                </details>
            </div>
            <details class="p-4 border rounded-lg bg-gray-50 group">
                <summary class="text-lg font-semibold cursor-pointer flex justify-between items-center">
                    <span>Typography & Alignment</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </summary>
                <div class="mt-4 pt-4 border-t space-y-3">
                    <div><label for="fontFamily" class="block text-sm font-medium text-gray-700">Font</label><select id="fontFamily" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="'Inter', sans-serif" selected>Inter (Sans-serif)</option><option value="'Lora', serif">Lora (Serif)</option><option value="'Merriweather', serif">Merriweather (Serif)</option><option value="'Playfair Display', serif">Playfair Display (Serif)</option><option value="'Roboto Mono', monospace">Roboto Mono (Monospace)</option><option value="Arial, sans-serif">Arial</option><option value="'Times New Roman', Times, serif">Times New Roman</option></select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="fontSize" class="block text-sm font-medium text-gray-700">Font Size (pt)</label><input type="number" id="fontSize" value="12" min="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                         <div class="flex items-end space-x-2">
                            <button id="fontBold" class="p-2 rounded-md border bg-white hover:bg-sky-100 data-[active=true]:bg-sky-500 data-[active=true]:text-white" data-active="false"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg></button>
                            <button id="fontItalic" class="p-2 rounded-md border bg-white hover:bg-sky-100 data-[active=true]:bg-sky-500 data-[active=true]:text-white" data-active="false"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg></button>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div><label for="vAlign" class="block text-sm font-medium text-gray-700">Vertical</label><select id="vAlign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="flex-start">Top</option><option value="center" selected>Middle</option><option value="flex-end">Bottom</option></select></div>
                        <div><label for="hAlign" class="block text-sm font-medium text-gray-700">Horizontal</label><select id="hAlign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="flex-start">Left</option><option value="center" selected>Center</option><option value="flex-end">Right</option></select></div>
                    </div>
                </div>
            </details>
            <details class="p-4 border rounded-lg bg-gray-50 group">
                 <summary class="text-lg font-semibold cursor-pointer flex justify-between items-center"><span>Content</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></summary>
                 <div class="mt-4 pt-4 border-t space-y-3">
                     <div>
                        <label for="csvFile" class="block text-sm font-medium text-gray-700">Import from CSV</label>
                        <p class="text-xs text-gray-500 mb-1">Each row in the CSV will populate one label.</p>
                        <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                        <div class="flex items-center mt-2">
                            <input id="csvHasHeader" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                            <label for="csvHasHeader" class="ml-2 block text-sm font-medium text-gray-700">First row is a header</label>
                        </div>
                     </div>
                     <div><label for="labelText" class="block text-sm font-medium text-gray-700">Manual Text</label><p class="text-xs text-gray-500 mb-1">Applies to all currently selected labels.</p><textarea id="labelText" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" placeholder="Enter common text here..."></textarea></div>
                 </div>
            </details>
            <div class="space-y-4 pt-4 border-t">
                <div class="grid grid-cols-2 gap-2">
                    <button id="selectAll" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Select All</button>
                    <button id="deselectAll" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Deselect All</button>
                </div>
                <button id="printButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h8a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>Print</button>
            </div>
        </div>
        <main class="flex-1 p-8 bg-gray-200 flex items-start justify-center overflow-auto"><div id="label-grid-container"><div id="label-grid"></div></div></main>
    </div>
    <div id="print-area"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const controls = {
                templateType: document.getElementById('templateType'), presets: document.getElementById('presets'),
                labelSheetControls: document.getElementById('labelSheetControls'), envelopeControls: document.getElementById('envelopeControls'),
                suspensionTabControls: document.getElementById('suspensionTabControls'), printCutLines: document.getElementById('printCutLines'),
                paperSize: document.getElementById('paperSize'), orientation: document.getElementById('orientation'),
                marginTop: document.getElementById('marginTop'), marginLeft: document.getElementById('marginLeft'),
                rows: document.getElementById('rows'), cols: document.getElementById('cols'),
                gridRowGap: document.getElementById('gridRowGap'), gridColumnGap: document.getElementById('gridColumnGap'),
                gridAlignment: document.getElementById('gridAlignment'),
                startPosition: document.getElementById('startPosition'), labelWidth: document.getElementById('labelWidth'),
                labelHeight: document.getElementById('labelHeight'), maximizeLayout: document.getElementById('maximizeLayout'), 
                cornerRadius: document.getElementById('cornerRadius'),
                envelopeWidth: document.getElementById('envelopeWidth'), envelopeHeight: document.getElementById('envelopeHeight'),
                fontFamily: document.getElementById('fontFamily'), fontSize: document.getElementById('fontSize'),
                fontBold: document.getElementById('fontBold'), fontItalic: document.getElementById('fontItalic'),
                vAlign: document.getElementById('vAlign'), hAlign: document.getElementById('hAlign'),
                labelText: document.getElementById('labelText'), csvFile: document.getElementById('csvFile'),
                csvHasHeader: document.getElementById('csvHasHeader'),
            };
            const actions = { selectAll: document.getElementById('selectAll'), deselectAll: document.getElementById('deselectAll'), printButton: document.getElementById('printButton') };
            const labelGrid = document.getElementById('label-grid');
            const root = document.documentElement;
            
            let labelData = [];
            const PRESETS = {
                labelSheet: {
                    'Avery (A4)': {
                         'avery_L7160': { name: 'L7160 (63.5x38.1mm)', paper: 'A4', rows: 7, cols: 3, width: 63.5, height: 38.1, marginTop: 15, marginLeft: 7.5, rowGap: 0, colGap: 2.5 },
                         'avery_L7163': { name: 'L7163 (99.1x38.1mm)', paper: 'A4', rows: 7, cols: 2, width: 99.1, height: 38.1, marginTop: 14.9, marginLeft: 5.4, rowGap: 0, colGap: 0 },
                    },
                    'Avery (US Letter)': {
                        'avery_5160': { name: '5160 (2.625"x1")', paper: 'Letter', rows: 10, cols: 3, width: 66.675, height: 25.4, marginTop: 12.7, marginLeft: 4.76, rowGap: 0, colGap: 3.175 },
                        'avery_5163': { name: '5163 (4"x2")', paper: 'Letter', rows: 5, cols: 2, width: 101.6, height: 50.8, marginTop: 12.7, marginLeft: 5.56, rowGap: 0, colGap: 0 },
                    },
                    'Custom...': { 'custom': { name: 'Custom...' } },
                },
                suspensionTab: {
                    'Print on...': {
                        'custom': { name: 'Custom...' },
                        'grid_a4_card': { name: 'Grid on A4 Card', paper: 'A4', orientation: 'portrait', rows: 17, cols: 3, width: 50, height: 15, marginTop: 4.5, marginLeft: 5, rowGap: 2, colGap: 2 },
                        'prepunched_a4_sheet': { name: 'Pre-punched A4 Sheet (Example)', paper: 'A4', orientation: 'portrait', rows: 10, cols: 1, width: 50, height: 15, marginTop: 23.5, marginLeft: 80, rowGap: 14.7, colGap: 0 }
                    }
                },
                envelope: {
                    'Common Sizes': {
                        'dl': { name: 'DL (220 x 110mm)', width: 220, height: 110 },
                        'c5': { name: 'C5 (229 x 162mm)', width: 229, height: 162 },
                        'us_10': { name: 'US #10 (104.8 x 241.3mm)', width: 241.3, height: 104.8 },
                        'custom': { name: 'Custom...', width: 220, height: 110 },
                    }
                }
            };
            
            const getLabelsPerPage = () => {
                if (controls.templateType.value === 'envelope') return 1;
                const rows = parseInt(controls.rows.value, 10) || 1;
                const cols = parseInt(controls.cols.value, 10) || 1;
                return rows * cols;
            };

            const renderPreview = () => {
                labelGrid.innerHTML = '';
                const labelsPerPage = getLabelsPerPage();
                const totalLabels = labelData.length > 0 ? labelData.length : labelsPerPage;
                const labelsToShow = Math.min(totalLabels, labelsPerPage);
                
                for (let i = 0; i < labelsToShow; i++) {
                    const label = document.createElement('div');
                    label.classList.add('label');
                    label.dataset.index = i;
                    label.dataset.labelNumber = i + 1;
                    label.textContent = labelData[i] || '';
                    if (label.textContent || controls.templateType.value === 'envelope') {
                        label.classList.add('selected');
                    }
                    label.addEventListener('click', () => label.classList.toggle('selected'));
                    labelGrid.appendChild(label);
                }
            };

            const updateAllStyles = () => {
                const type = controls.templateType.value;
                if (type === 'envelope') {
                    const envWidth = `${controls.envelopeWidth.value}mm`, envHeight = `${controls.envelopeHeight.value}mm`;
                    root.style.setProperty('--paper-width', envWidth); root.style.setProperty('--paper-height', envHeight);
                    root.style.setProperty('--label-width', envWidth); root.style.setProperty('--label-height', envHeight);
                    ['--margin-top','--margin-left','--grid-row-gap','--grid-column-gap','--corner-radius'].forEach(p => root.style.setProperty(p, '0mm'));
                } else {
                    const isLetter = controls.paperSize.value === 'Letter';
                    let paper = isLetter ? {w:'215.9mm',h:'279.4mm',w_val:215.9,h_val:279.4} : {w:'210mm',h:'297mm',w_val:210,h_val:297};
                    if (controls.orientation.value === 'landscape') { [paper.w, paper.h, paper.w_val, paper.h_val] = [paper.h, paper.w, paper.h_val, paper.w_val]; }
                    root.style.setProperty('--paper-width', paper.w); root.style.setProperty('--paper-height', paper.h);
                    
                    if (controls.maximizeLayout.checked) {
                        controls.rows.disabled = true;
                        controls.cols.disabled = true;
                        controls.labelWidth.disabled = false;
                        controls.labelHeight.disabled = false;

                        const availW = paper.w_val - (2 * parseFloat(controls.marginLeft.value));
                        const availH = paper.h_val - (2 * parseFloat(controls.marginTop.value));
                        const labelW = parseFloat(controls.labelWidth.value);
                        const labelH = parseFloat(controls.labelHeight.value);
                        const colGap = parseFloat(controls.gridColumnGap.value);
                        const rowGap = parseFloat(controls.gridRowGap.value);

                        if (labelW > 0 && labelH > 0) {
                            const cols = Math.floor((availW + colGap) / (labelW + colGap));
                            const rows = Math.floor((availH + rowGap) / (labelH + rowGap));
                            controls.cols.value = cols > 0 ? cols : 1;
                            controls.rows.value = rows > 0 ? rows : 1;
                        }
                        root.style.setProperty('--label-width', `${controls.labelWidth.value}mm`);
                        root.style.setProperty('--label-height', `${controls.labelHeight.value}mm`);
                    } else {
                        controls.rows.disabled = false;
                        controls.cols.disabled = false;
                        controls.labelWidth.disabled = true;
                        controls.labelHeight.disabled = true;

                        const availW = paper.w_val - (2 * parseFloat(controls.marginLeft.value)) - ((parseInt(controls.cols.value, 10) - 1) * parseFloat(controls.gridColumnGap.value));
                        const newW = availW / parseInt(controls.cols.value, 10);
                        if (newW > 0) {
                            controls.labelWidth.value = newW.toFixed(2);
                            root.style.setProperty('--label-width', `${newW}mm`);
                        }

                        const availH = paper.h_val - (2 * parseFloat(controls.marginTop.value)) - ((parseInt(controls.rows.value, 10) - 1) * parseFloat(controls.gridRowGap.value));
                        const newH = availH / parseInt(controls.rows.value, 10);
                        if (newH > 0) {
                            controls.labelHeight.value = newH.toFixed(2);
                            root.style.setProperty('--label-height', `${newH}mm`);
                        }
                    }

                    root.style.setProperty('--margin-top', `${controls.marginTop.value}mm`);
                    root.style.setProperty('--margin-left', `${controls.marginLeft.value}mm`);
                    root.style.setProperty('--grid-row-gap', `${controls.gridRowGap.value}mm`);
                    root.style.setProperty('--grid-column-gap', `${controls.gridColumnGap.value}mm`);
                    root.style.setProperty('--corner-radius', `${controls.cornerRadius.value}mm`);
                }
                const [alignContent, justifyContent] = controls.gridAlignment.value.split(' ');
                root.style.setProperty('--grid-align-content', alignContent);
                root.style.setProperty('--grid-justify-content', justifyContent);

                root.style.setProperty('--cols', controls.cols.value);
                root.style.setProperty('--font-family', controls.fontFamily.value); root.style.setProperty('--font-size', `${controls.fontSize.value}pt`);
                root.style.setProperty('--align-items', controls.vAlign.value); root.style.setProperty('--justify-content', controls.hAlign.value);
                root.style.setProperty('--font-weight', controls.fontBold.dataset.active === 'true' ? 'bold' : 'normal');
                root.style.setProperty('--font-style', controls.fontItalic.dataset.active === 'true' ? 'italic' : 'normal');
                renderPreview();
            };

            const applyPreset = (key) => {
                const type = controls.templateType.value; if (!key || key === 'custom') { if (type === 'envelope') { controls.envelopeWidth.disabled = false; controls.envelopeHeight.disabled = false; } return; }
                if (type === 'labelSheet' || type === 'suspensionTab') {
                    let p; for (const group in PRESETS[type]) { if (PRESETS[type][group][key]) { p = PRESETS[type][group][key]; break; } } if (!p) return;
                    controls.paperSize.value = p.paper; controls.orientation.value = p.orientation || 'portrait';
                    controls.rows.value = p.rows; controls.cols.value = p.cols;
                    controls.labelWidth.value = p.width; controls.labelHeight.value = p.height;
                    controls.marginTop.value = p.marginTop; controls.marginLeft.value = p.marginLeft;
                    controls.gridRowGap.value = p.rowGap; controls.gridColumnGap.value = p.colGap;
                } else if (type === 'envelope') {
                    const p = PRESETS.envelope['Common Sizes'][key]; if (!p) return;
                    controls.envelopeWidth.value = p.width; controls.envelopeHeight.value = p.height;
                    controls.envelopeWidth.disabled = true; controls.envelopeHeight.disabled = true;
                }
                updateAllStyles();
            };
            
            const handleCsvUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    let csvRows = event.target.result.split('\n').filter(row => row.trim() !== '').map(r => r.trim().replace(/^"|"$/g, ''));
                    if (controls.csvHasHeader.checked) {
                        csvRows.shift();
                    }
                    const startIndex = Math.max(0, parseInt(controls.startPosition.value, 10) - 1);
                    const padding = Array(startIndex).fill('');
                    labelData = padding.concat(csvRows);
                    updateAllStyles();
                };
                reader.readAsText(file);
                e.target.value = '';
            };
            
            const toggleModeControls = () => {
                const type = controls.templateType.value;
                controls.envelopeControls.classList.toggle('hidden', type !== 'envelope');
                controls.suspensionTabControls.classList.toggle('hidden', type !== 'suspensionTab');
                controls.labelSheetControls.classList.toggle('hidden', type === 'envelope');
            };
            
            controls.templateType.addEventListener('input', () => {
                labelData = [];
                toggleModeControls(); 
                populatePresets(); 
                applyPreset(controls.presets.value);

                const type = controls.templateType.value;
                if (type === 'suspensionTab') {
                    controls.labelWidth.value = 54;
                    controls.labelHeight.value = 14;
                    controls.maximizeLayout.checked = false;
                    controls.presets.value = 'custom';
                }
                
                updateAllStyles();

                if (type === 'suspensionTab' || type === 'envelope') {
                    const firstLabel = document.querySelector('.label');
                    if (firstLabel) firstLabel.classList.add('selected');
                }
            });

            controls.presets.addEventListener('input', (e) => { labelData = []; applyPreset(e.target.value); });
            Object.values(controls).forEach(c => {
                const nonStandard = ['templateType','presets','csvFile','csvHasHeader','labelText','fontBold','fontItalic','labelSheetControls','envelopeControls','suspensionTabControls','printCutLines', 'maximizeLayout'];
                if (!c.id || nonStandard.includes(c.id)) return;
                c.addEventListener('input', () => { controls.presets.value = 'custom'; if (controls.templateType.value === 'envelope') { controls.envelopeWidth.disabled = false; controls.envelopeHeight.disabled = false; } labelData = []; updateAllStyles(); });
            });
            controls.maximizeLayout.addEventListener('input', updateAllStyles);
            controls.labelText.addEventListener('input', () => document.querySelectorAll('.label.selected').forEach(l => { const idx = parseInt(l.dataset.index, 10); if(labelData[idx] !== undefined) labelData[idx] = controls.labelText.value; l.textContent = controls.labelText.value; }));
            controls.fontBold.addEventListener('click', () => { controls.fontBold.dataset.active = !(controls.fontBold.dataset.active === 'true'); updateAllStyles(); });
            controls.fontItalic.addEventListener('click', () => { controls.fontItalic.dataset.active = !(controls.fontItalic.dataset.active === 'true'); updateAllStyles(); });
            controls.csvFile.addEventListener('change', handleCsvUpload);
            actions.selectAll.addEventListener('click', () => document.querySelectorAll('.label').forEach(l => l.classList.add('selected')));
            actions.deselectAll.addEventListener('click', () => document.querySelectorAll('.label').forEach(l => l.classList.remove('selected')));
            
            actions.printButton.addEventListener('click', () => {
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = '';
                printArea.className = (controls.templateType.value === 'suspensionTab' && controls.printCutLines.checked) ? 'print-borders-on' : '';
                
                let dataToPrint = labelData.length > 0 ? labelData : Array.from(document.querySelectorAll('.label.selected')).map(l => l.textContent);

                if (dataToPrint.length === 0) {
                     alert("There is no data to print. Import a CSV or enter text into a selected label.");
                     return;
                }

                const labelsPerPage = getLabelsPerPage();
                const totalPages = Math.ceil(dataToPrint.length / labelsPerPage);

                for (let i = 0; i < totalPages; i++) {
                    const page = document.createElement('div');
                    page.className = 'print-page';
                    
                    const pageData = dataToPrint.slice(i * labelsPerPage, (i + 1) * labelsPerPage);
                    
                    for (let j = 0; j < labelsPerPage; j++) {
                        const content = pageData[j];
                        const printLabel = document.createElement('div');
                        printLabel.className = 'label print-label';
                        if (content !== undefined && content.trim() !== '') {
                            printLabel.textContent = content;
                            printLabel.classList.add('has-content');
                        } else {
                            printLabel.classList.add('not-selected');
                        }
                        page.appendChild(printLabel);
                    }
                    printArea.appendChild(page);
                }
                window.print();
            });

            function populatePresets() {
                const type = controls.templateType.value; const presetList = PRESETS[type]; controls.presets.innerHTML = '';
                for (const group in presetList) {
                    const optgroup = document.createElement('optgroup'); optgroup.label = group;
                    for (const [key, value] of Object.entries(presetList[group])) { const o = document.createElement('option'); o.value = key; o.textContent = value.name; optgroup.appendChild(o); }
                    controls.presets.appendChild(optgroup);
                }
            }
            toggleModeControls(); populatePresets(); applyPreset('avery_L7163');
        });
    </script>
</body>
</html>
}