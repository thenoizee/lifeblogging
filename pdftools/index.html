<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools - Lifeblogging Hub</title>
    <link rel="icon" href="/favicons/pen-to-square.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&family=Cedarville+Cursive&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json" />
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker registered successfully:', registration))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
    </script>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg-color: white;
            --text-color-primary: #111827;
            --text-color-secondary: #4b5563;
            --input-bg-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        .dark {
            --bg-color: #111827;
            --card-bg-color: #1f2937;
            --text-color-primary: #f9fafb;
            --text-color-secondary: #9ca3af;
            --input-bg-color: #374151;
            --border-color: #4b5563;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color-primary); transition: background-color 0.3s, color 0.3s; }
        .nav-btn.active { color: #6366f1; background-color: #eef2ff; }
        .dark .nav-btn.active { background-color: #374151; color: #f9fafb; }
        .drop-zone { border: 2px dashed var(--border-color); transition: background-color 0.2s, border-color 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem; border-radius: 0.5rem; text-align: center; cursor: pointer; }
        .drop-zone.drag-over { background-color: #eef2ff; border-color: #6366f1; }
        .dark .drop-zone.drag-over { background-color: #374151; }
        .loader { border: 4px solid var(--border-color); border-top-color: #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .download-link, .download-zip-link { display: none; width: 100%; margin-top: 1rem; background-color: #16a34a; color: white; text-align: center; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s; }
        .download-link:hover, .download-zip-link:hover { background-color: #15803d; }
        .download-link.show, .download-zip-link.show { display: block; }
        .page-thumbnail { cursor: grab; position: relative; border: 1px solid var(--border-color); border-radius: 0.25rem; overflow: hidden; background: var(--input-bg-color); }
        .page-actions { position: absolute; top: 4px; right: 4px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; background-color: rgba(0,0,0,0.5); padding: 4px; border-radius: 5px;}
        .page-thumbnail:hover .page-actions { opacity: 1; }
        .page-thumbnail .page-number { position: absolute; bottom: 4px; left: 4px; background-color: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px;}
        .page-thumbnail.ghost { opacity: 0.5; background: #c8ebfb; }
        .page-thumbnail.deleted { opacity: 0.4; }
        .page-thumbnail.deleted::after { content: 'DELETED'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.7); color: white; font-weight: bold; }
        .file-item { cursor: grab; display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background-color: var(--input-bg-color); border: 1px solid var(--border-color); border-radius: 0.375rem; }
        #signature-pad { border: 1px solid var(--border-color); cursor: crosshair; }
        .preview-container { position: relative; border: 1px solid var(--border-color); overflow: auto; max-height: 60vh;}
        .draggable { position: absolute; cursor: move; border: 1px dashed #6366f1; background-color: rgba(99, 102, 241, 0.1); }
        .draggable.text-element { border: 1px dashed #f59e0b; background-color: rgba(245, 158, 11, 0.1); }
        .draggable.redact-element { border: 1px solid black; background-color: black; }
        .resizable-handle { position: absolute; width: 10px; height: 10px; background: #6366f1; border: 1px solid white; }
        .handle-se { bottom: -5px; right: -5px; cursor: se-resize; }
        .sig-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .sig-tab.active-tab { color: #6366f1; border-color: #6366f1; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold flex items-center"><i class="fas fa-file-pdf mr-3 text-red-500"></i>PDF Tools</h1>
            <div class="flex items-center gap-4">
                <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
                <button id="theme-toggle" class="bg-[var(--card-bg-color)] border border-[var(--border-color)] rounded-full p-2" title="Toggle dark mode"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="bg-[var(--card-bg-color)] shadow-lg rounded-xl md:flex">
             <aside class="w-full md:w-64 border-b md:border-b-0 md:border-r border-[var(--border-color)] p-4">
                <nav class="flex flex-row overflow-x-auto md:flex-col gap-2">
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Organize</h3>
                    <button data-panel="organize" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-sitemap w-6 mr-2"></i>Organize</button>
                    <button data-panel="merge" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-compress-alt w-6 mr-2"></i>Merge</button>
                    
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Edit & Sign</h3>
                     <button data-panel="sign" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-signature w-6 mr-2"></i>Sign PDF</button>
                     <button data-panel="addtext" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-font w-6 mr-2"></i>Add Text</button>
                     <button data-panel="redact" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-user-secret w-6 mr-2"></i>Redact</button>
                     <button data-panel="watermark" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-copyright w-6 mr-2"></i>Watermark</button>
                     <button data-panel="pagenumbers" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-sort-numeric-down w-6 mr-2"></i>Page Numbers</button>
                    
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Split & Extract</h3>
                     <button data-panel="extract" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-file-export w-6 mr-2"></i>Extract Pages</button>
                    <button data-panel="splithalf" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-columns w-6 mr-2"></i>Split Page in Half</button>
                    <button data-panel="recreate" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-book-open w-6 mr-2"></i>Re-create Book</button>
                    
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Convert & Finalize</h3>
                    <button data-panel="pdftoimages" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-file-image w-6 mr-2"></i>PDF to Images</button>
                    <button data-panel="images" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-images w-6 mr-2"></i>Images to PDF</button>
                    <button data-panel="flatten" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-layer-group w-6 mr-2"></i>Flatten PDF</button>
                    <button data-panel="protect" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-lock w-6 mr-2"></i>Protect PDF</button>
                    <button data-panel="unlock" class="nav-btn w-full text-left p-3 rounded-lg font-medium active flex-shrink-0"><i class="fas fa-unlock-alt w-6 mr-2"></i>Unlock</button>
                </nav>
            </aside>

            <main class="w-full p-6 md:p-8">
                <div id="panel-organize" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Organize PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Visually reorder, rotate, and delete pages from your PDF.</p>
                    <div id="organize-tool" class="tool-container">
                        <div class="drop-zone" data-tool="organize"><i class="fas fa-sitemap text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div id="organize-pages-grid" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                        <button class="action-btn hidden w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg"><span class="btn-text">Save Changes</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div>
                        <a class="download-link">Download Organized PDF</a>
                    </div>
                </div>
                <div id="panel-merge" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Merge PDFs</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Combine multiple PDFs into one. Drag and drop to reorder files.</p>
                    <div id="merge-tool" class="tool-container">
                       <div class="drop-zone" data-tool="merge"><i class="fas fa-compress-alt text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDFs here</p><p class="text-sm text-[var(--text-color-secondary)]">or click to select files</p><input type="file" class="file-input hidden" accept=".pdf" multiple></div>
                       <div id="merge-file-list" class="mt-4 space-y-2"></div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition" disabled><span class="btn-text">Merge PDFs</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Merged PDF</a>
                   </div>
                </div>
                <div id="panel-sign" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Sign PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Draw, type, or upload your signature to place on the document.</p>
                    <div id="sign-tool" class="tool-container">
                        <div class="drop-zone" data-tool="sign"><i class="fas fa-signature text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="editor-view hidden mt-4">
                            <div class="preview-container"><canvas id="sign-canvas-preview"></canvas></div>
                            <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                <div class="flex items-center gap-2"><button id="sign-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="sign-page-indicator">Page 1 / 1</span><button id="sign-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                <button id="add-signature-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Add Signature</button>
                            </div>
                        </div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Signatures & Save</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Signed PDF</a>
                    </div>
                </div>
                <div id="panel-addtext" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Add Text</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Add custom text boxes to your PDF pages.</p>
                    <div id="addtext-tool" class="tool-container">
                         <div class="drop-zone" data-tool="addtext"><i class="fas fa-font text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="editor-view hidden mt-4">
                             <div class="preview-container"><canvas id="addtext-canvas-preview"></canvas></div>
                             <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                 <div class="flex items-center gap-2"><button id="addtext-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="addtext-page-indicator">Page 1 / 1</span><button id="addtext-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                 <button id="add-textbox-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Add Text Box</button>
                             </div>
                         </div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Text & Save</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Updated PDF</a>
                    </div>
                </div>
                <div id="panel-redact" class="tab-panel hidden">
                     <h2 class="text-xl font-bold mb-2">Redact PDF</h2>
                     <p class="text-[var(--text-color-secondary)] mb-4">Draw black boxes to permanently hide sensitive information.</p>
                     <div id="redact-tool" class="tool-container">
                         <div class="drop-zone" data-tool="redact"><i class="fas fa-user-secret text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="editor-view hidden mt-4">
                             <div class="preview-container"><canvas id="redact-canvas-preview"></canvas></div>
                             <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                 <div class="flex items-center gap-2"><button id="redact-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="redact-page-indicator">Page 1 / 1</span><button id="redact-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                 <button id="add-redaction-btn" class="bg-black text-white font-bold py-2 px-4 rounded-lg">Add Redaction Box</button>
                             </div>
                         </div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Redactions & Save</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Redacted PDF</a>
                     </div>
                </div>
                <div id="panel-watermark" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Add Watermark</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Add text watermark to all pages of your PDF.</p>
                    <div id="watermark-tool" class="tool-container">
                        <div class="drop-zone" data-tool="watermark"><i class="fas fa-copyright text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span></p>
                           <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="block font-medium">Text:</label><input type="text" value="CONFIDENTIAL" class="watermark-text w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Font Size:</label><input type="number" value="72" class="watermark-size w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Rotation (degrees):</label><input type="number" value="-45" class="watermark-rotation w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Opacity (0-1):</label><input type="number" value="0.5" step="0.1" min="0" max="1" class="watermark-opacity w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Add Watermark</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Watermarked PDF</a>
                    </div>
                </div>
                <div id="panel-pagenumbers" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Add Page Numbers</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Add page numbers to your document with various options.</p>
                     <div id="pagenumbers-tool" class="tool-container">
                        <div class="drop-zone" data-tool="pagenumbers"><i class="fas fa-sort-numeric-down text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span></p>
                           <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="block font-medium">Position:</label><select class="pagenum-position w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"><option value="bottom-center">Bottom Center</option><option value="bottom-left">Bottom Left</option><option value="bottom-right">Bottom Right</option><option value="top-center">Top Center</option><option value="top-left">Top Left</option><option value="top-right">Top Right</option></select></div>
                               <div><label class="block font-medium">Font Size:</label><input type="number" value="12" class="pagenum-size w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Starting Number:</label><input type="number" value="1" class="pagenum-start w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Add Page Numbers</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Numbered PDF</a>
                    </div>
                </div>
                <div id="panel-extract" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Extract Pages</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Create a new PDF from a range of pages. Use ranges (e.g., 2-5), single pages (e.g., 7), or a combination (e.g., 1, 3-4, 9).</p>
                    <div id="extract-tool" class="tool-container">
                        <div class="drop-zone" data-tool="extract"><i class="fas fa-file-export text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span> (<span class="page-count"></span> pages)</p>
                            <div class="mt-2"><label class="block font-medium">Pages to extract:</label><input type="text" placeholder="e.g., 1, 3-5, 8" class="extract-pages w-full mt-1 p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Extract Pages</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Extracted PDF</a>
                   </div>
                </div>
                <div id="panel-splithalf" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Split Page in Half</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Splits each landscape page into two portrait pages. Useful for scanned single sheets.</p>
                    <div id="splithalf-tool" class="tool-container">
                        <div class="drop-zone" data-tool="splithalf"><i class="fas fa-columns text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Split Pages</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Split PDF</a>
                    </div>
                </div>
                <div id="panel-recreate" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Re-create Scanned Book</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Fixes books scanned as double-page spreads by splitting and re-ordering them correctly.</p>
                     <div class="text-sm bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-4 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-600">
                        <p><strong>How it works:</strong> Assumes a booklet format. For a 20-page book, the first scan has page 20 (left) and page 1 (right), the second has page 2 (left) and 19 (right), etc.</p>
                    </div>
                    <div id="recreate-tool" class="tool-container">
                        <div class="drop-zone" data-tool="recreate"><i class="fas fa-book-open text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop scanned PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Re-create Book</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Corrected Book</a>
                    </div>
                </div>
                <div id="panel-pdftoimages" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">PDF to Images</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Convert each page of a PDF to an image.</p>
                     <div id="pdftoimages-tool" class="tool-container">
                         <div class="drop-zone" data-tool="pdftoimages"><i class="fas fa-file-image text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span></p>
                           <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="block font-medium">Image Format:</label><select class="pdftoimages-format w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"><option value="image/png">PNG</option><option value="image/jpeg">JPG</option></select></div>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Convert to Images</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div>
                       <div id="pdftoimages-links" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                    </div>
                </div>
                <div id="panel-images" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Images to PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Convert JPG, PNG images to a single PDF. Drag to reorder.</p>
                     <div id="images-tool" class="tool-container">
                        <div class="drop-zone" data-tool="images"><i class="fas fa-images text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop Images here</p><input type="file" class="file-input hidden" accept="image/jpeg, image/png" multiple></div>
                        <div id="images-file-list" class="mt-4 space-y-2"></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Convert to PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download PDF</a>
                    </div>
                </div>
                <div id="panel-flatten" class="tab-panel hidden">
                     <h2 class="text-xl font-bold mb-2">Flatten PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Merge all annotations, form fields, and layers into a single, non-editable layer.</p>
                     <div id="flatten-tool" class="tool-container">
                         <div class="drop-zone" data-tool="flatten"><i class="fas fa-layer-group text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Flatten PDF</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Flattened PDF</a>
                     </div>
                </div>
                <div id="panel-protect" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Protect PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Encrypt and add a password to a PDF file.</p>
                    <div id="protect-tool" class="tool-container">
                        <div class="drop-zone" data-tool="protect"><i class="fas fa-lock text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                            <p class="font-bold">File: <span class="file-name"></span></p>
                            <div class="mt-2 grid sm:grid-cols-2 gap-4">
                                <div><label class="block font-medium">New Password:</label><input type="password" class="protect-password w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                                <div><label class="block font-medium">Confirm Password:</label><input type="password" class="protect-confirm-password w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                            </div>
                        </div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Protect PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Protected PDF</a>
                    </div>
                </div>
                <div id="panel-unlock" class="tab-panel">
                     <h2 class="text-xl font-bold mb-2">Unlock PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Remove password restrictions from a PDF. Files are processed in your browser.</p>
                     <div class="text-sm bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-4 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-600">
                        <p class="font-bold"><i class="fas fa-info-circle mr-2"></i>Having Trouble Unlocking?</p>
                        <p class="mt-1">If you're sure the password is correct, the PDF file itself might be slightly corrupted. You can fix this by "refreshing" it: Open it in Chrome or another PDF viewer, choose <strong>Print</strong>, and then <strong>Save as PDF</strong> to create a clean, working copy.</p>
                    </div>
                    <div id="unlock-tool" class="tool-container">
                        <div class="drop-zone" data-tool="unlock"><i class="fas fa-file-upload text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><p class="text-sm text-[var(--text-color-secondary)]">or click to select file</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                            <p class="font-bold">File: <span class="file-name"></span></p>
                            <div class="mt-2"><label class="block font-medium">Password (if any):</label><input type="password" class="unlock-password w-full mt-1 p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                        </div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition" disabled><span class="btn-text">Unlock PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Unlocked PDF</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="signature-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-[var(--card-bg-color)] rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4">Create Signature</h3>
            <div class="border-b border-[var(--border-color)] mb-4">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs"><button class="sig-tab active-tab" data-tab="draw">Draw</button><button class="sig-tab" data-tab="type">Type</button><button class="sig-tab" data-tab="upload">Upload</button></nav>
            </div>
            <div id="sig-tab-draw" class="sig-tab-content"><canvas id="signature-pad" width="400" height="200" class="bg-white rounded-md"></canvas></div>
            <div id="sig-tab-type" class="sig-tab-content hidden"><input type="text" id="sig-text-input" class="w-full p-2 border border-[var(--border-color)] rounded-md" placeholder="Type your name"><div id="sig-text-preview" class="mt-2 p-4 text-center text-3xl" style="font-family: 'Cedarville Cursive', cursive;"></div></div>
            <div id="sig-tab-upload" class="sig-tab-content hidden"><input type="file" id="sig-upload-input" accept="image/png, image/jpeg" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/></div>
            <div class="mt-4 flex justify-between">
                <button id="clear-signature" class="px-4 py-2 border rounded-md">Clear</button>
                <div><button id="cancel-signature" class="px-4 py-2 border rounded-md mr-2">Cancel</button><button id="save-signature" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save Signature</button></div>
            </div>
        </div>
    </div>


    <script type="module">
        const { PDFDocument, rgb, degrees, StandardFonts, PageSizes } = PDFLib;

        // --- THEME LOGIC ---
        const themeToggle = document.getElementById('theme-toggle');
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        };
        themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
        applyTheme(localStorage.getItem('theme') || 'light');

        // --- NAVIGATION LOGIC ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const panels = document.querySelectorAll('.tab-panel');
        const setActivePanel = (panelId) => {
             navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.panel === panelId));
             panels.forEach(panel => panel.classList.toggle('hidden', panel.id !== `panel-${panelId}`));
             // Reset all tools when switching
             Object.values(toolState).forEach(state => {
                 if(state && state.toolElement) resetTool(state.toolElement);
             });
        };
        navButtons.forEach(button => button.addEventListener('click', () => setActivePanel(button.dataset.panel)));
        
        // --- GLOBAL STATE & HELPERS ---
        const toolState = {};
        const showStatus = (tool, message, isError = false) => {
            const el = tool.querySelector('.status-text');
            if(!el) return;
            el.textContent = message;
            el.className = `status-text mt-4 text-center ${isError ? 'text-red-500' : 'text-green-600'}`;
        };
        const toggleButtonLoading = (tool, isLoading) => {
            const btn = tool.querySelector('.action-btn');
            if (!btn) return;
            btn.disabled = isLoading;
            btn.querySelector('.btn-text')?.classList.toggle('hidden', isLoading);
            btn.querySelector('.loader')?.classList.toggle('hidden', !isLoading);
        };
        const createDownloadLink = (tool, bytes, fileName) => {
            const link = tool.querySelector('.download-link');
            const blob = new Blob([bytes], { type: 'application/pdf' });
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.classList.add('show');
        };
         const parsePageRanges = (rangeStr, maxPage) => {
            const indices = new Set();
            if (!rangeStr || rangeStr.trim() === '' || rangeStr.trim() === '*') {
                for (let i = 0; i < maxPage; i++) indices.add(i);
                return Array.from(indices);
            }
            const parts = rangeStr.split(',');
            for (const part of parts) {
                const trimmedPart = part.trim();
                if (trimmedPart.includes('-')) {
                    let [start, end] = trimmedPart.split('-').map(p => parseInt(p.trim(), 10));
                    if (!isNaN(start) && !isNaN(end) && start <= end) {
                        for (let i = start; i <= end; i++) {
                             if (i > 0 && i <= maxPage) indices.add(i - 1);
                        }
                    }
                } else {
                    const pageNum = parseInt(trimmedPart, 10);
                    if (!isNaN(pageNum) && pageNum > 0 && pageNum <= maxPage) indices.add(pageNum - 1);
                }
            }
            return Array.from(indices).sort((a, b) => a - b);
        };
        const resetTool = (tool) => {
            if (!tool) return;
            tool.querySelector('.drop-zone')?.classList.remove('hidden');
            const fileInfo = tool.querySelector('.file-info');
            if(fileInfo) fileInfo.classList.add('hidden');
            const dlLink = tool.querySelector('.download-link');
            if(dlLink) dlLink.classList.remove('show');
            const statusText = tool.querySelector('.status-text');
            if(statusText) statusText.textContent = '';
            const actionBtn = tool.querySelector('.action-btn');
            if(actionBtn) actionBtn.disabled = true;

            const editorView = tool.querySelector('.editor-view');
            if(editorView) editorView.classList.add('hidden');
            
            // Specific resets
            const toolId = tool.id.replace('-tool', '');
            if(toolState[toolId]) toolState[toolId] = { files: [], toolElement: tool };
            if(toolId === 'organize'){
                const grid = tool.querySelector('#organize-pages-grid');
                if(grid) {
                    grid.innerHTML = '';
                    grid.classList.add('hidden');
                }
                if(actionBtn) actionBtn.classList.add('hidden');
            }
            const fileList = tool.querySelector('#merge-file-list, #images-file-list');
            if (fileList) fileList.innerHTML = '';
            const imageLinks = tool.querySelector('#pdftoimages-links');
            if (imageLinks) imageLinks.innerHTML = '';
        };

        // --- GENERIC TOOL SETUP ---
        const setupSimpleTool = (toolId, options = {}) => {
            const tool = document.getElementById(`${toolId}-tool`);
            if(!tool) return;
            toolState[toolId] = { files: [], toolElement: tool };

            const dropZone = tool.querySelector('.drop-zone');
            const fileInput = tool.querySelector('.file-input');
            const actionBtn = tool.querySelector('.action-btn');

            const handleFiles = async (files) => {
                if (files.length === 0) return;
                toolState[toolId].files = options.multiFile ? [...(toolState[toolId].files || []), ...Array.from(files)] : Array.from(files);
                
                if(actionBtn) actionBtn.disabled = false;
                const fileInfo = tool.querySelector('.file-info');
                if (fileInfo) {
                    fileInfo.classList.remove('hidden');
                    fileInfo.querySelector('.file-name').textContent = toolState[toolId].files.length > 1 ? `${toolState[toolId].files.length} files selected` : toolState[toolId].files[0].name;
                    
                    if (toolId !== 'unlock' && (fileInfo.querySelector('.page-count') || fileInfo.querySelector('.page-dims'))) {
                         try {
                            const arrayBuffer = await toolState[toolId].files[0].arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                            if (fileInfo.querySelector('.page-count')) fileInfo.querySelector('.page-count').textContent = pdfDoc.getPageCount();
                            if (fileInfo.querySelector('.page-dims')) {
                                const {width, height} = pdfDoc.getPage(0).getSize();
                                fileInfo.querySelector('.page-dims').textContent = `${width.toFixed(2)} x ${height.toFixed(2)} pts`;
                            }
                        } catch (e) {
                             if (fileInfo.querySelector('.page-count')) fileInfo.querySelector('.page-count').textContent = 'N/A';
                             if (fileInfo.querySelector('.page-dims')) fileInfo.querySelector('.page-dims').textContent = 'N/A';
                             console.warn(`Could not read PDF metadata for ${toolId}: ${e.message}`);
                        }
                    }
                }
                
                if (options.multiFile) {
                    renderMultiFileList(toolId);
                }
            };
            
            const renderMultiFileList = (toolIdToList) => {
                const listContainer = tool.querySelector(`#${toolIdToList}-file-list`);
                if (!listContainer) return;
                listContainer.innerHTML = '';
                toolState[toolIdToList].files.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    item.dataset.index = index;
                    item.innerHTML = `<span><i class="fas fa-grip-vertical mr-2 text-gray-400"></i>${file.name}</span><button class="remove-file text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>`;
                    listContainer.appendChild(item);
                });
                if (listContainer && !listContainer.sortable) {
                    listContainer.sortable = Sortable.create(listContainer, { handle: '.fa-grip-vertical', animation: 150, onEnd: onSortEnd });
                }
            };

            const onSortEnd = (evt) => {
                const { oldIndex, newIndex } = evt;
                const files = toolState[toolId].files;
                const [movedItem] = files.splice(oldIndex, 1);
                files.splice(newIndex, 0, movedItem);
            };

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            
            const listContainer = tool.querySelector(`#${toolId}-file-list`);
            if (listContainer) {
                listContainer.addEventListener('click', e => {
                    if (e.target.closest('.remove-file')) {
                        const item = e.target.closest('.file-item');
                        const index = Array.from(item.parentNode.children).indexOf(item);
                        toolState[toolId].files.splice(index, 1);
                        item.remove();
                        if (toolState[toolId].files.length === 0 && actionBtn) actionBtn.disabled = true;
                    }
                });
            }
        };

        const setupEditorTool = (toolId, onAddElement) => {
            const tool = document.getElementById(`${toolId}-tool`);
            if(!tool) return;
            toolState[toolId] = { files: [], toolElement: tool, currentPage: 1, elements: [] };
            
            const dropZone = tool.querySelector('.drop-zone');
            const fileInput = tool.querySelector('.file-input');
            const actionBtn = tool.querySelector('.action-btn');
            const editorView = tool.querySelector('.editor-view');
            const previewContainer = tool.querySelector('.preview-container');
            const canvas = tool.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const renderPage = async (pageNum) => {
                const pdfJS = toolState[toolId].pdfJSDoc;
                if (!pdfJS || pageNum < 1 || pageNum > pdfJS.numPages) return;
                toolState[toolId].currentPage = pageNum;
                tool.querySelector(`#${toolId}-page-indicator`).textContent = `Page ${pageNum} / ${pdfJS.numPages}`;
                
                const page = await pdfJS.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                previewContainer.style.height = `${canvas.height}px`;
                await page.render({ canvasContext: ctx, viewport }).promise;
                drawElementsForPage(pageNum);
            };

            const drawElementsForPage = (pageNum) => {
                // Remove existing DOM elements first
                previewContainer.querySelectorAll('.draggable').forEach(el => el.remove());
                toolState[toolId].elements.filter(el => el.page === pageNum).forEach(el => {
                    previewContainer.appendChild(el.domElement);
                });
            };

            const handleFile = async (file) => {
                if(!file) return;
                toolState[toolId].files = [file];
                dropZone.classList.add('hidden');
                editorView.classList.remove('hidden');
                if(actionBtn) actionBtn.disabled = false;
                showStatus(tool, 'Loading PDF...');
                const arrayBuffer = await file.arrayBuffer();
                toolState[toolId].pdfBytes = arrayBuffer;
                const pdfJS = await pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)}).promise;
                toolState[toolId].pdfJSDoc = pdfJS;
                await renderPage(1);
                showStatus(tool, 'PDF loaded.');
            };

            const prevPageBtn = tool.querySelector(`#${toolId}-prev-page`);
            const nextPageBtn = tool.querySelector(`#${toolId}-next-page`);

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => renderPage(toolState[toolId].currentPage - 1));
            }
            if(nextPageBtn) {
                nextPageBtn.addEventListener('click', () => renderPage(toolState[toolId].currentPage + 1));
            }
            
            if (onAddElement) {
                const addButton = tool.querySelector(`#add-${toolId.replace('add', '')}-btn`) || tool.querySelector(`#add-signature-btn`) || tool.querySelector(`#add-textbox-btn`) || tool.querySelector(`#add-redaction-btn`);
                if(addButton) {
                    addButton.addEventListener('click', () => onAddElement(tool, previewContainer));
                }
            }

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
        };
        
        // --- TOOL-SPECIFIC LOGIC ---
        const setupAllTools = () => {
            setupOrganizeTool();
            setupSimpleTool('unlock');
            setupSimpleTool('protect');
            setupSimpleTool('extract');
            setupSimpleTool('splithalf');
            setupSimpleTool('recreate');
            setupSimpleTool('merge', { multiFile: true });
            setupSimpleTool('images', { multiFile: true });
            setupSimpleTool('watermark');
            setupSimpleTool('pagenumbers');
            setupSimpleTool('pdftoimages');
            setupSimpleTool('flatten');
            
            setupEditorTool('sign', onAddSignature);
            setupEditorTool('addtext', onAddTextBox);
            setupEditorTool('redact', onAddRedactionBox);

            document.querySelectorAll('.action-btn').forEach(btn => {
                const toolId = btn.closest('.tool-container').id.replace('-tool', '');
                const handlerName = `handle${toolId.charAt(0).toUpperCase() + toolId.slice(1)}`;
                const handler = window[handlerName];
                if(handler) {
                    btn.addEventListener('click', handler);
                }
            });
        };
        
        const setupOrganizeTool = () => { /* ... Full implementation from previous step ... */ };
        window.handleOrganize = async () => { /* ... Full implementation from previous step ... */ };
        
        window.handleUnlock = async () => {
            const tool = document.getElementById('unlock-tool');
            toggleButtonLoading(tool, true);
            showStatus(tool, 'Unlocking PDF...');
            try {
                const file = toolState.unlock.files[0];
                const password = tool.querySelector('.unlock-password').value;
                const existingPdfBytes = await file.arrayBuffer();

                // Load the original document with the provided password.
                const pdfDoc = await PDFDocument.load(existingPdfBytes, { password });

                // Create a new document to copy the pages to. This is the most reliable
                // way to remove all forms of encryption and restrictions.
                const newPdfDoc = await PDFDocument.create();
                const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                copiedPages.forEach(page => newPdfDoc.addPage(page));

                // Save the new, unlocked document.
                const bytes = await newPdfDoc.save();

                createDownloadLink(tool, bytes, `unlocked_${file.name}`);
                showStatus(tool, 'PDF unlocked successfully!');
            } catch (e) {
                const msg = e.message.toLowerCase();
                if (msg.includes('password') || msg.includes('encrypted')) {
                     showStatus(tool, 'Incorrect password. If you are sure it is correct, the file may be corrupted. See the tip above.', true);
                } else if (msg.includes('parse')) {
                     showStatus(tool, 'Could not read the PDF file. It might be corrupted. Try the "Save as PDF" trick mentioned in the tip above.', true);
                } else {
                    showStatus(tool, `An error occurred: ${e.message}`, true);
                }
            } finally {
                toggleButtonLoading(tool, false);
            }
        };

        window.handleProtect = async () => {
            const tool = document.getElementById('protect-tool');
            const password = tool.querySelector('.protect-password').value;
            const confirm = tool.querySelector('.protect-confirm-password').value;
            if(password !== confirm || !password){
                showStatus(tool, 'Passwords do not match or are empty.', true);
                return;
            }
            toggleButtonLoading(tool, true); showStatus(tool, 'Protecting PDF...');
            try {
                const file = toolState.protect.files[0];
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                const bytes = await pdfDoc.save({ userPassword: password });
                createDownloadLink(tool, bytes, `protected_${file.name}`);
                showStatus(tool, 'PDF protected successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handleMerge = async () => {
            const tool = document.getElementById('merge-tool');
            toggleButtonLoading(tool, true); showStatus(tool, 'Merging PDFs...');
            try {
                const newPdfDoc = await PDFDocument.create();
                for(const file of toolState.merge.files){
                    const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                    const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => newPdfDoc.addPage(page));
                }
                const bytes = await newPdfDoc.save();
                createDownloadLink(tool, bytes, 'merged.pdf');
                showStatus(tool, 'PDFs merged successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handleImages = async () => {
             const tool = document.getElementById('images-tool');
            toggleButtonLoading(tool, true); showStatus(tool, 'Converting images to PDF...');
            try {
                const newPdfDoc = await PDFDocument.create();
                for (const file of toolState.images.files) {
                    const bytes = await file.arrayBuffer();
                    const image = await (file.type === 'image/png' ? newPdfDoc.embedPng(bytes) : newPdfDoc.embedJpg(bytes));
                    const page = newPdfDoc.addPage([image.width, image.height]);
                    page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                }
                const pdfBytes = await newPdfDoc.save();
                createDownloadLink(tool, pdfBytes, 'converted_images.pdf');
                showStatus(tool, 'Images converted successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handleRecreate = async () => {
            const tool = document.getElementById('recreate-tool');
            toggleButtonLoading(tool, true); showStatus(tool, 'Re-creating book...');
            try {
                const file = toolState.recreate.files[0];
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                const newPdfDoc = await PDFDocument.create();
                const pageCount = pdfDoc.getPageCount();
                const reorderedIndices = [];
                for (let i = 0; i < pageCount / 2; i++) {
                    reorderedIndices.push(i * 2 + 1); // Right side
                    reorderedIndices.push((pageCount - 1 - i) * 2); // Left side from end
                }
                for (const index of reorderedIndices) {
                    const [copiedPage] = await newPdfDoc.copyPages(pdfDoc, [Math.floor(index / 2)]);
                    const { width, height } = copiedPage.getSize();
                    const newPage = newPdfDoc.addPage([width / 2, height]);
                    const x = index % 2 === 0 ? 0 : -width / 2;
                    newPage.drawPage(copiedPage, { x, y: 0, width, height });
                }
                const bytes = await newPdfDoc.save();
                createDownloadLink(tool, bytes, `recreated_${file.name}`);
                showStatus(tool, 'Book re-created successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handleExtract = async () => {
            const tool = document.getElementById('extract-tool');
            toggleButtonLoading(tool, true); showStatus(tool, 'Extracting pages...');
            try {
                const file = toolState.extract.files[0];
                const rangeStr = tool.querySelector('.extract-pages').value;
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                const pageIndices = parsePageRanges(rangeStr, pdfDoc.getPageCount());
                if (pageIndices.length === 0) throw new Error("No valid pages selected.");
                const newPdfDoc = await PDFDocument.create();
                const copiedPages = await newPdfDoc.copyPages(pdfDoc, pageIndices);
                copiedPages.forEach(page => newPdfDoc.addPage(page));
                const bytes = await newPdfDoc.save();
                createDownloadLink(tool, bytes, `extracted_${file.name}`);
                showStatus(tool, 'Pages extracted successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handleSplitHalf = async () => {
            const tool = document.getElementById('splithalf-tool');
            toggleButtonLoading(tool, true); showStatus(tool, 'Splitting pages...');
            try {
                const file = toolState.splithalf.files[0];
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                const newPdfDoc = await PDFDocument.create();
                for (const page of pdfDoc.getPages()) {
                    const { width, height } = page.getSize();
                    const [leftHalf] = await newPdfDoc.copyPages(pdfDoc, [pdfDoc.getPages().indexOf(page)]);
                    const [rightHalf] = await newPdfDoc.copyPages(pdfDoc, [pdfDoc.getPages().indexOf(page)]);
                    const leftPage = newPdfDoc.addPage([width / 2, height]);
                    const rightPage = newPdfDoc.addPage([width / 2, height]);
                    leftPage.drawPage(leftHalf, { x: 0, y: 0 });
                    rightPage.drawPage(rightHalf, { x: -width / 2, y: 0 });
                }
                const bytes = await newPdfDoc.save();
                createDownloadLink(tool, bytes, `split_${file.name}`);
                showStatus(tool, 'Pages split successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handleWatermark = async () => {
            const tool = document.getElementById('watermark-tool');
            toggleButtonLoading(tool, true); showStatus(tool, 'Adding watermark...');
            try {
                const file = toolState.watermark.files[0];
                const text = tool.querySelector('.watermark-text').value;
                const size = parseInt(tool.querySelector('.watermark-size').value, 10);
                const rotation = parseInt(tool.querySelector('.watermark-rotation').value, 10);
                const opacity = parseFloat(tool.querySelector('.watermark-opacity').value);
                
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer(), {ignoreEncryption: true});
                const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

                pdfDoc.getPages().forEach(page => {
                    const { width, height } = page.getSize();
                    page.drawText(text, {
                        x: width / 2 - (font.widthOfTextAtSize(text, size) / 2),
                        y: height / 2 - size / 2,
                        font, size,
                        color: rgb(0, 0, 0),
                        opacity,
                        rotate: degrees(rotation),
                    });
                });
                
                const bytes = await pdfDoc.save();
                createDownloadLink(tool, bytes, `watermarked_${file.name}`);
                showStatus(tool, 'Watermark added successfully!');
            } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handlePageNumbers = async () => {
             const tool = document.getElementById('pagenumbers-tool');
             toggleButtonLoading(tool, true); showStatus(tool, 'Adding page numbers...');
             try {
                 const file = toolState.pagenumbers.files[0];
                 const position = tool.querySelector('.pagenum-position').value;
                 const size = parseInt(tool.querySelector('.pagenum-size').value, 10);
                 const start = parseInt(tool.querySelector('.pagenum-start').value, 10);

                 const pdfDoc = await PDFDocument.load(await file.arrayBuffer(), {ignoreEncryption: true});
                 const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                 const pages = pdfDoc.getPages();

                 pages.forEach((page, i) => {
                     const pageNum = i + start;
                     const { width, height } = page.getSize();
                     const text = `${pageNum}`;
                     const textWidth = font.widthOfTextAtSize(text, size);
                     
                     let x, y;
                     const margin = 30;

                     if (position.includes('bottom')) y = margin;
                     if (position.includes('top')) y = height - size - margin;
                     if (position.includes('left')) x = margin;
                     if (position.includes('right')) x = width - textWidth - margin;
                     if (position.includes('center')) x = width / 2 - textWidth / 2;

                     page.drawText(text, { x, y, font, size, color: rgb(0,0,0) });
                 });
                 
                 const bytes = await pdfDoc.save();
                 createDownloadLink(tool, bytes, `numbered_${file.name}`);
                 showStatus(tool, 'Page numbers added successfully!');
             } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
        };
        window.handlePdfToImages = async () => { /* ... Full implementation from previous step ... */ };
        window.handleFlatten = async () => { /* ... Full implementation from previous step ... */ };
        window.handleSign = async () => { /* Placeholder */ };
        const onAddSignature = () => { /* Placeholder */ };
        window.handleAddText = async () => { /* Placeholder */ };
        const onAddTextBox = () => { /* Placeholder */ };
        window.handleRedact = async () => { /* Placeholder */ };
        const onAddRedactionBox = () => { /* Placeholder */ };


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupAllTools();
            setActivePanel('unlock');
        });

    </script>
</body>
</html>