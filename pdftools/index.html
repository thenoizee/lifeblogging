<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools - Lifeblogging Hub</title>
    <link rel="icon" href="/favicons/file-pdf.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&family=Cedarville+Cursive&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json" />
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker registered successfully:', registration))
                    .catch(err => console.log('Service Worker registration failed (this is expected in local development if sw.js is not configured):', err));
            });
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
    </script>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg-color: white;
            --text-color-primary: #111827;
            --text-color-secondary: #4b5563;
            --input-bg-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        .dark {
            --bg-color: #111827;
            --card-bg-color: #1f2937;
            --text-color-primary: #f9fafb;
            --text-color-secondary: #9ca3af;
            --input-bg-color: #374151;
            --border-color: #4b5563;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color-primary); transition: background-color 0.3s, color 0.3s; }
        .nav-btn.active { color: #6366f1; background-color: #eef2ff; }
        .dark .nav-btn.active { background-color: #374151; color: #f9fafb; }
        .drop-zone { border: 2px dashed var(--border-color); transition: background-color 0.2s, border-color 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem; border-radius: 0.5rem; text-align: center; cursor: pointer; }
        .drop-zone.drag-over { background-color: #eef2ff; border-color: #6366f1; }
        .dark .drop-zone.drag-over { background-color: #374151; }
        .loader { border: 4px solid var(--border-color); border-top-color: #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .download-link, .download-zip-link { display: none; width: 100%; margin-top: 1rem; background-color: #16a34a; color: white; text-align: center; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s; }
        .download-link:hover, .download-zip-link:hover { background-color: #15803d; }
        .download-link.show, .download-zip-link.show { display: block; }
        .page-thumbnail { cursor: grab; position: relative; border: 1px solid var(--border-color); border-radius: 0.25rem; overflow: hidden; background: var(--input-bg-color); }
        .page-actions { position: absolute; top: 4px; right: 4px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; background-color: rgba(0,0,0,0.5); padding: 4px; border-radius: 5px;}
        .page-thumbnail:hover .page-actions { opacity: 1; }
        .page-thumbnail .page-number { position: absolute; bottom: 4px; left: 4px; background-color: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px;}
        .page-thumbnail.ghost { opacity: 0.5; background: #c8ebfb; }
        .page-thumbnail.deleted { opacity: 0.4; }
        .page-thumbnail.deleted::after { content: 'DELETED'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.7); color: white; font-weight: bold; }
        .file-item { cursor: grab; display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background-color: var(--input-bg-color); border: 1px solid var(--border-color); border-radius: 0.375rem; }
        #signature-pad { border: 1px solid var(--border-color); cursor: crosshair; }
        .preview-container { position: relative; border: 1px solid var(--border-color); overflow: auto; max-height: 60vh; width: 100%; }
        .preview-container.crop-active { cursor: crosshair; }
        .preview-container canvas { max-width: 100%; height: auto; display: block; }
        .crop-box { position: absolute; border: 2px dashed #6366f1; background-color: rgba(99, 102, 241, 0.1); pointer-events: none; }
        .draggable { position: absolute; cursor: move; border: 1px dashed #6366f1; background-color: rgba(99, 102, 241, 0.1); }
        .draggable.text-element { border: 1px dashed #f59e0b; background-color: rgba(245, 158, 11, 0.1); }
        .draggable.redact-element { border: 1px solid black; background-color: black; }
        .resizable-handle { position: absolute; width: 10px; height: 10px; background: #6366f1; border: 1px solid white; }
        .handle-se { bottom: -5px; right: -5px; cursor: se-resize; }
        .sig-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .sig-tab.active-tab { color: #6366f1; border-color: #6366f1; font-weight: 600; }
        .split-line, .cut-line { position: absolute; left: 0; right: 0; height: 3px; z-index: 10; border-top: 1px solid white; border-bottom: 1px solid white; cursor: pointer; }
        .split-line { background: rgba(255, 0, 0, 0.7); }
        .split-line:hover { background: red; }
        .cut-line { background: rgba(0, 100, 255, 0.7); }
        .cut-line:hover { background: blue; }
        #stitch-full-preview-container { max-height: 70vh; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; background: var(--input-bg-color); }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold flex items-center">
                <i class="fas fa-file-pdf mr-3 text-red-500"></i>PDF Tools
                <span id="version-display" class="text-sm font-mono bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-md px-2 py-1 ml-4"></span>
            </h1>
            <div class="flex items-center gap-4">
                <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
                <button id="theme-toggle" class="bg-[var(--card-bg-color)] border border-[var(--border-color)] rounded-full p-2" title="Toggle dark mode" disabled><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="bg-[var(--card-bg-color)] shadow-lg rounded-xl md:flex">
             <aside class="w-full md:w-64 border-b md:border-b-0 md:border-r border-[var(--border-color)] p-4">
                <nav class="flex flex-row overflow-x-auto md:flex-col gap-2">
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Organise</h3>
                    <button data-panel="organise" class="nav-btn active w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-sitemap w-6 mr-2"></i>Organise</button>
                    <button data-panel="metadata" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-tags w-6 mr-2"></i>Edit Metadata</button>
                    <button data-panel="merge" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-compress-alt w-6 mr-2"></i>Merge</button>
                    
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Edit & Sign</h3>
                     <button data-panel="sign" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-signature w-6 mr-2"></i>Sign PDF</button>
                     <button data-panel="addtext" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-font w-6 mr-2"></i>Add Text</button>
                     <button data-panel="redact" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-user-secret w-6 mr-2"></i>Redact</button>
                     <button data-panel="watermark" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-copyright w-6 mr-2"></i>Watermark</button>
                     <button data-panel="pagenumbers" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-sort-numeric-down w-6 mr-2"></i>Page Numbers</button>
                     <button data-panel="crop" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-crop-alt w-6 mr-2"></i>Crop PDF</button>
                    
                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Split & Extract</h3>
                     <button data-panel="extract" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-file-export w-6 mr-2"></i>Extract Pages</button>
                    <button data-panel="splithalf" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-columns w-6 mr-2"></i>Split Page in Half</button>
                    <button data-panel="recreate" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-book-open w-6 mr-2"></i>Re-create Book</button>
                    <button data-panel="stitch" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-link w-6 mr-2"></i>Stitch Pages</button>
                    <button data-panel="adfscanfixer" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-exchange-alt w-6 mr-2"></i>ADF Tablet to Booklet Scan Fixer</button>

                    <h3 class="text-xs uppercase text-[var(--text-color-secondary)] font-bold tracking-wider hidden md:block mt-4">Convert & Finalize</h3>
                    <button data-panel="pdftoimages" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-file-image w-6 mr-2"></i>PDF to Images</button>
                    <button data-panel="images" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-images w-6 mr-2"></i>Images to PDF</button>
                    <button data-panel="flatten" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-layer-group w-6 mr-2"></i>Flatten PDF</button>
                    <button data-panel="protect" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-lock w-6 mr-2"></i>Protect PDF</button>
                    <button data-panel="unlock" class="nav-btn w-full text-left p-3 rounded-lg font-medium flex-shrink-0"><i class="fas fa-unlock-alt w-6 mr-2"></i>Unlock</button>
                </nav>
            </aside>

            <main class="w-full p-6 md:p-8">
                <div id="panel-organise" class="tab-panel">
                    <h2 class="text-xl font-bold mb-2">Organise PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Visually reorder, rotate, and delete pages from your PDF.</p>
                    <div id="organise-tool" class="tool-container">
                        <div class="drop-zone" data-tool="organise"><i class="fas fa-sitemap text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div id="organise-pages-grid" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                        <button class="action-btn hidden w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg"><span class="btn-text">Save Changes</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div>
                        <a class="download-link">Download organised PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">Edit another PDF</button>
                    </div>
                </div>
                <div id="panel-metadata" class="tab-panel hidden">
    <h2 class="text-xl font-bold mb-2">Edit Metadata</h2>
    <p class="text-[var(--text-color-secondary)] mb-4">View and edit PDF properties and filename.</p>
    <div id="metadata-tool" class="tool-container">
        <div class="drop-zone" data-tool="metadata">
            <i class="fas fa-tags text-4xl text-[var(--text-color-secondary)] mb-4"></i>
            <p class="font-bold">Drag & drop PDF here</p>
            <input type="file" class="file-input hidden" accept=".pdf">
        </div>
        
        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg border border-[var(--border-color)]">
            <div class="mb-4 pb-4 border-b border-[var(--border-color)]">
                <label class="block font-bold mb-1">Filename (Save As):</label>
                <div class="flex">
                    <input type="text" id="meta-filename" class="flex-grow p-2 border rounded-l-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                    <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-[var(--border-color)] bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300">.pdf</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Title</label>
                    <input type="text" id="meta-title" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Author</label>
                    <input type="text" id="meta-author" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="md:col-span-2">
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Subject</label>
                    <input type="text" id="meta-subject" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="md:col-span-2">
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Keywords</label>
                    <input type="text" id="meta-keywords" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Creator</label>
                    <input type="text" id="meta-creator" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Producer</label>
                    <input type="text" id="meta-producer" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Creation Date</label>
                    <input type="datetime-local" id="meta-creation" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block font-medium text-sm text-[var(--text-color-secondary)]">Modification Date</label>
                    <input type="datetime-local" id="meta-mod" class="w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)] focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
        </div>

        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition" disabled>
            <span class="btn-text">Save Metadata</span>
            <div class="loader hidden"></div>
        </button>
        
        <div class="status-text mt-4 text-center"></div>
        <a class="download-link">Download Updated PDF</a>
        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">Edit another PDF</button>
    </div>
</div>
                <div id="panel-merge" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Merge PDFs</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Combine multiple PDFs into one. Drag and drop to reorder files.</p>
                    <div id="merge-tool" class="tool-container">
                       <div class="drop-zone" data-tool="merge"><i class="fas fa-compress-alt text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDFs here</p><p class="text-sm text-[var(--text-color-secondary)]">or click to select files</p><input type="file" class="file-input hidden" accept=".pdf" multiple></div>
                       <div id="merge-file-list" class="mt-4 space-y-2"></div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition" disabled><span class="btn-text">Merge PDFs</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Merged PDF</a>
                       <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                   </div>
                </div>
                <div id="panel-sign" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Sign PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Draw, type, or upload your signature to place on the document.</p>
                    <div id="sign-tool" class="tool-container">
                        <div class="drop-zone" data-tool="sign"><i class="fas fa-signature text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="editor-view hidden mt-4">
                            <div class="preview-container"><canvas id="sign-canvas-preview"></canvas></div>
                            <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                <div class="flex items-center gap-2"><button id="sign-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="sign-page-indicator">Page 1 / 1</span><button id="sign-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                <button id="add-signature-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Add Signature</button>
                            </div>
                        </div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Signatures & Save</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Signed PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-addtext" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Add Text</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Add custom text boxes to your PDF pages.</p>
                    <div id="addtext-tool" class="tool-container">
                         <div class="drop-zone" data-tool="addtext"><i class="fas fa-font text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="editor-view hidden mt-4">
                             <div class="preview-container"><canvas id="addtext-canvas-preview"></canvas></div>
                             <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                 <div class="flex items-center gap-2"><button id="addtext-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="addtext-page-indicator">Page 1 / 1</span><button id="addtext-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                 <button id="add-textbox-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Add Text Box</button>
                             </div>
                         </div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Text & Save</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Updated PDF</a>
                         <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-redact" class="tab-panel hidden">
                      <h2 class="text-xl font-bold mb-2">Redact PDF</h2>
                      <p class="text-[var(--text-color-secondary)] mb-4">Draw black boxes to permanently hide sensitive information.</p>
                      <div id="redact-tool" class="tool-container">
                         <div class="drop-zone" data-tool="redact"><i class="fas fa-user-secret text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="editor-view hidden mt-4">
                             <div class="preview-container"><canvas id="redact-canvas-preview"></canvas></div>
                             <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                 <div class="flex items-center gap-2"><button id="redact-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="redact-page-indicator">Page 1 / 1</span><button id="redact-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                 <button id="add-redaction-btn" class="bg-black text-white font-bold py-2 px-4 rounded-lg">Add Redaction Box</button>
                             </div>
                         </div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Redactions & Save</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Redacted PDF</a>
                         <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                      </div>
                </div>
                <div id="panel-watermark" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Add Watermark</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Add text watermark to all pages of your PDF.</p>
                    <div id="watermark-tool" class="tool-container">
                        <div class="drop-zone" data-tool="watermark"><i class="fas fa-copyright text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span></p>
                           <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="block font-medium">Text:</label><input type="text" value="CONFIDENTIAL" class="watermark-text w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Font Size:</label><input type="number" value="72" class="watermark-size w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Rotation (degrees):</label><input type="number" value="-45" class="watermark-rotation w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Opacity (0-1):</label><input type="number" value="0.5" step="0.1" min="0" max="1" class="watermark-opacity w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Add Watermark</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Watermarked PDF</a>
                       <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-pagenumbers" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Add Page Numbers</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Add page numbers to your document with various options.</p>
                      <div id="pagenumbers-tool" class="tool-container">
                        <div class="drop-zone" data-tool="pagenumbers"><i class="fas fa-sort-numeric-down text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                          <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span></p>
                           <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="block font-medium">Position:</label><select class="pagenum-position w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"><option value="bottom-center">Bottom Center</option><option value="bottom-left">Bottom Left</option><option value="bottom-right">Bottom Right</option><option value="top-center">Top Center</option><option value="top-left">Top Left</option><option value="top-right">Top Right</option></select></div>
                               <div><label class="block font-medium">Font Size:</label><input type="number" value="12" class="pagenum-size w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                               <div><label class="block font-medium">Starting Number:</label><input type="number" value="1" class="pagenum-start w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Add Page Numbers</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Numbered PDF</a>
                       <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                 <div id="panel-crop" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Crop PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Draw a rectangle on a page to crop it. The crop area can be set individually for each page.</p>
                    <div id="crop-tool" class="tool-container">
                       <div class="drop-zone" data-tool="crop"><i class="fas fa-crop-alt text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                       <div class="editor-view hidden mt-4">
                           <div class="preview-container"><canvas id="crop-canvas-preview"></canvas></div>
                           <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                               <div class="flex items-center gap-2"><button id="crop-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="crop-page-indicator">Page 1 / 1</span><button id="crop-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                               <button id="crop-clear-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Clear Crop on this Page</button>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Apply Crop & Save</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Cropped PDF</a>
                       <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-extract" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Extract Pages</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Create a new PDF from a range of pages. Use ranges (e.g., 2-5), single pages (e.g., 7), or a combination (e.g., 1, 3-4, 9).</p>
                    <div id="extract-tool" class="tool-container">
                        <div class="drop-zone" data-tool="extract"><i class="fas fa-file-export text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span> (<span class="page-count"></span> pages)</p>
                            <div class="mt-2"><label class="block font-medium">Pages to extract:</label><input type="text" placeholder="e.g., 1, 3-5, 8" class="extract-pages w-full mt-1 p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Extract Pages</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div><a class="download-link">Download Extracted PDF</a>
                       <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                   </div>
                </div>
                <div id="panel-splithalf" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Split Page in Half</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Splits each landscape page into two portrait pages. Useful for scanned single sheets.</p>
                    <div id="splithalf-tool" class="tool-container">
                        <div class="drop-zone" data-tool="splithalf"><i class="fas fa-columns text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Split Pages</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Split PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-recreate" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Re-create Scanned Book</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Fixes books scanned as double-page spreads by splitting and re-ordering them correctly.</p>
                        <div class="text-sm bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-4 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-600">
                         <p><strong>How it works:</strong> Assumes a booklet format. For a 20-page book, the first scan has page 20 (left) and page 1 (right), the second has page 2 (left) and 19 (right), etc.</p>
                    </div>
                    <div id="recreate-tool" class="tool-container">
                        <div class="drop-zone" data-tool="recreate"><i class="fas fa-book-open text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop scanned PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Re-create Book</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Corrected Book</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-stitch" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Stitch Pages</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">All pages will be stitched into one long page by default. To create a page break, you can: 1) Click to add a red line. 2) Shift+Click twice to create a blue area to remove (this also adds a break). 3) Use the "Mark Page as End" button.</p>
                    <div id="stitch-tool" class="tool-container">
                         <div class="drop-zone" data-tool="stitch"><i class="fas fa-link text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="editor-view hidden mt-4">
                             <div class="preview-container"><canvas id="stitch-canvas-preview"></canvas></div>
                             <div class="mt-4 flex flex-wrap justify-between items-center gap-4">
                                 <div class="flex items-center gap-2"><button id="stitch-prev-page" class="px-3 py-1 border rounded-md">&lt;</button><span id="stitch-page-indicator">Page 1 / 1</span><button id="stitch-next-page" class="px-3 py-1 border rounded-md">&gt;</button></div>
                                 <div class="flex items-center gap-2">
                                     <button id="mark-end-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Mark Page as End</button>
                                     <button id="clear-splits-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Clear All Lines</button>
                                 </div>
                             </div>
                         </div>
                         <div id="stitch-full-preview" class="hidden mt-4">
                             <h3 class="font-bold text-lg mb-2">Stitched Preview</h3>
                             <div id="stitch-full-preview-container" class="space-y-4"></div>
                         </div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Stitch PDF</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Stitched PDF</a>
                         <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-pdftoimages" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">PDF to Images</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Convert each page of a PDF to an image.</p>
                      <div id="pdftoimages-tool" class="tool-container">
                         <div class="drop-zone" data-tool="pdftoimages"><i class="fas fa-file-image text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                           <p class="font-bold">File: <span class="file-name"></span></p>
                           <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div><label class="block font-medium">Image Format:</label><select class="pdftoimages-format w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"><option value="image/png">PNG</option><option value="image/jpeg">JPG</option></select></div>
                           </div>
                       </div>
                       <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Convert to Images</span><div class="loader hidden"></div></button>
                       <div class="status-text mt-4 text-center"></div>
                       <div id="pdftoimages-links" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                       <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-images" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Images to PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Convert JPG, PNG images to a single PDF. Drag to reorder.</p>
                      <div id="images-tool" class="tool-container">
                        <div class="drop-zone" data-tool="images"><i class="fas fa-images text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop Images here</p><input type="file" class="file-input hidden" accept="image/jpeg, image/png" multiple></div>
                        <div id="images-file-list" class="mt-4 space-y-2"></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Convert to PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-flatten" class="tab-panel hidden">
                      <h2 class="text-xl font-bold mb-2">Flatten PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Merge all annotations, form fields, and layers into a single, non-editable layer.</p>
                      <div id="flatten-tool" class="tool-container">
                         <div class="drop-zone" data-tool="flatten"><i class="fas fa-layer-group text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                         <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                         <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Flatten PDF</span><div class="loader hidden"></div></button>
                         <div class="status-text mt-4 text-center"></div><a class="download-link">Download Flattened PDF</a>
                         <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                      </div>
                </div>
                <div id="panel-protect" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">Protect PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Encrypt and add a password to a PDF file.</p>
                    <div id="protect-tool" class="tool-container">
                        <div class="drop-zone" data-tool="protect"><i class="fas fa-lock text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                            <p class="font-bold">File: <span class="file-name"></span></p>
                            <div class="mt-2 grid sm:grid-cols-2 gap-4">
                                <div><label class="block font-medium">New Password:</label><input type="password" class="protect-password w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                                <div><label class="block font-medium">Confirm Password:</label><input type="password" class="protect-confirm-password w-full mt-1 p-2 border rounded-md bg-[var(--bg-color)] border-[var(--border-color)]"></div>
                            </div>
                        </div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Protect PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Protected PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                <div id="panel-unlock" class="tab-panel hidden">
                      <h2 class="text-xl font-bold mb-2">Unlock PDF</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Remove password restrictions from a PDF. Files are processed in your browser.</p>
                      <div class="text-sm bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-4 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-600">
                        <p class="font-bold"><i class="fas fa-info-circle mr-2"></i>Having Trouble Unlocking?</p>
                        <p class="mt-1">If you're sure the password is correct, the PDF file itself might be slightly corrupted. You can fix this by "refreshing" it: Open it in Chrome or another PDF viewer, choose <strong>Print</strong>, and then <strong>Save as PDF</strong> to create a clean, working copy.</p>
                    </div>
                    <div id="unlock-tool" class="tool-container">
                        <div class="drop-zone" data-tool="unlock"><i class="fas fa-file-upload text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><p class="text-sm text-[var(--text-color-secondary)]">or click to select file</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg">
                            <p class="font-bold">File: <span class="file-name"></span></p>
                            <div class="mt-2"><label class="block font-medium">Password (if any):</label><input type="password" class="unlock-password w-full mt-1 p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                        </div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition" disabled><span class="btn-text">Unlock PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Unlocked PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>

                <div id="panel-adfscanfixer" class="tab-panel hidden">
                    <h2 class="text-xl font-bold mb-2">ADF Tablet to Booklet Scan Fixer</h2>
                    <p class="text-[var(--text-color-secondary)] mb-4">Corrects PDFs where every second page is scanned upside down (a common automatic document feeder scanning accident / issue).</p>
                    <div id="adfscanfixer-tool" class="tool-container">
                        <div class="drop-zone" data-tool="adfscanfixer"><i class="fas fa-exchange-alt text-4xl text-[var(--text-color-secondary)] mb-4"></i><p class="font-bold">Drag & drop PDF here</p><input type="file" class="file-input hidden" accept=".pdf"></div>
                        <div class="file-info hidden mt-4 bg-[var(--input-bg-color)] p-4 rounded-lg"><p class="font-bold">File: <span class="file-name"></span></p></div>
                        <button class="action-btn w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled><span class="btn-text">Fix PDF</span><div class="loader hidden"></div></button>
                        <div class="status-text mt-4 text-center"></div><a class="download-link">Download Fixed PDF</a>
                        <button class="reset-btn hidden w-full mt-4 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">I have more PDFs to edit</button>
                    </div>
                </div>
                
            </main>
        </div>
    </div>
    
    <div id="signature-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-[var(--card-bg-color)] rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4">Create Signature</h3>
            <div class="border-b border-[var(--border-color)] mb-4">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs"><button class="sig-tab active-tab" data-tab="draw">Draw</button><button class="sig-tab" data-tab="type">Type</button><button class="sig-tab" data-tab="upload">Upload</button></nav>
            </div>
            <div id="sig-tab-draw" class="sig-tab-content"><canvas id="signature-pad" width="400" height="200" class="bg-white rounded-md"></canvas></div>
            <div id="sig-tab-type" class="sig-tab-content hidden"><input type="text" id="sig-text-input" class="w-full p-2 border border-[var(--border-color)] rounded-md" placeholder="Type your name"><div id="sig-text-preview" class="mt-2 p-4 text-center text-3xl" style="font-family: 'Cedarville Cursive', cursive;"></div></div>
            <div id="sig-tab-upload" class="sig-tab-content hidden"><input type="file" id="sig-upload-input" accept="image/png, image/jpeg" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/></div>
            <div class="mt-4 flex justify-between">
                <button id="clear-signature" class="px-4 py-2 border rounded-md">Clear</button>
                <div><button id="cancel-signature" class="px-4 py-2 border rounded-md mr-2">Cancel</button><button id="save-signature" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save Signature</button></div>
            </div>
        </div>
    </div>


    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { changelogData } from '/changelog-data.js';
    const { PDFDocument, rgb, degrees, StandardFonts, PageSizes } = PDFLib;

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
        authDomain: "sammy-7298f.firebaseapp.com",
        projectId: "sammy-7298f",
        storageBucket: "sammy-7298f.appspot.com",
        messagingSenderId: "963185683535",
        appId: "1:963185683535:web:807df8941feba46c208e3a",
        measurementId: "G-JT1YF2ELN3"
    };

    // --- FIREBASE INIT ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const LATEST_VERSION = changelogData[0].version;
    document.getElementById('version-display').textContent = LATEST_VERSION;

    // --- THEME LOGIC (REVISED) ---
    const themeToggle = document.getElementById('theme-toggle');
    let themeDocRef = null;
    let themeUnsubscribe = null;

    const applyTheme = (theme) => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    };
    
    themeToggle.addEventListener('click', () => {
        const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(newTheme); // Apply locally
        
        if (themeDocRef) {
            // Logged in: Save to Firestore
            setDoc(themeDocRef, { theme: newTheme }, { merge: true });
        } else {
            // Not logged in: Save to localStorage
            localStorage.setItem('theme', newTheme);
        }
    });

    // Auth listener to set up theme
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is logged in
            themeDocRef = doc(db, 'users', user.uid, 'settings', 'theme');
            themeToggle.disabled = false;

            if (themeUnsubscribe) themeUnsubscribe();
            themeUnsubscribe = onSnapshot(themeDocRef, (docSnap) => {
                const theme = docSnap.data()?.theme || 'light';
                applyTheme(theme);
            }, (error) => {
                console.error("Error listening to theme:", error);
                applyTheme('light'); // Default on error
            });
        } else {
            // User is not logged in
            themeDocRef = null;
            if (themeUnsubscribe) themeUnsubscribe();
            themeToggle.disabled = false; // Can still use localStorage
            
            // Load from localStorage
            applyTheme(localStorage.getItem('theme') || 'light');
        }
    });

    // --- NAVIGATION LOGIC ---
    const navButtons = document.querySelectorAll('.nav-btn');
    const panels = document.querySelectorAll('.tab-panel');
    let currentPanelId = 'organise'; // Default panel

    const setActivePanel = (panelId) => {
        if (currentPanelId && toolState[currentPanelId] && toolState[currentPanelId].toolElement) {
            resetTool(toolState[currentPanelId].toolElement);
        }
        navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.panel === panelId));
        panels.forEach(panel => panel.classList.toggle('hidden', panel.id !== `panel-${panelId}`));
        currentPanelId = panelId;
    };
    navButtons.forEach(button => button.addEventListener('click', (e) => setActivePanel(e.currentTarget.dataset.panel)));
    
    // --- GLOBAL STATE & HELPERS ---
    const toolState = {};
    const showStatus = (tool, message, isError = false) => {
        const el = tool.querySelector('.status-text');
        if(!el) return;
        el.textContent = message;
        el.className = `status-text mt-4 text-center ${isError ? 'text-red-500' : 'text-green-600'}`;
    };
    const toggleButtonLoading = (tool, isLoading) => {
        const btn = tool.querySelector('.action-btn');
        if (!btn) return;
        btn.disabled = isLoading;
        btn.querySelector('.btn-text')?.classList.toggle('hidden', isLoading);
        btn.querySelector('.loader')?.classList.toggle('hidden', !isLoading);
    };
    const createDownloadLink = (tool, bytes, fileName) => {
    // 1. Setup Download Link
    const link = tool.querySelector('.download-link');
    const blob = new Blob([bytes], { type: 'application/pdf' });
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.classList.add('show');
    tool.querySelector('.reset-btn')?.classList.remove('hidden');

    // 2. Clear existing "Continue" container if any
    let continueContainer = tool.querySelector('.continue-container');
    if (continueContainer) continueContainer.remove();

    // 3. Create "Continue Editing" UI
    continueContainer = document.createElement('div');
    continueContainer.className = 'continue-container mt-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-lg';
    
    continueContainer.innerHTML = `
        <label class="block text-sm font-bold text-indigo-800 dark:text-indigo-200 mb-2">
            <i class="fas fa-arrow-right mr-1"></i> Continue working on this file:
        </label>
        <div class="flex gap-2">
            <select class="continue-select flex-grow p-2 rounded border border-indigo-200 dark:border-indigo-700 bg-white dark:bg-gray-800 text-sm">
                <option value="">Select next tool...</option>
                <option value="organise">Organise (Reorder/Rotate)</option>
                <option value="metadata">Edit Metadata</option>
                <option value="merge">Merge (Add more files)</option>
                <option value="sign">Sign PDF</option>
                <option value="addtext">Add Text</option>
                <option value="redact">Redact</option>
                <option value="watermark">Watermark</option>
                <option value="pagenumbers">Page Numbers</option>
                <option value="crop">Crop</option>
                <option value="extract">Extract Pages</option>
                <option value="splithalf">Split Pages in Half</option>
                <option value="stitch">Stitch Pages</option>
                <option value="flatten">Flatten</option>
                <option value="protect">Protect (Password)</option>
            </select>
            <button class="continue-go-btn bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700 disabled:opacity-50" disabled>
                Go
            </button>
        </div>
    `;

    tool.querySelector('.download-link').after(continueContainer);

    // 4. Handle "Continue" Logic
    const select = continueContainer.querySelector('.continue-select');
    const goBtn = continueContainer.querySelector('.continue-go-btn');

    select.addEventListener('change', () => { goBtn.disabled = !select.value; });

    goBtn.addEventListener('click', () => {
        const targetId = select.value;
        if (!targetId) return;

        // Create a File object from the processed bytes
        const newFile = new File([bytes], fileName, { type: 'application/pdf' });

        // Switch Panel
        setActivePanel(targetId);

        // Load file into new tool
        setTimeout(() => {
            const targetTool = document.getElementById(`${targetId}-tool`);
            // Reset target first to clear old state
            resetTool(targetTool);
            
            // Invoke the handler (we must ensure setup functions exposed it below)
            if (toolState[targetId] && toolState[targetId].loadHandler) {
                // Some tools accept array (SimpleTool), others single file (EditorTool)
                // Our update below ensures loadHandler handles the arguments correctly or we adapt here:
                if (['merge', 'images'].includes(targetId)) {
                    toolState[targetId].loadHandler([newFile]);
                } else {
                    toolState[targetId].loadHandler(newFile);
                }
                
                // Scroll to top
                targetTool.scrollIntoView({ behavior: 'smooth' });
            } else {
                console.error(`Tool ${targetId} does not have a registered loadHandler.`);
            }
        }, 100);
    });
};
    const toDatetimeLocal = (date) => {
        if (!date) return '';
        const pad = (num) => (num < 10 ? '0' : '') + num;
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };
     const parsePageRanges = (rangeStr, maxPage) => {
        const indices = new Set();
        if (!rangeStr || rangeStr.trim() === '' || rangeStr.trim() === '*') {
            for (let i = 0; i < maxPage; i++) indices.add(i);
            return Array.from(indices);
        }
        const parts = rangeStr.split(',');
        for (const part of parts) {
            const trimmedPart = part.trim();
            if (trimmedPart.includes('-')) {
                let [start, end] = trimmedPart.split('-').map(p => parseInt(p.trim(), 10));
                if (!isNaN(start) && !isNaN(end) && start <= end) {
                    for (let i = start; i <= end; i++) {
                         if (i > 0 && i <= maxPage) indices.add(i - 1);
                    }
                }
            } else {
                const pageNum = parseInt(trimmedPart, 10);
                if (!isNaN(pageNum) && pageNum > 0 && pageNum <= maxPage) indices.add(pageNum - 1);
            }
        }
        return Array.from(indices).sort((a, b) => a - b);
    };

    const setupMetadataTool = () => {
        const toolId = 'metadata';
        const tool = document.getElementById(`${toolId}-tool`);
        if (!tool) return;
        
        toolState[toolId] = { files: [], toolElement: tool };
        const dropZone = tool.querySelector('.drop-zone');
        const fileInput = tool.querySelector('.file-input');
        const actionBtn = tool.querySelector('.action-btn');
        const fileInfo = tool.querySelector('.file-info');
        const resetBtn = tool.querySelector('.reset-btn');

        const handleFile = async (file) => {
            if (!file) return;
            resetTool(tool);
            toolState[toolId].files = [file];
            
            dropZone.classList.add('hidden');
            fileInfo.classList.remove('hidden');
            actionBtn.disabled = false;
            
            // Populate Filename Input (stripping .pdf extension)
            const nameWithoutExt = file.name.replace(/\.pdf$/i, "");
            const filenameInput = document.getElementById('meta-filename');
            if (filenameInput) filenameInput.value = nameWithoutExt;

            showStatus(tool, 'Reading metadata...');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                
                // Populate fields
                document.getElementById('meta-title').value = pdfDoc.getTitle() || '';
                document.getElementById('meta-author').value = pdfDoc.getAuthor() || '';
                document.getElementById('meta-subject').value = pdfDoc.getSubject() || '';
                document.getElementById('meta-keywords').value = pdfDoc.getKeywords() || '';
                document.getElementById('meta-creator').value = pdfDoc.getCreator() || '';

                // --- NEW CODE: Custom Creator Logic ---
const currentCreator = pdfDoc.getCreator();
// Check if missing or if it's the default library tag
if (!currentCreator || currentCreator.toLowerCase().includes('pdf-lib') || currentCreator.toLowerCase().includes('script')) {
    document.getElementById('meta-creator').value = "";
} else {
    document.getElementById('meta-creator').value = currentCreator;
}
                
                // --- CUSTOM PRODUCER LOGIC ---
                const currentProducer = pdfDoc.getProducer();
                // If producer is missing or is the default pdf-lib tag, use your custom name
                if (!currentProducer || currentProducer.toLowerCase().includes('pdf-lib')) {
                    document.getElementById('meta-producer').value = "SH's PDF Editing Tool";
                } else {
                    document.getElementById('meta-producer').value = currentProducer;
                }
                
                document.getElementById('meta-creation').value = toDatetimeLocal(pdfDoc.getCreationDate());
                document.getElementById('meta-mod').value = toDatetimeLocal(pdfDoc.getModificationDate());
                
                showStatus(tool, 'Metadata loaded. Edit fields and click Save.');
            } catch (e) {
                showStatus(tool, `Error reading PDF: ${e.message}`, true);
                console.error(e);
            }
        };

        // EXPOSE HANDLER
    toolState[toolId].loadHandler = handleFile;

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
        if (resetBtn) resetBtn.addEventListener('click', () => resetTool(tool));
    };

    const resetTool = (tool) => {
        if (!tool) return;
        tool.querySelector('.drop-zone')?.classList.remove('hidden');
        tool.querySelector('.editor-view')?.classList.add('hidden');
        tool.querySelector('.file-info')?.classList.add('hidden');
        tool.querySelector('.download-link')?.classList.remove('show');
        tool.querySelector('.reset-btn')?.classList.add('hidden');

        if (tool.querySelector('.status-text')) tool.querySelector('.status-text').textContent = '';
        const actionBtn = tool.querySelector('.action-btn');
        if(actionBtn) actionBtn.disabled = true;

        const toolId = tool.id.replace('-tool', '');
        const state = toolState[toolId];
        if (!state) return;

        state.files = [];
        if (state.hasOwnProperty('elements')) state.elements = [];
        if (state.hasOwnProperty('currentPage')) state.currentPage = 1;
        
        if (toolId === 'organise') {
            const grid = tool.querySelector('#organise-pages-grid');
            grid.innerHTML = '';
            grid.classList.add('hidden');
            actionBtn.classList.add('hidden');
        }
        if (toolId === 'stitch') {
            state.splits = {};
            state.cuts = {};
            state.ends = new Set();
            const fullPreview = tool.querySelector('#stitch-full-preview');
            if (fullPreview) fullPreview.classList.add('hidden');
            const previewContainer = tool.querySelector('#stitch-full-preview-container');
            if (previewContainer) previewContainer.innerHTML = '';
        }
        if (toolId === 'crop') {
            state.boxes = {};
            const previewContainer = tool.querySelector('.preview-container');
            previewContainer.querySelector('.crop-box')?.remove();
        }
        if (toolId === 'merge' || toolId === 'images') {
            const fileList = tool.querySelector(`#${toolId}-file-list`);
            if (fileList) fileList.innerHTML = '';
        }
    };

    // --- GENERIC TOOL SETUP ---
    const setupSimpleTool = (toolId, options = {}) => {
        const tool = document.getElementById(`${toolId}-tool`);
        if(!tool) return;
        toolState[toolId] = { files: [], toolElement: tool };
        const dropZone = tool.querySelector('.drop-zone');
        const fileInput = tool.querySelector('.file-input');
        const actionBtn = tool.querySelector('.action-btn');
        const handleFiles = async (files) => {
            if (files.length === 0) return;
            toolState[toolId].files = options.multiFile ? [...(toolState[toolId].files || []), ...Array.from(files)] : Array.from(files);
            if(actionBtn) actionBtn.disabled = false;
            const fileInfo = tool.querySelector('.file-info');
            if (fileInfo) {
                fileInfo.classList.remove('hidden');
                fileInfo.querySelector('.file-name').textContent = toolState[toolId].files.length > 1 ? `${toolState[toolId].files.length} files selected` : toolState[toolId].files[0].name;
                if (toolId !== 'unlock' && (fileInfo.querySelector('.page-count') || fileInfo.querySelector('.page-dims'))) {
                     try {
                        const arrayBuffer = await toolState[toolId].files[0].arrayBuffer();
                        const pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                        if (fileInfo.querySelector('.page-count')) fileInfo.querySelector('.page-count').textContent = pdfDoc.getPageCount();
                        if (fileInfo.querySelector('.page-dims')) {
                            const {width, height} = pdfDoc.getPage(0).getSize();
                            fileInfo.querySelector('.page-dims').textContent = `${width.toFixed(2)} x ${height.toFixed(2)} pts`;
                        }
                    } catch (e) {
                         if (fileInfo.querySelector('.page-count')) fileInfo.querySelector('.page-count').textContent = 'N/A';
                         if (fileInfo.querySelector('.page-dims')) fileInfo.querySelector('.page-dims').textContent = 'N/A';
                         console.warn(`Could not read PDF metadata for ${toolId}: ${e.message}`);
                    }
                }
            }
            if (options.multiFile) {
                renderMultiFileList(toolId);
            }
            
        };

        // EXPOSE HANDLER (Adapter for single file vs FileList)
    toolState[toolId].loadHandler = (filesInput) => {
        // If passed a single File from "Continue", wrap in array
        if (filesInput instanceof File) handleFiles([filesInput]);
        else handleFiles(filesInput);
    };
        const renderMultiFileList = (toolIdToList) => {
            const listContainer = tool.querySelector(`#${toolIdToList}-file-list`);
            if (!listContainer) return;
            listContainer.innerHTML = '';
            toolState[toolIdToList].files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.dataset.index = index;
                item.innerHTML = `<span><i class="fas fa-grip-vertical mr-2 text-gray-400"></i>${file.name}</span><button class="remove-file text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>`;
                listContainer.appendChild(item);
            });
            if (listContainer && !listContainer.sortable) {
                listContainer.sortable = Sortable.create(listContainer, { handle: '.fa-grip-vertical', animation: 150, onEnd: onSortEnd });
            }
        };
        const onSortEnd = (evt) => {
            const { oldIndex, newIndex } = evt;
            const files = toolState[toolId].files;
            const [movedItem] = files.splice(oldIndex, 1);
            files.splice(newIndex, 0, movedItem);
        };
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
        const listContainer = tool.querySelector(`#${toolId}-file-list`);
        if (listContainer) {
            listContainer.addEventListener('click', e => {
                if (e.target.closest('.remove-file')) {
                    const item = e.target.closest('.file-item');
                    const index = Array.from(item.parentNode.children).indexOf(item);
                    toolState[toolId].files.splice(index, 1);
                    item.remove();
                    if (toolState[toolId].files.length === 0 && actionBtn) actionBtn.disabled = true;
                }
            });
        }
        const resetBtn = tool.querySelector('.reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => resetTool(tool));
        }
    };

    const setupEditorTool = (toolId, onAddElement) => {
        const tool = document.getElementById(`${toolId}-tool`);
        if (!tool) return;
        toolState[toolId] = { files: [], toolElement: tool, currentPage: 1, elements: [] };
        // Tool specific state initialization
        if (toolId === 'stitch') {
            toolState[toolId].splits = {}; toolState[toolId].cuts = {}; toolState[toolId].ends = new Set();
        }
        if (toolId === 'crop') {
            toolState[toolId].boxes = {};
        }

        const dropZone = tool.querySelector('.drop-zone');
        const fileInput = tool.querySelector('.file-input');
        const actionBtn = tool.querySelector('.action-btn');
        const editorView = tool.querySelector('.editor-view');
        const previewContainer = tool.querySelector('.preview-container');
        const canvas = tool.querySelector('canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const resetBtn = tool.querySelector('.reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => resetTool(tool));
        }

        const RENDER_SCALE = 1.5;
        
        const renderPage = async (pageNum) => {
            const pdfJS = toolState[toolId].pdfJSDoc;
            if (!pdfJS || pageNum < 1 || pageNum > pdfJS.numPages) return;
            toolState[toolId].currentPage = pageNum;
            tool.querySelector(`#${toolId}-page-indicator`).textContent = `Page ${pageNum} / ${pdfJS.numPages}`;
            const page = await pdfJS.getPage(pageNum);
            const viewport = page.getViewport({ scale: RENDER_SCALE });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({ canvasContext: ctx, viewport }).promise;
            
            // Tool-specific rendering on top of the page
            if (toolId === 'stitch') {
                const cuts = toolState.stitch.cuts[pageNum] || [];
                const splits = toolState.stitch.splits[pageNum] || [];
                const sortedCuts = [...cuts].map(c => c.y).sort((a, b) => a - b);
                ctx.fillStyle = 'rgba(0, 100, 255, 0.3)';
                for (let i = 0; i < sortedCuts.length - 1; i += 2) {
                    const startY = sortedCuts[i];
                    const endY = sortedCuts[i + 1];
                    if (endY > startY) ctx.fillRect(0, startY, canvas.width, endY - startY);
                }
                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                splits.forEach(split => ctx.fillRect(0, split.y - 1.5, canvas.width, 3));
                ctx.fillStyle = 'rgba(0, 100, 255, 0.7)';
                cuts.forEach(cut => ctx.fillRect(0, cut.y - 1.5, canvas.width, 3));

                const markEndBtn = tool.querySelector('#mark-end-btn');
                markEndBtn.textContent = toolState.stitch.ends.has(pageNum) ? "Unmark as End" : "Mark Page as End";
                markEndBtn.classList.toggle('bg-green-600', toolState.stitch.ends.has(pageNum));
            }
            if (toolId === 'crop') {
                previewContainer.querySelector('.crop-box')?.remove();
                if (toolState.crop.boxes[pageNum]) {
                    const boxData = toolState.crop.boxes[pageNum];
                    const cropBoxDiv = document.createElement('div');
                    cropBoxDiv.className = 'crop-box';
                    const canvasRect = canvas.getBoundingClientRect();
                    const containerRect = previewContainer.getBoundingClientRect();
                    const scale = canvasRect.width / canvas.width;
                    cropBoxDiv.style.left = `${(boxData.x * scale) + (canvasRect.left - containerRect.left)}px`;
                    cropBoxDiv.style.top = `${(boxData.y * scale) + (canvasRect.top - containerRect.top)}px`;
                    cropBoxDiv.style.width = `${boxData.width * scale}px`;
                    cropBoxDiv.style.height = `${boxData.height * scale}px`;
                    previewContainer.appendChild(cropBoxDiv);
                }
            }
        };

        const handleFile = async (file) => {
            if (!file) return;
            resetTool(tool); // Reset previous state before loading new file
            toolState[toolId].files = [file];
            dropZone.classList.add('hidden');
            editorView.classList.remove('hidden');
            if (actionBtn) actionBtn.disabled = false;
            showStatus(tool, 'Loading PDF...');
            try {
                const arrayBuffer = await file.arrayBuffer();
                // Store the original buffer for pdf-lib
                toolState[toolId].pdfBytes = arrayBuffer;
                
                // --- FIX: Give pdf.js a COPY of the buffer so the original isn't detached ---
                const bufferCopy = arrayBuffer.slice(0);
                const pdfJS = await pdfjsLib.getDocument({ data: new Uint8Array(bufferCopy) }).promise;

                toolState[toolId].pdfJSDoc = pdfJS;
                await renderPage(1);
                showStatus(tool, 'PDF loaded.');
            } catch(e) {
                showStatus(tool, `Error loading PDF: ${e.message}`, true);
                resetTool(tool);
            }
        };

        // EXPOSE HANDLER
    toolState[toolId].loadHandler = handleFile;

        // Standard event listeners
        const prevPageBtn = tool.querySelector(`#${toolId}-prev-page`);
        const nextPageBtn = tool.querySelector(`#${toolId}-next-page`);
        if (prevPageBtn) prevPageBtn.addEventListener('click', () => renderPage(toolState[toolId].currentPage - 1));
        if (nextPageBtn) nextPageBtn.addEventListener('click', () => renderPage(toolState[toolId].currentPage + 1));
        if (onAddElement) {
            const addButton = tool.querySelector(`#add-${toolId.replace('add', '')}-btn`) || tool.querySelector(`#add-signature-btn`) || tool.querySelector(`#add-textbox-btn`) || tool.querySelector(`#add-redaction-btn`);
            if(addButton) addButton.addEventListener('click', () => onAddElement(tool, previewContainer));
        }

        // Tool-specific interaction setup
        if (toolId === 'stitch') {
            previewContainer.addEventListener('click', (e) => {
                const pageNum = toolState.stitch.currentPage;
                if (e.target.tagName !== 'CANVAS') return;
                const rect = canvas.getBoundingClientRect();
                const y_css = e.clientY - rect.top;
                const effectiveScaleRatio = canvas.height / rect.height;
                const clickedInternalY = y_css * effectiveScaleRatio;
                const clickThreshold = 5 * effectiveScaleRatio;
                let lineDeleted = false;
                
                const cuts = toolState.stitch.cuts[pageNum] || [];
                for (let i = cuts.length - 1; i >= 0; i--) {
                    if (Math.abs(cuts[i].y - clickedInternalY) < clickThreshold) {
                        cuts.splice(i, 1);
                        lineDeleted = true;
                        break;
                    }
                }
                if (!lineDeleted) {
                    const splits = toolState.stitch.splits[pageNum] || [];
                    for (let i = splits.length - 1; i >= 0; i--) {
                        if (Math.abs(splits[i].y - clickedInternalY) < clickThreshold) {
                            splits.splice(i, 1);
                            lineDeleted = true;
                            break;
                        }
                    }
                }
                if (!lineDeleted) {
                    if (e.shiftKey) {
                        if (!toolState.stitch.cuts[pageNum]) toolState.stitch.cuts[pageNum] = [];
                        toolState.stitch.cuts[pageNum].push({ y: clickedInternalY });
                    } else {
                        if (!toolState.stitch.splits[pageNum]) toolState.stitch.splits[pageNum] = [];
                        toolState.stitch.splits[pageNum].push({ y: clickedInternalY });
                    }
                }
                renderPage(pageNum);
            });
            
            tool.querySelector('#clear-splits-btn').addEventListener('click', () => {
                toolState.stitch.splits = {}; toolState.stitch.cuts = {}; toolState.stitch.ends.clear();
                renderPage(toolState.stitch.currentPage);
            });
            tool.querySelector('#mark-end-btn').addEventListener('click', () => {
                 const pageNum = toolState.stitch.currentPage;
                 if(toolState.stitch.ends.has(pageNum)) toolState.stitch.ends.delete(pageNum);
                 else toolState.stitch.ends.add(pageNum);
                 renderPage(pageNum);
            });
        }

        if (toolId === 'crop') {
            previewContainer.classList.add('crop-active');
            let cropBoxDiv = null, startCoords = null;

            const getCanvasCoords = (e) => {
                const canvasRect = canvas.getBoundingClientRect();
                const scale = canvas.width / canvasRect.width;
                return {
                    x: (e.clientX - canvasRect.left) * scale,
                    y: (e.clientY - canvasRect.top) * scale
                };
            };
            
            previewContainer.addEventListener('mousedown', e => {
                if (e.target !== canvas) return;
                startCoords = getCanvasCoords(e);
                previewContainer.querySelector('.crop-box')?.remove();
                cropBoxDiv = document.createElement('div');
                cropBoxDiv.className = 'crop-box';
                previewContainer.appendChild(cropBoxDiv);
                
                const canvasRect = canvas.getBoundingClientRect();
                const containerRect = previewContainer.getBoundingClientRect();
                cropBoxDiv.style.left = `${e.clientX - containerRect.left}px`;
                cropBoxDiv.style.top = `${e.clientY - containerRect.top}px`;
                cropBoxDiv.style.width = '0px';
                cropBoxDiv.style.height = '0px';
            });
            previewContainer.addEventListener('mousemove', e => {
                if (!startCoords || !cropBoxDiv) return;
                const currentCoords = getCanvasCoords(e);
                const canvasRect = canvas.getBoundingClientRect();
                const containerRect = previewContainer.getBoundingClientRect();
                const scale = canvasRect.width / canvas.width;
                
                const x = Math.min(startCoords.x, currentCoords.x);
                const y = Math.min(startCoords.y, currentCoords.y);
                const width = Math.abs(currentCoords.x - startCoords.x);
                const height = Math.abs(currentCoords.y - startCoords.y);
                
                cropBoxDiv.style.left = `${(x * scale) + (canvasRect.left - containerRect.left)}px`;
                cropBoxDiv.style.top = `${(y * scale) + (canvasRect.top - containerRect.top)}px`;
                cropBoxDiv.style.width = `${width * scale}px`;
                cropBoxDiv.style.height = `${height * scale}px`;
            });
            const endCrop = (e) => {
                if (!startCoords || !cropBoxDiv) return;
                const currentCoords = getCanvasCoords(e);
                const x = Math.min(startCoords.x, currentCoords.x);
                const y = Math.min(startCoords.y, currentCoords.y);
                const width = Math.abs(currentCoords.x - startCoords.x);
                const height = Math.abs(currentCoords.y - startCoords.y);

                if (width > 5 && height > 5) { // Minimum crop size
                    toolState.crop.boxes[toolState.crop.currentPage] = { x, y, width, height };
                } else {
                    delete toolState.crop.boxes[toolState.crop.currentPage];
                    cropBoxDiv.remove();
                }
                startCoords = null;
                cropBoxDiv = null;
            };
            previewContainer.addEventListener('mouseup', endCrop);
            previewContainer.addEventListener('mouseleave', endCrop);
            tool.querySelector('#crop-clear-btn').addEventListener('click', () => {
                delete toolState.crop.boxes[toolState.crop.currentPage];
                renderPage(toolState.crop.currentPage);
            });
        }
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
    };
    
    // --- TOOL-SPECIFIC LOGIC ---
    const setupAllTools = () => {
        setupMetadataTool(); // <--- Add this line
        setuporganiseTool();
        setupSimpleTool('unlock');
        setupSimpleTool('protect');
        setupSimpleTool('extract');
        setupSimpleTool('splithalf');
        setupSimpleTool('recreate');
        setupSimpleTool('merge', { multiFile: true });
        setupSimpleTool('images', { multiFile: true });
        setupSimpleTool('watermark');
        setupSimpleTool('pagenumbers');
        setupSimpleTool('pdftoimages');
        setupSimpleTool('flatten');
        setupSimpleTool('adfscanfixer');
        setupEditorTool('sign', onAddSignature);
        setupEditorTool('addtext', onAddTextBox);
        setupEditorTool('redact', onAddRedactionBox);
        setupEditorTool('stitch');
        setupEditorTool('crop');
        document.querySelectorAll('.action-btn').forEach(btn => {
            const toolId = btn.closest('.tool-container').id.replace('-tool', '');
            const handlerName = `handle${toolId.charAt(0).toUpperCase() + toolId.slice(1)}`;
            const handler = window[handlerName];
            if(handler) {
                btn.addEventListener('click', handler);
            }
        });
    };
    
    const setuporganiseTool = () => {
        const tool = document.getElementById('organise-tool');
        if(!tool) return;
        toolState.organise = { files: [], toolElement: tool, pageStates: [] };
        const dropZone = tool.querySelector('.drop-zone');
        const fileInput = tool.querySelector('.file-input');
        const actionBtn = tool.querySelector('.action-btn');
        const pagesGrid = tool.querySelector('#organise-pages-grid');
        const resetBtn = tool.querySelector('.reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => resetTool(tool));
        }
        const handleFile = async (file) => {
            if (!file) return;
            toolState.organise.files = [file];
            dropZone.classList.add('hidden');
            actionBtn.classList.remove('hidden');
            actionBtn.disabled = false;
            pagesGrid.classList.remove('hidden');
            showStatus(tool, 'Loading PDF pages...');
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfjsDoc = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
                toolState.organise.pdfJSDoc = pdfjsDoc;
                toolState.organise.pageStates = [];
                pagesGrid.innerHTML = '';
                for (let i = 1; i <= pdfjsDoc.numPages; i++) {
                    toolState.organise.pageStates.push({ originalIndex: i - 1, rotation: 0, deleted: false });
                    const page = await pdfjsDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.3 });
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const context = canvas.getContext('2d');
                    await page.render({ canvasContext: context, viewport }).promise;
                    const pageEl = document.createElement('div');
                    pageEl.className = 'page-thumbnail';
                    pageEl.dataset.originalIndex = i - 1;
                    pageEl.innerHTML = `
                        <canvas width="${canvas.width}" height="${canvas.height}"></canvas>
                        <div class="page-number">${i}</div>
                        <div class="page-actions">
                            <button class="rotate-btn text-white p-1" title="Rotate"><i class="fas fa-redo pointer-events-none"></i></button>
                            <button class="delete-btn text-white p-1" title="Delete"><i class="fas fa-trash pointer-events-none"></i></button>
                        </div>
                    `;
                    pageEl.querySelector('canvas').getContext('2d').drawImage(canvas, 0, 0);
                    pagesGrid.appendChild(pageEl);
                }
                Sortable.create(pagesGrid, { animation: 150, ghostClass: 'ghost' });
                showStatus(tool, 'Ready to organise. Drag pages to reorder.');
            } catch(e) {
                showStatus(tool, `Error loading PDF: ${e.message}`, true);
                resetTool(tool);
            }
        };

        // EXPOSE HANDLER
    toolState.organise.loadHandler = handleFile;
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
        pagesGrid.addEventListener('click', (e) => {
            const rotateBtn = e.target.closest('.rotate-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const pageEl = e.target.closest('.page-thumbnail');
            if (!pageEl) return;
            if (rotateBtn) {
                const originalIndex = parseInt(pageEl.dataset.originalIndex, 10);
                const state = toolState.organise.pageStates[originalIndex];
                state.rotation = (state.rotation + 90) % 360;
                pageEl.querySelector('canvas').style.transform = `rotate(${state.rotation}deg)`;
            }
            if (deleteBtn) {
                const originalIndex = parseInt(pageEl.dataset.originalIndex, 10);
                toolState.organise.pageStates[originalIndex].deleted = !toolState.organise.pageStates[originalIndex].deleted;
                pageEl.classList.toggle('deleted');
            }
        });
    };
    // Change is on the line below: handleorganise -> handleOrganise
    window.handleOrganise = async () => {
        const tool = document.getElementById('organise-tool');
        toggleButtonLoading(tool, true);
        showStatus(tool, 'Processing PDF...');
        try {
            const { files, pageStates } = toolState.organise;
            if (!files || files.length === 0) throw new Error("No PDF file loaded.");
            const pdfBytes = await files[0].arrayBuffer();
            const pdfDoc = await PDFDocument.load(pdfBytes);
            const newPdfDoc = await PDFDocument.create();
            const newOrderIndices = Array.from(tool.querySelectorAll('.page-thumbnail')).map(el => parseInt(el.dataset.originalIndex, 10));
            const finalIndicesInOrder = newOrderIndices.filter(originalIndex => !pageStates[originalIndex].deleted);
            if (finalIndicesInOrder.length === 0) throw new Error("All pages were deleted. Cannot create an empty PDF.");
            const copiedPages = await newPdfDoc.copyPages(pdfDoc, finalIndicesInOrder);
            copiedPages.forEach((page, i) => {
                const originalIndex = finalIndicesInOrder[i];
                const state = pageStates[originalIndex];
                page.setRotation(degrees(state.rotation));
                newPdfDoc.addPage(page);
            });
            const newPdfBytes = await newPdfDoc.save();
            createDownloadLink(tool, newPdfBytes, `organised_${files[0].name}`);
            showStatus(tool, 'PDF organised successfully!');
        } catch (e) {
            showStatus(tool, e.message, true);
            console.error("organise PDF Error:", e);
        } finally {
            toggleButtonLoading(tool, false);
        }
    };

    window.handleMetadata = async () => {
        const tool = document.getElementById('metadata-tool');
        toggleButtonLoading(tool, true);
        showStatus(tool, 'Saving metadata...');
        
        try {
            const file = toolState.metadata.files[0];
            const pdfDoc = await PDFDocument.load(await file.arrayBuffer());

            // Get values
            // Default to 'document' if empty to prevent saving issues
            const filenameInput = document.getElementById('meta-filename').value || 'document'; 
            
            const title = document.getElementById('meta-title').value;
            const author = document.getElementById('meta-author').value;
            const subject = document.getElementById('meta-subject').value;
            const keywords = document.getElementById('meta-keywords').value;
            const creator = document.getElementById('meta-creator').value;
            const producer = document.getElementById('meta-producer').value;
            const creationDateVal = document.getElementById('meta-creation').value;
            const modDateVal = document.getElementById('meta-mod').value;

            // Set Metadata
            if (title !== undefined) pdfDoc.setTitle(title);
            if (author !== undefined) pdfDoc.setAuthor(author);
            if (subject !== undefined) pdfDoc.setSubject(subject);
            if (keywords !== undefined) pdfDoc.setKeywords(keywords.split(',').map(k => k.trim()));
            if (creator !== undefined) pdfDoc.setCreator(creator);
            if (producer !== undefined) pdfDoc.setProducer(producer);
            
            if (creationDateVal) pdfDoc.setCreationDate(new Date(creationDateVal));
            if (modDateVal) pdfDoc.setModificationDate(new Date(modDateVal));
            else pdfDoc.setModificationDate(new Date()); // Always update mod date

            const bytes = await pdfDoc.save();
            
            // Construct new filename
            const finalFilename = filenameInput.endsWith('.pdf') ? filenameInput : `${filenameInput}.pdf`;
            createDownloadLink(tool, bytes, finalFilename);
            
            showStatus(tool, 'Metadata saved successfully!');
        } catch (e) {
            showStatus(tool, e.message, true);
            console.error(e);
        } finally {
            toggleButtonLoading(tool, false);
        }
    };
    
    window.handleUnlock = async () => {
        const tool = document.getElementById('unlock-tool');
        toggleButtonLoading(tool, true);
        showStatus(tool, 'Unlocking PDF...');
        try {
            const file = toolState.unlock.files[0];
            const password = tool.querySelector('.unlock-password').value;
            const existingPdfBytes = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(existingPdfBytes, { password });
            const newPdfDoc = await PDFDocument.create();
            const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
            copiedPages.forEach(page => newPdfDoc.addPage(page));
            const bytes = await newPdfDoc.save();
            createDownloadLink(tool, bytes, `unlocked_${file.name}`);
            showStatus(tool, 'PDF unlocked successfully!');
        } catch (e) {
            const msg = e.message.toLowerCase();
            if (msg.includes('password') || msg.includes('encrypted')) {
                 showStatus(tool, 'Incorrect password. If you are sure it is correct, the file may be corrupted. See the tip above.', true);
            } else if (msg.includes('parse')) {
                 showStatus(tool, 'Could not read the PDF file. It might be corrupted. Try the "Save as PDF" trick mentioned in the tip above.', true);
            } else {
                showStatus(tool, `An error occurred: ${e.message}`, true);
            }
        } finally {
            toggleButtonLoading(tool, false);
        }
    };
    window.handleProtect = async () => {
        const tool = document.getElementById('protect-tool');
        const password = tool.querySelector('.protect-password').value;
        const confirm = tool.querySelector('.protect-confirm-password').value;
        if(password !== confirm || !password){
            showStatus(tool, 'Passwords do not match or are empty.', true);
            return;
        }
        toggleButtonLoading(tool, true); showStatus(tool, 'Protecting PDF...');
        try {
            const file = toolState.protect.files[0];
            const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
            const bytes = await pdfDoc.save({ userPassword: password });
            createDownloadLink(tool, bytes, `protected_${file.name}`);
            showStatus(tool, 'PDF protected successfully!');
        } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    window.handleMerge = async () => {
        const tool = document.getElementById('merge-tool');
        toggleButtonLoading(tool, true); showStatus(tool, 'Merging PDFs...');
        try {
            const newPdfDoc = await PDFDocument.create();
            for(const file of toolState.merge.files){
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                copiedPages.forEach(page => newPdfDoc.addPage(page));
            }
            const bytes = await newPdfDoc.save();
            createDownloadLink(tool, bytes, 'merged.pdf');
            showStatus(tool, 'PDFs merged successfully!');
        } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    window.handleImages = async () => {
        const tool = document.getElementById('images-tool');
        toggleButtonLoading(tool, true); showStatus(tool, 'Converting images to PDF...');
        try {
            const newPdfDoc = await PDFDocument.create();
            for (const file of toolState.images.files) {
                const bytes = await file.arrayBuffer();
                const image = await (file.type === 'image/png' ? newPdfDoc.embedPng(bytes) : newPdfDoc.embedJpg(bytes));
                const page = newPdfDoc.addPage([image.width, image.height]);
                page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
            }
            const pdfBytes = await newPdfDoc.save();
            createDownloadLink(tool, pdfBytes, 'converted_images.pdf');
            showStatus(tool, 'Images converted successfully!');
        } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    window.handleRecreate = async () => {
        const tool = document.getElementById('recreate-tool');
        toggleButtonLoading(tool, true); 
        showStatus(tool, 'Re-creating book...');
        
        try {
            const file = toolState.recreate.files[0];
            const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
            const numScans = pdfDoc.getPageCount();
            const totalPages = numScans * 2;
            
            // Create the final document
            const finalPdf = await PDFDocument.create();
            
            // Pre-allocate array to hold pages in the correct 1..20 order
            const orderedPages = new Array(totalPages);

            for (let k = 0; k < numScans; k++) {
                // Copy the scan page TWICE. 
                // This creates two distinct page objects in 'finalPdf' that we can crop independently.
                const [pageL, pageR] = await finalPdf.copyPages(pdfDoc, [k, k]);
                
                const { width, height } = pageL.getMediaBox();
                
                // Set Crop for Left Half
                pageL.setCropBox(0, 0, width / 2, height);
                
                // Set Crop for Right Half
                pageR.setCropBox(width / 2, 0, width / 2, height);
                
                // --- SORTING LOGIC ---
                // Scan 0 (Even): [20 | 1]  -> Left is High (20), Right is Low (1)
                // Scan 1 (Odd):  [2 | 19]  -> Left is Low (2), Right is High (19)
                // Scan 2 (Even): [18 | 3]  -> Left is High (18), Right is Low (3)
                // ...
                
                const lowIndex = k;                 // e.g., 0, 1, 2...
                const highIndex = totalPages - 1 - k; // e.g., 19, 18, 17...

                if (k % 2 === 0) {
                    // Even scans: Right is Low, Left is High
                    orderedPages[lowIndex] = pageR;
                    orderedPages[highIndex] = pageL;
                } else {
                    // Odd scans: Left is Low, Right is High
                    orderedPages[lowIndex] = pageL;
                    orderedPages[highIndex] = pageR;
                }
            }

            // Add the pages to the document in the correct order
            for (const page of orderedPages) {
                if (page) finalPdf.addPage(page);
            }
            
            const bytes = await finalPdf.save();
            createDownloadLink(tool, bytes, `recreated_${file.name}`);
            showStatus(tool, 'Book re-created successfully!');
            
        } catch (e) { 
            showStatus(tool, e.message, true); 
            console.error(e); 
        } finally { 
            toggleButtonLoading(tool, false); 
        }
    };
    window.handleExtract = async () => {
        const tool = document.getElementById('extract-tool');
        toggleButtonLoading(tool, true); showStatus(tool, 'Extracting pages...');
        try {
            const file = toolState.extract.files[0];
            const rangeStr = tool.querySelector('.extract-pages').value;
            const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
            const pageIndices = parsePageRanges(rangeStr, pdfDoc.getPageCount());
            if (pageIndices.length === 0) throw new Error("No valid pages selected.");
            const newPdfDoc = await PDFDocument.create();
            const copiedPages = await newPdfDoc.copyPages(pdfDoc, pageIndices);
            copiedPages.forEach(page => newPdfDoc.addPage(page));
            const bytes = await newPdfDoc.save();
            createDownloadLink(tool, bytes, `extracted_${file.name}`);
            showStatus(tool, 'Pages extracted successfully!');
        } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    window.handleSplithalf = async () => {
        const tool = document.getElementById('splithalf-tool');
        toggleButtonLoading(tool, true); showStatus(tool, 'Splitting pages...');
        try {
            const file = toolState.splithalf.files[0];
            const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
            const newPdfDoc = await PDFDocument.create();
            const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
            for (const copiedPage of copiedPages) {
                const { width, height } = copiedPage.getMediaBox();
                copiedPage.setCropBox(0, 0, width / 2, height);
                const leftEmbed = await newPdfDoc.embedPage(copiedPage);
                const leftPage = newPdfDoc.addPage([width / 2, height]);
                leftPage.drawPage(leftEmbed, { x: 0, y: 0, width: width / 2, height});
                copiedPage.setCropBox(width / 2, 0, width / 2, height);
                const rightEmbed = await newPdfDoc.embedPage(copiedPage);
                const rightPage = newPdfDoc.addPage([width / 2, height]);
                rightPage.drawPage(rightEmbed, { x: 0, y: 0, width: width / 2, height});
            }
            const bytes = await newPdfDoc.save();
            createDownloadLink(tool, bytes, `split_${file.name}`);
            showStatus(tool, 'Pages split successfully!');
        } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    window.handleWatermark = async () => {
        const tool = document.getElementById('watermark-tool');
        toggleButtonLoading(tool, true); showStatus(tool, 'Adding watermark...');
        try {
            const file = toolState.watermark.files[0];
            const text = tool.querySelector('.watermark-text').value;
            const size = parseInt(tool.querySelector('.watermark-size').value, 10);
            const rotation = parseInt(tool.querySelector('.watermark-rotation').value, 10);
            const opacity = parseFloat(tool.querySelector('.watermark-opacity').value);
            const pdfDoc = await PDFDocument.load(await file.arrayBuffer(), {ignoreEncryption: true});
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            pdfDoc.getPages().forEach(page => {
                const { width, height } = page.getSize();
                page.drawText(text, {
                    x: width / 2 - (font.widthOfTextAtSize(text, size) / 2),
                    y: height / 2 - size / 2,
                    font, size,
                    color: rgb(0, 0, 0),
                    opacity,
                    rotate: degrees(rotation),
                });
            });
            const bytes = await pdfDoc.save();
            createDownloadLink(tool, bytes, `watermarked_${file.name}`);
            showStatus(tool, 'Watermark added successfully!');
        } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    window.handlePagenumbers = async () => {
         const tool = document.getElementById('pagenumbers-tool');
         toggleButtonLoading(tool, true); showStatus(tool, 'Adding page numbers...');
         try {
             const file = toolState.pagenumbers.files[0];
             const position = tool.querySelector('.pagenum-position').value;
             const size = parseInt(tool.querySelector('.pagenum-size').value, 10);
             const start = parseInt(tool.querySelector('.pagenum-start').value, 10);
             const pdfDoc = await PDFDocument.load(await file.arrayBuffer(), {ignoreEncryption: true});
             const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
             const pages = pdfDoc.getPages();
             pages.forEach((page, i) => {
                 const pageNum = i + start;
                 const { width, height } = page.getSize();
                 const text = `${pageNum}`;
                 const textWidth = font.widthOfTextAtSize(text, size);
                 let x, y;
                 const margin = 30;
                 if (position.includes('bottom')) y = margin;
                 if (position.includes('top')) y = height - size - margin;
                 if (position.includes('left')) x = margin;
                 if (position.includes('right')) x = width - textWidth - margin;
                 if (position.includes('center')) x = width / 2 - textWidth / 2;
                 page.drawText(text, { x, y, font, size, color: rgb(0,0,0) });
             });
             const bytes = await pdfDoc.save();
             createDownloadLink(tool, bytes, `numbered_${file.name}`);
             showStatus(tool, 'Page numbers added successfully!');
         } catch (e) { showStatus(tool, e.message, true); } finally { toggleButtonLoading(tool, false); }
    };
    
    window.handleStitch = async () => {
        const tool = document.getElementById('stitch-tool');
        toggleButtonLoading(tool, true);
        showStatus(tool, 'Stitching PDF...');
        try {
            const { files, splits, cuts, ends, pdfBytes } = toolState.stitch;
            if (!files || files.length === 0) throw new Error("No PDF file loaded.");
            
            const pdfDoc = await PDFDocument.load(pdfBytes);
            const RENDER_SCALE = 1.5;
            const allChunks = [];

            for (let i = 0; i < pdfDoc.getPageCount(); i++) {
                const pageNum = i + 1;
                const page = pdfDoc.getPage(i);
                const { width: pdfWidth, height: pdfHeight } = page.getSize();
                const canvasHeight = pdfHeight * RENDER_SCALE;

                const splitPoints = (splits[pageNum] || []).map(s => s.y);
                const cutPoints = (cuts[pageNum] || []).map(c => c.y);
                
                const allYPoints = [...new Set([0, canvasHeight, ...splitPoints, ...cutPoints])].sort((a, b) => a - b);
                
                for (let j = 0; j < allYPoints.length - 1; j++) {
                    const startY_internal = allYPoints[j];
                    const endY_internal = allYPoints[j + 1];

                    if (endY_internal - startY_internal < 0.1) continue;
                    
                    const midPointY = (startY_internal + endY_internal) / 2;
                    const cutLineCrossings = cutPoints.filter(cutY => cutY < midPointY).length;
                    const isCut = (cutLineCrossings % 2 === 1);

                    if (isCut) {
                        if (allChunks.length > 0 && !allChunks[allChunks.length - 1].isPageBreak) {
                            allChunks.push({ isPageBreak: true });
                        }
                        continue;
                    }
                    
                    const cropY = pdfHeight - (endY_internal / RENDER_SCALE);
                    const cropHeight = (endY_internal - startY_internal) / RENDER_SCALE;

                    allChunks.push({
                        pageIndex: i,
                        crop: { x: 0, y: cropY, width: pdfWidth, height: cropHeight }
                    });
                    
                    if (splitPoints.includes(endY_internal)) {
                        allChunks.push({ isPageBreak: true });
                    }
                }
                if (ends.has(pageNum)) {
                    if (allChunks.length > 0 && !allChunks[allChunks.length - 1].isPageBreak) {
                        allChunks.push({ isPageBreak: true });
                    }
                }
            }

            const newPdfDoc = await PDFDocument.create();
            let piecesForCurrentPage = [];

            const createPageFromPieces = async (pieces) => {
                if (pieces.length === 0) return;
                
                // Use the original pdfDoc to get page properties to avoid state issues
                const firstPiecePageIndex = pieces[0].pageIndex;
                const page_width = pdfDoc.getPage(firstPiecePageIndex).getSize().width;

                const totalHeight = pieces.reduce((sum, piece) => sum + piece.crop.height, 0);
                if (totalHeight < 1) return;
                const newPage = newPdfDoc.addPage([page_width, totalHeight]);
                let currentY = totalHeight;

                for (const piece of pieces) {
                    // --- FIX: For each piece, create a fresh copy from the original to prevent state pollution ---
                    const tempDoc = await PDFDocument.load(pdfBytes);
                    const [pageToCrop] = await newPdfDoc.copyPages(tempDoc, [piece.pageIndex]);

                    pageToCrop.setCropBox(piece.crop.x, piece.crop.y, piece.crop.width, piece.crop.height);
                    const embeddedPiece = await newPdfDoc.embedPage(pageToCrop);
                    
                    currentY -= embeddedPiece.height;
                    newPage.drawPage(embeddedPiece, { x: 0, y: currentY, width: embeddedPiece.width, height: embeddedPiece.height });
                }
            };

            for (const chunk of allChunks) {
                if (chunk.isPageBreak) {
                    await createPageFromPieces(piecesForCurrentPage);
                    piecesForCurrentPage = [];
                } else {
                    piecesForCurrentPage.push(chunk);
                }
            }
            await createPageFromPieces(piecesForCurrentPage);

            if (newPdfDoc.getPageCount() === 0) throw new Error("Stitching resulted in an empty document. Check your split/cut lines.");
            
            const newPdfBytes = await newPdfDoc.save();
            const previewBytes = new Uint8Array(newPdfBytes);
            const fullPreviewContainer = document.getElementById('stitch-full-preview-container');
            fullPreviewContainer.innerHTML = '';
            document.getElementById('stitch-full-preview').classList.remove('hidden');
            const previewPdfJS = await pdfjsLib.getDocument({ data: previewBytes }).promise;
            for (let i = 1; i <= previewPdfJS.numPages; i++) {
                const page = await previewPdfJS.getPage(i);
                const viewport = page.getViewport({ scale: 1 });
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.maxWidth = '100%';
                canvas.style.height = 'auto';
                canvas.style.border = '1px solid #ccc';
                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport }).promise;
                fullPreviewContainer.appendChild(canvas);
            }
            createDownloadLink(tool, newPdfBytes, `stitched_${files[0].name}`);
            showStatus(tool, 'Stitching complete. Review the preview below.');
        } catch (e) {
            showStatus(tool, e.message, true);
            console.error("Stitch PDF Error:", e);
        } finally {
            toggleButtonLoading(tool, false);
        }
    };
    
    window.handleCrop = async () => {
        const tool = document.getElementById('crop-tool');
        toggleButtonLoading(tool, true);
        showStatus(tool, 'Applying crop to PDF...');
        try {
            const { pdfBytes, boxes, pdfJSDoc } = toolState.crop;
            if (!pdfBytes) throw new Error("No PDF file loaded.");
            if (Object.keys(boxes).length === 0) throw new Error("No crop areas have been defined.");

            const pdfDoc = await PDFDocument.load(pdfBytes);
            const pages = pdfDoc.getPages();
            const RENDER_SCALE = 1.5;

            for (let i = 0; i < pages.length; i++) {
                const pageNum = i + 1;
                const page = pages[i];
                const box = boxes[pageNum];

                if (!box) continue; // Skip pages without a crop box

                const { width: pdfWidth, height: pdfHeight } = page.getSize();
                const pdfjsPage = await pdfJSDoc.getPage(pageNum);
                const viewport = pdfjsPage.getViewport({ scale: RENDER_SCALE });
                const canvasWidth = viewport.width;
                const canvasHeight = viewport.height;

                const scaleX = pdfWidth / canvasWidth;
                const scaleY = pdfHeight / canvasHeight;

                const cropWidth = box.width * scaleX;
                const cropHeight = box.height * scaleY;
                const cropX = box.x * scaleX;
                const cropY = pdfHeight - ((box.y + box.height) * scaleY); // Y-axis is inverted in PDF-Lib

                page.setCropBox(cropX, cropY, cropWidth, cropHeight);
            }
            
            const newPdfBytes = await pdfDoc.save();
            createDownloadLink(tool, newPdfBytes, `cropped_${toolState.crop.files[0].name}`);
            showStatus(tool, 'PDF cropped successfully!');

        } catch (e) {
            showStatus(tool, e.message, true);
            console.error("Crop PDF Error:", e);
        } finally {
            toggleButtonLoading(tool, false);
        }
    };

    window.handleAdfscanfixer = async () => {
        const tool = document.getElementById('adfscanfixer-tool');
        toggleButtonLoading(tool, true);
        showStatus(tool, 'Fixing scanned PDF...');
        try {
            const file = toolState.adfscanfixer.files[0];
            if (!file) throw new Error("No file selected.");

            const pdfBytes = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(pdfBytes);
            const pages = pdfDoc.getPages();

            for (let i = 0; i < pages.length; i++) {
    // Check if the page index is odd (i.e., page 2, 4, 6...)
    if (i % 2 !== 0) { 
        const page = pages[i];
        const currentRotation = page.getRotation().angle;
        // Rotate 180 degrees
        page.setRotation(degrees((currentRotation + 180) % 360));
    }
}

            const fixedBytes = await pdfDoc.save();
            createDownloadLink(tool, fixedBytes, `fixed_${file.name}`);
            showStatus(tool, 'Successfully fixed PDF!');
        } catch (e) {
            showStatus(tool, e.message, true);
            console.error("ADF Scan Fixer Error:", e);
        } finally {
            toggleButtonLoading(tool, false);
        }
    };


    // --- Placeholder Handlers ---
    window.handlePdftoimages = async () => {
    const tool = document.getElementById('pdftoimages-tool');
    toggleButtonLoading(tool, true);
    showStatus(tool, 'Converting pages to images...');
    
    const linksContainer = document.getElementById('pdftoimages-links');
    linksContainer.innerHTML = ''; // Clear previous results

    try {
        const file = toolState.pdftoimages.files[0];
        if (!file) throw new Error("No file selected.");

        const format = tool.querySelector('.pdftoimages-format').value; // 'image/png' or 'image/jpeg'
        const fileExt = format === 'image/jpeg' ? 'jpg' : 'png';
        
        // Use PDF.js to render the pages
        const arrayBuffer = await file.arrayBuffer();
        const pdfJsDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        for (let i = 1; i <= pdfJsDoc.numPages; i++) {
            const page = await pdfJsDoc.getPage(i);
            // Scale: 2.0 provides better quality (Retina-like) output
            const viewport = page.getViewport({ scale: 2.0 }); 
            
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({
                canvasContext: canvas.getContext('2d'),
                viewport: viewport
            }).promise;
            
            // Convert canvas to blob and create link
            const blob = await new Promise(resolve => canvas.toBlob(resolve, format));
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${file.name.replace('.pdf', '')}_page_${i}.${fileExt}`;
            link.className = "flex flex-col items-center justify-center p-3 bg-gray-100 border rounded hover:bg-indigo-50 dark:bg-gray-700 dark:hover:bg-gray-600 transition";
            link.innerHTML = `<i class="fas fa-download mb-2 text-indigo-500"></i><span class="text-xs font-bold">Page ${i}</span>`;
            
            linksContainer.appendChild(link);
        }
        
        showStatus(tool, `Success! Created ${pdfJsDoc.numPages} images below.`);
    } catch (e) {
        showStatus(tool, `Error: ${e.message}`, true);
        console.error(e);
    } finally {
        toggleButtonLoading(tool, false);
    }
};
    window.handleFlatten = async () => {
    const tool = document.getElementById('flatten-tool');
    toggleButtonLoading(tool, true);
    showStatus(tool, 'Flattening PDF...');
    try {
        const file = toolState.flatten.files[0];
        if (!file) throw new Error("No file selected.");

        const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
        const form = pdfDoc.getForm();
        
        // This collapses all form fields into standard page content
        form.flatten();
        
        const bytes = await pdfDoc.save();
        createDownloadLink(tool, bytes, `flattened_${file.name}`);
        showStatus(tool, 'PDF flattened successfully!');
    } catch (e) {
        showStatus(tool, e.message, true);
        console.error(e);
    } finally {
        toggleButtonLoading(tool, false);
    }
};
    window.handleSign = async () => { alert('This feature is not yet implemented.'); };
    const onAddSignature = () => { alert('This feature is not yet implemented.'); };
    window.handleAddtext = async () => { alert('This feature is not yet implemented.'); };
    const onAddTextBox = () => { alert('This feature is not yet implemented.'); };
    window.handleRedact = async () => { alert('This feature is not yet implemented.'); };
    const onAddRedactionBox = () => { alert('This feature is not yet implemented.'); };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        setupAllTools();
        setActivePanel('organise');
    });
</script>
</body>
</html>