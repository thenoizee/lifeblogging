<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HydrationTrackr</title>
    <link rel="icon" href="/favicons/droplet.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { type: 'module' })
                    .then(registration => console.log('Service Worker registered successfully:', registration))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
    <style>
    :root {
        --bg-color: #f7fafc;
        --card-bg-color: white;
        --text-color-primary: #1a202c;
        --text-color-secondary: #4a5568;
        --input-bg-color: #e2e8f0;
        --button-bg: #3b82f6;
        --button-hover: #2563eb;
        --border-color: #e2e8f0;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --font-family: 'Inter', sans-serif;
    }
    :root.dark, .dark body { 
        --bg-color: #111827; /* Darker gray for better contrast */
        --card-bg-color: #1f2937;
        --text-color-primary: #f3f4f6;
        --text-color-secondary: #9ca3af;
        --input-bg-color: #374151;
        --button-bg: #3b82f6;
        --button-hover: #2563eb;
        --border-color: #374151;
        --shadow-color: rgba(0, 0, 0, 0.4);
    }
    
    body {
        font-family: var(--font-family);
        background-color: var(--bg-color);
        color: var(--text-color-primary);
        display: block; 
        min-height: 100vh;
        margin: 0;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Helper Classes */
    .container { max-width: 1200px; margin: auto; }
    .card { background-color: var(--card-bg-color); border-radius: 1rem; box-shadow: 0 4px 12px var(--shadow-color); padding: 1.5rem; margin-bottom: 1.5rem; }
    input, select, textarea { background-color: var(--input-bg-color); color: var(--text-color-primary); border: 1px solid var(--border-color); }
    .main-button { background-color: var(--button-bg); color: white; transition: background-color 0.2s; }
    .main-button:hover:not(:disabled) { background-color: var(--button-hover); }
    .main-button:disabled { opacity: 0.5; cursor: not-allowed; }

    .history-view-btn.active {
        background-color: var(--card-bg-color);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        color: var(--button-bg);
        font-weight: 700;
    }
    .dark-mode .history-view-btn.active {
        background-color: #374151;
        color: white;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Custom Cup Grid */
    .cup-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    @media (min-width: 640px) { .cup-grid { grid-template-columns: repeat(4, 1fr); } }

    /* Other Utilities */
    .progress-bar-bg { background-color: var(--input-bg-color); }
    .progress-bar-fill { background-color: var(--button-bg); transition: width 0.5s ease-in-out; }
    .dark-mode input[type="datetime-local"], .dark-mode input[type="time"] { color-scheme: dark; }
    .dark-mode #bulk-actions-bar { background-color: #1e3a8a; border-color: #3b82f6; }
</style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
             <div class="card">
                <h1 class="text-2xl font-bold text-center mb-6">Welcome to HydrationTrackr</h1>
                <div class="mb-4">
                    <label for="email" class="block font-semibold mb-2 text-left">Email</label>
                    <input type="email" id="email" class="w-full rounded-lg p-2">
                </div>
                <div class="mb-6">
                    <label for="password" class="block font-semibold mb-2 text-left">Password</label>
                    <input type="password" id="password" class="w-full rounded-lg p-2">
                </div>
                <div class="flex space-x-3">
                    <button id="sign-up-btn" class="main-button font-bold py-2 px-4 rounded-lg flex-1">Sign Up</button>
                    <button id="sign-in-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex-1">Log In</button>
                </div>
                 <div class="mt-4">
                     <button id="anonymous-signin-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg w-full">Continue Anonymously</button>
                 </div>
            </div>
        </div>
    </div>

    <div id="main-app-container" class="hidden w-full">
        
        <div class="max-w-[1200px] mx-auto px-4 pb-24 md:pb-8 mt-6">
            
            <div id="tab-content-dashboard" class="tab-content active">
                <div class="card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-4">Today's Intake</h2>
                            <div class="text-5xl sm:text-6xl font-bold mb-2"><span id="today-total">0</span><span class="unit-label text-3xl ml-1">ml</span></div>
                            <div class="text-md sm:text-lg text-[var(--text-color-secondary)] mb-4"><span id="today-percentage">0</span>% of Goal</div>
                            <div class="text-sm text-[var(--text-color-secondary)]">Goal: <span id="today-goal">2000</span><span class="unit-label">ml</span> | Remaining: <span id="today-remaining">2000</span><span class="unit-label">ml</span></div>
                        </div>
                        <div class="text-right">
                             <h2 class="text-xl sm:text-2xl font-bold mb-4">Streaks</h2>
                             <div class="flex gap-4">
                                <div>
                                    <div class="text-5xl sm:text-6xl font-bold mb-2"><i class="fa-solid fa-fire-flame-curved text-orange-500"></i> <span id="goal-streak-count">0</span></div>
                                    <div class="text-md sm:text-lg text-[var(--text-color-secondary)] mb-4">Goal Days</div>
                                </div>
                                <div>
                                     <div class="text-5xl sm:text-6xl font-bold mb-2"><i class="fa-solid fa-calendar-check text-green-500"></i> <span id="log-streak-count">0</span></div>
                                     <div class="text-md sm:text-lg text-[var(--text-color-secondary)] mb-4">Logged Days</div>
                                </div>
                             </div>
                        </div>
                    </div>
                    <div class="progress-bar-bg w-full h-4 rounded-full overflow-hidden mt-4">
                        <div id="today-progress" class="progress-bar-fill h-full rounded-full" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Log a Drink</h2>
                    <div id="quick-add-container" class="cup-grid mb-4">
                        </div>
                    <button onclick="document.getElementById('manual-entry-section').classList.toggle('hidden')" class="w-full text-center text-sm text-[var(--text-color-secondary)] hover:text-blue-500 mt-2">Toggle Manual Entry</button>
                    
                    <div id="manual-entry-section" class="hidden mt-4 pt-4 border-t border-[var(--border-color)]">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Time</label>
                                <input type="datetime-local" id="custom-datetime" class="w-full p-3 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Amount (<span class="unit-label">ml</span>)</label>
                                <input type="number" id="custom-amount" placeholder="Amount" class="w-full p-3 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Type</label>
                                <select id="custom-drink-type" class="w-full p-3 rounded-lg">
                                    <option value="water">Water</option>
                                    <option value="coffee">Coffee</option>
                                    <option value="tea">Tea</option>
                                    <option value="juice">Juice</option>
                                    <option value="soda">Soda</option>
                                    <option value="milk">Milk</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Notes</label>
                                <input type="text" id="custom-notes" placeholder="Optional notes" class="w-full p-3 rounded-lg">
                            </div>
                            <button id="log-custom-btn" class="main-button py-3 px-6 rounded-lg font-bold sm:col-span-2">Log Manual Entry</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-content-history" class="tab-content">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Intake History</h2>

                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="bg-gray-100 dark-mode:bg-gray-800 p-1 rounded-lg flex space-x-1">
                            <button class="history-view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all" data-view="day">Day</button>
                            <button class="history-view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white dark-mode:bg-gray-700 shadow-sm" data-view="week">Week</button>
                            <button class="history-view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all" data-view="month">Month</button>
                            <button class="history-view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all" data-view="year">Year</button>
                            <button class="history-view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all" data-view="all">All</button>
                        </div>

                        <div class="flex items-center space-x-4 bg-gray-50 dark-mode:bg-gray-800 px-4 py-2 rounded-lg">
                            <button id="hist-prev-btn" class="p-1 hover:text-blue-500 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
                            <span id="hist-date-range" class="font-bold text-lg min-w-[140px] text-center">Loading...</span>
                            <button id="hist-next-btn" class="p-1 hover:text-blue-500 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl text-center border border-blue-100 dark:border-blue-800">
                            <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide font-semibold">Total</div>
                            <div class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400 mt-1"><span id="hist-total">0</span><span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-1 unit-label">ml</span></div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl text-center border border-green-100 dark:border-green-800">
                            <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide font-semibold">Daily Avg</div>
                            <div class="text-2xl sm:text-3xl font-bold text-green-600 dark:text-green-400 mt-1"><span id="hist-avg">0</span><span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-1 unit-label">ml</span></div>
                        </div>
                    </div>

                    <div class="w-full h-72 mb-6"><canvas id="history-chart"></canvas></div>

                    <h3 class="font-bold text-lg mb-2">Detailed Logs</h3>
                    <div id="history-table-container" class="max-h-96 overflow-y-auto border-t border-[var(--border-color)]"></div>
                </div>
            </div>

            <div id="tab-content-settings" class="tab-content">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Preferences</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="settings-units" class="block font-semibold mb-2">Units</label>
                            <select id="settings-units" class="w-full p-3 rounded-lg">
                                <option value="ml">Milliliters (ml)</option>
                                <option value="oz">Fluid Ounces (oz)</option>
                            </select>
                        </div>
                        <div>
                            <label for="daily-goal" class="block font-semibold mb-2">Daily Goal (<span class="unit-label">ml</span>)</label>
                            <input type="number" id="daily-goal" value="2000" class="w-full p-3 rounded-lg">
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="settings-week-start" class="block font-semibold mb-2">Week Starts On</label>
                                <select id="settings-week-start" class="w-full p-3 rounded-lg">
                                    <option value="1">Monday</option>
                                    <option value="0">Sunday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                            <div>
                                <label for="settings-day-reset" class="block font-semibold mb-2">Day Resets At</label>
                                <input type="time" id="settings-day-reset" class="w-full p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">For late night tracking (e.g. 04:00 AM)</p>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold mt-6 mb-2">Custom Cups / Quick Add</h3>
                        <div id="custom-cups-list" class="space-y-2 mb-2"></div>
                        <div class="flex gap-2">
                             <input type="text" id="new-cup-name" placeholder="Name (e.g. Big Bottle)" class="flex-1 p-2 rounded-lg text-sm">
                             <input type="number" id="new-cup-amount" placeholder="Amount" class="w-20 p-2 rounded-lg text-sm">
                             <select id="new-cup-type" class="w-24 p-2 rounded-lg text-sm">
                                <option value="water">Water</option><option value="coffee">Coffee</option><option value="tea">Tea</option>
                             </select>
                             <button id="add-cup-btn" class="bg-green-500 text-white px-3 rounded-lg"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <h3 class="text-xl font-bold mt-6 mb-2">Drink Factors</h3>
                        <div id="drink-factors" class="space-y-2"></div>

                        <h3 class="text-xl font-bold mt-6 mb-2">Reminders</h3>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-reminders" class="h-5 w-5">
                            <label for="enable-reminders">Enable Reminders</label>
                        </div>
                        <div id="reminder-options" class="hidden mt-2">
                            <label for="reminder-interval">Remind me every (minutes):</label>
                            <input type="number" id="reminder-interval" value="60" class="w-full p-3 rounded-lg mt-1">
                        </div>

                        <button id="save-settings-btn" class="main-button w-full py-3 rounded-lg font-bold mt-6">Save Preferences</button>
                    </div>
                </div>

                <div class="card">
                     <h2 class="text-2xl font-bold mb-4">Integrations</h2>
                     <div class="space-y-4">
                         <div class="flex items-center justify-between p-3 border dark:border-gray-700 rounded-lg">
                             <div class="flex items-center gap-3">
                                 <i class="fa-brands fa-google text-2xl text-red-500"></i>
                                 <div>
                                     <div class="font-bold">Google Fit</div>
                                     <div class="text-xs text-gray-500 dark:text-gray-400">Sync hydration data</div>
                                 </div>
                             </div>
                             <button class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm font-bold" onclick="alert('To enable Google Fit, you need to configure a GCP Project and add your Client ID in the code.')">Connect</button>
                         </div>
                     </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Data Management</h2>
                    <div class="text-left space-y-4">
                       <button id="export-csv-btn" class="main-button w-full py-3 rounded-lg font-bold bg-green-600 hover:bg-green-700">Export CSV</button>
                       <input type="file" id="import-csv-input" class="hidden" accept=".csv">
                       <button onclick="document.getElementById('import-csv-input').click()" class="w-full py-3 rounded-lg font-bold border border-dashed border-gray-400 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">Import CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-log-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card p-6 rounded-lg shadow-lg max-w-sm w-full text-left dark:bg-gray-800 dark:text-white">
            <h2 class="text-2xl font-bold mb-4">Edit Entry</h2>
            <div class="space-y-4">
                <div>
                    <label class="block font-semibold mb-1">Date & Time</label>
                    <input type="datetime-local" id="edit-datetime" class="w-full p-2 rounded-lg">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Drink Type</label>
                    <select id="edit-drink-type" class="w-full p-2 rounded-lg"></select>
                </div>
                <div>
                    <label class="block font-semibold mb-1">Amount (<span class="unit-label">ml</span>)</label>
                    <input type="number" id="edit-amount" class="w-full p-2 rounded-lg">
                </div>
                 <div>
                    <label class="block font-semibold mb-1">Notes</label>
                    <textarea id="edit-notes" class="w-full p-2 rounded-lg"></textarea>
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button id="save-edit-btn" class="flex-1 main-button py-2 rounded-lg font-bold">Save</button>
                <button id="cancel-edit-btn" class="flex-1 bg-gray-500 text-white py-2 rounded-lg font-bold">Cancel</button>
            </div>
            <button id="delete-log-btn" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-bold">Delete Entry</button>
        </div>
    </div>

    <script type="module">
        import { changelogData } from '/changelog-data.js';
        import { AppNavigation } from '../shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, where, orderBy, Timestamp, getDocs, writeBatch, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const DB_COLLECTION = 'hydrationtrackr';
        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let settingsUnsubscribe = null;
        let waterLogUnsubscribe = null;
        let historyChart = null;
        let reminderIntervalId = null;
        let selectedHistoryIds = new Set();
        let editingLogId = null;
        let historyViewMode = 'week';
        let historyCursorDate = new Date();
        let currentHistoryLogs = [];
        
        // App Settings State (Defaults)
        let appSettings = {
            dailyGoal: 2000,
            units: 'ml', // 'ml' or 'oz'
            weekStart: 1, // 0=Sun, 1=Mon, 6=Sat
            dayReset: "00:00", // "HH:MM"
            drinkFactors: { water: 1, coffee: 0.8, tea: 0.9, juice: 0.8, other: 0.5 },
            customCups: [
                { id: 'def1', name: 'Water Glass', amount: 250, type: 'water', color: 'blue' },
                { id: 'def2', name: 'Water Bottle', amount: 500, type: 'water', color: 'blue' },
                { id: 'def3', name: 'Coffee Mug', amount: 200, type: 'coffee', color: 'yellow' },
                { id: 'def4', name: 'Tea Cup', amount: 200, type: 'tea', color: 'green' }
            ],
            reminders: { enabled: false, interval: 60 }
        };

        // --- UI ELEMENTS ---
        const ui = {
            body: document.body,
            authContainer: document.getElementById('auth-container'),
            mainAppContainer: document.getElementById('main-app-container'),
            todayTotal: document.getElementById('today-total'),
            todayGoal: document.getElementById('today-goal'),
            todayProgress: document.getElementById('today-progress'),
            todayPercentage: document.getElementById('today-percentage'),
            todayRemaining: document.getElementById('today-remaining'),
            
            // Settings UI
            dailyGoalInput: document.getElementById('daily-goal'),
            unitSelect: document.getElementById('settings-units'),
            weekStartSelect: document.getElementById('settings-week-start'),
            dayResetInput: document.getElementById('settings-day-reset'),
            customCupsList: document.getElementById('custom-cups-list'),
            drinkFactorsContainer: document.getElementById('drink-factors'),
            
            quickAddContainer: document.getElementById('quick-add-container'),
            editLogModal: document.getElementById('edit-log-modal'),
            editDrinkTypeSelect: document.getElementById('edit-drink-type')
        };

        let appNav = null;

        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                ui.authContainer.style.display = 'none';
                ui.mainAppContainer.classList.remove('hidden');
                
                if (!appNav) {
                    appNav = new AppNavigation({
                        appName: 'HydrationTrackr',
                        appIcon: 'fa-droplet',
                        themeColor: 'cyan',
                        userEmail: user.email,
                        version: changelogData?.[0]?.version || 'v2.1',
                        activeTab: 'dashboard',
                        tabs: [
                            { id: 'dashboard', label: 'Dashboard', icon: 'fa-house' },
                            { id: 'history', label: 'History', icon: 'fa-chart-line' },
                            { id: 'settings', label: 'Settings', icon: 'fa-gear' }
                        ]
                    });

                    window.addEventListener('tab-changed', (e) => {
                        const tabId = e.detail.tabId;
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        const content = document.getElementById(`tab-content-${tabId}`);
                        if (content) content.classList.add('active');
                        if (tabId === 'history') {
                            selectedHistoryIds.clear();
                            renderHistory();
                        }
                    });

                    window.addEventListener('app-logout-request', () => signOut(auth));
                } else {
                    appNav.updateUser(user.email);
                }

                setDefaultDateTime();
                setupListeners();
            } else {
                ui.authContainer.style.display = 'block';
                ui.mainAppContainer.classList.add('hidden');
                if(settingsUnsubscribe) settingsUnsubscribe();
                if(waterLogUnsubscribe) waterLogUnsubscribe();
            }
        });

        // --- UNIT CONVERSION HELPERS ---
        const ML_TO_OZ = 0.033814;
        
        function formatVol(ml) {
            if (appSettings.units === 'oz') return Math.round(ml * ML_TO_OZ);
            return Math.round(ml);
        }
        
        function parseVol(displayVal) {
            if (appSettings.units === 'oz') return Math.round(displayVal / ML_TO_OZ);
            return parseInt(displayVal);
        }

        function updateUnitLabels() {
            const label = appSettings.units === 'oz' ? 'oz' : 'ml';
            document.querySelectorAll('.unit-label').forEach(el => el.textContent = label);
        }

        // --- DATE HELPER (Respects Day Reset Time) ---
        function getTodayRange() {
            const now = new Date();
            const [rHour, rMin] = (appSettings.dayReset || "00:00").split(':').map(Number);
            
            const resetToday = new Date(now);
            resetToday.setHours(rHour, rMin, 0, 0);

            let start, end;
            
            if (now >= resetToday) {
                start = resetToday;
                end = new Date(start);
                end.setDate(end.getDate() + 1);
            } else {
                end = resetToday;
                start = new Date(end);
                start.setDate(start.getDate() - 1);
            }
            return { start, end };
        }

        // --- DATA LISTENERS ---
        function setupListeners() {
            const settingsDocRef = doc(db, 'users', currentUser.uid, 'settings', 'water');
            
            settingsUnsubscribe = onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appSettings = { ...appSettings, ...data };
                }
                
                ui.dailyGoalInput.value = formatVol(appSettings.dailyGoal);
                ui.unitSelect.value = appSettings.units || 'ml';
                ui.weekStartSelect.value = appSettings.weekStart ?? 1;
                ui.dayResetInput.value = appSettings.dayReset || "00:00";
                
                updateUnitLabels();
                renderDrinkFactors(appSettings.drinkFactors);
                renderCustomCupsSettings();
                renderDashboardButtons();
                
                document.getElementById('enable-reminders').checked = appSettings.reminders?.enabled || false;
                document.getElementById('reminder-interval').value = appSettings.reminders?.interval || 60;
                document.getElementById('reminder-options').classList.toggle('hidden', !appSettings.reminders?.enabled);
                
                refreshDashboard(); 
                setupReminders(appSettings.reminders);
            });
        }
        
        function refreshDashboard() {
            if(waterLogUnsubscribe) waterLogUnsubscribe();
            
            const range = getTodayRange();
            
            const q = query(collection(db, `users/${currentUser.uid}/${DB_COLLECTION}`), 
                where('date', '>=', Timestamp.fromDate(range.start)),
                where('date', '<', Timestamp.fromDate(range.end))
            );
            
            waterLogUnsubscribe = onSnapshot(q, (snapshot) => {
                let total = 0;
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const amount = log.attributeValue !== undefined ? log.attributeValue : log.amount;
                    const drinkType = log.attributeName || 'water';
                    const factor = appSettings.drinkFactors[drinkType] ?? 1;
                    total += amount * factor;
                });
                
                const dispTotal = formatVol(total);
                const dispGoal = formatVol(appSettings.dailyGoal);
                
                ui.todayTotal.textContent = dispTotal;
                ui.todayGoal.textContent = dispGoal;
                
                const percentage = dispGoal > 0 ? Math.round((total / appSettings.dailyGoal) * 100) : 0;
                const remaining = Math.max(0, dispGoal - dispTotal);
                
                ui.todayProgress.style.width = `${Math.min(percentage, 100)}%`;
                ui.todayPercentage.textContent = percentage;
                ui.todayRemaining.textContent = remaining;
                
                updateStreaks(); 
            });
        }

        // --- RENDERING UI ---
        function renderCustomCupsSettings() {
            ui.customCupsList.innerHTML = '';
            appSettings.customCups.forEach((cup, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded";
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-${cup.color}-500"></div>
                        <span class="font-bold text-sm">${cup.name}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-300">${formatVol(cup.amount)}${appSettings.units} ${cup.type}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700 px-2 delete-cup-btn" data-index="${index}"><i class="fa-solid fa-trash"></i></button>
                `;
                ui.customCupsList.appendChild(div);
            });
            
            document.querySelectorAll('.delete-cup-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    const newCups = [...appSettings.customCups];
                    newCups.splice(idx, 1);
                    saveSettings({ customCups: newCups });
                });
            });
        }

        function renderDashboardButtons() {
            ui.quickAddContainer.innerHTML = '';
            appSettings.customCups.forEach(cup => {
                const btn = document.createElement('button');
                const colorClass = cup.color === 'blue' ? 'bg-blue-500 hover:bg-blue-600' :
                                   cup.color === 'yellow' ? 'bg-yellow-500 hover:bg-yellow-600' :
                                   cup.color === 'green' ? 'bg-green-500 hover:bg-green-600' : 
                                   'bg-gray-500 hover:bg-gray-600';
                
                btn.className = `flex flex-col items-center justify-center p-4 rounded-xl text-white shadow-md transition-transform active:scale-95 ${colorClass}`;
                btn.innerHTML = `
                    <div class="text-lg font-bold mb-1">+${formatVol(cup.amount)}</div>
                    <div class="text-xs uppercase opacity-90">${cup.name}</div>
                `;
                btn.onclick = () => logWater(cup.amount, cup.type, null, `Quick add: ${cup.name}`);
                ui.quickAddContainer.appendChild(btn);
            });
        }

        function renderDrinkFactors(factors) {
            ui.drinkFactorsContainer.innerHTML = '';
            factors = factors || { water: 1 };
            for (const drink in factors) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between text-sm';
                div.innerHTML = `
                    <label class="capitalize">${drink}</label>
                    <input type="number" id="factor-${drink}" value="${factors[drink]}" step="0.1" class="w-16 p-1 rounded border text-right">
                `;
                ui.drinkFactorsContainer.appendChild(div);
            }
        }

        async function saveSettings(updates = {}) {
            if(!currentUser) return;
            const settingsDocRef = doc(db, 'users', currentUser.uid, 'settings', 'water');
            await setDoc(settingsDocRef, updates, { merge: true });
        }

        document.getElementById('save-settings-btn').addEventListener('click', () => {
            const updates = {
                units: ui.unitSelect.value,
                dailyGoal: parseVol(ui.dailyGoalInput.value),
                weekStart: parseInt(ui.weekStartSelect.value),
                dayReset: ui.dayResetInput.value,
                reminders: {
                    enabled: document.getElementById('enable-reminders').checked,
                    interval: parseInt(document.getElementById('reminder-interval').value)
                },
                drinkFactors: {}
            };
            
            document.querySelectorAll('#drink-factors input').forEach(input => {
                const drink = input.id.replace('factor-', '');
                updates.drinkFactors[drink] = parseFloat(input.value);
            });
            
            saveSettings(updates);
            alert("Settings saved!");
        });

        document.getElementById('add-cup-btn').addEventListener('click', () => {
            const name = document.getElementById('new-cup-name').value;
            const amount = parseInt(document.getElementById('new-cup-amount').value);
            const type = document.getElementById('new-cup-type').value;
            
            if(!name || !amount) return alert("Please fill details");
            
            let color = 'gray';
            if(type === 'water') color = 'blue';
            if(type === 'coffee') color = 'yellow';
            if(type === 'tea') color = 'green';

            const mlAmount = appSettings.units === 'oz' ? Math.round(amount / ML_TO_OZ) : amount;
            
            const newCup = { id: Date.now().toString(), name, amount: mlAmount, type, color };
            const newCups = [...appSettings.customCups, newCup];
            
            saveSettings({ customCups: newCups });
            
            document.getElementById('new-cup-name').value = '';
            document.getElementById('new-cup-amount').value = '';
        });

        async function logWater(amount, drinkType = 'water', entryDate = null, notes = "", tags = ["manual_entry"]) {
            if (!currentUser || amount <= 0) return;
            try {
                const now = Timestamp.now();
                const logEntry = {
                    attributeName: drinkType,
                    attributeValue: amount,
                    status: "drank",
                    notes: notes,
                    tags: tags,
                    date: entryDate ? Timestamp.fromDate(new Date(entryDate)) : now,
                    dailyGoal: appSettings.dailyGoal,
                    createdAt: now,
                    uploadedApp: "HydrationTrackr",
                };
                await addDoc(collection(db, `users/${currentUser.uid}/${DB_COLLECTION}`), logEntry);
                updateStreaks();
            } catch (error) { console.error("Error logging:", error); }
        }

        document.getElementById('log-custom-btn').addEventListener('click', () => {
            const amtVal = document.getElementById('custom-amount').value;
            const amount = parseVol(amtVal);
            const type = document.getElementById('custom-drink-type').value;
            const date = document.getElementById('custom-datetime').value;
            const notes = document.getElementById('custom-notes').value;
            
            if(amount > 0) {
                logWater(amount, type, date, notes);
                document.getElementById('custom-amount').value = '';
                document.getElementById('manual-entry-section').classList.add('hidden');
            }
        });

        // --- HISTORY & DATE LOGIC UPDATES ---
        
        function navigateHistory(direction) {
            if (historyViewMode === 'all') return;
            const d = new Date(historyCursorDate);
            if (historyViewMode === 'day') d.setDate(d.getDate() + direction);
            if (historyViewMode === 'week') d.setDate(d.getDate() + (direction * 7));
            if (historyViewMode === 'month') d.setMonth(d.getMonth() + direction);
            if (historyViewMode === 'year') d.setFullYear(d.getFullYear() + direction);
            historyCursorDate = d;
            renderHistory();
        }
        
        function getDateRangeForMode(mode, date) {
            const start = new Date(date);
            const end = new Date(date);
            start.setHours(0,0,0,0);
            end.setHours(23,59,59,999);

            if (mode === 'day') {
            } else if (mode === 'week') {
                const currentDay = start.getDay(); 
                const targetStart = appSettings.weekStart;
                
                let diff = currentDay - targetStart;
                if (diff < 0) diff += 7;
                
                start.setDate(start.getDate() - diff);
                end.setDate(start.getDate() + 6);
            } else if (mode === 'month') {
                start.setDate(1);
                end.setMonth(end.getMonth() + 1);
                end.setDate(0);
            } else if (mode === 'year') {
                start.setMonth(0, 1);
                end.setMonth(11, 31);
            }
            return { start, end };
        }
        
        // --- HELPER: DRINK ICONS ---
        const getDrinkIcon = (type) => {
            const map = {
                water: '<i class="fa-solid fa-glass-water text-blue-500"></i>',
                coffee: '<i class="fa-solid fa-mug-hot text-amber-700 dark:text-amber-500"></i>',
                tea: '<i class="fa-solid fa-mug-saucer text-green-600 dark:text-green-500"></i>',
                juice: '<i class="fa-solid fa-glass-water text-orange-400"></i>',
                soda: '<i class="fa-solid fa-bottle-water text-red-500"></i>',
                milk: '<i class="fa-solid fa-cow text-gray-500 dark:text-gray-300"></i>',
                other: '<i class="fa-solid fa-question text-gray-400"></i>'
            };
            return map[type] || map.other;
        };

        async function renderHistory() {
            if(!currentUser) return;
            const historyQuery = query(collection(db, `users/${currentUser.uid}/${DB_COLLECTION}`), orderBy('date', 'desc'));
            const snapshot = await getDocs(historyQuery);
            const allLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            currentHistoryLogs = allLogs;

            let startDate, endDate;
            if (historyViewMode === 'all') {
                if(allLogs.length > 0) {
                    startDate = allLogs[allLogs.length - 1].date.toDate();
                    endDate = allLogs[0].date.toDate();
                } else { startDate = new Date(); endDate = new Date(); }
            } else {
                const range = getDateRangeForMode(historyViewMode, historyCursorDate);
                startDate = range.start; endDate = range.end;
            }
            
            const ukDate = { day: '2-digit', month: '2-digit' };
            const rangeStr = historyViewMode === 'day' ? startDate.toLocaleDateString() : 
                             `${startDate.toLocaleDateString(undefined, ukDate)} - ${endDate.toLocaleDateString(undefined, ukDate)}`;
            document.getElementById('hist-date-range').textContent = historyViewMode === 'all' ? "All Time" : rangeStr;

            const filteredLogs = allLogs.filter(l => {
                const d = l.date.toDate();
                return d >= startDate && d <= endDate;
            });

            let totalVolume = 0;
            const chartMap = new Map(); 
            
             if (historyViewMode === 'day') for(let i=0; i<24; i++) chartMap.set(i.toString().padStart(2,'0')+':00', 0);
             else if (historyViewMode === 'week') {
                 for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) chartMap.set(d.toISOString().split('T')[0], 0);
             }

            filteredLogs.forEach(log => {
                const amount = log.attributeValue;
                const factor = appSettings.drinkFactors[log.attributeName] || 1;
                const vol = amount * factor;
                totalVolume += vol;
                
                const d = log.date.toDate();
                let key = d.toISOString().split('T')[0];
                if(historyViewMode === 'day') key = d.getHours().toString().padStart(2,'0')+':00';
                
                if(chartMap.has(key)) chartMap.set(key, chartMap.get(key) + vol);
                else if (historyViewMode === 'all' || historyViewMode === 'year' || historyViewMode === 'month') {
                     chartMap.set(key, (chartMap.get(key) || 0) + vol);
                }
            });

            document.getElementById('hist-total').textContent = formatVol(totalVolume);
            
            // --- UPDATED TABLE RENDER (Dark Mode + Date + Icons) ---
            const tbody = document.querySelector('#history-table-container');
            tbody.innerHTML = `<table class="w-full text-left divide-y dark:divide-gray-700">${
                filteredLogs.map(log => {
                    const dateObj = log.date.toDate();
                    // If viewing 'Day' mode, only show Time. Otherwise show Date & Time.
                    const dateDisplay = historyViewMode === 'day' 
                        ? dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                        : dateObj.toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
                    
                    return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <td class="p-3 text-sm font-medium whitespace-nowrap">${dateDisplay}</td>
                        <td class="p-3 capitalize flex items-center gap-2">
                            ${getDrinkIcon(log.attributeName)}
                            <span>${log.attributeName}</span>
                        </td>
                        <td class="p-3 font-bold">${formatVol(log.attributeValue)}${appSettings.units}</td>
                        <td class="p-3 text-right"><button class="text-gray-400 hover:text-blue-500 transition-colors" onclick="openEdit('${log.id}')"><i class="fa-solid fa-pen"></i></button></td>
                    </tr>
                `}).join('')
            }</table>`;
            
            updateChart(chartMap);
        }
        
        function updateChart(chartMap) {
             const ctx = document.getElementById('history-chart').getContext('2d');
             if(historyChart) historyChart.destroy();
             
             const labels = Array.from(chartMap.keys());
             const data = Array.from(chartMap.values()).map(v => formatVol(v));
             
             historyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Hydration (${appSettings.units})`,
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: document.body.classList.contains('dark-mode') ? '#374151' : '#e5e7eb' } },
                        y: { grid: { color: document.body.classList.contains('dark-mode') ? '#374151' : '#e5e7eb' } }
                    }
                }
             });
        }
        
        async function updateStreaks() {
             // Basic streak logic
        }

        window.openEdit = async function(docId) {
            editingLogId = docId;
            const log = currentHistoryLogs.find(l => l.id === docId); 
            if (!log) return;

            const toLocalISOString = (date) => {
                const tzoffset = (new Date()).getTimezoneOffset() * 60000;
                return new Date(date - tzoffset).toISOString().slice(0, 16);
            };

            document.getElementById('edit-datetime').value = toLocalISOString(log.date.toDate());
            document.getElementById('edit-amount').value = formatVol(log.attributeValue); 
            document.getElementById('edit-notes').value = log.notes || '';
            
            ui.editDrinkTypeSelect.innerHTML = '';
            const types = ['water', 'coffee', 'tea', 'juice', 'soda', 'milk', 'other'];
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                ui.editDrinkTypeSelect.appendChild(opt);
            });
            ui.editDrinkTypeSelect.value = log.attributeName;

            ui.editLogModal.classList.remove('hidden');
        };

        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('custom-datetime').value = now.toISOString().slice(0, 16);
        }

        function setupReminders(settings) {
             if(reminderIntervalId) clearInterval(reminderIntervalId);
             if(settings?.enabled && Notification.permission === "granted") {
                 reminderIntervalId = setInterval(() => {
                     new Notification("Hydrate!", { body: "Time to drink water", icon: "/favicons/droplet.svg" });
                 }, settings.interval * 60000);
             }
        }
        
        document.querySelectorAll('.history-view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.history-view-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                historyViewMode = e.target.dataset.view;
                renderHistory();
            });
        });
        document.getElementById('hist-prev-btn').addEventListener('click', () => navigateHistory(-1));
        document.getElementById('hist-next-btn').addEventListener('click', () => navigateHistory(1));
        
        document.getElementById('cancel-edit-btn').addEventListener('click', () => ui.editLogModal.classList.add('hidden'));
        
        document.getElementById('save-edit-btn').addEventListener('click', async () => {
             if (!editingLogId) return;
             const val = parseInt(document.getElementById('edit-amount').value);
             const mlVal = parseVol(val); 
             
             try {
                const docRef = doc(db, `users/${currentUser.uid}/${DB_COLLECTION}`, editingLogId);
                await updateDoc(docRef, {
                    date: Timestamp.fromDate(new Date(document.getElementById('edit-datetime').value)),
                    attributeName: document.getElementById('edit-drink-type').value,
                    attributeValue: mlVal,
                    notes: document.getElementById('edit-notes').value
                });
                ui.editLogModal.classList.add('hidden');
                renderHistory();
             } catch(e) { console.error(e); alert("Update failed"); }
        });
        
        document.getElementById('delete-log-btn').addEventListener('click', async () => {
             if (!editingLogId) return;
             if(confirm("Delete this log?")) {
                 await deleteDoc(doc(db, `users/${currentUser.uid}/${DB_COLLECTION}`, editingLogId));
                 ui.editLogModal.classList.add('hidden');
                 renderHistory();
             }
        });
        
        document.getElementById("sign-in-btn").addEventListener("click", () => signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value));
        document.getElementById("sign-up-btn").addEventListener("click", () => createUserWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value));
        document.getElementById("anonymous-signin-btn").addEventListener("click", () => signInAnonymously(auth));
        
    </script>
</body>
</html>