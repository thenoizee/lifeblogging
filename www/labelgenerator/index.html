<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printing Label Generator</title>
    <link rel="icon" href="/favicons/print.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&family=Roboto+Mono&family=Lora&family=Merriweather&family=Playfair+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper-width: 210mm;
            --paper-height: 297mm;
            --label-width: 80mm;
            --label-height: 50mm;
            --corner-radius: 0mm;
            --margin-top: 10mm;
            --margin-left: 10mm;
            --grid-row-gap: 2mm;
            --grid-column-gap: 2mm;
            --grid-justify-content: start;
            --grid-align-content: start;
            --cols: 2;
            --font-size: 12pt;
            --font-family: 'Inter', sans-serif;
            --align-items: center; /* vertical text align in label */
            --justify-content: center; /* horizontal text align in label */
            --font-weight: normal;
            --font-style: normal;
        }

        #print-area { position: fixed; top: -9999px; left: -9999px; }
        body { font-family: 'Inter', sans-serif; }
        
        #label-grid-container {
            /* Remove the border-right and border-bottom entirely */
        }

        /* Common styles for both on-screen and print pages */
        #label-grid, .print-page {
            display: grid;
            grid-template-columns: repeat(var(--cols), var(--label-width));
            justify-content: var(--grid-justify-content);
            align-content: var(--grid-align-content);
            row-gap: var(--grid-row-gap);
            column-gap: var(--grid-column-gap);
            background-color: white;
            width: var(--paper-width);
            height: var(--paper-height);
            padding-top: var(--margin-top);
            padding-bottom: var(--margin-top);
            padding-left: var(--margin-left);
            padding-right: var(--margin-left);
            box-sizing: border-box;
        }

        #label-grid {
             box-shadow: 0 4px 12px rgba(0,0,0,0.1);
             overflow: hidden;
        }

        .label {
            height: var(--label-height);
            /* Remove border-top and border-left */
            outline: 1px solid #ddd;        /* Add this */
            outline-offset: -1px;           /* Add this */
            border-radius: var(--corner-radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: var(--align-items);
            justify-content: var(--justify-content);
            padding: 2mm;
            box-sizing: border-box;
            font-size: var(--font-size);
            font-family: var(--font-family);
            font-weight: var(--font-weight);
            font-style: var(--font-style);
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
            text-align: var(--justify-content);
        }
        
        .label::before {
            content: attr(data-label-number);
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 8pt;
            color: #aaa;
            font-family: 'Roboto Mono', monospace;
            pointer-events: none; /* <--- ADD THIS LINE */
        }

        /* Update/Add to your CSS */
.label:not(.selected) .btn-deselect { 
    display: none; 
}

.btn-clear {
    display: none; /* Hidden by default */
}
.label.has-override .btn-clear { 
    display: flex; /* Show only if label has manual text */
}
        
        .label.has-template::before {
            display: none;
        }
        
        .label[contenteditable=true] {
            cursor: text;
        }

        .label.selected {
            background-color: #e0f2fe;
            border-color: #0ea5e9;
        }
        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }
        
        /* Wizard Tab Styles */
        .tab-button.active {
            border-color: #0ea5e9;
            background-color: #f0f9ff;
            color: #0369a1;
            font-weight: 600;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }

        /* Add to <style> block */
.label-controls {
    position: absolute;
    top: 2px;
    right: 2px;
    display: flex;
    gap: 4px;
    z-index: 50;
    opacity: 0;
    transition: opacity 0.2s;
}
.label:hover .label-controls, .label.selected .label-controls {
    opacity: 1;
}


/* --- NEW CSS FIXES --- */

/* 1. Isolates the editable text so controls don't interfere */
.label-content {
    outline: none;       /* Removes the blue border from the text box itself */
    min-width: 100%;     /* Ensures it spans the full width for typing */
    z-index: 1;          /* Sits below controls */
}

/* 2. Visual cue when you are actually editing */
.label-content:focus {
    /* Optional: adds a subtle background to show active editing */
    background-color: rgba(255, 255, 255, 0.5); 
}

/* 3. Ensures the "1", "2" label numbers don't block your click */
.label::before {
    pointer-events: none;
}
.btn-control {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    font-weight: bold;
    user-select: none;
    background: white;
    border: 1px solid #ddd;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.btn-deselect {
    color: #64748b; /* Slate-500 */
}
.btn-deselect:hover {
    background-color: #f1f5f9;
    color: #0f172a;
}
.btn-clear {
    color: #ef4444; /* Red-500 */
    border-color: #fecaca;
    background-color: #fef2f2;
}
.btn-clear:hover {
    background-color: #fee2e2;
    border-color: #ef4444;
}
@media print {
    .label-controls { display: none !important; }
}

        /* Visual Grid Alignment Styles */
        #gridAlignmentIcons button::after {
            content: 'â€¢';
            font-size: 1.5rem;
            line-height: 1;
            color: #9ca3af;
        }
        #gridAlignmentIcons button[data-active="true"] {
            background-color: #e0f2fe;
            border-color: #0ea5e9;
        }
        #gridAlignmentIcons button[data-active="true"]::after {
            color: #0ea5e9;
        }
        #gridAlignmentIcons button[data-value="start start"] { justify-self: start; align-self: start; }
        #gridAlignmentIcons button[data-value="start center"] { justify-self: center; align-self: start; }
        #gridAlignmentIcons button[data-value="start end"] { justify-self: end; align-self: start; }
        #gridAlignmentIcons button[data-value="center start"] { justify-self: start; align-self: center; }
        #gridAlignmentIcons button[data-value="center center"] { justify-self: center; align-self: center; }
        #gridAlignmentIcons button[data-value="center end"] { justify-self: end; align-self: center; }
        #gridAlignmentIcons button[data-value="end start"] { justify-self: start; align-self: end; }
        #gridAlignmentIcons button[data-value="end center"] { justify-self: center; align-self: end; }
        #gridAlignmentIcons button[data-value="end end"] { justify-self: end; align-self: end; }
        #gridAlignmentIcons button { display: flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; }

        /* Add this to your existing CSS */
        .remove-override {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #fee2e2; /* Red-100 */
            color: #ef4444;       /* Red-500 */
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50;
            user-select: none;
        }
        .label.selected:hover .remove-override {
            opacity: 1;
        }
        
        /* Ensure it hides during printing */
        @media print {
            .remove-override { display: none !important; }
        }

        @page { size: auto; margin: 0mm; }

        @media print {
            #app { display: none; }
            body { margin: 0; background-color: #fff; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
            }
            .print-page { 
                page-break-after: always; 
                margin: 0 auto;
                height: var(--paper-height);
            }
            #print-area .label::before { display: none; }
            .print-label { border: 1px solid transparent; page-break-inside: avoid; }
            .print-label.not-selected { visibility: hidden; }
            #print-area.print-borders-on .print-label.has-content { border: 1px dashed #999; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="flex flex-col lg:flex-row min-h-screen">
        <div id="controls" class="w-full lg:w-96 bg-white shadow-lg p-6 space-y-4 overflow-y-auto">
            <h1 class="text-2xl font-bold text-gray-900 mb-4">Printing Label Generator</h1>
            
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex -mb-px space-x-1" id="wizard-tabs">
                    <button class="tab-button active text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-2 border-b-2" data-tab="step1">1. Template</button>
                    <button class="tab-button text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-2 border-b-2" data-tab="step2">2. Layout</button>
                    <button class="tab-button text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-2 border-b-2" data-tab="step3">3. Content</button>
                    <button class="tab-button text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-2 border-b-2" data-tab="step4">4. Print</button>
                </nav>
            </div>

            <div id="wizard-panels">
                <div id="tab-step1" class="tab-panel active space-y-4">
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-lg font-semibold mb-3">Template Setup</h2>
                        <div class="space-y-3">
                            <div>
                                <label for="templateType" class="block text-sm font-medium text-gray-700">Template Type</label>
                                <select id="templateType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500">
                                    <option value="labelSheet">Label Sheet</option>
                                    <option value="suspensionTab">Suspension File Tab</option>
                                    <option value="envelope">Envelope</option>
                                </select>
                            </div>
                            <div>
                                <label for="presets" class="block text-sm font-medium text-gray-700">Presets</label>
                                <div class="flex space-x-2">
                                    <select id="presets" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></select>
                                    <button id="savePresetButton" class="mt-1 px-3 py-1 text-sm bg-sky-500 text-white rounded-md shadow-sm hover:bg-sky-600 transition duration-150">Save</button>
                                </div>
                                <div class="flex justify-between items-start mt-2">
                                    <div id="presetPreview" class="text-xs text-gray-500 flex-1"></div>
                                    <button id="resetTemplateBtn" class="text-xs text-red-600 hover:text-red-800 underline py-1">Reset to Default</button>
                                </div>
                            </div>
                            <div id="envelopeControls" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="envelopeWidth" class="block text-sm font-medium text-gray-700">Width (mm)</label><input type="number" id="envelopeWidth" value="220" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                    <div><label for="envelopeHeight" class="block text-sm font-medium text-gray-700">Height (mm)</label><input type="number" id="envelopeHeight" value="110" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                </div>
                            </div>
                            <div id="suspensionTabControls" class="hidden pt-2">
                                <div class="flex items-center">
                                    <input id="printCutLines" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500"><label for="printCutLines" class="ml-2 block text-sm font-medium text-gray-700">Print cut lines</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-step2" class="tab-panel space-y-4">
                    <div id="labelSheetControls" class="space-y-4">
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h2 class="text-lg font-semibold mb-3">Paper & Margins</h2>
                            <div class="space-y-3">
                                <div><label for="paperSize" class="block text-sm font-medium text-gray-700">Paper Size</label><select id="paperSize" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="A4">A4 (210 x 297mm)</option><option value="Letter">US Letter (8.5 x 11in)</option></select></div>
                                <div><label for="orientation" class="block text-sm font-medium text-gray-700">Orientation</label><select id="orientation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="portrait">Portrait</option><option value="landscape">Landscape</option></select></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="marginTop" class="block text-sm font-medium text-gray-700">Margin Top (mm)</label><input type="number" id="marginTop" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                    <div><label for="marginLeft" class="block text-sm font-medium text-gray-700">Margin Left (mm)</label><input type="number" id="marginLeft" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h2 class="text-lg font-semibold mb-3">Grid Layout</h2>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="rows" class="block text-sm font-medium text-gray-700">Rows</label><input type="number" id="rows" value="4" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                    <div><label for="cols" class="block text-sm font-medium text-gray-700">Columns</label><input type="number" id="cols" value="2" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="gridRowGap" class="block text-sm font-medium text-gray-700">Vertical Gap (mm)</label><input type="number" id="gridRowGap" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                    <div><label for="gridColumnGap" class="block text-sm font-medium text-gray-700">Horizontal Gap (mm)</label><input type="number" id="gridColumnGap" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Grid Alignment</label>
                                    <div id="gridAlignmentIcons" class="mt-1 grid grid-cols-3 gap-1 w-24">
                                        <button data-value="start start" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Top Left"></button>
                                        <button data-value="start center" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Top Center"></button>
                                        <button data-value="start end" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Top Right"></button>
                                        <button data-value="center start" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Middle Left"></button>
                                        <button data-value="center center" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Center"></button>
                                        <button data-value="center end" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Middle Right"></button>
                                        <button data-value="end start" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Bottom Left"></button>
                                        <button data-value="end center" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Bottom Center"></button>
                                        <button data-value="end end" class="border p-2 hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500" title="Bottom Right"></button>
                                    </div>
                                </div>
                                <div><label for="startPosition" class="block text-sm font-medium text-gray-700">Start filling at Label #</label><input type="number" id="startPosition" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                <p class="text-xs text-gray-500">Used for CSV/Serial import on partial sheets.</p>
                                
                                <div id="manualGridPreview" class="pt-4 mt-2 border-t border-gray-200 text-xs text-gray-500 w-full flex flex-col items-center"></div>

                            </div>
                        </div>
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h2 class="text-lg font-semibold mb-3">Label Size (mm)</h2>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Layout Mode</label>
                                    <div class="mt-1 flex space-x-4">
                                        <div class="flex items-center">
                                            <input id="layoutModeGrid" name="layoutMode" type="radio" value="grid" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500" checked>
                                            <label for="layoutModeGrid" class="ml-2 block text-sm text-gray-900">Define by Grid (Rows/Cols)</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="layoutModeLabel" name="layoutMode" type="radio" value="label" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                                            <label for="layoutModeLabel" class="ml-2 block text-sm text-gray-900">Define by Label Size</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="labelWidth" class="block text-sm font-medium text-gray-700">Width</label><input type="number" id="labelWidth" value="80" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                    <div><label for="labelHeight" class="block text-sm font-medium text-gray-700">Height</label><input type="number" id="labelHeight" value="50" min="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                </div>
                                <div class="mt-3"><label for="cornerRadius" class="block text-sm font-medium text-gray-700">Corner Radius (mm)</label><input type="number" id="cornerRadius" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-step3" class="tab-panel space-y-4">
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-lg font-semibold mb-3">Typography & Alignment</h2>
                        <div class="space-y-3">
                            <div><label for="fontFamily" class="block text-sm font-medium text-gray-700">Font</label>
                                <select id="fontFamily" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500">
                                    <option value="'Inter', sans-serif" selected>Inter (Sans-serif)</option>
                                    <option value="'Montserrat', sans-serif">Montserrat (Sans-serif)</option>
                                    <option value="'Lora', serif">Lora (Serif)</option>
                                    <option value="'Merriweather', serif">Merriweather (Serif)</option>
                                    <option value="'Playfair Display', serif">Playfair Display (Serif)</option>
                                    <option value="'Roboto Mono', monospace">Roboto Mono (Monospace)</option>
                                    <option value="Arial, sans-serif">Arial</option>
                                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="fontSize" class="block text-sm font-medium text-gray-700">Font Size (pt)</label><input type="number" id="fontSize" value="12" min="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"></div>
                                <div class="flex items-end space-x-2">
                                    <button id="fontBold" class="p-2 rounded-md border bg-white hover:bg-sky-100 data-[active=true]:bg-sky-500 data-[active=true]:text-white" data-active="false"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg></button>
                                    <button id="fontItalic" class="p-2 rounded-md border bg-white hover:bg-sky-100 data-[active=true]:bg-sky-500 data-[active=true]:text-white" data-active="false"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="vAlign" class="block text-sm font-medium text-gray-700">Vertical</label><select id="vAlign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="flex-start">Top</option><option value="center" selected>Middle</option><option value="flex-end">Bottom</option></select></div>
                                <div><label for="hAlign" class="block text-sm font-medium text-gray-700">Horizontal</label><select id="hAlign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="flex-start">Left</option><option value="center" selected>Center</option><option value="flex-end">Right</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-lg font-semibold mb-3">Content & Data (Field Mapping)</h2>
                        <div class="space-y-3">
                            <div id="csvDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-sky-50 transition-colors cursor-pointer">
                                <label for="csvFile" class="block text-sm font-medium text-gray-700 pointer-events-none">Import Data (CSV)</label>
                                <p class="text-xs text-gray-500 mb-3 mt-1 pointer-events-none">Drag and drop your file here, or click to browse.</p>
                                <input type="file" id="csvFile" accept=".csv" class="hidden"/>
                                <button id="browseCsvBtn" class="text-sm px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 pointer-events-none">Browse Files</button>
                                <p id="csvFileName" class="text-xs text-sky-600 mt-2 font-medium"></p>
                                <div class="flex items-center justify-center mt-4">
                                    <input id="csvHasHeader" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500" onclick="event.stopPropagation()">
                                    <label for="csvHasHeader" class="ml-2 block text-sm font-medium text-gray-700" onclick="event.stopPropagation()">First row is a header</label>
                                </div>
                            </div>
                            <details id="serializationGroup" class="pt-2 border-t mt-4">
                                <summary class="text-sm font-medium text-gray-700 cursor-pointer">Auto-Increment / Serial ({{SERIAL}})</summary>
                                <div class="grid grid-cols-3 gap-2 pt-2">
                                    <div><label for="serialStart" class="block text-xs font-medium text-gray-500">Start</label><input type="number" id="serialStart" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                                    <div><label for="serialEnd" class="block text-xs font-medium text-gray-500">End (Max)</label><input type="number" id="serialEnd" value="20" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                                    <div><label for="serialIncrement" class="block text-xs font-medium text-gray-500">Increment</label><input type="number" id="serialIncrement" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Overrides CSV data if serial range is larger.</p>
                            </details>
                            
                            <div class="pt-2 border-t mt-4">
                                <label for="contentTemplate" class="block text-sm font-medium text-gray-700">Content Template (Manual Text & Fields)</label>
                                <p class="text-xs text-gray-500 mb-1">Use <code>{{FIELD_NAME}}</code>, <code>{{COL1}}</code>, or <code>{{SERIAL}}</code>. Use <code>&lt;br&gt;</code> for new lines. **Or, type directly into the first label on the grid.**</p>
                                <textarea id="contentTemplate" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm font-mono text-sm focus:border-sky-500 focus:ring-sky-500" placeholder="Example: My Product Label&#10;Date: 2024-01-01&#10;Serial: {{SERIAL}}&#10;{{BARCODE:COL1}}"></textarea>
                                <p class="text-xs text-gray-500 mt-1">For a Barcode, use <code>{{BARCODE:FIELD_NAME}}</code>.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-step4" class="tab-panel space-y-4">
                    <div class="space-y-4 pt-4">
                        <p class="text-sm text-gray-600">Select/deselect labels in the preview grid. Only selected labels will be printed.</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="selectAll" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Select All</button>
                            <button id="deselectAll" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Deselect All</button>
                            <button id="clearManual" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 mt-2 col-span-2">Clear Manual Edits</button>
                        </div>
                        <button id="printButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h8a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>Print Selected Labels</button>
                        
                        <button id="exportPdfButton" class="w-full flex justify-center py-3 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 mt-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>Export as PDF</button>
                    </div>
                </div>
            </div>
        </div>
        <main class="flex-1 p-8 bg-gray-200 flex items-start justify-center overflow-auto"><div id="label-grid-container"><div id="label-grid"></div></div></main>
    </div>
    <div id="print-area"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION (NOW POPULATED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        // Initialize Firebase
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = typeof firebase !== 'undefined' ? firebase.firestore() : null;
        let currentUserId = null; 
        // --- END FIREBASE CONFIGURATION ---

        document.addEventListener('DOMContentLoaded', () => {
            const controls = {
                templateType: document.getElementById('templateType'), presets: document.getElementById('presets'),
                savePresetButton: document.getElementById('savePresetButton'),
                labelSheetControls: document.getElementById('labelSheetControls'), envelopeControls: document.getElementById('envelopeControls'),
                suspensionTabControls: document.getElementById('suspensionTabControls'), printCutLines: document.getElementById('printCutLines'),
                paperSize: document.getElementById('paperSize'), orientation: document.getElementById('orientation'),
                marginTop: document.getElementById('marginTop'), marginLeft: document.getElementById('marginLeft'),
                rows: document.getElementById('rows'), cols: document.getElementById('cols'),
                gridRowGap: document.getElementById('gridRowGap'), gridColumnGap: document.getElementById('gridColumnGap'),
                startPosition: document.getElementById('startPosition'), labelWidth: document.getElementById('labelWidth'),
                labelHeight: document.getElementById('labelHeight'),
                layoutModeGrid: document.getElementById('layoutModeGrid'),
                layoutModeLabel: document.getElementById('layoutModeLabel'), 
                cornerRadius: document.getElementById('cornerRadius'),
                envelopeWidth: document.getElementById('envelopeWidth'), envelopeHeight: document.getElementById('envelopeHeight'),
                fontFamily: document.getElementById('fontFamily'), fontSize: document.getElementById('fontSize'),
                fontBold: document.getElementById('fontBold'), fontItalic: document.getElementById('fontItalic'),
                vAlign: document.getElementById('vAlign'), hAlign: document.getElementById('hAlign'),
                contentTemplate: document.getElementById('contentTemplate'),
                csvFile: document.getElementById('csvFile'),
                csvHasHeader: document.getElementById('csvHasHeader'),
                serialStart: document.getElementById('serialStart'),
                serialEnd: document.getElementById('serialEnd'),
                serialIncrement: document.getElementById('serialIncrement'),
            };

            document.getElementById('resetTemplateBtn').addEventListener('click', () => {
                if(confirm("Reset layout settings to default?")) {
                    controls.templateType.value = 'labelSheet';
                    controls.templateType.dispatchEvent(new Event('input'));
                    applyPreset('avery_L7163');
                    controls.presets.value = 'avery_L7163';
                }
            });


            const actions = { 
                selectAll: document.getElementById('selectAll'), 
                deselectAll: document.getElementById('deselectAll'), 
                printButton: document.getElementById('printButton'),
                exportPdfButton: document.getElementById('exportPdfButton') // Add this
            };
            const labelGrid = document.getElementById('label-grid');
            const root = document.documentElement;
            
            const wizardTabs = document.getElementById('wizard-tabs');
            const wizardPanels = document.getElementById('wizard-panels');
            const gridAlignmentIcons = document.getElementById('gridAlignmentIcons');
            let gridAlignmentValue = 'start start'; // Default value


    // --- State Variables ---
    let labelData = []; 
    let csvHeader = []; 
    let manualOverrides = {}; 
    
    // --- Undo/Redo System ---
    const historyStack = [];
    let historyPointer = -1;
    let historyDebounceTimer = null;

    // --- Reset Template Logic ---
    const resetBtn = document.getElementById('resetTemplateBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if(confirm("Reset layout settings to default?")) {
                controls.templateType.value = 'labelSheet';
                controls.templateType.dispatchEvent(new Event('input'));
                applyPreset('avery_L7163');
                controls.presets.value = 'avery_L7163';
            }
        });
    }

    // --- Dynamic Thumbnail Generator ---
    const renderThumbnails = () => {
        const type = controls.templateType.value;
        const presetPrev = document.getElementById('presetPreview');
        const manualPrev = document.getElementById('manualGridPreview');

        if (type === 'envelope') {
            if (presetPrev) presetPrev.innerHTML = '';
            if (manualPrev) manualPrev.innerHTML = '';
            return;
        }

        const r = parseInt(controls.rows.value, 10) || 1;
        const c = parseInt(controls.cols.value, 10) || 1;
        const w = parseFloat(controls.labelWidth.value) || 1;
        const h = parseFloat(controls.labelHeight.value) || 1;
        const total = r * c;

        // Draw the mini grid using CSS
        let html = `<div style="display:grid; grid-template-columns: repeat(${c}, 1fr); gap: 1px; width: 60px; background: #cbd5e1; border: 1px solid #cbd5e1; padding: 1px; margin-bottom: 4px;">`;
        for(let i=0; i<Math.min(total, 100); i++) {
            html += `<div style="background: white; aspect-ratio: ${w}/${h};"></div>`;
        }
        html += `</div><p>${r} x ${c} (${total} labels)</p>`;

        if (presetPrev) presetPrev.innerHTML = html;
        if (manualPrev) manualPrev.innerHTML = html; // Syncs to Tab 2 as well
    };

    const saveHistory = () => {
        // Remove any future history if we are in the middle of the stack
        if (historyPointer < historyStack.length - 1) {
            historyStack.splice(historyPointer + 1);
        }
        // Deep copy the current state
        historyStack.push(JSON.stringify(manualOverrides));
        historyPointer++;
        
        // Limit stack size (optional, e.g., 50 steps)
        if (historyStack.length > 50) {
            historyStack.shift();
            historyPointer--;
        }
    };

    const undo = () => {
        if (historyPointer > 0) {
            historyPointer--;
            manualOverrides = JSON.parse(historyStack[historyPointer]);
            renderPreview();
        }
    };

    const redo = () => {
        if (historyPointer < historyStack.length - 1) {
            historyPointer++;
            manualOverrides = JSON.parse(historyStack[historyPointer]);
            renderPreview();
        }
    };

    document.getElementById('clearManual').addEventListener('click', () => {
        if (confirm("Are you sure you want to remove all manual text changes?")) {
            manualOverrides = {};
            saveHistory(); // Save the empty state
            renderPreview();
        }
    });

    // Save initial empty state
    saveHistory();

    

            
            const PRESETS = {
                labelSheet: {
                    'Avery (A4)': {
                         'avery_L7160': { name: 'L7160 (63.5x38.1mm)', paper: 'A4', rows: 7, cols: 3, width: 63.5, height: 38.1, marginTop: 15, marginLeft: 7.5, rowGap: 0, colGap: 2.5, cornerRadius: 0 },
                         'avery_L7163': { name: 'L7163 (99.1x38.1mm)', paper: 'A4', rows: 7, cols: 2, width: 99.1, height: 38.1, marginTop: 14.9, marginLeft: 5.4, rowGap: 0, colGap: 0, cornerRadius: 0 },
                    },
                    'Avery (US Letter)': {
                        'avery_5160': { name: '5160 (2.625"x1")', paper: 'Letter', rows: 10, cols: 3, width: 66.675, height: 25.4, marginTop: 12.7, marginLeft: 4.76, rowGap: 0, colGap: 3.175, cornerRadius: 0 },
                        'avery_5163': { name: '5163 (4"x2")', paper: 'Letter', rows: 5, cols: 2, width: 101.6, height: 50.8, marginTop: 12.7, marginLeft: 5.56, rowGap: 0, colGap: 0, cornerRadius: 0 },
                    },
                    'Custom...': { 'custom': { name: 'Custom...' } },
                },
                suspensionTab: {
                    'Print on...': {
                        'custom': { name: 'Custom...' },
                        'grid_a4_card': { name: 'Grid on A4 Card', paper: 'A4', orientation: 'portrait', rows: 17, cols: 3, width: 50, height: 15, marginTop: 4.5, marginLeft: 5, rowGap: 2, colGap: 2, cornerRadius: 0 },
                        'prepunched_a4_sheet': { name: 'Pre-punched A4 Sheet (Example)', paper: 'A4', orientation: 'portrait', rows: 10, cols: 1, width: 50, height: 15, marginTop: 23.5, marginLeft: 80, rowGap: 14.7, colGap: 0, cornerRadius: 0 }
                    }
                },
                envelope: {
                    'Common Sizes': {
                        'dl': { name: 'DL (220 x 110mm)', width: 220, height: 110 },
                        'c5': { name: 'C5 (229 x 162mm)', width: 229, height: 162 },
                        'us_10': { name: 'US #10 (104.8 x 241.3mm)', width: 241.3, height: 104.8 },
                        'custom': { name: 'Custom...', width: 220, height: 110 },
                    }
                }
            };
            
            // --- FIREBASE AUTH LISTENER ---
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        currentUserId = user.uid;
                        populatePresets(); 
                    } else {
                        currentUserId = null;
                        populatePresets(); 
                    }
                });
            } else {
                 populatePresets(); 
            }
            // --- END FIREBASE AUTH LISTENER ---

            const generateLabelContent = (data, index) => {
                let template = controls.contentTemplate.value || '';
                
                // Use MANUAL_CONTENT if it exists (for pure manual mode)
                if (data && data.MANUAL_CONTENT !== undefined) {
                    template = data.MANUAL_CONTENT;
                }
                
                if (!template) return '';

                let content = template.replace(/\r/g, '').replace(/\n/g, '<br>');
                const serialNum = data && data.SERIAL !== undefined ? data.SERIAL : '';

                if (data) {
                    for (const key in data) {
                        const value = data[key];
                        if (key === 'SERIAL' || key === 'MANUAL_CONTENT') continue;

                        content = content.replace(new RegExp(`{{${key}}}`, 'g'), value);
                        
                        const barcodeMatch = content.match(new RegExp(`{{BARCODE:${key}}}`, 'i'));
                        if (barcodeMatch) {
                             content = content.replace(new RegExp(`{{BARCODE:${key}}}`, 'i'), `<svg class="barcode" data-value="${value}" style="width: 100%; height: auto;"></svg>`);
                        }
                    }
                }
                
                content = content.replace(new RegExp(`{{SERIAL}}`, 'g'), serialNum);

                // Remove any un-replaced tags
                content = content.replace(/{{[^{}]*}}/g, '');

                return content;
            };

            const generateDataArray = () => {
                const start = parseInt(controls.serialStart.value, 10);
                const end = parseInt(controls.serialEnd.value, 10);
                const increment = parseInt(controls.serialIncrement.value, 10);
                const templateUsesSerial = controls.contentTemplate.value.includes('{{SERIAL}}');
                
                let serialData = [];
                if (templateUsesSerial) {
                    for (let i = start; i <= end; i += increment) {
                        serialData.push({ SERIAL: i.toString() });
                    }
                }

                if (labelData.length > 0) {
                    // Merge serial data and CSV data
                    const mergedData = serialData.map((sData, index) => {
                        if (labelData[index]) {
                            return { ...sData, ...labelData[index] };
                        }
                        return sData;
                    });
                    
                    if (labelData.length > mergedData.length) {
                        return mergedData.concat(labelData.slice(mergedData.length));
                    }
                    
                    return mergedData;

                } else if (templateUsesSerial) {
                    // Only serial data
                    return serialData;
                }
                
                if (controls.contentTemplate.value) {
                    // Pure manual mode
                     return [ { MANUAL_CONTENT: controls.contentTemplate.value } ];
                }

                return [];
            };

            const getLabelsPerPage = () => {
                if (controls.templateType.value === 'envelope') return 1;
                const rows = parseInt(controls.rows.value, 10) || 1;
                const cols = parseInt(controls.cols.value, 10) || 1;
                return rows * cols;
            };

            const renderPreview = () => {
                const labelsPerPage = getLabelsPerPage();
                // Get currently selected indices
                let currentSelection = Array.from(document.querySelectorAll('.label.selected')).map(l => parseInt(l.dataset.index, 10));
                
                labelGrid.innerHTML = '';

                const dataToRender = generateDataArray();
                const startPos = Math.max(0, parseInt(controls.startPosition.value, 10) - 1);
                const isPureManualMode = dataToRender.length === 1 && dataToRender[0].MANUAL_CONTENT !== undefined;
                const padding = Array(startPos).fill(null);
                const finalData = padding.concat(dataToRender);

                for (let i = 0; i < labelsPerPage; i++) {
                    const label = document.createElement('div');
                    label.classList.add('label');
                    label.dataset.index = i;
                    label.dataset.labelNumber = i + 1; // Ensure label number is set
                    
                    // --- 1. SETUP CONTENT DATA ---
                    let content = '';
                    const dataItem = isPureManualMode ? dataToRender[0] : finalData[i];

                    const hasOverride = manualOverrides[i] !== undefined;
                    if (hasOverride) {
                        content = manualOverrides[i];
                        label.classList.add('has-override'); 
                    } else if (dataItem) {
                        content = generateLabelContent(dataItem, i + 1);
                    }

                    // --- 2. SELECTION LOGIC ---
                    let isSelected = currentSelection.includes(i);
                    // Default selection on fresh load
                    if (currentSelection.length === 0 && (dataItem || controls.templateType.value === 'envelope')) {
                        isSelected = true; 
                    }

                    if (isSelected) {
                        label.classList.add('selected');
                        if (content.trim() !== '') {
                            label.classList.add('has-template');
                        }
                    }

                    // --- 3. CREATE SEPARATE CONTENT LAYER (The Fix) ---
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'label-content';
                    contentDiv.contentEditable = true; // Only this part is editable
                    contentDiv.innerHTML = content;
                    
                    // Input Listener (Saves ONLY the text, ignores buttons)
                    contentDiv.addEventListener('input', (e) => {
                        manualOverrides[i] = contentDiv.innerHTML;
                        
                        label.classList.add('has-override'); 
                        if (!label.classList.contains('selected')) {
                            label.classList.add('selected');
                        }
                        
                        // Debounce History
                        clearTimeout(historyDebounceTimer);
                        historyDebounceTimer = setTimeout(() => saveHistory(), 500);
                    });

                    // --- 4. CREATE CONTROLS LAYER ---
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'label-controls';
                    controlsDiv.contentEditable = false; // Buttons are NOT editable

                    // Clear Button
                    const clearBtn = document.createElement('div');
                    clearBtn.className = 'btn-control btn-clear';
                    clearBtn.innerHTML = '&#128465;'; 
                    clearBtn.title = 'Clear Manual Text';
                    clearBtn.addEventListener('mousedown', e => e.stopPropagation());
                    clearBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        delete manualOverrides[i];
                        saveHistory();
                        renderPreview(); 
                    });
                    controlsDiv.appendChild(clearBtn);

                    // Deselect Button
                    const deselectBtn = document.createElement('div');
                    deselectBtn.className = 'btn-control btn-deselect';
                    deselectBtn.innerHTML = '&times;';
                    deselectBtn.title = 'Deselect';
                    deselectBtn.addEventListener('mousedown', e => e.stopPropagation());
                    deselectBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        label.classList.remove('selected');
                        // Use CSS to hide controls, no re-render needed
                    });
                    controlsDiv.appendChild(deselectBtn);

                    // Append layers in order
                    label.appendChild(contentDiv);
                    label.appendChild(controlsDiv);

                    // --- 5. CLICK HANDLER (Focus Management) ---
                    label.addEventListener('click', (e) => {
                         // Ctrl+Click to Deselect
                         if (e.ctrlKey || e.metaKey) {
                             label.classList.toggle('selected');
                             return;
                         }
                         
                         // Standard Click: Select
                         if (!label.classList.contains('selected')) {
                             label.classList.add('selected');
                         }
                         
                         // FORCE FOCUS on the content layer
                         // This fixes the "no entry bit" issue
                         contentDiv.focus();
                    });

                    // Render Barcodes (if any in content)
                    if (contentDiv.querySelector('.barcode')) {
                        const svg = contentDiv.querySelector('.barcode');
                        JsBarcode(svg, svg.dataset.value, { displayValue: true, margin: 5, fontSize: 10, height: 30 });
                    }
                    
                    labelGrid.appendChild(label);
                }
            };
            
            // Sync contentTemplate changes back to the first label
            controls.contentTemplate.addEventListener('input', () => {
                const firstLabel = labelGrid.querySelector('.label[data-index="0"]');
                if (firstLabel && firstLabel.innerText !== controls.contentTemplate.value) {
                    firstLabel.innerText = controls.contentTemplate.value;
                }
                // No need to call updateAllStyles here, as the input event on the textarea
                // is already handled to call it.
            });

            const saveCurrentSettings = (name) => {
                if (!currentUserId || !db) {
                    alert("Preset saving requires Firebase configuration and a logged-in user.");
                    return;
                }
                const type = controls.templateType.value;
                const newPreset = {
                    name: name,
                    type: type, 
                    paper: controls.paperSize.value,
                    orientation: controls.orientation.value,
                    rows: controls.rows.value,
                    cols: controls.cols.value,
                    width: controls.labelWidth.value,
                    height: controls.labelHeight.value,
                    marginTop: controls.marginTop.value,
                    marginLeft: controls.marginLeft.value,
                    rowGap: controls.gridRowGap.value,
                    colGap: controls.gridColumnGap.value,
                    cornerRadius: controls.cornerRadius.value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const key = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                
                db.collection(`users/${currentUserId}/labelPresets`).doc(key).set(newPreset)
                    .then(() => {
                        alert(`Preset "${name}" saved to your Firebase account!`);
                        populatePresets();
                        controls.presets.value = key;
                    })
                    .catch((error) => {
                        console.error("Error saving preset:", error);
                        alert("Error saving preset to cloud. Check console.");
                    });
            };

            const updateAllStyles = () => {
                const type = controls.templateType.value;
                if (type === 'envelope') {
                    const envWidth = `${controls.envelopeWidth.value}mm`, envHeight = `${controls.envelopeHeight.value}mm`;
                    root.style.setProperty('--paper-width', envWidth); root.style.setProperty('--paper-height', envHeight);
                    root.style.setProperty('--label-width', envWidth); root.style.setProperty('--label-height', envHeight);
                    ['--margin-top','--margin-left','--grid-row-gap','--grid-column-gap','--corner-radius'].forEach(p => root.style.setProperty(p, '0mm'));
                } else {
                    const isLetter = controls.paperSize.value === 'Letter';
                    let paper = isLetter ? {w:'215.9mm',h:'279.4mm',w_val:215.9,h_val:279.4} : {w:'210mm',h:'297mm',w_val:210,h_val:297};
                    if (controls.orientation.value === 'landscape') { [paper.w, paper.h, paper.w_val, paper.h_val] = [paper.h, paper.w, paper.h_val, paper.w_val]; }
                    root.style.setProperty('--paper-width', paper.w); root.style.setProperty('--paper-height', paper.h);
                    
                    if (controls.layoutModeLabel.checked) {
                        controls.rows.disabled = true;
                        controls.cols.disabled = true;
                        controls.labelWidth.disabled = false;
                        controls.labelHeight.disabled = false;

                        const availW = paper.w_val - (2 * parseFloat(controls.marginLeft.value));
                        const availH = paper.h_val - (2 * parseFloat(controls.marginTop.value));
                        const labelW = parseFloat(controls.labelWidth.value);
                        const labelH = parseFloat(controls.labelHeight.value);
                        const colGap = parseFloat(controls.gridColumnGap.value);
                        const rowGap = parseFloat(controls.gridRowGap.value);

                        if (labelW > 0 && labelH > 0) {
                            const cols = Math.floor((availW + colGap) / (labelW + colGap));
                            const rows = Math.floor((availH + rowGap) / (labelH + rowGap));
                            controls.cols.value = cols > 0 ? cols : 1;
                            controls.rows.value = rows > 0 ? rows : 1;
                        }
                        root.style.setProperty('--label-width', `${controls.labelWidth.value}mm`);
                        root.style.setProperty('--label-height', `${controls.labelHeight.value}mm`);
                    } else {
                        // Layout Mode: Define by Grid
                        controls.rows.disabled = false;
                        controls.cols.disabled = false;
                        controls.labelWidth.disabled = true;
                        controls.labelHeight.disabled = true;

                        const availW = paper.w_val - (2 * parseFloat(controls.marginLeft.value)) - ((parseInt(controls.cols.value, 10) - 1) * parseFloat(controls.gridColumnGap.value));
                        const newW = availW / parseInt(controls.cols.value, 10);
                        if (newW > 0) {
                            controls.labelWidth.value = newW.toFixed(2);
                            root.style.setProperty('--label-width', `${newW}mm`);
                        }

                        const availH = paper.h_val - (2 * parseFloat(controls.marginTop.value)) - ((parseInt(controls.rows.value, 10) - 1) * parseFloat(controls.gridRowGap.value));
                        const newH = availH / parseInt(controls.rows.value, 10);
                        if (newH > 0) {
                            controls.labelHeight.value = newH.toFixed(2);
                            root.style.setProperty('--label-height', `${newH}mm`);
                        }
                    }

                    root.style.setProperty('--margin-top', `${controls.marginTop.value}mm`);
                    root.style.setProperty('--margin-left', `${controls.marginLeft.value}mm`);
                    root.style.setProperty('--grid-row-gap', `${controls.gridRowGap.value}mm`);
                    root.style.setProperty('--grid-column-gap', `${controls.gridColumnGap.value}mm`);
                    root.style.setProperty('--corner-radius', `${controls.cornerRadius.value}mm`);
                }
                const [alignContent, justifyContent] = gridAlignmentValue.split(' ');
                root.style.setProperty('--grid-align-content', alignContent);
                root.style.setProperty('--grid-justify-content', justifyContent);

                root.style.setProperty('--cols', controls.cols.value);
                root.style.setProperty('--font-family', controls.fontFamily.value); root.style.setProperty('--font-size', `${controls.fontSize.value}pt`);
                root.style.setProperty('--align-items', controls.vAlign.value); 
                root.style.setProperty('--justify-content', controls.hAlign.value);
                root.style.setProperty('--font-weight', controls.fontBold.dataset.active === 'true' ? 'bold' : 'normal');
                root.style.setProperty('--font-style', controls.fontItalic.dataset.active === 'true' ? 'italic' : 'normal');
                renderPreview();
                renderThumbnails(); // <-- NEW: Updates thumbnails instantly on any layout change
            };

            const applyPreset = async (key) => {
                const type = controls.templateType.value; if (!key || key === 'custom') { if (type === 'envelope') { controls.envelopeWidth.disabled = false; controls.envelopeHeight.disabled = false; } return; }
                
                let p;
                
                if (type === 'labelSheet' || type === 'suspensionTab') {
                    for (const group in PRESETS[type]) { if (PRESETS[type][group][key]) { p = PRESETS[type][group][key]; break; } }
                } else if (type === 'envelope') {
                    p = PRESETS.envelope['Common Sizes'][key];
                }
                
                if (!p && currentUserId && db) {
                    try {
                        const doc = await db.collection(`users/${currentUserId}/labelPresets`).doc(key).get();
                        if (doc.exists) {
                            p = doc.data();
                            if (p.type !== type) return; 
                        }
                    } catch (error) {
                        console.error("Error fetching custom preset:", error);
                        return;
                    }
                }
                if (!p) return;

                if (type === 'labelSheet' || type === 'suspensionTab') {
                    controls.paperSize.value = p.paper; 
                    controls.orientation.value = p.orientation || 'portrait';
                    controls.rows.value = p.rows; 
                    controls.cols.value = p.cols;
                    controls.labelWidth.value = p.width; 
                    controls.labelHeight.value = p.height;
                    controls.marginTop.value = p.marginTop; 
                    controls.marginLeft.value = p.marginLeft;
                    controls.gridRowGap.value = p.rowGap; 
                    controls.gridColumnGap.value = p.colGap;
                    controls.cornerRadius.value = p.cornerRadius || 0;
                    
                    // Default to calculating by grid instead of label size
                    controls.layoutModeGrid.checked = true;
                } else if (type === 'envelope') {
                    controls.envelopeWidth.value = p.width; 
                    controls.envelopeHeight.value = p.height;
                    controls.envelopeWidth.disabled = true; 
                    controls.envelopeHeight.disabled = true;
                }

                // Generate Visual Thumbnail
                const previewDiv = document.getElementById('presetPreview');
                if (p && p.cols && p.rows && type !== 'envelope') {
                    const total = p.rows * p.cols;
                    let html = `<div style="display:grid; grid-template-columns: repeat(${p.cols}, 1fr); gap: 1px; width: 60px; background: #cbd5e1; border: 1px solid #cbd5e1; padding: 1px; margin-bottom: 4px;">`;
                    for(let i=0; i<Math.min(total, 65); i++) {
                        html += `<div style="background: white; aspect-ratio: ${p.width}/${p.height};"></div>`;
                    }
                    html += `</div><p>${p.rows} x ${p.cols} (${total} labels)</p>`;
                    previewDiv.innerHTML = html;
                } else {
                    previewDiv.innerHTML = '';
                }
                updateAllStyles();
            };
            
            const handleCsvUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n').filter(row => row.trim() !== '');
                    
                    if (rows.length === 0) return;

                    let dataRows = rows;
                    let header = [];
                    
                    if (controls.csvHasHeader.checked) {
                        header = rows[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        dataRows = rows.slice(1);
                    }

                    if (header.length === 0) {
                        header = dataRows[0].split(',').map((_, i) => `COL${i + 1}`);
                    }
                    csvHeader = header;
                    
                    labelData = dataRows.map(row => {
                        const values = row.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                        const obj = {};
                        header.forEach((key, i) => {
                            obj[key] = values[i] || ''; 
                            obj[`COL${i + 1}`] = values[i] || ''; 
                        });
                        return obj;
                    });
                    
                    updateAllStyles();
                };
                reader.readAsText(file);
                e.target.value = '';
            };
            
            const toggleModeControls = () => {
                const type = controls.templateType.value;
                controls.envelopeControls.classList.toggle('hidden', type !== 'envelope');
                controls.suspensionTabControls.classList.toggle('hidden', type !== 'suspensionTab');
                
                // Show/hide all non-envelope controls
                const labelSheetPanels = ['tab-step2'];
                wizardPanels.querySelectorAll('.tab-panel').forEach(p => {
                    if (labelSheetPanels.includes(p.id) || p.id.startsWith('labelSheetControls')) {
                         p.classList.toggle('hidden', type === 'envelope');
                    }
                });
                document.querySelector('button[data-tab="step2"]').classList.toggle('hidden', type === 'envelope');

                // If envelope, switch to step 1
                if (type === 'envelope') {
                     document.querySelector('.tab-button[data-tab="step1"]').click();
                }
            };

            // --- Wizard Tab Logic ---
            wizardTabs.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const tabId = e.target.dataset.tab;
                    
                    // Update Tabs
                    wizardTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Update Panels
                    wizardPanels.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                }
            });
            
            // --- Visual Grid Alignment Logic ---
            gridAlignmentIcons.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                
                gridAlignmentValue = button.dataset.value;
                gridAlignmentIcons.querySelectorAll('button').forEach(btn => btn.dataset.active = 'false');
                button.dataset.active = 'true';
                
                updateAllStyles();
            });
            // Set default active grid icon
            gridAlignmentIcons.querySelector(`button[data-value="${gridAlignmentValue}"]`).dataset.active = 'true';
            
            controls.templateType.addEventListener('input', () => {
                labelData = [];
                toggleModeControls(); 
                populatePresets(); 
                applyPreset(controls.presets.value);

                const type = controls.templateType.value;
                if (type === 'suspensionTab') {
                    controls.labelWidth.value = 54;
                    controls.labelHeight.value = 14;
                    // Default to Grid instead of Label
                    controls.layoutModeGrid.checked = true;
                    controls.presets.value = 'custom';
                }
                
                updateAllStyles();

                if (type === 'suspensionTab' || type === 'envelope') {
                    const firstLabel = document.querySelector('.label');
                    if (firstLabel) firstLabel.classList.add('selected');
                }
            });

            controls.savePresetButton.addEventListener('click', () => {
                const presetName = prompt("Enter a name for your custom preset (e.g., 'My Favourite 5160'):");
                if (presetName) {
                    saveCurrentSettings(presetName);
                }
            });

            controls.presets.addEventListener('input', (e) => { labelData = []; applyPreset(e.target.value); });
            Object.values(controls).forEach(c => {
                const nonStandard = ['templateType','presets','csvFile','csvHasHeader','contentTemplate','fontBold','fontItalic','labelSheetControls','envelopeControls','suspensionTabControls','printCutLines', 'layoutModeGrid', 'layoutModeLabel','serialStart','serialEnd','serialIncrement','savePresetButton'];
                if (!c.id || nonStandard.includes(c.id)) return;
                c.addEventListener('input', () => { controls.presets.value = 'custom'; if (controls.templateType.value === 'envelope') { controls.envelopeWidth.disabled = false; controls.envelopeHeight.disabled = false; } labelData = []; updateAllStyles(); });
            });
            [controls.contentTemplate, controls.serialStart, controls.serialEnd, controls.serialIncrement, controls.layoutModeGrid, controls.layoutModeLabel].forEach(c => c.addEventListener('input', updateAllStyles));

            controls.fontBold.addEventListener('click', () => { controls.fontBold.dataset.active = !(controls.fontBold.dataset.active === 'true'); updateAllStyles(); });
            controls.fontItalic.addEventListener('click', () => { controls.fontItalic.dataset.active = !(controls.fontItalic.dataset.active === 'true'); updateAllStyles(); });
            // --- Drag and Drop Logic ---
            const csvDropZone = document.getElementById('csvDropZone');
            const csvFileName = document.getElementById('csvFileName');

            csvDropZone.addEventListener('click', () => controls.csvFile.click());

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                csvDropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                csvDropZone.addEventListener(eventName, () => csvDropZone.classList.add('bg-sky-100', 'border-sky-400'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                csvDropZone.addEventListener(eventName, () => csvDropZone.classList.remove('bg-sky-100', 'border-sky-400'));
            });

            csvDropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                if (dt.files && dt.files.length > 0) {
                    controls.csvFile.files = dt.files;
                    csvFileName.textContent = dt.files[0].name;
                    handleCsvUpload({ target: controls.csvFile });
                }
            });

            controls.csvFile.addEventListener('change', (e) => {
                if(e.target.files.length > 0) csvFileName.textContent = e.target.files[0].name;
                handleCsvUpload(e);
            });
            // ---------------------------
            controls.csvFile.addEventListener('change', handleCsvUpload);
            actions.selectAll.addEventListener('click', () => { document.querySelectorAll('.label').forEach(l => l.classList.add('selected')); if(generateDataArray().length === 1 && generateDataArray()[0].MANUAL_CONTENT !== undefined) renderPreview(); });
            actions.deselectAll.addEventListener('click', () => { document.querySelectorAll('.label').forEach(l => l.classList.remove('selected')); if(generateDataArray().length === 1 && generateDataArray()[0].MANUAL_CONTENT !== undefined) renderPreview(); });
            
            // --- Shared Output Generator (Print & PDF) ---
            const processOutput = (isPdf) => {
                const btn = isPdf ? actions.exportPdfButton : actions.printButton;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = isPdf ? "Generating PDF..." : "Preparing Print...";
                btn.disabled = true;

                setTimeout(() => {
                    try {
                        const printArea = document.getElementById('print-area');
                        
                        // Safely strip inline styles so CSS handles the hiding/showing
                        printArea.style.removeProperty('position');
                        printArea.style.removeProperty('left');
                        printArea.style.removeProperty('top');
                        
                        printArea.innerHTML = '';
                        printArea.className = (controls.templateType.value === 'suspensionTab' && controls.printCutLines.checked) ? 'print-borders-on' : '';
                        
                        const dataToPrint = generateDataArray();
                        const startPos = Math.max(0, parseInt(controls.startPosition.value, 10) - 1);
                        const padding = Array(startPos).fill(null);
                        const finalData = padding.concat(dataToPrint);

                        const hasManualData = Object.keys(manualOverrides).length > 0;
                        
                        if (finalData.length === 0 && controls.contentTemplate.value.trim() === '' && !hasManualData) {
                             alert("There is no data to output. Please enter text, import a CSV, or type manually.");
                             btn.innerHTML = originalHtml; btn.disabled = false;
                             return;
                        }
                        
                        const labelsPerPage = getLabelsPerPage();
                        const isPureManualMode = dataToPrint.length === 1 && dataToPrint[0].MANUAL_CONTENT !== undefined;
                        const selectedIndexes = Array.from(document.querySelectorAll('#label-grid .label.selected')).map(l => parseInt(l.dataset.index, 10));

                        if (selectedIndexes.length === 0) {
                            alert("No labels are selected.");
                            btn.innerHTML = originalHtml; btn.disabled = false;
                            return;
                        }

                        const maxIndex = Math.max(...selectedIndexes);
                        const totalPages = Math.ceil((maxIndex + 1) / labelsPerPage);

                        for (let i = 0; i < totalPages; i++) {
                            const page = document.createElement('div');
                            page.className = 'print-page';
                            let pageHasContent = false;

                            for (let j = 0; j < labelsPerPage; j++) {
                                const globalIndex = (i * labelsPerPage) + j;
                                const printLabel = document.createElement('div');
                                printLabel.className = 'label print-label';
                                
                                printLabel.style.fontSize = root.style.getPropertyValue('--font-size');
                                printLabel.style.fontFamily = root.style.getPropertyValue('--font-family');
                                printLabel.style.fontWeight = root.style.getPropertyValue('--font-weight');
                                printLabel.style.fontStyle = root.style.getPropertyValue('--font-style');
                                printLabel.style.alignItems = root.style.getPropertyValue('--align-items'); 
                                printLabel.style.justifyContent = root.style.getPropertyValue('--justify-content'); 
                                printLabel.style.textAlign = root.style.getPropertyValue('--justify-content'); 

                                let content = '', hasContent = false;
                                
                                if (selectedIndexes.includes(globalIndex)) {
                                    if (manualOverrides[globalIndex] !== undefined) {
                                        content = manualOverrides[globalIndex]; hasContent = true;
                                    } else if (isPureManualMode) {
                                        content = generateLabelContent(dataToPrint[0], globalIndex + 1); hasContent = true;
                                    } else {
                                        const dataItem = finalData[globalIndex];
                                        if (dataItem) {
                                            content = generateLabelContent(dataItem, globalIndex + 1);
                                            if (content.trim() !== '') hasContent = true;
                                        }
                                    }
                                }

                                if (hasContent) {
                                    printLabel.innerHTML = content;
                                    printLabel.classList.add('has-content');
                                    pageHasContent = true;
                                    if (printLabel.querySelector('.barcode')) {
                                        const svg = printLabel.querySelector('.barcode');
                                        JsBarcode(svg, svg.dataset.value, { displayValue: true, margin: 2, fontSize: 8, height: 25, width: 1.5, textMargin: 0, background: 'transparent' });
                                    }
                                } else { printLabel.classList.add('not-selected'); }
                                page.appendChild(printLabel);
                            }
                            if (pageHasContent) printArea.appendChild(page);
                        }
                        
                        if (printArea.childElementCount === 0) {
                             alert("The selected labels do not have any content.");
                             btn.innerHTML = originalHtml; btn.disabled = false;
                             return;
                        }

                        if (isPdf) {
                            const isLandscape = controls.orientation.value === 'landscape';
                            const paperType = controls.paperSize.value === 'Letter' ? 'letter' : 'a4';
                            
                            // Temporarily bring into view for html2pdf rendering
                            printArea.style.position = 'relative';
                            printArea.style.left = '0';
                            printArea.style.top = '0';
                            
                            html2pdf().set({
                                margin: 0, filename: 'labels.pdf', image: { type: 'jpeg', quality: 0.98 },
                                html2canvas: { scale: 2, useCORS: true },
                                jsPDF: { unit: 'mm', format: paperType, orientation: isLandscape ? 'landscape' : 'portrait' }
                            }).from(printArea).save().then(() => {
                                printArea.style.removeProperty('position');
                                printArea.style.removeProperty('left');
                                printArea.style.removeProperty('top');
                                btn.innerHTML = originalHtml; btn.disabled = false;
                            }).catch(err => {
                                console.error("PDF generation failed:", err);
                                alert("Failed to generate PDF. Check console for details.");
                                btn.innerHTML = originalHtml; btn.disabled = false;
                            });
                        } else {
                            // Give the DOM a tiny fraction of a second to apply the inline-style removals
                            setTimeout(() => {
                                window.print();
                                btn.innerHTML = originalHtml; btn.disabled = false;
                            }, 50);
                        }
                    } catch (error) {
                        console.error("Output Generation Error:", error);
                        alert("An error occurred generating the output: " + error.message);
                        btn.innerHTML = originalHtml; btn.disabled = false;
                    }
                }, 50);
            };

            actions.printButton.addEventListener('click', () => processOutput(false));
            actions.exportPdfButton.addEventListener('click', () => processOutput(true));
            

            async function populatePresets() {
                const type = controls.templateType.value; 
                const presetList = PRESETS[type]; 
                
                controls.presets.innerHTML = '';
                
                for (const group in presetList) {
                    const optgroup = document.createElement('optgroup'); 
                    optgroup.label = group;
                    for (const [key, value] of Object.entries(presetList[group])) { 
                        const o = document.createElement('option'); 
                        o.value = key; 
                        o.textContent = value.name; 
                        optgroup.appendChild(o); 
                    }
                    controls.presets.appendChild(optgroup);
                }
                
                if (currentUserId && db) {
                    try {
                        const snapshot = await db.collection(`users/${currentUserId}/labelPresets`)
                                                .where('type', '==', type) 
                                                .get();
                        
                        if (!snapshot.empty) {
                            const customGroup = document.createElement('optgroup'); 
                            customGroup.label = 'Custom Saved Presets (Cloud)';
                            snapshot.forEach(doc => {
                                const preset = doc.data();
                                const o = document.createElement('option');
                                o.value = doc.id;
                                o.textContent = preset.name;
                                customGroup.appendChild(o);
                            });
                            controls.presets.appendChild(customGroup);
                        }
                    } catch (error) {
                        console.error("Error loading custom presets:", error);
                    }
                }
            }

            toggleModeControls(); 
            populatePresets(); 
            applyPreset('avery_L7163');
            
            // ***FIXED***: Manually select the first label on initial load
            // This runs *after* the first render, so it sets the default
            // without getting in the way of the re-render logic.
            labelGrid.querySelector('.label[data-index="0"]')?.classList.add('selected');
        });

        // --- Keyboard Shortcuts (Undo/Redo) ---
            document.addEventListener('keydown', (e) => {
                // Check for Ctrl (or Cmd on Mac)
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                    } else if (e.key === 'y') {
                        e.preventDefault();
                        redo();
                    }
                }
            });
    </script>
</body>
</html>