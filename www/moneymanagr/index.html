<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyManagr</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%2310b981%22 d=%22M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V192c0-35.3-28.7-64-64-64H80c-8.8 0-16-7.2-16-16s7.2-16 16-16H448c17.7 0 32-14.3 32-32s-14.3-32-32-32H64zM416 336c-17.7 0-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32s-14.3 32-32 32z%22/%3E</svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#ecfdf5', 100: '#d1fae5', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --bg-color: #f0fdf4;
            --card-bg-color: white;
            --text-color-primary: #064e3b;
            --text-color-secondary: #64748b;
            --input-bg-color: #f1f5f9;
            --button-bg: #10b981;
            --button-hover: #059669;
            --border-color: #e2e8f0;
            --font-family: 'Inter', sans-serif;
        }
        :root.dark {
            --bg-color: #111827;
            --card-bg-color: #1f2937;
            --text-color-primary: #ecfdf5;
            --text-color-secondary: #9ca3af;
            --input-bg-color: #374151;
            --button-bg: #10b981;
            --button-hover: #059669;
            --border-color: #374151;
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color-primary); display: flex; flex-direction: column; min-height: 100dvh; margin: 0; padding: 0; transition: background-color 0.3s ease, color 0.3s ease; }
        .card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: transform 0.2s; }
        .pot-card { border-left: 4px solid var(--button-bg); }
        .main-button { background-color: var(--button-bg); color: white; padding: 14px; border-radius: 12px; font-weight: 700; width: 100%; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
        .main-button:hover { background-color: var(--button-hover); transform: translateY(-1px); }
        .secondary-button { background-color: var(--input-bg-color); color: var(--text-color-primary); padding: 10px; border-radius: 10px; font-weight: 600; transition: all 0.2s; }
        .secondary-button:hover { filter: brightness(0.95); }
        .danger-button { background-color: #fee2e2; color: #991b1b; padding: 10px; border-radius: 10px; font-weight: 600; transition: all 0.2s; }
        .dark .danger-button { background-color: #7f1d1d; color: #fecaca; }
        .danger-button:hover { filter: brightness(0.95); }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: var(--text-color-secondary); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); background-color: var(--input-bg-color); color: var(--text-color-primary); border-radius: 10px; font-size: 1rem; outline: none; }
        input:focus { ring: 2px solid var(--button-bg); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #auth-container { background-color: var(--card-bg-color); padding: 40px; border-radius: 24px; border: 1px solid var(--border-color); max-width: 400px; width: 90%; margin: 10vh auto; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: end; z-index: 100; }
        @media (min-width: 640px) { .modal-overlay { align-items: center; } }
        .modal-container { background: var(--card-bg-color); padding: 24px; border-top-left-radius: 24px; border-top-right-radius: 24px; width: 100%; max-width: 500px; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
        @media (min-width: 640px) { .modal-container { border-radius: 24px; animation: fadeIn 0.2s ease-out; width: 90%; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: #064e3b; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 200; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .import-item { border-left: 3px solid transparent; }
        .import-item.pending { border-left-color: #f59e0b; }
        .category-radio:checked + div { background-color: var(--button-bg); color: white; border-color: var(--button-bg); }
        .type-toggle.active { background-color: var(--card-bg-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--text-color-primary); }
        .progress-bar-bg { background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; }
        .dark .progress-bar-bg { background-color: #374151; }
        .progress-bar-fill { height: 100%; border-radius: 999px; transition: width 0.5s ease; }
        /* Clickable row style */
        .activity-row { transition: background-color 0.2s; cursor: pointer; }
        .activity-row:hover { background-color: var(--input-bg-color); }
    </style>
</head>
<body>
    
    <div id="app-loading-screen" style="position:fixed; inset:0; background:var(--bg-color); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="text-align:center; color:var(--button-bg);">
            <i class="fa-solid fa-seedling fa-bounce" style="font-size: 3rem;"></i>
        </div>
    </div>

    <div id="auth-container" style="display: none;">
        <div class="w-16 h-16 bg-brand-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-600">
            <i class="fa-solid fa-vault text-3xl"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2">MoneyManagr</h1>
        <p class="text-sm text-gray-500 mb-6">Simple finance tracking.</p>
        <div class="space-y-3">
            <input id="email" type="email" placeholder="Email" />
            <input id="password" type="password" placeholder="Password" />
            <button id="sign-in-btn" class="main-button">Log In</button>
            <button id="sign-up-btn" class="secondary-button w-full">Sign Up</button>
        </div>
    </div>

    <div id="main-app-container" class="hidden w-full max-w-[800px] mx-auto px-4 pb-28">
        
        <div id="tab-content-accounts" class="tab-content active pt-6">
            <div class="text-center mb-8">
    <p id="net-balance-label" class="text-sm font-semibold uppercase tracking-wider text-brand-600 dark:text-brand-400 mb-1">Net Balance</p>
    <h1 id="balance-header" class="text-4xl font-extrabold tracking-tight flex items-center justify-center gap-1">
        <span class="text-2xl opacity-50 currency-symbol">$</span><span id="total-balance">0.00</span>
    </h1>
    <div class="flex justify-center gap-4 mt-3 text-xs font-bold">
        <p class="text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30 px-3 py-1 rounded-full"><i class="fa-solid fa-arrow-down mr-1"></i> Owed to you: <span class="currency-symbol">$</span><span id="total-owed-to-me">0.00</span></p>
        <p class="text-red-600 bg-red-50 dark:bg-red-900/30 px-3 py-1 rounded-full"><i class="fa-solid fa-arrow-up mr-1"></i> You owe: <span class="currency-symbol">$</span><span id="total-i-owe">0.00</span></p>
    </div>
</div>

            <div class="card mb-6 border-brand-200 dark:border-brand-900 bg-gradient-to-br from-white to-brand-50 dark:from-gray-800 dark:to-gray-900">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-brand-100 dark:bg-brand-900 flex items-center justify-center text-brand-600">
                            <i class="fa-regular fa-calendar-check"></i>
                        </div>
                        <div>
                            <h3 class="font-bold">This Week</h3>
                            <p class="text-xs text-gray-500">Deposits & Round ups</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg">$<span id="weekly-total">0.00</span></p>
                    </div>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden mb-2">
                    <div id="weekly-progress" class="h-full bg-brand-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-400 text-center">Target: $<span id="weekly-target">50</span>/week</p>
            </div>

            <div class="card mb-6 border-brand-200 dark:border-brand-900">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-brand-100 dark:bg-brand-900 flex items-center justify-center text-brand-600">
                            <i class="fa-solid fa-wallet"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900 dark:text-white">Personal Ledger</h3>
                            <p class="text-xs text-gray-500">My unlinked spending & income</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-gray-900 dark:text-white"><span class="currency-symbol">$</span><span id="personal-total-display">0.00</span></p>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
    <h2 class="font-bold text-lg">Who Owes What</h2>
    <div class="flex gap-2">
        <button class="text-brand-600 text-sm font-bold bg-brand-50 dark:bg-brand-900/30 px-3 py-1 rounded-lg" onclick="openPotModal()">+ Add Person</button>
    </div>
</div>


            
            <div id="pots-list" class="space-y-3 mb-10"></div>

            <div class="flex justify-between items-center mb-4 border-t border-gray-200 dark:border-gray-800 pt-8">
                <h2 class="font-bold text-lg">Recent Activity</h2>
                <span class="text-xs text-gray-400" id="activity-count">0 records</span>
            </div>
            
            <div class="relative mb-4">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
                <input type="text" id="activity-search" placeholder="Search transactions..." class="pl-10">
            </div>

            <div id="activity-list" class="space-y-4"></div>
        </div>

        <div id="tab-content-tools" class="tab-content pt-6">
            <h2 class="text-2xl font-bold mb-6">Tools</h2>

            <div class="card mb-6 border-brand-200 dark:border-brand-900">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center">
                        <i class="fa-solid fa-gear"></i>
                    </div>
                    <h3 class="font-bold">App Settings</h3>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Currency Symbol</label>
                    <select id="currency-select" class="w-full" onchange="updateCurrency()">
                        <option value="$">$ (USD/CAD/AUD)</option>
                        <option value="£">£ (GBP)</option>
                        <option value="€">€ (EUR)</option>
                        <option value="¥">¥ (JPY/CNY)</option>
                        <option value="₹">₹ (INR)</option>
                    </select>
                </div>
            </div>

            <div class="card mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                        <i class="fa-solid fa-chart-simple"></i>
                    </div>
                    <h3 class="font-bold">Budgets</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Set and monitor monthly category limits.</p>
                <button onclick="openBudgetModal()" class="secondary-button w-full">Manage Budgets</button>
            </div>
            
            <div class="card mb-6 border-blue-200 dark:border-blue-900 bg-blue-50 dark:bg-blue-900/10">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                        <i class="fa-solid fa-file-invoice"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Import & Export</h3>
                        <p class="text-xs text-gray-500">Manage data</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openImportModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-sm">
                        Upload CSV
                    </button>
                    <button onclick="exportData()" class="flex-1 bg-white border border-blue-200 text-blue-600 font-bold py-3 rounded-xl transition-colors shadow-sm">
                        Export CSV
                    </button>
                </div>
                <div id="pending-imports-alert" class="hidden mt-3 text-center">
                    <button onclick="openPendingTransactions()" class="text-xs font-bold text-blue-600 underline">
                        View Pending Transactions
                    </button>
                </div>
            </div>

            <div class="card mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                        <i class="fa-solid fa-chart-pie"></i>
                    </div>
                    <h3 class="font-bold">Spending Breakdown</h3>
                </div>
                <div class="h-64 relative">
                    <canvas id="breakdown-chart"></canvas>
                </div>
            </div>

            <div class="card mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center">
                        <i class="fa-solid fa-calendar-days"></i>
                    </div>
                    <h3 class="font-bold">Subscriptions</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Manage recurring payments.</p>
                <button onclick="openSubscriptionModal()" class="secondary-button w-full">Manage Subscriptions</button>
            </div>

            <div class="card mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center">
                        <i class="fa-solid fa-dice"></i>
                    </div>
                    <h3 class="font-bold">Random Round Up</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Simulate a coffee purchase and save the change.</p>
                <button id="generate-roundup-btn" class="secondary-button w-full">Generate</button>
            </div>

            <div class="card">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </div>
                    <h3 class="font-bold">Time Machine</h3>
                </div>
                <div class="h-40 mb-4"><canvas id="projection-chart"></canvas></div>
                <div class="space-y-4">
                    <input type="range" id="proj-deposit" min="10" max="500" value="50" step="10" class="w-full accent-brand-500">
                    <input type="range" id="proj-years" min="1" max="40" value="10" class="w-full accent-purple-500">
                </div>
                <p class="text-center font-bold text-2xl mt-4 text-brand-600" id="proj-total">$0</p>
            </div>
        </div>

    </div>
    <div id="pot-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <h2 class="text-xl font-bold mb-4">Open New Pot</h2>
            <div class="input-group mb-4">
                <label>Pot Name</label>
                <input type="text" id="pot-name" placeholder="e.g. Holiday Fund">
            </div>
            <div class="input-group mb-4">
                <label>Target Goal ($)</label>
                <input type="number" id="pot-target" placeholder="1000">
            </div>
            <div class="flex gap-2">
                <button id="save-pot-btn" class="main-button">Create Pot</button>
                <button class="secondary-button" onclick="closeModal('pot-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="transaction-details-modal" class="modal-overlay hidden" style="z-index: 120;">
    <div class="modal-container">
        <div class="flex justify-between items-start mb-2">
            <p class="text-xs text-gray-400 uppercase tracking-wide font-bold">Edit Transaction</p>
            <button onclick="closeModal('transaction-details-modal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
        </div>

        <div class="text-center mb-6">
    <div id="txn-detail-icon" class="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-2xl mb-3 bg-gray-100 text-gray-600"></div>
    <h2 class="text-2xl font-bold" id="txn-detail-amount">0.00</h2>
    <p class="text-gray-500 text-sm font-medium mb-2" id="txn-detail-date">Date</p>
    
    <p class="text-[10px] text-gray-400 uppercase tracking-wider mb-4 border border-gray-200 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 py-1 px-2 inline-block">
        <i class="fa-solid fa-lock mr-1"></i> <span id="txn-locked-desc">Original Name</span>
    </p>
    
    <div class="input-group text-left">
        <label>Known As (Custom Note)</label>
        <input type="text" id="txn-edit-known-as" class="w-full text-center font-bold" placeholder="e.g. Dinner with Sarah">
    </div>
</div>

        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 mb-6 space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Category</label>
                <select id="txn-edit-category" class="w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-2 text-sm font-bold"></select>
            </div>
            
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Assigned To</label>
                <select id="txn-move-select" class="w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-2 text-sm font-bold"></select>
            </div>
        </div>

        <div class="flex gap-2">
            <button id="txn-update-btn" class="main-button">Save Changes</button>
            <button id="txn-delete-btn" class="danger-button flex-1"><i class="fa-solid fa-trash mr-2"></i> Delete</button>
        </div>
    </div>
</div>

    <div id="budget-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <h2 class="text-xl font-bold mb-4">Monthly Budgets</h2>
            <p class="text-xs text-gray-500 mb-4">Set limits for categories.</p>
            <div id="budget-list" class="space-y-4 mb-6 max-h-[40vh] overflow-y-auto"></div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 class="font-bold text-sm mb-2">Set New Limit</h3>
                <div class="flex gap-2 mb-2">
                    <select id="budget-category" class="w-1/2 text-sm"></select>
                    <input type="number" id="budget-limit" placeholder="Limit $" class="w-1/2 text-sm">
                </div>
                <button onclick="saveBudget()" class="w-full bg-brand-100 text-brand-700 font-bold py-2 rounded-lg text-sm">Save Limit</button>
            </div>
            <button class="secondary-button w-full mt-4" onclick="closeModal('budget-modal')">Close</button>
        </div>
    </div>

    <div id="subscription-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <h2 class="text-xl font-bold mb-4">Subscriptions</h2>
            <div id="sub-list" class="space-y-3 mb-6 max-h-[30vh] overflow-y-auto"></div>
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl">
                <h3 class="font-bold text-sm mb-3">Add Recurring Payment</h3>
                <input type="text" id="sub-name" placeholder="Name (e.g. Netflix)" class="mb-2 text-sm">
                <div class="flex gap-2 mb-2">
                    <input type="number" id="sub-amount" placeholder="Amount" class="w-1/2 text-sm">
                    <input type="date" id="sub-date" class="w-1/2 text-sm">
                </div>
                <button onclick="saveSubscription()" class="w-full bg-pink-100 text-pink-600 font-bold py-2 rounded-lg text-sm">Add Subscription</button>
            </div>
            <button class="secondary-button w-full mt-4" onclick="closeModal('subscription-modal')">Close</button>
        </div>
    </div>

    <div id="pot-details-modal" class="modal-overlay hidden">
        <div class="modal-container h-[85vh] flex flex-col">
            <div class="flex justify-between items-start mb-6">
    <div>
        <h2 class="text-2xl font-bold" id="detail-pot-name">Pot Name</h2>
        <p class="text-sm text-gray-400">Target: $<span id="detail-pot-target">0</span></p>
    </div>
    <div class="flex gap-2">
        <button id="detail-edit-btn" class="text-gray-300 hover:text-blue-500 transition-colors p-2" title="Rename Person">
            <i class="fa-solid fa-pen"></i>
        </button>
        <button id="detail-delete-btn" class="text-gray-300 hover:text-red-500 transition-colors p-2">
            <i class="fa-solid fa-trash"></i>
        </button>
        <button onclick="closeModal('pot-details-modal')" class="text-gray-400 p-2">
            <i class="fa-solid fa-times text-xl"></i>
        </button>
    </div>
</div>

            <div class="bg-brand-50 dark:bg-brand-900/20 rounded-2xl p-6 text-center mb-6">
                <p class="text-sm text-gray-500 uppercase font-bold tracking-wider mb-1">Current Balance</p>
                <h1 class="text-4xl font-extrabold text-brand-600 dark:text-brand-400">$<span id="detail-pot-balance">0.00</span></h1>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden mt-4">
                    <div id="detail-pot-progress" class="h-full bg-brand-500 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div class="flex gap-2 mb-6">
                <button id="detail-deposit-btn" class="flex-1 bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-100 py-3 rounded-xl font-bold">
                    <i class="fa-solid fa-plus mr-1"></i> Add
                </button>
                <button id="detail-withdraw-btn" class="flex-1 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200 py-3 rounded-xl font-bold">
                    <i class="fa-solid fa-minus mr-1"></i> Spend
                </button>
            </div>

            <h3 class="font-bold mb-3 text-sm text-gray-500 uppercase">History</h3>
            <div id="detail-history-list" class="overflow-y-auto flex-1 space-y-3 -mr-2 pr-2">
            </div>
        </div>
    </div>

    <div id="deposit-modal" class="modal-overlay hidden" style="z-index: 105;">
        <div class="modal-container">
            <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-xl flex mb-6">
                <button onclick="setTxType('deposit')" id="type-btn-deposit" class="type-toggle active flex-1 py-2 text-sm font-bold rounded-lg transition-all text-center">Add Money</button>
                <button onclick="setTxType('withdrawal')" id="type-btn-withdrawal" class="type-toggle flex-1 py-2 text-sm font-bold rounded-lg transition-all text-center">Spend/Withdraw</button>
            </div>

            <p class="text-xs text-gray-500 text-center uppercase tracking-wide mb-1" id="deposit-pot-name">Account</p>
            
            <div class="mb-6 relative">
                <span id="amount-symbol" class="absolute left-1/2 -ml-16 top-2 text-2xl text-gray-400 font-bold">+</span>
                <input type="number" id="deposit-amount" placeholder="0.00" class="text-5xl text-center font-bold bg-transparent border-none focus:ring-0 p-0 placeholder-gray-300">
            </div>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Category</label>
                <div class="grid grid-cols-4 gap-2" id="category-grid"></div>
            </div>

            <div class="input-group mb-6">
                <label>Description (Optional)</label>
                <input type="text" id="deposit-note" placeholder="e.g. Weekly Savings, New Headphones...">
            </div>

            <input type="hidden" id="deposit-pot-id">
            <input type="hidden" id="tx-type" value="deposit">
            
            <div class="flex gap-2">
                <button id="confirm-deposit-btn" class="main-button">Confirm</button>
                <button class="secondary-button" onclick="closeModal('deposit-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <h2 class="text-xl font-bold mb-4">Import Statement</h2>
            <p class="text-sm text-gray-500 mb-4">Upload a .CSV file from your bank.</p>
            
            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 mb-4"/>

            <div id="import-mapping" class="hidden bg-gray-50 dark:bg-gray-800 p-4 rounded-xl mb-4 text-sm">
                <p class="font-bold mb-2">Confirm Columns:</p>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <label>Date Column #</label>
                    <input type="number" id="map-date" value="0" class="p-1 text-center">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <label>Description Column #</label>
                    <input type="number" id="map-desc" value="1" class="p-1 text-center">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <label>Amount Column #</label>
                    <input type="number" id="map-amount" value="2" class="p-1 text-center">
                </div>
            </div>

            <div class="flex gap-2">
                <button id="process-import-btn" class="main-button hidden">Process</button>
                <button class="secondary-button" onclick="closeModal('import-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="categorize-modal" class="modal-overlay hidden">
        <div class="modal-container h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Inbox (<span id="inbox-count">0</span>)</h2>
                <button onclick="closeModal('categorize-modal')" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div id="inbox-list" class="overflow-y-auto flex-1 space-y-3 p-1"></div>
        </div>
    </div>

    <div id="action-modal" class="modal-overlay hidden" style="z-index: 110;">
        <div class="modal-container">
            <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Categorize Transaction</h3>
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl mb-4 text-center">
                <p class="font-bold text-lg" id="action-desc">Tesco</p>
                <p class="text-2xl font-extrabold my-2" id="action-amount">£4.50</p>
                <p class="text-xs text-gray-400" id="action-date">12/10/2023</p>
            </div>

            <div class="input-group mb-4">
                <label>Known As (Custom Description)</label>
                <input type="text" id="action-known-as" placeholder="e.g. Dinner with Sarah, Weekly Food">
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Category</label>
                <select id="action-category" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-xl font-bold"></select>
            </div>

            <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-xl flex mb-4">
                <button onclick="toggleActionType('personal')" id="action-tab-personal" class="type-toggle active flex-1 py-2 text-sm font-bold rounded-lg transition-all text-center">Personal Ledger</button>
                <button onclick="toggleActionType('person')" id="action-tab-person" class="type-toggle flex-1 py-2 text-sm font-bold rounded-lg transition-all text-center">Linked to Person</button>
            </div>

            <div id="action-personal-view" class="space-y-4">
                <button onclick="applyCategorization('personal')" class="main-button mt-2">Log to Personal Account</button>
            </div>

            <div id="action-person-view" class="space-y-4 hidden">
                <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Select Person</label>
                <select id="action-pot-select" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-xl font-bold"></select>
                
                <p id="action-person-hint" class="text-xs text-center font-bold text-gray-500 mt-2"></p>
                <button onclick="applyCategorization('person')" id="btn-person-confirm" class="main-button mt-2">Confirm Link</button>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button onclick="applyCategorization('ignore')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300 p-3 rounded-xl font-bold text-sm">
                    Ignore & Remove from Inbox
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"><i class="fa-solid fa-check-circle mr-2"></i> <span>Saved!</span></div>
    <script type="module">
        import { AppNavigation } from '../shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, Timestamp, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let nav = null;
        let pots = [];
        let logs = []; 
        let subs = [];
        let budgets = [];
        let projectionChart = null;
        let breakdownChart = null;
        let pendingTransactions = [];
        let currentActionTxn = null;
        let currentEditingLog = null;

        const categories = [
            { id: 'savings', label: 'Savings', icon: 'fa-piggy-bank' },
            { id: 'income', label: 'Income', icon: 'fa-wallet' },
            { id: 'food', label: 'Food', icon: 'fa-utensils' },
            { id: 'transport', label: 'Transport', icon: 'fa-car' },
            { id: 'tech', label: 'Tech', icon: 'fa-laptop' },
            { id: 'home', label: 'Home', icon: 'fa-house' },
            { id: 'bills', label: 'Bills', icon: 'fa-file-invoice-dollar' },
            { id: 'fun', label: 'Fun', icon: 'fa-gamepad' },
            { id: 'shopping', label: 'Shop', icon: 'fa-bag-shopping' },
            { id: 'other', label: 'Other', icon: 'fa-circle-question' }
        ];

        const initNav = () => {
            nav = new AppNavigation({
                appName: 'MoneyManagr',
                appIcon: 'fa-piggy-bank',
                themeColor: 'emerald',
                userEmail: user ? user.email : 'Guest',
                activeTab: 'accounts',
                tabs: [
                    { id: 'accounts', label: 'Home', icon: 'fa-wallet' },
                    { id: 'tools', label: 'Tools', icon: 'fa-toolbox' }
                ]
            });
            window.addEventListener('tab-changed', (e) => switchTab(e.detail.tabId));
            window.addEventListener('app-logout-request', () => signOut(auth));
        };

        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-content-${tabId}`).classList.add('active');
            
            if(tabId === 'tools') {
                updateProjection();
                setTimeout(updateBreakdownChart, 100);
            }
        };

        let currency = localStorage.getItem('moneymanagr_currency') || '$';

window.updateCurrency = () => {
    currency = document.getElementById('currency-select').value;
    localStorage.setItem('moneymanagr_currency', currency);
    document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = currency);
    
    // Re-render UI to update inner JS templates
    renderPots();
    renderActivity();
    if(document.getElementById('inbox-list').innerHTML !== '') renderInbox();
    if(!document.getElementById('budget-modal').classList.contains('hidden')) renderBudgetProgress();
    if(!document.getElementById('subscription-modal').classList.contains('hidden')) renderSubscriptions();
    updateTotalBalance();
};

// Apply currency on load (inside your onAuthStateChanged success block)
const sel = document.getElementById('currency-select');
if(sel) sel.value = currency;
document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = currency);

        onAuthStateChanged(auth, (authUser) => {
            const loader = document.getElementById('app-loading-screen');
            if (authUser) {
                user = authUser;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('main-app-container').classList.remove('hidden');
                
                if (!nav) initNav(); else nav.updateUser(user.email);

                // Listeners
                onSnapshot(query(collection(db, `users/${user.uid}/moneyPots`)), (snap) => {
                    pots = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderPots();
                    updateTotalBalance();
                });

                onSnapshot(query(collection(db, `users/${user.uid}/moneyLogs`), orderBy('date', 'desc')), (snap) => {
                    logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderActivity();
                    updateWeeklyTracker();
                    updateBreakdownChart();
                    renderBudgetProgress();
                    
                    // Add this line so the dashboard updates live!
                    updatePersonalLedgerDisplay(); 
                });

                onSnapshot(query(collection(db, `users/${user.uid}/moneySubs`)), (snap) => {
                    subs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderSubscriptions();
                    checkSubscriptions();
                });

                onSnapshot(query(collection(db, `users/${user.uid}/moneyBudgets`)), (snap) => {
                    budgets = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderBudgetProgress();
                });

                const savedPending = localStorage.getItem(`moneymanagr_pending_${user.uid}`);
                if (savedPending) {
                    pendingTransactions = JSON.parse(savedPending);
                    updatePendingAlert();
                }
            } else {
                user = null;
                document.getElementById('auth-container').style.display = 'block';
                document.getElementById('main-app-container').classList.add('hidden');
            }
            if(loader) loader.style.display = 'none';
        });

        // --- RENDER ACTIVITY (Merged into Home) ---
        const renderActivity = () => {
            const list = document.getElementById('activity-list');
            const search = document.getElementById('activity-search')?.value.toLowerCase() || '';
            list.innerHTML = '';
            
            const filteredLogs = logs.filter(log => {
        // Search looks at the custom name AND the original note
        const desc = (log.knownAs || log.note || log.potName || '').toLowerCase();
        const cat = (log.category || '').toLowerCase();
        const amt = log.amount.toString();
        const date = log.date ? log.date.toDate().toLocaleDateString().toLowerCase() : '';
        return desc.includes(search) || cat.includes(search) || amt.includes(search) || date.includes(search);
    });

    document.getElementById('activity-count').textContent = `${filteredLogs.length} records`;
    if (filteredLogs.length === 0) return list.innerHTML = '<div class="text-center text-gray-400 py-8">No transactions found.</div>';
    
    filteredLogs.slice(0, 50).forEach(log => {
        const date = log.date ? log.date.toDate().toLocaleDateString() : 'Unknown';
        // Display 'knownAs' if it exists, otherwise fall back to the original locked note
        const desc = log.knownAs || log.note || log.potName;
                const isNegative = log.amount < 0;
                const catObj = categories.find(c => c.id === log.category) || { icon: 'fa-circle', label: 'General' };
                const icon = log.isRoundUp ? 'fa-coins' : catObj.icon;
                
                let subLabel = `${catObj.label} • Logged: ${date}`;
                if(log.originalDate) subLabel = `${catObj.label} • Bank: ${log.originalDate} | Logged: ${date}`;

                const el = document.createElement('div');
                el.className = 'activity-row bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 flex justify-between items-center';
                el.onclick = () => openTransactionDetails(log, catObj, isNegative); // Click Handler

                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full ${isNegative ? 'bg-red-50 text-red-500' : 'bg-brand-50 text-brand-600'} flex items-center justify-center text-sm">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm">${desc}</p>
                            <p class="text-[10px] text-gray-400 capitalize">${subLabel}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="font-bold block ${isNegative ? 'text-red-600' : 'text-brand-600'}">
                            ${isNegative ? '-' : '+'}${currency}${Math.abs(log.amount).toFixed(2)}
                        </span>
                        <span class="text-[10px] text-gray-400">${log.potName}</span>
                    </div>
                `;
                list.appendChild(el);
            });
        };

        // --- TRANSACTION DETAILS & MOVING LOGIC ---
        // --- ADD THIS ANYWHERE IN YOUR MAIN LOGIC LISTENER (e.g. inside the logs onSnapshot listener) ---
        const updatePersonalLedgerDisplay = () => {
            const personalLogs = logs.filter(l => l.potId === 'personal');
            const total = personalLogs.reduce((sum, l) => sum + l.amount, 0);
            const el = document.getElementById('personal-total-display');
            if(el) el.textContent = total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        };
        // Don't forget to call updatePersonalLedgerDisplay() inside your logs onSnapshot callback!


        // --- REPLACE THESE THREE FUNCTIONS ---
        window.openTransactionDetails = (log, catObj, isNegative) => {
            currentEditingLog = log;
            document.getElementById('txn-detail-amount').textContent = `${isNegative ? '-' : '+'}${currency}${Math.abs(log.amount).toFixed(2)}`;
            document.getElementById('txn-detail-amount').className = `text-2xl font-bold ${isNegative ? 'text-red-500' : 'text-emerald-500'}`;
            document.getElementById('txn-locked-desc').textContent = log.note || 'No Original Description';
            document.getElementById('txn-edit-known-as').value = log.knownAs || '';
            document.getElementById('txn-detail-date').textContent = log.date ? log.date.toDate().toLocaleString() : 'Unknown Date';
            
            const iconContainer = document.getElementById('txn-detail-icon');
            iconContainer.className = `w-16 h-16 rounded-full mx-auto flex items-center justify-center text-2xl mb-3 ${isNegative ? 'bg-red-50 text-red-500' : 'bg-brand-50 text-brand-600'}`;
            iconContainer.innerHTML = `<i class="fa-solid ${log.isRoundUp ? 'fa-coins' : catObj.icon}"></i>`;

            const catSelect = document.getElementById('txn-edit-category');
            catSelect.innerHTML = categories.map(c => `<option value="${c.id}" ${c.id === log.category ? 'selected' : ''}>${c.label}</option>`).join('');

            // FIX: Add 'Virtual' Personal Ledger to the dropdown so it doesn't default to the first real person
            const select = document.getElementById('txn-move-select');
            let selectHTML = `<option value="personal" ${log.potId === 'personal' ? 'selected' : ''}>Personal Ledger</option>`;
            selectHTML += pots.map(p => `<option value="${p.id}" ${p.id === log.potId ? 'selected' : ''}>${p.name} (${p.balance >= 0 ? '+' : '-'}$${Math.abs(p.balance).toFixed(2)})</option>`).join('');
            select.innerHTML = selectHTML;

            document.getElementById('transaction-details-modal').classList.remove('hidden');
        };

        document.getElementById('txn-update-btn').addEventListener('click', async () => {
            if(!currentEditingLog) return;
            
            const newPotId = document.getElementById('txn-move-select').value;
            const oldPotId = currentEditingLog.potId;
            const amount = currentEditingLog.amount;
            
            let logUpdates = {
                knownAs: document.getElementById('txn-edit-known-as').value.trim(),
                category: document.getElementById('txn-edit-category').value
            };

            if(newPotId !== oldPotId) {
                // If removing from a person, reverse the balance impact
                if(oldPotId !== 'personal') {
                    await updateDoc(doc(db, `users/${user.uid}/moneyPots`, oldPotId), { balance: increment(-amount) });
                }
                
                // If assigning to a new person, apply the balance impact
                if(newPotId !== 'personal') {
                    const newPot = pots.find(p => p.id === newPotId);
                    await updateDoc(doc(db, `users/${user.uid}/moneyPots`, newPotId), { balance: increment(amount) });
                    logUpdates.potName = newPot.name;
                } else {
                    logUpdates.potName = 'Personal Ledger';
                }
                logUpdates.potId = newPotId;
            }

            await updateDoc(doc(db, `users/${user.uid}/moneyLogs`, currentEditingLog.id), logUpdates);
            showToast("Transaction Updated!");
            closeModal('transaction-details-modal');
        });

        document.getElementById('txn-delete-btn').addEventListener('click', async () => {
            if(!currentEditingLog) return;
            if(confirm("Delete this transaction? This will reverse the balance change.")) {
                 const potId = currentEditingLog.potId;
                 const amount = currentEditingLog.amount;
                 
                 // Only reverse balance if it was linked to an actual person pot
                 if(potId !== 'personal') {
                     await updateDoc(doc(db, `users/${user.uid}/moneyPots`, potId), { balance: increment(-amount) });
                 }
                 
                await deleteDoc(doc(db, `users/${user.uid}/moneyLogs`, currentEditingLog.id));
                closeModal('transaction-details-modal');
                showToast("Deleted");
            }
        });

        // --- RENDER POTS ---
        const renderPots = () => {
    const list = document.getElementById('pots-list');
    list.innerHTML = '';
    if(pots.length === 0) return list.innerHTML = `<div class="p-8 text-center text-gray-400 bg-white dark:bg-gray-800 rounded-2xl border border-dashed border-gray-300"><p>No people added yet.</p></div>`;

    pots.forEach(pot => {
        // Positive balance = they owe you. Negative balance = you owe them.
        const isOwedToMe = pot.balance >= 0;
        const balanceText = isOwedToMe ? `Owes you ${currency}${pot.balance.toFixed(2)}` : `You owe ${currency}${Math.abs(pot.balance).toFixed(2)}`;
        const colorClass = isOwedToMe ? 'text-brand-600 dark:text-brand-400' : 'text-red-600 dark:text-red-400';

        const el = document.createElement('div');
        el.className = 'card pot-card flex justify-between items-center cursor-pointer hover:shadow-md transition-all group';
        el.onclick = () => openPotDetails(pot);

        el.innerHTML = `
            <div class="flex-grow">
                <div class="flex justify-between items-end mb-1">
                    <h3 class="font-bold text-gray-900 dark:text-white">${pot.name}</h3>
                    <span class="font-bold text-sm ${colorClass}">${balanceText}</span>
                </div>
            </div>
            <div class="ml-4 flex gap-2">
                <button class="w-9 h-9 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center" onclick="event.stopPropagation(); openDepositModal('${pot.id}', '${pot.name}', 'withdrawal')" title="They Paid (You Owe)">
                    <i class="fa-solid fa-arrow-down"></i>
                </button>
                <button class="w-9 h-9 rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 flex items-center justify-center" onclick="event.stopPropagation(); openDepositModal('${pot.id}', '${pot.name}', 'deposit')" title="You Paid (They Owe)">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        `;
        list.appendChild(el);
    });
};

        const updatePendingAlert = () => {
            const el = document.getElementById('pending-imports-alert');
            if(pendingTransactions.length > 0) el.classList.remove('hidden'); else el.classList.add('hidden');
        };

        const renderSubscriptions = () => {
            const list = document.getElementById('sub-list');
            list.innerHTML = subs.length ? '' : '<p class="text-gray-400 text-center text-sm">No subscriptions yet.</p>';
            subs.forEach(sub => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600';
                el.innerHTML = `
                    <div><p class="font-bold text-sm">${sub.name}</p><p class="text-xs text-gray-500">Next: ${sub.nextPayment}</p></div>
                    <div class="flex items-center gap-2"><span class="font-bold">$${sub.amount}</span><button onclick="deleteSub('${sub.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>
                `;
                list.appendChild(el);
            });
        };

        const checkSubscriptions = async () => {
            if(pots.length === 0) return;
            const today = new Date().toISOString().split('T')[0];
            const dueSubs = subs.filter(s => s.nextPayment <= today);
            for (const sub of dueSubs) {
                const targetPot = pots[0]; 
                await updateDoc(doc(db, `users/${user.uid}/moneyPots`, targetPot.id), { balance: increment(-sub.amount) });
                await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount: -sub.amount, potId: targetPot.id, potName: targetPot.name, note: `Sub: ${sub.name}`, category: sub.category, date: Timestamp.now(), isRoundUp: false });
                const nextDate = new Date(sub.nextPayment);
                nextDate.setMonth(nextDate.getMonth() + 1);
                await updateDoc(doc(db, `users/${user.uid}/moneySubs`, sub.id), { nextPayment: nextDate.toISOString().split('T')[0] });
                showToast(`Paid Subscription: ${sub.name}`);
            }
        };

        window.saveSubscription = async () => {
            const name = document.getElementById('sub-name').value;
            const amount = parseFloat(document.getElementById('sub-amount').value);
            const date = document.getElementById('sub-date').value;
            if(!name || !amount || !date) return alert("Fill all fields");
            await addDoc(collection(db, `users/${user.uid}/moneySubs`), { name, amount, nextPayment: date, category: 'bills' });
            document.getElementById('sub-name').value = '';
            document.getElementById('sub-amount').value = '';
            showToast("Subscription Added");
            renderSubscriptions();
        };

        window.deleteSub = async (id) => {
            if(confirm("Stop tracking this subscription?")) await deleteDoc(doc(db, `users/${user.uid}/moneySubs`, id));
        };

        window.exportData = () => {
            if(logs.length === 0) return alert("No data to export.");
            let csvContent = "data:text/csv;charset=utf-8,Date,Description,Amount,Category,Pot\n";
            logs.forEach(row => {
                const date = row.date.toDate().toLocaleDateString();
                const desc = (row.note || row.potName).replace(/,/g, " ");
                csvContent += `${date},${desc},${row.amount},${row.category || 'other'},${row.potName}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "moneymanagr_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- IMPORT LOGIC ---
        const fileInput = document.getElementById('csv-file-input');
        if(fileInput) {
            fileInput.addEventListener('change', (e) => {
                if(e.target.files.length > 0) {
                    document.getElementById('import-mapping').classList.remove('hidden');
                    document.getElementById('process-import-btn').classList.remove('hidden');
                }
            });
        }

        document.getElementById('process-import-btn').addEventListener('click', () => {
            const file = fileInput.files[0];
            const reader = new FileReader();
            const dateCol = parseInt(document.getElementById('map-date').value);
            const descCol = parseInt(document.getElementById('map-desc').value);
            const amtCol = parseInt(document.getElementById('map-amount').value);

            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                let newImports = [];
                
                // Build a set of existing hashes to detect duplicates instantly
                const existingHashes = new Set(logs.map(l => l.txHash));

                for(let i=1; i<lines.length; i++) {
                    const row = lines[i].split(','); 
                    if(row.length < 3) continue;
                    
                    let rawDate = row[dateCol]?.replace(/"/g, '').trim();
                    let rawDesc = row[descCol]?.replace(/"/g, '').trim();
                    let amountStr = row[amtCol]?.replace(/"/g, '').replace(/£/g, '').replace(/\$/g, '').trim();
                    let amount = parseFloat(amountStr);
                    
                    if(isNaN(amount) || !rawDate) continue;

                    // Create unique fingerprint for the transaction
                    const txHash = `${rawDate}_${rawDesc}_${amount}`;
                    
                    if (existingHashes.has(txHash)) continue; // Skip existing statements
                    if (pendingTransactions.some(p => p.hash === txHash)) continue; // Skip if already in pending

                    newImports.push({ 
                        id: Date.now() + i, 
                        date: rawDate, 
                        desc: rawDesc, 
                        amount: amount,
                        hash: txHash 
                    });
                }
                
                pendingTransactions = [...pendingTransactions, ...newImports];
                localStorage.setItem(`moneymanagr_pending_${user.uid}`, JSON.stringify(pendingTransactions));
                closeModal('import-modal');
                updatePendingAlert();
                openPendingTransactions();
                showToast(`Imported ${newImports.length} new transactions`);
            };
            reader.readAsText(file);
        });

        window.openPendingTransactions = () => { document.getElementById('categorize-modal').classList.remove('hidden'); renderInbox(); };
        const renderInbox = () => {
            const list = document.getElementById('inbox-list');
            document.getElementById('inbox-count').textContent = pendingTransactions.length;
            list.innerHTML = '';
            if(pendingTransactions.length === 0) return list.innerHTML = `<div class="p-8 text-center text-gray-400"><i class="fa-solid fa-check-circle text-4xl mb-4 text-green-500"></i><p>All caught up!</p></div>`;
            pendingTransactions.forEach(txn => {
                const el = document.createElement('div');
                el.className = 'import-item pending bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700';
                el.onclick = () => openActionModal(txn);
                el.innerHTML = `<div><p class="font-bold text-sm truncate max-w-[200px]">${txn.desc}</p><p class="text-xs text-gray-400">${txn.date}</p></div><span class="font-bold ${txn.amount < 0 ? 'text-gray-800 dark:text-gray-200' : 'text-green-600'}">${txn.amount.toFixed(2)}</span>`;
                list.appendChild(el);
            });
        };

        // Setup categories for the action modal
        const setupActionModal = () => {
            const catHTML = categories.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
            document.getElementById('action-category').innerHTML = catHTML;
        };
        setTimeout(setupActionModal, 1000);

        window.toggleActionType = (type) => {
            const btnPers = document.getElementById('action-tab-personal');
            const btnPot = document.getElementById('action-tab-person');
            const viewPers = document.getElementById('action-personal-view');
            const viewPot = document.getElementById('action-person-view');

            if (type === 'personal') {
                btnPers.classList.add('active'); btnPot.classList.remove('active');
                viewPers.classList.remove('hidden'); viewPot.classList.add('hidden');
            } else {
                btnPot.classList.add('active'); btnPers.classList.remove('active');
                viewPot.classList.remove('hidden'); viewPers.classList.add('hidden');
            }
        };

        window.openActionModal = (txn) => {
            currentActionTxn = txn;
            
            document.getElementById('action-desc').textContent = txn.desc;
            document.getElementById('action-date').textContent = txn.date;
            document.getElementById('action-amount').textContent = `${txn.amount < 0 ? '-' : '+'}${currency}${Math.abs(txn.amount).toFixed(2)}`;
            document.getElementById('action-amount').className = `text-2xl font-extrabold my-2 ${txn.amount < 0 ? 'text-gray-900 dark:text-white' : 'text-emerald-500'}`;
            document.getElementById('action-known-as').value = ""; // Clear input

            // Populate Person Dropdown
            const select = document.getElementById('action-pot-select');
            select.innerHTML = pots.length === 0 ? '<option value="">No Pots Added</option>' : pots.map(pot => `<option value="${pot.id}">${pot.name} (${pot.balance >= 0 ? 'Owes you ' : 'You owe '}${currency}${Math.abs(pot.balance).toFixed(2)})</option>`).join('');
            
            // Dynamic Hint for Debt Offset
            const hint = document.getElementById('action-person-hint');
            const btnConfirm = document.getElementById('btn-person-confirm');
            if (txn.amount < 0) {
                hint.textContent = `You paid for this. It will INCREASE their debt to you.`;
                hint.className = "text-xs text-center font-bold text-red-500 mt-2";
                btnConfirm.textContent = "Add to their Debt";
            } else {
                hint.textContent = `They paid you. This will OFFSET (reduce) their debt to you.`;
                hint.className = "text-xs text-center font-bold text-emerald-500 mt-2";
                btnConfirm.textContent = "Offset Deficit";
            }

            toggleActionType('personal');
            document.getElementById('action-modal').classList.remove('hidden');
        };

        window.applyCategorization = async (actionType) => {
            if(!currentActionTxn) return;
            const amt = currentActionTxn.amount;
            const note = currentActionTxn.desc;
            const originalDate = currentActionTxn.date;
            const knownAs = document.getElementById('action-known-as').value.trim();
            const category = document.getElementById('action-category').value;
            const txHash = currentActionTxn.hash || `${originalDate}_${note}_${amt}`;

            if (actionType === 'personal') {
                await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount: amt, potId: 'personal', potName: 'Personal Ledger', note, knownAs, category, date: Timestamp.now(), originalDate, isRoundUp: false, txHash });
                showToast("Logged Personal Expense");
                
            } else if (actionType === 'person') {
                if(pots.length === 0) return alert("Create a person/pot first!");
                const potId = document.getElementById('action-pot-select').value;
                const pot = pots.find(p => p.id === potId);
                const balanceChange = amt < 0 ? Math.abs(amt) : -amt;

                await updateDoc(doc(db, `users/${user.uid}/moneyPots`, potId), { balance: increment(balanceChange) });
                await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount: amt, potId, potName: pot.name, note, knownAs, category, date: Timestamp.now(), originalDate, isRoundUp: false, txHash });
                showToast(`Updated balance for ${pot.name}`);
            }

            pendingTransactions = pendingTransactions.filter(t => t.id !== currentActionTxn.id);
            localStorage.setItem(`moneymanagr_pending_${user.uid}`, JSON.stringify(pendingTransactions));
            closeModal('action-modal');
            renderInbox();
            updatePendingAlert();
        };

        window.applyAction = async (actionType) => {
            if(!currentActionTxn || pots.length === 0) return pots.length === 0 ? alert("Create a pot first!") : null;
            const potId = document.getElementById('action-pot-select').value;
            const amtAbs = Math.abs(currentActionTxn.amount);
            const note = currentActionTxn.desc;
            const originalDate = currentActionTxn.date;

            if (actionType === 'save') {
                await updateDoc(doc(db, `users/${user.uid}/moneyPots`, potId), { balance: increment(amtAbs) });
                await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount: amtAbs, potId, potName: 'Pot', note, category: 'income', date: Timestamp.now(), originalDate, isRoundUp: false });
                showToast("Saved Full Amount");
            } else if (actionType === 'roundup') {
                const ceil = Math.ceil(amtAbs);
                let diff = (ceil - amtAbs);
                if(diff === 0) diff = 1.00;
                diff = parseFloat(diff.toFixed(2));
                await updateDoc(doc(db, `users/${user.uid}/moneyPots`, potId), { balance: increment(diff) });
                await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount: diff, potId, potName: 'Pot', note: `Roundup: ${note}`, category: 'savings', date: Timestamp.now(), originalDate, isRoundUp: true });
                showToast(`Saved Round Up: $${diff}`);
            }
            pendingTransactions = pendingTransactions.filter(t => t.id !== currentActionTxn.id);
            localStorage.setItem(`moneymanagr_pending_${user.uid}`, JSON.stringify(pendingTransactions));
            closeModal('action-modal');
            renderInbox();
            updatePendingAlert();
        };

        // --- STANDARD HELPERS ---
        window.openPotDetails = (pot) => {
    document.getElementById('detail-pot-name').textContent = pot.name;
    
    const isOwedToMe = pot.balance >= 0;
    document.getElementById('detail-pot-target').textContent = isOwedToMe ? "They owe you" : "You owe them";
    document.getElementById('detail-pot-balance').textContent = Math.abs(pot.balance).toFixed(2);
    
    // Hide progress bar
    document.getElementById('detail-pot-progress').parentElement.style.display = 'none';
    
    document.getElementById('detail-deposit-btn').innerHTML = '<i class="fa-solid fa-arrow-up mr-1"></i> I Paid';
    document.getElementById('detail-deposit-btn').onclick = () => { closeModal('pot-details-modal'); openDepositModal(pot.id, pot.name, 'deposit'); };
    
    document.getElementById('detail-withdraw-btn').innerHTML = '<i class="fa-solid fa-arrow-down mr-1"></i> They Paid';
    document.getElementById('detail-withdraw-btn').onclick = () => { closeModal('pot-details-modal'); openDepositModal(pot.id, pot.name, 'withdrawal'); };

    document.getElementById('detail-edit-btn').onclick = async () => {
        const newName = prompt("Rename this person:", pot.name);
        if(newName && newName.trim() !== "" && newName !== pot.name) {
            await updateDoc(doc(db, `users/${user.uid}/moneyPots`, pot.id), { name: newName.trim() });
            document.getElementById('detail-pot-name').textContent = newName.trim();
            showToast("Name updated");
        }
    };
    
    document.getElementById('detail-delete-btn').onclick = async () => {
        // Updated requirement: Balance must be 0 to delete, not > 0
        if(pot.balance !== 0) return alert("Please settle the balance to $0.00 before deleting this person.");
        if(confirm(`Delete person "${pot.name}"?`)) {
            await deleteDoc(doc(db, `users/${user.uid}/moneyPots`, pot.id));
            closeModal('pot-details-modal');
            showToast("Person deleted");
        }
    };
    
    const histList = document.getElementById('detail-history-list');
    histList.innerHTML = '';
    const potLogs = logs.filter(l => l.potId === pot.id);
    if(potLogs.length === 0) {
        histList.innerHTML = '<p class="text-center text-gray-400 py-4 text-sm">No activity yet.</p>';
    } else {
        potLogs.forEach(log => {
            const date = log.date.toDate().toLocaleDateString();
            const isNegative = log.amount < 0;
            const catObj = categories.find(c => c.id === log.category) || { icon: 'fa-circle' };
            const el = document.createElement('div');
            el.className = 'flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700';
            el.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${isNegative ? 'bg-red-50 text-red-500' : 'bg-brand-50 text-brand-600'} flex items-center justify-center text-xs"><i class="fa-solid ${catObj.icon}"></i></div><div><p class="font-bold text-sm text-gray-800 dark:text-gray-200">${log.note || 'Transaction'}</p><p class="text-[10px] text-gray-400">${date}</p></div></div><span class="font-bold text-sm ${isNegative ? 'text-red-600' : 'text-brand-600'}">${isNegative ? '-' : '+'}${Math.abs(log.amount).toFixed(2)}</span>`;
            histList.appendChild(el);
        });
    }
    document.getElementById('pot-details-modal').classList.remove('hidden');
};

        document.getElementById('activity-search').addEventListener('keyup', renderActivity);
        
        const updateWeeklyTracker = () => {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            startOfWeek.setHours(0,0,0,0);
            const weeklyTotal = logs.filter(l => l.date.toDate() >= startOfWeek && l.amount > 0).reduce((sum, l) => sum + l.amount, 0);
            document.getElementById('weekly-total').textContent = weeklyTotal.toFixed(2);
            document.getElementById('weekly-progress').style.width = `${Math.min(100, (weeklyTotal / 50) * 100)}%`;
        };

        const updateTotalBalance = () => {
    let owedToMe = 0;
    let iOwe = 0;
    
    pots.forEach(pot => {
        if (pot.balance >= 0) {
            owedToMe += pot.balance;
        } else {
            iOwe += Math.abs(pot.balance);
        }
    });

    const netTotal = owedToMe - iOwe;
    
    document.getElementById('total-balance').textContent = Math.abs(netTotal).toLocaleString('en-US', {minimumFractionDigits: 2});
    
    const owedToMeEl = document.getElementById('total-owed-to-me');
    const iOweEl = document.getElementById('total-i-owe');
    if(owedToMeEl) owedToMeEl.textContent = owedToMe.toLocaleString('en-US', {minimumFractionDigits: 2});
    if(iOweEl) iOweEl.textContent = iOwe.toLocaleString('en-US', {minimumFractionDigits: 2});

    const label = document.getElementById('net-balance-label');
    const header = document.getElementById('balance-header');
    
    if(label && header) {
        if (netTotal >= 0) {
            label.textContent = "Net Balance (Credit)";
            label.className = "text-sm font-semibold uppercase tracking-wider text-emerald-600 dark:text-emerald-400 mb-1";
            header.className = "text-4xl font-extrabold tracking-tight flex items-center justify-center gap-1 text-emerald-600";
        } else {
            label.textContent = "Net Balance (Debt)";
            label.className = "text-sm font-semibold uppercase tracking-wider text-red-600 dark:text-red-400 mb-1";
            header.className = "text-4xl font-extrabold tracking-tight flex items-center justify-center gap-1 text-red-600";
        }
    }
};



        window.setTxType = (type) => {
    document.getElementById('tx-type').value = type;
    const depBtn = document.getElementById('type-btn-deposit');
    const withBtn = document.getElementById('type-btn-withdrawal');
    const symbol = document.getElementById('amount-symbol');
    const confirmBtn = document.getElementById('confirm-deposit-btn');
    
    depBtn.textContent = "I Paid (They Owe)";
    withBtn.textContent = "They Paid (I Owe)";

    if (type === 'deposit') {
        depBtn.classList.add('active'); withBtn.classList.remove('active');
        symbol.textContent = '+'; symbol.className = "absolute left-1/2 -ml-16 top-2 text-2xl text-emerald-500 font-bold";
        confirmBtn.className = "main-button"; confirmBtn.textContent = "Confirm I Paid";
    } else {
        withBtn.classList.add('active'); depBtn.classList.remove('active');
        symbol.textContent = '-'; symbol.className = "absolute left-1/2 -ml-16 top-2 text-2xl text-red-500 font-bold";
        confirmBtn.className = "danger-button w-full"; confirmBtn.textContent = "Confirm They Paid";
    }
};

        document.getElementById('confirm-deposit-btn').addEventListener('click', async () => {
            const potId = document.getElementById('deposit-pot-id').value;
            let amount = parseFloat(document.getElementById('deposit-amount').value);
            const potName = document.getElementById('deposit-pot-name').textContent.replace('Account: ', '');
            let note = document.getElementById('deposit-note').value.trim();
            const type = document.getElementById('tx-type').value;
            const category = document.querySelector('input[name="category"]:checked')?.value || 'other';
            if(!amount || amount <= 0) return;
            if(type === 'withdrawal') amount = -amount; 
            if (!note) note = type === 'deposit' ? 'Deposit' : 'Expense';
            if (type === 'withdrawal') {
                const pot = pots.find(p => p.id === potId);
            }
            await updateDoc(doc(db, `users/${user.uid}/moneyPots`, potId), { balance: increment(amount) });
            await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount, potId, potName, note, category, date: Timestamp.now(), isRoundUp: false });
            closeModal('deposit-modal');
            showToast(type === 'deposit' ? 'Added!' : 'Spent!');
        });

        document.getElementById('save-pot-btn').addEventListener('click', async () => {
            const name = document.getElementById('pot-name').value;
            const target = parseFloat(document.getElementById('pot-target').value) || 1000;
            if(!name) return;
            await addDoc(collection(db, `users/${user.uid}/moneyPots`), { name, target, balance: 0, createdAt: Timestamp.now() });
            closeModal('pot-modal');
        });

        document.getElementById('generate-roundup-btn').addEventListener('click', async () => {
            if(pots.length === 0) return alert("Create an account first!");
            const amount = parseFloat((Math.random() * 0.90 + 0.10).toFixed(2));
            const targetPot = pots[0];
            await updateDoc(doc(db, `users/${user.uid}/moneyPots`, targetPot.id), { balance: increment(amount) });
            await addDoc(collection(db, `users/${user.uid}/moneyLogs`), { amount, potId: targetPot.id, potName: targetPot.name, note: 'Random Roundup', category: 'savings', date: Timestamp.now(), isRoundUp: true });
            showToast(`Saved round up: ${currency}${amount}`);
        });

        window.openBudgetModal = () => {
            const select = document.getElementById('budget-category');
            select.innerHTML = categories.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
            document.getElementById('budget-modal').classList.remove('hidden');
            renderBudgetProgress();
        };
        window.saveBudget = async () => {
            const cat = document.getElementById('budget-category').value;
            const limit = parseFloat(document.getElementById('budget-limit').value);
            if(!limit) return;
            const existing = budgets.find(b => b.category === cat);
            if(existing) {
                await updateDoc(doc(db, `users/${user.uid}/moneyBudgets`, existing.id), { limit });
            } else {
                await addDoc(collection(db, `users/${user.uid}/moneyBudgets`), { category: cat, limit });
            }
            renderBudgetProgress();
        };
        const renderBudgetProgress = () => {
            const container = document.getElementById('budget-list');
            if(!container) return;
            container.innerHTML = budgets.length ? '' : '<p class="text-center text-gray-400">No budgets set.</p>';
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthlyExpenses = logs.filter(l => l.date.toDate() >= startOfMonth && l.amount < 0);
            budgets.forEach(b => {
                const spent = monthlyExpenses.filter(l => l.category === b.category).reduce((sum, l) => sum + Math.abs(l.amount), 0);
                const percent = Math.min(100, (spent / b.limit) * 100);
                const catLabel = categories.find(c => c.id === b.category)?.label || b.category;
                let colorClass = 'bg-brand-500';
                if(percent > 80) colorClass = 'bg-yellow-500';
                if(percent >= 100) colorClass = 'bg-red-500';
                const div = document.createElement('div');
                div.innerHTML = `<div class="flex justify-between text-sm mb-1"><span class="font-bold">${catLabel}</span>
                    <span class="text-gray-500">${currency}${spent.toFixed(0)} / ${currency}${b.limit}</span>
                    </div><div class="progress-bar-bg"><div class="progress-bar-fill ${colorClass}" style="width: ${percent}%"></div></div>`;
                container.appendChild(div);
            });
        };

        const updateBreakdownChart = () => {
            const ctx = document.getElementById('breakdown-chart');
            if(!ctx || logs.length === 0) return;
            const expenses = logs.filter(l => l.amount < 0);
            const categoryTotals = {};
            expenses.forEach(log => {
                const catId = log.category || 'other';
                const catLabel = categories.find(c => c.id === catId)?.label || 'Other';
                if (!categoryTotals[catLabel]) categoryTotals[catLabel] = 0;
                categoryTotals[catLabel] += Math.abs(log.amount);
            });
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const bgColors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#64748b'];
            if (breakdownChart) breakdownChart.destroy();
            breakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors, borderWidth: 0, hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: "'Inter', sans-serif", size: 11 } } } }, cutout: '70%' }
            });
        };

        window.openImportModal = () => document.getElementById('import-modal').classList.remove('hidden');
        window.openPotModal = () => document.getElementById('pot-modal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openSubscriptionModal = () => document.getElementById('subscription-modal').classList.remove('hidden');
        
        const showToast = (msg = 'Saved!') => {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const setupCategoryGrid = () => {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = categories.map(cat => `
                <label class="cursor-pointer">
                    <input type="radio" name="category" value="${cat.id}" class="category-radio hidden">
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-2 text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors h-full flex flex-col items-center justify-center gap-1">
                        <i class="fa-solid ${cat.icon} text-lg"></i>
                        <span class="text-[10px] font-bold">${cat.label}</span>
                    </div>
                </label>
            `).join('');
            const first = grid.querySelector('input');
            if(first) first.checked = true;
        };
        setupCategoryGrid();

        const updateProjection = () => {
            const weeklyDeposit = parseFloat(document.getElementById('proj-deposit').value);
            const years = parseInt(document.getElementById('proj-years').value);
            const r = 0.05 / 52; 
            const n = years * 52;
            const fv = weeklyDeposit * (((Math.pow(1 + r, n) - 1) / r));
            document.getElementById('proj-total').textContent = currency + Math.round(fv).toLocaleString();
            renderProjectionChart(weeklyDeposit, years);
        };
        const renderProjectionChart = (deposit, years) => {
            const ctx = document.getElementById('projection-chart').getContext('2d');
            const data = [];
            let r = 0.05 / 52;
            for(let i=1; i<=years; i++) data.push(deposit * (((Math.pow(1 + r, i*52) - 1) / r)));
            if (projectionChart) projectionChart.destroy();
            projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: years}, (_, i) => `Year ${i+1}`),
                    datasets: [{ data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        };
        document.getElementById('proj-deposit').addEventListener('input', updateProjection);
        document.getElementById('proj-years').addEventListener('input', updateProjection);

        document.getElementById('sign-in-btn').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
        });
        document.getElementById('sign-up-btn').addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
        });
    </script>
</body>
</html>