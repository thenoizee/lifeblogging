<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PetManagr | Lifeblogging</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'128'%20height%3D'128'%20viewBox%3D'0%200%20128%20128'%3E%3Cdefs%3E%3ClinearGradient%20id%3D'g'%20x1%3D'85.35533905932738%25'%20y1%3D'85.35533905932738%25'%20x2%3D'14.644660940672615%25'%20y2%3D'14.64466094067263%25'%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'0%25'%20style%3D'stop-color%3A%234f46e5%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'100%25'%20style%3D'stop-color%3A%239333ea%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect%20width%3D'128'%20height%3D'128'%20rx%3D'25.6'%20fill%3D'url(%23g)'%20%2F%3E%3Cg%20transform%3D'translate(0%2C%200)%20rotate(0%2C%2064%2C%2064)'%3E%3Csvg%20x%3D'16'%20y%3D'16'%20width%3D'96'%20height%3D'96'%20viewBox%3D'0%200%20512%20512'%3E%3Cpath%20fill%3D'%236366f1'%20fill-opacity%3D'1'%20d%3D'M226.5%2092.9c14.3%2042.9-.3%2086.2-32.6%2096.8s-70.1-15.6-84.4-58.5s.3-86.2%2032.6-96.8s70.1%2015.6%2084.4%2058.5zM100.4%20198.6c18.9%2032.4%2014.3%2070.1-10.2%2084.1s-59.7-.9-78.5-33.3S-2.7%20179.3%2021.8%20165.3s59.7%20.9%2078.5%2033.3zM69.2%20401.2C121.6%20259.9%20214.7%20224%20256%20224s134.4%2035.9%20186.8%20177.2c3.6%209.7%205.2%2020.1%205.2%2030.5v1.6c0%2025.8-20.9%2046.7-46.7%2046.7c-11.5%200-22.9-1.4-34-4.2l-88-22c-15.3-3.8-31.3-3.8-46.6%200l-88%2022c-11.1%202.8-22.5%204.2-34%204.2C84.9%20480%2064%20459.1%2064%20433.3v-1.6c0-10.4%201.6-20.8%205.2-30.5zM421.8%20282.7c-24.5-14-29.1-51.7-10.2-84.1s54-47.3%2078.5-33.3s29.1%2051.7%2010.2%2084.1s-54%2047.3-78.5%2033.3zM310.1%20189.7c-32.3-10.6-46.9-53.9-32.6-96.8s52.1-69.1%2084.4-58.5s46.9%2053.9%2032.6%2096.8s-52.1%2069.1-84.4%2058.5z'%20%2F%3E%3C%2Fsvg%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW failed:', err));
            });
        }
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.2s ease-in-out; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal.active .modal-content { transform: scale(1); }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: rgba(0,0,0,0.05); }
        .dark th.sortable:hover { background-color: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300 min-h-screen pb-20 md:pb-0">

    <div id="auth-overlay" class="fixed inset-0 z-[60] bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-paw text-3xl text-indigo-600 dark:text-indigo-400"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">PetManagr</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8">Manage your pets, treatments, and vet history.</p>
            <div class="space-y-4 text-left">
                <input id="email" type="email" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input id="password" type="password" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button id="sign-in-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg shadow-indigo-500/30">Log In</button>
                    <button id="sign-up-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-bold py-3 px-4 rounded-xl transition">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden container mx-auto max-w-5xl p-4 md:p-6">
        
        <div id="tab-dashboard" class="tab-content block animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-bell text-yellow-500"></i> Upcoming Reminders</h2>
                        <div id="dashboard-reminders-container" class="space-y-3"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-blue-500"></i> Recent Activity</h2>
                        <div id="dashboard-recent-events-container" class="space-y-3"></div>
                    </div>
                </div>

                <div class="space-y-6">
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h2 class="text-lg font-bold mb-4">Weight Trends</h2>
                        <div class="relative h-48 w-full"><canvas id="weightChart"></canvas></div>
                        <p class="text-xs text-center text-gray-400 mt-2">Last 5 weight logs</p>
                    </div>
                    <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg shadow-indigo-500/20 text-white">
                        <h2 class="text-lg font-bold mb-2">Quick Stats</h2>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-white/10 p-3 rounded-lg">
                                <span class="block text-2xl font-bold" id="total-pets-count">0</span>
                                <span class="text-xs opacity-75">Pets</span>
                            </div>
                            <div class="bg-white/10 p-3 rounded-lg">
                                <span class="block text-2xl font-bold" id="total-events-count">0</span>
                                <span class="text-xs opacity-75">Events</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-pets" class="tab-content hidden animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">My Pets</h2>
                <button onclick="document.getElementById('add-pet-details').open = !document.getElementById('add-pet-details').open" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                    <i class="fa-solid fa-plus mr-1"></i> Add Pet
                </button>
            </div>

            <details id="add-pet-details" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6 group">
                <summary class="list-none cursor-pointer font-semibold text-indigo-500 hidden">Add New</summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="new-pet-name" type="text" placeholder="Pet Name" class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                    <input id="new-pet-breed" type="text" placeholder="Breed / Species" class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                    <input id="new-pet-dob" type="date" class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                    <div class="flex gap-2">
                        <input id="new-pet-icon" type="hidden" value="fa-solid fa-paw">
                        <button id="new-pet-icon-button" class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-200 transition text-2xl flex items-center justify-center">
                            <i id="icon-preview" class="fa-solid fa-paw text-indigo-600"></i>
                        </button>
                        <button id="add-pet-btn" class="flex-[3] bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition">Save Pet</button>
                    </div>
                </div>
            </details>

            <div id="pet-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-treatments" class="tab-content hidden animate-fade-in">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
                <h3 class="font-bold text-lg mb-4">Define Recurring Treatments</h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <input id="new-treatment-name" type="text" placeholder="Treatment Name (e.g. Flea)" class="flex-grow p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                    <input id="new-treatment-frequency" type="number" placeholder="Days (e.g. 30)" class="w-full md:w-32 p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                    <button id="add-treatment-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-3 rounded-lg transition whitespace-nowrap">Add Type</button>
                </div>
            </div>
            <div class="grid gap-4" id="treatment-list"></div>
        </div>

        <div id="tab-log" class="tab-content hidden animate-fade-in">
            <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 md:p-8 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
                <h2 class="text-2xl font-bold mb-6 text-center">Log Activity</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-500">Who?</label>
                        <select id="log-event-pet-select" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-lg"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-500">What?</label>
                            <select id="log-event-type-select" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                                <option value="Vet Visit">Vet Visit</option>
                                <option value="Weight">Weight Check</option>
                                <option value="Medication">Medication</option>
                                <option value="Note">General Note</option>
                                <option value="Grooming">Grooming</option>
                            </select>
                        </div>
                        <div>
                             <label class="block text-sm font-semibold mb-1 text-gray-500">When?</label>
                             <input id="event-datetime" type="datetime-local" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-sm">
                        </div>
                    </div>
                    
                    <div id="weight-input-group" class="hidden">
                        <label class="block text-sm font-semibold mb-1 text-gray-500">Weight (kg)</label>
                        <input id="event-weight" type="number" step="0.01" placeholder="0.00" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                    </div>

                    <div id="next-due-input-group" class="hidden">
                        <label class="block text-sm font-semibold mb-1 text-indigo-500">Next Due Date (Reminder)</label>
                        <input id="event-next-due" type="date" class="w-full p-3 rounded-xl bg-indigo-50 dark:bg-gray-800 border border-indigo-200 dark:border-indigo-900">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-500">Notes</label>
                        <textarea id="event-notes" rows="3" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600" placeholder="Details..."></textarea>
                    </div>

                    <button id="log-event-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-indigo-500/30 transition transform active:scale-95">
                        <i class="fa-solid fa-check mr-2"></i> Save Entry
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-history" class="tab-content hidden animate-fade-in">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                     <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="search-input" placeholder="Search by pet, type, or notes..." class="w-full pl-10 p-3 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700 text-xs uppercase text-gray-500 dark:text-gray-300">
                            <tr>
                                <th class="p-3 sortable" data-sort="date">Date <span class="sort-icon"></span></th>
                                <th class="p-3 sortable" data-sort="petName">Pet <span class="sort-icon"></span></th>
                                <th class="p-3 sortable" data-sort="type">Type <span class="sort-icon"></span></th>
                                <th class="p-3">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="event-table-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="tab-settings" class="tab-content hidden animate-fade-in">
             <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Data Management</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="export-json-btn" class="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 py-3 px-4 rounded-lg font-semibold transition">
                        <i class="fa-solid fa-file-code mr-2"></i> Export JSON
                    </button>
                    <button id="export-csv-btn" class="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 py-3 px-4 rounded-lg font-semibold transition">
                        <i class="fa-solid fa-file-csv mr-2"></i> Export CSV
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="icon-picker-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-2xl max-w-lg w-full m-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Select Icon</h2>
                <button class="close-btn text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="icon-picker-grid" class="grid grid-cols-6 gap-3 max-h-60 overflow-y-auto p-1"></div>
        </div>
    </div>
    
    <div id="edit-pet-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-2xl max-w-lg w-full m-4 shadow-2xl max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Edit Pet</h2>
                <button class="close-btn text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="space-y-4">
                <input id="modal-pet-name" type="text" placeholder="Name" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                <input id="modal-pet-breed" type="text" placeholder="Breed" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                <input id="modal-pet-dob" type="date" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                <div class="flex items-center gap-2">
                    <input id="modal-pet-icon" type="hidden">
                    <i id="modal-icon-preview" class="text-2xl"></i>
                    <button id="modal-pet-icon-button" class="text-sm bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded hover:bg-gray-300">Change Icon</button>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="font-bold text-sm mb-2 text-gray-500 uppercase">Assigned Treatments</h3>
                    <div id="modal-pet-treatments-container" class="space-y-2 text-sm"></div>
                </div>
                <button id="modal-save-pet-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="edit-event-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-2xl max-w-md w-full m-4 shadow-2xl">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Edit Event</h2>
                <button class="close-btn text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
             <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Pet</label>
                        <input id="modal-event-pet-name" type="text" disabled class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-900 border-none text-gray-500 cursor-not-allowed text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Type</label>
                        <input id="modal-event-type" type="text" disabled class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-900 border-none text-gray-500 cursor-not-allowed text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Date</label>
                    <input id="modal-event-datetime" type="datetime-local" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Notes</label>
                    <textarea id="modal-event-notes" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600"></textarea>
                </div>
                <div class="flex gap-3">
                    <button id="modal-delete-event-btn" class="flex-1 bg-red-100 dark:bg-red-900/30 text-red-600 py-3 rounded-lg font-bold hover:bg-red-200">Delete</button>
                    <button id="modal-save-event-btn" class="flex-[2] bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">Update</button>
                </div>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed top-20 left-1/2 -translate-x-1/2 z-[70] transition-all duration-300 transform scale-90 opacity-0 pointer-events-none px-6 py-3 rounded-full shadow-xl font-bold text-white text-sm"></div>

    <script type="module">
      import { AppNavigation } from '../shared-nav.js';
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, Timestamp, doc, deleteDoc, updateDoc, getDocs, writeBatch, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Firebase Init ---
      const firebaseConfig = {
        apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
        authDomain: "sammy-7298f.firebaseapp.com",
        projectId: "sammy-7298f",
        storageBucket: "sammy-7298f.firebasestorage.app",
        messagingSenderId: "963185683535",
        appId: "1:963185683535:web:807df8941feba46c208e3a",
        measurementId: "G-JT1YF2ELN3",
      };
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- Navigation ---
      const nav = new AppNavigation({
          appName: 'PetManagr',
          appIcon: 'fa-paw',
          themeColor: 'indigo',
          activeTab: 'dashboard',
          tabs: [
              { id: 'dashboard', label: 'Dashboard', icon: 'fa-gauge-high' },
              { id: 'pets', label: 'Pets', icon: 'fa-cat' },
              { id: 'treatments', label: 'Treatments', icon: 'fa-kit-medical' },
              { id: 'log', label: 'Log Event', icon: 'fa-pen-to-square' },
              { id: 'history', label: 'History', icon: 'fa-list' },
              { id: 'settings', label: 'Settings', icon: 'fa-cog' }
          ],
          onThemeChange: () => { if(window.weightChartInstance) window.weightChartInstance.update(); }
      });

      // --- State ---
      const appState = {
          user: null,
          pets: [],
          treatments: [],
          events: [],
          currentModalEventId: null,
          currentModalPetId: null,
          currentIconPickerTarget: null,
          sort: { column: 'date', direction: 'desc' },
          filter: ''
      };

      const ICON_LIST = ['fa-solid fa-paw', 'fa-solid fa-cat', 'fa-solid fa-dog', 'fa-solid fa-fish', 'fa-solid fa-dove', 'fa-solid fa-spider', 'fa-solid fa-otter', 'fa-solid fa-horse', 'fa-solid fa-bug', 'fa-solid fa-crow'];
      
      const showMessage = (msg, type = "success") => {
          const el = document.getElementById('message-box');
          el.textContent = msg;
          el.className = `fixed top-20 left-1/2 -translate-x-1/2 z-[70] transition-all duration-300 transform px-6 py-3 rounded-full shadow-xl font-bold text-white text-sm ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} scale-100 opacity-100`;
          setTimeout(() => el.classList.add('opacity-0', 'scale-90'), 3000);
      };

      const toLocalISOString = (date) => {
        const d = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        return d.toISOString().slice(0, 16);
      };

      const renderAll = () => {
          renderPets();
          renderTreatments();
          renderDashboard();
          renderHistory(); // Renders table with current sort/filter
          updateWeightChart();
          document.getElementById('total-pets-count').textContent = appState.pets.length;
          document.getElementById('total-events-count').textContent = appState.events.length;
      };

      // --- Chart.js ---
      window.weightChartInstance = null;
      const updateWeightChart = () => {
          const ctx = document.getElementById('weightChart').getContext('2d');
          const weightEvents = appState.events
            .filter(e => e.type === 'Weight' && e.weight)
            .sort((a,b) => new Date(a.date) - new Date(b.date))
            .slice(-10);

          const data = {
              labels: weightEvents.map(e => new Date(e.date).toLocaleDateString()),
              datasets: [{
                  label: 'Weight (kg)',
                  data: weightEvents.map(e => e.weight),
                  borderColor: '#4f46e5',
                  backgroundColor: 'rgba(79, 70, 229, 0.1)',
                  fill: true,
                  tension: 0.4
              }]
          };

          if(window.weightChartInstance) {
              window.weightChartInstance.data = data;
              window.weightChartInstance.update();
          } else {
              window.weightChartInstance = new Chart(ctx, {
                  type: 'line', data: data,
                  options: {
                      responsive: true, maintainAspectRatio: false,
                      plugins: { legend: { display: false } },
                      scales: { y: { beginAtZero: false } }
                  }
              });
          }
      };

      // --- Renderers ---
      const renderPets = () => {
          const list = document.getElementById('pet-list');
          const select = document.getElementById('log-event-pet-select');
          list.innerHTML = '';
          select.innerHTML = '<option value="" disabled selected>Select a Pet...</option>';

          appState.pets.forEach(pet => {
              select.appendChild(new Option(pet.name, pet.id));
              const div = document.createElement('div');
              div.className = "bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center justify-between group hover:border-indigo-200 dark:hover:border-indigo-900 transition";
              div.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-indigo-50 dark:bg-gray-700 text-indigo-600 flex items-center justify-center text-xl">
                        <i class="${pet.icon || 'fa-paw'}"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">${pet.name}</h3>
                        <p class="text-xs text-gray-500">${pet.breed || 'Unknown'}</p>
                    </div>
                </div>
                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="edit-pet-btn w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:text-indigo-600" data-id="${pet.id}"><i class="fa-solid fa-pen"></i></button>
                    <button class="delete-pet-btn w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100" data-id="${pet.id}"><i class="fa-solid fa-trash"></i></button>
                </div>
              `;
              list.appendChild(div);
          });
          document.querySelectorAll('.edit-pet-btn').forEach(b => b.onclick = (e) => handleEditPet(e.currentTarget.dataset.id));
          document.querySelectorAll('.delete-pet-btn').forEach(b => b.onclick = (e) => handleDeletePet(e.currentTarget.dataset.id));
      };

      const renderTreatments = () => {
          const list = document.getElementById('treatment-list');
          list.innerHTML = '';
          const logSelect = document.getElementById('log-event-type-select');
          
          Array.from(logSelect.options).forEach(opt => { if(opt.dataset.dynamic) opt.remove(); });

          appState.treatments.forEach(t => {
             const opt = new Option(t.name, t.name);
             opt.dataset.dynamic = "true"; // Used for logic check
             logSelect.appendChild(opt);

             const div = document.createElement('div');
             div.className = "flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700";
             div.innerHTML = `
                <div>
                    <span class="font-bold block">${t.name}</span>
                    <span class="text-xs text-gray-500">Repeats every ${t.frequencyDays} days</span>
                </div>
                <button class="text-red-400 hover:text-red-600 delete-treatment-btn" data-id="${t.id}"><i class="fa-solid fa-trash"></i></button>
             `;
             list.appendChild(div);
          });
          document.querySelectorAll('.delete-treatment-btn').forEach(b => b.onclick = (e) => handleDeleteTreatment(e.currentTarget.dataset.id));
      };

      const renderDashboard = () => {
          const container = document.getElementById('dashboard-reminders-container');
          container.innerHTML = '';
          const now = new Date();
          let reminders = [];

          appState.pets.forEach(pet => {
              (pet.assignedTreatments || []).forEach(assigned => {
                  const treatment = appState.treatments.find(t => t.id === assigned.treatmentId);
                  if(!treatment) return;
                  const lastEvent = appState.events
                      .filter(e => e.petId === pet.id && e.type === treatment.name)
                      .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                  
                  const baseDate = lastEvent ? new Date(lastEvent.date) : new Date(assigned.startDate);
                  const nextDate = new Date(baseDate);
                  nextDate.setDate(nextDate.getDate() + parseInt(treatment.frequencyDays));
                  reminders.push({ pet: pet.name, task: treatment.name, date: nextDate });
              });
          });
          
          appState.events.forEach(e => {
              if(e.nextDueDate) reminders.push({ pet: e.petName, task: `Follow up: ${e.type}`, date: new Date(e.nextDueDate) });
          });

          reminders.sort((a,b) => a.date - b.date);
          
          if(reminders.length === 0) container.innerHTML = `<div class="text-center py-4 text-gray-400 text-sm">No upcoming tasks.</div>`;

          reminders.slice(0, 5).forEach(r => {
              const diff = Math.ceil((r.date - now) / (1000 * 60 * 60 * 24));
              let colorClass = diff < 0 ? 'bg-red-100 text-red-700' : (diff < 7 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700');
              const div = document.createElement('div');
              div.className = "flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50";
              div.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold uppercase px-2 py-1 rounded ${colorClass}">${diff < 0 ? 'Due' : diff + 'd'}</span>
                    <div>
                        <p class="font-bold text-sm">${r.task}</p>
                        <p class="text-xs text-gray-500">${r.pet}</p>
                    </div>
                </div>
                <span class="text-xs text-gray-400">${r.date.toLocaleDateString()}</span>
              `;
              container.appendChild(div);
          });
          
          const recentContainer = document.getElementById('dashboard-recent-events-container');
          recentContainer.innerHTML = '';
          appState.events.slice(0,5).forEach(e => {
             const div = document.createElement('div');
             div.className = "text-sm border-l-2 border-indigo-400 pl-3 py-1";
             div.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-semibold">${e.type}</span>
                    <span class="text-xs text-gray-400">${new Date(e.date).toLocaleDateString()}</span>
                </div>
                <p class="text-gray-500">${e.petName} ${e.weight ? `(${e.weight}kg)` : ''}</p>
             `;
             recentContainer.appendChild(div);
          });
      };
      
      const renderHistory = () => {
          const tbody = document.getElementById('event-table-body');
          tbody.innerHTML = '';
          
          // Sort Logic
          const sorted = [...appState.events].sort((a,b) => {
              const valA = (a[appState.sort.column] || '').toString().toLowerCase();
              const valB = (b[appState.sort.column] || '').toString().toLowerCase();
              return appState.sort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });

          // Filter Logic
          const filtered = sorted.filter(e => {
              const term = appState.filter.toLowerCase();
              return e.petName.toLowerCase().includes(term) || e.type.toLowerCase().includes(term) || (e.notes || '').toLowerCase().includes(term);
          });

          // Update Icons
          document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '');
          const activeHeader = document.querySelector(`th[data-sort="${appState.sort.column}"] .sort-icon`);
          if(activeHeader) activeHeader.textContent = appState.sort.direction === 'asc' ? ' ▲' : ' ▼';

          if(filtered.length === 0) {
              tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">No events found.</td></tr>`;
              return;
          }

          filtered.forEach(e => {
              const row = document.createElement('tr');
              row.className = "hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition border-b border-gray-100 dark:border-gray-800";
              row.onclick = () => handleEditEvent(e.id);
              row.innerHTML = `
                <td class="p-3 text-gray-500">${new Date(e.date).toLocaleDateString()}</td>
                <td class="p-3 font-semibold">${e.petName}</td>
                <td class="p-3"><span class="px-2 py-1 rounded bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-xs font-bold">${e.type}</span></td>
                <td class="p-3 text-gray-500 truncate max-w-[150px]">${e.notes || '-'}</td>
              `;
              tbody.appendChild(row);
          });
      };

      // --- Interaction Listeners ---
      document.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', () => {
              const col = th.dataset.sort;
              if(appState.sort.column === col) {
                  appState.sort.direction = appState.sort.direction === 'asc' ? 'desc' : 'asc';
              } else {
                  appState.sort.column = col;
                  appState.sort.direction = 'asc';
              }
              renderHistory();
          });
      });

      document.getElementById('search-input').addEventListener('input', (e) => {
          appState.filter = e.target.value;
          renderHistory();
      });

      // Show/Hide Fields in Log Form
      document.getElementById('log-event-type-select').addEventListener('change', (e) => {
         const val = e.target.value;
         const opt = e.target.options[e.target.selectedIndex];
         const isDynamic = opt.dataset.dynamic === "true";
         
         document.getElementById('weight-input-group').classList.toggle('hidden', val !== 'Weight');
         
         // Show 'Next Due' for Vet Visits AND Custom Treatments
         const showDue = (val === 'Vet Visit' || isDynamic);
         document.getElementById('next-due-input-group').classList.toggle('hidden', !showDue);
      });

      // --- CRUD Operations ---
      document.getElementById('add-pet-btn').onclick = async () => {
          const name = document.getElementById('new-pet-name').value;
          if(!name) return showMessage('Name required', 'error');
          await addDoc(collection(db, `users/${appState.user.uid}/pets`), {
              name, 
              breed: document.getElementById('new-pet-breed').value,
              dob: document.getElementById('new-pet-dob').value,
              icon: document.getElementById('new-pet-icon').value,
              petCreatedAt: Timestamp.now()
          });
          showMessage('Pet added');
          document.getElementById('new-pet-name').value = '';
          document.getElementById('add-pet-details').open = false;
      };

      document.getElementById('add-treatment-btn').onclick = async () => {
         const name = document.getElementById('new-treatment-name').value;
         const days = document.getElementById('new-treatment-frequency').value;
         if(!name || !days) return showMessage('Details required', 'error');
         await addDoc(collection(db, `users/${appState.user.uid}/pet_treatments`), {
             name, frequencyDays: days
         });
         showMessage('Treatment added');
         document.getElementById('new-treatment-name').value = '';
         document.getElementById('new-treatment-frequency').value = '';
      };
      
      const handleDeleteTreatment = async (id) => {
          if(!confirm('Delete this treatment?')) return;
          await deleteDoc(doc(db, `users/${appState.user.uid}/pet_treatments`, id));
          showMessage('Treatment deleted');
      };

      const handleDeletePet = async (id) => {
          if(!confirm('Delete this pet and all history?')) return;
          const batch = writeBatch(db);
          batch.delete(doc(db, `users/${appState.user.uid}/pets`, id));
          appState.events.filter(e => e.petId === id).forEach(e => {
              batch.delete(doc(db, `users/${appState.user.uid}/pet_events`, e.id));
          });
          await batch.commit();
          showMessage('Pet deleted');
      };

      document.getElementById('log-event-btn').onclick = async () => {
         const petId = document.getElementById('log-event-pet-select').value;
         if(!petId) return showMessage('Select a pet', 'error');
         const pet = appState.pets.find(p => p.id === petId);
         
         await addDoc(collection(db, `users/${appState.user.uid}/pet_events`), {
             petId,
             petName: pet.name,
             type: document.getElementById('log-event-type-select').value,
             date: document.getElementById('event-datetime').value,
             notes: document.getElementById('event-notes').value,
             weight: document.getElementById('event-weight').value || null,
             nextDueDate: document.getElementById('event-next-due').value || null,
             eventCreatedAt: Timestamp.now()
         });
         showMessage('Event logged');
         nav.switchTab('history');
      };

      // --- Modals ---
      const handleEditPet = (id) => {
          const pet = appState.pets.find(p => p.id === id);
          if(!pet) return;
          appState.currentModalPetId = id;
          document.getElementById('modal-pet-name').value = pet.name;
          document.getElementById('modal-pet-breed').value = pet.breed || '';
          document.getElementById('modal-pet-dob').value = pet.dob || '';
          document.getElementById('modal-pet-icon').value = pet.icon || 'fa-solid fa-paw';
          document.getElementById('modal-icon-preview').className = pet.icon || 'fa-solid fa-paw';
          
          const tContainer = document.getElementById('modal-pet-treatments-container');
          tContainer.innerHTML = '';
          appState.treatments.forEach(t => {
              const assigned = (pet.assignedTreatments || []).find(at => at.treatmentId === t.id);
              const div = document.createElement('div');
              div.className = "flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded";
              div.innerHTML = `
                <label class="flex items-center gap-2 font-semibold">
                    <input type="checkbox" class="treatment-chk rounded text-indigo-600" data-tid="${t.id}" ${assigned ? 'checked' : ''}>
                    ${t.name}
                </label>
                <input type="date" class="treatment-date text-xs p-1 rounded border dark:bg-gray-800 dark:border-gray-600" id="date-${t.id}" value="${assigned ? assigned.startDate : ''}">
              `;
              tContainer.appendChild(div);
          });
          document.getElementById('edit-pet-modal').classList.add('active');
      };
      
      document.getElementById('modal-save-pet-btn').onclick = async () => {
          const assigned = [];
          document.querySelectorAll('.treatment-chk:checked').forEach(chk => {
             const tid = chk.dataset.tid;
             const date = document.getElementById(`date-${tid}`).value;
             if(date) assigned.push({ treatmentId: tid, startDate: date });
          });
          await updateDoc(doc(db, `users/${appState.user.uid}/pets`, appState.currentModalPetId), {
              name: document.getElementById('modal-pet-name').value,
              breed: document.getElementById('modal-pet-breed').value,
              dob: document.getElementById('modal-pet-dob').value,
              icon: document.getElementById('modal-pet-icon').value,
              assignedTreatments: assigned
          });
          document.getElementById('edit-pet-modal').classList.remove('active');
          showMessage('Pet updated');
      };

      const handleEditEvent = (id) => {
          const e = appState.events.find(ev => ev.id === id);
          appState.currentModalEventId = id;
          // Restore Context (Read Only)
          document.getElementById('modal-event-pet-name').value = e.petName;
          document.getElementById('modal-event-type').value = e.type;
          
          document.getElementById('modal-event-datetime').value = e.date;
          document.getElementById('modal-event-notes').value = e.notes || '';
          document.getElementById('edit-event-modal').classList.add('active');
      };

      document.getElementById('modal-save-event-btn').onclick = async () => {
          await updateDoc(doc(db, `users/${appState.user.uid}/pet_events`, appState.currentModalEventId), {
              date: document.getElementById('modal-event-datetime').value,
              notes: document.getElementById('modal-event-notes').value
          });
          document.getElementById('edit-event-modal').classList.remove('active');
          showMessage('Event updated');
      };
      
      document.getElementById('modal-delete-event-btn').onclick = async () => {
          if(!confirm('Delete this event?')) return;
          await deleteDoc(doc(db, `users/${appState.user.uid}/pet_events`, appState.currentModalEventId));
          document.getElementById('edit-event-modal').classList.remove('active');
          showMessage('Event deleted');
      };

      document.querySelectorAll('.close-btn').forEach(btn => btn.onclick = (e) => {
          e.target.closest('.modal').classList.remove('active');
      });

      const renderIcons = () => {
          const grid = document.getElementById('icon-picker-grid');
          grid.innerHTML = '';
          ICON_LIST.forEach(icon => {
              const btn = document.createElement('button');
              btn.className = "text-2xl p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition";
              btn.innerHTML = `<i class="${icon}"></i>`;
              btn.onclick = () => {
                  if(appState.currentIconPickerTarget === 'new') {
                      document.getElementById('new-pet-icon').value = icon;
                      document.getElementById('icon-preview').className = icon + ' text-indigo-600';
                  } else {
                       document.getElementById('modal-pet-icon').value = icon;
                       document.getElementById('modal-icon-preview').className = icon;
                  }
                  document.getElementById('icon-picker-modal').classList.remove('active');
              };
              grid.appendChild(btn);
          });
      };
      document.getElementById('new-pet-icon-button').onclick = () => { appState.currentIconPickerTarget = 'new'; document.getElementById('icon-picker-modal').classList.add('active'); };
      document.getElementById('modal-pet-icon-button').onclick = () => { appState.currentIconPickerTarget = 'modal'; document.getElementById('icon-picker-modal').classList.add('active'); };
      renderIcons();

      // --- Export ---
      document.getElementById('export-json-btn').onclick = async () => {
          const data = { pets: appState.pets, events: appState.events, treatments: appState.treatments };
          const a = document.createElement('a');
          a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
          a.download = `petmanagr_export.json`;
          a.click();
      };
      document.getElementById('export-csv-btn').onclick = () => {
           const csv = Papa.unparse(appState.events.map(e => ({...e, date: new Date(e.date).toISOString()})));
           const a = document.createElement('a');
           a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
           a.download = `petmanagr_events.csv`;
           a.click();
      };

      // --- Tabs ---
      window.addEventListener('tab-changed', (e) => {
          const tabId = e.detail.tabId;
          document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
          const target = document.getElementById(`tab-${tabId}`);
          if(target) target.classList.remove('hidden');
          if(tabId === 'log') document.getElementById('event-datetime').value = toLocalISOString(new Date());
          if(tabId === 'dashboard') updateWeightChart();
      });

      // --- Auth ---
      onAuthStateChanged(auth, (user) => {
          if (user) {
              appState.user = user;
              nav.updateUser(user.email);
              document.getElementById('auth-overlay').classList.add('hidden');
              document.getElementById('main-app').classList.remove('hidden');
              onSnapshot(query(collection(db, `users/${user.uid}/pets`), orderBy('name')), snap => { appState.pets = snap.docs.map(d => ({id: d.id, ...d.data()})); renderAll(); });
              onSnapshot(query(collection(db, `users/${user.uid}/pet_treatments`), orderBy('name')), snap => { appState.treatments = snap.docs.map(d => ({id: d.id, ...d.data()})); renderAll(); });
              onSnapshot(query(collection(db, `users/${user.uid}/pet_events`), orderBy('date', 'desc')), snap => { appState.events = snap.docs.map(d => ({id: d.id, ...d.data()})); renderAll(); });
          } else {
              document.getElementById('auth-overlay').classList.remove('hidden');
              document.getElementById('main-app').classList.add('hidden');
          }
      });

      document.getElementById('sign-in-btn').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => showMessage(e.message, 'error'));
      document.getElementById('sign-up-btn').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => showMessage(e.message, 'error'));
      window.addEventListener('app-logout-request', () => signOut(auth));
    </script>
</body>
</html>