<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Lifeblogging Hub</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'128'%20height%3D'128'%20viewBox%3D'0%200%20128%20128'%3E%3Cdefs%3E%3C%2Fdefs%3E%3Crect%20width%3D'128'%20height%3D'128'%20rx%3D'25.6'%20fill%3D'%234f46e5'%20fill-opacity%3D'0'%20%2F%3E%3Cg%20transform%3D'translate(0%2C%200)%20rotate(0%2C%2064%2C%2064)'%3E%3Csvg%20x%3D'16'%20y%3D'16'%20width%3D'96'%20height%3D'96'%20viewBox%3D'0%200%20576%20512'%3E%3Cpath%20fill%3D'%236366f1'%20fill-opacity%3D'1'%20d%3D'M264.5%205.2c14.9-6.9%2032.1-6.9%2047%200l218.6%20101c8.5%203.9%2013.9%2012.4%2013.9%2021.8s-5.4%2017.9-13.9%2021.8l-218.6%20101c-14.9%206.9-32.1%206.9-47%200L45.9%20149.8C37.4%20145.8%2032%20137.3%2032%20128s5.4-17.9%2013.9-21.8L264.5%205.2zM476.9%20209.6l53.2%2024.6c8.5%203.9%2013.9%2012.4%2013.9%2021.8s-5.4%2017.9-13.9%2021.8l-218.6%20101c-14.9%206.9-32.1%206.9-47%200L45.9%20277.8C37.4%20273.8%2032%20265.3%2032%20256s5.4-17.9%2013.9-21.8l53.2-24.6%20152%2070.2c23.4%2010.8%2050.4%2010.8%2073.8%200l152-70.2zm-152%20198.2l152-70.2%2053.2%2024.6c8.5%203.9%2013.9%2012.4%2013.9%2021.8s-5.4%2017.9-13.9%2021.8l-218.6%20101c-14.9%206.9-32.1%206.9-47%200L45.9%20405.8C37.4%20401.8%2032%20393.3%2032%20384s5.4-17.9%2013.9-21.8l53.2-24.6%20152%2070.2c23.4%2010.8%2050.4%2010.8%2073.8%200z'%20%2F%3E%3C%2Fsvg%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="manifest" href="/manifest.json" />
    <style>
    :root {
        --bg-color: #f7f7f7;
        --card-bg: #ffffff;
        --text-primary: #111111;
        --text-secondary: #666666;
        --border-color: #e5e5e5;
        --accent: #dfff00; 
        --accent-fg: #000000;
        --radius: 6px; 
    }
    .dark {
        --bg-color: #161616; 
        --card-bg: #1c1c1c;  
        --text-primary: #ffffff;
        --text-secondary: #888888;
        --border-color: #333333;
        --accent: #dfff00;
        --accent-fg: #000000;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        min-height: 100vh;
        letter-spacing: -0.015em; 
    }

    .clock-widget {
        margin-top: 0.15rem;
        color: var(--text-secondary);
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
    }
    .clock-time {
        font-weight: 700;
        color: var(--text-primary);
        margin-right: 0.5rem;
    }

    #app-search {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        transition: all 0.2s;
    }
    #app-search:focus {
        border-color: var(--text-primary);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        outline: none;
    }

    .app-card {
        display: flex;
        align-items: center;
        padding: 0.75rem; 
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        text-decoration: none;
        transition: all 0.15s ease-in-out;
        position: relative;
        overflow: hidden;
    }
    
    .app-card:hover {
        transform: translateY(-1px);
        border-color: var(--text-primary); 
        background-color: var(--card-bg);
    }
    
    .app-card:hover::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background-color: var(--accent);
    }

    .app-card.hidden-app { display: none; }
    
    /* Layout Editing Visibility Styles */
    .hidden-app-pref { display: none !important; }
    .layout-editing .hidden-app-pref {
        display: flex !important;
        opacity: 0.4;
        border-style: dashed;
    }
    .layout-editing .app-card {
        cursor: pointer;
    }
    .app-hide-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
        display: none;
        z-index: 10;
    }
    .layout-editing .app-hide-btn {
        display: block;
    }

    .app-icon-wrapper {
        width: 2rem; 
        height: 2rem;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        color: white; 
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .app-content {
        flex-grow: 1;
        min-width: 0;
    }
    .app-title {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-primary);
        line-height: 1.2;
    }
    .app-desc {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 0.1rem;
        font-weight: 500;
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid var(--border-color);
    }
    .section-title {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 700;
        color: var(--text-secondary);
        margin-right: 0.75rem;
    }
    .section-badge { display: none; } 

    .hub-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 0.5rem; 
    }
    @media (min-width: 640px) {
        .hub-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 1024px) {
        .hub-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    }
    
    #auth-container {
        min-height: 100vh;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .auth-card {
        background-color: var(--card-bg);
        padding: 2.5rem;
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        width: 100%;
        max-width: 400px;
        text-align: center;
    }
    
    button { font-weight: 600; letter-spacing: -0.01em; }
    
    #sign-in-btn {
        background-color: var(--accent);
        color: var(--accent-fg);
        box-shadow: none;
        border: 1px solid transparent;
    }
    #sign-in-btn:hover { opacity: 0.9; }
</style>
</head>
<body>
    <div id="main-app-container" class="container mx-auto px-4 pb-6 pt-2" style="display: none;">
        
        <div class="mb-4 text-center md:text-left flex flex-col md:flex-row justify-between items-end">
            <div>
                <h1 class="text-2xl font-bold mb-0.5">Welcome, <span id="user-name-display">Guest</span></h1>
                <div class="clock-widget">
                    <span id="clock-time" class="clock-time">00:00:00</span>
                    <span id="clock-date" class="clock-date">Loading...</span>
                </div>
            </div>
        </div>

        <div class="mb-4 flex gap-2 max-w-2xl">
            <div class="relative flex-grow">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400 text-sm"></i>
                <input type="text" id="app-search" placeholder="Search apps..." 
                    class="w-full pl-10 pr-4 py-2.5 text-sm rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white shadow-sm transition-all">
            </div>
            <button id="edit-hub-btn" class="px-4 py-2 rounded-xl bg-[var(--card-bg)] border border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 transition text-[var(--text-secondary)]" title="Edit Visibility"><i class="fas fa-pen"></i></button>
        </div>

        <div class="mb-5">
            <div class="section-header">
                <span class="section-title">Daily & Tracking</span>
            </div>
            <div class="hub-grid" id="apps-daily">
                <a href="/dashboard" id="app-dashboard" class="app-card hover:text-slate-600 dark:hover:text-slate-400">
                    <div class="app-icon-wrapper bg-slate-700"><i class="fa-solid fa-gauge-high"></i></div>
                    <div class="app-content"><div class="app-title">Dashboard</div><div class="app-desc">See an overview of all app metrics in the Lifeblogging ecocsystem.</div></div>
                </a>
                
                <a href="/tasktrackr" id="app-tasktrackr" class="app-card hover:text-blue-600 dark:hover:text-blue-400">
                    <div class="app-icon-wrapper bg-blue-600"><i class="fa-solid fa-check-double"></i></div>
                    <div class="app-content"><div class="app-title">TaskTrackr</div><div class="app-desc">Keep track of all tasks.</div></div>
                </a>

                <a href="/foodtrackr" id="app-foodtrackr" class="app-card hover:text-orange-600 dark:hover:text-orange-400">
                    <div class="app-icon-wrapper bg-orange-600"><i class="fa-solid fa-utensils"></i></div>
                    <div class="app-content"><div class="app-title">FoodTrackr</div><div class="app-desc">Keep track of all consumed food and drink and sourdough starter health. </div></div>
                </a>

                <a href="/hydrationtrackr" id="app-hydrationtrackr" class="app-card hover:text-cyan-600 dark:hover:text-cyan-400">
                    <div class="app-icon-wrapper bg-cyan-600"><i class="fa-solid fa-droplet"></i></div>
                    <div class="app-content"><div class="app-title">HydrationTrackr</div><div class="app-desc">Keep a record of water intake.</div></div>
                </a>

                <a href="/medimanagr" id="app-medimanagr" class="app-card hover:text-pink-600 dark:hover:text-pink-400">
                    <div class="app-icon-wrapper bg-pink-600"><i class="fa-solid fa-pills"></i></div>
                    <div class="app-content"><div class="app-title">MediManagr</div><div class="app-desc">Keep a record of medicines.</div></div>
                </a>

                <a href="/log" id="app-log" class="app-card hover:text-green-600 dark:hover:text-green-400">
                    <div class="app-icon-wrapper bg-green-600"><i class="fa-solid fa-pen-to-square"></i></div>
                    <div class="app-content"><div class="app-title">Logger</div><div class="app-desc">Quick daily logging tool.</div></div>
                </a>

                <a href="/petmanagr" id="app-petmanagr" class="app-card hover:text-indigo-600 dark:hover:text-indigo-400">
                    <div class="app-icon-wrapper bg-indigo-600"><i class="fa-solid fa-paw"></i></div>
                    <div class="app-content"><div class="app-title">PetManagr</div><div class="app-desc">Keep a record of pet care.</div></div>
                </a>

                <a href="/planttrackr" id="app-planttrackr" class="app-card hover:text-green-600 dark:hover:text-green-400">
                    <div class="app-icon-wrapper bg-green-600"><i class="fa-solid fa-leaf"></i></div>
                    <div class="app-content"><div class="app-title">PlantTrackr</div><div class="app-desc">Keep track of all plants.</div></div>
                </a>
            </div>
        </div>

        <div class="mb-5">
            <div class="section-header">
                <span class="section-title">Media</span>
            </div>
            <div class="hub-grid" id="apps-media">
                <a href="/vidtrackr" id="app-vidtrackr" class="app-card hover:text-red-600 dark:hover:text-red-400">
                    <div class="app-icon-wrapper bg-red-600"><i class="fa-solid fa-ticket"></i></div>
                    <div class="app-content"><div class="app-title">VidTrackr</div><div class="app-desc">Keep a record of TV show & movie watching.</div></div>
                </a>

                <a href="/podtrackr" id="app-podtrackr" class="app-card hover:text-purple-600 dark:hover:text-purple-400">
                    <div class="app-icon-wrapper bg-purple-600"><i class="fa-solid fa-podcast"></i></div>
                    <div class="app-content"><div class="app-title">PodTrackr</div><div class="app-desc">Keep a record of podcast listening.</div></div>
                </a>
            </div>
        </div>

        <div class="mb-5">
            <div class="section-header">
                <span class="section-title">Management</span>
            </div>
            <div class="hub-grid" id="apps-general">
                <a href="/analyser" id="app-analyser" class="app-card hover:text-indigo-600 dark:hover:text-indigo-400">
                    <div class="app-icon-wrapper bg-indigo-600"><i class="fa-solid fa-chart-line"></i></div>
                    <div class="app-content"><div class="app-title">Analyser</div><div class="app-desc">Analyse data & view trends in data across all apps in the ecosystem.</div></div>
                </a>
                <a href="/recipemanagr" id="app-recipemanagr" class="app-card hover:text-teal-600 dark:hover:text-teal-400">
                    <div class="app-icon-wrapper bg-teal-600"><i class="fa-solid fa-book-open"></i></div>
                    <div class="app-content"><div class="app-title">RecipeManagr</div><div class="app-desc">Keep a record of recipes, cooking and baking.</div></div>
                </a>
                
                <a href="/routetrackr" id="app-routetrackr" class="app-card hover:text-lime-600 dark:hover:text-lime-400">
                    <div class="app-icon-wrapper bg-lime-600"><i class="fa-solid fa-map-location-dot"></i></div>
                    <div class="app-content"><div class="app-title">RouteTrackr</div><div class="app-desc">Plan paths & track journeys.</div></div>
                </a>

                <a href="/vehiclemanagr" id="app-vehiclemanagr" class="app-card hover:text-zinc-600 dark:hover:text-zinc-400">
                    <div class="app-icon-wrapper bg-zinc-600"><i class="fa-solid fa-car-tunnel"></i></div>
                    <div class="app-content"><div class="app-title">VehicleManagr</div><div class="app-desc">Keep a record of car maintenance and fuel log history.</div></div>
                </a>
                
                <a href="/warrantytrackr" id="app-warrantytrackr" class="app-card hover:text-emerald-600 dark:hover:text-emerald-400">
                    <div class="app-icon-wrapper bg-emerald-600"><i class="fa-solid fa-shield-halved"></i></div>
                    <div class="app-content"><div class="app-title">WarrantyTrackr</div><div class="app-desc">Keep track of all active and expiring warranties.</div></div>
                </a>
            </div>
        </div>

        <div class="mb-5">
             <div class="section-header">
                <span class="section-title">Utilities</span>
            </div>
            <div class="hub-grid" id="tools-list">
                <a href="/account" id="app-account" class="app-card group">
                    <div class="app-icon-wrapper bg-gray-700 group-hover:bg-[#dfff00] group-hover:text-black transition-colors duration-200">
                        <i class="fa-solid fa-user-gear"></i>
                    </div>
                    <div class="app-content">
                        <div class="app-title">Account</div>
                        <div class="app-desc">Profile & Settings</div>
                    </div>
                </a>
                 <a href="/work" id="app-work" class="app-card hover:text-fuchsia-600 dark:hover:text-fuchsia-400">
                    <div class="app-icon-wrapper bg-fuchsia-600"><i class="fas fa-envelope-open-text"></i></div>
                    <div class="app-content"><div class="app-title">Text Generator</div><div class="app-desc">Text placeholder tool.</div></div>
                </a>
                
                <a href="/labelgenerator" id="app-labelgenerator" class="app-card hover:text-lime-600 dark:hover:text-lime-400">
                    <div class="app-icon-wrapper bg-lime-600"><i class="fas fa-print"></i></div>
                    <div class="app-content"><div class="app-title">Label Generator</div><div class="app-desc">Printable labels.</div></div>
                </a>

                 <a href="/pdftools" id="app-pdftools" class="app-card hover:text-rose-600 dark:hover:text-rose-400">
                    <div class="app-icon-wrapper bg-rose-600"><i class="fas fa-file-pdf"></i></div>
                    <div class="app-content"><div class="app-title">PDF Tools</div><div class="app-desc">PDF Tool Suite</div></div>
                </a>

                <a href="/time" id="app-time" class="app-card hover:text-sky-600 dark:hover:text-sky-400">
                    <div class="app-icon-wrapper bg-sky-600"><i class="fas fa-clock"></i></div>
                    <div class="app-content"><div class="app-title">Time Tool</div><div class="app-desc">Time Tools</div></div>
                </a>

                 <a href="/converter" id="app-converter" class="app-card hover:text-amber-600 dark:hover:text-amber-400">
                    <div class="app-icon-wrapper bg-amber-600"><i class="fas fa-exchange-alt"></i></div>
                    <div class="app-content"><div class="app-title">Converter</div><div class="app-desc">CSV to JSON</div></div>
                </a>

                 <a href="/palette" id="app-palette" class="app-card hover:text-emerald-600 dark:hover:text-emerald-400">
                    <div class="app-icon-wrapper bg-emerald-600"><i class="fas fa-palette"></i></div>
                    <div class="app-content"><div class="app-title">Palette Gen</div><div class="app-desc">Colour Schemes</div></div>
                </a>
                
                <a href="/icongenerator" id="app-icongenerator" class="app-card hover:text-pink-400 dark:hover:text-pink-200">
                    <div class="app-icon-wrapper bg-pink-400"><i class="fas fa-box"></i></div>
                    <div class="app-content"><div class="app-title">Icon Generator</div><div class="app-desc">Icon Generator</div></div>
                </a>
                <a href="/lightmanagr" id="app-lightmanagr" class="app-card hover:text-yellow-500 dark:hover:text-yellow-600">
                    <div class="app-icon-wrapper bg-yellow-600"><i class="fas fa-lightbulb"></i></div>
                    <div class="app-content"><div class="app-title">LightManagr</div><div class="app-desc">Smart home light management.</div></div>
                </a>
            </div>
        </div>

        <div class="border-t border-gray-200 dark:border-gray-800 pt-4 flex flex-col md:flex-row justify-center items-center gap-4 text-xs text-gray-500">
             <a href="/changelog" class="hover:text-indigo-500 relative flex items-center gap-2">
                <i class="fa-solid fa-list-check"></i> Changelog
                <div id="changelog-badge" class="notification-dot"></div>
            </a>
            <span class="hidden md:inline">•</span>
            <a href="https://github.com/thenoizee/lifeblogging" class="hover:text-gray-800 dark:hover:text-gray-300 flex items-center gap-2">
                <i class="fa-brands fa-github"></i> GitHub
            </a>
            <span class="hidden md:inline">•</span>
            <span id="version-display" class="font-mono text-[10px] opacity-75">v0.0.0</span>
        </div>
    </div>
    <div id="auth-container" style="display: none;">
        <div class="auth-card">
            <div class="text-indigo-600 mb-4 text-4xl"><i class="fa-solid fa-layer-group"></i></div>
            <h1 class="text-2xl font-bold mb-2 dark:text-white">Life Hub</h1>
            <p class="text-gray-500 mb-6 text-sm">Sign in to access your dashboard</p>
            
            <div class="space-y-3">
                <input type="email" id="email" placeholder="Email" class="w-full rounded-lg p-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all">
                <input type="password" id="password" placeholder="Password" class="w-full rounded-lg p-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all">
                
                <div class="flex gap-2">
                    <button id="sign-in-btn" class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Log In</button>
                    <button id="sign-up-btn" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-semibold py-2.5 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">Sign Up</button>
                </div>
                
                <button id="google-sign-in-btn" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-semibold py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center gap-2">
                    <i class="fa-brands fa-google text-red-500"></i> Google
                </button>
                
                <button id="anonymous-sign-in-btn" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 mt-2">Continue as Guest</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-2xl text-white font-semibold transition-all duration-300 opacity-0 translate-y-10" role="alert"></div>

    <script>
        try {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.classList.add('dark');
            }
        } catch (e) {}

        window.addEventListener('DOMContentLoaded', () => {
            const hasCachedUser = Object.keys(localStorage).some(key => key.startsWith('firebase:authUser'));
            const main = document.getElementById('main-app-container');
            const auth = document.getElementById('auth-container');
            
            if (hasCachedUser) {
                if(main) main.style.display = 'block';
                if(auth) auth.style.display = 'none';
                const nameEl = document.getElementById('user-name-display');
                if(nameEl) nameEl.innerText = '...';
            } else {
                if(main) main.style.display = 'none';
                if(auth) auth.style.display = 'flex';
            }
        });
    </script>

    <script type="module">
        import { changelogData } from '/changelog-data.js';
        import { AppNavigation } from '/shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const nav = new AppNavigation({
            appName: 'Lifeblogging Hub',
            appIcon: 'fa-layer-group',
            themeColor: 'indigo',
            userEmail: 'Guest',
            version: changelogData[0].version,
            search: null, 
            onThemeChange: (theme) => {}
        });

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const el = (id) => document.getElementById(id);
        const els = {
            auth: el('auth-container'),
            main: el('main-app-container'),
            msgBox: el('message-box'),
            badge: el('changelog-badge'),
            version: el('version-display'),
            userName: el('user-name-display'),
            clockTime: el('clock-time'),
            clockDate: el('clock-date'),
            search: el('app-search')
        };

        els.version.textContent = changelogData[0].version;

        const hasCachedUser = Object.keys(localStorage).some(key => key.startsWith('firebase:authUser'));
        if (hasCachedUser) {
            els.auth.style.display = 'none';
            els.main.style.display = 'block';
            els.userName.textContent = '...'; 
        }

        const updateClock = () => {
            const now = new Date();
            els.clockTime.textContent = now.toLocaleTimeString([], { hour12: false });
            els.clockDate.textContent = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        };
        updateClock();
        setInterval(updateClock, 1000); 

        const handleSearch = (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.app-card').forEach(card => {
                const title = card.querySelector('.app-title').textContent.toLowerCase();
                const desc = card.querySelector('.app-desc').textContent.toLowerCase();
                if (title.includes(query) || desc.includes(query)) card.classList.remove('hidden-app');
                else card.classList.add('hidden-app');
            });
        };
        els.search.addEventListener('input', handleSearch);

        // --- HUB APP VISIBILITY LOGIC ---
        let isEditingHub = false;
        const editHubBtn = document.getElementById('edit-hub-btn');

        const loadHubVisibility = () => {
            const hiddenApps = JSON.parse(localStorage.getItem('hub_hidden_apps') || '[]');
            document.querySelectorAll('.app-card').forEach(card => {
                if (hiddenApps.includes(card.id)) {
                    card.classList.add('hidden-app-pref');
                }
            });
        };
        loadHubVisibility();

        const updateAppHideIcon = (btn, card) => {
            if(btn) btn.innerHTML = card.classList.contains('hidden-app-pref') ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        };

        const saveHubVisibility = () => {
            const hidden = [];
            document.querySelectorAll('.app-card.hidden-app-pref').forEach(card => {
                if (card.id) hidden.push(card.id);
            });
            localStorage.setItem('hub_hidden_apps', JSON.stringify(hidden));
        };

        const handleCardClick = (e) => {
            e.preventDefault();
            const card = e.currentTarget;
            card.classList.toggle('hidden-app-pref');
            updateAppHideIcon(card.querySelector('.app-hide-btn'), card);
            saveHubVisibility();
        };

        editHubBtn.addEventListener('click', () => {
            isEditingHub = !isEditingHub;
            document.body.classList.toggle('layout-editing', isEditingHub);
            
            if (isEditingHub) {
                editHubBtn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                editHubBtn.classList.add('bg-green-100', 'dark:bg-green-900/30');
                
                document.querySelectorAll('.app-card').forEach(card => {
                    card.addEventListener('click', handleCardClick);
                    let hideBtn = card.querySelector('.app-hide-btn');
                    if (!hideBtn) {
                        hideBtn = document.createElement('div');
                        hideBtn.className = 'app-hide-btn';
                        card.appendChild(hideBtn);
                    }
                    updateAppHideIcon(hideBtn, card);
                });
            } else {
                editHubBtn.innerHTML = '<i class="fas fa-pen"></i>';
                editHubBtn.classList.remove('bg-green-100', 'dark:bg-green-900/30');
                
                document.querySelectorAll('.app-card').forEach(card => {
                    card.removeEventListener('click', handleCardClick);
                });
            }
        });
        // --- END VISIBILITY LOGIC ---


        const showMessage = (msg, type = 'success') => {
            els.msgBox.textContent = msg;
            els.msgBox.className = `fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-2xl text-white font-semibold transition-all duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-600'} translate-y-0 opacity-100`;
            setTimeout(() => {
                els.msgBox.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                els.auth.style.display = 'none';
                els.main.style.display = 'block';
                nav.updateUser(user.email);
                
                onSnapshot(doc(db, 'users', user.uid, 'settings', 'profile'), (snap) => {
                    const name = snap.data()?.displayName;
                    els.userName.textContent = name || user.email.split('@')[0];
                });

                const lastSeen = localStorage.getItem('lastSeenVersion');
                if(lastSeen !== changelogData[0].version) els.badge.style.display = 'block';

            } else {
                els.auth.style.display = 'flex';
                els.main.style.display = 'none';
                nav.updateUser('Guest');
            }
        });

        const safeClick = (id, fn) => {
            const btn = el(id);
            if(btn) btn.addEventListener('click', fn);
        }

        safeClick('sign-in-btn', () => signInWithEmailAndPassword(auth, el('email').value, el('password').value).catch(e => showMessage(e.message, 'error')));
        safeClick('sign-up-btn', () => createUserWithEmailAndPassword(auth, el('email').value, el('password').value).catch(e => showMessage(e.message, 'error')));
        safeClick('google-sign-in-btn', () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showMessage(e.message, 'error')));
        safeClick('anonymous-sign-in-btn', () => signInAnonymously(auth).catch(e => showMessage(e.message, 'error')));

        window.addEventListener('app-logout-request', () => {
            auth.signOut().then(() => showMessage("Logged out successfully"));
        });
    </script>
</body>
</html>