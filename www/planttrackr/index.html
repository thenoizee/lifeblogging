<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlantTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'128'%20height%3D'128'%20viewBox%3D'0%200%20128%20128'%3E%3Cdefs%3E%3ClinearGradient%20id%3D'g'%20x1%3D'85.35533905932738%25'%20y1%3D'85.35533905932738%25'%20x2%3D'14.644660940672615%25'%20y2%3D'14.64466094067263%25'%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'0%25'%20style%3D'stop-color%3A%234f46e5%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'100%25'%20style%3D'stop-color%3A%239333ea%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect%20width%3D'128'%20height%3D'128'%20rx%3D'25.6'%20fill%3D'url(%23g)'%20%2F%3E%3Cg%20transform%3D'translate(0%2C%200)%20rotate(0%2C%2064%2C%2064)'%3E%3Csvg%20x%3D'32'%20y%3D'32'%20width%3D'64'%20height%3D'64'%20viewBox%3D'0%200%20512%20512'%3E%3Cpath%20fill%3D'%2322c55e'%20fill-opacity%3D'1'%20d%3D'M272%2096c-78.6%200-145.1%2051.5-167.7%20122.5c33.6-17%2071.5-26.5%20111.7-26.5h88c8.8%200%2016%207.2%2016%2016s-7.2%2016-16%2016H288%20216s0%200%200%200c-16.6%200-32.7%201.9-48.3%205.4c-25.9%205.9-49.9%2016.4-71.4%2030.7c0%200%200%200%200%200C38.3%20298.8%200%20364.9%200%20440v16c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24V440c0-48.7%2020.7-92.5%2053.8-123.2C121.6%20392.3%20190.3%20448%20272%20448l1%200c132.1-.7%20239-130.9%20239-291.4c0-42.6-7.5-83.1-21.1-119.6c-2.6-6.9-12.7-6.6-16.2-.1C455.9%2072.1%20418.7%2096%20376%2096L272%2096z'%20%2F%3E%3C%2Fsvg%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="manifest" href="/manifest.json" />
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        green: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg: #f0fdf4;       
            --card: #ffffff;
            --text: #14532d;     
            --border: #bbf7d0;   
            --input-bg: #dcfce7; 
            --primary: #16a34a;  
        }

        .dark {
            --bg: #064e3b;       
            --card: #022c22;     
            --text: #ecfdf5;     
            --border: #14532d;
            --input-bg: #14532d; 
            --primary: #22c55e;  
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        @media (max-width: 768px) {
            body { padding-bottom: 80px; }
        }
        
        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .input-std {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            outline: none;
            transition: ring 0.2s;
        }
        .input-std:focus {
            ring: 2px solid var(--primary);
            border-color: var(--primary);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background-color: var(--input-bg);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .btn-secondary:hover { filter: brightness(0.95); }

        .plant-icon-circle {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem;
            background-color: var(--input-bg);
            color: var(--primary);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
            position: relative;
        }

        .message-box {
            position: fixed; top: 6rem; left: 50%; transform: translateX(-50%);
            padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            color: white; z-index: 100; font-weight: 600;
            display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .message-box.show { display: block; animation: fadeIn 0.3s; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 0.75rem; color: var(--text); opacity: 0.7; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 0.75rem; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <div id="loading-state" class="fixed inset-0 flex flex-col items-center justify-center bg-[var(--bg)] z-50">
        <i class="fa-solid fa-leaf fa-spin text-5xl text-[var(--primary)] mb-4"></i>
        <p class="text-lg font-semibold opacity-70">Entering the greenhouse...</p>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8 hidden" id="main-app-container">
        
        <div id="tab-content-dashboard" class="tab-content animate-fade">
            <h1 class="text-3xl font-bold mb-6">Dashboard</h1>

            <section id="dashboard-hospital-section" class="card p-6 mb-8 border-2 border-red-100 dark:border-red-900 hidden">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-600 dark:text-red-400">
                    <i class="fa-solid fa-staff-snake"></i> The Infirmary
                </h2>
                <div id="dashboard-hospital-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            </section>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <section class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-droplet text-blue-500"></i> Thirsty Plants
                    </h2>
                    <div id="dashboard-water-list" class="space-y-3">
                        <p class="text-sm opacity-60">Calculating water levels...</p>
                    </div>
                </section>

                <section class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-seedling text-orange-500"></i> Hungry Plants
                    </h2>
                    <div id="dashboard-fert-list" class="space-y-3">
                        <p class="text-sm opacity-60">Checking soil nutrients...</p>
                    </div>
                </section>
            </div>

            <section class="card p-6 mb-8">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-calendar-week text-purple-500"></i> Upcoming Tasks (Next 7 Days)
                </h2>
                <div id="dashboard-upcoming-list" class="space-y-1">
                    <p class="text-sm opacity-60">Forecasting schedule...</p>
                </div>
            </section>

            <section class="card p-6 mb-8 bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-[var(--primary)]">
                    <i class="fa-solid fa-pen-to-square"></i> Quick Log Care
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Select Plant</label>
                        <select id="log-plant-select" class="input-std"></select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">Action</label>
                            <select id="log-type-select" class="input-std">
                                <option value="Water">Watering</option>
                                <option value="Mist">Misting üí¶</option>
                                <option value="Fertilize">Fertilizing</option>
                                <option value="Prune">Pruning ‚úÇÔ∏è</option>
                                <option value="Repot">Repotting ü™¥</option>
                                <option value="Pest Control">Pest Control üêõ</option>
                                <option value="Overwinter">Overwinter Prep ‚ùÑÔ∏è</option>
                                <option value="Note">Note / Observation</option>
                                <option value="Progress">Progress Update üì∏</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Date</label>
                            <input type="datetime-local" id="log-date" class="input-std">
                        </div>
                    </div>

                    <div id="log-progress-extras" class="hidden space-y-4 mt-4 p-4 border rounded-lg bg-gray-50 dark:bg-gray-800/50">
                        <h3 class="font-bold text-sm text-[var(--primary)]"><i class="fa-solid fa-chart-line mr-2"></i>Progress Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">Size / Height (cm) <span class="text-xs font-normal opacity-60">(Optional)</span></label>
                                <input type="number" id="log-growth-val" class="input-std" placeholder="e.g. 15.5">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Current Health</label>
                                <select id="log-health-select" class="input-std">
                                    <option value="excellent">Excellent üåü</option>
                                    <option value="good" selected>Good üåø</option>
                                    <option value="bad">Bad üìâ</option>
                                    <option value="sick-pests">Sick - Pests üêõ</option>
                                    <option value="sick-wilty">Sick - Wilty ü•Ä</option>
                                    <option value="sick-other">Sick - Other ü§í</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold mb-2">Worth Noticing <span class="text-xs font-normal opacity-60">(Optional)</span></label>
                            <div class="flex flex-wrap gap-2" id="log-noticing-tags">
                                <label class="cursor-pointer"><input type="checkbox" value="New Leaves" class="peer sr-only"><span class="px-2 py-1 text-xs border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">New Leaves üçÉ</span></label>
                                <label class="cursor-pointer"><input type="checkbox" value="New Shoots" class="peer sr-only"><span class="px-2 py-1 text-xs border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">New Shoots üå±</span></label>
                                <label class="cursor-pointer"><input type="checkbox" value="New Flowers" class="peer sr-only"><span class="px-2 py-1 text-xs border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">New Flowers üå∏</span></label>
                                <label class="cursor-pointer"><input type="checkbox" value="Done Flowering" class="peer sr-only"><span class="px-2 py-1 text-xs border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">Done Flowering ü•Ä</span></label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-1">Progress Photo <span class="text-xs font-normal opacity-60">(Optional)</span></label>
                            <div class="flex gap-2 mb-1">
                                <button type="button" class="btn-secondary flex-1 py-2 text-sm" onclick="document.getElementById('log-photo').removeAttribute('capture'); document.getElementById('log-photo').click();"><i class="fa-solid fa-image mr-1"></i> Gallery</button>
                                <button type="button" class="btn-secondary flex-1 py-2 text-sm" onclick="document.getElementById('log-photo').setAttribute('capture', 'environment'); document.getElementById('log-photo').click();"><i class="fa-solid fa-camera mr-1"></i> Camera</button>
                            </div>
                            <input type="file" id="log-photo" accept="image/*" class="hidden" onchange="document.getElementById('log-photo-name').innerHTML = this.files[0] ? '<i class=\'fa-solid fa-check text-green-500 mr-1\'></i> ' + this.files[0].name : ''">
                            <p id="log-photo-name" class="text-xs font-bold text-[var(--primary)] truncate"></p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Notes <span class="text-xs font-normal opacity-60">(Optional)</span></label>
                        <textarea id="log-notes" rows="3" class="input-std" placeholder="Any observations?"></textarea>
                    </div>

                    <button id="submit-log-btn" class="btn-primary w-full mt-4">
                        <i class="fa-solid fa-check mr-2"></i> Save Log
                    </button>
                </div>
            </section>

            <section>
                <h2 class="text-xl font-bold mb-4">Recent Activity</h2>
                <div id="dashboard-recent-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>
        </div>

        <div id="tab-content-plants" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold">My Garden</h1>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="plant-filter-location" class="input-std !w-auto">
                        <option value="all">All Locations</option>
                    </select>
                    <button onclick="window.dispatchEvent(new CustomEvent('tab-changed', {detail: {tabId: 'locations'}}))" class="btn-secondary whitespace-nowrap hidden md:block" title="Manage Locations">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </button>
                    <button id="open-add-plant-modal" class="btn-primary whitespace-nowrap">
                        <i class="fa-solid fa-plus mr-2"></i> Add Plant
                    </button>
                </div>
            </div>
            <div id="plants-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
        <div id="tab-content-locations" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">
                    <i class="fa-solid fa-map-location-dot mr-2"></i>Locations
                </h1>
                <button onclick="openLocationModal()" class="btn-primary bg-blue-600 hover:bg-blue-700 whitespace-nowrap">
                    <i class="fa-solid fa-plus mr-2"></i> Add Location
                </button>
            </div>
            <div id="locations-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-content-layout" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h1 class="text-3xl font-bold">Layout</h1>
                
                <div class="bg-gray-200 dark:bg-gray-800 p-1 rounded-lg flex gap-1">
                    <button id="mode-move" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all" onclick="setMode('move')">
                        <i class="fa-solid fa-hand-pointer mr-2"></i> Move
                    </button>
                    <button id="mode-draw" class="px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all" onclick="setMode('draw')">
                        <i class="fa-solid fa-pencil mr-2"></i> Draw
                    </button>
                </div>
                
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="layout-location-select" class="input-std !w-auto">
                        <option value="">-- Select Room --</option>
                    </select>
                </div>
            </div>

            <div id="layout-toolbar" class="card p-2 mb-4 flex gap-2 overflow-x-auto transition-opacity duration-200">
            </div>
            
            <div class="card relative bg-[#f0fdf4] dark:bg-[#022c22] border-2 border-dashed border-[var(--border)] overflow-hidden select-none" 
                 style="height: 60vh; touch-action: none;" 
                 id="layout-container">
                
                <div id="layout-placeholder" class="absolute inset-0 flex items-center justify-center opacity-50 pointer-events-none">
                    <p><i class="fa-solid fa-map mr-2"></i>Select a location to start</p>
                </div>
            </div>
            <p class="text-xs text-center mt-4 opacity-60" id="layout-instructions">
                <i class="fa-solid fa-hand-pointer mr-1"></i> Drag items to move. Double-tap to delete.
            </p>
        </div>

        <div id="tab-content-history" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold">Journal</h1>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <select id="history-filter-location" class="input-std !w-auto">
                        <option value="all">All Locations</option>
                    </select>
                    <select id="history-filter-plant" class="input-std !w-auto">
                        <option value="all">All Plants</option>
                    </select>
                    <input type="text" id="history-search" class="input-std !w-auto md:w-48" placeholder="Search...">
                </div>
            </div>
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table id="history-table">
                        <thead><tr><th>Date</th><th>Plant</th><th>Action</th><th>Details</th><th></th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="tab-content-wishlist" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold text-purple-600 dark:text-purple-400">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Dream Garden
                </h1>
                <button onclick="openWishlistModal()" class="btn-primary bg-purple-600 hover:bg-purple-700 whitespace-nowrap">
                    <i class="fa-solid fa-plus mr-2"></i> Add Wish
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="card p-4 border-l-4 border-red-500">
                    <h3 class="text-xs font-bold opacity-60 uppercase">High Priority</h3>
                    <p class="text-2xl font-bold" id="wish-count-high">0</p>
                </div>
                <div class="card p-4 border-l-4 border-yellow-500">
                    <h3 class="text-xs font-bold opacity-60 uppercase">Medium Priority</h3>
                    <p class="text-2xl font-bold" id="wish-count-med">0</p>
                </div>
                <div class="card p-4 border-l-4 border-green-500">
                    <h3 class="text-xs font-bold opacity-60 uppercase">Low Priority</h3>
                    <p class="text-2xl font-bold" id="wish-count-low">0</p>
                </div>
            </div>

            <div id="wishlist-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>
        </div>

        <div id="tab-content-graveyard" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold text-gray-500 dark:text-gray-400">
                    <i class="fa-solid fa-skull mr-2"></i>Plant Graveyard
                </h1>
            </div>
            <p class="mb-6 opacity-70">May they rest in compost. Plants marked as dead or archived appear here.</p>
            <div id="graveyard-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-content-settings" class="tab-content hidden animate-fade">
            <h1 class="text-3xl font-bold mb-6">Settings</h1>
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Seasons</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-bold">Winter Mode</p>
                        <p class="text-xs opacity-70">Reduces watering frequency by 50%</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="winter-mode-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Data Management</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="export-json-btn" class="btn-secondary"><i class="fa-solid fa-download mr-2"></i> Export JSON</button>
                    <button id="export-csv-btn" class="btn-secondary"><i class="fa-solid fa-file-csv mr-2"></i> Export CSV</button>
                </div>
            </div>
        </div>

    </main>

    <div id="location-modal" class="modal-overlay hidden !z-[60]" style="display: none;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="toggleDisplay(document.getElementById('location-modal'), false)">&times;</button>
            <h2 id="modal-location-title" class="text-2xl font-bold mb-6">Add Location</h2>
            <input type="hidden" id="modal-location-id">
            
            <div class="space-y-4">
                <div><label class="text-sm font-bold">Name</label><input type="text" id="loc-name" class="input-std" placeholder="e.g. Kitchen, Living Room"></div>
                
                <div>
                    <label class="text-sm font-bold">Positions / Zones (Comma-separated)</label>
                    <input type="text" id="loc-positions" class="input-std" placeholder="e.g. Window Sill, Island, Fridge Top">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Type</label>
                        <select id="loc-type" class="input-std">
                            <option value="inside">Inside</option>
                            <option value="outside">Outside</option>
                            <option value="germinator">Germinator</option>
                            <option value="patio">Patio</option>
                            <option value="greenhouse">Greenhouse</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Light Source</label>
                        <select id="loc-light" class="input-std">
                            <option value="natural">Natural Light</option>
                            <option value="growlight">Grow Light</option>
                            <option value="both">Both</option>
                            <option value="low">Low Light</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Avg Temp Summer (¬∞C)</label><input type="number" id="loc-temp-summer" class="input-std" placeholder="e.g. 25"></div>
                    <div><label class="text-sm font-bold">Avg Temp Winter (¬∞C)</label><input type="number" id="loc-temp-winter" class="input-std" placeholder="e.g. 18"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Humidity</label>
                        <select id="loc-humidity" class="input-std">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Draft</label>
                        <select id="loc-draft" class="input-std">
                            <option value="none">None</option>
                            <option value="slight">Slight</option>
                            <option value="drafty">Drafty</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="saveLocation()" class="btn-primary flex-1">Save Location</button>
                    <button id="delete-location-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden" onclick="deleteLocation(document.getElementById('modal-location-id').value)">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="plant-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Plant</h2>
            <input type="hidden" id="modal-plant-id">
            
            <div class="space-y-4">
                <div><label class="text-sm font-bold">Name</label><input type="text" id="plant-name" class="input-std" placeholder="e.g. Monstera"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Species</label><input type="text" id="plant-species" class="input-std"></div>
                    <div>
                        <label class="text-sm font-bold">Location / Area</label>
                        <div class="flex gap-2">
                            <select id="plant-location" class="input-std flex-grow">
                                <option value="">-- Select --</option>
                            </select>
                            <button type="button" onclick="openLocationModal()" class="btn-secondary px-3" title="Create New Location">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Light Condition</label>
                        <select id="plant-light" class="input-std">
                            <option value="">-- Select --</option>
                            <option value="low">‚òÅÔ∏è Low / Shadow</option>
                            <option value="medium">‚õÖ Medium / Indirect</option>
                            <option value="high">‚òÄÔ∏è Bright / Direct</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Position Details</label>
                        <select id="plant-position" class="input-std">
                            <option value="">-- Select Location First --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div><label class="text-sm font-bold">Water Every</label><input type="number" id="plant-water-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Feed Every</label><input type="number" id="plant-fert-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Progress Every</label><input type="number" id="plant-prog-freq" class="input-std" placeholder="Days"></div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div><label class="text-sm font-bold">Mist Every</label><input type="number" id="plant-mist-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Prune Every</label><input type="number" id="plant-prune-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Repot Every</label><input type="number" id="plant-repot-freq" class="input-std" placeholder="Days"></div>
                </div>

                <div class="flex gap-4 mb-4">
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-bold">
                        <input type="checkbox" id="plant-weather" class="w-4 h-4 text-[var(--primary)] bg-[var(--input-bg)] border-[var(--border)] rounded focus:ring-[var(--primary)]">
                        Weather Alerts
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-bold">
                        <input type="checkbox" id="plant-overwinter" class="w-4 h-4 text-[var(--primary)] bg-[var(--input-bg)] border-[var(--border)] rounded focus:ring-[var(--primary)]">
                        Needs Overwintering
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-bold">Health Status</label>
                        <select id="plant-health" class="input-std">
                            <option value="excellent">Excellent üåü</option>
                            <option value="good" selected>Good üåø</option>
                            <option value="bad">Bad üìâ</option>
                            <option value="sick-pests">Sick - Pests üêõ</option>
                            <option value="sick-wilty">Sick - Wilty ü•Ä</option>
                            <option value="sick-other">Sick - Other ü§í</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Status</label>
                        <select id="plant-status" class="input-std">
                            <option value="alive" selected>Alive & Kicking</option>
                            <option value="dead">Dead / Archived ü™¶</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-sm font-bold">Background / History</label>
                    <textarea id="plant-background" class="input-std" rows="2" placeholder="Where is it from? Was it a gift? Any history?"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Acquired On</label><input type="date" id="plant-acquired" class="input-std"></div>
                    <div>
                        <label class="text-sm font-bold">Icon</label>
                        <select id="plant-icon" class="input-std">
                            <option value="fa-leaf">Leaf</option>
                            <option value="fa-seedling">Seedling</option>
                            <option value="fa-tree">Tree</option>
                            <option value="fa-cannabis">Broad</option>
                            <option value="fa-clover">Clover</option>
                            <option value="fa-spa">Lotus</option>
                            <option value="fa-apple-whole">Fruit</option>
                            <option value="fa-pepper-hot">Veg</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Custom Photo (Optional)</label>
                        <div id="current-plant-photo-container" class="hidden mb-2 items-center gap-3">
                            <img id="current-plant-photo-img" class="w-12 h-12 rounded-full object-cover border border-[var(--border)]">
                            <button type="button" class="btn-secondary text-xs text-red-500 py-1 px-2" id="remove-plant-photo-btn">
                                <i class="fa-solid fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="flex gap-2 mb-1 mt-1">
                            <button type="button" class="btn-secondary flex-1 py-2 text-xs" onclick="document.getElementById('plant-photo').removeAttribute('capture'); document.getElementById('plant-photo').click();"><i class="fa-solid fa-image mr-1"></i> Gallery</button>
                            <button type="button" class="btn-secondary flex-1 py-2 text-xs" onclick="document.getElementById('plant-photo').setAttribute('capture', 'environment'); document.getElementById('plant-photo').click();"><i class="fa-solid fa-camera mr-1"></i> Camera</button>
                        </div>
                        <input type="file" id="plant-photo" accept="image/*" class="hidden" onchange="document.getElementById('plant-photo-name').innerHTML = this.files[0] ? '<i class=\'fa-solid fa-check text-green-500 mr-1\'></i> ' + this.files[0].name : ''">
                        <p id="plant-photo-name" class="text-xs font-bold text-gray-600 dark:text-gray-400 truncate mb-1"></p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button id="save-plant-btn" class="btn-primary flex-1">Save Plant</button>
                    <button id="delete-plant-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="wishlist-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade border-purple-500 border-2">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500" onclick="toggleDisplay(document.getElementById('wishlist-modal'), false)">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-purple-600">Add to Wishlist</h2>
            <input type="hidden" id="wish-id">
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold">Plant Name</label>
                    <input type="text" id="wish-name" class="input-std" placeholder="e.g. Variegated Monstera">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Species</label>
                        <input type="text" id="wish-species" class="input-std">
                    </div>
                    <div>
                        <label class="text-sm font-bold">Est. Price</label>
                        <input type="number" id="wish-price" class="input-std" placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold">Priority</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="wish-priority" value="high" class="peer sr-only">
                            <div class="p-2 rounded border text-center peer-checked:bg-red-500 peer-checked:text-white transition">High üî•</div>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="wish-priority" value="medium" class="peer sr-only" checked>
                            <div class="p-2 rounded border text-center peer-checked:bg-yellow-500 peer-checked:text-white transition">Med üòê</div>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="wish-priority" value="low" class="peer sr-only">
                            <div class="p-2 rounded border text-center peer-checked:bg-green-500 peer-checked:text-white transition">Low üßä</div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold">Notes / Link</label>
                    <textarea id="wish-notes" rows="2" class="input-std" placeholder="Where to buy?"></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="saveWish()" class="btn-primary bg-purple-600 hover:bg-purple-700 flex-1">Save Wish</button>
                    <button id="delete-wish-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="snooze-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade max-w-sm">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="document.getElementById('snooze-modal').style.display='none'">&times;</button>
            <h2 class="text-xl font-bold mb-2">Snooze Plant</h2>
            <p class="text-sm opacity-70 mb-6">How long should we wait before reminding you again?</p>
            <input type="hidden" id="snooze-plant-target">
            
            <div class="space-y-3">
                <button class="w-full btn-secondary text-left p-3 flex justify-between" onclick="applySnooze(1)">
                    <span>Tomorrow (1 Day)</span> <i class="fa-solid fa-sun opacity-50"></i>
                </button>
                <button class="w-full btn-secondary text-left p-3 flex justify-between" onclick="applySnooze(2)">
                    <span>Short Break (2 Days)</span> <i class="fa-solid fa-coffee opacity-50"></i>
                </button>
                <button class="w-full btn-secondary text-left p-3 flex justify-between" onclick="applySnooze(7)">
                    <span>Next Week (7 Days)</span> <i class="fa-solid fa-calendar-week opacity-50"></i>
                </button>
                <div class="flex gap-2">
                    <input type="number" id="snooze-custom-val" class="input-std" placeholder="Custom days">
                    <button class="btn-primary whitespace-nowrap" onclick="applySnooze(document.getElementById('snooze-custom-val').value)">Set</button>
                </div>
            </div>
        </div>
    </div>

    <div id="photo-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closePhotoModal()">
        <button class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 focus:outline-none">&times;</button>
        <img id="photo-modal-img" src="" class="max-h-[90vh] max-w-[95vw] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
    </div>

    <div id="message-box" class="message-box"></div>
    <script type="module">
        import { changelogData } from '../changelog-data.js'; 
        import { AppNavigation } from '../shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp, doc, deleteDoc, updateDoc, query, orderBy, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        if (localStorage.getItem('theme') === 'dark' || 
           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        const state = {
            user: null, plants: [], logs: [], structures: [], wishlist: [], locations: [],
            unsubPlants: null, unsubLogs: null, unsubStructs: null, unsubWish: null, unsubLocs: null,
            nav: null, themeUnsubscribe: null 
        };

        const getLatestPlantPhoto = (plant) => {
            if (!plant) return null;
            const plantLogs = state.logs.filter(l => l.plantId === plant.id && l.photoUrl);
            let latestLogPhotoUrl = null;
            let latestLogTime = 0;
            if (plantLogs.length > 0) {
                latestLogPhotoUrl = plantLogs[0].photoUrl; // Logs are already sorted desc
                latestLogTime = new Date(plantLogs[0].date).getTime();
            }
            const plantUpdateTime = plant.updatedAt ? plant.updatedAt.toDate().getTime() : 0;
            if (latestLogPhotoUrl && latestLogTime > plantUpdateTime) return latestLogPhotoUrl;
            return plant.photoUrl || latestLogPhotoUrl || null;
        };
        
        const getEl = (id) => document.getElementById(id);

        // Use this flag to track if user hit "Remove" on plant edit
        let plantPhotoRemoved = false;
        getEl("remove-plant-photo-btn").onclick = () => {
            plantPhotoRemoved = true;
            getEl("current-plant-photo-container").classList.add("hidden");
            getEl("plant-photo-name").innerHTML = "<i class='fa-solid fa-trash text-red-500 mr-1'></i> Photo will be removed on save";
        };
        
        let msgTimeout;
        const showMsg = (msg, type = "success", duration = 3000) => {
            const box = getEl("message-box");
            box.textContent = msg;
            box.className = `message-box show ${type === 'error' ? 'bg-red-500' : 'bg-[var(--primary)]'}`;
            clearTimeout(msgTimeout);
            if (duration > 0) {
                msgTimeout = setTimeout(() => box.classList.remove("show"), duration);
            }
        };

        const toggleDisplay = (el, show) => {
            if (show) { el.classList.remove('hidden'); el.style.display = ''; } 
            else { el.classList.add('hidden'); el.style.display = 'none'; }
        };

        const compressImage = (file, maxWidth = 1200) => {
            return new Promise((resolve) => {
                if (!file || !file.type.match(/image.*/)) return resolve(file);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const ratio = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
                        if (ratio >= 1) return resolve(file);
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })), 'image/jpeg', 0.8);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        const lightIcons = { low: 'fa-cloud', medium: 'fa-cloud-sun', high: 'fa-sun' };
        const lightColors = { low: 'text-gray-400', medium: 'text-yellow-400', high: 'text-orange-500' };

        const updateLocationDropdowns = () => {
            const locs = state.locations;
            const legacyLocs = [...new Set(state.plants.map(p => p.location).filter(Boolean))]
                .filter(val => !locs.find(l => l.id === val));

            const populate = (selectEl, defaultOpt, currentVal) => {
                if(!selectEl) return;
                selectEl.innerHTML = defaultOpt;
                locs.forEach(l => { selectEl.innerHTML += `<option value="${l.id}">${l.name}</option>`; });
                legacyLocs.forEach(val => { selectEl.innerHTML += `<option value="${val}">${val} (Legacy)</option>`; });
                if (currentVal && (locs.find(l=>l.id===currentVal) || legacyLocs.includes(currentVal))) {
                    selectEl.value = currentVal;
                }
            };

            populate(getEl("plant-filter-location"), '<option value="all">All Locations</option>', getEl("plant-filter-location").value);
            populate(getEl("layout-location-select"), '<option value="">-- Select Room --</option>', getEl("layout-location-select").value);
            populate(getEl("plant-location"), '<option value="">-- Select --</option>', getEl("plant-location").value);
            populate(getEl("history-filter-location"), '<option value="all">All Locations</option>', getEl("history-filter-location").value);
        };
        const renderLocations = () => {
            const list = getEl("locations-list-container");
            if (!list) return;
            list.innerHTML = "";

            if(state.locations.length === 0) {
                list.innerHTML = `<p class="col-span-3 text-center opacity-50 py-8">No locations defined. Create one to organize your plants!</p>`;
                return;
            }

            state.locations.forEach(loc => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between hover:shadow-lg transition relative";
                
                const typeIcons = {
                    inside: 'fa-house', outside: 'fa-sun', germinator: 'fa-seedling', patio: 'fa-chair', greenhouse: 'fa-tent'
                };
                const icon = typeIcons[loc.type] || 'fa-map-pin';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="plant-icon-circle bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">${loc.name}</h3>
                                <p class="text-xs opacity-70 uppercase tracking-wider">${loc.type}</p>
                            </div>
                        </div>
                        <button onclick="openLocationModal('${loc.id}')" class="text-gray-400 hover:text-[var(--primary)]">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm opacity-80 mt-2">
                        <div title="Light"><i class="fa-solid fa-lightbulb w-4 text-yellow-500"></i> ${loc.light}</div>
                        <div title="Humidity"><i class="fa-solid fa-droplet w-4 text-blue-400"></i> ${loc.humidity}</div>
                        ${loc.tempSummer ? `<div title="Summer Temp"><i class="fa-solid fa-temperature-full w-4 text-red-400"></i> ${loc.tempSummer}¬∞C (S)</div>` : ''}
                        ${loc.tempWinter ? `<div title="Winter Temp"><i class="fa-solid fa-temperature-empty w-4 text-blue-300"></i> ${loc.tempWinter}¬∞C (W)</div>` : ''}
                        <div title="Draft" class="col-span-2"><i class="fa-solid fa-wind w-4 text-gray-400"></i> Draft: ${loc.draft}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        };

        const renderPlants = () => {
            const list = getEl("plants-list-container");
            const select = getEl("log-plant-select");
            const filterLoc = getEl("plant-filter-location");
            
            select.innerHTML = "<option value=''>-- Select Plant --</option>";
            
            const histPlantSelect = getEl("history-filter-plant");
            let histCurVal = "all";
            if (histPlantSelect) {
                histCurVal = histPlantSelect.value;
                histPlantSelect.innerHTML = '<option value="all">All Plants</option>';
            }

            state.plants.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id; opt.textContent = p.name;
                select.appendChild(opt);
                
                if (histPlantSelect) {
                    histPlantSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                }
            });
            if (histPlantSelect) histPlantSelect.value = histCurVal;

            // Change from: let displayPlants = state.plants;
            let displayPlants = state.plants.filter(p => p.status !== 'dead');
            if (filterLoc.value && filterLoc.value !== 'all') {
                displayPlants = displayPlants.filter(p => p.location === filterLoc.value);
            }

            list.innerHTML = displayPlants.length ? '' : `<p class="opacity-50 text-center col-span-3 py-8">No plants found.</p>`;

            displayPlants.forEach(plant => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between h-full hover:shadow-lg transition";
                
                const locObj = state.locations.find(l => l.id === plant.location);
                const displayLocation = locObj ? locObj.name : (plant.location || 'No location');
                
                // Inherit light from location if plant doesn't explicitly have it set
                const finalLight = plant.light || (locObj ? locObj.light : null);
                const inheritedBadge = (!plant.light && finalLight) ? '<span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1 rounded ml-1">Inherited</span>' : '';

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            ${getLatestPlantPhoto(plant) 
                            ? `<img src="${getLatestPlantPhoto(plant)}" onclick="openPhotoModal(this.src)" class="w-12 h-12 rounded-full object-cover border border-[var(--border)] cursor-zoom-in hover:opacity-80 transition">` 
                            : `<div class="plant-icon-circle"><i class="fa-solid ${plant.icon || 'fa-leaf'}"></i></div>`
                            }
                            <div>
                                <h3 class="font-bold text-lg leading-tight">${plant.name}</h3>
                                <p class="text-xs opacity-70">${plant.species || 'Unknown'}</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-[var(--primary)] edit-plant-btn" data-id="${plant.id}"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    
                    <div class="space-y-2 mb-4 flex-grow">
                        <div class="flex items-center gap-2 text-sm font-semibold">
                            <i class="fa-solid fa-location-dot w-4 text-gray-400"></i> ${displayLocation}
                        </div>
                        
                        <div class="flex items-center gap-2 text-xs opacity-70 ml-6">
                            ${finalLight ? `<i class="fa-solid fa-sun text-yellow-500"></i> <span class="capitalize">${finalLight}</span> ${inheritedBadge}` : '<span>No light info</span>'}
                        </div>

                        ${plant.waterFreq ? `<div class="flex items-center gap-2 text-sm text-blue-500 mt-2"><i class="fa-solid fa-droplet w-4"></i> Every ${plant.waterFreq} days</div>` : ''}
                        ${plant.snoozeUntil && plant.snoozeUntil.toDate() > new Date() ? `
                        <div class="inline-flex items-center gap-1 px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs font-bold mt-1">
                            <i class="fa-solid fa-clock"></i> Snoozed
                            <button class="ml-2 hover:text-red-600 unsnooze-btn" data-id="${plant.id}" title="Undo Snooze">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-auto">
                        <button class="btn-secondary text-sm quick-water-btn" data-id="${plant.id}"><i class="fa-solid fa-droplet text-blue-500"></i> Water</button>
                        <button class="btn-secondary text-sm" onclick="window.dispatchEvent(new CustomEvent('tab-changed', {detail: {tabId: 'log'}})); document.getElementById('log-plant-select').value='${plant.id}';"><i class="fa-solid fa-plus text-green-500"></i> Log</button>
                    </div>
                `;
                list.appendChild(card);
            });

            document.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
            document.querySelectorAll(".quick-water-btn").forEach(b => b.onclick = (e) => quickWater(e.currentTarget.dataset.id));
            document.querySelectorAll(".unsnooze-btn").forEach(b => b.onclick = (e) => unsnoozePlant(e.currentTarget.dataset.id));
        };
        


        const renderGraveyard = () => {
            const list = getEl("graveyard-container");
            if (!list) return;
            list.innerHTML = "";

            const deadPlants = state.plants.filter(p => p.status === 'dead');

            if(deadPlants.length === 0) {
                list.innerHTML = `<p class="col-span-3 text-center opacity-50 py-8">No casualties yet! Keep up the good work. ü™¥</p>`;
                return;
            }

            deadPlants.forEach(plant => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col grayscale opacity-80 hover:grayscale-0 hover:opacity-100 transition";
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <div class="plant-icon-circle bg-gray-200 text-gray-500"><i class="fa-solid fa-skull"></i></div>
                            <div>
                                <h3 class="font-bold text-lg line-through decoration-2">${plant.name}</h3>
                                <p class="text-xs opacity-70">${plant.species || 'Unknown'}</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-[var(--primary)] edit-plant-btn" data-id="${plant.id}"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    ${plant.background ? `<p class="text-sm italic mt-2 opacity-80 border-l-2 pl-2 border-gray-400">" ${plant.background} "</p>` : ''}
                    <p class="text-xs opacity-50 mt-4 text-right">RIP</p>
                `;
                list.appendChild(card);
            });

            // Make sure graveyard items can be edited/resurrected
            list.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
        };




        const renderDashboard = () => {
            const waterList = getEl("dashboard-water-list");
            const fertList = getEl("dashboard-fert-list");
            const hospitalSection = getEl("dashboard-hospital-section");
            const hospitalList = getEl("dashboard-hospital-list");
            const upcomingList = getEl("dashboard-upcoming-list");
            const recentList = getEl("dashboard-recent-list");

            waterList.innerHTML = "";
            fertList.innerHTML = "";
            hospitalList.innerHTML = "";
            upcomingList.innerHTML = "";
            recentList.innerHTML = "";

            const now = new Date();
            let thirstyCount = 0;
            let hungryCount = 0;
            const upcomingTasks = [];
            let hasSickPlants = false;

            state.plants.filter(p => p.status !== 'dead').forEach(plant => {
                const isSick = plant.health && (plant.health.startsWith('sick') || plant.health === 'bad');
                if (isSick) hasSickPlants = true;

                const plantLogs = state.logs.filter(l => l.plantId === plant.id);
                const lastWater = plantLogs.find(l => l.type === 'Water');
                const lastFert = plantLogs.find(l => l.type === 'Fertilize');

                if (plant.waterFreq) {
                    const isSnoozed = plant.snoozeUntil && plant.snoozeUntil.toDate() > now;
                    let freq = plant.waterFreq;
                    if (state.winterMode) freq = Math.ceil(freq * 1.5);

                    if (isSnoozed) {
                        const snoozeDate = plant.snoozeUntil.toDate();
                        const diffMs = snoozeDate - now;
                        const daysUntil = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= 7) {
                            upcomingTasks.push({
                                plant: plant, type: 'Snooze Ends (Water)', daysUntil: daysUntil,
                                date: snoozeDate, icon: 'fa-clock', color: 'text-yellow-600', bg: 'bg-yellow-100 dark:bg-yellow-900'
                            });
                        }
                    } else {
                        const lastDate = lastWater ? new Date(lastWater.date) : new Date(plant.acquired || 0);
                        const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                        const daysOverdue = Math.floor(diffDays - freq);

                        if (daysOverdue >= 0) {
                            if (!isSick) {
                                thirstyCount++;
                                const div = document.createElement("div");
                                div.className = "flex justify-between items-center bg-[var(--input-bg)] p-3 rounded-lg border border-[var(--border)]";
                                
                                const latestPhoto = getLatestPlantPhoto(plant);
                                const imgHtml = latestPhoto 
                                    ? `<img src="${latestPhoto}" onclick="openPhotoModal(this.src)" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200 cursor-zoom-in hover:opacity-80 transition">`
                                    : `<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3 text-blue-500"><i class="fa-solid ${plant.icon || 'fa-leaf'}"></i></div>`;

                                div.innerHTML = `
                                    <div class="flex items-center">
                                        ${imgHtml}
                                        <div>
                                            <p class="font-bold text-sm">${plant.name}</p>
                                            <p class="text-xs text-red-500 font-bold">${daysOverdue === 0 ? 'Due Today' : `${daysOverdue} days late`}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button class="btn-secondary p-1.5 rounded text-xs" onclick="openSnoozeModal('${plant.id}')" title="Snooze"><i class="fa-solid fa-clock text-yellow-500"></i></button>
                                        <button class="btn-primary p-1.5 rounded text-xs quick-water-btn" data-id="${plant.id}"><i class="fa-solid fa-check"></i></button>
                                    </div>
                                `;
                                waterList.appendChild(div);
                            }
                        } else if (daysOverdue >= -7) {
                            const daysUntil = Math.abs(daysOverdue);
                            const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                            upcomingTasks.push({ plant, type: 'Water', daysUntil, date: dueDate, icon: 'fa-droplet', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900' });
                        }
                    }
                }

                if (plant.fertFreq) {
                    const lastDate = lastFert ? new Date(lastFert.date) : new Date(plant.acquired || 0);
                    const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                    const daysOverdue = Math.floor(diffDays - plant.fertFreq);

                    if (daysOverdue >= 0) {
                        if (!isSick) {
                            hungryCount++;
                            const div = document.createElement("div");
                            div.className = "flex justify-between items-center bg-[var(--input-bg)] p-3 rounded-lg border border-[var(--border)]";
                            
                            const latestPhoto = getLatestPlantPhoto(plant);
                            const imgHtml = latestPhoto 
                                ? `<img src="${latestPhoto}" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200">`
                                : `<div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center mr-3 text-orange-500"><i class="fa-solid ${plant.icon || 'fa-seedling'}"></i></div>`;

                            div.innerHTML = `
                                <div class="flex items-center">
                                    ${imgHtml}
                                    <div>
                                        <p class="font-bold text-sm">${plant.name}</p>
                                        <p class="text-xs text-orange-500 font-bold">${daysOverdue} days overdue</p>
                                    </div>
                                </div>
                            `;
                            fertList.appendChild(div);
                        }
                    } else if (daysOverdue >= -7) {
                        const daysUntil = Math.abs(daysOverdue);
                        const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                        upcomingTasks.push({ plant, type: 'Fertilize', daysUntil, date: dueDate, icon: 'fa-seedling', color: 'text-orange-500', bg: 'bg-orange-100 dark:bg-orange-900' });
                    }
                }

                if (plant.progFreq) {
                    const lastProg = plantLogs.find(l => l.type === 'Progress' || l.type === 'Growth');
                    const lastDate = lastProg ? new Date(lastProg.date) : new Date(plant.acquired || 0);
                    const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                    const daysOverdue = Math.floor(diffDays - plant.progFreq);

                    if (daysOverdue >= -7) {
                        let daysUntil = -daysOverdue;
                        if (daysUntil < 0) daysUntil = 0; 
                        const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                        upcomingTasks.push({ plant, type: 'Update Progress üì∏', daysUntil, date: dueDate, icon: 'fa-camera', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900' });
                    }
                }

                // --- Generic Task Check for Mist, Prune, Repot ---
                const checkFreq = (freq, type, icon, color, bg) => {
                    if (!freq) return;
                    const lastLog = plantLogs.find(l => l.type === type);
                    const lastDate = lastLog ? new Date(lastLog.date) : new Date(plant.acquired || 0);
                    const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                    const daysOverdue = Math.floor(diffDays - freq);

                    if (daysOverdue >= -7) { // Due within next 7 days, or overdue
                        let daysUntil = daysOverdue > 0 ? 0 : Math.abs(daysOverdue); 
                        const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                        upcomingTasks.push({ plant, type, daysUntil, date: dueDate, icon, color, bg });
                    }
                };

                checkFreq(plant.mistFreq, 'Mist', 'fa-spray-can', 'text-cyan-500', 'bg-cyan-100 dark:bg-cyan-900');
                checkFreq(plant.pruneFreq, 'Prune', 'fa-scissors', 'text-green-700', 'bg-green-100 dark:bg-green-900');
                checkFreq(plant.repotFreq, 'Repot', 'fa-bucket', 'text-amber-700', 'bg-amber-100 dark:bg-amber-900');

                // --- Static Season Check for Overwintering (Assumes Northern Hemisphere Oct/Nov prep) ---
                if (plant.overwinter && (now.getMonth() === 9 || now.getMonth() === 10)) {
                    upcomingTasks.push({ plant, type: 'Needs Overwinter Prep ‚ùÑÔ∏è', daysUntil: 0, date: now, icon: 'fa-snowflake', color: 'text-blue-500', bg: 'bg-blue-50 dark:bg-blue-900' });
                }

                // --- Weather Alert Placeholder ---
                if (plant.weatherAlerts && plant.location && state.locations.find(l=>l.id===plant.location)?.type === 'outside') {
                    // Just an example static reminder for outdoor plants if alerts are checked. 
                    // To do true live alerts, you'd integrate a weather API here.
                    upcomingTasks.push({ plant, type: 'Monitor Weather üå§Ô∏è', daysUntil: 0, date: now, icon: 'fa-cloud-sun-rain', color: 'text-gray-500', bg: 'bg-gray-100 dark:bg-gray-800' });
                }

                if (isSick) {
                    const div = document.createElement("div");
                    div.className = `p-4 rounded-lg border ${plant.health === 'quarantine' ? 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800' : 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-800'}`;
                    
                    const latestPhoto = getLatestPlantPhoto(plant);
                    const imgHtml = latestPhoto ? `<img src="${latestPhoto}" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200">` : ``;

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                ${imgHtml}
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid ${plant.health === 'quarantine' ? 'fa-ban text-red-500' : 'fa-notes-medical text-yellow-500'}"></i>
                                    <span class="font-bold">${plant.name}</span>
                                </div>
                            </div>
                            <button class="text-xs btn-secondary px-2 py-1 edit-plant-btn" data-id="${plant.id}">Edit</button>
                        </div>
                        <p class="text-xs opacity-70 italic mb-2">${plant.health === 'quarantine' ? 'In Isolation' : 'Under Observation'}</p>
                        <div class="flex gap-2">
                            <button class="flex-1 btn-secondary text-xs py-1 quick-water-btn" data-id="${plant.id}">Water</button>
                            <button class="flex-1 btn-secondary text-xs py-1" onclick="openSnoozeModal('${plant.id}')">Snooze</button>
                        </div>
                    `;
                    hospitalList.appendChild(div);
                }
            });

            toggleDisplay(hospitalSection, hasSickPlants);

            if (thirstyCount === 0) waterList.innerHTML = `<div class="text-center p-4 bg-[var(--input-bg)] rounded-lg text-green-600"><i class="fa-solid fa-check-circle mb-1 text-2xl"></i><p class="text-sm font-bold">All plants watered!</p></div>`;
            if (hungryCount === 0) fertList.innerHTML = `<div class="text-center p-4 bg-[var(--input-bg)] rounded-lg text-green-600"><i class="fa-solid fa-check-circle mb-1 text-2xl"></i><p class="text-sm font-bold">All plants fed!</p></div>`;

            upcomingTasks.sort((a, b) => a.daysUntil - b.daysUntil);
            
            if (upcomingTasks.length === 0) {
                upcomingList.innerHTML = `<p class="text-center py-4 opacity-50 text-sm">No tasks for the next 7 days. Relax! üåø</p>`;
            } else {
                upcomingTasks.forEach(task => {
                    const row = document.createElement("div");
                    row.className = "flex items-center justify-between p-3 border-b border-[var(--border)] last:border-0 hover:bg-[var(--input-bg)] transition-colors rounded";
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${task.bg} flex items-center justify-center ${task.color}">
                                <i class="fa-solid ${task.icon}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm">${task.plant.name}</p>
                                <p class="text-xs opacity-70">${task.type}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-sm text-[var(--primary)]">
                                ${task.daysUntil <= 1 ? 'Tomorrow' : `In ${task.daysUntil} days`}
                            </p>
                            <p class="text-xs opacity-60">${task.date.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})}</p>
                        </div>
                    `;
                    upcomingList.appendChild(row);
                });
            }

            state.logs.slice(0, 6).forEach(log => {
                const plant = state.plants.find(p => p.id === log.plantId);
                const item = document.createElement("div");
                item.className = "card p-3 flex flex-col justify-center h-24";
                
                let iconHtml = '';
                if (plant) {
                    const latestPhoto = getLatestPlantPhoto(plant);
                    if (latestPhoto) {
                        iconHtml = `<img src="${latestPhoto}" onclick="openPhotoModal(this.src)" class="w-8 h-8 rounded-full object-cover mr-2 border border-[var(--border)] cursor-zoom-in hover:opacity-80 transition">`;
                    } else {
                        iconHtml = `<div class="w-8 h-8 rounded-full bg-[var(--input-bg)] flex items-center justify-center mr-2 text-[var(--primary)]"><i class="fa-solid ${plant.icon || 'fa-leaf'}"></i></div>`;
                    }
                } else {
                    iconHtml = `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-2"><i class="fa-solid fa-trash text-gray-400"></i></div>`;
                }

                item.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-xs uppercase tracking-wider text-[var(--primary)]">${log.type}</span>
                        <span class="text-[10px] opacity-60">${new Date(log.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
                    </div>
                    
                    <div class="flex items-center">
                        ${iconHtml}
                        <div class="overflow-hidden">
                            <p class="font-bold text-sm truncate">${plant ? plant.name : 'Deleted Plant'}</p>
                            ${log.notes ? `<p class="text-xs italic opacity-70 truncate">"${log.notes}"</p>` : ''}
                        </div>
                    </div>
                `;
                recentList.appendChild(item);
            });

            

            document.querySelectorAll(".quick-water-btn").forEach(b => b.onclick = (e) => quickWater(e.currentTarget.dataset.id));
            document.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
        };
        const renderHistory = () => {
            const tbody = getEl("history-table-body");
            tbody.innerHTML = "";
            const filter = getEl("history-search").value.toLowerCase();
            const locFilter = getEl("history-filter-location").value;
            const plantFilter = getEl("history-filter-plant").value;

            state.logs.forEach(log => {
                const plant = state.plants.find(p => p.id === log.plantId);
                const plantName = plant ? plant.name : "Deleted Plant";
                const plantLoc = plant ? plant.location : null;

                if (locFilter !== 'all' && plantLoc !== locFilter) return;
                if (plantFilter !== 'all' && log.plantId !== plantFilter) return;

                if (!filter || `${plantName} ${log.type} ${log.notes}`.toLowerCase().includes(filter)) {
                    const tr = document.createElement("tr");
                    
                    let detailsHtml = log.notes ? `<span>${log.notes}</span><br>` : '';
                    if (log.height) detailsHtml += `<span class="text-xs bg-green-100 text-green-800 px-1 rounded mr-1">‚ÜïÔ∏è ${log.height}cm</span>`;
                    if (log.health) detailsHtml += `<span class="text-xs bg-blue-100 text-blue-800 px-1 rounded mr-1">‚ù§Ô∏è ${log.health.replace('-', ' ')}</span>`;
                    if (log.noticing && log.noticing.length > 0) detailsHtml += `<span class="text-xs bg-purple-100 text-purple-800 px-1 rounded mr-1">‚ú® ${log.noticing.join(', ')}</span>`;
                    
                    const photoHtml = log.photoUrl ? `<img src="${log.photoUrl}" onclick="openPhotoModal(this.src)" class="w-10 h-10 object-cover rounded cursor-zoom-in hover:opacity-80 inline-block mr-2 border">` : '';

                    tr.innerHTML = `
                        <td class="whitespace-nowrap">${new Date(log.date).toLocaleDateString()}</td>
                        <td class="font-bold">${plantName}</td>
                        <td><span class="bg-[var(--input-bg)] px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">${log.type}</span></td>
                        <td class="text-sm opacity-80 flex items-center">
                            ${photoHtml}
                            <div>${detailsHtml || '-'}</div>
                        </td>
                        <td><button class="text-red-400 hover:text-red-600 delete-log-btn" data-id="${log.id}"><i class="fa-solid fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            document.querySelectorAll(".delete-log-btn").forEach(b => b.onclick = (e) => deleteLog(e.currentTarget.dataset.id));
        };

        const quickWater = async (plantId) => {
            if (!confirm("Log watering now?")) return;
            try {
                await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                    plantId, type: "Water", date: new Date().toISOString(), notes: "Dashboard Quick Log", createdAt: Timestamp.now()
                });
                await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { snoozeUntil: null });
                showMsg("Watering logged!");
            } catch (e) { showMsg(e.message, "error"); }
        };

        const deleteLog = async (id) => {
            if(confirm("Delete this log?")) {
                await deleteDoc(doc(db, `users/${state.user.uid}/plant_logs`, id));
                showMsg("Log deleted");
            }
        };

        getEl("delete-plant-btn").onclick = async () => {
            const id = getEl("modal-plant-id").value;
            if (!id) return;

            if (confirm("Delete this plant?")) {
                try {
                    const plant = state.plants.find(p => p.id === id);
                    if (plant && plant.photoUrl && plant.photoUrl.includes("firebasestorage")) {
                        try {
                            const fileRef = ref(storage, plant.photoUrl); 
                            await deleteObject(fileRef);
                        } catch (err) {
                            console.log("Could not delete image, might be external or already gone");
                        }
                    }
                    await deleteDoc(doc(db, `users/${state.user.uid}/plants`, id));
                    toggleDisplay(getEl("plant-modal"), false);
                    showMsg("Plant deleted üóëÔ∏è");
                } catch (e) {
                    showMsg(e.message, "error");
                }
            }
        };

        getEl("plant-location").addEventListener("change", (e) => {
            const posSelect = getEl("plant-position");
            posSelect.innerHTML = '<option value="">-- Select Position --</option>';
            const loc = state.locations.find(l => l.id === e.target.value);
            if (loc && loc.positions) {
                loc.positions.forEach(p => posSelect.innerHTML += `<option value="${p}">${p}</option>`);
            }
        });

        const openPlantModal = (plantId = null) => {
            plantPhotoRemoved = false;
            const curPhotoCont = getEl("current-plant-photo-container");
            const curPhotoImg = getEl("current-plant-photo-img");
            const modal = getEl("plant-modal");
            const title = getEl("modal-title");
            const delBtn = getEl("delete-plant-btn");
            const idInput = getEl("modal-plant-id");
            
            ['plant-name', 'plant-species', 'plant-location', 'plant-water-freq', 'plant-fert-freq', 'plant-prog-freq'].forEach(id => getEl(id).value = '');
            ['plant-mist-freq', 'plant-prune-freq', 'plant-repot-freq'].forEach(id => getEl(id).value = '');
            getEl("plant-weather").checked = false;
            getEl("plant-overwinter").checked = false;
            getEl("plant-acquired").value = new Date().toISOString().split('T')[0];
            getEl("plant-icon").value = "fa-leaf";
            getEl("plant-health").value = "healthy";
            getEl('plant-photo-name').innerHTML = ''; // Add this line
            getEl("plant-status").value = "alive";
            getEl("plant-background").value = "";

            if (plantId) {
                const plant = state.plants.find(p => p.id === plantId);
                if (plant) {
                    title.textContent = "Edit Plant";
                    idInput.value = plant.id;
                    getEl("plant-name").value = plant.name;
                    getEl("plant-species").value = plant.species || "";
                    getEl("plant-location").value = plant.location || "";
                    getEl("plant-light").value = plant.light || "";
                    getEl("plant-position").value = plant.position || "";
                    getEl("plant-health").value = plant.health || "healthy";
                    getEl("plant-water-freq").value = plant.waterFreq || "";
                    getEl("plant-fert-freq").value = plant.fertFreq || "";
                    getEl("plant-prog-freq").value = plant.progFreq || ""; 
                    getEl("plant-acquired").value = plant.acquired || "";
                    getEl("plant-icon").value = plant.icon || "fa-leaf";
                    getEl("plant-mist-freq").value = plant.mistFreq || "";
                getEl("plant-prune-freq").value = plant.pruneFreq || "";
                getEl("plant-repot-freq").value = plant.repotFreq || "";
                getEl("plant-weather").checked = plant.weatherAlerts || false;
                getEl("plant-overwinter").checked = plant.overwinter || false;
                getEl("plant-status").value = plant.status || "alive";
            getEl("plant-background").value = plant.background || "";
                
                // Populate positions dropdown before setting its value
                const posSelect = getEl("plant-position");
                posSelect.innerHTML = '<option value="">-- Select Position --</option>';
                const loc = state.locations.find(l => l.id === plant.location);
                if (loc && loc.positions) {
                    loc.positions.forEach(p => posSelect.innerHTML += `<option value="${p}">${p}</option>`);
                }
                posSelect.value = plant.position || "";
                    
                    delBtn.style.display = 'block'; 

                if (plant.photoUrl) {
                        curPhotoImg.src = plant.photoUrl;
                        curPhotoCont.classList.remove("hidden");
                        curPhotoCont.classList.add("flex");
                    } else {
                        curPhotoCont.classList.add("hidden");
                        curPhotoCont.classList.remove("flex");
                    }
                }
            } else {
                title.textContent = "Add Plant";
                idInput.value = "";
                delBtn.style.display = 'none'; 
            }
            toggleDisplay(modal, true);
        };

        getEl("open-add-plant-modal").onclick = () => openPlantModal();
        document.querySelectorAll(".close-modal-btn").forEach(b => b.onclick = (e) => toggleDisplay(e.target.closest('.modal-overlay'), false));

        getEl("save-plant-btn").onclick = async () => {
            const id = getEl("modal-plant-id").value;
            const fileInput = getEl("plant-photo");
            const file = fileInput.files[0];
            
            let data = {
                name: getEl("plant-name").value,
                species: getEl("plant-species").value,
                location: getEl("plant-location").value,
                light: getEl("plant-light").value,
                health: getEl("plant-health").value,
                position: getEl("plant-position").value,
                waterFreq: parseInt(getEl("plant-water-freq").value) || 0,
                fertFreq: parseInt(getEl("plant-fert-freq").value) || 0,
                progFreq: parseInt(getEl("plant-prog-freq").value) || 0,
                acquired: getEl("plant-acquired").value,
                icon: getEl("plant-icon").value,
                mistFreq: parseInt(getEl("plant-mist-freq").value) || 0,
                pruneFreq: parseInt(getEl("plant-prune-freq").value) || 0,
                repotFreq: parseInt(getEl("plant-repot-freq").value) || 0,
                weatherAlerts: getEl("plant-weather").checked,
                overwinter: getEl("plant-overwinter").checked,
                
                // Add these two new lines:
                status: getEl("plant-status").value,
                background: getEl("plant-background").value,
                
                updatedAt: Timestamp.now()
            };
            
            if (!data.name) return showMsg("Name required", "error");

            try {
                getEl("save-plant-btn").disabled = true;
                showMsg("Saving plant...", "success", 0); // 0 duration = stays until finished

                if (plantPhotoRemoved) {
                    data.photoUrl = null;
                }

                if (file) {
                    const compressedFile = await compressImage(file);
                    const storageRef = ref(storage, `users/${state.user.uid}/plants/${Date.now()}_${compressedFile.name}`);
                    await uploadBytes(storageRef, compressedFile);
                    data.photoUrl = await getDownloadURL(storageRef);
                }

                if (id) {
                    // Find the plant as it is right now before the update
                    const existingPlant = state.plants.find(p => p.id === id);
                    
                    // Update the plant
                    await updateDoc(doc(db, `users/${state.user.uid}/plants`, id), data);
                    
                    // If it wasn't dead before, but is dead now, log it in history!
                    if (existingPlant && existingPlant.status !== 'dead' && data.status === 'dead') {
                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId: id, type: "Archived", date: new Date().toISOString(), 
                            notes: `Moved to Graveyard ü™¶`, createdAt: Timestamp.now()
                        });
                    }
                    
                    if (file) {
                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId: id, type: "Progress", date: new Date().toISOString(), 
                            notes: `Updated plant photo`, photoUrl: data.photoUrl, createdAt: Timestamp.now()
                        });
                    }
                    showMsg("Plant updated", "success", 3000);
                } else {
                    data.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, `users/${state.user.uid}/plants`), data);
                    
                    await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                        plantId: docRef.id, type: "Added", date: new Date().toISOString(), 
                        notes: `Welcome home, ${data.name}!`, createdAt: Timestamp.now()
                    });
                    showMsg("Plant added", "success", 3000);
                }
                toggleDisplay(getEl("plant-modal"), false);
                fileInput.value = ""; 

            } catch (e) { 
                console.error(e);
                showMsg("Error saving: " + e.message, "error", 4000); 
            } finally {
                getEl("save-plant-btn").disabled = false;
            }
        };
        // --- Locations Logic ---
        window.openLocationModal = (id = null) => {
            const modal = getEl("location-modal");
            const delBtn = getEl("delete-location-btn");
            const title = getEl("modal-location-title");

            getEl("modal-location-id").value = "";
            getEl("loc-name").value = "";
            getEl("loc-positions").value = ""; // Default state
            getEl("loc-type").value = "inside";
            getEl("loc-light").value = "natural";
            getEl("loc-temp-summer").value = "";
            getEl("loc-temp-winter").value = "";
            getEl("loc-humidity").value = "medium";
            getEl("loc-draft").value = "none";
            delBtn.style.display = 'none';
            title.textContent = "Add Location";

            if (id) {
                const loc = state.locations.find(l => l.id === id);
                if (loc) {
                    getEl("modal-location-id").value = loc.id;
                    getEl("loc-name").value = loc.name || "";
                    getEl("loc-positions").value = loc.positions ? loc.positions.join(', ') : "";
                    getEl("loc-type").value = loc.type || "inside";
                    getEl("loc-light").value = loc.light || "natural";
                    getEl("loc-temp-summer").value = loc.tempSummer || "";
                    getEl("loc-temp-winter").value = loc.tempWinter || "";
                    getEl("loc-humidity").value = loc.humidity || "medium";
                    getEl("loc-draft").value = loc.draft || "none";
                    delBtn.style.display = 'block';
                    title.textContent = "Edit Location";
                }
            }
            toggleDisplay(modal, true);
        };

        window.saveLocation = async () => {
            const id = getEl("modal-location-id").value;
            const data = {
                name: getEl("loc-name").value,
                type: getEl("loc-type").value,
                light: getEl("loc-light").value,
                tempSummer: parseFloat(getEl("loc-temp-summer").value) || null,
                tempWinter: parseFloat(getEl("loc-temp-winter").value) || null,
                humidity: getEl("loc-humidity").value,
                draft: getEl("loc-draft").value,
                positions: getEl("loc-positions").value.split(',').map(s=>s.trim()).filter(Boolean),
                updatedAt: Timestamp.now()
            };

            if (!data.name) return showMsg("Location name is required", "error");

            try {
                if (id) {
                    await updateDoc(doc(db, `users/${state.user.uid}/plant_locations`, id), data);
                    showMsg("Location updated");
                } else {
                    data.createdAt = Timestamp.now();
                    await addDoc(collection(db, `users/${state.user.uid}/plant_locations`), data);
                    showMsg("Location added");
                }
                toggleDisplay(getEl("location-modal"), false);
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.deleteLocation = async (id) => {
            if(!confirm("Delete this location? Plants here will keep the reference but lose environmental details.")) return;
            try {
                await deleteDoc(doc(db, `users/${state.user.uid}/plant_locations`, id));
                toggleDisplay(getEl("location-modal"), false);
                showMsg("Location deleted");
            } catch(e) { showMsg(e.message, "error"); }
        };

        // --- Layout / Birds-Eye Logic ---
        let layoutMode = 'move'; 
        let activeTool = 'path'; 
        let activeDrag = null;   
        let activeDraw = null;   

        const tools = [
            { id: 'path', label: 'Path', icon: 'fa-road', color: 'text-gray-500', bg: 'bg-gray-300 dark:bg-gray-600', border: 'border-dashed border-gray-400' },
            { id: 'shed', label: 'Shed', icon: 'fa-warehouse', color: 'text-amber-800', bg: 'bg-amber-100 dark:bg-amber-900', border: 'border-amber-800' },
            { id: 'veg',  label: 'Veg Patch', icon: 'fa-carrot', color: 'text-orange-500', bg: 'bg-amber-900/30', border: 'border-amber-900/50' },
            { id: 'water', label: 'Water', icon: 'fa-water', color: 'text-blue-500', bg: 'bg-blue-500/20', border: 'border-blue-400' },
            { id: 'wall', label: 'Wall', icon: 'fa-ruler-horizontal', color: 'text-stone-500', bg: 'bg-stone-500', border: '' },
            { id: 'tree', label: 'Tree', icon: 'fa-tree', color: 'text-green-700', bg: 'bg-green-800/80', border: '' }
        ];

        window.setMode = (mode) => {
            layoutMode = mode;
            
            const moveBtn = getEl('mode-move');
            const drawBtn = getEl('mode-draw');
            const toolbar = getEl('layout-toolbar');
            const instructions = getEl('layout-instructions');

            if (mode === 'move') {
                moveBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all";
                drawBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all";
                toolbar.classList.add('opacity-50', 'pointer-events-none'); 
                instructions.innerHTML = '<i class="fa-solid fa-hand-pointer mr-1"></i> Drag items to move. Double-tap to delete.';
            } else {
                moveBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all";
                drawBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all";
                toolbar.classList.remove('opacity-50', 'pointer-events-none');
                instructions.innerHTML = '<i class="fa-solid fa-pencil mr-1"></i> Drag on canvas to draw area. Select tool above.';
                renderToolbar(); 
            }
        };

        window.selectTool = (toolId) => {
            activeTool = toolId;
            renderToolbar();
        };

        const renderToolbar = () => {
            const bar = getEl("layout-toolbar");
            bar.innerHTML = tools.map(t => `
                <button onclick="selectTool('${t.id}')" 
                    class="btn-secondary whitespace-nowrap text-xs flex items-center gap-2 transition-all ${activeTool === t.id && layoutMode === 'draw' ? 'ring-2 ring-[var(--primary)] bg-[var(--input-bg)]' : 'opacity-80'}">
                    <i class="fa-solid ${t.icon} ${t.color}"></i> ${t.label}
                </button>
            `).join('');
        };

        const renderLayout = () => {
            const container = document.getElementById("layout-container");
            const select = document.getElementById("layout-location-select");
            const location = select.value;
            
            container.innerHTML = `<div id="layout-placeholder" class="absolute inset-0 flex items-center justify-center opacity-50 pointer-events-none ${location ? 'hidden' : ''}">
                <p><i class="fa-solid fa-map mr-2"></i>Select a location to start</p>
            </div>`;

            container.onmousedown = handleDrawStart;
            container.ontouchstart = handleDrawStart;

            if (!location) return;

            state.structures.filter(s => s.location === location).forEach(s => {
                const tool = tools.find(t => t.id === s.type) || tools[0];
                const el = document.createElement("div");
                
                el.style.left = `${s.x}%`; 
                el.style.top = `${s.y}%`;
                el.style.width = s.w ? `${s.w}%` : (s.type === 'wall' ? '30%' : '15%'); 
                el.style.height = s.h ? `${s.h}%` : (s.type === 'wall' ? '2%' : '10%');
                
                el.className = `absolute cursor-move touch-none structure-item ${tool.bg} ${tool.border ? 'border-2' : ''} ${tool.border} rounded flex items-center justify-center shadow-sm z-0`;
                
                if (!s.w || s.w > 10) {
                    el.innerHTML = `<i class="fa-solid ${tool.icon} ${tool.color} opacity-50 pointer-events-none"></i>`;
                }

                el.dataset.id = s.id;
                el.dataset.type = "structure";
                el.addEventListener('mousedown', handleMoveStart);
                el.addEventListener('touchstart', handleMoveStart, { passive: false });
                el.ondblclick = (e) => { e.stopPropagation(); deleteStructure(s.id); };
                
                container.appendChild(el);
            });

            state.plants.filter(p => p.location === location && p.status !== 'dead').forEach(plant => {
                const el = document.createElement("div");
                const x = plant.layoutX !== undefined ? plant.layoutX : 50;
                const y = plant.layoutY !== undefined ? plant.layoutY : 50;

                el.className = "absolute flex flex-col items-center justify-center cursor-move select-none touch-none z-10 plant-marker"; 
                el.style.left = `${x}%`; el.style.top = `${y}%`;
                el.style.transform = "translate(-50%, -50%)"; 
                el.dataset.id = plant.id;
                el.dataset.type = "plant";
                
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-[var(--primary)] text-white flex items-center justify-center shadow-lg border-2 border-white dark:border-gray-800 hover:scale-110 transition-transform">
                        <i class="fa-solid ${plant.icon || 'fa-leaf'}"></i>
                    </div>
                    <span class="text-[10px] font-bold mt-1 bg-[var(--card)] px-1 rounded shadow opacity-80 whitespace-nowrap">${plant.name}</span>
                `;

                el.addEventListener('mousedown', handleMoveStart);
                el.addEventListener('touchstart', handleMoveStart, { passive: false });
                container.appendChild(el);
            });
        };
        function handleDrawStart(e) {
            if (layoutMode !== 'draw' || e.target !== getEl('layout-container')) return;
            e.preventDefault();

            const container = getEl("layout-container");
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const startX = ((clientX - rect.left) / rect.width) * 100;
            const startY = ((clientY - rect.top) / rect.height) * 100;

            const guide = document.createElement("div");
            guide.className = "absolute border-2 border-[var(--primary)] bg-[var(--primary)] bg-opacity-20 z-50 pointer-events-none";
            guide.style.left = startX + '%';
            guide.style.top = startY + '%';
            container.appendChild(guide);

            activeDraw = { startX, startY, guide, rect };

            document.addEventListener('mousemove', handleDrawMove);
            document.addEventListener('touchmove', handleDrawMove, { passive: false });
            document.addEventListener('mouseup', handleDrawEnd);
            document.addEventListener('touchend', handleDrawEnd);
        }

        function handleDrawMove(e) {
            if (!activeDraw) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let currX = ((clientX - activeDraw.rect.left) / activeDraw.rect.width) * 100;
            let currY = ((clientY - activeDraw.rect.top) / activeDraw.rect.height) * 100;
            
            currX = Math.max(0, Math.min(100, currX));
            currY = Math.max(0, Math.min(100, currY));

            const left = Math.min(activeDraw.startX, currX);
            const top = Math.min(activeDraw.startY, currY);
            const width = Math.abs(currX - activeDraw.startX);
            const height = Math.abs(currY - activeDraw.startY);

            activeDraw.guide.style.left = left + '%';
            activeDraw.guide.style.top = top + '%';
            activeDraw.guide.style.width = width + '%';
            activeDraw.guide.style.height = height + '%';

            activeDraw.final = { x: left, y: top, w: width, h: height };
        }

        async function handleDrawEnd() {
            if (activeDraw && activeDraw.final) {
                const { x, y, w, h } = activeDraw.final;
                const location = getEl("layout-location-select").value;
                
                if (w > 2 || h > 2) {
                    try {
                        await addDoc(collection(db, `users/${state.user.uid}/garden_structures`), {
                            type: activeTool,
                            location: location,
                            x, y, w, h,
                            createdAt: Timestamp.now()
                        });
                    } catch(e) { showMsg(e.message, "error"); }
                }
                activeDraw.guide.remove();
            } else if (activeDraw) {
                activeDraw.guide.remove(); 
            }

            activeDraw = null;
            document.removeEventListener('mousemove', handleDrawMove);
            document.removeEventListener('touchmove', handleDrawMove);
            document.removeEventListener('mouseup', handleDrawEnd);
            document.removeEventListener('touchend', handleDrawEnd);
        }

        function handleMoveStart(e) {
            if (layoutMode === 'draw') return; 
            e.stopPropagation(); 
            if(e.cancelable) e.preventDefault();
            
            const el = e.currentTarget;
            const container = getEl("layout-container").getBoundingClientRect();
            
            activeDrag = {
                el,
                id: el.dataset.id,
                type: el.dataset.type, 
                container,
                offsetX: 0, offsetY: 0
            };

            document.addEventListener('mousemove', handleMoveDrag);
            document.addEventListener('touchmove', handleMoveDrag, { passive: false });
            document.addEventListener('mouseup', handleMoveEnd);
            document.addEventListener('touchend', handleMoveEnd);
        }

        function handleMoveDrag(e) {
            if (!activeDrag) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let x = ((clientX - activeDrag.container.left) / activeDrag.container.width) * 100;
            let y = ((clientY - activeDrag.container.top) / activeDrag.container.height) * 100;
            
            x = Math.max(0, Math.min(100, x));
            y = Math.max(0, Math.min(100, y));

            activeDrag.el.style.left = x + '%';
            activeDrag.el.style.top = y + '%';
            activeDrag.lastX = x;
            activeDrag.lastY = y;
        }

        async function handleMoveEnd() {
            if (activeDrag && activeDrag.lastX !== undefined) {
                const { id, type, lastX, lastY } = activeDrag;
                try {
                    const collectionName = type === 'structure' ? 'garden_structures' : 'plants';
                    const updateData = type === 'structure' 
                        ? { x: lastX, y: lastY } 
                        : { layoutX: lastX, layoutY: lastY }; 

                    await updateDoc(doc(db, `users/${state.user.uid}/${collectionName}`, id), updateData);
                } catch(e) { console.error("Save pos failed", e); }
            }
            activeDrag = null;
            document.removeEventListener('mousemove', handleMoveDrag);
            document.removeEventListener('touchmove', handleMoveDrag);
            document.removeEventListener('mouseup', handleMoveEnd);
            document.removeEventListener('touchend', handleMoveEnd);
        }

        renderToolbar();
        // --- Wishlist Functions ---
        window.openWishlistModal = (id = null) => {
            const modal = getEl("wishlist-modal");
            const delBtn = getEl("delete-wish-btn");
            
            getEl("wish-id").value = "";
            getEl("wish-name").value = "";
            getEl("wish-species").value = "";
            getEl("wish-price").value = "";
            getEl("wish-notes").value = "";
            document.querySelector('input[name="wish-priority"][value="medium"]').checked = true;
            delBtn.style.display = 'none';

            if (id) {
                const item = state.wishlist.find(w => w.id === id);
                if (item) {
                    getEl("wish-id").value = item.id;
                    getEl("wish-name").value = item.name;
                    getEl("wish-species").value = item.species || "";
                    getEl("wish-price").value = item.price || "";
                    getEl("wish-notes").value = item.notes || "";
                    const radio = document.querySelector(`input[name="wish-priority"][value="${item.priority}"]`);
                    if(radio) radio.checked = true;
                    
                    delBtn.style.display = 'block';
                    delBtn.onclick = () => deleteWish(id);
                }
            }
            toggleDisplay(modal, true);
        };

        window.saveWish = async () => {
            const id = getEl("wish-id").value;
            const data = {
                name: getEl("wish-name").value,
                species: getEl("wish-species").value,
                price: getEl("wish-price").value,
                notes: getEl("wish-notes").value,
                priority: document.querySelector('input[name="wish-priority"]:checked').value,
                updatedAt: Timestamp.now()
            };

            if (!data.name) return showMsg("Name is required", "error");

            try {
                if (id) {
                    await updateDoc(doc(db, `users/${state.user.uid}/wishlist`, id), data);
                    showMsg("Wish updated ‚ú®");
                } else {
                    data.createdAt = Timestamp.now();
                    await addDoc(collection(db, `users/${state.user.uid}/wishlist`), data);
                    showMsg("Added to wishlist ‚ú®");
                }
                toggleDisplay(getEl("wishlist-modal"), false);
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.deleteWish = async (id) => {
            if(!confirm("Remove from wishlist?")) return;
            try {
                await deleteDoc(doc(db, `users/${state.user.uid}/wishlist`, id));
                toggleDisplay(getEl("wishlist-modal"), false);
                showMsg("Wish removed");
            } catch(e) { showMsg(e.message, "error"); }
        };

        window.promoteWish = async (id) => {
            const item = state.wishlist.find(w => w.id === id);
            if (!item) return;

            if (!confirm(`Did you get the ${item.name}? This will move it to your Garden.`)) return;

            try {
                const plantData = {
                    name: item.name,
                    species: item.species || "",
                    location: "",
                    light: "medium",
                    health: "healthy",
                    waterFreq: 7, 
                    fertFreq: 14, 
                    acquired: new Date().toISOString().split('T')[0],
                    icon: "fa-leaf",
                    createdAt: Timestamp.now()
                };
                
                const docRef = await addDoc(collection(db, `users/${state.user.uid}/plants`), plantData);

                await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                    plantId: docRef.id,
                    type: "Added",
                    date: new Date().toISOString(),
                    notes: `Wishlist item acquired! (Price: ${item.price || 'N/A'})`,
                    createdAt: Timestamp.now()
                });

                await deleteDoc(doc(db, `users/${state.user.uid}/wishlist`, id));
                showMsg("Welcome home! moved to Garden üå±");
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.openPhotoModal = (src) => {
            if (!src) return;
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('photo-modal-img');
            img.src = src;
            modal.classList.remove('hidden');
        };

        window.closePhotoModal = () => {
            document.getElementById('photo-modal').classList.add('hidden');
            document.getElementById('photo-modal-img').src = '';
        };

        getEl("log-type-select").addEventListener("change", (e) => {
            const showExtras = e.target.value === "Progress" || e.target.value === "Growth";
            toggleDisplay(getEl("log-progress-extras"), showExtras);
        });

        const renderWishlist = () => {
            const list = getEl("wishlist-container");
            list.innerHTML = "";

            let high = 0, med = 0, low = 0;

            state.wishlist.sort((a,b) => {
                const priorities = { high: 3, medium: 2, low: 1 };
                return priorities[b.priority] - priorities[a.priority];
            }).forEach(item => {
                if(item.priority === 'high') high++;
                if(item.priority === 'medium') med++;
                if(item.priority === 'low') low++;

                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between relative overflow-hidden group";
                
                const borderColors = { high: 'border-red-500', medium: 'border-yellow-500', low: 'border-green-500' };
                card.classList.add('border-l-4', borderColors[item.priority]);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg">${item.name}</h3>
                            <p class="text-xs opacity-70">${item.species || 'Unknown Species'}</p>
                        </div>
                        <button onclick="openWishlistModal('${item.id}')" class="text-gray-400 hover:text-purple-500">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4 space-y-1">
                        ${item.price ? `<p class="text-sm"><i class="fa-solid fa-tag text-gray-400 w-5"></i> ${item.price}</p>` : ''}
                        ${item.notes ? `<p class="text-xs italic opacity-60 line-clamp-2">"${item.notes}"</p>` : ''}
                    </div>

                    <button onclick="promoteWish('${item.id}')" class="w-full py-2 bg-[var(--input-bg)] hover:bg-green-100 dark:hover:bg-green-900 text-green-600 font-bold rounded flex items-center justify-center gap-2 transition-colors">
                        <i class="fa-solid fa-check"></i> I Got It!
                    </button>
                `;
                list.appendChild(card);
            });

            getEl("wish-count-high").textContent = high;
            getEl("wish-count-med").textContent = med;
            getEl("wish-count-low").textContent = low;

            if(state.wishlist.length === 0) {
                list.innerHTML = `<p class="col-span-3 text-center opacity-50 py-8">Your wishlist is empty. Time to go shopping? üõçÔ∏è</p>`;
            }
        };
        // --- Auth & Init ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;

                state.nav = new AppNavigation({
                    appName: 'PlantTrackr',
                    appIcon: 'fa-leaf',
                    themeColor: 'green',
                    userEmail: user.email,
                    version: changelogData && changelogData.length > 0 ? changelogData[0].version : '1.0.0',
                    activeTab: 'dashboard',
                    tabs: [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fa-border-all' },
                        { id: 'plants',    label: 'Garden',    icon: 'fa-seedling' },
                        { id: 'locations', label: 'Locations', icon: 'fa-map-location-dot' }, 
                        { id: 'wishlist',  label: 'Wishlist',  icon: 'fa-star' }, 
                        { id: 'layout',    label: 'Layout',    icon: 'fa-map' },
                        { id: 'history',   label: 'Journal',   icon: 'fa-book' },
                        { id: 'settings',  label: 'Settings',  icon: 'fa-gear' },
                        // Add this new tab configuration:
                        { id: 'graveyard', label: 'Graveyard', icon: 'fa-skull' }
                    ],
                    onThemeChange: async (newTheme) => {
                        await setDoc(doc(db, 'users', user.uid, 'settings', 'theme'), { theme: newTheme }, { merge: true });
                    }
                });

                onSnapshot(doc(db, 'users', state.user.uid, 'settings', 'general'), (snap) => {
                    state.winterMode = snap.exists() ? snap.data().winterMode : false;
                    const toggle = getEl("winter-mode-toggle");
                    if(toggle) toggle.checked = state.winterMode;
                    renderDashboard(); 
                });

                getEl("winter-mode-toggle").addEventListener('change', async (e) => {
                    await setDoc(doc(db, 'users', state.user.uid, 'settings', 'general'), { 
                        winterMode: e.target.checked 
                    }, { merge: true });
                });

                getEl("log-type-select").addEventListener("change", (e) => {
                    const showExtras = e.target.value === "Progress";
                    toggleDisplay(getEl("log-progress-extras"), showExtras);
                });

                getEl("submit-log-btn").onclick = async () => {
                    const plantId = getEl("log-plant-select").value;
                    const type = getEl("log-type-select").value;
                    const date = getEl("log-date").value;
                    const notes = getEl("log-notes").value;
                    const height = getEl("log-growth-val").value;
                    const health = getEl("log-health-select").value;
                    const noticingTags = Array.from(document.querySelectorAll('#log-noticing-tags input:checked')).map(cb => cb.value);
                    
                    const fileInput = getEl("log-photo");
                    const file = fileInput ? fileInput.files[0] : null;

                    if (!plantId) return showMsg("Please select a plant", "error");

                    try {
                        getEl("submit-log-btn").disabled = true;
                        showMsg("Saving log...", "success", 0); // 0 duration = stays until finished

                        let photoUrl = null;
                        if (file) {
                            const compressedFile = await compressImage(file);
                            const storageRef = ref(storage, `users/${state.user.uid}/logs/${Date.now()}_${compressedFile.name}`);
                            await uploadBytes(storageRef, compressedFile);
                            photoUrl = await getDownloadURL(storageRef);
                        }

                        const logData = {
                            plantId, type, date: new Date(date).toISOString(), notes,
                            height: height ? parseFloat(height) : null,
                            noticing: noticingTags,
                            photoUrl, createdAt: Timestamp.now()
                        };
                        
                        if (type === 'Progress') logData.health = health;

                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), logData);

                        if (type === 'Progress' && health) {
                            await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { health });
                        }

                        showMsg("Log saved successfully!", "success", 3000);
                        
                        // Reset Form fields
                        getEl("log-notes").value = "";
                        getEl("log-growth-val").value = "";
                        document.querySelectorAll('#log-noticing-tags input').forEach(cb => cb.checked = false);
                        if(fileInput) fileInput.value = "";
                        getEl("log-photo-name").innerHTML = ""; // Add this line
                        toggleDisplay(getEl("log-progress-extras"), false);
                        getEl("log-type-select").value = "Water";

                    } catch (e) { 
                        showMsg(e.message, "error", 4000); 
                    } finally {
                        getEl("submit-log-btn").disabled = false;
                    }
                };

                window.openSnoozeModal = (plantId) => {
                    getEl("snooze-plant-target").value = plantId;
                    getEl("snooze-custom-val").value = "";
                    toggleDisplay(getEl("snooze-modal"), true);
                };

                window.applySnooze = async (days) => {
                    const plantId = getEl("snooze-plant-target").value;
                    const duration = parseInt(days);
                    
                    if (!plantId || isNaN(duration) || duration <= 0) return showMsg("Invalid duration", "error");
                    
                    try {
                        const date = new Date(); 
                        date.setDate(date.getDate() + duration);
                        
                        await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { 
                            snoozeUntil: Timestamp.fromDate(date) 
                        });

                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId, type: "Snooze", date: new Date().toISOString(), 
                            notes: `Snoozed for ${duration} days`, 
                            createdAt: Timestamp.now()
                        });
                        
                        showMsg(`Snoozed for ${duration} days`);
                        toggleDisplay(getEl("snooze-modal"), false);
                    } catch(e) { showMsg(e.message, "error"); }
                };

                window.unsnoozePlant = async (plantId) => {
                    if (!confirm("Wake this plant up?")) return;
                    try {
                        await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { snoozeUntil: null });
                        
                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId, type: "Unsnooze", date: new Date().toISOString(), 
                            notes: "Manually woke up plant", createdAt: Timestamp.now()
                        });

                        showMsg("Snooze cancelled");
                    } catch (e) { showMsg(e.message, "error"); }
                };
                window.addStructure = async (type) => {
                    const location = getEl("layout-location-select").value;
                    if (!location) return showMsg("Please select a location first", "error");

                    try {
                        await addDoc(collection(db, `users/${state.user.uid}/garden_structures`), {
                            type, location, x: 50, y: 50, createdAt: Timestamp.now()
                        });
                    } catch(e) { showMsg(e.message, "error"); }
                };

                const deleteStructure = async (id) => {
                    if(confirm("Remove this item?")) {
                        await deleteDoc(doc(db, `users/${state.user.uid}/garden_structures`, id));
                    }
                };

                const themeDocRef = doc(db, 'users', user.uid, 'settings', 'theme');
                if (state.themeUnsubscribe) state.themeUnsubscribe();
                
                state.themeUnsubscribe = onSnapshot(themeDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const isDark = data.theme === 'dark';
                        if (state.nav) state.nav.applyTheme(isDark);
                    }
                });

                window.addEventListener('tab-changed', (e) => {
                    const tabId = e.detail.tabId;
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                    const target = getEl(`tab-content-${tabId}`);
                    if(target) target.classList.remove('hidden');
                });

                getEl("loading-state").classList.add("hidden");
                getEl("main-app-container").classList.remove("hidden");

                state.unsubPlants = onSnapshot(query(collection(db, `users/${user.uid}/plants`), orderBy("name")), snap => {
                    state.plants = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateLocationDropdowns();
                    renderPlants(); 
                    renderDashboard();
                    renderLayout(); 
                    renderGraveyard(); // Add this line!
                });

                state.unsubLocs = onSnapshot(collection(db, `users/${user.uid}/plant_locations`), snap => {
                    // Safe localeCompare in case a location is saved without a name
                    state.locations = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                    updateLocationDropdowns();
                    renderLocations();
                    renderPlants(); 
                    renderLayout(); 
                });

                state.unsubLogs = onSnapshot(query(collection(db, `users/${user.uid}/plant_logs`), orderBy("date", "desc")), snap => {
                    state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderDashboard(); renderHistory();
                });

                state.unsubStructs = onSnapshot(collection(db, `users/${user.uid}/garden_structures`), snap => {
                    state.structures = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderLayout();
                });

                state.unsubWish = onSnapshot(collection(db, `users/${user.uid}/wishlist`), snap => {
                    state.wishlist = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderWishlist();
                });

                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                getEl("log-date").value = now.toISOString().slice(0, 16);

            } else {
                window.location.href = '/';
            }
        });

        getEl("history-search").oninput = renderHistory;

        getEl("export-json-btn").onclick = () => {
            const blob = new Blob([JSON.stringify({plants: state.plants, logs: state.logs, locations: state.locations}, null, 2)], {type: "application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "plants_backup.json"; a.click();
        };
        getEl("export-csv-btn").onclick = () => {
            const csv = Papa.unparse(state.logs.map(l => ({
                date: l.date, plant: state.plants.find(p=>p.id===l.plantId)?.name, type: l.type, notes: l.notes
            })));
            const blob = new Blob([csv], {type: "text/csv"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "plant_logs.csv"; a.click();
        };

        document.getElementById("layout-location-select").addEventListener("change", renderLayout);
        // Add this line so the Garden tab filter actually triggers a re-render
        document.getElementById("plant-filter-location").addEventListener("change", renderPlants);
        document.getElementById("history-filter-location").addEventListener("change", renderHistory);
        document.getElementById("history-filter-plant").addEventListener("change", renderHistory);
    </script>
</body>
</html>
