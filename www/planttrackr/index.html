<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlantTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20width%3D'128'%20height%3D'128'%20viewBox%3D'0%200%20128%20128'%3E%3Cdefs%3E%3ClinearGradient%20id%3D'g'%20x1%3D'85.35533905932738%25'%20y1%3D'85.35533905932738%25'%20x2%3D'14.644660940672615%25'%20y2%3D'14.64466094067263%25'%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'0%25'%20style%3D'stop-color%3A%234f46e5%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D'100%25'%20style%3D'stop-color%3A%239333ea%3Bstop-opacity%3A0'%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect%20width%3D'128'%20height%3D'128'%20rx%3D'25.6'%20fill%3D'url(%23g)'%20%2F%3E%3Cg%20transform%3D'translate(0%2C%200)%20rotate(0%2C%2064%2C%2064)'%3E%3Csvg%20x%3D'32'%20y%3D'32'%20width%3D'64'%20height%3D'64'%20viewBox%3D'0%200%20512%20512'%3E%3Cpath%20fill%3D'%2322c55e'%20fill-opacity%3D'1'%20d%3D'M272%2096c-78.6%200-145.1%2051.5-167.7%20122.5c33.6-17%2071.5-26.5%20111.7-26.5h88c8.8%200%2016%207.2%2016%2016s-7.2%2016-16%2016H288%20216s0%200%200%200c-16.6%200-32.7%201.9-48.3%205.4c-25.9%205.9-49.9%2016.4-71.4%2030.7c0%200%200%200%200%200C38.3%20298.8%200%20364.9%200%20440v16c0%2013.3%2010.7%2024%2024%2024s24-10.7%2024-24V440c0-48.7%2020.7-92.5%2053.8-123.2C121.6%20392.3%20190.3%20448%20272%20448l1%200c132.1-.7%20239-130.9%20239-291.4c0-42.6-7.5-83.1-21.1-119.6c-2.6-6.9-12.7-6.6-16.2-.1C455.9%2072.1%20418.7%2096%20376%2096L272%2096z'%20%2F%3E%3C%2Fsvg%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="manifest" href="/manifest.json" />
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        green: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg: #f0fdf4;       
            --card: #ffffff;
            --text: #14532d;     
            --border: #bbf7d0;   
            --input-bg: #dcfce7; 
            --primary: #16a34a;  
        }

        .dark {
            --bg: #064e3b;       
            --card: #022c22;     
            --text: #ecfdf5;     
            --border: #14532d;
            --input-bg: #14532d; 
            --primary: #22c55e;  
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        @media (max-width: 768px) {
            body { padding-bottom: 80px; }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .input-std {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            outline: none;
            transition: ring 0.2s;
        }
        .input-std:focus {
            outline: 2px solid var(--primary);
            border-color: var(--primary);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background-color: var(--input-bg);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .btn-secondary:hover { filter: brightness(0.95); }

        .plant-icon-circle {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem;
            background-color: var(--input-bg);
            color: var(--primary);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
            position: relative;
        }

        .message-box {
            position: fixed; top: 6rem; left: 50%; transform: translateX(-50%);
            padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            color: white; z-index: 100; font-weight: 600;
            display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .message-box.show { display: block; animation: fadeIn 0.3s; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 0.75rem; color: var(--text); opacity: 0.7; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 0.75rem; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <div id="loading-state" class="fixed inset-0 flex flex-col items-center justify-center bg-[var(--bg)] z-50">
        <i class="fa-solid fa-leaf fa-spin text-5xl text-[var(--primary)] mb-4"></i>
        <p class="text-lg font-semibold opacity-70">Entering the greenhouse...</p>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8 hidden" id="main-app-container">
        
        <div id="tab-content-dashboard" class="tab-content animate-fade">
            <div id="dashboard-weather-banner" class="mb-4 hidden"></div>

            <section id="dashboard-hospital-section" class="card p-4 mb-4 border-2 border-red-100 dark:border-red-900 hidden">
                <h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-red-600 dark:text-red-400">
                    <i class="fa-solid fa-staff-snake"></i> The Infirmary
                </h2>
                <div id="dashboard-hospital-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </section>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <section class="card p-4 lg:col-span-2 flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-[var(--primary)]">
                            <i class="fa-solid fa-clipboard-list"></i> Action Required
                        </h2>
                        <button onclick="window.openLawnModal()" class="text-xs btn-secondary py-1 px-2" title="Manage Lawn"><i class="fa-solid fa-scissors mr-1"></i> Lawn Settings</button>
                    </div>
                    <div id="dashboard-care-combined-list" class="space-y-2 flex-grow">
                        <p class="text-sm opacity-60">Checking needs...</p>
                    </div>
                </section>

                <section class="card p-4 flex flex-col">
                    <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-calendar-week text-purple-500"></i> Next 7 Days
                    </h2>
                    <div id="dashboard-upcoming-list" class="space-y-1 flex-grow overflow-y-auto max-h-64 pr-2 hide-scrollbar">
                        <p class="text-sm opacity-60">Forecasting schedule...</p>
                    </div>
                </section>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-q gap-4 mb-8">
                <div class="mb-8">
                <section class="card p-4 flex flex-col h-fit">
                    <h2 class="text-lg font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left opacity-50"></i> Recent Activity</h2>
                    <div id="dashboard-recent-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                </section>
            </div>
        </div>
        </div> 
        <div id="tab-content-plants" class="tab-content hidden animate-fade">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold">My Garden</h1>
        
        <div class="bg-gray-200 dark:bg-gray-800 p-1 rounded-lg flex gap-1 w-full md:w-auto overflow-x-auto hide-scrollbar">
            <button onclick="window.toggleGardenView('active')" id="btn-view-active" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all whitespace-nowrap">Active</button>
            <button onclick="window.toggleGardenView('wishlist')" id="btn-view-wishlist" class="px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all whitespace-nowrap">Wishlist</button>
            <button onclick="window.toggleGardenView('graveyard')" id="btn-view-graveyard" class="px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all whitespace-nowrap">Graveyard</button>
        </div>

        <div class="flex gap-2 w-full md:w-auto" id="garden-controls">
            <select id="plant-filter-location" class="input-std !w-auto">
                <option value="all">All Locations</option>
            </select>
            <button id="open-add-plant-modal" class="btn-primary whitespace-nowrap">
                <i class="fa-solid fa-plus"></i> Add
            </button>
            <button onclick="openWishlistModal()" id="open-add-wish-modal" class="btn-primary bg-purple-600 hover:bg-purple-700 whitespace-nowrap hidden">
                <i class="fa-solid fa-plus"></i> Add Wish
            </button>
        </div>
    </div>

    <div id="plants-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    
    <div id="wishlist-wrapper" class="hidden">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card p-4 border-l-4 border-red-500">
                <h3 class="text-xs font-bold opacity-60 uppercase">High Priority</h3>
                <p class="text-2xl font-bold" id="wish-count-high">0</p>
            </div>
            <div class="card p-4 border-l-4 border-yellow-500">
                <h3 class="text-xs font-bold opacity-60 uppercase">Medium Priority</h3>
                <p class="text-2xl font-bold" id="wish-count-med">0</p>
            </div>
            <div class="card p-4 border-l-4 border-green-500">
                <h3 class="text-xs font-bold opacity-60 uppercase">Low Priority</h3>
                <p class="text-2xl font-bold" id="wish-count-low">0</p>
            </div>
        </div>

        <div id="wishlist-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="graveyard-wrapper" class="hidden">
        <div id="graveyard-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>
        

        <div id="tab-content-layout" class="tab-content hidden animate-fade">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold">Spaces</h1>
        
        <div class="bg-gray-200 dark:bg-gray-800 p-1 rounded-lg flex gap-1">
            <button onclick="window.toggleSpacesView('list')" id="btn-space-list" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all">List View</button>
            <button onclick="window.toggleSpacesView('map')" id="btn-space-map" class="px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all">Map Builder</button>
        </div>

        <button onclick="openLocationModal()" id="btn-add-location" class="btn-primary">
            <i class="fa-solid fa-plus"></i> New Space
        </button>
    </div>

    <div id="spaces-list-wrapper">
        <div id="locations-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="spaces-map-wrapper" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <div class="bg-gray-200 dark:bg-gray-800 p-1 rounded-lg flex gap-1">
                <button id="mode-move" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all" onclick="setMode('move')"><i class="fa-solid fa-hand-pointer mr-2"></i> Move</button>
                <button id="mode-draw" class="px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all" onclick="setMode('draw')"><i class="fa-solid fa-pencil mr-2"></i> Draw</button>
            </div>
            <select id="layout-location-select" class="input-std !w-auto"><option value="">-- Select Room --</option></select>
        </div>
        <div id="layout-toolbar" class="card p-2 mb-4 flex gap-2 overflow-x-auto"></div>
        <div class="card relative bg-[#f0fdf4] dark:bg-[#022c22] border-2 border-dashed border-[var(--border)] overflow-hidden" style="height: 60vh;" id="layout-container">
            <div id="layout-placeholder" class="absolute inset-0 flex items-center justify-center opacity-50 pointer-events-none"><p>Select a location to start</p></div>
        </div>
    </div>
</div>

        <div id="tab-content-history" class="tab-content hidden animate-fade">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold">Journal</h1>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <select id="history-filter-location" class="input-std !w-auto">
                        <option value="all">All Locations</option>
                    </select>
                    <select id="history-filter-plant" class="input-std !w-auto">
                        <option value="all">All Plants</option>
                    </select>
                    <input type="text" id="history-search" class="input-std !w-auto md:w-48" placeholder="Search...">
                </div>
            </div>
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table id="history-table">
                        <thead><tr><th>Date</th><th>Plant</th><th>Action</th><th>Details</th><th></th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        



        <div id="tab-content-settings" class="tab-content hidden animate-fade">
            <h1 class="text-3xl font-bold mb-6">Settings</h1>
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Seasons</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-bold">Winter Mode</p>
                        <p class="text-xs opacity-70">Reduces watering frequency by 50%</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="winter-mode-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>

            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">API Integrations & Advice</h2>
                <p class="text-sm opacity-70 mb-4">OpenFarm API is free and enabled by default. Add a Perenual API key for expanded access to watering and sunlight advice.</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Perenual API Key (Optional)</label>
                        <input type="text" id="setting-perenual-key" class="input-std" placeholder="sk-...">
                    </div>
                    <button onclick="window.saveApiKeys()" class="btn-primary">Save API Keys</button>
                </div>
            </div>

            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Data Management</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="export-json-btn" class="btn-secondary"><i class="fa-solid fa-download mr-2"></i> Export JSON</button>
                    <button id="export-csv-btn" class="btn-secondary"><i class="fa-solid fa-file-csv mr-2"></i> Export CSV</button>
                </div>
            </div>
        </div>

    </main>

    <div id="location-modal" class="modal-overlay hidden !z-[60]" style="display: none;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="toggleDisplay(document.getElementById('location-modal'), false)">&times;</button>
            <h2 id="modal-location-title" class="text-2xl font-bold mb-6">Add Location</h2>
            <input type="hidden" id="modal-location-id">
            
            <div class="space-y-4">
                <div><label class="text-sm font-bold">Name</label><input type="text" id="loc-name" class="input-std" placeholder="e.g. Kitchen, Living Room"></div>
                
                <div>
                    <label class="text-sm font-bold">Positions / Zones (Comma-separated)</label>
                    <input type="text" id="loc-positions" class="input-std" placeholder="e.g. Window Sill, Island, Fridge Top">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Type</label>
                        <select id="loc-type" class="input-std">
                            <option value="inside">Inside</option>
                            <option value="outside">Outside</option>
                            <option value="germinator">Germinator</option>
                            <option value="patio">Patio</option>
                            <option value="greenhouse">Greenhouse</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Light Source</label>
                        <select id="loc-light" class="input-std">
                            <option value="natural">Natural Light</option>
                            <option value="growlight">Grow Light</option>
                            <option value="both">Both</option>
                            <option value="low">Low Light</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Avg Temp Summer (¬∞C)</label><input type="number" id="loc-temp-summer" class="input-std" placeholder="e.g. 25"></div>
                    <div><label class="text-sm font-bold">Avg Temp Winter (¬∞C)</label><input type="number" id="loc-temp-winter" class="input-std" placeholder="e.g. 18"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Humidity</label>
                        <select id="loc-humidity" class="input-std">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Draft</label>
                        <select id="loc-draft" class="input-std">
                            <option value="none">None</option>
                            <option value="slight">Slight</option>
                            <option value="drafty">Drafty</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="saveLocation()" class="btn-primary flex-1">Save Location</button>
                    <button id="delete-location-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden" onclick="deleteLocation(document.getElementById('modal-location-id').value)">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="plant-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Plant</h2>
            <input type="hidden" id="modal-plant-id">
            
            <div class="space-y-4">
                <div><label class="text-sm font-bold">Name</label><input type="text" id="plant-name" class="input-std" placeholder="e.g. Monstera"></div>

                <button type="button" onclick="window.openApiSearchModal()" class="btn-secondary text-xs w-full mt-1 border-dashed border-2">
                    <i class="fa-solid fa-cloud-arrow-down mr-1"></i> Auto-fill Advice from API
                </button>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Species</label><input type="text" id="plant-species" class="input-std"></div>
                    <div>
                        <label class="text-sm font-bold">Location / Area</label>
                        <div class="flex gap-2">
                            <select id="plant-location" class="input-std flex-grow">
                                <option value="">-- Select --</option>
                            </select>
                            <button type="button" onclick="openLocationModal()" class="btn-secondary px-3" title="Create New Location">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
    <div>
        <label class="text-sm font-bold">Pot Material</label>
        <select id="plant-pot-type" class="input-std">
    <option value="plastic">Plastic / Nursery</option>
    <option value="terracotta">Terracotta (Dries fast)</option>
    <option value="ceramic">Glazed Ceramic</option>
    <option value="ground">In Ground / Garden Bed</option>
</select>
    </div>
    <div>
        <label class="text-sm font-bold">Pot Size (cm)</label>
        <input type="number" id="plant-pot-size" class="input-std" placeholder="Diameter e.g. 15">
    </div>
</div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Light Condition</label>
                        <select id="plant-light" class="input-std">
                            <option value="">-- Select --</option>
                            <option value="low">‚òÅÔ∏è Low / Shadow</option>
                            <option value="medium">‚õÖ Medium / Indirect</option>
                            <option value="high">‚òÄÔ∏è Bright / Direct</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Position Details</label>
                        <select id="plant-position" class="input-std">
                            <option value="">-- Select Location First --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div><label class="text-sm font-bold">Water Every</label><input type="number" id="plant-water-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Feed Every</label><input type="number" id="plant-fert-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Progress Every</label><input type="number" id="plant-prog-freq" class="input-std" placeholder="Days"></div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div><label class="text-sm font-bold">Mist Every</label><input type="number" id="plant-mist-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Prune Every</label><input type="number" id="plant-prune-freq" class="input-std" placeholder="Days"></div>
                    <div><label class="text-sm font-bold">Repot Every</label><input type="number" id="plant-repot-freq" class="input-std" placeholder="Days"></div>
                </div>

                <div class="flex gap-4 mb-4">
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-bold">
                        <input type="checkbox" id="plant-weather" class="w-4 h-4 text-[var(--primary)] bg-[var(--input-bg)] border-[var(--border)] rounded focus:ring-[var(--primary)]">
                        Weather Alerts
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-bold">
                        <input type="checkbox" id="plant-overwinter" class="w-4 h-4 text-[var(--primary)] bg-[var(--input-bg)] border-[var(--border)] rounded focus:ring-[var(--primary)]">
                        Needs Overwintering
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-bold">Health Status</label>
                        <select id="plant-health" class="input-std">
                            <option value="excellent">Excellent üåü</option>
                            <option value="good" selected>Good üåø</option>
                            <option value="bad">Bad üìâ</option>
                            <option value="sick-pests">Sick - Pests üêõ</option>
                            <option value="sick-wilty">Sick - Wilty ü•Ä</option>
                            <option value="sick-other">Sick - Other ü§í</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Status</label>
                        <select id="plant-status" class="input-std">
                            <option value="alive" selected>Alive & Kicking</option>
                            <option value="dead">Dead / Archived ü™¶</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-sm font-bold">Background / History</label>
                    <textarea id="plant-background" class="input-std" rows="2" placeholder="Where is it from? Was it a gift? Any history?"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold">Acquired On</label><input type="date" id="plant-acquired" class="input-std"></div>
                    <div>
                        <label class="text-sm font-bold">Icon</label>
                        <select id="plant-icon" class="input-std">
                            <option value="fa-leaf">Leaf</option>
                            <option value="fa-seedling">Seedling</option>
                            <option value="fa-tree">Tree</option>
                            <option value="fa-cannabis">Broad</option>
                            <option value="fa-clover">Clover</option>
                            <option value="fa-spa">Lotus</option>
                            <option value="fa-apple-whole">Fruit</option>
                            <option value="fa-pepper-hot">Veg</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Custom Photo (Optional)</label>
                        <div id="current-plant-photo-container" class="hidden mb-2 items-center gap-3">
                            <img id="current-plant-photo-img" class="w-12 h-12 rounded-full object-cover border border-[var(--border)]">
                            <button type="button" class="btn-secondary text-xs text-red-500 py-1 px-2" id="remove-plant-photo-btn">
                                <i class="fa-solid fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="flex gap-2 mb-1 mt-1">
                            <button type="button" class="btn-secondary flex-1 py-2 text-xs" onclick="document.getElementById('plant-photo').removeAttribute('capture'); document.getElementById('plant-photo').click();"><i class="fa-solid fa-image mr-1"></i> Gallery</button>
                            <button type="button" class="btn-secondary flex-1 py-2 text-xs" onclick="document.getElementById('plant-photo').setAttribute('capture', 'environment'); document.getElementById('plant-photo').click();"><i class="fa-solid fa-camera mr-1"></i> Camera</button>
                        </div>
                        <input type="file" id="plant-photo" accept="image/*" class="hidden" onchange="document.getElementById('plant-photo-name').innerHTML = this.files[0] ? '<i class=\'fa-solid fa-check text-green-500 mr-1\'></i> ' + this.files[0].name : ''">
                        <p id="plant-photo-name" class="text-xs font-bold text-gray-600 dark:text-gray-400 truncate mb-1"></p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button id="save-plant-btn" class="btn-primary flex-1">Save Plant</button>
                    <button id="delete-plant-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="wishlist-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade border-purple-500 border-2">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500" onclick="toggleDisplay(document.getElementById('wishlist-modal'), false)">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-purple-600">Add to Wishlist</h2>
            <input type="hidden" id="wish-id">
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold">Plant Name</label>
                    <input type="text" id="wish-name" class="input-std" placeholder="e.g. Variegated Monstera">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold">Species</label>
                        <input type="text" id="wish-species" class="input-std">
                    </div>
                    <div>
                        <label class="text-sm font-bold">Est. Price</label>
                        <input type="number" id="wish-price" class="input-std" placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold">Priority</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="wish-priority" value="high" class="peer sr-only">
                            <div class="p-2 rounded border text-center peer-checked:bg-red-500 peer-checked:text-white transition">High üî•</div>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="wish-priority" value="medium" class="peer sr-only" checked>
                            <div class="p-2 rounded border text-center peer-checked:bg-yellow-500 peer-checked:text-white transition">Med üòê</div>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="wish-priority" value="low" class="peer sr-only">
                            <div class="p-2 rounded border text-center peer-checked:bg-green-500 peer-checked:text-white transition">Low üßä</div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold">Notes / Link</label>
                    <textarea id="wish-notes" rows="2" class="input-std" placeholder="Where to buy?"></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="saveWish()" class="btn-primary bg-purple-600 hover:bg-purple-700 flex-1">Save Wish</button>
                    <button id="delete-wish-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="plant-tasks-modal" class="modal-overlay hidden" style="display: none; z-index: 75;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="document.getElementById('plant-tasks-modal').style.display='none'">&times;</button>
            <h2 class="text-2xl font-bold mb-1 flex items-center gap-2 text-blue-600 dark:text-blue-400">
                <i class="fa-solid fa-calculator"></i> Task Forecast
            </h2>
            <p id="tasks-modal-subtitle" class="text-sm font-bold opacity-70 mb-4"></p>
            
            <div id="plant-tasks-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 hide-scrollbar">
                </div>
        </div>
    </div>

    <div id="snooze-modal" class="modal-overlay hidden" style="display: none;">
        <div class="modal-content animate-fade max-w-sm">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="document.getElementById('snooze-modal').style.display='none'">&times;</button>
            <h2 class="text-xl font-bold mb-2">Snooze Plant</h2>
            <p class="text-sm opacity-70 mb-6">How long should we wait before reminding you again?</p>
            <input type="hidden" id="snooze-plant-target">
            
            <div class="space-y-3">
                <button class="w-full btn-secondary text-left p-3 flex justify-between" onclick="applySnooze(1)">
                    <span>Tomorrow (1 Day)</span> <i class="fa-solid fa-sun opacity-50"></i>
                </button>
                <button class="w-full btn-secondary text-left p-3 flex justify-between" onclick="applySnooze(2)">
                    <span>Short Break (2 Days)</span> <i class="fa-solid fa-coffee opacity-50"></i>
                </button>
                <button class="w-full btn-secondary text-left p-3 flex justify-between" onclick="applySnooze(7)">
                    <span>Next Week (7 Days)</span> <i class="fa-solid fa-calendar-week opacity-50"></i>
                </button>
                <div class="flex gap-2">
                    <input type="number" id="snooze-custom-val" class="input-std" placeholder="Custom days">
                    <button class="btn-primary whitespace-nowrap" onclick="applySnooze(document.getElementById('snooze-custom-val').value)">Set</button>
                </div>
            </div>
        </div>
    </div>

    <div id="photo-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closePhotoModal()">
        <button class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 focus:outline-none">&times;</button>
        <img id="photo-modal-img" src="" class="max-h-[90vh] max-w-[95vw] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
    </div>

    <div id="lawn-modal" class="modal-overlay hidden" style="display: none; z-index: 60;">
        <div class="modal-content animate-fade max-w-sm">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="document.getElementById('lawn-modal').style.display='none'">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-[var(--primary)]"><i class="fa-solid fa-scissors"></i> Lawn Care</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold">Mowing Frequency (Days)</label>
                    <input type="number" id="lawn-freq" class="input-std" placeholder="e.g. 7" value="7">
                    <p class="text-xs opacity-60 mt-1">How often should you cut the grass?</p>
                </div>
                <button onclick="window.logLawnCut()" class="btn-primary w-full bg-green-600 hover:bg-green-700">
                    <i class="fa-solid fa-check mr-2"></i> Log Cut Today
                </button>
                <button onclick="window.saveLawnSettings()" class="btn-secondary w-full">
                    Just Save Settings
                </button>
            </div>
        </div>
    </div>

    <div id="api-search-modal" class="modal-overlay hidden" style="display: none; z-index: 70;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="document.getElementById('api-search-modal').style.display='none'">&times;</button>
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-book-open"></i> Plant Database</h2>
            
            <div class="space-y-3 mb-4">
                <div class="flex gap-2">
                    <select id="api-choice" class="input-std flex-1">
                        <option value="growstuff">Growstuff (Free)</option>
                        <option value="perenual">Perenual (Needs Key)</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="api-search-query" class="input-std flex-grow" placeholder="Search plant name...">
                    <button onclick="window.searchPlantApi()" class="btn-primary whitespace-nowrap"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
            </div>
            <div id="api-search-results" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                <p class="text-sm opacity-60 text-center py-4">Search for advice, sunlight, and watering tips!</p>
            </div>
        </div>
    </div>

    <button onclick="window.openQuickLogModal()" class="fixed bottom-20 right-6 md:bottom-8 md:right-8 z-40 bg-[var(--primary)] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform">
        <i class="fa-solid fa-pen"></i>
    </button>

    <div id="quick-log-modal" class="modal-overlay hidden" style="display: none; z-index: 65;">
        <div class="modal-content animate-fade">
            <button class="absolute top-4 right-4 text-2xl hover:text-red-500 close-modal-btn" onclick="document.getElementById('quick-log-modal').style.display='none'">&times;</button>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square text-[var(--primary)]"></i> Quick Log Care
            </h2>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold mb-1">Select Plant</label>
                    <select id="log-plant-select" class="input-std text-sm"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold mb-1">Action</label>
                        <select id="log-type-select" class="input-std text-sm">
                            <option value="Water">Watering</option>
                            <option value="Mist">Misting üí¶</option>
                            <option value="Fertilize">Fertilizing</option>
                            <option value="Prune">Pruning ‚úÇÔ∏è</option>
                            <option value="Repot">Repotting ü™¥</option>
                            <option value="Pest Control">Pest Control üêõ</option>
                            <option value="Overwinter">Overwinter Prep ‚ùÑÔ∏è</option>
                            <option value="Note">Note / Observation</option>
                            <option value="Progress">Progress Update üì∏</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">Date</label>
                        <input type="datetime-local" id="log-date" class="input-std text-sm">
                    </div>
                </div>
                <div id="log-progress-extras" class="hidden space-y-3 mt-3 p-3 border rounded bg-gray-50 dark:bg-gray-800/50">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold mb-1">Size (cm)</label><input type="number" id="log-growth-val" class="input-std text-sm"></div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Health</label>
                            <select id="log-health-select" class="input-std text-sm">
                                <option value="excellent">Excellent üåü</option>
                                <option value="good" selected>Good üåø</option>
                                <option value="bad">Bad üìâ</option>
                                <option value="sick-pests">Sick - Pests üêõ</option>
                                <option value="sick-wilty">Sick - Wilty ü•Ä</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">Tags</label>
                        <div class="flex flex-wrap gap-1.5" id="log-noticing-tags">
                            <label class="cursor-pointer"><input type="checkbox" value="New Leaves" class="peer sr-only"><span class="px-2 py-0.5 text-[10px] border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">New Leaves</span></label>
                            <label class="cursor-pointer"><input type="checkbox" value="New Shoots" class="peer sr-only"><span class="px-2 py-0.5 text-[10px] border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">New Shoots</span></label>
                            <label class="cursor-pointer"><input type="checkbox" value="Flowers" class="peer sr-only"><span class="px-2 py-0.5 text-[10px] border border-[var(--border)] rounded-full peer-checked:bg-[var(--primary)] peer-checked:text-white transition">Flowers</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">Photo</label>
                        <input type="file" id="log-photo" accept="image/*" class="text-xs">
                        <p id="log-photo-name" class="text-xs font-bold text-[var(--primary)] mt-1 truncate"></p>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1">Notes</label>
                    <textarea id="log-notes" rows="2" class="input-std text-sm"></textarea>
                </div>
                <button id="submit-log-btn" class="btn-primary w-full py-2 text-sm mt-2">
                    <i class="fa-solid fa-check mr-2"></i> Save Log
                </button>
            </div>
        </div>
    </div>



    <div id="message-box" class="message-box"></div>
    <script type="module">
        import { changelogData } from '../changelog-data.js'; 
        import { AppNavigation } from '../shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp, doc, deleteDoc, updateDoc, query, orderBy, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        if (localStorage.getItem('theme') === 'dark' || 
           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // Update the state object to include lawn, apiKeys, location, and weather:
        const state = {
            user: null, plants: [], logs: [], structures: [], wishlist: [], locations: [],
            lawn: null, apiKeys: null, location: null, weather: null, // <-- NEW FIELDS
            unsubPlants: null, unsubLogs: null, unsubStructs: null, unsubWish: null, unsubLocs: null,
            nav: null, themeUnsubscribe: null 
        };
        
        // Fetch weather data for the dashboard using Open-Meteo
        const fetchWeather = async () => {
            if (!state.location || !state.location.latitude || !state.location.longitude) return;
            try {
                // Added hourly metrics to the API URL
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${state.location.latitude}&longitude=${state.location.longitude}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max,wind_speed_10m_max,precipitation_probability_max&hourly=temperature_2m,precipitation_probability&timezone=auto`);
                if (!res.ok) throw new Error("API request failed");
                const data = await res.json();
                if (data.error) throw new Error(data.reason);
                
                state.weather = data.daily;
                state.weatherHourly = data.hourly; // Save the hourly array
                renderDashboard();
            } catch (e) {
                console.error("Failed to fetch weather", e);
                state.weather = { error: true, message: e.message }; 
                renderDashboard();
            }
        };

        // 1. Add this globally accessible function anywhere before onAuthStateChanged
        window.openQuickLogModal = (plantId = null) => {
            const modal = document.getElementById('quick-log-modal');
            const select = document.getElementById('log-plant-select');
            if (plantId) {
                select.value = plantId;
            }
            // If they are on the garden tab and no plant is passed, default to empty
            toggleDisplay(modal, true);
        };

        // 2. Locate your getEl("submit-log-btn").onclick function inside onAuthStateChanged.
        // Add this line inside the try block, right after showMsg("Log saved successfully!", ...):
        

        const getLatestPlantPhoto = (plant) => {
            if (!plant) return null;
            const plantLogs = state.logs.filter(l => l.plantId === plant.id && l.photoUrl);
            let latestLogPhotoUrl = null;
            let latestLogTime = 0;
            if (plantLogs.length > 0) {
                latestLogPhotoUrl = plantLogs[0].photoUrl; // Logs are already sorted desc
                latestLogTime = new Date(plantLogs[0].date).getTime();
            }
            
            // SAFELY parse updatedAt
            let plantUpdateTime = 0;
            if (plant.updatedAt) {
                plantUpdateTime = typeof plant.updatedAt.toDate === 'function' 
                    ? plant.updatedAt.toDate().getTime() 
                    : new Date(plant.updatedAt).getTime();
            }
            
            if (latestLogPhotoUrl && latestLogTime > plantUpdateTime) return latestLogPhotoUrl;
            return plant.photoUrl || latestLogPhotoUrl || null;
        };
        
        const getEl = (id) => document.getElementById(id);

        // Use this flag to track if user hit "Remove" on plant edit
        let plantPhotoRemoved = false;
        getEl("remove-plant-photo-btn").onclick = () => {
            plantPhotoRemoved = true;
            getEl("current-plant-photo-container").classList.add("hidden");
            getEl("plant-photo-name").innerHTML = "<i class='fa-solid fa-trash text-red-500 mr-1'></i> Photo will be removed on save";
        };
        
        let msgTimeout;
        const showMsg = (msg, type = "success", duration = 3000) => {
            const box = getEl("message-box");
            box.textContent = msg;
            box.className = `message-box show ${type === 'error' ? 'bg-red-500' : 'bg-[var(--primary)]'}`;
            clearTimeout(msgTimeout);
            if (duration > 0) {
                msgTimeout = setTimeout(() => box.classList.remove("show"), duration);
            }
        };

        window.toggleDisplay = (el, show) => {
            if (show) { el.classList.remove('hidden'); el.style.display = ''; } 
            else { el.classList.add('hidden'); el.style.display = 'none'; }
        };
        const toggleDisplay = window.toggleDisplay; // Keeps internal JS calls working too

        const compressImage = (file, maxWidth = 1200) => {
            return new Promise((resolve) => {
                if (!file || !file.type.match(/image.*/)) return resolve(file);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const ratio = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
                        if (ratio >= 1) return resolve(file);
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })), 'image/jpeg', 0.8);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        const lightIcons = { low: 'fa-cloud', medium: 'fa-cloud-sun', high: 'fa-sun' };
        const lightColors = { low: 'text-gray-400', medium: 'text-yellow-400', high: 'text-orange-500' };

        const updateLocationDropdowns = () => {
            const locs = state.locations;
            const legacyLocs = [...new Set(state.plants.map(p => p.location).filter(Boolean))]
                .filter(val => !locs.find(l => l.id === val));

            const populate = (selectEl, defaultOpt, currentVal) => {
                if(!selectEl) return;
                selectEl.innerHTML = defaultOpt;
                locs.forEach(l => { selectEl.innerHTML += `<option value="${l.id}">${l.name}</option>`; });
                legacyLocs.forEach(val => { selectEl.innerHTML += `<option value="${val}">${val} (Legacy)</option>`; });
                if (currentVal && (locs.find(l=>l.id===currentVal) || legacyLocs.includes(currentVal))) {
                    selectEl.value = currentVal;
                }
            };

            populate(getEl("plant-filter-location"), '<option value="all">All Locations</option>', getEl("plant-filter-location").value);
            populate(getEl("layout-location-select"), '<option value="">-- Select Room --</option>', getEl("layout-location-select").value);
            populate(getEl("plant-location"), '<option value="">-- Select --</option>', getEl("plant-location").value);
            populate(getEl("history-filter-location"), '<option value="all">All Locations</option>', getEl("history-filter-location").value);
        };
        const renderLocations = () => {
            const list = getEl("locations-list-container");
            if (!list) return;
            list.innerHTML = "";

            if(state.locations.length === 0) {
                list.innerHTML = `<p class="col-span-3 text-center opacity-50 py-8">No locations defined. Create one to organize your plants!</p>`;
                return;
            }

            state.locations.forEach(loc => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between hover:shadow-lg transition relative";
                
                const typeIcons = {
                    inside: 'fa-house', outside: 'fa-sun', germinator: 'fa-seedling', patio: 'fa-chair', greenhouse: 'fa-tent'
                };
                const icon = typeIcons[loc.type] || 'fa-map-pin';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="plant-icon-circle bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">${loc.name}</h3>
                                <p class="text-xs opacity-70 uppercase tracking-wider">${loc.type}</p>
                            </div>
                        </div>
                        <button onclick="openLocationModal('${loc.id}')" class="text-gray-400 hover:text-[var(--primary)]">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm opacity-80 mt-2">
                        <div title="Light"><i class="fa-solid fa-lightbulb w-4 text-yellow-500"></i> ${loc.light}</div>
                        <div title="Humidity"><i class="fa-solid fa-droplet w-4 text-blue-400"></i> ${loc.humidity}</div>
                        ${loc.tempSummer ? `<div title="Summer Temp"><i class="fa-solid fa-temperature-full w-4 text-red-400"></i> ${loc.tempSummer}¬∞C (S)</div>` : ''}
                        ${loc.tempWinter ? `<div title="Winter Temp"><i class="fa-solid fa-temperature-empty w-4 text-blue-300"></i> ${loc.tempWinter}¬∞C (W)</div>` : ''}
                        <div title="Draft" class="col-span-2"><i class="fa-solid fa-wind w-4 text-gray-400"></i> Draft: ${loc.draft}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        };

        const renderPlants = () => {
            const list = getEl("plants-list-container");
            const select = getEl("log-plant-select");
            const filterLoc = getEl("plant-filter-location");
            
            select.innerHTML = "<option value=''>-- Select Plant --</option>";
            
            const histPlantSelect = getEl("history-filter-plant");
            let histCurVal = "all";
            if (histPlantSelect) {
                histCurVal = histPlantSelect.value;
                histPlantSelect.innerHTML = '<option value="all">All Plants</option>';
            }

            state.plants.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id; opt.textContent = p.name;
                select.appendChild(opt);
                
                if (histPlantSelect) {
                    histPlantSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                }
            });
            if (histPlantSelect) histPlantSelect.value = histCurVal;

            let displayPlants = state.plants.filter(p => p.status !== 'dead');
            if (filterLoc.value && filterLoc.value !== 'all') {
                displayPlants = displayPlants.filter(p => p.location === filterLoc.value);
            }

            list.innerHTML = displayPlants.length ? '' : `<p class="opacity-50 text-center col-span-3 py-8">No plants found.</p>`;

            displayPlants.forEach(plant => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between h-full hover:shadow-lg transition";
                
                const locObj = state.locations.find(l => l.id === plant.location);
                const displayLocation = locObj ? locObj.name : (plant.location || 'No location');
                
                // Inherit light from location if plant doesn't explicitly have it set
                const finalLight = plant.light || (locObj ? locObj.light : null);
                const inheritedBadge = (!plant.light && finalLight) ? '<span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1 rounded ml-1">Inherited</span>' : '';

                // SAFELY calculate snooze HTML
                let snoozeHtml = '';
                if (plant.snoozeUntil) {
                    const snoozeDate = typeof plant.snoozeUntil.toDate === 'function' 
                        ? plant.snoozeUntil.toDate() 
                        : new Date(plant.snoozeUntil);
                    
                    if (snoozeDate > new Date()) {
                        snoozeHtml = `
                        <div class="inline-flex items-center gap-1 px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs font-bold mt-1">
                            <i class="fa-solid fa-clock"></i> Snoozed
                            <button class="ml-2 hover:text-red-600 unsnooze-btn" data-id="${plant.id}" title="Undo Snooze">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>`;
                    }
                }

let potBadge = '';
if (plant.potType || plant.potSize) {
    const pType = plant.potType === 'terracotta' ? 'üè∫ Terracotta' : 
                  plant.potType === 'ceramic' ? 'ü™¥ Ceramic' : 
                  plant.potType === 'ground' ? 'üåç In Ground' : 'ü™£ Plastic';
                  
    const pSize = (plant.potSize && plant.potType !== 'ground') ? ` ${plant.potSize}cm` : '';
    potBadge = `<span class="text-[10px] bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200 px-1.5 py-0.5 rounded ml-2">${pType}${pSize}</span>`;
}

card.innerHTML = `
    <div class="flex items-start justify-between mb-4">
        <div class="flex items-center gap-3 cursor-pointer hover:opacity-70 transition" onclick="window.openQuickLogModal('${plant.id}')" title="Quick Log">
            ${getLatestPlantPhoto(plant) 
            ? `<img src="${getLatestPlantPhoto(plant)}" class="w-12 h-12 rounded-full object-cover border border-[var(--border)]">` 
            : `<div class="plant-icon-circle"><i class="fa-solid ${plant.icon || 'fa-leaf'}"></i></div>`
            }
            <div>
                <h3 class="font-bold text-lg leading-tight">${plant.name}</h3>
                <p class="text-xs opacity-70">${plant.species || 'Unknown'}</p>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button class="text-blue-400 hover:text-blue-600 transition" onclick="window.openPlantTasksModal('${plant.id}')" title="View Forecast & Calculations"><i class="fa-solid fa-calculator"></i></button>
            <button class="text-gray-400 hover:text-[var(--primary)] edit-plant-btn" data-id="${plant.id}"><i class="fa-solid fa-pen"></i></button>
        </div>
    </div>
    
    <div class="space-y-2 mb-4 flex-grow">
        <div class="flex items-center gap-2 text-sm font-semibold">
            <i class="fa-solid fa-location-dot w-4 text-gray-400"></i> ${displayLocation}
            ${potBadge}
        </div>
        
        <div class="flex items-center gap-2 text-xs opacity-70 ml-6">
            ${finalLight ? `<i class="fa-solid fa-sun text-yellow-500"></i> <span class="capitalize">${finalLight}</span> ${inheritedBadge}` : '<span>No light info</span>'}
        </div>

        ${plant.waterFreq ? `<div class="flex items-center gap-2 text-sm text-blue-500 mt-2"><i class="fa-solid fa-droplet w-4"></i> Base: ${plant.waterFreq}d <span class="opacity-50 text-xs">(Auto-adjusts for weather/pots)</span></div>` : ''}
        ${snoozeHtml}
    </div>

    <div class="grid grid-cols-2 gap-2 mt-auto">
        <button class="btn-secondary text-sm quick-water-btn" data-id="${plant.id}"><i class="fa-solid fa-droplet text-blue-500"></i> Water</button>
        <button class="btn-secondary text-sm" onclick="window.openQuickLogModal('${plant.id}')"><i class="fa-solid fa-plus text-green-500"></i> Log</button>
    </div>
`;
                list.appendChild(card);
            });

            document.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
            document.querySelectorAll(".quick-water-btn").forEach(b => b.onclick = (e) => quickWater(e.currentTarget.dataset.id));
            document.querySelectorAll(".unsnooze-btn").forEach(b => b.onclick = (e) => unsnoozePlant(e.currentTarget.dataset.id));
        };

        window.toggleSpacesView = (view) => {
    const isList = view === 'list';
    
    getEl("btn-space-list").className = isList ? "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all" : "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all";
    getEl("btn-space-map").className = !isList ? "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all" : "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all";
    
    toggleDisplay(getEl("spaces-list-wrapper"), isList);
    toggleDisplay(getEl("spaces-map-wrapper"), !isList);
    toggleDisplay(getEl("btn-add-location"), isList);
};


        const renderGraveyard = () => {
            const list = getEl("graveyard-container");
            if (!list) return;
            list.innerHTML = "";

            const deadPlants = state.plants.filter(p => p.status === 'dead');

            if(deadPlants.length === 0) {
                list.innerHTML = `<p class="col-span-3 text-center opacity-50 py-8">No casualties yet! Keep up the good work. ü™¥</p>`;
                return;
            }

            deadPlants.forEach(plant => {
                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col grayscale opacity-80 hover:grayscale-0 hover:opacity-100 transition";
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <div class="plant-icon-circle bg-gray-200 text-gray-500"><i class="fa-solid fa-skull"></i></div>
                            <div>
                                <h3 class="font-bold text-lg line-through decoration-2">${plant.name}</h3>
                                <p class="text-xs opacity-70">${plant.species || 'Unknown'}</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-[var(--primary)] edit-plant-btn" data-id="${plant.id}"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    ${plant.background ? `<p class="text-sm italic mt-2 opacity-80 border-l-2 pl-2 border-gray-400">" ${plant.background} "</p>` : ''}
                    <p class="text-xs opacity-50 mt-4 text-right">RIP</p>
                `;
                list.appendChild(card);
            });

            // Make sure graveyard items can be edited/resurrected
            list.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
        };


window.toggleGardenView = (view) => {
    const views = ['active', 'wishlist', 'graveyard'];
    views.forEach(v => {
        const btn = getEl(`btn-view-${v}`);
        if (v === view) {
            btn.className = "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all whitespace-nowrap";
        } else {
            btn.className = "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all whitespace-nowrap";
        }
    });

    toggleDisplay(getEl("plants-list-container"), view === 'active');
    toggleDisplay(getEl("wishlist-wrapper"), view === 'wishlist');
    toggleDisplay(getEl("graveyard-wrapper"), view === 'graveyard');
    
    // Toggle primary action buttons
    toggleDisplay(getEl("open-add-plant-modal"), view !== 'wishlist');
    toggleDisplay(getEl("open-add-wish-modal"), view === 'wishlist');
    toggleDisplay(getEl("plant-filter-location"), view === 'active');
};

        const renderDashboard = () => {
            const weatherBanner = getEl("dashboard-weather-banner");
            const combinedCareList = getEl("dashboard-care-combined-list");
            const hospitalSection = getEl("dashboard-hospital-section");
            const hospitalList = getEl("dashboard-hospital-list");
            const upcomingList = getEl("dashboard-upcoming-list");
            const recentList = getEl("dashboard-recent-list");

            // Build Weather Banner
            if (state.location && state.location.latitude) {
                if (state.weather && state.weather.temperature_2m_min) {
                    const minTemp = state.weather.temperature_2m_min[0];
                    const maxTemp = state.weather.temperature_2m_max[0];
                    const rain = state.weather.precipitation_sum[0];
                    
                    const uv = state.weather.uv_index_max ? state.weather.uv_index_max[0] : 0;
                    const wind = state.weather.wind_speed_10m_max ? state.weather.wind_speed_10m_max[0] : 0;
                    
                    const uvText = uv <= 2 ? `Low UV (${uv})` : uv <= 5 ? `Mod UV (${uv})` : uv <= 7 ? `High UV ‚ö†Ô∏è (${uv})` : `Extreme UV üõë (${uv})`;
                    const uvColor = uv <= 5 ? 'text-green-600 dark:text-green-400' : uv <= 7 ? 'text-orange-500' : 'text-red-500';

                    const windText = wind < 15 ? `Calm üçÉ (${wind} km/h)` : wind < 30 ? `Breezy üí® (${wind} km/h)` : `Strong Winds ‚ö†Ô∏è (${wind} km/h)`;
                    const windColor = wind < 30 ? 'text-gray-600 dark:text-gray-400' : 'text-orange-500';

                    const tempText = maxTemp < 10 ? `Cold ‚ùÑÔ∏è (${maxTemp}¬∞C)` : maxTemp < 20 ? `Mild üå§Ô∏è (${maxTemp}¬∞C)` : maxTemp < 30 ? `Warm ‚òÄÔ∏è (${maxTemp}¬∞C)` : `Hot üî• (${maxTemp}¬∞C)`;
                    const tempColor = maxTemp < 10 ? 'text-blue-500' : maxTemp < 30 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-500';

                    let hourlyHtml = '';
                    if (state.weatherHourly && state.weatherHourly.time) {
                        const now = new Date();
                        let startIndex = state.weatherHourly.time.findIndex(t => new Date(t).getTime() > now.getTime()) - 1;
                        if (startIndex < 0) startIndex = 0;
                        
                        const nextHours = state.weatherHourly.time.slice(startIndex, startIndex + 5).map((t, i) => {
                            const idx = startIndex + i;
                            const timeDate = new Date(t);
                            const timeLabel = i === 0 ? 'Now' : timeDate.toLocaleTimeString('en-US', {hour: 'numeric', hour12: true}); 
                            const temp = state.weatherHourly.temperature_2m[idx];
                            const precip = state.weatherHourly.precipitation_probability[idx];
                            
                            return `
                                <div class="flex flex-col items-center justify-center p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-blue-100 dark:border-blue-800/50 min-w-[65px] flex-1">
                                    <span class="text-[10px] uppercase font-bold opacity-70 mb-1 whitespace-nowrap">${timeLabel}</span>
                                    <span class="text-sm font-bold">${Math.round(temp)}¬∞</span>
                                    <span class="text-[10px] text-cyan-500 mt-1 font-bold flex items-center gap-1"><i class="fa-solid fa-droplet"></i> ${precip}%</span>
                                </div>
                            `;
                        }).join('');
                        hourlyHtml = `<div class="flex gap-2 mt-4 md:mt-0 overflow-x-auto pb-1 w-full hide-scrollbar">${nextHours}</div>`;
                    }
                    
                    weatherBanner.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 dark:bg-blue-900/20 dark:border-blue-800 rounded-lg p-4 shadow-sm">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <i class="fa-solid ${rain > 0 ? 'fa-cloud-rain' : 'fa-cloud-sun'} text-4xl text-blue-500"></i>
                                        <div>
                                            <h3 class="font-bold text-lg text-blue-800 dark:text-blue-300">${state.location.name || 'Saved Location'}</h3>
                                            <div class="flex items-center gap-3 text-sm font-semibold text-blue-900 dark:text-blue-200">
                                                <span title="High Temp"><i class="fa-solid fa-arrow-up text-red-400"></i> ${maxTemp}¬∞C</span>
                                                <span title="Low Temp"><i class="fa-solid fa-arrow-down text-blue-400"></i> ${minTemp}¬∞C</span>
                                                <span title="Total Rain"><i class="fa-solid fa-droplet text-cyan-500"></i> ${rain}mm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2 mt-3">
                                        <span class="px-2.5 py-1 bg-white dark:bg-gray-800 border border-blue-100 dark:border-blue-800/50 rounded-full text-[10px] font-bold shadow-sm ${tempColor}">${tempText}</span>
                                        <span class="px-2.5 py-1 bg-white dark:bg-gray-800 border border-blue-100 dark:border-blue-800/50 rounded-full text-[10px] font-bold shadow-sm ${uvColor}">${uvText}</span>
                                        <span class="px-2.5 py-1 bg-white dark:bg-gray-800 border border-blue-100 dark:border-blue-800/50 rounded-full text-[10px] font-bold shadow-sm ${windColor}">${windText}</span>
                                    </div>
                                </div>
                                <div class="w-full md:w-auto md:max-w-[50%]">${hourlyHtml}</div>
                            </div>
                        </div>
                    `;
                    toggleDisplay(weatherBanner, true);
                } else if (state.weather && state.weather.error) {
                    weatherBanner.innerHTML = `<div class="p-4 text-sm text-red-500 bg-red-50 dark:bg-red-900/20 rounded-lg flex items-center gap-2 border border-red-200 dark:border-red-800"><i class="fa-solid fa-triangle-exclamation"></i> Error loading weather: ${state.weather.message}</div>`;
                    toggleDisplay(weatherBanner, true);
                } else {
                    weatherBanner.innerHTML = `<div class="p-4 text-sm opacity-60 flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> Fetching daily overview...</div>`;
                    toggleDisplay(weatherBanner, true);
                }
            } else {
                toggleDisplay(weatherBanner, false);
            }

            if (combinedCareList) combinedCareList.innerHTML = "";
            hospitalList.innerHTML = "";
            upcomingList.innerHTML = "";
            recentList.innerHTML = "";

            let careItemsCount = 0;
            const now = new Date();
            const upcomingTasks = [];
            let hasSickPlants = false;

            state.plants.filter(p => p.status !== 'dead').forEach(plant => {
                const isSick = plant.health && (plant.health.startsWith('sick') || plant.health === 'bad');
                if (isSick) hasSickPlants = true;

                const plantLogs = state.logs.filter(l => l.plantId === plant.id);
                const lastWater = plantLogs.find(l => l.type === 'Water');
                const lastFert = plantLogs.find(l => l.type === 'Fertilize');

                if (plant.waterFreq) {
                    // SAFELY parse snooze date
                    let isSnoozed = false;
                    let snoozeDate = null;
                    if (plant.snoozeUntil) {
                        snoozeDate = typeof plant.snoozeUntil.toDate === 'function' 
                            ? plant.snoozeUntil.toDate() 
                            : new Date(plant.snoozeUntil);
                        isSnoozed = snoozeDate > now;
                    }

                    let freq = plant.waterFreq;

// 1. Seasonality
if (state.winterMode) freq = Math.ceil(freq * 1.5);

// 2. Pot Modifiers
if (plant.potType === 'terracotta') {
    freq = Math.ceil(freq * 0.8); // Terracotta breathes
} else if (plant.potType === 'ground') {
    freq += 3; // Ground retains moisture much longer
}

// Only apply pot size math if it's actually in a pot
if (plant.potType !== 'ground' && plant.potSize) {
    if (plant.potSize <= 10) freq -= 1;
    if (plant.potSize >= 25) freq += 2;
}

// 3. Environmental Modifiers (Sunlight & Humidity)
const locObj = state.locations.find(l => l.id === plant.location);
const finalLight = plant.light || (locObj ? locObj.light : 'medium');
const finalHumidity = locObj ? locObj.humidity : 'medium';

if (finalLight === 'high') freq -= 1; // Direct sun dries soil faster
if (finalLight === 'low') freq += 1;  // Shadow keeps soil wet longer
if (finalHumidity === 'high') freq += 1; // Humid air slows evaporation
if (finalHumidity === 'low') freq -= 1;  // Dry air speeds up evaporation

// Ensure it never goes below 1 day
freq = Math.max(1, freq);

// 4. Rain Delay Logic
let rainDelayed = false;
if (locObj && (locObj.type === 'outside' || locObj.type === 'patio' || locObj.type === 'greenhouse')) {
    if (state.weather && state.weather.precipitation_sum && state.weather.precipitation_sum[0] > 1) {
        freq += 2; 
        rainDelayed = true;
    }
}

                    if (isSnoozed) {
                        const diffMs = snoozeDate - now;
                        const daysUntil = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= 7) {
                            upcomingTasks.push({
                                plant: plant, type: 'Snooze Ends (Water)', daysUntil: daysUntil,
                                date: snoozeDate, icon: 'fa-clock', color: 'text-yellow-600', bg: 'bg-yellow-100 dark:bg-yellow-900'
                            });
                        }
                    } else {
                        const lastDate = lastWater ? new Date(lastWater.date) : new Date(plant.acquired || 0);
                        const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                        const daysOverdue = Math.floor(diffDays - freq);

                        if (daysOverdue >= 0) {
                            if (!isSick) {
                                careItemsCount++;
                                const div = document.createElement("div");
                                div.className = "flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-2.5 rounded-lg border border-blue-100 dark:border-blue-800";
                                
                                const latestPhoto = getLatestPlantPhoto(plant);
                                const imgHtml = latestPhoto 
                                    ? `<img src="${latestPhoto}" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200">`
                                    : `<div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-800 flex items-center justify-center mr-3 text-blue-500 dark:text-blue-300"><i class="fa-solid ${plant.icon || 'fa-droplet'}"></i></div>`;

                                div.innerHTML = `
                                    <div class="flex items-center cursor-pointer hover:opacity-70 transition" onclick="window.openQuickLogModal('${plant.id}')" title="Quick Log">
                                        ${imgHtml}
                                        <div>
                                            <p class="font-bold text-sm">${plant.name} <span class="text-xs font-normal opacity-70 ml-1">needs water</span></p>
                                            <p class="text-xs text-red-500 font-bold">${daysOverdue === 0 ? 'Due Today' : `${daysOverdue} days late`} ${rainDelayed ? 'üåßÔ∏è (Rain Delayed)' : ''}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button class="btn-secondary p-1.5 rounded text-xs" onclick="openSnoozeModal('${plant.id}')" title="Snooze"><i class="fa-solid fa-clock text-yellow-500"></i></button>
                                        <button class="btn-primary p-1.5 rounded text-xs quick-water-btn" data-id="${plant.id}"><i class="fa-solid fa-check"></i></button>
                                    </div>
                                `;
                                if (combinedCareList) combinedCareList.appendChild(div);
                            }
                        } else if (daysOverdue >= -7) {
                            const daysUntil = Math.abs(daysOverdue);
                            const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                            upcomingTasks.push({ plant, type: 'Water', daysUntil, date: dueDate, icon: 'fa-droplet', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900' });
                        }
                    }
                }

                if (plant.fertFreq) {
                    const lastDate = lastFert ? new Date(lastFert.date) : new Date(plant.acquired || 0);
                    const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                    const daysOverdue = Math.floor(diffDays - plant.fertFreq);

                    if (daysOverdue >= 0) {
                        if (!isSick) {
                            careItemsCount++;
                            const div = document.createElement("div");
                            div.className = "flex justify-between items-center bg-orange-50 dark:bg-orange-900/20 p-2.5 rounded-lg border border-orange-100 dark:border-orange-800";
                            
                            const latestPhoto = getLatestPlantPhoto(plant);
                            const imgHtml = latestPhoto 
                                ? `<img src="${latestPhoto}" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200">`
                                : `<div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-800 flex items-center justify-center mr-3 text-orange-500 dark:text-orange-300"><i class="fa-solid ${plant.icon || 'fa-seedling'}"></i></div>`;

                            div.innerHTML = `
                                <div class="flex items-center cursor-pointer hover:opacity-70 transition" onclick="window.openQuickLogModal('${plant.id}')" title="Quick Log">
                                    ${imgHtml}
                                    <div>
                                        <p class="font-bold text-sm">${plant.name} <span class="text-xs font-normal opacity-70 ml-1">needs fertilizer</span></p>
                                        <p class="text-xs text-orange-500 font-bold">${daysOverdue} days overdue</p>
                                    </div>
                                </div>
                            `;
                            if (combinedCareList) combinedCareList.appendChild(div);
                        }
                    } else if (daysOverdue >= -7) {
                        const daysUntil = Math.abs(daysOverdue);
                        const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                        upcomingTasks.push({ plant, type: 'Fertilize', daysUntil, date: dueDate, icon: 'fa-seedling', color: 'text-orange-500', bg: 'bg-orange-100 dark:bg-orange-900' });
                    }
                }

                if (plant.progFreq) {
                    const lastProg = plantLogs.find(l => l.type === 'Progress' || l.type === 'Growth');
                    const lastDate = lastProg ? new Date(lastProg.date) : new Date(plant.acquired || 0);
                    const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                    const daysOverdue = Math.floor(diffDays - plant.progFreq);

                    if (daysOverdue >= -7) {
                        let daysUntil = -daysOverdue;
                        if (daysUntil < 0) daysUntil = 0; 
                        const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                        upcomingTasks.push({ plant, type: 'Update Progress üì∏', daysUntil, date: dueDate, icon: 'fa-camera', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900' });
                    }
                }

                const checkFreq = (freq, type, icon, color, bg) => {
                    if (!freq) return;
                    const lastLog = plantLogs.find(l => l.type === type);
                    const lastDate = lastLog ? new Date(lastLog.date) : new Date(plant.acquired || 0);
                    const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
                    const daysOverdue = Math.floor(diffDays - freq);

                    if (daysOverdue >= -7) {
                        let daysUntil = daysOverdue > 0 ? 0 : Math.abs(daysOverdue); 
                        const dueDate = new Date(); dueDate.setDate(dueDate.getDate() + daysUntil);
                        upcomingTasks.push({ plant, type, daysUntil, date: dueDate, icon, color, bg });
                    }
                };

                checkFreq(plant.mistFreq, 'Mist', 'fa-spray-can', 'text-cyan-500', 'bg-cyan-100 dark:bg-cyan-900');
                checkFreq(plant.pruneFreq, 'Prune', 'fa-scissors', 'text-green-700', 'bg-green-100 dark:bg-green-900');
                let repotDays = plant.repotFreq;
if (repotDays && plant.potSize && plant.potSize <= 12) {
    repotDays = Math.max(30, repotDays - 60); // Small pots get rootbound faster, reduce time by 2 months
}
checkFreq(repotDays, 'Repot', 'fa-bucket', 'text-amber-700', 'bg-amber-100 dark:bg-amber-900');

                if (plant.overwinter && (now.getMonth() === 9 || now.getMonth() === 10)) {
                    upcomingTasks.push({ plant, type: 'Needs Overwinter Prep ‚ùÑÔ∏è', daysUntil: 0, date: now, icon: 'fa-snowflake', color: 'text-blue-500', bg: 'bg-blue-50 dark:bg-blue-900' });
                }

                if (plant.weatherAlerts && plant.location && state.locations.find(l=>l.id===plant.location)?.type === 'outside') {
                    if (state.weather && state.weather.temperature_2m_min && state.weather.temperature_2m_min.length > 0) {
                        const minTemp = state.weather.temperature_2m_min[0];
                        const maxTemp = state.weather.temperature_2m_max[0];
                        const rain = state.weather.precipitation_sum[0];
                        
                        if (minTemp <= 4) {
                             upcomingTasks.push({ plant, type: `Frost Warning (${minTemp}¬∞C) ‚ùÑÔ∏è`, daysUntil: 0, date: now, icon: 'fa-snowflake', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900' });
                        } else if (maxTemp >= 35) {
                             upcomingTasks.push({ plant, type: `Heat Warning (${maxTemp}¬∞C) ‚òÄÔ∏è`, daysUntil: 0, date: now, icon: 'fa-sun', color: 'text-red-500', bg: 'bg-red-100 dark:bg-red-900' });
                        } else if (rain > 10) {
                             upcomingTasks.push({ plant, type: `Heavy Rain Expected (${rain}mm) üåßÔ∏è`, daysUntil: 0, date: now, icon: 'fa-cloud-rain', color: 'text-cyan-500', bg: 'bg-cyan-100 dark:bg-cyan-900' });
                        } else {
                            upcomingTasks.push({ plant, type: 'Weather Clear Today üå§Ô∏è', daysUntil: 0, date: now, icon: 'fa-cloud-sun', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900' });
                        }
                    }
                }

                if (isSick) {
                    const div = document.createElement("div");
                    div.className = `p-4 rounded-lg border ${plant.health === 'quarantine' ? 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800' : 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-800'}`;
                    
                    const latestPhoto = getLatestPlantPhoto(plant);
                    const imgHtml = latestPhoto ? `<img src="${latestPhoto}" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200">` : ``;

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center cursor-pointer hover:opacity-70 transition" onclick="window.openQuickLogModal('${plant.id}')" title="Quick Log">
                                ${imgHtml}
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid ${plant.health === 'quarantine' ? 'fa-ban text-red-500' : 'fa-notes-medical text-yellow-500'}"></i>
                                    <span class="font-bold">${plant.name}</span>
                                </div>
                            </div>
                            <button class="text-xs btn-secondary px-2 py-1 edit-plant-btn" data-id="${plant.id}">Edit</button>
                        </div>
                        <p class="text-xs opacity-70 italic mb-2">${plant.health === 'quarantine' ? 'In Isolation' : 'Under Observation'}</p>
                        <div class="flex gap-2">
                            <button class="flex-1 btn-secondary text-xs py-1 quick-water-btn" data-id="${plant.id}">Water</button>
                            <button class="flex-1 btn-secondary text-xs py-1" onclick="openSnoozeModal('${plant.id}')">Snooze</button>
                        </div>
                    `;
                    hospitalList.appendChild(div);
                }
            });

            // Process Lawn into Action Required
            if (state.lawn) {
                const lastCut = state.lawn.lastCut ? new Date(state.lawn.lastCut) : null;
                if (lastCut) {
                    const daysSince = Math.floor((new Date() - lastCut) / (1000 * 60 * 60 * 24));
                    const freq = state.lawn.cutFreq || 7;
                    if (daysSince >= freq) {
                        careItemsCount++;
                        const div = document.createElement("div");
                        div.className = "flex justify-between items-center bg-green-50 dark:bg-green-900/20 p-2.5 rounded-lg border border-green-100 dark:border-green-800";
                        div.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-800 flex items-center justify-center mr-3 text-green-600 dark:text-green-300"><i class="fa-solid fa-scissors"></i></div>
                                <div>
                                    <p class="font-bold text-sm">Lawn Care <span class="text-xs font-normal opacity-70 ml-1">needs cutting</span></p>
                                    <p class="text-xs text-green-600 font-bold">${daysSince - freq} days overdue</p>
                                </div>
                            </div>
                            <button onclick="window.openLawnModal()" class="btn-primary p-1.5 rounded text-xs"><i class="fa-solid fa-scissors"></i></button>
                        `;
                        if (combinedCareList) combinedCareList.appendChild(div);
                    }
                }
            }

            if (careItemsCount === 0 && combinedCareList) {
                combinedCareList.innerHTML = `<div class="text-center p-6 bg-[var(--input-bg)] rounded-lg text-green-600 flex flex-col items-center justify-center h-full"><i class="fa-solid fa-check-circle mb-2 text-3xl"></i><p class="text-sm font-bold">All caught up!</p><p class="text-xs opacity-70 mt-1">Your garden is looking great.</p></div>`;
            }

            toggleDisplay(hospitalSection, hasSickPlants);

            upcomingTasks.sort((a, b) => a.daysUntil - b.daysUntil);
            
            if (upcomingTasks.length === 0) {
                upcomingList.innerHTML = `<p class="text-center py-4 opacity-50 text-sm">No tasks for the next 7 days. Relax! üåø</p>`;
            } else {
                upcomingTasks.forEach(task => {
                    const row = document.createElement("div");
                    row.className = "flex items-center justify-between p-3 border-b border-[var(--border)] last:border-0 hover:bg-[var(--input-bg)] transition-colors rounded";
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${task.bg} flex items-center justify-center ${task.color}">
                                <i class="fa-solid ${task.icon}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm">${task.plant.name}</p>
                                <p class="text-xs opacity-70">${task.type}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-sm text-[var(--primary)]">
                                ${task.daysUntil <= 1 ? 'Tomorrow' : `In ${task.daysUntil} days`}
                            </p>
                            <p class="text-xs opacity-60">${task.date.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})}</p>
                        </div>
                    `;
                    upcomingList.appendChild(row);
                });
            }

            state.logs.slice(0, 6).forEach(log => {
                const plant = state.plants.find(p => p.id === log.plantId);
                const item = document.createElement("div");
                item.className = "card p-3 flex flex-col justify-center h-24";
                
                let iconHtml = plant && getLatestPlantPhoto(plant) 
                    ? `<img src="${getLatestPlantPhoto(plant)}" onclick="openPhotoModal(this.src)" class="w-8 h-8 rounded-full object-cover mr-2 border border-[var(--border)] cursor-zoom-in">`
                    : plant 
                    ? `<div class="w-8 h-8 rounded-full bg-[var(--input-bg)] flex items-center justify-center mr-2 text-[var(--primary)]"><i class="fa-solid ${plant.icon || 'fa-leaf'}"></i></div>`
                    : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-2"><i class="fa-solid fa-trash text-gray-400"></i></div>`;

                item.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-xs uppercase tracking-wider text-[var(--primary)]">${log.type}</span>
                        <span class="text-[10px] opacity-60">${new Date(log.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
                    </div>
                    <div class="flex items-center">
                        ${iconHtml}
                        <div class="overflow-hidden">
                            <p class="font-bold text-sm truncate">${plant ? plant.name : 'Deleted Plant'}</p>
                            ${log.notes ? `<p class="text-xs italic opacity-70 truncate">"${log.notes}"</p>` : ''}
                        </div>
                    </div>
                `;
                recentList.appendChild(item);
            });

            document.querySelectorAll(".quick-water-btn").forEach(b => b.onclick = (e) => quickWater(e.currentTarget.dataset.id));
            document.querySelectorAll(".edit-plant-btn").forEach(b => b.onclick = (e) => openPlantModal(e.currentTarget.dataset.id));
        };
        
        const renderHistory = () => {
            const tbody = getEl("history-table-body");
            tbody.innerHTML = "";
            const filter = getEl("history-search").value.toLowerCase();
            const locFilter = getEl("history-filter-location").value;
            const plantFilter = getEl("history-filter-plant").value;

            state.logs.forEach(log => {
                const plant = state.plants.find(p => p.id === log.plantId);
                const plantName = plant ? plant.name : "Deleted Plant";
                const plantLoc = plant ? plant.location : null;

                if (locFilter !== 'all' && plantLoc !== locFilter) return;
                if (plantFilter !== 'all' && log.plantId !== plantFilter) return;

                if (!filter || `${plantName} ${log.type} ${log.notes}`.toLowerCase().includes(filter)) {
                    const tr = document.createElement("tr");
                    
                    let detailsHtml = log.notes ? `<span>${log.notes}</span><br>` : '';
                    if (log.height) detailsHtml += `<span class="text-xs bg-green-100 text-green-800 px-1 rounded mr-1">‚ÜïÔ∏è ${log.height}cm</span>`;
                    if (log.health) detailsHtml += `<span class="text-xs bg-blue-100 text-blue-800 px-1 rounded mr-1">‚ù§Ô∏è ${log.health.replace('-', ' ')}</span>`;
                    if (log.noticing && log.noticing.length > 0) detailsHtml += `<span class="text-xs bg-purple-100 text-purple-800 px-1 rounded mr-1">‚ú® ${log.noticing.join(', ')}</span>`;
                    
                    const photoHtml = log.photoUrl ? `<img src="${log.photoUrl}" onclick="openPhotoModal(this.src)" class="w-10 h-10 object-cover rounded cursor-zoom-in hover:opacity-80 inline-block mr-2 border">` : '';

                    tr.innerHTML = `
                        <td class="whitespace-nowrap">${new Date(log.date).toLocaleDateString()}</td>
                        <td class="font-bold">${plantName}</td>
                        <td><span class="bg-[var(--input-bg)] px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">${log.type}</span></td>
                        <td class="text-sm opacity-80 flex items-center">
                            ${photoHtml}
                            <div>${detailsHtml || '-'}</div>
                        </td>
                        <td><button class="text-red-400 hover:text-red-600 delete-log-btn" data-id="${log.id}"><i class="fa-solid fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            document.querySelectorAll(".delete-log-btn").forEach(b => b.onclick = (e) => deleteLog(e.currentTarget.dataset.id));
        };

        const quickWater = async (plantId) => {
            if (!confirm("Log watering now?")) return;
            try {
                await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                    plantId, type: "Water", date: new Date().toISOString(), notes: "Dashboard Quick Log", createdAt: Timestamp.now()
                });
                await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { snoozeUntil: null });
                showMsg("Watering logged!");
            } catch (e) { showMsg(e.message, "error"); }
        };

        const deleteLog = async (id) => {
            if(confirm("Delete this log?")) {
                await deleteDoc(doc(db, `users/${state.user.uid}/plant_logs`, id));
                showMsg("Log deleted");
            }
        };

        getEl("delete-plant-btn").onclick = async () => {
            const id = getEl("modal-plant-id").value;
            if (!id) return;

            if (confirm("Delete this plant?")) {
                try {
                    const plant = state.plants.find(p => p.id === id);
                    if (plant && plant.photoUrl && plant.photoUrl.includes("firebasestorage")) {
                        try {
                            const fileRef = ref(storage, plant.photoUrl); 
                            await deleteObject(fileRef);
                        } catch (err) {
                            console.log("Could not delete image, might be external or already gone");
                        }
                    }
                    await deleteDoc(doc(db, `users/${state.user.uid}/plants`, id));
                    toggleDisplay(getEl("plant-modal"), false);
                    showMsg("Plant deleted üóëÔ∏è");
                } catch (e) {
                    showMsg(e.message, "error");
                }
            }
        };

        getEl("plant-location").addEventListener("change", (e) => {
            const posSelect = getEl("plant-position");
            posSelect.innerHTML = '<option value="">-- Select Position --</option>';
            const loc = state.locations.find(l => l.id === e.target.value);
            if (loc && loc.positions) {
                loc.positions.forEach(p => posSelect.innerHTML += `<option value="${p}">${p}</option>`);
            }
        });

        const openPlantModal = (plantId = null) => {
            plantPhotoRemoved = false;
            const curPhotoCont = getEl("current-plant-photo-container");
            const curPhotoImg = getEl("current-plant-photo-img");
            const modal = getEl("plant-modal");
            const title = getEl("modal-title");
            const delBtn = getEl("delete-plant-btn");
            const idInput = getEl("modal-plant-id");
            
            ['plant-name', 'plant-species', 'plant-location', 'plant-water-freq', 'plant-fert-freq', 'plant-prog-freq'].forEach(id => getEl(id).value = '');
            ['plant-mist-freq', 'plant-prune-freq', 'plant-repot-freq'].forEach(id => getEl(id).value = '');
            getEl("plant-weather").checked = false;
            getEl("plant-overwinter").checked = false;
            getEl("plant-acquired").value = new Date().toISOString().split('T')[0];
            getEl("plant-icon").value = "fa-leaf";
            getEl("plant-health").value = "healthy";
            getEl('plant-photo-name').innerHTML = ''; // Add this line
            getEl("plant-status").value = "alive";
            getEl("plant-background").value = "";
            getEl("plant-pot-type").value = "plastic";
getEl("plant-pot-size").value = "";

            if (plantId) {
                const plant = state.plants.find(p => p.id === plantId);
                if (plant) {
                    title.textContent = "Edit Plant";
                    idInput.value = plant.id;
                    getEl("plant-name").value = plant.name;
                    getEl("plant-species").value = plant.species || "";
                    getEl("plant-location").value = plant.location || "";
                    getEl("plant-light").value = plant.light || "";
getEl("plant-pot-type").value = plant.potType || "plastic"; // ADD THIS
getEl("plant-pot-size").value = plant.potSize || "";        // ADD THIS
getEl("plant-position").value = plant.position || "";
                    getEl("plant-health").value = plant.health || "healthy";
                    getEl("plant-water-freq").value = plant.waterFreq || "";
                    getEl("plant-fert-freq").value = plant.fertFreq || "";
                    getEl("plant-prog-freq").value = plant.progFreq || ""; 
                    getEl("plant-acquired").value = plant.acquired || "";
                    getEl("plant-icon").value = plant.icon || "fa-leaf";
                    getEl("plant-mist-freq").value = plant.mistFreq || "";
                getEl("plant-prune-freq").value = plant.pruneFreq || "";
                getEl("plant-repot-freq").value = plant.repotFreq || "";
                getEl("plant-weather").checked = plant.weatherAlerts || false;
                getEl("plant-overwinter").checked = plant.overwinter || false;
                getEl("plant-status").value = plant.status || "alive";
            getEl("plant-background").value = plant.background || "";
                
                // Populate positions dropdown before setting its value
                const posSelect = getEl("plant-position");
                posSelect.innerHTML = '<option value="">-- Select Position --</option>';
                const loc = state.locations.find(l => l.id === plant.location);
                if (loc && loc.positions) {
                    loc.positions.forEach(p => posSelect.innerHTML += `<option value="${p}">${p}</option>`);
                }
                posSelect.value = plant.position || "";
                    
                    delBtn.style.display = 'block'; 

                if (plant.photoUrl) {
                        curPhotoImg.src = plant.photoUrl;
                        curPhotoCont.classList.remove("hidden");
                        curPhotoCont.classList.add("flex");
                    } else {
                        curPhotoCont.classList.add("hidden");
                        curPhotoCont.classList.remove("flex");
                    }
                }
            } else {
                title.textContent = "Add Plant";
                idInput.value = "";
                delBtn.style.display = 'none'; 
            }
            toggleDisplay(modal, true);
        };

        getEl("open-add-plant-modal").onclick = () => openPlantModal();
        document.querySelectorAll(".close-modal-btn").forEach(b => b.onclick = (e) => toggleDisplay(e.target.closest('.modal-overlay'), false));

        getEl("save-plant-btn").onclick = async () => {
            const id = getEl("modal-plant-id").value;
            const fileInput = getEl("plant-photo");
            const file = fileInput.files[0];
            
            let data = {
    name: getEl("plant-name").value,
    species: getEl("plant-species").value,
    location: getEl("plant-location").value,
    light: getEl("plant-light").value,
    
    // ADD THESE TWO LINES:
    potType: getEl("plant-pot-type").value,
    potSize: parseInt(getEl("plant-pot-size").value) || null,
    
    health: getEl("plant-health").value,
    position: getEl("plant-position").value,
                waterFreq: parseInt(getEl("plant-water-freq").value) || 0,
                fertFreq: parseInt(getEl("plant-fert-freq").value) || 0,
                progFreq: parseInt(getEl("plant-prog-freq").value) || 0,
                acquired: getEl("plant-acquired").value,
                icon: getEl("plant-icon").value,
                mistFreq: parseInt(getEl("plant-mist-freq").value) || 0,
                pruneFreq: parseInt(getEl("plant-prune-freq").value) || 0,
                repotFreq: parseInt(getEl("plant-repot-freq").value) || 0,
                weatherAlerts: getEl("plant-weather").checked,
                overwinter: getEl("plant-overwinter").checked,
                
                // Add these two new lines:
                status: getEl("plant-status").value,
                background: getEl("plant-background").value,
                
                updatedAt: Timestamp.now()
            };
            
            if (!data.name) return showMsg("Name required", "error");

            try {
                getEl("save-plant-btn").disabled = true;
                showMsg("Saving plant...", "success", 0); // 0 duration = stays until finished

                if (plantPhotoRemoved) {
                    data.photoUrl = null;
                }

                if (file) {
                    const compressedFile = await compressImage(file);
                    const storageRef = ref(storage, `users/${state.user.uid}/plants/${Date.now()}_${compressedFile.name}`);
                    await uploadBytes(storageRef, compressedFile);
                    data.photoUrl = await getDownloadURL(storageRef);
                }

                if (id) {
                    // Find the plant as it is right now before the update
                    const existingPlant = state.plants.find(p => p.id === id);
                    
                    // Update the plant
                    await updateDoc(doc(db, `users/${state.user.uid}/plants`, id), data);
                    
                    // If it wasn't dead before, but is dead now, log it in history!
                    if (existingPlant && existingPlant.status !== 'dead' && data.status === 'dead') {
                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId: id, type: "Archived", date: new Date().toISOString(), 
                            notes: `Moved to Graveyard ü™¶`, createdAt: Timestamp.now()
                        });
                    }
                    
                    if (file) {
                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId: id, type: "Progress", date: new Date().toISOString(), 
                            notes: `Updated plant photo`, photoUrl: data.photoUrl, createdAt: Timestamp.now()
                        });
                    }
                    showMsg("Plant updated", "success", 3000);
                } else {
                    data.createdAt = Timestamp.now();
                    const docRef = await addDoc(collection(db, `users/${state.user.uid}/plants`), data);
                    
                    await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                        plantId: docRef.id, type: "Added", date: new Date().toISOString(), 
                        notes: `Welcome home, ${data.name}!`, createdAt: Timestamp.now()
                    });
                    showMsg("Plant added", "success", 3000);
                }
                toggleDisplay(getEl("plant-modal"), false);
                fileInput.value = ""; 

            } catch (e) { 
                console.error(e);
                showMsg("Error saving: " + e.message, "error", 4000); 
            } finally {
                getEl("save-plant-btn").disabled = false;
            }
        };
        // --- Locations Logic ---
        window.openLocationModal = (id = null) => {
            const modal = getEl("location-modal");
            const delBtn = getEl("delete-location-btn");
            const title = getEl("modal-location-title");

            getEl("modal-location-id").value = "";
            getEl("loc-name").value = "";
            getEl("loc-positions").value = ""; // Default state
            getEl("loc-type").value = "inside";
            getEl("loc-light").value = "natural";
            getEl("loc-temp-summer").value = "";
            getEl("loc-temp-winter").value = "";
            getEl("loc-humidity").value = "medium";
            getEl("loc-draft").value = "none";
            delBtn.style.display = 'none';
            title.textContent = "Add Location";

            if (id) {
                const loc = state.locations.find(l => l.id === id);
                if (loc) {
                    getEl("modal-location-id").value = loc.id;
                    getEl("loc-name").value = loc.name || "";
                    getEl("loc-positions").value = loc.positions ? loc.positions.join(', ') : "";
                    getEl("loc-type").value = loc.type || "inside";
                    getEl("loc-light").value = loc.light || "natural";
                    getEl("loc-temp-summer").value = loc.tempSummer || "";
                    getEl("loc-temp-winter").value = loc.tempWinter || "";
                    getEl("loc-humidity").value = loc.humidity || "medium";
                    getEl("loc-draft").value = loc.draft || "none";
                    delBtn.style.display = 'block';
                    title.textContent = "Edit Location";
                }
            }
            toggleDisplay(modal, true);
        };

        window.saveLocation = async () => {
            const id = getEl("modal-location-id").value;
            const data = {
                name: getEl("loc-name").value,
                type: getEl("loc-type").value,
                light: getEl("loc-light").value,
                tempSummer: parseFloat(getEl("loc-temp-summer").value) || null,
                tempWinter: parseFloat(getEl("loc-temp-winter").value) || null,
                humidity: getEl("loc-humidity").value,
                draft: getEl("loc-draft").value,
                positions: getEl("loc-positions").value.split(',').map(s=>s.trim()).filter(Boolean),
                updatedAt: Timestamp.now()
            };

            if (!data.name) return showMsg("Location name is required", "error");

            try {
                if (id) {
                    await updateDoc(doc(db, `users/${state.user.uid}/plant_locations`, id), data);
                    showMsg("Location updated");
                } else {
                    data.createdAt = Timestamp.now();
                    await addDoc(collection(db, `users/${state.user.uid}/plant_locations`), data);
                    showMsg("Location added");
                }
                toggleDisplay(getEl("location-modal"), false);
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.deleteLocation = async (id) => {
            if(!confirm("Delete this location? Plants here will keep the reference but lose environmental details.")) return;
            try {
                await deleteDoc(doc(db, `users/${state.user.uid}/plant_locations`, id));
                toggleDisplay(getEl("location-modal"), false);
                showMsg("Location deleted");
            } catch(e) { showMsg(e.message, "error"); }
        };

        // --- Layout / Birds-Eye Logic ---
        let layoutMode = 'move'; 
        let activeTool = 'path'; 
        let activeDrag = null;   
        let activeDraw = null;   

        const tools = [
            { id: 'path', label: 'Path', icon: 'fa-road', color: 'text-gray-500', bg: 'bg-gray-300 dark:bg-gray-600', border: 'border-dashed border-gray-400' },
            { id: 'shed', label: 'Shed', icon: 'fa-warehouse', color: 'text-amber-800', bg: 'bg-amber-100 dark:bg-amber-900', border: 'border-amber-800' },
            { id: 'veg',  label: 'Veg Patch', icon: 'fa-carrot', color: 'text-orange-500', bg: 'bg-amber-900/30', border: 'border-amber-900/50' },
            { id: 'water', label: 'Water', icon: 'fa-water', color: 'text-blue-500', bg: 'bg-blue-500/20', border: 'border-blue-400' },
            { id: 'wall', label: 'Wall', icon: 'fa-ruler-horizontal', color: 'text-stone-500', bg: 'bg-stone-500', border: '' },
            { id: 'tree', label: 'Tree', icon: 'fa-tree', color: 'text-green-700', bg: 'bg-green-800/80', border: '' }
        ];

        window.setMode = (mode) => {
            layoutMode = mode;
            
            const moveBtn = getEl('mode-move');
            const drawBtn = getEl('mode-draw');
            const toolbar = getEl('layout-toolbar');
            const instructions = getEl('layout-instructions');

            if (mode === 'move') {
                moveBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all";
                drawBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all";
                toolbar.classList.add('opacity-50', 'pointer-events-none'); 
                instructions.innerHTML = '<i class="fa-solid fa-hand-pointer mr-1"></i> Drag items to move. Double-tap to delete.';
            } else {
                moveBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold opacity-60 hover:opacity-100 transition-all";
                drawBtn.className = "px-4 py-1.5 rounded-md text-sm font-bold bg-white dark:bg-gray-600 shadow-sm transition-all";
                toolbar.classList.remove('opacity-50', 'pointer-events-none');
                instructions.innerHTML = '<i class="fa-solid fa-pencil mr-1"></i> Drag on canvas to draw area. Select tool above.';
                renderToolbar(); 
            }
        };

        window.selectTool = (toolId) => {
            activeTool = toolId;
            renderToolbar();
        };

        const renderToolbar = () => {
            const bar = getEl("layout-toolbar");
            bar.innerHTML = tools.map(t => `
                <button onclick="selectTool('${t.id}')" 
                    class="btn-secondary whitespace-nowrap text-xs flex items-center gap-2 transition-all ${activeTool === t.id && layoutMode === 'draw' ? 'ring-2 ring-[var(--primary)] bg-[var(--input-bg)]' : 'opacity-80'}">
                    <i class="fa-solid ${t.icon} ${t.color}"></i> ${t.label}
                </button>
            `).join('');
        };

        const renderLayout = () => {
            const container = document.getElementById("layout-container");
            const select = document.getElementById("layout-location-select");
            const location = select.value;
            
            container.innerHTML = `<div id="layout-placeholder" class="absolute inset-0 flex items-center justify-center opacity-50 pointer-events-none ${location ? 'hidden' : ''}">
                <p><i class="fa-solid fa-map mr-2"></i>Select a location to start</p>
            </div>`;

            container.onmousedown = handleDrawStart;
            container.ontouchstart = handleDrawStart;

            if (!location) return;

            state.structures.filter(s => s.location === location).forEach(s => {
                const tool = tools.find(t => t.id === s.type) || tools[0];
                const el = document.createElement("div");
                
                el.style.left = `${s.x}%`; 
                el.style.top = `${s.y}%`;
                el.style.width = s.w ? `${s.w}%` : (s.type === 'wall' ? '30%' : '15%'); 
                el.style.height = s.h ? `${s.h}%` : (s.type === 'wall' ? '2%' : '10%');
                
                el.className = `absolute cursor-move touch-none structure-item ${tool.bg} ${tool.border ? 'border-2' : ''} ${tool.border} rounded flex items-center justify-center shadow-sm z-0`;
                
                if (!s.w || s.w > 10) {
                    el.innerHTML = `<i class="fa-solid ${tool.icon} ${tool.color} opacity-50 pointer-events-none"></i>`;
                }

                el.dataset.id = s.id;
                el.dataset.type = "structure";
                el.addEventListener('mousedown', handleMoveStart);
                el.addEventListener('touchstart', handleMoveStart, { passive: false });
                el.ondblclick = (e) => { e.stopPropagation(); deleteStructure(s.id); };
                
                container.appendChild(el);
            });

            state.plants.filter(p => p.location === location && p.status !== 'dead').forEach(plant => {
                const el = document.createElement("div");
                const x = plant.layoutX !== undefined ? plant.layoutX : 50;
                const y = plant.layoutY !== undefined ? plant.layoutY : 50;

                el.className = "absolute flex flex-col items-center justify-center cursor-move select-none touch-none z-10 plant-marker"; 
                el.style.left = `${x}%`; el.style.top = `${y}%`;
                el.style.transform = "translate(-50%, -50%)"; 
                el.dataset.id = plant.id;
                el.dataset.type = "plant";
                
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-[var(--primary)] text-white flex items-center justify-center shadow-lg border-2 border-white dark:border-gray-800 hover:scale-110 transition-transform">
                        <i class="fa-solid ${plant.icon || 'fa-leaf'}"></i>
                    </div>
                    <span class="text-[10px] font-bold mt-1 bg-[var(--card)] px-1 rounded shadow opacity-80 whitespace-nowrap">${plant.name}</span>
                `;

                el.addEventListener('mousedown', handleMoveStart);
                el.addEventListener('touchstart', handleMoveStart, { passive: false });
                container.appendChild(el);
            });
        };
        function handleDrawStart(e) {
            if (layoutMode !== 'draw' || e.target !== getEl('layout-container')) return;
            e.preventDefault();

            const container = getEl("layout-container");
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const startX = ((clientX - rect.left) / rect.width) * 100;
            const startY = ((clientY - rect.top) / rect.height) * 100;

            const guide = document.createElement("div");
            guide.className = "absolute border-2 border-[var(--primary)] bg-[var(--primary)] bg-opacity-20 z-50 pointer-events-none";
            guide.style.left = startX + '%';
            guide.style.top = startY + '%';
            container.appendChild(guide);

            activeDraw = { startX, startY, guide, rect };

            document.addEventListener('mousemove', handleDrawMove);
            document.addEventListener('touchmove', handleDrawMove, { passive: false });
            document.addEventListener('mouseup', handleDrawEnd);
            document.addEventListener('touchend', handleDrawEnd);
        }

        function handleDrawMove(e) {
            if (!activeDraw) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let currX = ((clientX - activeDraw.rect.left) / activeDraw.rect.width) * 100;
            let currY = ((clientY - activeDraw.rect.top) / activeDraw.rect.height) * 100;
            
            currX = Math.max(0, Math.min(100, currX));
            currY = Math.max(0, Math.min(100, currY));

            const left = Math.min(activeDraw.startX, currX);
            const top = Math.min(activeDraw.startY, currY);
            const width = Math.abs(currX - activeDraw.startX);
            const height = Math.abs(currY - activeDraw.startY);

            activeDraw.guide.style.left = left + '%';
            activeDraw.guide.style.top = top + '%';
            activeDraw.guide.style.width = width + '%';
            activeDraw.guide.style.height = height + '%';

            activeDraw.final = { x: left, y: top, w: width, h: height };
        }

        async function handleDrawEnd() {
            if (activeDraw && activeDraw.final) {
                const { x, y, w, h } = activeDraw.final;
                const location = getEl("layout-location-select").value;
                
                if (w > 2 || h > 2) {
                    try {
                        await addDoc(collection(db, `users/${state.user.uid}/garden_structures`), {
                            type: activeTool,
                            location: location,
                            x, y, w, h,
                            createdAt: Timestamp.now()
                        });
                    } catch(e) { showMsg(e.message, "error"); }
                }
                activeDraw.guide.remove();
            } else if (activeDraw) {
                activeDraw.guide.remove(); 
            }

            activeDraw = null;
            document.removeEventListener('mousemove', handleDrawMove);
            document.removeEventListener('touchmove', handleDrawMove);
            document.removeEventListener('mouseup', handleDrawEnd);
            document.removeEventListener('touchend', handleDrawEnd);
        }

        function handleMoveStart(e) {
            if (layoutMode === 'draw') return; 
            e.stopPropagation(); 
            if(e.cancelable) e.preventDefault();
            
            const el = e.currentTarget;
            const container = getEl("layout-container").getBoundingClientRect();
            
            activeDrag = {
                el,
                id: el.dataset.id,
                type: el.dataset.type, 
                container,
                offsetX: 0, offsetY: 0
            };

            document.addEventListener('mousemove', handleMoveDrag);
            document.addEventListener('touchmove', handleMoveDrag, { passive: false });
            document.addEventListener('mouseup', handleMoveEnd);
            document.addEventListener('touchend', handleMoveEnd);
        }

        function handleMoveDrag(e) {
            if (!activeDrag) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let x = ((clientX - activeDrag.container.left) / activeDrag.container.width) * 100;
            let y = ((clientY - activeDrag.container.top) / activeDrag.container.height) * 100;
            
            x = Math.max(0, Math.min(100, x));
            y = Math.max(0, Math.min(100, y));

            activeDrag.el.style.left = x + '%';
            activeDrag.el.style.top = y + '%';
            activeDrag.lastX = x;
            activeDrag.lastY = y;
        }

        async function handleMoveEnd() {
            if (activeDrag && activeDrag.lastX !== undefined) {
                const { id, type, lastX, lastY } = activeDrag;
                try {
                    const collectionName = type === 'structure' ? 'garden_structures' : 'plants';
                    const updateData = type === 'structure' 
                        ? { x: lastX, y: lastY } 
                        : { layoutX: lastX, layoutY: lastY }; 

                    await updateDoc(doc(db, `users/${state.user.uid}/${collectionName}`, id), updateData);
                } catch(e) { console.error("Save pos failed", e); }
            }
            activeDrag = null;
            document.removeEventListener('mousemove', handleMoveDrag);
            document.removeEventListener('touchmove', handleMoveDrag);
            document.removeEventListener('mouseup', handleMoveEnd);
            document.removeEventListener('touchend', handleMoveEnd);
        }

        renderToolbar();
        // --- Wishlist Functions ---
        window.openWishlistModal = (id = null) => {
            const modal = getEl("wishlist-modal");
            const delBtn = getEl("delete-wish-btn");
            
            getEl("wish-id").value = "";
            getEl("wish-name").value = "";
            getEl("wish-species").value = "";
            getEl("wish-price").value = "";
            getEl("wish-notes").value = "";
            document.querySelector('input[name="wish-priority"][value="medium"]').checked = true;
            delBtn.style.display = 'none';

            if (id) {
                const item = state.wishlist.find(w => w.id === id);
                if (item) {
                    getEl("wish-id").value = item.id;
                    getEl("wish-name").value = item.name;
                    getEl("wish-species").value = item.species || "";
                    getEl("wish-price").value = item.price || "";
                    getEl("wish-notes").value = item.notes || "";
                    const radio = document.querySelector(`input[name="wish-priority"][value="${item.priority}"]`);
                    if(radio) radio.checked = true;
                    
                    delBtn.style.display = 'block';
                    delBtn.onclick = () => deleteWish(id);
                }
            }
            toggleDisplay(modal, true);
        };

        window.saveWish = async () => {
            const id = getEl("wish-id").value;
            const data = {
                name: getEl("wish-name").value,
                species: getEl("wish-species").value,
                price: getEl("wish-price").value,
                notes: getEl("wish-notes").value,
                priority: document.querySelector('input[name="wish-priority"]:checked').value,
                updatedAt: Timestamp.now()
            };

            if (!data.name) return showMsg("Name is required", "error");

            try {
                if (id) {
                    await updateDoc(doc(db, `users/${state.user.uid}/wishlist`, id), data);
                    showMsg("Wish updated ‚ú®");
                } else {
                    data.createdAt = Timestamp.now();
                    await addDoc(collection(db, `users/${state.user.uid}/wishlist`), data);
                    showMsg("Added to wishlist ‚ú®");
                }
                toggleDisplay(getEl("wishlist-modal"), false);
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.deleteWish = async (id) => {
            if(!confirm("Remove from wishlist?")) return;
            try {
                await deleteDoc(doc(db, `users/${state.user.uid}/wishlist`, id));
                toggleDisplay(getEl("wishlist-modal"), false);
                showMsg("Wish removed");
            } catch(e) { showMsg(e.message, "error"); }
        };

        window.promoteWish = async (id) => {
            const item = state.wishlist.find(w => w.id === id);
            if (!item) return;

            if (!confirm(`Did you get the ${item.name}? This will move it to your Garden.`)) return;

            try {
                const plantData = {
                    name: item.name,
                    species: item.species || "",
                    location: "",
                    light: "medium",
                    health: "healthy",
                    waterFreq: 7, 
                    fertFreq: 14, 
                    acquired: new Date().toISOString().split('T')[0],
                    icon: "fa-leaf",
                    createdAt: Timestamp.now()
                };
                
                const docRef = await addDoc(collection(db, `users/${state.user.uid}/plants`), plantData);

                await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                    plantId: docRef.id,
                    type: "Added",
                    date: new Date().toISOString(),
                    notes: `Wishlist item acquired! (Price: ${item.price || 'N/A'})`,
                    createdAt: Timestamp.now()
                });

                await deleteDoc(doc(db, `users/${state.user.uid}/wishlist`, id));
                showMsg("Welcome home! moved to Garden üå±");
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.openPlantTasksModal = (plantId) => {
    const plant = state.plants.find(p => p.id === plantId);
    if (!plant) return;
    
    getEl("tasks-modal-subtitle").innerHTML = `Schedule & Modifiers for <span class="text-[var(--primary)]">${plant.name}</span>`;
    const list = getEl("plant-tasks-list");
    list.innerHTML = "";
    
    const now = new Date();
    const plantLogs = state.logs.filter(l => l.plantId === plant.id);
    let html = "";
    
    // Helper to calculate diffs
    const getDiff = (lastLogType, freq) => {
        if (!freq) return null;
        const lastLog = plantLogs.find(l => l.type === lastLogType);
        const lastDate = lastLog ? new Date(lastLog.date) : new Date(plant.acquired || 0);
        const diffDays = (now - lastDate) / (1000 * 60 * 60 * 24);
        const daysOverdue = Math.floor(diffDays - freq);
        
        let statusText = daysOverdue >= 0 
            ? `<span class="text-red-500 font-bold">${daysOverdue === 0 ? 'Due Today' : daysOverdue + ' days overdue'}</span>` 
            : `<span class="text-green-600 dark:text-green-400 font-bold">Due in ${Math.abs(daysOverdue)} days</span>`;
        
        return { daysOverdue, statusText, lastDate };
    };

    // 1. Water Calculation Breakdown
    if (plant.waterFreq) {
        let wBase = plant.waterFreq;
        let wFreq = wBase;
        let mathLog = `<li>Base: <b>${wBase} days</b></li>`;
        
        if (state.winterMode) {
            wFreq = Math.ceil(wFreq * 1.5);
            mathLog += `<li>‚ùÑÔ∏è Winter Mode (x1.5): <b>${wFreq} days</b></li>`;
        }
        
        if (plant.potType === 'terracotta') {
            wFreq = Math.ceil(wFreq * 0.8);
            mathLog += `<li>üè∫ Terracotta (x0.8): <b>${wFreq} days</b></li>`;
        } else if (plant.potType === 'ground') {
            wFreq += 3;
            mathLog += `<li>üåç In Ground (+3): <b>${wFreq} days</b></li>`;
        }
        
        if (plant.potType !== 'ground' && plant.potSize) {
            if (plant.potSize <= 10) { wFreq -= 1; mathLog += `<li>ü§è Small Pot (-1): <b>${wFreq} days</b></li>`; }
            if (plant.potSize >= 25) { wFreq += 2; mathLog += `<li>ü™£ Large Pot (+2): <b>${wFreq} days</b></li>`; }
        }
        
        const locObj = state.locations.find(l => l.id === plant.location);
        const finalLight = plant.light || (locObj ? locObj.light : 'medium');
        const finalHumidity = locObj ? locObj.humidity : 'medium';
        
        if (finalLight === 'high') { wFreq -= 1; mathLog += `<li>‚òÄÔ∏è Direct Sun (-1): <b>${wFreq} days</b></li>`; }
        if (finalLight === 'low') { wFreq += 1; mathLog += `<li>‚òÅÔ∏è Low Light (+1): <b>${wFreq} days</b></li>`; }
        if (finalHumidity === 'high') { wFreq += 1; mathLog += `<li>üíß High Humidity (+1): <b>${wFreq} days</b></li>`; }
        if (finalHumidity === 'low') { wFreq -= 1; mathLog += `<li>üåµ Dry Air (-1): <b>${wFreq} days</b></li>`; }
        
        wFreq = Math.max(1, wFreq); // Floor limit
        
        if (locObj && (locObj.type === 'outside' || locObj.type === 'patio' || locObj.type === 'greenhouse')) {
            if (state.weather && state.weather.precipitation_sum && state.weather.precipitation_sum[0] > 1) {
                wFreq += 2; 
                mathLog += `<li>üåßÔ∏è Rain Delay (+2): <b>${wFreq} days</b></li>`;
            }
        }
        
        const waterDiff = getDiff('Water', wFreq);
        
        // Snooze Note
        let snoozeHtml = '';
        if (plant.snoozeUntil) {
            const snoozeDate = typeof plant.snoozeUntil.toDate === 'function' ? plant.snoozeUntil.toDate() : new Date(plant.snoozeUntil);
            if (snoozeDate > now) {
                const dUntil = Math.ceil((snoozeDate - now) / (1000 * 60 * 60 * 24));
                snoozeHtml = `<div class="text-xs bg-yellow-100 text-yellow-800 p-2 rounded mt-2 border border-yellow-200 font-bold"><i class="fa-solid fa-clock"></i> Snoozed for ${dUntil} more days.</div>`;
            }
        }
        
        html += `
            <div class="card p-3 border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/10 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-blue-700 dark:text-blue-400 flex items-center gap-2"><i class="fa-solid fa-droplet"></i> Watering</h3>
                    <span class="text-sm bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm border border-[var(--border)]">${waterDiff.statusText}</span>
                </div>
                <div class="text-xs space-y-1 opacity-80 mb-2 border-b border-blue-200 dark:border-blue-800 pb-2">
                    <p>Last watered: ${waterDiff.lastDate.toLocaleDateString()}</p>
                    <p class="font-bold text-[var(--text)]">Final Target: Every ${wFreq} days</p>
                </div>
                <details class="group bg-white dark:bg-gray-800 rounded p-2 border border-[var(--border)]">
                    <summary class="text-xs font-bold cursor-pointer opacity-70 hover:opacity-100 flex items-center gap-1">
                        <i class="fa-solid fa-square-root-variable"></i> View Math Breakdown
                    </summary>
                    <ul class="text-xs mt-2 space-y-1 ml-4 list-disc opacity-80">
                        ${mathLog}
                    </ul>
                </details>
                ${snoozeHtml}
            </div>
        `;
    }
    
    // Helper for basic tasks
    const renderSimpleTask = (freqVal, type, icon, colorClass, borderClass, bgClass) => {
        if (!freqVal) return;
        const diff = getDiff(type, freqVal);
        html += `
            <div class="card p-3 border-l-4 ${borderClass} ${bgClass} shadow-sm">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold ${colorClass} flex items-center gap-2"><i class="fa-solid ${icon}"></i> ${type}</h3>
                    <span class="text-sm bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm border border-[var(--border)]">${diff.statusText}</span>
                </div>
                <div class="text-xs mt-2 opacity-80">
                    <p>Last: ${diff.lastDate.toLocaleDateString()} | Target: Every ${freqVal} days</p>
                </div>
            </div>
        `;
    };

    renderSimpleTask(plant.fertFreq, 'Fertilize', 'fa-seedling', 'text-orange-600 dark:text-orange-400', 'border-orange-500', 'bg-orange-50 dark:bg-orange-900/10');
    renderSimpleTask(plant.mistFreq, 'Mist', 'fa-spray-can', 'text-cyan-600 dark:text-cyan-400', 'border-cyan-500', 'bg-cyan-50 dark:bg-cyan-900/10');
    renderSimpleTask(plant.pruneFreq, 'Prune', 'fa-scissors', 'text-green-700 dark:text-green-400', 'border-green-500', 'bg-green-50 dark:bg-green-900/10');
    
    let repotDays = plant.repotFreq;
    if (repotDays && plant.potSize && plant.potSize <= 12 && plant.potType !== 'ground') {
        repotDays = Math.max(30, repotDays - 60); 
    }
    
    if (plant.repotFreq) {
         const diff = getDiff('Repot', repotDays);
         let repotNote = (plant.repotFreq !== repotDays) ? `<p class="text-[10px] text-amber-600 font-bold mt-1 bg-amber-100 dark:bg-amber-900 p-1 rounded inline-block">*Reduced by 60 days due to small pot size.</p>` : '';
         html += `
            <div class="card p-3 border-l-4 border-amber-500 bg-amber-50 dark:bg-amber-900/10 shadow-sm">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-amber-700 dark:text-amber-400 flex items-center gap-2"><i class="fa-solid fa-bucket"></i> Repot</h3>
                    <span class="text-sm bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm border border-[var(--border)]">${diff.statusText}</span>
                </div>
                <div class="text-xs mt-2 opacity-80">
                    <p>Last: ${diff.lastDate.toLocaleDateString()} | Target: Every ${repotDays} days</p>
                    ${repotNote}
                </div>
            </div>
        `;
    }

    renderSimpleTask(plant.progFreq, 'Progress', 'fa-camera', 'text-purple-600 dark:text-purple-400', 'border-purple-500', 'bg-purple-50 dark:bg-purple-900/10');

    if (!html) {
        html = `<div class="text-center p-6 border-2 border-dashed border-[var(--border)] rounded-lg"><p class="opacity-50 text-sm font-bold"><i class="fa-solid fa-bed text-2xl mb-2 block"></i> No routines set for this plant yet.</p></div>`;
    }

    list.innerHTML = html;
    toggleDisplay(getEl("plant-tasks-modal"), true);
};

        window.openPhotoModal = (src) => {
            if (!src) return;
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('photo-modal-img');
            img.src = src;
            modal.classList.remove('hidden');
        };

        window.closePhotoModal = () => {
            document.getElementById('photo-modal').classList.add('hidden');
            document.getElementById('photo-modal-img').src = '';
        };

        getEl("log-type-select").addEventListener("change", (e) => {
            const showExtras = e.target.value === "Progress" || e.target.value === "Growth";
            toggleDisplay(getEl("log-progress-extras"), showExtras);
        });

        window.openLawnModal = () => {
            getEl('lawn-freq').value = state.lawn?.cutFreq || 7;
            toggleDisplay(getEl('lawn-modal'), true);
        };

        window.logLawnCut = async () => {
            try {
                await setDoc(doc(db, `users/${state.user.uid}/settings/lawn`), {
                    lastCut: new Date().toISOString(),
                    cutFreq: parseInt(getEl('lawn-freq').value) || 7
                }, { merge: true });
                showMsg("Grass cutting logged successfully!");
                toggleDisplay(getEl('lawn-modal'), false);
            } catch(e) { showMsg(e.message, 'error'); }
        };

        window.saveLawnSettings = async () => {
            try {
                await setDoc(doc(db, `users/${state.user.uid}/settings/lawn`), {
                    cutFreq: parseInt(getEl('lawn-freq').value) || 7
                }, { merge: true });
                showMsg("Lawn settings saved!");
                toggleDisplay(getEl('lawn-modal'), false);
            } catch(e) { showMsg(e.message, 'error'); }
        };

        window.saveApiKeys = async () => {
            try {
                await setDoc(doc(db, `users/${state.user.uid}/settings/apikeys`), {
                    perenual: getEl('setting-perenual-key').value
                }, { merge: true });
                showMsg("API Keys saved!");
            } catch(e) { showMsg(e.message, 'error'); }
        };

        window.openApiSearchModal = () => {
            getEl('api-search-query').value = getEl('plant-name').value;
            getEl('api-search-results').innerHTML = '<p class="text-sm opacity-60 text-center py-4">Search to find advice...</p>';
            toggleDisplay(getEl('api-search-modal'), true);
        };

        window.searchPlantApi = async () => {
            const query = getEl('api-search-query').value;
            const apiChoice = getEl('api-choice').value;
            const resContainer = getEl('api-search-results');
            if(!query) return showMsg("Please enter a plant name", "error");
            
            resContainer.innerHTML = '<p class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></p>';

            const cloudFunctionBase = 'https://us-central1-sammy-7298f.cloudfunctions.net';

            try {
                if (apiChoice === 'growstuff') {
                    // FIX 1: Changed ?query= to ?term=
                    const targetUrl = `${cloudFunctionBase}/growstuffProxy/crops.json?term=${encodeURIComponent(query)}`;
                    
                    const res = await fetch(targetUrl);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    
                    // FIX 2: Added data.query to the extraction fallbacks
                    const results = Array.isArray(data) ? data : (data.query || data.data || data.crops || []);

                    if (results.length === 0) {
                        resContainer.innerHTML = '<p class="text-center py-4 opacity-70">No results found in Growstuff. Try Perenual!</p>';
                        return;
                    }

                    renderApiResults(results.map(d => ({
                        name: d.name || 'Unknown', 
                        species: d.scientific_name || d.en_wikipedia_url?.split('/').pop()?.replace(/_/g, ' ') || '',
                        sun: d.sun_requirements || 'Check local guidelines', 
                        water: d.water_requirements || 'Check local guidelines',
                        desc: d.description || ''
                    })));

                } else if (apiChoice === 'perenual') {
                    const key = state.apiKeys?.perenual || '';
                    if (!key) return resContainer.innerHTML = '<p class="text-red-500 text-center py-4">Perenual API Key missing! Add it in Settings.</p>';
                    
                    const targetUrl = `${cloudFunctionBase}/perenualProxy/api/species-list?key=${key}&q=${encodeURIComponent(query)}`;
                    
                    const res = await fetch(targetUrl);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    
                    const data = await res.json();
                    
                    if (!data.data || data.data.length === 0) {
                        resContainer.innerHTML = '<p class="text-center py-4 opacity-70">No results found in Perenual.</p>';
                        return;
                    }

                    renderApiResults(data.data.map(d => ({
                        name: d.common_name, species: d.scientific_name[0],
                        sun: d.sunlight.join(', '), water: d.watering, desc: ''
                    })));
                }
            } catch(e) { 
                console.error(e);
                resContainer.innerHTML = `<p class="text-red-500 text-center py-4">Error fetching data: ${e.message}</p>`; 
            }
        };

        window.renderApiResults = (results) => {
            const resContainer = getEl('api-search-results');
            if(!results.length) return resContainer.innerHTML = '<p class="text-center py-4 opacity-70">No results found.</p>';
            resContainer.innerHTML = results.map(r => `
                <div class="card p-3 border border-[var(--border)] text-sm">
                    <p class="font-bold text-lg capitalize text-[var(--primary)]">${r.name}</p>
                    <p class="text-xs opacity-70 italic mb-2">${r.species || 'Unknown Species'}</p>
                    <p><strong><i class="fa-solid fa-sun text-yellow-500 w-4"></i> Sun:</strong> ${r.sun || 'Unknown'}</p>
                    <p><strong><i class="fa-solid fa-droplet text-blue-500 w-4"></i> Water:</strong> ${r.water || 'Unknown'}</p>
                    <button onclick='window.applyApiData(${JSON.stringify(r).replace(/'/g, "&#39;")})' class="btn-secondary w-full mt-3 py-1 text-xs">
                        <i class="fa-solid fa-file-import mr-1"></i> Use this advice
                    </button>
                </div>
            `).join('');
        };

        window.applyApiData = (data) => {
            if(data.name) getEl('plant-name').value = data.name.charAt(0).toUpperCase() + data.name.slice(1);
            if(data.species) getEl('plant-species').value = data.species;
            if(data.desc) getEl('plant-background').value = data.desc;
            
            const sun = (data.sun || '').toLowerCase();
            if(sun.includes('full') || sun.includes('high') || sun.includes('direct')) getEl('plant-light').value = 'high';
            else if(sun.includes('shade') || sun.includes('low')) getEl('plant-light').value = 'low';
            else getEl('plant-light').value = 'medium';

            if(data.water) {
                const w = data.water.toLowerCase();
                if(w.includes('frequent') || w.includes('high')) getEl('plant-water-freq').value = 3;
                else if(w.includes('average') || w.includes('moderate')) getEl('plant-water-freq').value = 7;
                else if(w.includes('minimum') || w.includes('low')) getEl('plant-water-freq').value = 14;
            }

            toggleDisplay(getEl('api-search-modal'), false);
            showMsg("Advice applied to form!");
        };

        const renderWishlist = () => {
            const list = getEl("wishlist-container");
            list.innerHTML = "";

            let high = 0, med = 0, low = 0;

            state.wishlist.sort((a,b) => {
                const priorities = { high: 3, medium: 2, low: 1 };
                return priorities[b.priority] - priorities[a.priority];
            }).forEach(item => {
                if(item.priority === 'high') high++;
                if(item.priority === 'medium') med++;
                if(item.priority === 'low') low++;

                const card = document.createElement("div");
                card.className = "card p-4 flex flex-col justify-between relative overflow-hidden group";
                
                const borderColors = { high: 'border-red-500', medium: 'border-yellow-500', low: 'border-green-500' };
                card.classList.add('border-l-4', borderColors[item.priority]);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg">${item.name}</h3>
                            <p class="text-xs opacity-70">${item.species || 'Unknown Species'}</p>
                        </div>
                        <button onclick="openWishlistModal('${item.id}')" class="text-gray-400 hover:text-purple-500">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4 space-y-1">
                        ${item.price ? `<p class="text-sm"><i class="fa-solid fa-tag text-gray-400 w-5"></i> ${item.price}</p>` : ''}
                        ${item.notes ? `<p class="text-xs italic opacity-60 line-clamp-2">"${item.notes}"</p>` : ''}
                    </div>

                    <button onclick="promoteWish('${item.id}')" class="w-full py-2 bg-[var(--input-bg)] hover:bg-green-100 dark:hover:bg-green-900 text-green-600 font-bold rounded flex items-center justify-center gap-2 transition-colors">
                        <i class="fa-solid fa-check"></i> I Got It!
                    </button>
                `;
                list.appendChild(card);
            });

            getEl("wish-count-high").textContent = high;
            getEl("wish-count-med").textContent = med;
            getEl("wish-count-low").textContent = low;

            if(state.wishlist.length === 0) {
                list.innerHTML = `<p class="col-span-3 text-center opacity-50 py-8">Your wishlist is empty. Time to go shopping? üõçÔ∏è</p>`;
            }
        };
        // --- Auth & Init ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;

                state.nav = new AppNavigation({
                    appName: 'PlantTrackr',
                    appIcon: 'fa-leaf',
                    themeColor: 'green',
                    userEmail: user.email,
                    version: changelogData && changelogData.length > 0 ? changelogData[0].version : '1.0.0',
                    activeTab: 'dashboard',
                    tabs: [
    { id: 'dashboard', label: 'Dashboard', icon: 'fa-border-all' },
    { id: 'plants',    label: 'Garden',    icon: 'fa-seedling' },
    { id: 'layout',    label: 'Spaces',    icon: 'fa-map' }, // Renamed to Spaces
    { id: 'history',   label: 'Journal',   icon: 'fa-book' },
    { id: 'settings',  label: 'Settings',  icon: 'fa-gear' }
],
                    onThemeChange: async (newTheme) => {
                        await setDoc(doc(db, 'users', user.uid, 'settings', 'theme'), { theme: newTheme }, { merge: true });
                    }
                });

                onSnapshot(doc(db, 'users', state.user.uid, 'settings', 'lawn'), (snap) => {
            state.lawn = snap.exists() ? snap.data() : null;
            if (window.renderDashboard) renderDashboard();
        });

        onSnapshot(doc(db, 'users', state.user.uid, 'settings', 'apikeys'), (snap) => {
            state.apiKeys = snap.exists() ? snap.data() : null;
            const keyInput = document.getElementById("setting-perenual-key");
            if(keyInput && state.apiKeys?.perenual) keyInput.value = state.apiKeys.perenual;
        });

        onSnapshot(doc(db, 'users', state.user.uid, 'settings', 'location'), async (snap) => {
            const data = snap.exists() ? snap.data() : null;
            
            if (data && data.latitude) {
                state.location = data;
                await fetchWeather();
            } else {
                state.location = null;
                state.weather = null;
                renderDashboard(); // <-- Fixed: Removed window. check
            }
        });

                onSnapshot(doc(db, 'users', state.user.uid, 'settings', 'general'), (snap) => {
                    state.winterMode = snap.exists() ? snap.data().winterMode : false;
                    const toggle = getEl("winter-mode-toggle");
                    if(toggle) toggle.checked = state.winterMode;
                    renderDashboard(); 
                });

                getEl("winter-mode-toggle").addEventListener('change', async (e) => {
                    await setDoc(doc(db, 'users', state.user.uid, 'settings', 'general'), { 
                        winterMode: e.target.checked 
                    }, { merge: true });
                });

                getEl("log-type-select").addEventListener("change", (e) => {
                    const showExtras = e.target.value === "Progress";
                    toggleDisplay(getEl("log-progress-extras"), showExtras);
                });

                getEl("submit-log-btn").onclick = async () => {
                    const plantId = getEl("log-plant-select").value;
                    const type = getEl("log-type-select").value;
                    const date = getEl("log-date").value;
                    const notes = getEl("log-notes").value;
                    const height = getEl("log-growth-val").value;
                    const health = getEl("log-health-select").value;
                    const noticingTags = Array.from(document.querySelectorAll('#log-noticing-tags input:checked')).map(cb => cb.value);
                    
                    const fileInput = getEl("log-photo");
                    const file = fileInput ? fileInput.files[0] : null;

                    if (!plantId) return showMsg("Please select a plant", "error");

                    try {
                        getEl("submit-log-btn").disabled = true;
                        showMsg("Saving log...", "success", 0); // 0 duration = stays until finished

                        let photoUrl = null;
                        if (file) {
                            const compressedFile = await compressImage(file);
                            const storageRef = ref(storage, `users/${state.user.uid}/logs/${Date.now()}_${compressedFile.name}`);
                            await uploadBytes(storageRef, compressedFile);
                            photoUrl = await getDownloadURL(storageRef);
                        }

                        const logData = {
                            plantId, type, date: new Date(date).toISOString(), notes,
                            height: height ? parseFloat(height) : null,
                            noticing: noticingTags,
                            photoUrl, createdAt: Timestamp.now()
                        };
                        
                        if (type === 'Progress') logData.health = health;

                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), logData);

                        if (type === 'Progress' && health) {
                            await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { health });
                        }

                        showMsg("Log saved successfully!", "success", 3000);

                        toggleDisplay(document.getElementById("quick-log-modal"), false);
                        
                        // Reset Form fields
                        getEl("log-notes").value = "";
                        getEl("log-growth-val").value = "";
                        document.querySelectorAll('#log-noticing-tags input').forEach(cb => cb.checked = false);
                        if(fileInput) fileInput.value = "";
                        getEl("log-photo-name").innerHTML = ""; // Add this line
                        toggleDisplay(getEl("log-progress-extras"), false);
                        getEl("log-type-select").value = "Water";

                    } catch (e) { 
                        showMsg(e.message, "error", 4000); 
                    } finally {
                        getEl("submit-log-btn").disabled = false;
                    }
                };

                window.openSnoozeModal = (plantId) => {
                    getEl("snooze-plant-target").value = plantId;
                    getEl("snooze-custom-val").value = "";
                    toggleDisplay(getEl("snooze-modal"), true);
                };

                window.applySnooze = async (days) => {
                    const plantId = getEl("snooze-plant-target").value;
                    const duration = parseInt(days);
                    
                    if (!plantId || isNaN(duration) || duration <= 0) return showMsg("Invalid duration", "error");
                    
                    try {
                        const date = new Date(); 
                        date.setDate(date.getDate() + duration);
                        
                        await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { 
                            snoozeUntil: Timestamp.fromDate(date) 
                        });

                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId, type: "Snooze", date: new Date().toISOString(), 
                            notes: `Snoozed for ${duration} days`, 
                            createdAt: Timestamp.now()
                        });
                        
                        showMsg(`Snoozed for ${duration} days`);
                        toggleDisplay(getEl("snooze-modal"), false);
                    } catch(e) { showMsg(e.message, "error"); }
                };

                window.unsnoozePlant = async (plantId) => {
                    if (!confirm("Wake this plant up?")) return;
                    try {
                        await updateDoc(doc(db, `users/${state.user.uid}/plants`, plantId), { snoozeUntil: null });
                        
                        await addDoc(collection(db, `users/${state.user.uid}/plant_logs`), {
                            plantId, type: "Unsnooze", date: new Date().toISOString(), 
                            notes: "Manually woke up plant", createdAt: Timestamp.now()
                        });

                        showMsg("Snooze cancelled");
                    } catch (e) { showMsg(e.message, "error"); }
                };
                window.addStructure = async (type) => {
                    const location = getEl("layout-location-select").value;
                    if (!location) return showMsg("Please select a location first", "error");

                    try {
                        await addDoc(collection(db, `users/${state.user.uid}/garden_structures`), {
                            type, location, x: 50, y: 50, createdAt: Timestamp.now()
                        });
                    } catch(e) { showMsg(e.message, "error"); }
                };

                const deleteStructure = async (id) => {
                    if(confirm("Remove this item?")) {
                        await deleteDoc(doc(db, `users/${state.user.uid}/garden_structures`, id));
                    }
                };

                const themeDocRef = doc(db, 'users', user.uid, 'settings', 'theme');
                if (state.themeUnsubscribe) state.themeUnsubscribe();
                
                state.themeUnsubscribe = onSnapshot(themeDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const isDark = data.theme === 'dark';
                        if (state.nav) state.nav.applyTheme(isDark);
                    }
                });

                window.addEventListener('tab-changed', (e) => {
            // Safely extract the ID no matter what format the shared-nav.js uses
            const tabId = e.detail?.tabId || e.detail?.id || e.detail;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Unhide the target tab
            const target = getEl(`tab-content-${tabId}`);
            if (target) {
                target.classList.remove('hidden');
            } else {
                console.error("Whoops! Could not find a tab matching:", tabId);
            }
        });

                getEl("loading-state").classList.add("hidden");
                getEl("main-app-container").classList.remove("hidden");

                state.unsubPlants = onSnapshot(query(collection(db, `users/${user.uid}/plants`), orderBy("name")), snap => {
                    state.plants = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateLocationDropdowns();
                    renderPlants(); 
                    renderDashboard();
                    renderLayout(); 
                    renderGraveyard(); // Add this line!
                });

                state.unsubLocs = onSnapshot(collection(db, `users/${user.uid}/plant_locations`), snap => {
                    // Safe localeCompare in case a location is saved without a name
                    state.locations = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                    updateLocationDropdowns();
                    renderLocations();
                    renderPlants(); 
                    renderLayout(); 
                });

                state.unsubLogs = onSnapshot(query(collection(db, `users/${user.uid}/plant_logs`), orderBy("date", "desc")), snap => {
                    state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderDashboard(); renderHistory();
                });

                state.unsubStructs = onSnapshot(collection(db, `users/${user.uid}/garden_structures`), snap => {
                    state.structures = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderLayout();
                });

                state.unsubWish = onSnapshot(collection(db, `users/${user.uid}/wishlist`), snap => {
                    state.wishlist = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderWishlist();
                });

                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                getEl("log-date").value = now.toISOString().slice(0, 16);

            } else {
                window.location.href = '/';
            }
        });

        getEl("history-search").oninput = renderHistory;

        getEl("export-json-btn").onclick = () => {
            const blob = new Blob([JSON.stringify({plants: state.plants, logs: state.logs, locations: state.locations}, null, 2)], {type: "application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "plants_backup.json"; a.click();
        };
        getEl("export-csv-btn").onclick = () => {
            const csv = Papa.unparse(state.logs.map(l => ({
                date: l.date, plant: state.plants.find(p=>p.id===l.plantId)?.name, type: l.type, notes: l.notes
            })));
            const blob = new Blob([csv], {type: "text/csv"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "plant_logs.csv"; a.click();
        };

        document.getElementById("layout-location-select").addEventListener("change", renderLayout);
        // Add this line so the Garden tab filter actually triggers a re-render
        document.getElementById("plant-filter-location").addEventListener("change", renderPlants);
        document.getElementById("history-filter-location").addEventListener("change", renderHistory);
        document.getElementById("history-filter-plant").addEventListener("change", renderHistory);
    </script>
</body>
</html>
