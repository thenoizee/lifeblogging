<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightManagr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        yellow: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #f3f4f6; --card-bg: #ffffff; --text-primary: #1f2937; }
        .dark { --bg-color: #111827; --card-bg: #1f2937; --text-primary: #f9fafb; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            transition: background-color 0.3s, color 0.3s; 
        }

        /* --- CUSTOM SLIDERS --- */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        
        /* Thumb Style */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            margin-top: -8px;
            border: 2px solid white;
        }

        /* Brightness Track */
        .slider-bri::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: #e5e7eb; border-radius: 99px;
        }
        .dark .slider-bri::-webkit-slider-runnable-track { background: #374151; }

        /* Hue Rainbow Track */
        .slider-hue::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer;
            border-radius: 99px;
            background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
        }

        /* Temp Track */
        .slider-temp::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer;
            border-radius: 99px;
            background: linear-gradient(to right, #a1c4fd, #ffffff, #fbc2eb);
        }

        /* Card Glow & Transitions */
        .light-card { transition: all 0.3s ease; position: relative; overflow: hidden; }
        .light-card::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; 
            height: 4px; background: var(--light-color, transparent); transition: 0.3s; 
        }
        .light-on { 
            box-shadow: 0 4px 20px -5px var(--light-color-dim, rgba(251, 191, 36, 0.3)); 
            border-color: var(--light-color, #fbbf24); 
        }
        .light-off { opacity: 0.75; filter: grayscale(1); }

        .controls-container { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div id="setup-panel" class="hidden max-w-md mx-auto mt-20 px-4">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fa-solid fa-lightbulb"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Connect Hue</h1>
            <p class="text-gray-500 dark:text-gray-400">Control your lights from your LifeBlogging Hub</p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
            <div class="mb-6">
                <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-house-signal text-green-500"></i> Local (Fastest)
                </h3>
                <p class="text-xs text-gray-400 mb-3">Requires same Wi-Fi. Press button on bridge first.</p>
                <input id="bridge-ip" placeholder="Bridge IP (e.g. 192.168.1.50)" class="w-full mb-3 p-3 rounded-lg border bg-gray-50 dark:bg-gray-900 dark:border-gray-600 text-sm focus:ring-2 ring-yellow-500 outline-none transition">
                <button onclick="connectBridge()" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white py-3 rounded-lg font-bold transition">
                    Connect Locally
                </button>
            </div>
            
            <div class="text-center text-xs text-gray-400">
                To connect via Cloud, please go to the <a href="/account" class="text-blue-500 underline">Account Page</a>.
            </div>
        </div>
    </div>

    <div id="fade-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50">
                <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-stopwatch text-purple-500"></i> Fade Lights
                </h3>
                <button onclick="closeFadeModal()" class="w-8 h-8 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <input type="hidden" id="fade-target-id">
                <input type="hidden" id="fade-is-group">

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Duration (Minutes)</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="fade-duration" min="1" max="60" value="15" 
                               oninput="document.getElementById('dur-val').innerText = this.value + ' min'"
                               class="slider-bri w-full bg-gray-200 dark:bg-gray-600 h-2 rounded-full">
                        <span id="dur-val" class="text-sm font-mono w-16 text-right">15 min</span>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold text-gray-400 uppercase">Target Brightness</label>
                        <span id="fade-bri-val" class="text-xs font-mono text-gray-500">0% (Off)</span>
                    </div>
                    <input type="range" id="fade-bri" min="0" max="254" value="0" 
                           oninput="document.getElementById('fade-bri-val').innerText = Math.round((this.value/254)*100) + '%'"
                           class="slider-bri w-full bg-gray-200 dark:bg-gray-600 h-2 rounded-full">
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="use-fade-color" class="rounded text-purple-600 focus:ring-purple-500" onchange="toggleFadeColor(this.checked)">
                        <label for="use-fade-color" class="text-sm font-medium">Fade Color too?</label>
                    </div>
                    
                    <div id="fade-color-container" class="opacity-50 pointer-events-none transition-opacity">
                         <input type="range" id="fade-hue" min="0" max="65535" value="0" 
                                class="slider-hue w-full h-3 rounded-full">
                    </div>
                </div>
            </div>

            <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                <button onclick="closeFadeModal()" class="flex-1 py-2 rounded-lg font-medium text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition">Cancel</button>
                <button onclick="submitFade()" class="flex-1 py-2 rounded-lg font-bold bg-purple-500 hover:bg-purple-600 text-white shadow-lg shadow-purple-500/30 transition">Start Fade</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="container mx-auto px-4 md:px-6 hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 mt-6">
            <div class="flex items-center gap-3">
                <div id="connection-badge" class="px-3 py-1 rounded-full text-xs font-mono bg-gray-200 dark:bg-gray-800 text-gray-500">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Connecting...
                </div>
            </div>

            <div class="flex gap-2 w-full md:w-auto">
                <button id="btn-all-on" onclick="allLights(true)" class="flex-1 md:flex-none px-4 py-2 bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 rounded-lg font-bold hover:bg-yellow-200 dark:hover:bg-yellow-900/50 transition text-sm disabled:opacity-50">
                    All On
                </button>
                <button id="btn-all-off" onclick="allLights(false)" class="flex-1 md:flex-none px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition text-sm disabled:opacity-50">
                    All Off
                </button>
                <button onclick="refreshLights(true)" class="p-2 w-10 h-10 bg-white dark:bg-gray-800 shadow-sm border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </div>
        
        <div id="main-content" class="space-y-8">
             <div class="hidden" id="skeleton-loader">
                <div class="h-40 bg-gray-200 dark:bg-gray-800 rounded-2xl animate-pulse"></div>
            </div>
        </div>
    </div>

    <script type="module">
    import { AppNavigation } from '/shared-nav.js';
    import { changelogData } from '/changelog-data.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    // --- CONFIG ---
    const nav = new AppNavigation({
        appName: 'LightManagr',
        appIcon: 'fa-lightbulb',
        themeColor: 'yellow',
        version: (changelogData && changelogData[0]) ? changelogData[0].version : '1.0.0'
    });

    const firebaseConfig = {
        apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
        authDomain: "sammy-7298f.firebaseapp.com",
        projectId: "sammy-7298f",
        storageBucket: "sammy-7298f.firebasestorage.app",
        messagingSenderId: "963185683535",
        appId: "1:963185683535:web:807df8941feba46c208e3a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    const getEl = (id) => document.getElementById(id);
    let localConfig = JSON.parse(localStorage.getItem('hue_config')) || null;
    let cachedData = JSON.parse(localStorage.getItem('hue_cache_data')) || null;
    let isRemote = false;
    let debounceTimers = {};
    let isGlobalActionPending = false;

    // --- MATH HELPERS ---
    function hueSatToCss(hue, sat, bri) {
        const h = (hue / 65535) * 360;
        const s = (sat / 254) * 100;
        const l = 20 + ((bri / 254) * 40); 
        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    // --- CORE LOGIC ---
    async function init() {
        if (cachedData) {
            getEl('dashboard').classList.remove('hidden');
            renderData(cachedData);
            getEl('connection-badge').innerHTML = `<i class="fa-solid fa-bolt text-yellow-500"></i> Loaded (Cache)`;
        } else {
             getEl('dashboard').classList.remove('hidden');
             getEl('skeleton-loader').classList.remove('hidden');
        }

        if (localConfig && localConfig.ip) {
            refreshLights();
            return;
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const proxy = httpsCallable(functions, 'hueProxy');
                    const result = await proxy({ endpoint: 'config', method: 'GET' });
                    
                    if (result.data && !result.data.error) {
                        isRemote = true;
                        getEl('setup-panel').classList.add('hidden');
                        refreshLights();
                    } else {
                        if(!cachedData) getEl('setup-panel').classList.remove('hidden');
                    }
                } catch (e) {
                    if(!cachedData) getEl('setup-panel').classList.remove('hidden');
                }
            } else {
                if(!cachedData) getEl('setup-panel').classList.remove('hidden');
            }
        });

        // POLLING LOOP (Live Updates)
        setInterval(() => {
            if (!document.hidden && !isGlobalActionPending) {
                refreshLights();
            }
        }, 1000);
    }

    window.refreshLights = async (manual = false) => {
        try {
            if(manual) {
                const icon = document.querySelector('.fa-rotate');
                if(icon) icon.classList.add('fa-spin');
            }

            let lights, groups;
            
            if (isRemote) {
                getEl('connection-badge').innerHTML = `<i class="fa-solid fa-cloud text-blue-500"></i> Cloud`;
                const proxy = httpsCallable(functions, 'hueProxy');
                const resLights = await proxy({ endpoint: 'lights', method: 'GET' });
                lights = resLights.data;
                const resGroups = await proxy({ endpoint: 'groups', method: 'GET' });
                groups = resGroups.data;
            } else if (localConfig) {
                getEl('connection-badge').innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-yellow-500"></i> Syncing...`;
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);

                    const resL = await fetch(`http://${localConfig.ip}/api/${localConfig.username}/lights`, { signal: controller.signal });
                    if(!resL.ok) throw new Error("Hub unreachable");
                    lights = await resL.json();
                    
                    const resG = await fetch(`http://${localConfig.ip}/api/${localConfig.username}/groups`, { signal: controller.signal });
                    groups = await resG.json();
                    
                    clearTimeout(timeoutId);
                    
                    getEl('connection-badge').innerHTML = `<i class="fa-solid fa-wifi text-green-500"></i> Online`;
                    getEl('connection-badge').classList.remove('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                } catch (err) {
                    throw new Error("Hub Offline");
                }
            }
            
            if(lights) {
                const fullData = { lights, groups };
                localStorage.setItem('hue_cache_data', JSON.stringify(fullData));
                renderData(fullData);
            }
        } catch (e) { 
            console.error(e); 
            getEl('connection-badge').innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Hub Offline`;
            getEl('connection-badge').classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
        } finally {
             const icon = document.querySelector('.fa-rotate');
             if(icon) icon.classList.remove('fa-spin');
        }
    };

    // --- CONTROLS ---

    window.allLights = async (state) => {
        if (isGlobalActionPending) return;
        isGlobalActionPending = true;

        const btnOn = getEl('btn-all-on');
        const btnOff = getEl('btn-all-off');
        btnOn.disabled = true; btnOff.disabled = true;

        // Optimistic Update
        document.querySelectorAll('.light-card').forEach(c => {
            const btn = c.querySelector('.toggle-btn');
            const span = btn?.querySelector('span');
            if(state) { 
                c.classList.remove('light-off'); c.classList.add('light-on');
                btn?.classList.remove('bg-gray-300', 'dark:bg-gray-600'); btn?.classList.add('bg-green-500');
                if(span) span.style.transform = 'translateX(16px)';
            } else {
                c.classList.add('light-off'); c.classList.remove('light-on');
                btn?.classList.add('bg-gray-300', 'dark:bg-gray-600'); btn?.classList.remove('bg-green-500');
                if(span) span.style.transform = 'translateX(0)';
            }
        });

        try {
            if (isRemote) {
                const proxy = httpsCallable(functions, 'hueProxy');
                await proxy({ endpoint: 'groups/0/action', method: 'PUT', body: { on: state } });
            } else if (localConfig) {
                await fetch(`http://${localConfig.ip}/api/${localConfig.username}/groups/0/action`, {
                    method: 'PUT', body: JSON.stringify({ on: state })
                });
            }
        } catch (e) { alert("Command failed"); } 
        finally {
            setTimeout(() => {
                isGlobalActionPending = false;
                btnOn.disabled = false; btnOff.disabled = false;
                refreshLights(); // Force sync after global action
            }, 1000);
        }
    };

    window.updateState = (id, body, isGroup = false) => {
        if(debounceTimers[id]) clearTimeout(debounceTimers[id]);
        
        debounceTimers[id] = setTimeout(async () => {
            const endpoint = isGroup ? `groups/${id}/action` : `lights/${id}/state`;
            
            if (isRemote) {
                const proxy = httpsCallable(functions, 'hueProxy');
                await proxy({ endpoint: endpoint, method: 'PUT', body: body });
            } else {
                await fetch(`http://${localConfig.ip}/api/${localConfig.username}/${endpoint}`, {
                    method: 'PUT', body: JSON.stringify(body)
                });
            }
        }, 400); 
    };

    window.handleToggle = (id, newState, isGroup = false) => {
        // UI updates are handled by renderData polling, but we do optimistic update here if needed
        const card = document.getElementById(`card-${id}`);
        if(card) {
             const btn = card.querySelector('.toggle-btn');
             const span = btn.querySelector('span');
             const controls = card.querySelector('.controls-container');
             if(newState) { 
                card.classList.remove('light-off'); card.classList.add('light-on');
                btn.classList.remove('bg-gray-300', 'dark:bg-gray-600'); btn.classList.add('bg-green-500');
                span.style.transform = 'translateX(16px)';
                controls.classList.remove('opacity-50', 'pointer-events-none');
            } else { 
                card.classList.add('light-off'); card.classList.remove('light-on'); 
                btn.classList.add('bg-gray-300', 'dark:bg-gray-600'); btn.classList.remove('bg-green-500');
                span.style.transform = 'translateX(0)';
                controls.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        window.updateState(id, { on: newState }, isGroup);
    };

    window.handleHue = (id, hueVal, isGroup = false) => {
        const card = document.getElementById(`card-${id}`);
        if(card) {
             const color = hueSatToCss(hueVal, 254, 127);
             card.style.setProperty('--light-color', color);
        }
        window.updateState(id, { hue: parseInt(hueVal), sat: 254 }, isGroup);
    };

    window.handleBri = (id, val, isGroup = false) => {
        const label = document.getElementById(`bri-label-${id}`);
        if(label) label.innerText = Math.round((val/254)*100) + '%';
        window.updateState(id, { bri: parseInt(val) }, isGroup);
    };

    window.handleTemp = (id, mireds, isGroup = false) => {
        window.updateState(id, { ct: parseInt(mireds) }, isGroup);
    };

    // --- FADE LOGIC ---
    window.openFadeModal = (id, isGroup, currentBri, currentHue) => {
        getEl('fade-target-id').value = id;
        getEl('fade-is-group').value = isGroup;
        getEl('fade-modal').classList.remove('hidden');
        
        // Reset defaults
        getEl('use-fade-color').checked = false;
        toggleFadeColor(false);
    }

    window.closeFadeModal = () => {
        getEl('fade-modal').classList.add('hidden');
    }

    window.toggleFadeColor = (checked) => {
        const container = getEl('fade-color-container');
        if(checked) {
            container.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            container.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    window.submitFade = async () => {
        const id = getEl('fade-target-id').value;
        const isGroup = getEl('fade-is-group').value === 'true';
        const durationMins = parseInt(getEl('fade-duration').value);
        const targetBri = parseInt(getEl('fade-bri').value);
        const useColor = getEl('use-fade-color').checked;
        const targetHue = parseInt(getEl('fade-hue').value);

        // API Transition Time: 1 = 100ms.
        // 1 min = 60000ms = 600 units.
        const transitionTime = durationMins * 600;

        const body = {
            on: true, // Ensure it turns/stays on
            bri: targetBri,
            transitiontime: transitionTime
        };

        if(useColor) {
            body.hue = targetHue;
            body.sat = 254; // Assume full saturation for fade
        }

        window.updateState(id, body, isGroup);
        closeFadeModal();
        alert(`Fading over ${durationMins} minutes...`);
    }

    // --- RENDERER ---
    function getHueDeviceMeta(item, isGroup) {
        let icon = 'fa-lightbulb';
        let label = 'Smart Light';

        if (isGroup) {
            // Hue uses 'class' for room types (e.g., 'Living room', 'Bedroom')
            label = item.class || item.type || 'Group'; 
            const classStr = (item.class || '').toLowerCase();
            
            if (classStr.includes('tv') || classStr.includes('living')) icon = 'fa-tv';
            else if (classStr.includes('kitchen')) icon = 'fa-kitchen-set';
            else if (classStr.includes('bed')) icon = 'fa-bed';
            else if (classStr.includes('bath')) icon = 'fa-bath';
            else if (classStr.includes('office') || classStr.includes('computer')) icon = 'fa-desktop';
            else if (classStr.includes('garden') || classStr.includes('outdoor')) icon = 'fa-tree';
            else if (item.type === 'Zone') icon = 'fa-chart-pie';
            else icon = 'fa-layer-group';
        } else {
            label = item.productname || item.type || 'Light';
            const typeStr = (item.type || '').toLowerCase();
            const prodStr = (item.productname || '').toLowerCase();
            
            if (typeStr.includes('plug') || prodStr.includes('plug')) {
                icon = 'fa-plug';
                label = 'Smart Plug';
            } else if (typeStr.includes('strip') || prodStr.includes('strip')) {
                icon = 'fa-tape';
            } else if (prodStr.includes('play')) {
                icon = 'fa-tv';
            } else if (prodStr.includes('spot') || prodStr.includes('gu10')) {
                icon = 'fa-bullseye';
            }
        }
        return { icon, label };
    }

    function createCardHTML(id, item, isGroup) {
        const state = isGroup ? item.action : item.state;
        const isOn = state.on;
        
        // Smart handling for missing properties (e.g. Smart Plugs don't have brightness)
        const canBri = state.bri !== undefined;
        let canColor = false;
        let canTemp = false;
        if (state.hue !== undefined) canColor = true;
        if (state.ct !== undefined) canTemp = true;
        
        const bri = state.bri || 254;
        const hue = state.hue || 0;
        const sat = state.sat || 0;
        const ct = state.ct || 370;
        
        // Groups don't have reachable state, only individual lights do
        const isReachable = isGroup ? true : (item.state.reachable !== false); 

        let glowColor = '#fbbf24';
        if (isOn && state.colormode === 'hs') {
            glowColor = hueSatToCss(hue, sat, bri);
        } else if (isOn && state.colormode === 'ct') {
            glowColor = ct < 300 ? '#dcf4ff' : '#ffb76b';
        }

        const meta = getHueDeviceMeta(item, isGroup);
        const offlineBadge = !isReachable ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10">Offline</span>` : '';

        return `
            <div id="card-${id}" 
                 style="--light-color: ${glowColor}; --light-color-dim: ${glowColor}4D"
                 class="light-card bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 ${isOn && isReachable ? 'light-on' : 'light-off'} relative">
                
                ${offlineBadge}

                <div class="flex justify-between items-start mb-6">
                    <div class="flex items-center gap-3 w-3/4">
                        <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-xl flex-shrink-0">
                            <i class="fa-solid ${meta.icon} text-gray-400"></i>
                        </div>
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-gray-900 dark:text-white leading-tight truncate pr-2" title="${item.name}">${item.name}</h3>
                            <span class="text-xs text-gray-400 font-medium truncate block" title="${meta.label}">${meta.label}</span>
                        </div>
                    </div>
                    
                    <button onclick="window.handleToggle('${id}', ${!isOn}, ${isGroup})" 
                        ${!isReachable ? 'disabled' : ''}
                        class="toggle-btn w-12 h-8 rounded-full transition-colors relative flex-shrink-0 ${isOn ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'} ${!isReachable ? 'opacity-50 cursor-not-allowed' : ''}">
                        <span class="absolute top-1 left-1 bg-white w-6 h-6 rounded-full shadow-sm transition-transform duration-200" style="transform: ${isOn ? 'translateX(16px)' : 'translateX(0)'}"></span>
                    </button>
                </div>

                <div class="controls-container space-y-5 ${(!isOn || !isReachable) ? 'opacity-50 pointer-events-none' : ''}">
                    ${canBri ? `
                    <div>
                        <div class="flex justify-between text-xs text-gray-400 mb-1 font-bold uppercase">
                            <span>Brightness</span>
                            <span id="bri-label-${id}">${Math.round((bri/254)*100)}%</span>
                        </div>
                        <input type="range" min="1" max="254" value="${bri}" 
                            oninput="window.handleBri('${id}', this.value, ${isGroup})"
                            class="slider-bri w-full bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                    </div>
                    ` : ''}

                    ${canColor ? `
                    <div>
                         <label class="text-xs text-gray-400 font-bold uppercase mb-1 block">Color</label>
                         <input type="range" min="0" max="65535" value="${hue}" 
                             oninput="window.handleHue('${id}', this.value, ${isGroup})"
                             class="slider-hue w-full appearance-none">
                    </div>
                    ` : ''}

                    ${canTemp && !canColor ? `
                    <div>
                         <label class="text-xs text-gray-400 font-bold uppercase mb-1 block">Warmth</label>
                         <input type="range" min="153" max="500" value="${ct}" 
                             oninput="window.handleTemp('${id}', this.value, ${isGroup})"
                             class="slider-temp w-full appearance-none">
                    </div>
                    ` : ''}

                    <div class="pt-2 border-t border-gray-100 dark:border-gray-700 flex justify-end">
                        <button onclick="window.openFadeModal('${id}', ${isGroup}, ${bri}, ${hue})" 
                                ${!canBri ? 'disabled class="hidden"' : `class="text-xs font-bold text-purple-500 hover:text-purple-600 dark:hover:text-purple-400 flex items-center gap-1 bg-purple-50 dark:bg-purple-900/30 px-3 py-1.5 rounded-lg transition"`}>
                            <i class="fa-solid fa-stopwatch"></i> Fade / Sleep
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderData(data) {
        const container = getEl('main-content');
        getEl('skeleton-loader')?.classList.add('hidden');
        
        let html = '';

        if(data.groups && Object.keys(data.groups).length > 0) {
            html += `<h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-layer-group text-yellow-500"></i> Rooms & Groups</h2>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8">`;
            html += Object.entries(data.groups).map(([id, group]) => createCardHTML(id, group, true)).join('');
            html += `</div>`;
        }

        if(data.lights && Object.keys(data.lights).length > 0) {
            html += `<h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-lightbulb text-yellow-500"></i> Individual Lights</h2>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">`;
            html += Object.entries(data.lights).map(([id, light]) => createCardHTML(id, light, false)).join('');
            html += `</div>`;
        }

        container.innerHTML = html;
    }

    init();
    </script>
</body>
</html>