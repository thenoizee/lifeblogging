<!DOCTYPE html>
<html>
<head>
    <title>Connecting...</title>
    <style> body { font-family: sans-serif; padding: 2rem; line-height: 1.5; } </style>
</head>
<body>
    <h1>Connecting to Hue...</h1>
    <p id="status">Initializing...</p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const status = document.getElementById('status');
        function log(msg) { status.innerHTML += "<br> -> " + msg; console.log(msg); }

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        log("Starting Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        log("Waiting for user login...");
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log("User confirmed: " + user.email);
                
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code) {
                    log("Authorization Code found. Exchanging with backend...");
                    const exchange = httpsCallable(functions, 'hueTokenExchange');
                    
                    exchange({ code: code })
                        .then((result) => {
                            log("Success! Redirecting...");
                            setTimeout(() => window.location.href = '/huemanagr', 1000);
                        })
                        .catch(err => {
                            log("❌ ERROR: " + err.message);
                            log("Check the console (F12) for more details.");
                        });
                } else {
                    log("❌ ERROR: No 'code' found in URL.");
                }
            } else {
                log("⚠️ No user found. You are not logged in.");
                log("<a href='/'>Click here to go to Login Page</a>");
            }
        });
    </script>
</body>
</html>