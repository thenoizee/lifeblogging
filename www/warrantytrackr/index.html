<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WarrantyTrackr</title>
    <link rel="icon" href="/favicons/shield-alt.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker registered successfully:', registration))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg-color: white;
            --text-color-primary: #111827;
            --text-color-secondary: #4b5563;
            --input-bg-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --modal-overlay-color: rgba(0, 0, 0, 0.5);
        }
        .dark {
            --bg-color: #111827;
            --card-bg-color: #1f2937;
            --text-color-primary: #f9fafb;
            --text-color-secondary: #9ca3af;
            --input-bg-color: #374151;
            --border-color: #4b5563;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --modal-overlay-color: rgba(0, 0, 0, 0.7);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .form-input, .form-select, .form-textarea {
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color-primary);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
            border-color: transparent;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }
        
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
        .modal-leave { opacity: 1; transform: scale(1); }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <main>
            <div class="bg-[var(--card-bg-color)] shadow-lg rounded-xl p-6 md:p-8">
                 <div id="dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                    <div class="p-4 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                        <p class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Items</p>
                        <p id="total-warranties" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-green-100 dark:bg-green-900/50 rounded-lg">
                        <p class="text-sm font-medium text-green-600 dark:text-green-300">Active</p>
                        <p id="active-warranties" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-orange-100 dark:bg-orange-900/50 rounded-lg">
                        <p class="text-sm font-medium text-orange-600 dark:text-orange-300">Expiring Soon</p>
                        <p id="expiring-warranties" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-red-100 dark:bg-red-900/50 rounded-lg">
                        <p class="text-sm font-medium text-red-600 dark:text-red-300">Expired</p>
                        <p id="expired-warranties" class="text-3xl font-bold">0</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                    <div class="flex gap-2 flex-wrap justify-center">
                         <button id="add-warranty-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i> Add Warranty
                        </button>
                        <button id="import-devices-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center justify-center gap-2 relative">
                            <i class="fas fa-download"></i> Import Devices
                            <span id="import-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center" style="display: none;"></span>
                        </button>
                    </div>

                    <div class="w-full md:w-auto flex flex-col sm:flex-row gap-2">
                         <select id="category-filter" class="form-select rounded-lg w-full md:w-auto cursor-pointer">
                            <option value="all">All Categories</option>
                        </select>
                        <select id="sort-by" class="form-select rounded-lg w-full md:w-auto cursor-pointer">
                            <option value="expiryDate-asc">Expires Soonest</option>
                            <option value="expiryDate-desc">Expires Latest</option>
                            <option value="productName-asc">Name (A-Z)</option>
                            <option value="productName-desc">Name (Z-A)</option>
                            <option value="purchaseDate-desc">Newest First</option>
                            <option value="purchaseDate-asc">Oldest First</option>
                        </select>
                    </div>
                </div>

                <div id="warranty-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                
                <div id="loading-state" class="text-center py-10 text-[var(--text-color-secondary)]" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading warranties...</p>
                </div>
                <div id="empty-state" class="text-center py-10 text-[var(--text-color-secondary)]" style="display: none;">
                    <i class="fas fa-file-alt fa-3x mb-4 text-gray-400"></i>
                    <h3 class="text-xl font-semibold text-[var(--text-color-primary)]">No Warranties Yet</h3>
                    <p>Click "Add Warranty" to get started.</p>
                </div>
                 <div id="auth-state" class="text-center py-10 text-[var(--text-color-secondary)]" style="display: none;">
                    <i class="fas fa-lock fa-3x mb-4 text-gray-400"></i>
                    <h3 class="text-xl font-semibold text-[var(--text-color-primary)]">Please Sign In</h3>
                    <p>You need to be signed in at the Hub to use this app.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="warranty-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="fixed inset-0 bg-[var(--modal-overlay-color)] transition-opacity duration-300"></div>
        <div id="modal-content" class="relative bg-[var(--card-bg-color)] rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-8 modal-enter">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Warranty</h2>
            <form id="warranty-form">
                <input type="hidden" id="warranty-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block mb-1 font-medium">Product Name</label>
                        <input type="text" id="product-name" class="form-input w-full rounded-lg" required>
                    </div>
                     <div>
                        <label for="category" class="block mb-1 font-medium">Category</label>
                        <input type="text" id="category" class="form-input w-full rounded-lg" placeholder="e.g., Electronics, Kitchen">
                    </div>
                    <div>
                        <label for="purchase-date" class="block mb-1 font-medium">Purchase Date</label>
                        <input type="date" id="purchase-date" class="form-input w-full rounded-lg" required>
                    </div>
                    <div>
                        <label for="warranty-length" class="block mb-1 font-medium">Warranty Length</label>
                        <div class="flex gap-2">
                            <input type="number" id="warranty-length" class="form-input w-full rounded-lg" min="0" value="1">
                            <select id="warranty-unit" class="form-select rounded-lg">
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                                <option value="months">Months</option>
                                <option value="years" selected>Years</option>
                                <option value="lifetime">Lifetime</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="retailer" class="block mb-1 font-medium">Retailer / Store</label>
                        <input type="text" id="retailer" class="form-input w-full rounded-lg">
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/30 p-3 rounded-lg border border-dashed border-[var(--border-color)]">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="registered-online" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                            <label for="registered-online" class="font-medium select-none cursor-pointer">Warranty Registered Online?</label>
                        </div>
                        <div id="registration-details" class="space-y-3 hidden">
                            <div>
                                <label for="registered-by" class="block mb-1 text-sm text-[var(--text-color-secondary)]">Registered By (Name)</label>
                                <input type="text" id="registered-by" class="form-input w-full rounded-lg text-sm" placeholder="e.g., John Doe">
                            </div>
                            <div>
                                <label for="registration-link" class="block mb-1 text-sm text-[var(--text-color-secondary)]">Registration Link / Portal</label>
                                <input type="url" id="registration-link" class="form-input w-full rounded-lg text-sm" placeholder="https://...">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="notes" class="block mb-1 font-medium">Notes (e.g., order number)</label>
                        <textarea id="notes" rows="3" class="form-textarea w-full rounded-lg"></textarea>
                    </div>
                    <div>
                        <label for="file-upload" class="block mb-1 font-medium">Attachments (Receipt, Photo, etc.)</label>
                        <input type="file" id="file-upload" class="form-input w-full rounded-lg" multiple>
                        <div id="file-list" class="mt-2 space-y-2"></div>
                        <div id="upload-progress" class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2" style="display: none;">
                            <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Save Warranty</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="import-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="fixed inset-0 bg-[var(--modal-overlay-color)] transition-opacity duration-300"></div>
        <div id="import-modal-content" class="relative bg-[var(--card-bg-color)] rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto p-8 modal-enter">
            <h2 class="text-2xl font-bold mb-6">Import from RecipeManagr</h2>
            <div id="import-list" class="space-y-3"></div>
             <div class="flex justify-end gap-4 mt-8">
                <button type="button" id="import-cancel-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Close</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-lg shadow-lg text-white font-semibold transition-transform duration-300 translate-y-[-150%]" role="alert"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { AppNavigation } from '../shared-nav.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userId = null;
        let warrantiesUnsubscribe = null;
        let devicesUnsubscribe = null;
        let themeUnsubscribe = null;
        let warranties = [];
        let recipeManagerDevices = [];

        // DOM Elements
        const warrantyList = document.getElementById('warranty-list');
        const addWarrantyBtn = document.getElementById('add-warranty-btn');
        const warrantyModal = document.getElementById('warranty-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const warrantyForm = document.getElementById('warranty-form');
        const cancelBtn = document.getElementById('cancel-btn');
        const warrantyIdInput = document.getElementById('warranty-id');
        const productNameInput = document.getElementById('product-name');
        const purchaseDateInput = document.getElementById('purchase-date');
        const warrantyLengthInput = document.getElementById('warranty-length');
        const warrantyUnitInput = document.getElementById('warranty-unit');
        const retailerInput = document.getElementById('retailer');
        const categoryInput = document.getElementById('category');
        const notesInput = document.getElementById('notes');
        const sortBySelect = document.getElementById('sort-by');
        const categoryFilterSelect = document.getElementById('category-filter');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const authState = document.getElementById('auth-state');
        const messageBox = document.getElementById('message-box');
        const importDevicesBtn = document.getElementById('import-devices-btn');
        const importModal = document.getElementById('import-modal');
        const importModalContent = document.getElementById('import-modal-content');
        const importList = document.getElementById('import-list');
        const importCancelBtn = document.getElementById('import-cancel-btn');
        const importBadge = document.getElementById('import-badge');
        const registeredOnlineCheckbox = document.getElementById('registered-online');
        const registrationDetailsDiv = document.getElementById('registration-details');
        const registeredByInput = document.getElementById('registered-by');
        const registrationLinkInput = document.getElementById('registration-link');

        const nav = new AppNavigation({
            appName: 'WarrantyTrackr',
            appIcon: 'fa-shield-alt',
            themeColor: 'emerald',
            version: 'v10.13.0',
            userEmail: null,
            tabs: [ { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-pie' } ],
            activeTab: 'dashboard',
            search: { id: 'nav-search', placeholder: 'Search warranties...' },
            onThemeChange: async (newTheme) => {
                if (userId) await setDoc(doc(db, 'users', userId, 'settings', 'theme'), { theme: newTheme }, { merge: true });
            }
        });

        const navSearch = document.getElementById('nav-search');
        if (navSearch) navSearch.addEventListener('input', () => renderWarranties());

        // --- UPLOAD HELPER ---
        async function uploadFiles(files, userId) {
            if (!files.length) return [];
            const uploadedFiles = [];
            const progressBar = document.getElementById('upload-progress');
            const progressBarInner = document.getElementById('upload-progress-bar');
            progressBar.style.display = 'block';
            progressBarInner.style.width = '10%';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileRef = ref(storage, `users/${userId}/warranties/${Date.now()}_${file.name}`);
                try {
                    const snapshot = await uploadBytes(fileRef, file);
                    const url = await getDownloadURL(snapshot.ref);
                    uploadedFiles.push({
                        name: file.name,
                        path: snapshot.ref.fullPath,
                        type: file.type,
                        url: url
                    });
                    progressBarInner.style.width = `${((i + 1) / files.length) * 100}%`;
                } catch (error) {
                    console.error("Upload failed for:", file.name, error);
                }
            }
            setTimeout(() => { progressBar.style.display = 'none'; progressBarInner.style.width = '0%'; }, 500);
            return uploadedFiles;
        }

        // --- MODALS ---
        const openModal = (mode = 'add', data = null) => {
            warrantyForm.reset();
            purchaseDateInput.valueAsDate = new Date();
            registrationDetailsDiv.classList.add('hidden');
            document.getElementById('file-upload').value = '';

            if (mode === 'add') {
                modalTitle.textContent = 'Add New Warranty';
                warrantyIdInput.value = '';
                if(data && data.productName) productNameInput.value = data.productName;
            } else { 
                modalTitle.textContent = 'Edit Warranty';
                warrantyIdInput.value = data.id;
                productNameInput.value = data.productName;
                purchaseDateInput.value = data.purchaseDate;
                warrantyLengthInput.value = data.warrantyLength;
                warrantyUnitInput.value = data.warrantyUnit;
                retailerInput.value = data.retailer || '';
                categoryInput.value = data.category || '';
                notesInput.value = data.notes || '';
                
                if (data.registeredOnline) {
                    registeredOnlineCheckbox.checked = true;
                    registrationDetailsDiv.classList.remove('hidden');
                    registeredByInput.value = data.registeredBy || '';
                    registrationLinkInput.value = data.registrationLink || '';
                }
            }
            warrantyModal.style.display = 'flex';
            setTimeout(() => modalContent.classList.add('modal-enter-active'), 10);
        };
        
        const closeModal = () => {
            modalContent.classList.remove('modal-enter-active');
            modalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                warrantyModal.style.display = 'none';
                modalContent.classList.remove('modal-leave-active');
            }, 300);
        };
        
        const openImportModal = () => {
            importModal.style.display = 'flex';
            setTimeout(() => importModalContent.classList.add('modal-enter-active'), 10);
        };
        const closeImportModal = () => {
            importModalContent.classList.remove('modal-enter-active');
            importModalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                importModal.style.display = 'none';
                importModalContent.classList.remove('modal-leave-active');
            }, 300);
        };

        addWarrantyBtn.addEventListener('click', () => openModal('add'));
        cancelBtn.addEventListener('click', closeModal);
        warrantyModal.addEventListener('click', (e) => { if (e.target === warrantyModal) closeModal(); });
        importDevicesBtn.addEventListener('click', openImportModal);
        importCancelBtn.addEventListener('click', closeImportModal);
        importModal.addEventListener('click', (e) => { if (e.target === importModal) closeImportModal(); });
        warrantyUnitInput.addEventListener('change', () => { warrantyLengthInput.disabled = warrantyUnitInput.value === 'lifetime'; });
        registeredOnlineCheckbox.addEventListener('change', () => { registrationDetailsDiv.classList.toggle('hidden', !registeredOnlineCheckbox.checked); });

        const applyTheme = (theme) => {
            if (theme === 'dark') { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
            else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
        };

        // --- DATA & RENDERING ---
        const calculateExpiry = (purchaseDateStr, length, unit) => {
            if (unit === 'lifetime') return null;
            const date = new Date(purchaseDateStr);
            if (isNaN(date.getTime())) return null;
            if (unit === 'days') date.setDate(date.getDate() + parseInt(length));
            if (unit === 'weeks') date.setDate(date.getDate() + parseInt(length) * 7);
            if (unit === 'months') date.setMonth(date.getMonth() + parseInt(length));
            if (unit === 'years') date.setFullYear(date.getFullYear() + parseInt(length));
            return date;
        };
        
        const getStatus = (expiryDate) => {
            if (expiryDate === null) return { text: 'Lifetime', color: 'blue', days: Infinity };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = expiryDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: 'Expired', color: 'red', days: diffDays };
            if (diffDays <= 30) return { text: 'Expires Soon', color: 'orange', days: diffDays };
            return { text: 'Active', color: 'green', days: diffDays };
        };

        const renderAttachments = (files) => {
            if (!files || files.length === 0) return '';
            return `
                <div class="mt-3 pt-3 border-t border-dashed border-gray-200 dark:border-gray-700">
                    <p class="text-xs font-semibold text-[var(--text-color-secondary)] mb-2">Attachments:</p>
                    <div class="flex flex-wrap gap-2">
                        ${files.map(f => `
                            <a href="${f.url}" target="_blank" class="flex items-center gap-1 text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-100 dark:bg-indigo-900/50 dark:text-indigo-300">
                                <i class="fas fa-paperclip"></i> ${f.name.length > 15 ? f.name.substring(0, 12)+'...' : f.name}
                            </a>
                        `).join('')}
                    </div>
                </div>`;
        };

        const renderWarranties = () => {
            if (!userId) {
                warrantyList.innerHTML = '';
                authState.style.display = 'block';
                emptyState.style.display = 'none';
                loadingState.style.display = 'none';
                return;
            }

            // Stats
            document.getElementById('total-warranties').textContent = warranties.length;
            document.getElementById('active-warranties').textContent = warranties.filter(w => w.status.color !== 'red').length;
            document.getElementById('expiring-warranties').textContent = warranties.filter(w => w.status.color === 'orange').length;
            document.getElementById('expired-warranties').textContent = warranties.filter(w => w.status.color === 'red').length;

            authState.style.display = 'none';
            if (warranties.length === 0) {
                emptyState.style.display = 'block';
                warrantyList.innerHTML = '';
                return;
            }
            emptyState.style.display = 'none';

            // Populate Category Filter
            const categories = [...new Set(warranties.map(w => w.category).filter(Boolean))].sort();
            if (categoryFilterSelect.options.length - 1 !== categories.length) {
                const currentSelection = categoryFilterSelect.value;
                categoryFilterSelect.innerHTML = '<option value="all">All Categories</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilterSelect.appendChild(option);
                });
                categoryFilterSelect.value = currentSelection;
            }

            const searchTerm = document.getElementById('nav-search')?.value.toLowerCase() || '';
            const categoryFilter = categoryFilterSelect.value;
            const [sortField, sortOrder] = sortBySelect.value.split('-');

            const filteredWarranties = [...warranties]
                .filter(w => {
                    const matchesSearch = w.productName.toLowerCase().includes(searchTerm);
                    const matchesCategory = categoryFilter === 'all' || w.category === categoryFilter;
                    return matchesSearch && matchesCategory;
                })
                .sort((a, b) => {
                    let valA, valB;
                    if (sortField === 'expiryDate') { valA = a.status.days; valB = b.status.days; } 
                    else if (sortField === 'productName') { valA = a.productName.toLowerCase(); valB = b.productName.toLowerCase(); } 
                    else { valA = new Date(a.purchaseDate); valB = new Date(b.purchaseDate); }
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

            warrantyList.innerHTML = filteredWarranties.map(w => {
                const expiryDate = calculateExpiry(w.purchaseDate, w.warrantyLength, w.warrantyUnit);
                const registrationBadge = w.registeredOnline 
                    ? `<p class="text-green-600 dark:text-green-400 font-medium text-xs mt-1"><i class="fas fa-check-circle"></i> Registered ${w.registrationLink ? `<a href="${w.registrationLink}" target="_blank" class="underline ml-1">(View)</a>` : ''}</p>` 
                    : `<p class="text-gray-400 text-xs mt-1"><i class="far fa-circle"></i> Not registered</p>`;
                
                const status = getStatus(expiryDate);
                const statusColors = { red: 'border-red-500 bg-red-50 dark:bg-red-500/10', orange: 'border-orange-500 bg-orange-50 dark:bg-orange-500/10', green: 'border-green-500 bg-green-50 dark:bg-green-500/10', blue: 'border-blue-500 bg-blue-50 dark:bg-blue-500/10' };
                const statusTextColors = { red: 'text-red-600 dark:text-red-400', orange: 'text-orange-600 dark:text-orange-400', green: 'text-green-600 dark:text-green-400', blue: 'text-blue-600 dark:text-blue-400' };
                const expiryText = status.text === 'Lifetime' ? 'Lifetime Warranty' : `Expires: ${expiryDate.toLocaleDateString()}`;
                let daysText = status.text === 'Expired' ? `Expired ${-status.days} days ago` : (status.text === 'Lifetime' ? '' : `${status.days} days remaining`);

                return `
                    <div class="border-l-4 ${statusColors[status.color]} p-5 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg leading-tight">${w.productName}</h3>
                                ${w.category ? `<span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded-full">${w.category}</span>` : ''}
                            </div>
                            <p class="text-sm text-[var(--text-color-secondary)]">${w.retailer || 'Retailer not specified'}</p>
                            ${registrationBadge}
                            <div class="mt-4 space-y-2 text-sm">
                                <p><i class="fas fa-calendar-alt w-5 text-gray-400"></i> Purchased: ${new Date(w.purchaseDate).toLocaleDateString()}</p>
                                <p><i class="fas fa-calendar-check w-5 text-gray-400"></i> ${expiryText}</p>
                                ${w.notes ? `<p class="break-words"><i class="fas fa-info-circle w-5 text-gray-400"></i> ${w.notes}</p>` : ''}
                            </div>
                            ${renderAttachments(w.attachments)}
                        </div>
                        <div class="mt-4 pt-4 border-t border-[var(--border-color)] flex justify-between items-center">
                            <span class="font-semibold ${statusTextColors[status.color]}">${daysText}</span>
                            <div class="flex gap-2">
                                <button class="edit-btn text-blue-500 hover:text-blue-700" data-id="${w.id}"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn text-red-500 hover:text-red-700" data-id="${w.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        };
        
        sortBySelect.addEventListener('change', renderWarranties);
        categoryFilterSelect.addEventListener('change', renderWarranties);
        
        const renderImportModal = (untrackedDevices) => {
            if(untrackedDevices.length > 0) {
                importBadge.textContent = untrackedDevices.length;
                importBadge.style.display = 'flex';
                importList.innerHTML = untrackedDevices.map(device => `
                    <div class="flex justify-between items-center p-2 rounded-lg bg-[var(--input-bg-color)]">
                        <span>${device.name}</span>
                        <button class="track-device-btn bg-green-500 text-white px-3 py-1 text-sm rounded-md hover:bg-green-600" data-name="${device.name}">Track</button>
                    </div>`).join('');
            } else {
                importBadge.style.display = 'none';
                importList.innerHTML = '<p class="text-[var(--text-color-secondary)] text-center">All devices from RecipeManagr are tracked.</p>';
            }
        };
        
        importList.addEventListener('click', (e) => {
            if (e.target.classList.contains('track-device-btn')) {
                closeImportModal();
                openModal('add', { productName: e.target.dataset.name });
            }
        });

        const findAndRenderUntrackedDevices = () => {
            if (!userId || !warranties || !recipeManagerDevices) return;
            const trackedNames = new Set(warranties.map(w => w.productName.toLowerCase().trim()));
            const untracked = recipeManagerDevices.filter(d => !trackedNames.has(d.name.toLowerCase().trim()));
            renderImportModal(untracked);
        };

        // --- FIRESTORE ---
        warrantyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = warrantyForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;
            submitBtn.innerText = 'Saving...';
            submitBtn.disabled = true;

            const id = warrantyIdInput.value;
            const fileInput = document.getElementById('file-upload');

            try {
                let newAttachments = [];
                if (fileInput.files.length > 0) {
                    newAttachments = await uploadFiles(fileInput.files, userId);
                }

                const data = { 
                    productName: productNameInput.value, 
                    purchaseDate: purchaseDateInput.value, 
                    warrantyLength: parseInt(warrantyLengthInput.value, 10), 
                    warrantyUnit: warrantyUnitInput.value, 
                    retailer: retailerInput.value, 
                    category: categoryInput.value,
                    notes: notesInput.value,
                    registeredOnline: registeredOnlineCheckbox.checked,
                    registeredBy: registeredOnlineCheckbox.checked ? registeredByInput.value : null,
                    registrationLink: registeredOnlineCheckbox.checked ? registrationLinkInput.value : null,
                    updatedAt: serverTimestamp()
                };

                if (id) {
                    if (newAttachments.length > 0) {
                        const existingDoc = warranties.find(w => w.id === id);
                        data.attachments = [...(existingDoc.attachments || []), ...newAttachments];
                    }
                    await updateDoc(doc(db, 'users', userId, 'warranties', id), data);
                    showMessage('Warranty updated!');
                } else {
                    data.createdAt = serverTimestamp();
                    data.attachments = newAttachments;
                    await addDoc(collection(db, 'users', userId, 'warranties'), data);
                    showMessage('Warranty added!');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving warranty: ", error);
                showMessage('Failed to save warranty.', 'error');
            } finally {
                submitBtn.innerText = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        warrantyList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (editBtn) openModal('edit', warranties.find(w => w.id === editBtn.dataset.id));
            if (deleteBtn && confirm('Delete this warranty?')) {
                deleteDoc(doc(db, 'users', userId, 'warranties', deleteBtn.dataset.id))
                    .then(() => showMessage('Warranty deleted.'))
                    .catch(() => showMessage('Failed to delete.', 'error'));
            }
        });
        
        function showMessage(message, type = 'success', timeout = 3000) {
            messageBox.textContent = message;
            messageBox.className = `fixed top-5 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-lg shadow-lg text-white font-semibold transition-transform duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.style.transform = 'translate(-50%, 0%)';
            if (timeout > 0) { setTimeout(() => { messageBox.style.transform = 'translate(-50%, -150%)'; }, timeout); }
        }

        onAuthStateChanged(auth, (user) => {
            if (warrantiesUnsubscribe) warrantiesUnsubscribe();
            if (themeUnsubscribe) themeUnsubscribe();
            if (devicesUnsubscribe) devicesUnsubscribe();
            
            if (user) {
                userId = user.uid;
                nav.updateUser(user.email);
                loadingState.style.display = 'block';
                authState.style.display = 'none';

                themeUnsubscribe = onSnapshot(doc(db, 'users', userId, 'settings', 'theme'), (doc) => applyTheme(doc.data()?.theme || 'light'));
                
                warrantiesUnsubscribe = onSnapshot(collection(db, 'users', userId, 'warranties'), (snapshot) => {
                    warranties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    warranties.forEach(w => {
                        w.expiryDate = calculateExpiry(w.purchaseDate, w.warrantyLength, w.warrantyUnit);
                        w.status = getStatus(w.expiryDate);
                    });
                    findAndRenderUntrackedDevices();
                    loadingState.style.display = 'none';
                    renderWarranties();
                }, error => {
                    console.error("Error fetching warranties:", error);
                    loadingState.style.display = 'none';
                    showMessage('Could not fetch warranties.', 'error');
                });
                
                devicesUnsubscribe = onSnapshot(collection(db, 'users', userId, 'appliances'), (snapshot) => {
                    recipeManagerDevices = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    findAndRenderUntrackedDevices();
                }, error => console.error("Could not fetch RecipeManagr devices:", error));

            } else {
                userId = null;
                warranties = [];
                recipeManagerDevices = [];
                loadingState.style.display = 'none';
                renderWarranties();
                importBadge.style.display = 'none';
                applyTheme(localStorage.getItem('theme') || 'light');
                nav.updateUser(null);
            }
        });
    </script>
</body>
</html>