<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Lifeblogging Hub</title>
    <link rel="icon" href="/favicons/house.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json" />
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: white;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --timeline-line: #e5e7eb;
        }
        .dark {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --timeline-line: #374151;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .dashboard-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Styles for drag and drop */
        .layout-editing .dashboard-card {
            cursor: move;
            border-style: dashed;
            border-color: var(--text-secondary);
            animation: pulse-border 2s infinite;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--bg-color);
            border: 2px dashed var(--text-secondary);
        }
        .sortable-drag {
            cursor: grabbing;
            opacity: 1;
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }
        @keyframes pulse-border {
            0% { border-color: var(--border-color); }
            50% { border-color: #6366f1; }
            100% { border-color: var(--border-color); }
        }

        /* Widget Visibility hiding */
        .hidden-widget { display: none !important; }
        .layout-editing .hidden-widget {
            display: flex !important;
            opacity: 0.4;
            border-style: dashed;
            border-color: var(--text-secondary);
        }
        .hide-widget-btn {
            cursor: pointer;
            display: none;
            padding: 4px;
        }
        .layout-editing .hide-widget-btn {
            display: inline-block;
        }

        .card-header {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            z-index: 10;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 20px; }
        
        .mood-face-large {
            font-size: 5rem;
            transition: transform 0.2s;
        }
        .mood-face-large:hover { transform: scale(1.1) rotate(5deg); }

        .timeline-item:first-child .line-left { display: none; }
        .timeline-item:last-child .line-right { display: none; }

        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 12px;
            gap: 2px;
        }
        .bar {
            width: 3px;
            background-color: #10b981;
            animation: bounce 1s infinite ease-in-out;
        }
        .bar:nth-child(2) { animation-delay: 0.1s; height: 60%; }
        .bar:nth-child(3) { animation-delay: 0.2s; height: 30%; }
        .bar:nth-child(4) { animation-delay: 0.3s; height: 70%; }

        @keyframes bounce {
            0%, 100% { height: 20%; }
            50% { height: 100%; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <span id="greeting-text">Dashboard</span>
                </h1>
                <div class="flex items-center gap-2 mt-1 text-xs text-[var(--text-secondary)] font-arial">
                    <span id="current-date">Loading...</span>
                    
                    <span class="opacity-20">|</span>
                    
                    <span id="header-weather" class="flex items-center gap-1.5 cursor-help opacity-0 transition-opacity duration-1000" title="Current Weather">
                        <i class="fas fa-circle-notch fa-spin text-[10px]"></i>
                    </span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="edit-layout-btn" class="p-2 rounded-full bg-[var(--card-bg)] border border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 transition text-sm" title="Customize Layout"><i class="fas fa-pen"></i></button>
                
                <button id="refresh-btn" class="p-2 rounded-full bg-[var(--card-bg)] border border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 transition text-sm"><i class="fas fa-sync-alt"></i></button>
                <button id="theme-toggle" class="p-2 rounded-full bg-[var(--card-bg)] border border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 transition text-sm"><i class="fas fa-moon"></i></button>
                <div id="auth-container" class="hidden">
                    <a href="/" class="p-2 px-3 rounded-lg bg-indigo-600 text-white font-bold text-xs hover:bg-indigo-700 transition flex items-center gap-2">
                        <i class="fas fa-home"></i> Hub
                    </a>
                </div>
            </div>
        </div>

        <div id="login-prompt" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold mb-4">Welcome Back</h2>
            <p class="mb-6 text-[var(--text-secondary)]">Please log in to view your personal dashboard.</p>
            <a href="/index.html" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Go to Login</a>
        </div>

        <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-4 gap-4 hidden">
            
            <div class="dashboard-card md:col-span-2" id="card-mood">
                <div class="card-header">
                    <span>Daily Mood</span>
                    <a href="/log" class="text-indigo-500 hover:text-indigo-600" title="Logger"><i class="fas fa-smile text-lg"></i></a>
                </div>
                <div class="flex-grow flex items-center justify-center gap-6">
                    <div id="mood-display" class="mood-face-large text-gray-300"><i class="fas fa-meh"></i></div>
                    <div class="flex flex-col justify-center">
                        <p id="mood-text" class="font-bold text-3xl text-[var(--text-primary)]">No data</p>
                        <p id="mood-time" class="text-sm text-[var(--text-secondary)] mt-1 opacity-0">...</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-water">
                <div class="card-header">
                    <span>Water</span>
                    <a href="/hydrationtrackr" class="text-blue-500 hover:text-blue-600" title="HydrationTrackr"><i class="fas fa-droplet text-lg"></i></a>
                </div>
                <div class="flex-grow flex flex-col items-center justify-center -mt-2">
                    <div class="relative w-24 h-24">
                        <canvas id="water-chart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="water-value" class="text-lg font-bold">0</span>
                            <span class="text-[10px] text-[var(--text-secondary)]">ml</span>
                        </div>
                    </div>
                    <p id="water-goal-text" class="text-[10px] text-[var(--text-secondary)] mt-2">Goal: 2000ml</p>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-calories">
                <div class="card-header">
                    <span>Calories</span>
                    <a href="/foodtrackr" class="text-orange-500 hover:text-orange-600" title="FoodTrackr"><i class="fas fa-utensils text-lg"></i></a>
                </div>
                <div class="flex flex-col h-full justify-between">
                    <div class="text-center mb-2">
                        <span id="calories-val" class="text-3xl font-bold text-orange-500">0</span>
                        <span class="text-xs text-[var(--text-secondary)]">kcal</span>
                    </div>
                    <div class="space-y-1 text-[10px] text-[var(--text-secondary)]">
                        <div class="flex justify-between border-b border-[var(--border-color)] pb-1">
                            <span>Breakfast</span><span id="cal-breakfast" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                        <div class="flex justify-between border-b border-[var(--border-color)] pb-1">
                            <span>Lunch</span><span id="cal-lunch" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                        <div class="flex justify-between border-b border-[var(--border-color)] pb-1">
                            <span>Dinner</span><span id="cal-dinner" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Snack</span><span id="cal-snacks" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-meds">
                <div class="card-header">
                    <span>Meds</span>
                    <a href="/medimanagr" class="text-pink-500 hover:text-pink-600" title="MediManagr"><i class="fas fa-pills text-lg"></i></a>
                </div>
                <div id="meds-list" class="flex-grow custom-scroll overflow-y-auto space-y-2 pr-1 max-h-[140px]">
                    <p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">Loading schedule...</p>
                </div>
            </div>
            <div class="dashboard-card col-span-1" id="card-pets">
                <div class="card-header">
                    <span>Pets</span>
                    <a href="/petmanagr" class="text-indigo-500 hover:text-indigo-600" title="PetManagr"><i class="fas fa-paw text-lg"></i></a>
                </div>
                <div id="pets-list-container" class="flex-grow custom-scroll overflow-y-auto space-y-2 pr-1 max-h-[140px]">
                    <p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">Loading...</p>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-warranties">
                <div class="card-header">
                    <span>Warranties</span>
                    <a href="/warrantytrackr" class="text-green-600 hover:text-green-700" title="WarrantyTrackr"><i class="fas fa-shield-alt text-lg"></i></a>
                </div>
                <div id="warranty-list-container" class="flex-grow custom-scroll overflow-y-auto space-y-2 pr-1 max-h-[140px]">
                    <p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">Loading...</p>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-vehicles">
                <div class="card-header">
                    <span>Garage</span>
                    <a href="/vehiclemanagr" class="text-blue-600 hover:text-blue-700" title="VehicleManagr"><i class="fas fa-car-tunnel text-lg"></i></a>
                </div>
                <div id="vehicle-list-container" class="flex-grow custom-scroll overflow-y-auto space-y-2 pr-1 max-h-[140px]">
                    <p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">Loading...</p>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-watched">
                <div class="card-header">
                    <span>Watched</span>
                    <a href="/vidtrackr" class="text-red-500 hover:text-red-600" title="VidTrackr"><i class="fas fa-ticket text-lg"></i></a>
                </div>
                <div id="video-container" class="flex items-center gap-3 h-full">
                    <div class="w-16 h-10 bg-gray-200 dark:bg-gray-700 rounded-md flex-shrink-0 animate-pulse"></div>
                    <div class="flex-grow min-w-0">
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2 animate-pulse"></div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-1/2 animate-pulse"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-podcasts">
                <div class="card-header">
                    <span>Podcasts</span>
                    <a href="/podtrackr" class="text-purple-500 hover:text-purple-600" title="PodTrackr"><i class="fas fa-podcast text-lg"></i></a>
                </div>
                <div id="podcast-container" class="flex flex-col items-center text-center h-full justify-center">
                    <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-md mb-2 animate-pulse"></div>
                    <div class="w-full">
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mx-auto mb-1 animate-pulse"></div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mx-auto animate-pulse"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-music">
                <div class="card-header">
                    <span>Music</span>
                    <a id="lastfm-link" href="https://last.fm" target="_blank" class="text-red-500 hover:text-red-600" title="Last.fm"><i class="fas fa-music text-lg"></i></a>
                </div>
                <div id="music-container" class="flex flex-col h-full justify-center">
                    <div class="flex flex-col items-center text-center animate-pulse">
                        <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-md mb-2"></div>
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mx-auto mb-1"></div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mx-auto"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-cooking">
                <div class="card-header">
                    <span>Kitchen</span>
                    <a href="/recipemanagr" class="text-teal-500 hover:text-teal-600" title="RecipeManagr"><i class="fas fa-book-open text-lg"></i></a>
                </div>
                <div id="cooking-container" class="flex flex-col items-center text-center h-full justify-center">
                    <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-md mb-2 animate-pulse"></div>
                    <div class="w-full">
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mx-auto mb-1 animate-pulse"></div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mx-auto animate-pulse"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-sourdough">
                <div class="card-header">
                    <span>Sourdough</span>
                    <a href="/foodtrackr#foods-meals" class="text-orange-600 hover:text-orange-700" title="FoodTrackr"><i class="fas fa-wheat-awn text-lg"></i></a>
                </div>
                <div class="flex flex-col items-center justify-center h-full gap-1">
                    <div id="sd-status-icon" class="text-3xl text-gray-200 dark:text-gray-700 transition-colors"><i class="fas fa-bread-slice"></i></div>
                    <div class="text-center">
                        <p id="sd-last-fed" class="font-bold text-lg leading-tight">No Data</p>
                        <p id="sd-age" class="text-[10px] text-[var(--text-secondary)] uppercase tracking-wider mt-1">Age: --</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-plants">
                <div class="card-header">
                    <span>Garden</span>
                    <a href="/planttrackr" class="text-green-500 hover:text-green-600" title="PlantTrackr"><i class="fas fa-leaf text-lg"></i></a>
                </div>
                <div id="plant-container" class="flex flex-col h-full custom-scroll overflow-y-auto pr-1">
                    <div class="text-center h-full flex flex-col justify-center items-center">
                        <span class="text-3xl font-bold text-gray-300">-</span>
                        <p class="text-[10px] text-[var(--text-secondary)] uppercase tracking-wider mt-1">Loading...</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1" id="card-inbox">
                <div class="card-header">
                    <span>Inbox</span>
                    <a href="/tasktrackr" class="text-blue-500 hover:text-blue-600" title="TaskTrackr"><i class="fas fa-check-double text-lg"></i></a>
                </div>
                <div id="inbox-container" class="flex flex-col items-center justify-center h-full text-center p-1">
                    <span class="text-3xl font-bold text-gray-300">-</span>
                    <p class="text-[10px] text-[var(--text-secondary)] uppercase tracking-wider mt-1">Loading...</p>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2" id="card-activity">
                <div class="card-header">
                    <span>Recent Activity</span>
                    <a href="/log" class="text-green-500 hover:text-green-600" title="Logger"><i class="fas fa-list-ul text-lg"></i></a>
                </div>
                <div id="last-log-container" class="flex overflow-x-auto pb-4 custom-scroll items-center h-full px-2">
                    <p class="text-sm text-[var(--text-secondary)] italic w-full text-center">Loading logs...</p>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2" id="card-dailies">
                <div class="card-header">
                    <span>Dailies Progress</span>
                    <span id="dailies-progress-text" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full dark:bg-green-900 dark:text-green-200">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 mb-4">
                    <div id="dailies-progress-bar" class="bg-green-600 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div id="dailies-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 custom-scroll overflow-y-auto max-h-[150px] pr-1">
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, onSnapshot, Timestamp, setDoc, deleteField, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants
        const TRAKT_CLIENT_ID = '46c509e2cef42228978ae6a69b138628a6399c0bf28b729b7883b19ab9b082eb';
        const TRAKT_API_URL = 'https://api.trakt.tv';
        
        const LASTFM_API_KEY = '30a12197dac5d9d10dabf5880643cf35'; 
        const LASTFM_API_URL = 'https://ws.audioscrobbler.com/2.0/';

        const TICKTICK_API_URL = 'https://api.ticktick.com/open/v1';

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let unsubscribers = [];

        // --- UI References ---
        const ui = {
            grid: document.getElementById('dashboard-grid'),
            loginPrompt: document.getElementById('login-prompt'),
            authContainer: document.getElementById('auth-container'),
            date: document.getElementById('current-date'),
            greeting: document.getElementById('greeting-text'),
            moodDisplay: document.getElementById('mood-display'),
            moodText: document.getElementById('mood-text'),
            moodTime: document.getElementById('mood-time'),
            podcastContainer: document.getElementById('podcast-container'),
            cookingContainer: document.getElementById('cooking-container'),
            musicContainer: document.getElementById('music-container'),
            lastfmLink: document.getElementById('lastfm-link'),
            videoContainer: document.getElementById('video-container'),
            inboxCount: document.getElementById('inbox-count'),
            calVal: document.getElementById('calories-val'),
            calBreakdown: {
                breakfast: document.getElementById('cal-breakfast'),
                lunch: document.getElementById('cal-lunch'),
                dinner: document.getElementById('cal-dinner'),
                snacks: document.getElementById('cal-snacks')
            },
            medsList: document.getElementById('meds-list'),
            lastLogContainer: document.getElementById('last-log-container'),
            dailiesGrid: document.getElementById('dailies-grid'),
            dailiesProgText: document.getElementById('dailies-progress-text'),
            dailiesProgBar: document.getElementById('dailies-progress-bar'),
            waterVal: document.getElementById('water-value'),
            waterGoalText: document.getElementById('water-goal-text'),
            petsList: document.getElementById('pets-list-container'),
            plantContainer: document.getElementById('plant-container'),
            inboxContainer: document.getElementById('inbox-container'),
            warrantyList: document.getElementById('warranty-list-container'),
            vehicleList: document.getElementById('vehicle-list-container'),
        };

        // --- Clock Logic ---
        function updateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            ui.date.innerHTML = `<i class="fa-regular fa-clock mr-1"></i> ${dateStr} <span class="opacity-50 mx-1">|</span> <span class="font-bold">${timeStr}</span>`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- Layout Customization Logic ---
        const grid = document.getElementById('dashboard-grid');
        let sortableInstance = null;
        let isEditingLayout = false;

        const loadLayout = () => {
            const savedOrder = localStorage.getItem('dashboard_layout');
            const hiddenWidgets = JSON.parse(localStorage.getItem('dashboard_hidden_widgets') || '[]');

            const cards = Array.from(grid.children);
            const cardMap = cards.reduce((acc, card) => {
                if(card.id) acc[card.id] = card;
                return acc;
            }, {});

            if (savedOrder) {
                const order = JSON.parse(savedOrder);
                order.forEach(id => {
                    if (cardMap[id]) {
                        grid.appendChild(cardMap[id]);
                    }
                });
                
                cards.forEach(card => {
                    if (!order.includes(card.id)) grid.appendChild(card);
                });
            }

            // Apply Visibility state
            cards.forEach(card => {
                if (hiddenWidgets.includes(card.id)) card.classList.add('hidden-widget');
            });
        };

        const saveLayout = () => {
            const order = sortableInstance ? sortableInstance.toArray() : Array.from(grid.children).map(c => c.id);
            localStorage.setItem('dashboard_layout', JSON.stringify(order));
        };

        const saveVisibility = () => {
            const hidden = [];
            document.querySelectorAll('.dashboard-card.hidden-widget').forEach(card => {
                if(card.id) hidden.push(card.id);
            });
            localStorage.setItem('dashboard_hidden_widgets', JSON.stringify(hidden));
        };

        const updateVisibilityIcon = (btn, card) => {
            if(btn) btn.innerHTML = card.classList.contains('hidden-widget') ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        };

        const toggleLayoutEdit = () => {
            isEditingLayout = !isEditingLayout;
            const btn = document.getElementById('edit-layout-btn');
            
            if (isEditingLayout) {
                btn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                btn.classList.add('bg-green-100', 'dark:bg-green-900/30');
                document.body.classList.add('layout-editing');
                
                sortableInstance = new Sortable(grid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: saveLayout
                });

                document.querySelectorAll('.dashboard-card').forEach(card => {
                    let hideBtn = card.querySelector('.hide-widget-btn');
                    if (!hideBtn) {
                        hideBtn = document.createElement('div');
                        hideBtn.className = 'hide-widget-btn text-[var(--text-secondary)] hover:text-[var(--text-primary)] text-sm';
                        
                        const link = card.querySelector('.card-header a');
                        if (link) {
                            card.querySelector('.card-header').insertBefore(hideBtn, link);
                        } else {
                            card.querySelector('.card-header').appendChild(hideBtn);
                        }
                        
                        hideBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            card.classList.toggle('hidden-widget');
                            updateVisibilityIcon(hideBtn, card);
                            saveVisibility();
                        });
                    }
                    updateVisibilityIcon(hideBtn, card);
                });

            } else {
                btn.innerHTML = '<i class="fas fa-pen"></i>';
                btn.classList.remove('bg-green-100', 'dark:bg-green-900/30');
                document.body.classList.remove('layout-editing');
                
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
            }
        };
        
        document.getElementById('edit-layout-btn').addEventListener('click', toggleLayoutEdit);
        loadLayout();

        // --- Shared Data State ---
        let state = {
            dailyLogs: [],
            manualLogs: [],
            dailyPlan: [],
            plants: [],
            plantLogs: [],
            pets: [],
            petTreatments: [],
            petEvents: [],
            todayDoses: [],
            medsSchedule: [],
            recentMedLogs: [] 
        };
        // --- Theme Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        };
        themeToggle.addEventListener('click', async () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            if (currentUser) {
                await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'theme'), { theme: newTheme }, { merge: true });
            } else {
                localStorage.setItem('theme', newTheme);
            }
        });

        // --- Render Functions ---
        const renderLogsAndMood = () => {
            const allLogs = [...state.dailyLogs, ...state.manualLogs];
            
            const safeDate = (dateStr) => {
                if (!dateStr) return new Date();
                return new Date(dateStr.replace(' ', 'T')); 
            };

            allLogs.sort((a, b) => safeDate(b.date) - safeDate(a.date));
            
            const topLogs = allLogs.slice(0, 12);
            ui.lastLogContainer.innerHTML = '';
            
            if (topLogs.length === 0) {
                ui.lastLogContainer.innerHTML = '<p class="text-sm text-[var(--text-secondary)] italic w-full text-center">Nothing logged yet.</p>';
            } else {
                topLogs.forEach((log, index) => {
                    const logDate = safeDate(log.date);
                    const timeStr = logDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let iconClass = 'fa-circle-dot'; 
                    let colorClass = 'text-gray-500 border-gray-300';
                    const name = log.attributeName.toLowerCase();
                    
                    if (name.includes('mood')) {
                        const val = parseInt(log.attributeValue);
                        if(val === 1) { iconClass = 'fa-angry'; colorClass = 'text-red-500 border-red-500'; }
                        else if(val === 2) { iconClass = 'fa-frown'; colorClass = 'text-orange-500 border-orange-500'; }
                        else if(val === 3) { iconClass = 'fa-meh'; colorClass = 'text-yellow-500 border-yellow-500'; }
                        else if(val === 4) { iconClass = 'fa-smile'; colorClass = 'text-green-500 border-green-500'; }
                        else if(val === 5) { iconClass = 'fa-laugh-beam'; colorClass = 'text-green-600 border-green-600'; }
                        else { iconClass = 'fa-face-smile'; colorClass = 'text-gray-400 border-gray-400'; }
                    }
                    else if (name.includes('water')) { iconClass = 'fa-glass-water'; colorClass = 'text-blue-500 border-blue-500'; }
                    else if (name.includes('run') || name.includes('walk') || name.includes('steps')) { iconClass = 'fa-person-running'; colorClass = 'text-green-500 border-green-500'; }
                    else if (name.includes('code') || name.includes('dev')) { iconClass = 'fa-code'; colorClass = 'text-indigo-500 border-indigo-500'; }
                    else if (name.includes('read') || name.includes('book')) { iconClass = 'fa-book-open'; colorClass = 'text-purple-500 border-purple-500'; }
                    else if (name.includes('sleep')) { iconClass = 'fa-bed'; colorClass = 'text-blue-300 border-blue-300'; }
                    else if (name.includes('food') || name.includes('meal')) { iconClass = 'fa-utensils'; colorClass = 'text-orange-500 border-orange-500'; }
                    
                    const div = document.createElement('div');
                    div.className = 'timeline-item flex-shrink-0 flex flex-col items-center w-24 relative group';
                    div.innerHTML = `
                        <div class="line-left absolute top-[26px] left-0 w-1/2 h-0.5 bg-[var(--timeline-line)]"></div>
                        <div class="line-right absolute top-[26px] right-0 w-1/2 h-0.5 bg-[var(--timeline-line)]"></div>
                        <span class="text-[10px] text-[var(--text-secondary)] mb-1 font-mono">${timeStr}</span>
                        <div class="w-8 h-8 rounded-full bg-[var(--card-bg)] border-2 ${colorClass} z-10 flex items-center justify-center text-xs shadow-sm">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <div class="mt-2 text-center w-full px-1">
                            <p class="font-bold text-[10px] truncate w-full" title="${log.attributeName}">${log.attributeName}</p>
                            <p class="text-[9px] text-[var(--text-secondary)] truncate w-full opacity-80" title="${log.attributeValue}">${log.attributeValue}</p>
                        </div>
                    `;
                    ui.lastLogContainer.appendChild(div);
                });
            }

            const todayStr = new Date().toISOString().split('T')[0];
            const todaysMoodLog = allLogs.find(d => d.attributeName.toLowerCase() === 'mood' && d.date.startsWith(todayStr));

            if (todaysMoodLog) {
                const val = parseInt(todaysMoodLog.attributeValue);
                const moods = {1: ['fa-angry', 'text-red-500', 'Awful'], 2: ['fa-frown', 'text-orange-500', 'Bad'], 3: ['fa-meh', 'text-yellow-500', 'Okay'], 4: ['fa-smile', 'text-green-500', 'Good'], 5: ['fa-laugh-beam', 'text-green-600', 'Great']};
                const m = moods[val] || ['fa-question', 'text-gray-400', 'Unknown'];
                ui.moodDisplay.innerHTML = `<i class="fas ${m[0]} ${m[1]}"></i>`;
                ui.moodText.textContent = m[2];
                ui.moodTime.textContent = safeDate(todaysMoodLog.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                ui.moodTime.classList.remove('opacity-0');
            } else {
                 ui.moodDisplay.innerHTML = `<i class="fas fa-meh text-gray-300"></i>`;
                 ui.moodText.textContent = "No data";
                 ui.moodTime.classList.add('opacity-0');
            }
        };

        async function updateVidTrackrWidget(token) {
            try {
                const headers = { 
                    'Content-Type': 'application/json', 
                    'trakt-api-version': '2', 
                    'trakt-api-key': TRAKT_CLIENT_ID, 
                    'Authorization': `Bearer ${token}` 
                };

                const [historyRes, ratingsRes] = await Promise.all([
                    fetch(`${TRAKT_API_URL}/sync/history?limit=1&extended=images`, { headers }),
                    fetch(`${TRAKT_API_URL}/sync/ratings?limit=50`, { headers }) 
                ]);

                const history = await historyRes.json();
                const ratings = await ratingsRes.json();

                if (history.length > 0) {
                    const item = history[0];
                    const type = item.type;
                    const data = item[type];
                    const id = data.ids.trakt;
                    
                    const userRating = ratings.find(r => r[type] && r[type].ids.trakt === id);
                    const ratingBadge = userRating 
                        ? `<span class="absolute top-[-4px] right-[-4px] bg-green-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow-sm border border-white dark:border-gray-800">${userRating.rating}</span>` 
                        : '';

                    const media = data; 
                    const get = (path, obj) => {
                        const val = path.split('.').reduce((acc, part) => acc && acc[part], obj);
                        let final = Array.isArray(val) ? val[0] : val;
                        if (typeof final === 'string') {
                            if (!final.startsWith('http') && !final.startsWith('//')) return `https://${final}`;
                            if (final.startsWith('//')) return `https:${final}`;
                            return final;
                        }
                        return null;
                    };

                    let imgUrl = 'https://placehold.co/400x600/1f2937/FFF?text=No+Image';

                    if (type === 'episode') {
                         imgUrl = get('images.screenshot.medium', media) || get('images.screenshot.full', media) || get('images.screenshot', media) || get('images.thumb.medium', media) || get('images.thumb.full', media) || get('images.thumb', media) || get('images.fanart.medium', item.show) || get('images.fanart.full', item.show) || get('images.fanart', item.show) || imgUrl;
                    } else if (type === 'movie') {
                         imgUrl = get('images.fanart.medium', media) || get('images.fanart.full', media) || get('images.fanart', media) || get('images.thumb.medium', media) || get('images.thumb.full', media) || get('images.thumb', media) || imgUrl;
                    }
                    
                    if (imgUrl.includes('placehold.co') || !imgUrl) {
                         if (type === 'episode' && item.show) {
                            imgUrl = get('images.poster.medium', item.show) || get('images.poster.full', item.show) || get('images.poster', item.show) || imgUrl;
                         } else {
                            imgUrl = get('images.poster.medium', media) || get('images.poster.full', media) || get('images.poster', media) || imgUrl;
                         }
                    }

                    const title = type === 'episode' ? `${item.show.title}: ${data.title}` : data.title;
                    const watchedDate = new Date(item.watched_at);
                    const dateStr = watchedDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                    const timeStr = watchedDate.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });

                    ui.videoContainer.innerHTML = `
                        <div class="flex items-center gap-3 h-full px-1 w-full text-left relative">
                            <div class="relative flex-shrink-0">
                                <img src="${imgUrl}" class="w-16 h-10 rounded-md object-cover shadow-sm bg-gray-800" onerror="this.src='https://placehold.co/400x600/1f2937/FFF?text=Error'">
                                ${ratingBadge}
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="font-bold truncate text-xs text-[var(--text-primary)]" title="${title}">${title}</p>
                                <p class="text-[10px] text-[var(--text-secondary)] truncate">
                                    ${type === 'episode' ? `S${data.season}E${data.number}` : data.year} 
                                    <span class="mx-1">•</span> 
                                    <span class="text-[9px] opacity-80">Watched ${dateStr} at ${timeStr}</span>
                                </p>
                            </div>
                        </div>`;
                } else {
                     ui.videoContainer.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic">No watch history.</p>`;
                }
            } catch (e) {
                console.error("VidTrackr Widget Error:", e);
                ui.videoContainer.innerHTML = `<p class="text-xs text-red-400 italic">Connection error</p>`;
            }
        }
        // --- Weather Logic (Inline) ---
        async function fetchWeather(uid) {
            const el = document.getElementById('header-weather');

            try {
                const locRef = doc(db, 'users', uid, 'settings', 'location');
                const locSnap = await getDoc(locRef);
                let lat, lon;

                if (locSnap.exists() && locSnap.data().latitude) {
                    const data = locSnap.data();

                    if (data.expiresAt) {
                        const now = new Date();
                        const expiry = data.expiresAt.toDate();
                        if (now > expiry) {
                            await updateDoc(locRef, {
                                latitude: deleteField(),
                                longitude: deleteField(),
                                name: deleteField(),
                                expiresAt: deleteField()
                            });
                            console.log("Location expired and removed.");
                            throw new Error("Location expired");
                        }
                    }

                    lat = data.latitude;
                    lon = data.longitude;
                } else {
                    throw new Error("No location set");
                }

                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day`);
                if(!res.ok) throw new Error("API Error");
                const weatherData = await res.json();

                const temp = Math.round(weatherData.current.temperature_2m);
                const code = weatherData.current.weather_code;
                const isDay = weatherData.current.is_day;

                let icon = 'fa-cloud';
                let color = 'text-gray-400';
                let desc = 'Cloudy';

                if (code === 0) { 
                    icon = isDay ? 'fa-sun' : 'fa-moon'; 
                    color = isDay ? 'text-orange-400' : 'text-blue-300';
                    desc = isDay ? 'Sunny' : 'Clear';
                }
                else if (code <= 3) { 
                    icon = isDay ? 'fa-cloud-sun' : 'fa-cloud-moon'; 
                    color = isDay ? 'text-yellow-500' : 'text-gray-400';
                    desc = 'Partly Cloudy';
                }
                else if (code <= 48) { icon = 'fa-smog'; color = 'text-gray-500'; desc = 'Foggy'; }
                else if (code <= 57) { icon = 'fa-cloud-rain'; color = 'text-blue-300'; desc = 'Drizzle'; }
                else if (code <= 67) { icon = 'fa-cloud-showers-heavy'; color = 'text-blue-400'; desc = 'Rain'; }
                else if (code <= 77) { icon = 'fa-snowflake'; color = 'text-cyan-300'; desc = 'Snow'; }
                else if (code <= 82) { icon = 'fa-cloud-showers-water'; color = 'text-blue-500'; desc = 'Showers'; }
                else if (code <= 86) { icon = 'fa-snowflake'; color = 'text-cyan-400'; desc = 'Snow Showers'; }
                else if (code <= 99) { icon = 'fa-bolt'; color = 'text-purple-500'; desc = 'Thunderstorm'; }

                el.innerHTML = `
                    <i class="fas ${icon} ${color}"></i> 
                    <span>${temp}°C</span> 
                    <span class="hidden sm:inline text-[10px] text-[var(--text-secondary)] border-l border-[var(--border-color)] pl-2 ml-1 opacity-80">${desc}</span>
                `;
                el.classList.remove('opacity-0');

            } catch (e) { 
                el.innerHTML = '<a href="/account" class="text-[10px] text-[var(--text-secondary)] underline hover:text-indigo-500">Set Location</a>';
                el.classList.remove('opacity-0');
            }
        }

        const renderDailies = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            const counts = {};
            state.dailyLogs.forEach(d => {
                if(d.date.startsWith(todayStr)) {
                    counts[d.attributeName] = (counts[d.attributeName] || 0) + 1;
                }
            });

            ui.dailiesGrid.innerHTML = '';
            let totalTasks = 0;
            let completedTasks = 0;

            state.dailyPlan.forEach(task => {
                totalTasks++;
                const current = counts[task.attributeName] || 0;
                const target = parseInt(task.count) || 1;
                const isDone = current >= target;
                if (isDone) completedTasks++;

                const div = document.createElement('div');
                div.className = `p-2 rounded-lg border flex flex-col justify-center ${isDone ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' : 'bg-[var(--bg-color)] border-transparent'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-[10px] truncate max-w-[80%]" title="${task.attributeName}">${task.attributeName}</span>
                        <i class="fas ${isDone ? 'fa-check-circle text-green-500 text-[10px]' : 'fa-circle text-gray-300 text-[10px]'}"></i>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1 dark:bg-gray-700">
                        <div class="bg-indigo-500 h-1 rounded-full transition-all duration-500" style="width: ${(Math.min(current, target)/target)*100}%"></div>
                    </div>
                `;
                ui.dailiesGrid.appendChild(div);
            });

            const prog = totalTasks > 0 ? Math.round((completedTasks/totalTasks)*100) : 0;
            ui.dailiesProgText.textContent = `${prog}%`;
            ui.dailiesProgBar.style.width = `${prog}%`;
        };

        const renderMeds = () => {
            const dayName = new Date().toLocaleDateString('en-US', {weekday: 'long'});
            ui.medsList.innerHTML = '';
            
            let scheduledDoses = [];
            state.medsSchedule.forEach(med => {
                if (med.isArchived) return;
                if (med.schedule && med.schedule.days.includes(dayName)) {
                    const times = med.schedule.times.split(',').map(t => t.trim()).filter(Boolean);
                    times.forEach(time => {
                        scheduledDoses.push({
                            medId: med.id, name: med.name, dosage: med.dosage, tags: med.tags || [],
                            icon: med.icon || 'fas fa-pills', color: med.color || '#666', time: time, status: 'pending'
                        });
                    });
                }
            });

            let availableLogs = [...state.todayDoses];
            scheduledDoses.sort((a, b) => a.time.localeCompare(b.time));

            scheduledDoses.forEach(doseItem => {
                const logIndex = availableLogs.findIndex(log => log.medId === doseItem.medId && log.status === 'taken');
                if (logIndex !== -1) {
                    doseItem.status = 'taken';
                    availableLogs.splice(logIndex, 1);
                }
            });

            if (scheduledDoses.length === 0) {
                ui.medsList.innerHTML = `<p class="text-[10px] text-[var(--text-secondary)] italic text-center mb-2">No meds scheduled today.</p>`;
            } else {
                scheduledDoses.forEach(dose => {
                    const isTaken = dose.status === 'taken';
                    const tagsHtml = dose.tags.slice(0, 2).map(tag => 
                        `<span class="px-1 py-0.5 rounded-[3px] text-[8px] bg-gray-200 dark:bg-gray-700 text-[var(--text-secondary)]">${tag}</span>`
                    ).join('');

                    const div = document.createElement('div');
                    div.className = `flex justify-between items-center p-1.5 rounded-lg text-xs mb-1 ${isTaken ? 'bg-green-50 dark:bg-green-900/20' : 'bg-gray-50 dark:bg-gray-800'}`;
                    
                    div.innerHTML = `
                        <div class="flex items-start gap-2 min-w-0 flex-grow">
                            <span class="font-mono text-[var(--text-secondary)] w-8 text-right flex-shrink-0 pt-0.5">${dose.time}</span>
                            <div class="flex flex-col min-w-0 gap-0.5">
                                <div class="flex items-center gap-1.5">
                                    <i class="${dose.icon}" style="color: ${dose.color}"></i>
                                    <span class="${isTaken ? 'line-through opacity-60' : 'font-bold'} truncate text-xs" title="${dose.name}">${dose.name}</span>
                                </div>
                                <div class="flex flex-wrap items-center gap-1.5 min-w-0">
                                    ${dose.dosage ? `<span class="text-[9px] text-[var(--text-secondary)] opacity-90">${dose.dosage}</span>` : ''}
                                    ${tagsHtml}
                                </div>
                            </div>
                        </div>
                        <i class="fas ${isTaken ? 'fa-check text-green-500' : 'fa-hourglass-half text-gray-300'} ml-1 text-[10px] flex-shrink-0"></i>
                    `;
                    ui.medsList.appendChild(div);
                });
            }

            if (state.recentMedLogs && state.recentMedLogs.length > 0) {
                const historyHeader = document.createElement('div');
                historyHeader.className = "text-[9px] font-bold uppercase tracking-wider text-[var(--text-secondary)] mt-3 mb-1 pl-1 border-t border-[var(--border-color)] pt-2";
                historyHeader.textContent = "Latest Logs";
                ui.medsList.appendChild(historyHeader);

                state.recentMedLogs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-1.5 rounded-lg text-xs mb-1 bg-gray-50 dark:bg-gray-800 border border-[var(--border-color)]";
                    const timeStr = new Date(log.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const dateStr = new Date(log.date).toLocaleDateString([], {month: 'short', day: 'numeric'});
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-2 min-w-0">
                            <i class="fas fa-history text-[9px] text-gray-400"></i>
                            <div class="flex flex-col min-w-0">
                                <span class="font-bold truncate text-[11px]">${log.medicineName}</span>
                                <span class="text-[9px] text-[var(--text-secondary)]">${log.dosage || ''}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-[10px]">${timeStr}</div>
                            <div class="text-[8px] text-[var(--text-secondary)]">${dateStr}</div>
                        </div>
                    `;
                    ui.medsList.appendChild(div);
                });
            }
        };
        async function fetchTickTickCount(accessToken) {
            try {
                const projRes = await fetch(`${TICKTICK_API_URL}/project`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (projRes.status === 401) throw new Error('Unauthorized');
                const projects = await projRes.json();
                const inbox = projects.find(p => p.kind === 'inbox' || p.name === 'Inbox');
                const inboxId = inbox ? inbox.id : 'inbox';
                
                const taskRes = await fetch(`${TICKTICK_API_URL}/project/${inboxId}/data`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await taskRes.json();
                const tasks = (data.tasks || []).filter(t => t.status === 0);
                
                ui.inboxContainer.innerHTML = '';
                if(tasks.length > 0) {
                     ui.inboxContainer.classList.remove('justify-center', 'items-center');
                     ui.inboxContainer.classList.add('justify-start', 'items-start');
                     
                     ui.inboxContainer.innerHTML += `<div class="w-full flex justify-between items-center mb-2 pb-1 border-b border-[var(--border-color)]"><span class="text-xs font-bold text-gray-500">Inbox</span><span class="text-xs font-bold text-blue-500">${tasks.length}</span></div>`;

                     const list = document.createElement('div');
                     list.className = "w-full space-y-1.5";
                     tasks.slice(0, 3).forEach(t => {
                         list.innerHTML += `<div class="flex items-start gap-2 text-xs"><i class="far fa-square text-gray-400 mt-0.5"></i> <span class="truncate leading-tight">${t.title}</span></div>`;
                     });
                     ui.inboxContainer.appendChild(list);
                     
                     if(tasks.length > 3) {
                         ui.inboxContainer.innerHTML += `<p class="text-[9px] text-gray-400 mt-2 w-full text-center">+${tasks.length - 3} more</p>`;
                     }
                } else {
                    ui.inboxContainer.classList.add('justify-center', 'items-center');
                    ui.inboxContainer.innerHTML = `<i class="fas fa-check-circle text-3xl text-green-200 dark:text-green-900 mb-1"></i><p class="text-xs text-gray-400">All caught up!</p>`;
                }
            } catch (e) {
                console.error("TickTick Error", e);
                ui.inboxContainer.innerHTML = '<span class="text-gray-400 text-xs">Error loading tasks</span>';
            }
        }

        const renderPlantsWidget = () => {
            const now = new Date();
            let thirsty = [];
            
            state.plants.forEach(plant => {
                if (plant.health === 'sick' || !plant.waterFreq) return;
                if (plant.snoozeUntil && plant.snoozeUntil.toDate() > now) return;

                const logs = state.plantLogs.filter(l => l.plantId === plant.id && l.type === 'Water');
                const lastWater = logs.length > 0 ? new Date(logs[0].date) : (plant.acquired ? new Date(plant.acquired) : new Date(0));
                
                const daysOverdue = Math.floor(((now - lastWater) / (1000 * 60 * 60 * 24)) - plant.waterFreq);
                
                if (daysOverdue >= 0) {
                    thirsty.push({ name: plant.name, days: daysOverdue, icon: plant.icon || 'fa-leaf' });
                }
            });

            thirsty.sort((a,b) => b.days - a.days);
            ui.plantContainer.innerHTML = '';
            
            if (thirsty.length === 0) {
                 ui.plantContainer.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-green-500 opacity-60"><i class="fas fa-check-circle text-3xl mb-1"></i><span class="text-xs font-bold">All Good</span></div>`;
            } else {
                thirsty.slice(0, 10).forEach(p => {
                    ui.plantContainer.innerHTML += `
                        <div class="flex justify-between items-center p-1.5 rounded-lg mb-1 bg-green-50 dark:bg-green-900/10 border border-green-100 dark:border-green-900/30">
                            <div class="flex items-center gap-2 min-w-0"><i class="fa-solid ${p.icon} text-green-600 text-[10px]"></i><span class="text-xs font-semibold truncate">${p.name}</span></div>
                            <span class="text-[9px] font-bold text-red-500 whitespace-nowrap">${p.days > 0 ? p.days + 'd late' : 'Due'}</span>
                        </div>`;
                });
            }
        };

        const renderPetsWidget = () => {
            const now = new Date();
            let reminders = [];

            state.pets.forEach(pet => {
                (pet.assignedTreatments || []).forEach(assigned => {
                    const treatment = state.petTreatments.find(t => t.id === assigned.treatmentId);
                    if(!treatment) return;

                    const lastEvent = state.petEvents
                        .filter(e => e.petId === pet.id && e.type === treatment.name)
                        .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                    
                    const baseDate = lastEvent ? new Date(lastEvent.date) : new Date(assigned.startDate);
                    const nextDate = new Date(baseDate);
                    nextDate.setDate(nextDate.getDate() + parseInt(treatment.frequencyDays));
                    
                    const diffDays = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 14) { 
                        reminders.push({ pet: pet.name, task: treatment.name, date: nextDate, days: diffDays, icon: pet.icon || 'fa-paw' });
                    }
                });
            });

            reminders.sort((a,b) => a.days - b.days);
            ui.petsList.innerHTML = '';
            
            if (reminders.length === 0) {
                ui.petsList.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">No upcoming tasks.</p>`;
            } else {
                reminders.forEach(r => {
                    let color = r.days < 0 ? 'text-red-600 bg-red-50 dark:bg-red-900/20' : 'text-[var(--text-primary)] bg-gray-50 dark:bg-gray-800';
                    ui.petsList.innerHTML += `
                        <div class="flex justify-between items-center p-2 rounded-lg text-xs ${color} mb-1">
                            <div class="flex items-center gap-2 min-w-0"><i class="fas ${r.icon} opacity-70"></i><div class="flex flex-col min-w-0"><span class="font-bold truncate">${r.task}</span><span class="text-[10px] opacity-75 truncate">${r.pet}</span></div></div>
                            <div class="text-right whitespace-nowrap ml-2"><div class="font-bold">${r.days < 0 ? 'Overdue' : r.days + 'd'}</div><div class="text-[9px] opacity-75">${r.date.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</div></div>
                        </div>`;
                });
            }
        };

        async function fetchLastFm(username) {
            if (!username) return;
            ui.lastfmLink.href = `https://www.last.fm/user/${username}`;

            try {
                const url = `${LASTFM_API_URL}?method=user.getrecenttracks&user=${username}&api_key=${LASTFM_API_KEY}&format=json&limit=1`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.recenttracks || !data.recenttracks.track || data.recenttracks.track.length === 0) {
                    ui.musicContainer.innerHTML = `<p class="text-xs text-[var(--text-secondary)] text-center">No history found.</p>`;
                    return;
                }

                const track = data.recenttracks.track[0];
                const isNowPlaying = track['@attr'] && track['@attr'].nowplaying === 'true';
                
                let art = 'https://placehold.co/100x100/333/FFF?text=Music';
                if (track.image && track.image.length > 0) {
                    art = track.image[3]['#text'] || track.image[2]['#text'] || track.image[0]['#text'];
                }

                ui.musicContainer.innerHTML = `
                    <div class="flex items-center gap-3 h-full px-1">
                        <div class="relative flex-shrink-0">
                            <img src="${art}" class="w-14 h-14 rounded-md object-cover shadow-sm bg-gray-100 dark:bg-gray-800">
                            ${isNowPlaying ? `
                                <div class="absolute -bottom-1 -right-1 bg-[var(--card-bg)] rounded-full p-1 border border-[var(--border-color)] shadow-sm" title="Listening Now">
                                    <div class="equalizer">
                                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="min-w-0 flex flex-col justify-center">
                            <p class="font-bold text-xs truncate w-full pr-1" title="${track.name}">${track.name}</p>
                            <p class="text-[10px] text-[var(--text-secondary)] truncate w-full" title="${track.artist['#text']}">${track.artist['#text']}</p>
                            <p class="text-[9px] text-[var(--text-secondary)] mt-0.5 opacity-80">
                                ${isNowPlaying ? '<span class="text-green-500 font-bold">Scrobbling now...</span>' : 'Last played'}
                            </p>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error("LastFM Error:", err);
                ui.musicContainer.innerHTML = `<p class="text-[10px] text-red-400 text-center">Failed to load music.</p>`;
            }
        }
        const calculateWarrantyExpiry = (start, len, unit) => {
            if (!start || unit === 'lifetime') return null;
            const d = new Date(start);
            const n = parseInt(len);
            if (unit === 'days') d.setDate(d.getDate() + n);
            if (unit === 'weeks') d.setDate(d.getDate() + n * 7);
            if (unit === 'months') d.setMonth(d.getMonth() + n);
            if (unit === 'years') d.setFullYear(d.getFullYear() + n);
            return d;
        };

        const setupListeners = (uid) => {
            const start = new Date(); start.setHours(0, 0, 0, 0);
            const end = new Date(); end.setHours(23, 59, 59, 999);
            const startTs = Timestamp.fromDate(start);
            const endTs = Timestamp.fromDate(end);
            const todayStr = start.toISOString().split('T')[0];

            unsubscribers.push(onSnapshot(doc(db, 'users', uid, 'settings', 'profile'), (snap) => {
                const name = snap.data()?.displayName;
                const emailName = currentUser.email.split('@')[0];
                const finalName = name || emailName;

                const hour = new Date().getHours();
                let timeGreeting = "Hello";
                
                if (hour >= 5 && hour < 12) timeGreeting = "Good morning";
                else if (hour >= 12 && hour < 17) timeGreeting = "Good afternoon";
                else if (hour >= 17 && hour < 22) timeGreeting = "Good evening";
                else timeGreeting = "It's getting late";

                ui.greeting.textContent = `${timeGreeting}, ${finalName}!`;
            }));

            const dailiesQ = query(collection(db, `users/${uid}/sources/dailies/data`), orderBy('date', 'desc'), limit(20));
            unsubscribers.push(onSnapshot(dailiesQ, (snap) => {
                state.dailyLogs = snap.docs.map(d => d.data());
                renderLogsAndMood();
                renderDailies(); 
            }));

            const manualQ = query(collection(db, `users/${uid}/sources/manual/data`), orderBy('date', 'desc'), limit(20));
            unsubscribers.push(onSnapshot(manualQ, (snap) => {
                state.manualLogs = snap.docs.map(d => d.data());
                renderLogsAndMood();
            }));

            const hydroQ = query(collection(db, `users/${uid}/hydrationtrackr`), where('date', '>=', startTs), where('date', '<=', endTs));
            unsubscribers.push(onSnapshot(hydroQ, async (snap) => {
                let waterTotal = 0;
                snap.forEach(doc => waterTotal += parseInt(doc.data().attributeValue || doc.data().amount || 0));
                
                let waterGoal = 2000;
                const s = await getDoc(doc(db, `users/${uid}/settings/water`));
                if(s.exists()) waterGoal = s.data().dailyGoal || 2000;

                ui.waterVal.textContent = waterTotal;
                ui.waterGoalText.textContent = `Goal: ${waterGoal}ml`;
                updateWaterChart(waterTotal, waterGoal);
            }));

            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/pets`), s => {
                state.pets = s.docs.map(d => ({id:d.id, ...d.data()})); renderPetsWidget();
            }));
            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/pet_treatments`), s => {
                state.petTreatments = s.docs.map(d => ({id:d.id, ...d.data()})); renderPetsWidget();
            }));
            unsubscribers.push(onSnapshot(query(collection(db, `users/${uid}/pet_events`), orderBy('date', 'desc'), limit(50)), s => {
                state.petEvents = s.docs.map(d => ({id:d.id, ...d.data()})); renderPetsWidget();
            }));

            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/plants`), s => {
                state.plants = s.docs.map(d => ({id:d.id, ...d.data()})); renderPlantsWidget();
            }));
            unsubscribers.push(onSnapshot(query(collection(db, `users/${uid}/plant_logs`), where('type', '==', 'Water'), orderBy('date', 'desc'), limit(100)), s => {
                state.plantLogs = s.docs.map(d => ({id:d.id, ...d.data()})); renderPlantsWidget();
            }));

            const cookQ = query(collection(db, `users/${uid}/recipes`), orderBy('lastCooked', 'desc'), limit(5));
            unsubscribers.push(onSnapshot(cookQ, (snap) => {
                if (!snap.empty) {
                    const lastData = snap.docs[0].data();
                    const daysSince = Math.floor((new Date() - new Date(lastData.lastCooked.replace(' ', 'T')))/(1000*60*60*24));

                    if(daysSince > 3) {
                            const randomRec = snap.docs[Math.floor(Math.random() * snap.docs.length)].data();
                            ui.cookingContainer.innerHTML = `<div class="text-center p-1"><p class="text-[10px] text-[var(--text-secondary)] mb-1">Hungry? Try this:</p><p class="font-bold text-xs text-teal-600 truncate">${randomRec.name}</p></div>`;
                    } else {
                        const img = lastData.lastCookedImage || lastData.imageUrl || 'https://placehold.co/100x100/e2e8f0/adb5bd?text=Food';
                        ui.cookingContainer.innerHTML = `<div class="flex items-center gap-3 h-full px-1 text-left w-full"><img src="${img}" class="w-12 h-12 rounded-md object-cover shadow-sm bg-gray-100 flex-shrink-0"><div class="min-w-0"><p class="font-bold truncate text-xs">${lastData.name}</p><p class="text-[10px] text-[var(--text-secondary)] truncate">Cooked ${daysSince === 0 ? 'Today' : daysSince + 'd ago'}</p></div></div>`;
                    }
                } else {
                    ui.cookingContainer.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic">No recent cooks.</p>`;
                }
            }));

            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/warranties`), (snap) => {
                const now = new Date();
                now.setHours(0,0,0,0);
                
                const warranties = snap.docs.map(d => {
                    const w = d.data();
                    return {
                        name: w.productName,
                        date: calculateWarrantyExpiry(w.purchaseDate, w.warrantyLength, w.warrantyUnit),
                        isLifetime: w.warrantyUnit === 'lifetime'
                    };
                })
                .filter(w => w.isLifetime || (w.date && w.date >= now)) 
                .sort((a, b) => {
                    if(a.isLifetime) return 1;
                    if(b.isLifetime) return -1;
                    return a.date - b.date;
                })
                .slice(0, 5); 

                ui.warrantyList.innerHTML = '';
                if (warranties.length === 0) {
                    ui.warrantyList.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">No active warranties.</p>`;
                } else {
                    warranties.forEach(w => {
                        const isLife = w.isLifetime;
                        const daysLeft = isLife ? Infinity : Math.ceil((w.date - now) / (1000 * 60 * 60 * 24));
                        const colorClass = !isLife && daysLeft < 30 ? 'text-orange-600 bg-orange-50 dark:bg-orange-900/20' : 'text-gray-600 bg-gray-50 dark:bg-gray-800 dark:text-gray-300';
                        
                        const div = document.createElement('div');
                        div.className = `flex justify-between items-center p-2 rounded-lg text-xs ${colorClass}`;
                        div.innerHTML = `
                            <span class="font-medium truncate mr-2">${w.name}</span>
                            <span class="whitespace-nowrap font-mono text-[10px] opacity-80">${isLife ? 'Lifetime' : w.date.toLocaleDateString(undefined, {month:'short', day:'numeric', year:'2-digit'})}</span>
                        `;
                        ui.warrantyList.appendChild(div);
                    });
                }
            }));

            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/vehicles`), (snap) => {
                let events = [];
                const today = new Date();
                today.setHours(0,0,0,0);

                snap.forEach(d => {
                    const v = d.data();
                    if (v.isArchived) return;

                    if(v.motExpiry) events.push({ label: 'MOT', vehicle: v.name, date: new Date(v.motExpiry), icon: 'fa-screwdriver-wrench' });
                    if(v.taxExpiry) events.push({ label: 'Tax', vehicle: v.name, date: new Date(v.taxExpiry), icon: 'fa-sterling-sign' });
                    if(v.insuranceExpiry) events.push({ label: 'Ins', vehicle: v.name, date: new Date(v.insuranceExpiry), icon: 'fa-shield-halved' });
                });

                events.sort((a, b) => a.date - b.date);
                
                ui.vehicleList.innerHTML = '';
                if (events.length === 0) {
                    ui.vehicleList.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">No upcoming vehicle dates.</p>`;
                } else {
                    events.slice(0, 5).forEach(e => {
                        const daysDiff = Math.ceil((e.date - today) / (1000 * 60 * 60 * 24));
                        let statusColor = 'bg-gray-50 dark:bg-gray-800';
                        let iconColor = 'text-blue-400';
                        
                        if (daysDiff < 0) { statusColor = 'bg-red-50 dark:bg-red-900/20 text-red-700'; iconColor = 'text-red-500'; }
                        else if (daysDiff < 30) { statusColor = 'bg-orange-50 dark:bg-orange-900/20 text-orange-700'; iconColor = 'text-orange-500'; }

                        const div = document.createElement('div');
                        div.className = `flex justify-between items-center p-2 rounded-lg text-xs ${statusColor} mb-1`;
                        div.innerHTML = `
                            <div class="flex items-center gap-2 min-w-0">
                                <i class="fas ${e.icon} ${iconColor} w-3 text-center"></i>
                                <div class="flex flex-col min-w-0">
                                    <span class="font-bold truncate">${e.label}</span>
                                    <span class="text-[10px] opacity-75 truncate">${e.vehicle}</span>
                                </div>
                            </div>
                            <div class="text-right whitespace-nowrap ml-2">
                                <div class="font-mono font-bold">${e.date.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</div>
                                <div class="text-[9px] opacity-75">${daysDiff < 0 ? 'Expired' : daysDiff + ' days'}</div>
                            </div>
                        `;
                        ui.vehicleList.appendChild(div);
                    });
                }
            }));

            const podQ = query(collection(db, `users/${uid}/history`), orderBy('listenedAt', 'desc'), limit(1));
            unsubscribers.push(onSnapshot(podQ, (snap) => {
                if (!snap.empty) {
                    const data = snap.docs[0].data();
                    const rating = data.rating || 0;
                    
                    let starsHtml = '';
                    for (let i = 1; i <= 5; i++) {
                        starsHtml += `<i class="fas fa-star text-[10px] ${i <= rating ? 'text-yellow-400' : 'text-gray-300 dark:text-gray-600'}"></i>`;
                    }

                    ui.podcastContainer.innerHTML = `
                        <div class="flex items-center gap-3 h-full px-1 w-full text-left">
                            <img src="${data.podcastArtwork}" class="w-12 h-12 rounded-md object-cover shadow-sm bg-gray-100 flex-shrink-0">
                            <div class="min-w-0 flex-1">
                                <p class="font-bold truncate text-xs text-[var(--text-primary)]" title="${data.episodeTitle}">${data.episodeTitle}</p>
                                <p class="text-[10px] text-[var(--text-secondary)] truncate mb-0.5">${data.podcastTitle}</p>
                                <div class="flex gap-0.5">${starsHtml}</div>
                            </div>
                        </div>`;
                } else {
                    ui.podcastContainer.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic">No recent listens.</p>`;
                }
            }));

            unsubscribers.push(onSnapshot(doc(db, 'users', uid, 'settings', 'sourdough'), (snap) => {
                const ageEl = document.getElementById('sd-age');
                if (snap.exists() && snap.data().birthday) {
                    const bday = snap.data().birthday.toDate();
                    const diffDays = Math.floor((new Date() - bday) / (1000 * 60 * 60 * 24));
                    let ageText = diffDays < 30 ? `${diffDays} days` : 
                                  diffDays < 365 ? `${Math.floor(diffDays/30)} months` : 
                                  `${(diffDays/365).toFixed(1)} years`;
                    ageEl.textContent = `Age: ${ageText}`;
                } else {
                    ageEl.textContent = "Age: Not Set";
                }
            }));

            const sdQ = query(collection(db, `users/${uid}/sourdoughLogs`), orderBy('createdAt', 'desc'), limit(1));
            unsubscribers.push(onSnapshot(sdQ, (snap) => {
                const iconEl = document.getElementById('sd-status-icon');
                const textEl = document.getElementById('sd-last-fed');
                
                if (!snap.empty) {
                    const log = snap.docs[0].data();
                    const lastFed = log.createdAt.toDate();
                    const hoursAgo = Math.floor((new Date() - lastFed) / (1000 * 60 * 60));
                    
                    if (hoursAgo < 24) textEl.textContent = "Fed Today";
                    else if (hoursAgo < 48) textEl.textContent = "Fed Yesterday";
                    else textEl.textContent = `${Math.floor(hoursAgo / 24)} days ago`;

                    if (hoursAgo < 24) iconEl.className = "text-3xl text-green-500 mb-2";
                    else if (hoursAgo < 168) iconEl.className = "text-3xl text-yellow-500 mb-2"; 
                    else iconEl.className = "text-3xl text-red-400 mb-2"; 
                } else {
                    textEl.textContent = "Not fed yet";
                    iconEl.className = "text-3xl text-gray-200 dark:text-gray-700 mb-2";
                }
            }));

            const foodQ = query(collection(db, `users/${uid}/foodLog`), orderBy('eatenAt', 'desc'));
            unsubscribers.push(onSnapshot(foodQ, (snap) => {
                let cals = { total: 0, breakfast: 0, lunch: 0, dinner: 0, other: 0 };
                snap.forEach(d => {
                    const data = d.data();
                    const date = data.eatenAt.toDate();
                    if (date >= start && date <= end) {
                        const val = data.calories || 0;
                        cals.total += val;
                        const sec = (data.section || '').toLowerCase();
                        if (sec.includes('breakfast') || sec.includes('brunch')) cals.breakfast += val;
                        else if (sec.includes('lunch')) cals.lunch += val;
                        else if (sec.includes('dinner')) cals.dinner += val;
                        else cals.other += val;
                    }
                });
                ui.calVal.textContent = Math.round(cals.total);
                ui.calBreakdown.breakfast.textContent = Math.round(cals.breakfast);
                ui.calBreakdown.lunch.textContent = Math.round(cals.lunch);
                ui.calBreakdown.dinner.textContent = Math.round(cals.dinner);
                ui.calBreakdown.snacks.textContent = Math.round(cals.other);
            }));

            unsubscribers.push(onSnapshot(doc(db, `users/${uid}/settings/dailyPlan`), (snap) => {
                state.dailyPlan = snap.exists() ? (snap.data().dailyLogs || []) : [];
                renderDailies();
            }));

            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/medications`), (snap) => {
                state.medsSchedule = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMeds();
            }));

            const dosesQ = query(collection(db, `users/${uid}/doses`), where('date', '>=', todayStr));
            unsubscribers.push(onSnapshot(dosesQ, (snap) => {
                state.todayDoses = []; 
                snap.forEach(d => {
                    const data = d.data();
                    if (data.date.startsWith(todayStr)) {
                        state.todayDoses.push({id: d.id, ...data});
                    }
                });
                renderMeds();
            }));

            const recentDosesQ = query(collection(db, `users/${uid}/doses`), orderBy('date', 'desc'), limit(3));
            unsubscribers.push(onSnapshot(recentDosesQ, (snap) => {
                state.recentMedLogs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMeds();
            }));
        };

        const cleanupListeners = () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        };

        let waterChartInstance = null;
        function updateWaterChart(current, goal) {
            const ctx = document.getElementById('water-chart').getContext('2d');
            if (waterChartInstance) waterChartInstance.destroy();
            
            waterChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Drank', 'Remaining'],
                    datasets: [{
                        data: [current, Math.max(0, goal - current)],
                        backgroundColor: ['#3b82f6', '#e5e7eb'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        const refreshBtn = document.getElementById('refresh-btn');
        if(refreshBtn) refreshBtn.style.display = 'none'; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                ui.loginPrompt.classList.add('hidden');
                ui.grid.classList.remove('hidden');
                ui.authContainer.classList.remove('hidden');
                fetchWeather(user.uid);

                getDoc(doc(db, 'users', user.uid, 'settings', 'theme')).then(snap => {
                    applyTheme(snap.exists() ? snap.data().theme : 'light');
                });

                getDoc(doc(db, 'users', user.uid, 'services', 'trakt')).then(snap => {
                    if (snap.exists() && snap.data().accessToken) {
                        updateVidTrackrWidget(snap.data().accessToken); 
                    } else {
                        ui.videoContainer.innerHTML = `<div class="w-full text-center text-sm text-[var(--text-secondary)]">VidTrackr not connected.</div>`;
                    }
                });

                getDoc(doc(db, 'users', user.uid, 'services', 'lastfm')).then(snap => {
                    if (snap.exists() && snap.data().username) {
                        const fmUser = snap.data().username;
                        fetchLastFm(fmUser);
                        const fmInterval = setInterval(() => fetchLastFm(fmUser), 15000);
                        unsubscribers.push(() => clearInterval(fmInterval));
                    } else {
                        ui.musicContainer.innerHTML = `
                            <div class="text-center">
                               <p class="text-xs text-[var(--text-secondary)] mb-1">Last.fm not linked</p>
                               <a href="/account" class="text-[10px] underline">Connect in Settings</a>
                            </div>`;
                    }
                });

                const localToken = localStorage.getItem('ticktick_token');
                if (localToken) {
                    fetchTickTickCount(localToken);
                } else {
                     getDoc(doc(db, 'users', user.uid, 'services', 'ticktick')).then(snap => {
                        if (snap.exists() && snap.data().token) {
                            fetchTickTickCount(snap.data().token);
                        } else {
                             ui.inboxCount.innerHTML = `<a href="/tasktrackr" class="text-xs underline text-gray-400">Connect</a>`;
                        }
                    });
                }

                setupListeners(user.uid);
            } else {
                currentUser = null;
                cleanupListeners();
                ui.loginPrompt.classList.remove('hidden');
                ui.grid.classList.add('hidden');
                ui.authContainer.classList.add('hidden');
            }
        });
    </script>
</body>
</html>