<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colour Palette Generator - Lifeblogging Hub</title>
    <link rel="icon" href="/favicons/palette.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker registered successfully:', registration))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg-color: white;
            --text-color-primary: #111827;
            --text-color-secondary: #4b5563;
            --input-bg-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        .dark {
            --bg-color: #111827;
            --card-bg-color: #1f2937;
            --text-color-primary: #f9fafb;
            --text-color-secondary: #9ca3af;
            --input-bg-color: #374151;
            --border-color: #4b5563;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
        }
        .theme-switcher {
            background-color: var(--card-bg-color);
            border: 1px solid var(--text-color-secondary);
        }
        .color-card {
            height: 150px;
            transition: transform 0.2s ease-in-out;
            position: relative; /* Needed for the add button */
        }
        .color-card:hover {
            transform: translateY(-5px);
        }
        .color-info {
            font-family: 'Roboto Mono', monospace;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .color-info:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 56px;
            height: 56px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch {
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }
        input[type="color"]::-moz-color-swatch {
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }
         .saved-palette-item button {
            transition: color 0.2s;
         }
         .saved-palette-item button:hover {
            color: var(--text-color-primary);
         }
        .color-detail-box {
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
        }
        .add-to-custom-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .color-card:hover .add-to-custom-btn {
            opacity: 1;
        }
        .editable-color-swatch {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .gradient-preview {
            height: 60px;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold flex items-center">
                <i class="fas fa-palette mr-3 text-indigo-500"></i>Colour Palette Generator
            </h1>
            <div class="flex items-center gap-4">
                <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
                <button id="theme-toggle" class="theme-switcher rounded-full p-2" title="Toggle dark mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="bg-[var(--card-bg-color)] shadow-lg rounded-xl p-6 md:p-8 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                <div class="flex flex-col gap-4">
                    <h3 class="font-bold text-lg text-center lg:text-left">Base Color</h3>
                    <div class="flex items-center gap-4">
                        <input type="color" id="base-color-picker" value="#6366f1">
                        <div class="w-full">
                            <label for="base-color-hex" class="block text-sm font-medium text-[var(--text-color-secondary)]">HEX</label>
                            <input type="text" id="base-color-hex" value="#6366F1" class="font-mono w-full p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                           <label for="base-color-r" class="block text-sm font-medium text-[var(--text-color-secondary)]">R</label>
                           <input type="number" id="base-color-r" min="0" max="255" value="99" class="font-mono w-full p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                           <label for="base-color-g" class="block text-sm font-medium text-[var(--text-color-secondary)]">G</label>
                           <input type="number" id="base-color-g" min="0" max="255" value="102" class="font-mono w-full p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                           <label for="base-color-b" class="block text-sm font-medium text-[var(--text-color-secondary)]">B</label>
                           <input type="number" id="base-color-b" min="0" max="255" value="241" class="font-mono w-full p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                     <div id="color-info-panel" class="mt-4 p-4 rounded-lg color-detail-box space-y-2">
                        </div>
                </div>

                <div class="flex flex-col gap-4">
                     <h3 class="font-bold text-lg text-center lg:text-left">Generation Settings</h3>
                     <div>
                        <label for="palette-mode" class="block text-sm font-medium text-[var(--text-color-secondary)] mb-1">Mode</label>
                        <select id="palette-mode" class="w-full p-3 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="tailwind">Tailwind Shades</option>
                            <option value="monochromatic">Monochromatic</option>
                            <option value="analogous">Analogous</option>
                            <option value="complementary">Complementary</option>
                            <option value="triadic">Triadic</option>
                        </select>
                    </div>
                     <div>
                        <label for="palette-style" class="block text-sm font-medium text-[var(--text-color-secondary)] mb-1">Style</label>
                        <select id="palette-style" class="w-full p-3 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="default">Default</option>
                            <option value="vibrant">Vibrant</option>
                            <option value="pastel">Pastel</option>
                            <option value="muted">Muted</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <div>
                        <label for="color-count" class="block text-sm font-medium text-[var(--text-color-secondary)] mb-1">Color Count</label>
                        <input type="number" id="color-count" value="10" min="3" max="12" class="w-full p-3 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                 <div class="flex flex-col justify-between items-stretch h-full gap-4 pt-4 lg:pt-0">
                     <button id="generate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        <i class="fas fa-sync-alt mr-2"></i>Generate
                    </button>
                    <button id="show-save-modal-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                        <i class="fas fa-save mr-2"></i>Save Generated Palette
                    </button>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-[var(--border-color)]">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Saved Palettes</h3>
                    <input type="text" id="label-filter-input" placeholder="Filter by label..." class="p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                 </div>
                 <div id="saved-palettes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                     </div>
            </div>
        </div>
        
        <div id="palette-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
        </div>

        <div id="custom-palette-section" class="mt-8 bg-[var(--card-bg-color)] shadow-lg rounded-xl p-6 md:p-8 mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 id="custom-palette-title" class="font-bold text-lg">Your Custom Palette</h3>
                <div>
                    <button id="save-custom-palette-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm mr-2"><i class="fas fa-save mr-2"></i>Save Custom</button>
                    <button id="clear-custom-palette-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 text-sm"><i class="fas fa-trash mr-2"></i>Clear</button>
                </div>
            </div>
            <div id="custom-palette-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            </div>
        </div>
    </div>
    
    <div id="copy-toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        Copied to clipboard!
    </div>

    <div id="save-palette-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-[var(--card-bg-color)] p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Save Palette</h3>
            <div class="space-y-4">
                <div>
                    <label for="palette-name-input" class="block text-sm font-medium text-[var(--text-color-secondary)]">Palette Name</label>
                    <input type="text" id="palette-name-input" placeholder="e.g., 'Primary Brand Colors'" class="mt-1 w-full p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="palette-labels-input" class="block text-sm font-medium text-[var(--text-color-secondary)]">Labels (comma-separated)</label>
                    <input type="text" id="palette-labels-input" placeholder="e.g., branding, website" class="mt-1 w-full p-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--input-bg-color)] focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancel-save-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancel</button>
                <button id="confirm-save-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- UI ELEMENTS ---
        const colorPicker = document.getElementById('base-color-picker');
        const hexInput = document.getElementById('base-color-hex');
        const rInput = document.getElementById('base-color-r');
        const gInput = document.getElementById('base-color-g');
        const bInput = document.getElementById('base-color-b');
        const colorInfoPanel = document.getElementById('color-info-panel');
        const paletteModeSelect = document.getElementById('palette-mode');
        const paletteStyleSelect = document.getElementById('palette-style');
        const colorCountInput = document.getElementById('color-count');
        const generateBtn = document.getElementById('generate-btn');
        const paletteContainer = document.getElementById('palette-container');
        const themeToggle = document.getElementById('theme-toggle');
        const showSaveModalBtn = document.getElementById('show-save-modal-btn');
        const savePaletteModal = document.getElementById('save-palette-modal');
        const paletteNameInput = document.getElementById('palette-name-input');
        const paletteLabelsInput = document.getElementById('palette-labels-input');
        const cancelSaveBtn = document.getElementById('cancel-save-btn');
        const confirmSaveBtn = document.getElementById('confirm-save-btn');
        const savedPalettesContainer = document.getElementById('saved-palettes-container');
        const customPaletteSection = document.getElementById('custom-palette-section');
        const customPaletteTitle = document.getElementById('custom-palette-title');
        const customPaletteContainer = document.getElementById('custom-palette-container');
        const saveCustomPaletteBtn = document.getElementById('save-custom-palette-btn');
        const clearCustomPaletteBtn = document.getElementById('clear-custom-palette-btn');
        const labelFilterInput = document.getElementById('label-filter-input');
        
        // --- THEME LOGIC ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        };
        themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
        applyTheme(localStorage.getItem('theme') || 'light');

        // --- SAVED & CUSTOM PALETTES LOGIC ---
        let savedPalettes = [];
        let customPalette = [];
        let editingPaletteId = null;

        function savePalettesToStorage() {
            localStorage.setItem('savedPalettes', JSON.stringify(savedPalettes));
        }

        function loadPalettesFromStorage() {
            const saved = localStorage.getItem('savedPalettes');
            if (saved) {
                savedPalettes = JSON.parse(saved);
                renderSavedPalettes();
            }
        }

        function addPalette(name, labels, isCustom = false) {
            if (!name) return;
            
            let settings;
            let colors;

            if (isCustom) {
                if (customPalette.length < 2) {
                    alert("Please add at least 2 colors to your custom palette before saving.");
                    return;
                }
                settings = { custom: true };
                colors = customPalette;

                if (editingPaletteId) {
                    const paletteIndex = savedPalettes.findIndex(p => p.id === editingPaletteId);
                    if (paletteIndex > -1) {
                        savedPalettes[paletteIndex].name = name;
                        savedPalettes[paletteIndex].labels = labels;
                        savedPalettes[paletteIndex].colors = colors.map(c => c.hex);
                    }
                } else {
                     const newPalette = {
                        id: Date.now().toString(), name, labels, settings,
                        colors: colors.map(c => c.hex)
                    };
                    savedPalettes.unshift(newPalette);
                }

            } else {
                settings = {
                    baseColor: colorPicker.value, mode: paletteModeSelect.value,
                    style: paletteStyleSelect.value, count: parseInt(colorCountInput.value)
                };
                colors = generatePaletteColors(settings);
                const newPalette = {
                    id: Date.now().toString(), name, labels, settings,
                    colors: colors.map(c => c.hex)
                };
                savedPalettes.unshift(newPalette);
            }

            savePalettesToStorage();
            renderSavedPalettes();
            closeSaveModal();
            if(isCustom) clearCustomPalette();
        }


        function removePalette(id) {
            savedPalettes = savedPalettes.filter(p => p.id !== id);
            savePalettesToStorage();
            renderSavedPalettes();
        }
        
        function loadPaletteSettings(id) {
            const palette = savedPalettes.find(p => p.id === id);
            if (palette) {
                 if (palette.settings.custom) {
                    renderPalette(palette.colors.map(hex => {
                        const { r, g, b } = hexToRgb(hex);
                        return { hex, rgb: `rgb(${r}, ${g}, ${b})` };
                    }));
                 } else {
                    const { settings } = palette;
                    colorPicker.value = settings.baseColor;
                    paletteModeSelect.value = settings.mode;
                    paletteStyleSelect.value = settings.style;
                    colorCountInput.value = settings.count;
                    updateColorInputs('picker');
                    generatePalette();
                 }
            }
        }

        function editCustomPalette(id) {
            const palette = savedPalettes.find(p => p.id === id);
            if (palette && palette.settings.custom) {
                customPalette = palette.colors.map(hex => {
                    const {r,g,b} = hexToRgb(hex);
                    return { hex, rgb: `rgb(${r},${g},${b})` };
                });
                editingPaletteId = id;
                customPaletteTitle.textContent = `Editing: ${palette.name}`;
                saveCustomPaletteBtn.textContent = 'Update Palette';
                renderCustomPalette();
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        function renderSavedPalettes() {
            const filterTerm = labelFilterInput.value.toLowerCase().trim();
            const filteredPalettes = filterTerm 
                ? savedPalettes.filter(p => p.labels && p.labels.some(l => l.toLowerCase().includes(filterTerm)))
                : savedPalettes;
            
            savedPalettesContainer.innerHTML = '';
            if (filteredPalettes.length === 0) {
                savedPalettesContainer.innerHTML = `<p class="text-sm text-[var(--text-color-secondary)] md:col-span-2 lg:col-span-3">No palettes found.</p>`;
                return;
            }
            filteredPalettes.forEach(palette => {
                const item = document.createElement('div');
                item.className = 'saved-palette-item flex flex-col justify-between gap-3 p-3 bg-[var(--input-bg-color)] rounded-lg border border-[var(--border-color)]';
                
                const previewColors = palette.colors;
                const previewHtml = previewColors.slice(0, 7).map(c => `<div class="h-5 w-5 flex-1 rounded" style="background-color: ${c};" title="${c}"></div>`).join('');
                const labelsHtml = (palette.labels || []).map(l => `<span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-0.5 rounded-full">${l}</span>`).join(' ');
                
                const editButtonHtml = palette.settings.custom 
                    ? `<button class="edit-custom-palette-btn text-blue-500/70 hover:text-blue-500" data-id="${palette.id}" title="Edit Palette"><i class="fas fa-edit"></i> Edit</button>` 
                    : '';

                item.innerHTML = `
                    <div>
                        <p class="font-bold truncate" title="${palette.name}">${palette.name}</p>
                        <div class="flex flex-wrap gap-1 mt-2 text-xs">${labelsHtml}</div>
                        <div class="flex gap-1 mt-2">${previewHtml}</div>
                    </div>
                    <div class="flex gap-2 self-end">
                        ${editButtonHtml}
                        <button class="load-palette-btn text-[var(--text-color-secondary)]" data-id="${palette.id}" title="Load Palette"><i class="fas fa-eye"></i> Load</button>
                        <button class="remove-palette-btn text-red-500/70 hover:text-red-500" data-id="${palette.id}" title="Delete Palette"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                savedPalettesContainer.appendChild(item);
            });
        }
        
        savedPalettesContainer.addEventListener('click', (e) => {
            const loadBtn = e.target.closest('.load-palette-btn');
            const removeBtn = e.target.closest('.remove-palette-btn');
            const editBtn = e.target.closest('.edit-custom-palette-btn');
            if (loadBtn) loadPaletteSettings(loadBtn.dataset.id);
            if (removeBtn) removePalette(removeBtn.dataset.id);
            if (editBtn) editCustomPalette(editBtn.dataset.id);
        });
        labelFilterInput.addEventListener('input', renderSavedPalettes);

        // --- SAVE MODAL LOGIC ---
        let isSavingCustom = false;
        function openSaveModal(forCustom = false) {
            isSavingCustom = forCustom;
            paletteNameInput.value = '';
            paletteLabelsInput.value = '';

            if (isSavingCustom && editingPaletteId) {
                const palette = savedPalettes.find(p => p.id === editingPaletteId);
                if (palette) {
                    paletteNameInput.value = palette.name;
                    paletteLabelsInput.value = (palette.labels || []).join(', ');
                }
            }
            savePaletteModal.classList.remove('hidden');
            savePaletteModal.classList.add('flex');
            paletteNameInput.focus();
        }
        function closeSaveModal() {
            savePaletteModal.classList.add('hidden');
            savePaletteModal.classList.remove('flex');
        }
        showSaveModalBtn.addEventListener('click', () => openSaveModal(false));
        saveCustomPaletteBtn.addEventListener('click', () => openSaveModal(true));
        cancelSaveBtn.addEventListener('click', closeSaveModal);
        confirmSaveBtn.addEventListener('click', () => {
            const name = paletteNameInput.value.trim();
            const labels = paletteLabelsInput.value.split(',').map(l => l.trim()).filter(Boolean);
            addPalette(name, labels, isSavingCustom)
        });
        savePaletteModal.addEventListener('click', (e) => {
            if (e.target === savePaletteModal) closeSaveModal();
        });

        // --- CUSTOM PALETTE LOGIC ---
        function addToCustomPalette(color) {
            customPalette.push(color);
            renderCustomPalette();
        }
        
        function removeFromCustomPalette(hex) {
            customPalette = customPalette.filter(c => c.hex !== hex);
            renderCustomPalette();
        }

        function clearCustomPalette() {
            customPalette = [];
            editingPaletteId = null;
            customPaletteTitle.textContent = 'Your Custom Palette';
            saveCustomPaletteBtn.textContent = 'Save Custom';
            renderCustomPalette();
        }
        
        function renderCustomPalette() {
            if (customPalette.length > 0) {
                customPaletteSection.classList.remove('hidden');
            } else {
                customPaletteSection.classList.add('hidden');
            }
            customPaletteContainer.innerHTML = '';
            customPalette.forEach((color, index) => {
                const isDark = rgbToHsl(hexToRgb(color.hex).r, hexToRgb(color.hex).g, hexToRgb(color.hex).b).l < 50;
                const textColor = isDark ? 'text-white' : 'text-black';
                
                const card = document.createElement('div');
                card.className = `color-card rounded-lg shadow-md flex flex-col justify-end p-3 ${textColor}`;
                card.style.backgroundColor = color.hex;
                
                card.innerHTML = `
                    <button class="remove-from-custom-btn add-to-custom-btn !opacity-100" data-hex="${color.hex}"><i class="fas fa-times"></i></button>
                    <label class="editable-color-swatch">
                        <input type="color" class="opacity-0 absolute inset-0 w-full h-full" value="${color.hex}" data-index="${index}">
                    </label>
                    <div class="color-info p-1 rounded text-sm font-semibold" data-copy="${color.hex}">${color.hex}</div>
                    <div class="color-info p-1 rounded text-sm font-semibold" data-copy="${color.rgb}">${color.rgb}</div>
                `;
                customPaletteContainer.appendChild(card);
            });
        }
        clearCustomPaletteBtn.addEventListener('click', clearCustomPalette);
        customPaletteContainer.addEventListener('click', (e) => {
            const copyEl = e.target.closest('.color-info');
            const removeBtn = e.target.closest('.remove-from-custom-btn');
            if (copyEl) copyToClipboard(copyEl.dataset.copy);
            if (removeBtn) removeFromCustomPalette(removeBtn.dataset.hex);
        });
        customPaletteContainer.addEventListener('input', (e) => {
            if (e.target.type === 'color') {
                const index = parseInt(e.target.dataset.index);
                const newHex = e.target.value.toUpperCase();
                const {r,g,b} = hexToRgb(newHex);
                customPalette[index] = { hex: newHex, rgb: `rgb(${r},${g},${b})`};
                renderCustomPalette();
            }
        });

        // --- COLOR CONVERSION UTILITIES ---
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) {
                r = parseInt(hex[0] + hex[0], 16);
                g = parseInt(hex[1] + hex[1], 16);
                b = parseInt(hex[2] + hex[2], 16);
            } else if (hex.length === 6) {
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            }
            return { r, g, b };
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }
        
        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max == min) { h = s = 0; } 
            else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }

        function hslToRgb(h, s, l) {
            s /= 100; l /= 100;
            let c = (1 - Math.abs(2 * l - 1)) * s,
                x = c * (1 - Math.abs((h / 60) % 2 - 1)),
                m = l - c/2,
                r = 0, g = 0, b = 0;
            if (0 <= h && h < 60) { r = c; g = x; b = 0; } 
            else if (60 <= h && h < 120) { r = x; g = c; b = 0; } 
            else if (120 <= h && h < 180) { r = 0; g = c; b = x; } 
            else if (180 <= h && h < 240) { r = 0; g = x; b = c; } 
            else if (240 <= h && h < 300) { r = x; g = 0; b = c; } 
            else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
            r = Math.round((r + m) * 255);
            g = Math.round((g + m) * 255);
            b = Math.round((b + m) * 255);
            return { r, g, b };
        }

        // --- COLOR STATE MANAGEMENT ---
        function updateColorInputs(source) {
            let hex, r, g, b;
            if (source === 'picker') {
                hex = colorPicker.value.toUpperCase();
                const rgb = hexToRgb(hex);
                r = rgb.r; g = rgb.g; b = rgb.b;
            } else if (source === 'hex') {
                hex = hexInput.value.toUpperCase();
                if (!/^#[0-9A-F]{6}$/i.test(hex) && !/^#[0-9A-F]{3}$/i.test(hex)) return;
                const rgb = hexToRgb(hex);
                r = rgb.r; g = rgb.g; b = rgb.b;
            } else if (source === 'rgb') {
                r = parseInt(rInput.value);
                g = parseInt(gInput.value);
                b = parseInt(bInput.value);
                if (isNaN(r) || isNaN(g) || isNaN(b)) return;
                r = Math.max(0, Math.min(255, r));
                g = Math.max(0, Math.min(255, g));
                b = Math.max(0, Math.min(255, b));
                hex = rgbToHex(r, g, b);
            }

            if (source !== 'picker') colorPicker.value = hex;
            if (source !== 'hex') hexInput.value = hex;
            if (source !== 'rgb') {
                rInput.value = r;
                gInput.value = g;
                bInput.value = b;
            }
            updateColorInfo(hex);
        }

        function updateColorInfo(hex) {
            const { r, g, b } = hexToRgb(hex);
            const { h, s, l } = rgbToHsl(r, g, b);
            const tailwind = findClosestTailwindColor(hex);

            colorInfoPanel.innerHTML = `
                <div class="font-mono text-sm">
                    <div class="flex justify-between"><span>Tailwind:</span> <strong>${tailwind.name}-${tailwind.shade}</strong></div>
                    <div class="flex justify-between"><span>HEX:</span> <strong>${hex}</strong></div>
                    <div class="flex justify-between"><span>RGB:</span> <strong>${r}, ${g}, ${b}</strong></div>
                    <div class="flex justify-between"><span>HSL:</span> <strong>${h.toFixed(0)}°, ${s.toFixed(0)}%, ${l.toFixed(0)}%</strong></div>
                </div>
            `;
        }

        // --- PALETTE GENERATION LOGIC ---
        function applyStyleModifier(color, style) {
            if (style === 'default') return color;
            
            const { r, g, b } = hexToRgb(color.hex);
            let { h, s, l } = rgbToHsl(r, g, b);

            switch(style) {
                case 'vibrant': s = Math.min(100, s + 20); break;
                case 'pastel': s = Math.max(0, s - 20); l = Math.min(100, l + 15); break;
                case 'muted': s = Math.max(0, s - 30); break;
                case 'dark': l = Math.max(0, l - 20); break;
            }
            
            const newRgb = hslToRgb(h, s, l);
            return {
                hex: rgbToHex(newRgb.r, newRgb.g, newRgb.b),
                rgb: `rgb(${newRgb.r}, ${newRgb.g}, ${newRgb.b})`,
                tailwind: color.tailwind // Preserve tailwind name if it exists
            };
        }
        
        function generatePaletteColors(settings) {
            const { baseColor, mode, count, style } = settings;
            const { r, g, b } = hexToRgb(baseColor);
            const { h, s, l } = rgbToHsl(r, g, b);
            
            let colors = [];
            
            switch(mode) {
                case 'monochromatic':
                    for (let i = 0; i < count; i++) {
                        let newLightness = l + (i - Math.floor(count / 2)) * (80 / count);
                        newLightness = Math.max(5, Math.min(95, newLightness));
                        const {r: newR, g: newG, b: newB} = hslToRgb(h, s, newLightness);
                        colors.push({hex: rgbToHex(newR, newG, newB), rgb: `rgb(${newR}, ${newG}, ${newB})`});
                    }
                    break;
                case 'analogous':
                    const step = 30;
                    for (let i = 0; i < count; i++) {
                        let newHue = (h + (i - Math.floor(count / 2)) * step + 360) % 360;
                        const {r: newR, g: newG, b: newB} = hslToRgb(newHue, s, l);
                        colors.push({hex: rgbToHex(newR, newG, newB), rgb: `rgb(${newR}, ${newG}, ${newB})`});
                    }
                    break;
                case 'complementary':
                    colors.push({hex: baseColor, rgb: `rgb(${r}, ${g}, ${b})`});
                    const complementaryHue = (h + 180) % 360;
                    for (let i = 1; i < count; i++) {
                        let newLightness = l + (Math.random() - 0.5) * 40;
                        newLightness = Math.max(10, Math.min(90, newLightness));
                        const {r: newR, g: newG, b: newB} = hslToRgb(complementaryHue, s, newLightness);
                        colors.push({hex: rgbToHex(newR, newG, newB), rgb: `rgb(${newR}, ${newG}, ${newB})`});
                    }
                    break;
                 case 'triadic':
                    const hue2 = (h + 120) % 360;
                    const hue3 = (h + 240) % 360;
                    const hues = [h, hue2, hue3];
                    for(let i = 0; i < count; i++){
                        const baseHue = hues[i % 3];
                        let newLightness = l + (Math.floor(i/3) - 1) * 15 + (Math.random() - 0.5) * 10;
                        newLightness = Math.max(10, Math.min(90, newLightness));
                        const {r: newR, g: newG, b: newB} = hslToRgb(baseHue, s, newLightness);
                        colors.push({hex: rgbToHex(newR, newG, newB), rgb: `rgb(${newR}, ${newG}, ${newB})`});
                    }
                    break;
                case 'tailwind':
                default:
                    const shades = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950].slice(0, count > 11 ? 11 : count);
                    const { name: twName } = findClosestTailwindColor(baseColor);
                    shades.forEach(shade => {
                        const twColor = tailwindColors[twName][shade];
                        const {r: twR, g: twG, b: twB} = hexToRgb(twColor);
                        colors.push({
                            hex: twColor, 
                            rgb: `rgb(${twR}, ${twG}, ${twB})`, 
                            tailwind: `${twName}-${shade}`
                        });
                    });
                    break;
            }
            return colors.map(c => applyStyleModifier(c, style));
        }

        function generatePalette() {
            const currentSettings = {
                baseColor: colorPicker.value,
                mode: paletteModeSelect.value,
                style: paletteStyleSelect.value,
                count: parseInt(colorCountInput.value)
            };
            const styledColors = generatePaletteColors(currentSettings);
            renderPalette(styledColors);
        }

        // --- TAILWIND COLORS ---
        const tailwindColors = {
            slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
            gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827', 950: '#030712' },
            zinc: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b', 950: '#09090b' },
            neutral: { 50: '#fafafa', 100: '#f5f5f5', 200: '#e5e5e5', 300: '#d4d4d4', 400: '#a3a3a3', 500: '#737373', 600: '#525252', 700: '#404040', 800: '#262626', 900: '#171717', 950: '#0a0a0a' },
            stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917', 950: '#0c0a09' },
            red: { 50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d', 950: '#450a0a' },
            orange: { 50: '#fff7ed', 100: '#ffedd5', 200: '#fed7aa', 300: '#fdba74', 400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c', 800: '#9a3412', 900: '#7c2d12', 950: '#431407' },
            amber: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f', 950: '#451a03' },
            yellow: { 50: '#fefce8', 100: '#fef9c3', 200: '#fef08a', 300: '#fde047', 400: '#facc15', 500: '#eab308', 600: '#ca8a04', 700: '#a16207', 800: '#854d0e', 900: '#713f12', 950: '#422006' },
            lime: { 50: '#f7fee7', 100: '#ecfccb', 200: '#d9f99d', 300: '#bef264', 400: '#a3e635', 500: '#84cc16', 600: '#65a30d', 700: '#4d7c0f', 800: '#3f6212', 900: '#365314', 950: '#1a2e05' },
            green: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d', 950: '#052e16' },
            emerald: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22' },
            teal: { 50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a', 950: '#042f2e' },
            cyan: { 50: '#ecfeff', 100: '#cffafe', 200: '#a5f3fc', 300: '#67e8f9', 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2', 700: '#0e7490', 800: '#155e75', 900: '#164e63', 950: '#083344' },
            sky: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e', 950: '#082f49' },
            blue: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a', 950: '#172554' },
            indigo: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81', 950: '#1e1b4b' },
            violet: { 50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95', 950: '#2e1065' },
            purple: { 50: '#faf5ff', 100: '#f3e8ff', 200: '#e9d5ff', 300: '#d8b4fe', 400: '#c084fc', 500: '#a855f7', 600: '#9333ea', 700: '#7e22ce', 800: '#6b21a8', 900: '#581c87', 950: '#3b0764' },
            fuchsia: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75', 950: '#4a044e' },
            pink: { 50: '#fdf2f8', 100: '#fce7f3', 200: '#fbcfe8', 300: '#f9a8d4', 400: '#f472b6', 500: '#ec4899', 600: '#db2777', 700: '#be185d', 800: '#9d174d', 900: '#831843', 950: '#500724' },
            rose: { 50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 300: '#fda4af', 400: '#fb7185', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c', 800: '#9f1239', 900: '#881337', 950: '#4c0519' },
        };
        
        function findClosestTailwindColor(hex) {
            let minDistance = Infinity;
            let closestColor = { name: 'gray', shade: '500' };
            const inputRgb = hexToRgb(hex);

            for (const colorName in tailwindColors) {
                for (const shade in tailwindColors[colorName]) {
                    const shadeHex = tailwindColors[colorName][shade];
                    const shadeRgb = hexToRgb(shadeHex);
                    const distance = Math.sqrt(
                        Math.pow(inputRgb.r - shadeRgb.r, 2) +
                        Math.pow(inputRgb.g - shadeRgb.g, 2) +
                        Math.pow(inputRgb.b - shadeRgb.b, 2)
                    );
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = { name: colorName, shade: shade };
                    }
                }
            }
            return closestColor;
        }

        // --- UI RENDERING & EVENTS ---
        function renderPalette(colors) {
            paletteContainer.innerHTML = '';
            colors.forEach(color => {
                const isDark = rgbToHsl(hexToRgb(color.hex).r, hexToRgb(color.hex).g, hexToRgb(color.hex).b).l < 50;
                const textColor = isDark ? 'text-white' : 'text-black';
                
                const card = document.createElement('div');
                card.className = `color-card rounded-lg shadow-md flex flex-col justify-end p-3 ${textColor}`;
                card.style.backgroundColor = color.hex;
                
                let tailwindInfo = '';
                if (color.tailwind && paletteModeSelect.value === 'tailwind' && paletteStyleSelect.value === 'default') {
                    tailwindInfo = `<div class="color-info p-1 rounded text-sm font-semibold" data-copy="${color.tailwind}">${color.tailwind}</div>`;
                }

                card.innerHTML = `
                    <button class="add-to-custom-btn" data-color='${JSON.stringify(color)}'><i class="fas fa-plus"></i></button>
                    ${tailwindInfo}
                    <div class="color-info p-1 rounded text-sm font-semibold" data-copy="${color.hex}">${color.hex}</div>
                    <div class="color-info p-1 rounded text-sm font-semibold" data-copy="${color.rgb}">${color.rgb}</div>
                `;
                paletteContainer.appendChild(card);
            });
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('copy-toast');
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 2000);
            });
        }
        
        // --- EVENT LISTENERS ---
        colorPicker.addEventListener('input', () => updateColorInputs('picker'));
        hexInput.addEventListener('input', () => updateColorInputs('hex'));
        rInput.addEventListener('input', () => updateColorInputs('rgb'));
        gInput.addEventListener('input', () => updateColorInputs('rgb'));
        bInput.addEventListener('input', () => updateColorInputs('rgb'));
        
        paletteContainer.addEventListener('click', (e) => {
            const infoElement = e.target.closest('.color-info');
            const addBtn = e.target.closest('.add-to-custom-btn');
            if (infoElement) {
                copyToClipboard(infoElement.dataset.copy);
            }
            if (addBtn) {
                const colorData = JSON.parse(addBtn.dataset.color);
                addToCustomPalette(colorData);
            }
        });
        
        generateBtn.addEventListener('click', generatePalette);
        
        paletteModeSelect.addEventListener('change', () => {
             const isTailwind = paletteModeSelect.value === 'tailwind';
             colorCountInput.disabled = isTailwind;
             if (isTailwind) colorCountInput.value = 11;
             generatePalette();
        });

        [colorCountInput, paletteStyleSelect].forEach(el => el.addEventListener('change', generatePalette));

        // --- INITIAL LOAD ---
        loadPalettesFromStorage();
        updateColorInputs('picker');
        generatePalette();
    </script>
</body>
</html>