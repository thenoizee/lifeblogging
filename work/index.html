<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Generator</title>
    <link rel="icon" href="/favicons/envelope-open-text.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
    /* --- THEME VARIABLES --- */
    :root {
    --primary: #D946EF;
    --primary-hover: #4338ca;
    --secondary: #475569; /* Darkened from Slate-500 to Slate-600 for better readability */
    
    --bg-light: #f8fafc;
    --card-light: #ffffff;
    --text-light: #0f172a;
    
    /* CHANGED: Darkened border color for clear definition */
    --border-light: #cbd5e1; /* Slate-300 (was Slate-200) */
    --input-bg-light: #ffffff;
    
    --bg-dark: #0f172a;
    --card-dark: #1e293b;
    --text-dark: #f8fafc;
    --border-dark: #334155;
    --input-bg-dark: #0f172a;

    --bg: var(--bg-light);
    --card: var(--card-light);
    --text: var(--text-light);
    --border-color: var(--border-light);
    --input-bg: var(--input-bg-light);
    
    --moon-display: block; --sun-display: none;
}

    html.dark {
        --bg: var(--bg-dark);
        --card: var(--card-dark);
        --text: var(--text-dark);
        --border-color: var(--border-dark);
        --input-bg: var(--input-bg-dark);
        --moon-display: none; --sun-display: block;
        color-scheme: dark;
    }

    body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }

    body {
    height: 100vh;
    overflow: hidden; /* Prevent double scrollbars */
}
    
    /* --- GENERAL UI COMPONENTS --- */
    .card, .step-card { 
        background-color: var(--card); 
        border: 1px solid var(--border-color); 
        border-radius: 0.75rem; 
        transition: all 0.2s ease-in-out; 
    }
    .btn-primary { 
        background-color: var(--primary); color: white; 
        padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; 
        transition: 0.2s; 
    }
    .btn-primary:hover { background-color: var(--primary-hover); }

    input, select, textarea {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        color: var(--text);
        border-radius: 0.5rem;
        transition: ring 0.2s, border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); /* Indigo glow */
    }

    /* --- NAVIGATION --- */
    .nav-tab {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        color: var(--secondary);
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }
    .nav-tab:hover { background-color: rgba(0,0,0,0.05); color: var(--text); }
    .dark .nav-tab:hover { background-color: rgba(255,255,255,0.05); }
    
    /* DISTINCT ACTIVE TAB */
    .nav-tab.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }

    /* ... existing styles ... */
    .writing-vertical { writing-mode: vertical-rl; }
    
    /* Layout Transitions */
    .manage-grid { 
    display: grid; 
    grid-template-columns: 350px 1fr; /* Wider sidebar */
    gap: 1.5rem; 
    height: calc(100vh - 120px); /* Adjust height to fit screen better */
}
    
    /* Collapsed State */
    .manage-grid.sidebar-closed {
        grid-template-columns: 48px 1fr;
    }

    /* --- TEMPLATE GRID (STEP 1) --- */
    #template-list-container {
    display: grid;
    /* Reduced min-width from 280px to 240px to fit smaller phones */
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
    gap: 1rem;
}
    .template-item {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        background-color: var(--card);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        height: 100%;
    }
    .template-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
    }
    .template-item.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--primary);
    }

    /* --- USE TAB LAYOUT --- */
    .use-grid { 
    display: grid; 
    grid-template-columns: 350px 1fr; /* Wider sidebar */
    gap: 1.5rem; 
    height: calc(100vh - 120px); 
}

    /* Update this in your CSS */
::placeholder {
    color: #4a5568 !important;
    opacity: 1 !important;
    font-weight: 500;
}


    
    @media (max-width: 1024px) {
        .use-grid { 
            display: flex; 
            flex-direction: column; 
            height: auto; 
        }
        .use-sidebar { 
            height: auto; 
            max-height: 300px;
        }
    }

    /* Template List Item Styling */
    .template-list-item {
        padding: 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s;
    }
    .template-list-item:hover {
        background-color: var(--bg-light);
    }
    .dark .template-list-item:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .template-list-item.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    .template-list-item.active .text-gray-500 {
        color: rgba(255,255,255,0.8);
    }
    
    /* Scrollbar Polish for horizontal lists */
    .scrollbar-thin::-webkit-scrollbar { height: 4px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 2px; }

    /* --- EMAIL CLIENT SIMULATION (STEP 3) --- */
    .email-client-window {
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    overflow: hidden; /* Clips content */
    background-color: var(--input-bg);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    max-width: 100%; /* Ensure it never exceeds parent */
    width: 100%;
}
    .email-header-bar {
        background-color: var(--bg-light);
        border-bottom: 1px solid var(--border-color);
        padding: 0.75rem 1.25rem;
    }
    .dark .email-header-bar { background-color: #1e293b; }
    .email-content-area {
    padding: 1.5rem;
    min-height: 200px;
    white-space: pre-wrap; /* Maintain formatting */
    word-break: break-word; /* CRITICAL: Forces long words to wrap */
    overflow-wrap: break-word; /* Modern browser support */
    color: var(--text);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; /* Monospace feels more 'draft' like */
}

    /* --- MANAGE TAB LAYOUT --- */
    .manage-grid { 
        display: grid; 
        grid-template-columns: 280px 1fr; 
        gap: 1.5rem; 
        height: calc(100vh - 180px); /* Fixed height for scrolling */
    }
    .manage-sidebar, .manage-editor { 
        overflow-y: auto; 
        height: 100%;
    }
    
    /* Mobile Responsive Manage Tab */
    @media (max-width: 1024px) { 
    .manage-grid { 
        display: block; /* Stack them */
        height: auto; 
    }
    .manage-sidebar { 
        display: none; /* Hidden by default on mobile */
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        max-height: 400px;
    }
    .manage-sidebar.mobile-visible {
        display: block;
    }
    /* Toggle Button Style */
    #mobile-sidebar-toggle {
        display: flex; /* Visible on mobile */
    }
}
@media (min-width: 1025px) {
    #mobile-sidebar-toggle {
        display: none !important; /* Hidden on desktop */
    }
}

/* Sticky footer for Email Preview on Mobile */
@media (max-width: 640px) {
    .email-client-window {
        display: flex;
        flex-direction: column;
        max-height: 80vh; /* Prevent it from being taller than screen */
    }
    .email-content-area {
        overflow-y: auto; /* Allow internal scrolling */
        flex-grow: 1;
    }
    .email-client-window .bg-gray-50.border-t {
        position: sticky;
        bottom: 0;
        z-index: 10;
        background-color: var(--card); /* Ensure background isn't transparent */
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
    }
}

    /* --- DRAGGABLE PLACEHOLDERS --- */
    .placeholder-tag {
        cursor: grab;
        user-select: none;
        transition: transform 0.1s;
    }
    .placeholder-tag:active { cursor: grabbing; transform: scale(0.95); }

    /* --- UTILS --- */
    summary { list-style: none; cursor: pointer; }
    summary::-webkit-details-marker { display: none; }
    .details-arrow { transition: transform 0.2s; }
    details[open] > summary .details-arrow { transform: rotate(90deg); }
    
    /* Scrollbar Polish */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--secondary); }
</style>
</head>
<body>

    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        Copied to clipboard!
    </div>
    
    <div id="sync-conflict-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-[var(--card-bg-color)]">
            <div class="mt-3">
                <h3 class="text-2xl leading-6 font-medium text-center">Sync Conflict Detected</h3>
                <div class="mt-4 px-2 py-3">
                    <p class="text-sm text-[var(--text-secondary)] mb-6 text-center">
                        Your local templates differ from the ones stored in the cloud. For each item below, please choose which version you'd like to keep.
                    </p>
                    <div id="conflict-resolution-container" class="space-y-4 text-left max-h-[60vh] overflow-y-auto pr-2">
                        </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 space-y-2">
                    <button id="keep-all-cloud-button" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Keep All Cloud Versions
                    </button>
                    <button id="resolve-conflicts-button" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-75 disabled:cursor-wait">
                        Apply Custom Resolutions & Sync
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto max-w-[95%] p-4">     

        <div id="tab-content-use-templates" class="hidden h-full flex flex-col">
    <div class="use-grid flex-grow min-h-0">
        
        <div class="use-sidebar card p-4 flex flex-col h-full overflow-hidden">
            <h3 class="font-bold text-lg mb-3 shrink-0">Select Template</h3>
            
            <div class="space-y-2 mb-3 shrink-0">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input type="search" id="template-search-input" placeholder="Search..." class="w-full pl-8 pr-3 py-2 text-sm bg-[var(--input-bg)] border border-[var(--border-color)] rounded-md focus:ring-1 focus:ring-indigo-500">
                </div>
                <div id="folder-list-container" class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">
                    </div>
            </div>

            <div id="template-list-container" class="space-y-1 flex-grow overflow-y-auto pr-1">
                </div>
        </div>

        <div class="use-workspace card flex flex-col h-full overflow-hidden relative">
            
            <div id="workspace-empty-state" class="absolute inset-0 z-10 bg-[var(--card)] flex flex-col items-center justify-center text-center p-8">
                <div class="w-16 h-16 bg-indigo-50 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-4 text-indigo-500">
                    <i class="fa-solid fa-envelope-open-text text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">No Template Selected</h3>
                <p class="text-[var(--secondary)] max-w-xs">Select a template from the sidebar to start generating text.</p>
            </div>

            <div class="p-4 border-b border-[var(--border-color)] bg-[var(--bg-light)]/50 shrink-0">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 id="active-template-name" class="text-xl font-bold text-[var(--text)] mb-1">Template Name</h2>
                        
                        <div class="flex flex-wrap gap-2 mb-2 min-h-[20px]" id="active-template-badges">
                            <span id="badge-target" class="hidden px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                                <i class="fa-solid fa-bullseye mr-1"></i><span class="content"></span>
                            </span>
                            <span id="badge-purpose" class="hidden px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800">
                                <i class="fa-solid fa-check mr-1"></i><span class="content"></span>
                            </span>
                        </div>

                        <p id="active-template-desc" class="text-xs text-[var(--secondary)] line-clamp-2">Description goes here...</p>
                    </div>
                     <div class="flex flex-col items-end gap-2">
    <div id="version-select-container" class="hidden">
        <select id="version-select" class="text-xs py-1 px-2 border border-[var(--border-color)] rounded bg-[var(--card)]"></select>
    </div>
    <div id="template-actions" class="hidden flex gap-3 text-xs">
        <button id="edit-template-btn" class="flex items-center gap-1 text-[var(--secondary)] hover:text-indigo-600 transition" title="Edit Master Template">
            <i class="fa-solid fa-pen-to-square"></i> <span class="hidden sm:inline">Edit</span>
        </button>
        <button id="duplicate-template-btn" class="flex items-center gap-1 text-[var(--secondary)] hover:text-green-600 transition" title="Duplicate as New">
            <i class="fa-solid fa-copy"></i> <span class="hidden sm:inline">Duplicate</span>
        </button>
    </div>
</div>
                </div>
                
                <div class="flex flex-wrap gap-4 items-center bg-[var(--card)] p-2 rounded-lg border border-[var(--border-color)] shadow-sm">
                    <div class="flex items-center gap-2">
                        <label for="pronoun-preset" class="text-xs font-bold uppercase text-gray-500"><i class="fa-solid fa-user-group mr-1"></i>Pronouns</label>
                        <select id="pronoun-preset" class="text-sm border-none bg-transparent focus:ring-0 py-0 pl-0 font-medium text-indigo-600 cursor-pointer">
                            <option value="">Manual</option>
                            <option value="male">Male (He/Him)</option>
                            <option value="female">Female (She/Her)</option>
                            <option value="neutral">Neutral (They/Them)</option>
                        </select>
                    </div>
                    <div class="h-4 w-px bg-gray-300 dark:bg-gray-700"></div>
                    <div class="flex items-center gap-2">
                        <label for="scheduled-time" class="text-xs font-bold uppercase text-gray-500"><i class="fa-regular fa-clock mr-1"></i>Time</label>
                        <input type="time" id="scheduled-time" class="text-sm border-none bg-transparent focus:ring-0 py-0 pl-0 font-medium text-indigo-600 cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="flex-grow flex flex-col lg:flex-row overflow-hidden">
                
                <div class="w-full lg:w-5/12 p-6 overflow-y-auto border-r border-[var(--border-color)] bg-[var(--card)]">
                    <h4 class="text-xs font-bold uppercase text-gray-500 mb-4 sticky top-0 bg-[var(--card)] py-2 z-10">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> Fill Details
                    </h4>
                    <div id="fields-container" class="space-y-4">
                        </div>
                </div>

                <div class="w-full lg:w-7/12 flex flex-col bg-gray-50 dark:bg-gray-900/50">
                    <div id="generated-text-container" class="flex-grow flex flex-col m-4 bg-[var(--input-bg)] rounded-lg shadow-sm border border-[var(--border-color)] overflow-hidden">
                        
                        <div class="bg-gray-100 dark:bg-slate-800 px-4 py-2 border-b border-[var(--border-color)] flex gap-2 shrink-0">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-400"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-400"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-400"></div>
                        </div>

                        <div id="generated-subject-wrapper" class="hidden px-6 py-4 border-b border-[var(--border-color)] flex items-center gap-3 bg-[var(--card)]">
                            <span class="text-xs font-bold text-gray-400 uppercase">Subject:</span>
                            <input type="text" id="generated-subject" class="flex-grow bg-transparent border-none font-semibold text-[var(--text)] focus:ring-0 p-0" readonly placeholder="...">
                            <button id="copy-subject-button" class="text-gray-400 hover:text-indigo-600 transition" title="Copy Subject"><i class="fa-regular fa-copy"></i></button>
                        </div>

                        <div class="relative flex-grow overflow-hidden">
                            <div id="generated-text" class="email-content-area p-6 h-full overflow-y-auto whitespace-pre-wrap outline-none" contenteditable="true"></div>
                            
                            <div class="absolute bottom-4 right-4 flex gap-2">
                                <button id="load-to-gmail-button" class="hidden bg-red-600 text-white p-3 rounded-full shadow-lg hover:bg-red-700 hover:scale-105 transition" title="Open in Gmail">
                                    <i class="fa-brands fa-google"></i>
                                </button>
                                <button id="copy-body-button" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 hover:scale-105 transition" title="Copy Text">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        
        <div id="tab-content-batch-generate" class="hidden">
             <div class="space-y-8">
                <div class="step-card p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Batch Generate from CSV</h2>
                    <p class="mb-4 text-[var(--text-secondary)]">Upload a CSV file where the column headers match the placeholders of your chosen template (e.g., a column named 'Name' for the {{Name}} placeholder).</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="batch-template-select" class="block text-sm font-medium mb-1">1. Select Template to Use</label>
                            <select id="batch-template-select" class="w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="csv-file-input" class="block text-sm font-medium mb-1">2. Upload CSV File</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="batch-generate-button" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out text-lg">
                            Generate All
                        </button>
                    </div>
                </div>
                 <div id="batch-output-container" class="hidden step-card p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Generated Output</h2>
                     <div id="batch-output" class="space-y-6"></div>
                 </div>
            </div>
        </div>

<div id="tab-content-manage-templates" class="hidden h-full flex flex-col">
    <div class="mb-4 lg:hidden shrink-0">
        <button id="mobile-sidebar-toggle" class="w-full flex justify-between items-center bg-[var(--card)] border border-[var(--border-color)] px-4 py-3 rounded-lg font-semibold shadow-sm">
            <span><i class="fa-solid fa-list mr-2"></i> Show Template List</span>
            <i class="fa-solid fa-chevron-down transition-transform" id="sidebar-chevron"></i>
        </button>
    </div>

    <div class="manage-grid flex-grow min-h-0" id="manage-grid-container">
        
        <div class="relative h-full flex flex-col">
            <div id="manage-sidebar" class="manage-sidebar card p-4 flex flex-col h-full w-full absolute inset-0 z-10 transition-opacity duration-200 bg-[var(--card)]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="font-bold text-lg">Templates</h3>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('template-form').reset(); window.cancelEdit();" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" title="New Template">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <button id="collapse-sidebar-btn" class="hidden lg:block text-gray-400 hover:text-gray-600 p-1" title="Collapse Sidebar">
                            <i class="fa-solid fa-angles-left"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 mb-3 shrink-0">
                     <div class="relative flex-grow">
                        <i class="fa-solid fa-search absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" id="manager-search" placeholder="Filter..." class="w-full text-sm pl-7 pr-2 py-1.5 rounded border border-[var(--border-color)] bg-[var(--input-bg)] focus:ring-1 focus:ring-indigo-500">
                     </div>
                     <label class="flex items-center justify-center w-8 h-8 rounded border border-[var(--border-color)] bg-[var(--card)] cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition" title="Show Archived Templates">
                        <input type="checkbox" id="show-archived-toggle" class="hidden peer">
                        <i class="fa-solid fa-box-archive text-gray-400 peer-checked:text-indigo-600"></i>
                     </label>
                </div>

                <div id="user-templates-list" class="space-y-2 flex-grow overflow-y-auto pr-1"></div>
                
                <div class="mt-4 pt-4 border-t border-[var(--border-color)] flex gap-2 justify-center shrink-0">
                     <button id="import-button" class="text-xs bg-gray-200 dark:bg-gray-700 dark:text-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 transition">Import</button>
                     <button id="export-button" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition">Export</button>
                     <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </div>

            <button id="expand-sidebar-btn" class="hidden h-full w-full bg-[var(--card)] border border-[var(--border-color)] rounded-lg flex flex-col items-center py-4 gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors z-0">
                <i class="fa-solid fa-angles-right text-gray-500"></i>
                <div class="writing-vertical text-xs font-bold text-gray-400 tracking-widest uppercase transform rotate-180">Templates</div>
            </button>
        </div>

        <div class="manage-editor card p-6 h-full flex flex-col overflow-hidden">
             <div class="flex justify-between items-center mb-4 border-b border-[var(--border-color)] pb-2 flex-wrap gap-2 shrink-0">
                <h2 id="form-title" class="text-xl font-bold truncate">Create New Template</h2>
                <div class="flex gap-2 items-center">
                     <button type="button" id="toggle-preview-btn" class="hidden lg:flex text-xs items-center gap-1 text-gray-500 hover:text-indigo-600 border border-[var(--border-color)] px-2 py-1 rounded transition bg-[var(--input-bg)]">
                        <i class="fa-solid fa-eye-slash"></i> <span>Hide Preview</span>
                     </button>
                     <button type="button" id="cancel-edit-button" class="hidden px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Cancel</button>
                     <button type="submit" form="template-form" id="save-template-button" class="px-4 py-1 text-sm bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow-md">Save</button>
                </div>
             </div>
             
             <div class="flex-grow overflow-y-auto pr-2">
                <form id="template-form" class="flex flex-col h-full min-h-[600px]">
                    <input type="hidden" id="template-edit-id">
                    <input type="hidden" id="template-edit-version">
                    <input type="hidden" id="template-save-mode">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Name</label>
                            <input type="text" id="template-name" class="w-full p-2 text-sm" placeholder="Template Name" required>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Folder</label>
                            <div class="flex gap-2">
                                <input type="text" id="template-folder" class="w-full p-2 text-sm" placeholder="Folder" list="folder-suggestions">
                                <datalist id="folder-suggestions"></datalist>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Subject Line</label>
                        <input type="text" id="template-subject" class="w-full p-2 text-sm font-medium" placeholder="e.g. Update for {{Name}}">
                    </div>

                    <div class="mb-4">
                        <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Description</label>
                        <textarea id="template-description" class="w-full p-2 text-sm" rows="2" placeholder="Briefly describe what this template is for..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Target Audience</label>
                            <input type="text" id="template-target" class="w-full p-2 text-sm" placeholder="e.g. Clients, Team">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Purpose</label>
                            <input type="text" id="template-purpose" class="w-full p-2 text-sm" placeholder="e.g. Update, Request">
                        </div>
                    </div>

                    <div id="interactive-placeholders-wrapper" class="hidden mb-4 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-md border border-indigo-100 dark:border-indigo-800/50">
                        <div class="flex justify-between items-center mb-2">
                             <p class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider">
                                <i class="fa-solid fa-tags mr-1"></i> Available Placeholders
                            </p>
                            <span class="text-[9px] text-gray-400">Drag or Double-Click to insert</span>
                        </div>
                        <div id="interactive-placeholders-container" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div class="flex gap-6 flex-grow">
                        <div id="editor-pane" class="flex flex-col flex-grow w-1/2 transition-all">
                            <div class="flex justify-between items-end mb-1">
                                 <label class="block text-[10px] font-bold uppercase text-gray-500">Body Content</label>
                                 <button type="button" id="add-field-button" class="text-xs text-blue-500 hover:text-blue-700 font-bold flex items-center gap-1"><i class="fa-solid fa-plus"></i> Define Field</button>
                            </div>
                            <textarea id="template-body" class="w-full p-3 text-sm font-mono leading-relaxed bg-[var(--input-bg)] text-[var(--text)] border border-[var(--border-color)] rounded flex-grow min-h-[300px]" placeholder="Hi {{Name}}..." required></textarea>
                            
                            <div id="dynamic-fields-container" class="space-y-2 pl-2 border-l-2 border-gray-200 dark:border-gray-700 mt-4"></div>
                        </div>

                        <div id="live-preview-pane" class="hidden lg:flex flex-col w-1/2 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-[var(--border-color)] p-4 transition-all sticky top-0 h-[fit-content]">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-[10px] font-bold uppercase text-gray-500 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Live Preview</h4>
                                <span class="text-[10px] text-gray-400 italic">Updates as you type</span>
                            </div>
                            <div class="space-y-3 flex-grow flex flex-col">
                                <div class="bg-[var(--card)] border border-[var(--border-color)] p-2 rounded text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm">
                                    <span class="text-gray-400 text-xs mr-2 select-none uppercase tracking-wide">Subject:</span> <span id="preview-subject">...</span>
                                </div>
                                <div id="preview-body" class="bg-[var(--card)] border border-[var(--border-color)] p-4 rounded text-sm whitespace-pre-wrap flex-grow min-h-[250px] font-mono shadow-sm">
                                    Start typing to see preview...
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
             </div>
             <p id="save-status" class="text-sm mt-2 text-green-600 font-bold text-center"></p>
        </div>
    </div>
</div>
        
        
        <div id="tab-content-sync-settings" class="hidden space-y-8">
            <div class="step-card p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Sync with Firebase</h2>
                <div id="firebase-auth-container">
                    <p class="mb-4 text-[var(--text-secondary)]">Sign in to sync your templates across devices.</p>
                    <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                        <div class="flex-grow"><label for="firebase-email" class="block text-sm font-medium mb-1">Email</label><input type="email" id="firebase-email" class="w-full px-3 py-2 shadow-sm" placeholder="your@email.com"></div>
                        <div class="flex-grow"><label for="firebase-password" class="block text-sm font-medium mb-1">Password</label><input type="password" id="firebase-password" class="w-full px-3 py-2 shadow-sm" placeholder="••••••••"></div>
                        <div class="flex gap-2"><button id="firebase-signin-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Sign In</button><button id="firebase-signup-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Sign Up</button></div>
                    </div>
                     <div class="mt-4"><button id="google-signin-button" class="bg-white border text-gray-700 dark:bg-gray-200 dark:text-gray-900 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 dark:hover:bg-gray-300 w-full">Sign in with Google</button></div>
                </div>
                <div id="firebase-sync-controls" class="hidden mt-6 space-y-4">
                    <p id="firebase-auth-status" class="text-sm text-green-600"></p>
                    <div class="flex flex-col sm:flex-row gap-4"><button id="firebase-sync-button" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Check for Cloud Updates</button></div>
                    <button id="firebase-signout-button" class="text-sm text-red-600 hover:underline">Sign Out</button>
                </div>
                <p id="firebase-status" class="text-sm mt-4"></p>
            </div>

            <div class="step-card p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Gmail Integration</h2>
                <p class="mb-4 text-[var(--text-secondary)]">Authorize this application to create drafts in your Gmail account.</p>
                <button id="authorize-gmail-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Authorize Gmail Access</button>
                <p id="gmail-auth-status" class="text-sm mt-3 text-green-600"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { changelogData } from '/changelog-data.js';
        import { AppNavigation } from '/shared-nav.js';
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3",
        };
        
        const GMAIL_API_KEY = 'YOUR_GMAIL_API_KEY';
        const GMAIL_CLIENT_ID = 'YOUR_GMAIL_CLIENT_ID';
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.compose';

        let tokenClient;

        const defaultTemplates = [
             {
                id: "default-positive-review", name: "Positive Progress Review", folder: "Education", isArchived: false, isDefault: true,
                versions: [{ version: 1, createdAt: new Date('2023-01-01T10:00:00Z').toISOString(), updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(), subject: "An update on {{Name}}'s progress in {{Subject}}", description: "A standard positive review for a student making good progress.", target: "Parents/Guardians", purpose: "To inform and praise.", fields: [{name: "Name", desc: "Student's full name", type: "text"}, {name: "Subject", desc: "The academic subject", type: "text"}, {name: "Tutor", desc: "Tutor's name", type: "text"}], template: "{{Greeting}},\n\nThis is a review of {{Name}}'s progress in {{Subject}}.\n\nI am pleased to report that {{Name}} is making excellent progress. {{Pronoun_he_she_they}} consistently demonstrates a strong understanding of the core concepts and actively participates in class discussions.\n\n{{Pronoun_his_her_their}} work is always completed to a high standard, and {{Pronoun_he_she_they}} shows great enthusiasm for the subject. It is a pleasure to have {{Name}} in my class.\n\nRegards,\n{{Tutor}}"}]
            },
            {
                id: "default-needs-improvement", name: "Needs Improvement Review", folder: "Education", isArchived: false, isDefault: true,
                versions: [{ version: 1, createdAt: new Date('2023-01-01T10:00:00Z').toISOString(), updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(), subject: "Update regarding {{Name}} in {{Subject}}", description: "Highlights an area of concern and suggests next steps.", target: "Parents/Guardians", purpose: "To inform and seek support.", fields: [{name: "Name", desc: "", type: "text"}, {name: "Subject", desc: "", type: "text"}, {name: "Year_Group", desc: "", type: "text"}, {name: "Tutor", desc: "", type: "text"}, {name: "Specific_Area", desc: "e.g., Algebra, Punctuation", type: "text"}], template: "{{Greeting}},\n\nThis is an update regarding {{Name}} in Year {{Year_Group}} {{Subject}}.\n\nWhile {{Name}} has a foundational understanding of the subject, there are areas that require more focus. Specifically, {{Pronoun_he_she_they}} is finding {{Specific_Area}} challenging and would benefit from additional practice.\n\nI encourage {{Name}} to ask more questions in class and attend support sessions to improve {{Pronoun_his_her_their}} confidence and skills in this area. We will continue to provide support in school.\n\nRegards,\n{{Tutor}}"}]
            }
        ];
        
        const PRONOUN_PLACEHOLDERS = {
            'Pronoun_he_she_they': 'Subjective pronoun (e.g., he, she, they)',
            'Pronoun_him_her_them': 'Objective pronoun (e.g., him, her, them)',
            'Pronoun_his_her_their': 'Possessive pronoun (e.g., his, her, their)',
            'Pronoun_himself_herself_themself': 'Reflexive pronoun (e.g., himself, herself, themself)'
        };

        let allTemplates = [];
        let currentTemplateVersion = null;
        let syncState = 'unknown'; 
        let firebaseApp, firebaseAuth, firestoreDb;
        let currentUser = null;
        let templatesUnsubscribe = null;
        let themeUnsubscribe = null;
        let showArchived = false;

        let selectedFolder = 'All';
        let selectedTemplateId = null;

        const ui = {
            tabs: { buttons: document.querySelectorAll('.nav-tab'), contents: { 'use-templates': document.getElementById('tab-content-use-templates'), 'batch-generate': document.getElementById('tab-content-batch-generate'), 'manage-templates': document.getElementById('tab-content-manage-templates'), 'sync-settings': document.getElementById('tab-content-sync-settings') }},
    use: { 
        pronounPreset: document.getElementById('pronoun-preset'), 
        scheduledTimeInput: document.getElementById('scheduled-time'), 
        folderListContainer: document.getElementById('folder-list-container'),
        templateListContainer: document.getElementById('template-list-container'),
        templateSearchInput: document.getElementById('template-search-input'),
        templateActions: document.getElementById('template-actions'),
        editTemplateBtn: document.getElementById('edit-template-btn'),
        duplicateTemplateBtn: document.getElementById('duplicate-template-btn'),
        versionSelectContainer: document.getElementById('version-select-container'), 
        versionSelect: document.getElementById('version-select'), 
        fieldsContainer: document.getElementById('fields-container'), 
        // generateButton removed
        generatedTextContainer: document.getElementById('generated-text-container'), 
        generatedSubjectWrapper: document.getElementById('generated-subject-wrapper'), 
        generatedSubjectInput: document.getElementById('generated-subject'), 
        generatedTextDiv: document.getElementById('generated-text'), 
        copySubjectButton: document.getElementById('copy-subject-button'), 
        copyBodyButton: document.getElementById('copy-body-button'), 
        loadToGmailButton: document.getElementById('load-to-gmail-button') 
    },
            manage: { form: document.getElementById('template-form'), formTitle: document.getElementById('form-title'), nameInput: document.getElementById('template-name'), folderInput: document.getElementById('template-folder'), folderSuggestions: document.getElementById('folder-suggestions'), subjectInput: document.getElementById('template-subject'), descriptionInput: document.getElementById('template-description'), targetInput: document.getElementById('template-target'), purposeInput: document.getElementById('template-purpose'), fieldsContainer: document.getElementById('dynamic-fields-container'), addFieldButton: document.getElementById('add-field-button'), placeholdersWrapper: document.getElementById('interactive-placeholders-wrapper'), placeholdersContainer: document.getElementById('interactive-placeholders-container'), bodyTextarea: document.getElementById('template-body'), editIdInput: document.getElementById('template-edit-id'), editVersionInput: document.getElementById('template-edit-version'), saveModeInput: document.getElementById('template-save-mode'), userTemplatesList: document.getElementById('user-templates-list'), cancelEditButton: document.getElementById('cancel-edit-button'), saveStatus: document.getElementById('save-status'), exportButton: document.getElementById('export-button'), importButton: document.getElementById('import-button'), importFileInput: document.getElementById('import-file-input'), showArchivedToggle: document.getElementById('show-archived-toggle') },
    batch: { templateSelect: document.getElementById('batch-template-select'), csvFileInput: document.getElementById('csv-file-input'), generateButton: document.getElementById('batch-generate-button'), outputContainer: document.getElementById('batch-output-container'), output: document.getElementById('batch-output') },
    sync: { 
        indicator: document.getElementById('sync-status-indicator'), 
        authContainer: document.getElementById('firebase-auth-container'), 
        controls: document.getElementById('firebase-sync-controls'), 
        emailInput: document.getElementById('firebase-email'), 
        passwordInput: document.getElementById('firebase-password'), 
        signinButton: document.getElementById('firebase-signin-button'), 
        signupButton: document.getElementById('firebase-signup-button'), 
        googleSigninButton: document.getElementById('google-signin-button'),
        signoutButton: document.getElementById('firebase-signout-button'), 
        authStatus: document.getElementById('firebase-auth-status'), 
        syncButton: document.getElementById('firebase-sync-button'), 
        status: document.getElementById('firebase-status'),
        conflictModal: document.getElementById('sync-conflict-modal'),
        conflictContainer: document.getElementById('conflict-resolution-container'),
        resolveButton: document.getElementById('resolve-conflicts-button'),
        keepAllCloudButton: document.getElementById('keep-all-cloud-button'),
        authorizeGmailButton: document.getElementById('authorize-gmail-button'),
        gmailAuthStatus: document.getElementById('gmail-auth-status')
    },
    versionDisplay: document.getElementById('version-display'),
    notification: document.getElementById('notification'),
    themeToggle: document.getElementById('theme-toggle')
};

                    // Add listener to update preview immediately
const updateManagerPreview = () => {
    const subject = ui.manage.subjectInput.value || '';
    const body = ui.manage.bodyTextarea.value || '';
    
    // Simple placeholder highlighting for preview
    const highlight = (text) => text.replace(/{{(.*?)}}/g, '<span class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-1 rounded">{{$1}}</span>');
    
    document.getElementById('preview-subject').innerHTML = highlight(subject);
    document.getElementById('preview-body').innerHTML = highlight(body) || '<span class="text-gray-400 italic">Start typing...</span>';
};
        
        window.onload = function() {
    loadTemplates();

    // 1. Initialize Shared Navigation
    const nav = new AppNavigation({
        appName: 'Text Generator',
        appIcon: 'fa-envelope-open-text',
        themeColor: 'fuchsia', 
        version: changelogData[0].version,
        tabs: [
            { id: 'use-templates', label: 'Use', icon: 'fa-play' },
            { id: 'batch-generate', label: 'Batch', icon: 'fa-layer-group' },
            { id: 'manage-templates', label: 'Manage', icon: 'fa-pen-to-square' },
            { id: 'sync-settings', label: 'Settings', icon: 'fa-gear' }
        ],
        activeTab: 'use-templates'
    });

    // 2. Listen for tab changes
    window.addEventListener('tab-changed', (e) => {
        const tabId = e.detail.tabId;
        document.querySelectorAll('[id^="tab-content-"]').forEach(el => el.classList.add('hidden'));
        const content = document.getElementById(`tab-content-${tabId}`);
        if (content) content.classList.remove('hidden');
    });

    // 3. Inject Sync Indicator into the new Navbar (Fixes the null error)
    const navRightSection = document.querySelector('header .container > div > div:last-child');
    if (navRightSection) {
        const indicator = document.createElement('div');
        indicator.id = 'sync-status-indicator';
        indicator.className = 'text-xs font-bold hidden items-center gap-1 mr-2'; // Added mr-2 for spacing
        // Insert before the avatar or theme toggle
        navRightSection.insertBefore(indicator, navRightSection.firstChild);
        
        // Update the UI reference so the sync logic can find it
        ui.sync.indicator = indicator;
    }

    // 4. Mobile Sidebar Logic
    const toggleBtn = document.getElementById('mobile-sidebar-toggle');
    const sidebar = document.getElementById('manage-sidebar');
    const chevron = document.getElementById('sidebar-chevron');

    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('mobile-visible');
            if (sidebar.classList.contains('mobile-visible')) {
                chevron.style.transform = 'rotate(180deg)';
                toggleBtn.querySelector('span').innerHTML = '<i class="fa-solid fa-list mr-2"></i> Hide Template List';
            } else {
                chevron.style.transform = 'rotate(0deg)';
                toggleBtn.querySelector('span').innerHTML = '<i class="fa-solid fa-list mr-2"></i> Show Template List';
            }
        });
    }

    // 5. Setup Event Listeners
    ui.manage.subjectInput.addEventListener('input', updateManagerPreview);
    ui.manage.bodyTextarea.addEventListener('input', updateManagerPreview);
    
    ui.use.pronounPreset.addEventListener('change', () => {
        applyPronounPreset();
        liveGenerateText();
    });
    ui.use.scheduledTimeInput.addEventListener('input', () => {
        handleScheduledTimeChange();
        liveGenerateText();
    });
    ui.use.templateSearchInput.addEventListener('input', () => renderTemplateList(ui.use.templateSearchInput.value));
    ui.use.versionSelect.addEventListener('change', loadSelectedVersion);
    
    ui.use.copyBodyButton.addEventListener('click', () => copyToClipboard(ui.use.generatedTextDiv.innerText, "Body copied!"));
    ui.use.copySubjectButton.addEventListener('click', () => copyToClipboard(ui.use.generatedSubjectInput.value, "Subject copied!"));
    ui.use.loadToGmailButton.addEventListener('click', createGmailDraft);
    
    ui.use.fieldsContainer.addEventListener('input', liveGenerateText);
    
    ui.manage.form.addEventListener('submit', handleSaveTemplate);
    ui.manage.cancelEditButton.addEventListener('click', cancelEdit);
    ui.manage.addFieldButton.addEventListener('click', () => addFieldInputRow({name: '', desc: '', type: 'text', options: ''}));
    ui.manage.exportButton.addEventListener('click', exportTemplates);
    ui.manage.importButton.addEventListener('click', () => ui.manage.importFileInput.click());
    ui.manage.importFileInput.addEventListener('change', handleImportFile);

    if (ui.manage.showArchivedToggle) {
        ui.manage.showArchivedToggle.addEventListener('change', (e) => {
            showArchived = e.target.checked; renderTemplateManager();
        });
    }

    const managerSearch = document.getElementById('manager-search');
    if (managerSearch) {
        managerSearch.addEventListener('input', (e) => {
            renderTemplateManager(e.target.value); 
        });
    }

    ui.batch.generateButton.addEventListener('click', handleBatchGenerate);
    
    ui.sync.signinButton.addEventListener('click', handleFirebaseSignIn);
    ui.sync.signupButton.addEventListener('click', handleFirebaseSignUp);
    ui.sync.googleSigninButton.addEventListener('click', handleGoogleSignIn);
    ui.sync.signoutButton.addEventListener('click', handleFirebaseSignOut);
    ui.sync.syncButton.addEventListener('click', checkForCloudUpdates);
    ui.sync.authorizeGmailButton.addEventListener('click', handleAuthGmailClick);
    ui.sync.keepAllCloudButton.addEventListener('click', () => {
        document.querySelectorAll('#sync-conflict-modal input[name^="conflict_"][value="remote"]').forEach(radio => {
            radio.checked = true;
        });
        ui.sync.resolveButton.click();
    });

    ui.use.editTemplateBtn.addEventListener('click', () => {
        if (selectedTemplateId) {
            // Manually switch tab since nav.switchTab isn't exposed globally here
            // But we can trigger the click on the tab button if needed, 
            // or just use our helper if we still had it. 
            // Better way: rely on the shared nav event system or just direct DOM manipulation:
            if(nav) nav.switchTab('manage-templates');
            useLatestVersionForEdit(selectedTemplateId);
        }
    });

    ui.use.duplicateTemplateBtn.addEventListener('click', () => {
        if (selectedTemplateId) {
            const version = parseInt(ui.use.versionSelect.value) || 1;
            if(nav) nav.switchTab('manage-templates');
            duplicateAsNewTemplate(selectedTemplateId, version);
        }
    });

    ui.manage.bodyTextarea.addEventListener('dragover', e => e.preventDefault());
    ui.manage.bodyTextarea.addEventListener('drop', handleDrop);
    
    setupDragAndDrop();
    initializeFirebase(); // This must run AFTER ui.sync.indicator is created

    if (GMAIL_API_KEY === 'YOUR_GMAIL_API_KEY') {
        ui.sync.authorizeGmailButton.disabled = true;
        ui.sync.authorizeGmailButton.textContent = "Gmail Integration Disabled";
    } else {
        gapiLoaded();
        gisLoaded();
    }
};

        function sanitizeForId(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/[^a-zA-Z0-9\-_]/g, '_');
        }
        

        // Initialize Shared Navigation
const nav = new AppNavigation({
    appName: 'Text Generator',
    appIcon: 'fa-envelope-open-text',
    themeColor: 'fuchsia', // Matches your --primary color #D946EF
    version: changelogData[0].version,
    tabs: [
        { id: 'use-templates', label: 'Use', icon: 'fa-play' },
        { id: 'batch-generate', label: 'Batch', icon: 'fa-layer-group' },
        { id: 'manage-templates', label: 'Manage', icon: 'fa-pen-to-square' },
        { id: 'sync-settings', label: 'Settings', icon: 'fa-gear' }
    ],
    activeTab: 'use-templates'
});

// Listen for tab changes from the shared nav
window.addEventListener('tab-changed', (e) => {
    const tabId = e.detail.tabId;
    
    // Hide all tab contents
    document.querySelectorAll('[id^="tab-content-"]').forEach(el => {
        el.classList.add('hidden');
    });
    
    // Show selected tab content
    const content = document.getElementById(`tab-content-${tabId}`);
    if (content) content.classList.remove('hidden');
});

        
        function migrateTemplates(templates) {
            if (!Array.isArray(templates)) return [];
            return templates.map(t => {
                if (t.versions && t.versions[0].fields && typeof t.versions[0].fields[0] === 'object' && 'type' in t.versions[0].fields[0]) return t;
                const { name, folder, subject, description, target, purpose, fields, template, createdAt, updatedAt, isDefault, isArchived } = t;
                const newVersions = (t.versions || [{ subject, description, target, purpose, fields, template, createdAt }]).map(v => ({
                    ...v,
                    fields: Array.isArray(v.fields) ? v.fields.map(f => typeof f === 'string' ? { name: f, desc: '', type: 'text' } : {...f, type: f.type || 'text'}) : []
                }));
                return { id: t.id || crypto.randomUUID(), name: name || "Untitled Template", folder: folder || "", isArchived: isArchived || false, isDefault: isDefault || false, createdAt: createdAt || new Date().toISOString(), updatedAt: updatedAt || new Date().toISOString(), versions: newVersions };
            });
        }
        
        function loadTemplates() {
            let userTemplates = [];
            try { 
                const rawData = localStorage.getItem('userTemplates') || '[]';
                userTemplates = migrateTemplates(JSON.parse(rawData));
                localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            } catch (e) { console.error("Error parsing or migrating user templates:", e); }
            
            allTemplates = [...defaultTemplates.map(t => ({...t, versions: migrateTemplates([t])[0].versions })), ...userTemplates];
            
            renderFolderList();
            renderTemplateList();
            populateBatchTemplateSelector();
            renderTemplateManager();
        }
        

        // 1. Updated Folder List Renderer (Pills style)
function renderFolderList() {
    const folders = ['All', ...new Set(allTemplates.filter(t => !t.isArchived).map(t => t.folder || 'Uncategorized').filter(Boolean))];
    const container = ui.use.folderListContainer;
    container.innerHTML = '';
    
    folders.sort().forEach(folder => {
        const btn = document.createElement('button');
        const isActive = selectedFolder === folder;
        // Pill Styling
        btn.className = `whitespace-nowrap px-3 py-1 text-xs rounded-full border transition-colors ${
            isActive 
            ? 'bg-indigo-600 text-white border-indigo-600' 
            : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:border-indigo-300'
        }`;
        btn.textContent = folder;
        btn.addEventListener('click', () => {
            selectedFolder = folder;
            selectedTemplateId = null;
            renderFolderList(); // Re-render to update active state
            renderTemplateList();
            document.getElementById('workspace-empty-state').classList.remove('hidden'); // Show empty state
        });
        container.appendChild(btn);
    });
    
    // Also update Manage tab suggestions
    ui.manage.folderSuggestions.innerHTML = '';
    folders.filter(f => f !== 'All').forEach(folder => {
        const option = document.createElement('option');
        option.value = folder;
        ui.manage.folderSuggestions.appendChild(option);
    });
}

function renderTemplateList(searchTerm = '') {
    const container = ui.use.templateListContainer;
    container.innerHTML = '';
    const filtered = allTemplates.filter(t => {
        const folderMatch = selectedFolder === 'All' || (t.folder || 'Uncategorized') === selectedFolder;
        const searchMatch = !searchTerm || t.name.toLowerCase().includes(searchTerm.toLowerCase());
        return !t.isArchived && folderMatch && searchMatch;
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">No templates found.</div>`;
        return;
    }

    filtered.forEach(template => {
        const item = document.createElement('div');
        const isActive = selectedTemplateId === template.id;
        item.className = `template-list-item mb-1 flex flex-col gap-1 ${isActive ? 'active' : ''}`;
        
        // Get metadata from latest version
        const latest = template.versions && template.versions.length > 0 
            ? [...template.versions].sort((a, b) => b.version - a.version)[0] 
            : null;
            
        const target = latest?.target || '';
        const purpose = latest?.purpose || '';
        
        item.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-semibold text-sm truncate pr-2">${template.name}</span>
                ${template.isDefault ? '<i class="fa-solid fa-star text-[10px] text-yellow-400"></i>' : ''}
            </div>

            ${(target || purpose) ? `
            <div class="flex flex-wrap gap-1">
                 ${target ? `<span class="px-1.5 py-0.5 rounded-[3px] text-[9px] font-bold uppercase tracking-wider bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border border-blue-200 dark:border-blue-800 line-clamp-1 max-w-full">${target}</span>` : ''}
                 ${purpose ? `<span class="px-1.5 py-0.5 rounded-[3px] text-[9px] font-bold uppercase tracking-wider bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800 line-clamp-1 max-w-full">${purpose}</span>` : ''}
            </div>` : ''}

            <div class="text-[10px] ${isActive ? 'text-indigo-100' : 'text-gray-500'} truncate mt-0.5">
                ${template.folder || 'Uncategorized'}
            </div>
        `;
        
        item.addEventListener('click', () => {
            handleTemplateSelection(template.id);
            renderTemplateList(searchTerm); // Re-render to update active styling
        });
        container.appendChild(item);
    });
}

function handleTemplateSelection(templateId) {
    selectedTemplateId = templateId;
    const templateFamily = allTemplates.find(t => t.id === templateId);
    if (!templateFamily) return;

    // Hide Empty State
    document.getElementById('workspace-empty-state').classList.add('hidden');

    // Update Header
    document.getElementById('active-template-name').textContent = templateFamily.name;

    // Show Actions
    ui.use.templateActions.classList.remove('hidden');
    ui.use.versionSelect.innerHTML = '';

    // --- NEW LOGIC START ---
    // 1. Sort versions descending (Highest version number first)
    const sortedVersions = [...templateFamily.versions].sort((a, b) => b.version - a.version);

    // 2. Populate Dropdown
    sortedVersions.forEach((v) => {
        const option = document.createElement('option');
        option.value = v.version;
        option.textContent = `v${v.version}`;
        ui.use.versionSelect.appendChild(option);
    });

    // 3. Force select the first option (which is now the latest version)
    if (sortedVersions.length > 0) {
        ui.use.versionSelect.value = sortedVersions[0].version;
    }
    // --- NEW LOGIC END ---

    // Show version select only if multiple versions exist
    if (templateFamily.versions.length > 1) {
        ui.use.versionSelectContainer.classList.remove('hidden');
    } else {
        ui.use.versionSelectContainer.classList.add('hidden');
    }

    // Trigger Load
    loadSelectedVersion();
}

        // 5. Update resetSelectionUI to remove button logic
function resetSelectionUI() {
    ui.use.versionSelectContainer.classList.add('hidden');
    ui.use.templateActions.classList.add('hidden');
    ui.use.fieldsContainer.innerHTML = '<p class="col-span-full text-[var(--text-secondary)]">Please select a template first.</p>';
    // REMOVED: ui.use.generateButton.disabled = true;
    ui.use.generatedTextDiv.innerText = '';
    ui.use.generatedSubjectInput.value = '';
    ui.use.generatedSubjectWrapper.classList.add('hidden');
    currentTemplateVersion = null;
}

        function populateBatchTemplateSelector() {
            ui.batch.templateSelect.innerHTML = '<option value="">Select a template...</option>';
            allTemplates.filter(t => !t.isArchived).forEach((template) => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                ui.batch.templateSelect.appendChild(option);
            });
        }
        
        function createFieldInput(field) {
            const sanitizedId = `field-${sanitizeForId(field.name)}`;
            const fieldWrapper = document.createElement('div');
            
            const label = document.createElement('label');
            label.setAttribute('for', sanitizedId);
            label.className = "block text-sm font-medium";
            label.textContent = field.name;
            fieldWrapper.appendChild(label);

            if (field.desc) {
                const descEl = document.createElement('p');
                descEl.className = "text-xs text-[var(--text-secondary)] mb-1";
                descEl.textContent = field.desc;
                fieldWrapper.appendChild(descEl);
            }

            let inputElement;
            if (field.type === 'dropdown') {
                inputElement = document.createElement('select');
                const options = (field.options || '').split(',').map(opt => opt.trim());
                options.forEach(opt => {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = opt;
                    inputElement.appendChild(optionEl);
                });
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.placeholder = `Enter ${field.name}...`;
            }
            
            inputElement.id = sanitizedId;
            inputElement.className = "w-full px-3 py-2 border rounded-md shadow-sm dynamic-field";
            inputElement.setAttribute('data-original-name', field.name);
            fieldWrapper.appendChild(inputElement);
            
            return fieldWrapper;
        }

       function loadSelectedVersion() {
            const selectedVersionNum = parseInt(ui.use.versionSelect.value, 10);
            if (!selectedTemplateId || isNaN(selectedVersionNum)) return;

            const templateFamily = allTemplates.find(t => t.id === selectedTemplateId);
            const version = templateFamily?.versions.find(v => v.version === selectedVersionNum);
            if (!version) return;

            currentTemplateVersion = version;
            ui.use.fieldsContainer.innerHTML = '';

            // --- UPDATE LABELS ---
            const targetBadge = document.getElementById('badge-target');
            const purposeBadge = document.getElementById('badge-purpose');
            const descText = document.getElementById('active-template-desc');

            if (targetBadge) {
                if (version.target) {
                    targetBadge.querySelector('.content').textContent = version.target;
                    targetBadge.classList.remove('hidden');
                } else {
                    targetBadge.classList.add('hidden');
                }
            }
            
            if (purposeBadge) {
                if (version.purpose) {
                    purposeBadge.querySelector('.content').textContent = version.purpose;
                    purposeBadge.classList.remove('hidden');
                } else {
                    purposeBadge.classList.add('hidden');
                }
            }

            if (descText) descText.textContent = version.description || "No description provided.";
            // ---------------------

            const definedFieldNames = new Set((version.fields || []).map(f => f.name));
            const templateText = version.template || "";

            if (version.fields && version.fields.length > 0) {
                version.fields.forEach(field => { if (field.name) ui.use.fieldsContainer.appendChild(createFieldInput(field)) });
            }

            Object.keys(PRONOUN_PLACEHOLDERS).forEach(pronoun => {
                if (templateText.includes(`{{${pronoun}}}`) && !definedFieldNames.has(pronoun)) {
                    ui.use.fieldsContainer.appendChild(createFieldInput({ name: pronoun, desc: PRONOUN_PLACEHOLDERS[pronoun], type: 'text' }));
                }
            });
            
            if (templateText.includes('{{Greeting}}') && !definedFieldNames.has('Greeting')) {
                ui.use.fieldsContainer.appendChild(createFieldInput({ name: 'Greeting', desc: 'Auto-populated by scheduled time', type: 'text' }));
            }

            if (ui.use.fieldsContainer.children.length === 0) {
                 ui.use.fieldsContainer.innerHTML = '<p class="col-span-full text-[var(--text-secondary)]">This template version has no placeholders.</p>';
            }

            applyPronounPreset();
            handleScheduledTimeChange();
            liveGenerateText(); 
        }
        
        function applyPronounPreset() {
            const preset = ui.use.pronounPreset.value;

            if (preset) {
                Object.keys(PRONOUN_PLACEHOLDERS).forEach(fieldName => {
                    const inputElement = document.getElementById(`field-${sanitizeForId(fieldName)}`);
                    if (inputElement) {
                        inputElement.value = "";
                        inputElement.readOnly = true;
                    }
                });
            }

            const pronouns = {
                male: { 'Pronoun_he_she_they': 'he', 'Pronoun_him_her_them': 'him', 'Pronoun_his_her_their': 'his', 'Pronoun_himself_herself_themself': 'himself' },
                female: { 'Pronoun_he_she_they': 'she', 'Pronoun_him_her_them': 'her', 'Pronoun_his_her_their': 'her', 'Pronoun_himself_herself_themself': 'herself' },
                neutral: { 'Pronoun_he_she_they': 'they', 'Pronoun_him_her_them': 'them', 'Pronoun_his_her_their': 'their', 'Pronoun_himself_herself_themself': 'themself' }
            };

            const selectedPronouns = pronouns[preset];
            if (!selectedPronouns) {
                 Object.keys(PRONOUN_PLACEHOLDERS).forEach(fieldName => {
                    const inputElement = document.getElementById(`field-${sanitizeForId(fieldName)}`);
                    if (inputElement) {
                        inputElement.readOnly = false;
                    }
                });
                return;
            }

            Object.entries(selectedPronouns).forEach(([fieldName, value]) => {
                const inputElement = document.getElementById(`field-${sanitizeForId(fieldName)}`);
                if (inputElement) {
                    inputElement.value = value;
                    inputElement.readOnly = true;
                }
            });
        }
        
        function handleScheduledTimeChange() {
            const timeValue = ui.use.scheduledTimeInput.value;
            const greetingField = document.getElementById('field-Greeting');
            if (!greetingField) return;

            if (timeValue) {
                const hour = parseInt(timeValue.split(':')[0], 10);
                let greeting = "Good morning";
                if (hour >= 12 && hour < 17) {
                    greeting = "Good afternoon";
                } else if (hour >= 17 || hour < 5) { 
                    greeting = "Good evening";
                }
                greetingField.value = greeting;
                greetingField.readOnly = true;
            } else {
                 greetingField.value = "";
                 greetingField.readOnly = false;
            }
        }
        
        function generateText() {
    const btn = ui.use.generateButton;
    const originalText = btn.innerHTML;
    
    // 1. Show Loading State
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Generating...`;
    
    // 2. Perform Generation (Simulated delay for effect, or instant)
    setTimeout(() => {
        liveGenerateText(false); 
        ui.use.step3Details.open = true;
        
        // Reveal animation
        const container = document.getElementById('generated-text-container');
        container.classList.remove('opacity-50');
        container.classList.add('opacity-100');

        // Scroll to result
        ui.use.step3Details.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Restore Button
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        // Visual Success Flash
        const previewWindow = document.querySelector('.email-client-window');
        previewWindow.classList.add('ring-2', 'ring-indigo-400');
        setTimeout(() => previewWindow.classList.remove('ring-2', 'ring-indigo-400'), 500);
        
    }, 400); // Short delay makes it feel like "work" is being done
}
        // This is the new function for live updates
        function liveGenerateText(autoCopy = false) {
            if (!currentTemplateVersion) return;
            const fieldData = {};
            document.querySelectorAll('#fields-container .dynamic-field').forEach(input => {
                const originalName = input.getAttribute('data-original-name');
                if (originalName) fieldData[originalName] = input.value;
            });

            const process = (text) => {
                if (!text) return "";
                return text.replace(/{{\s*([^}]+?)\s*}}/g, (match, placeholderName) => {
                    return fieldData.hasOwnProperty(placeholderName) ? fieldData[placeholderName] : match;
                });
            };

            ui.use.generatedSubjectInput.value = process(currentTemplateVersion.subject);
            const bodyText = process(currentTemplateVersion.template);
            ui.use.generatedTextDiv.innerText = bodyText;

            // Show the containers if they have content
            ui.use.generatedSubjectWrapper.classList.toggle('hidden', !currentTemplateVersion.subject);
            ui.use.generatedTextContainer.style.maxHeight = '500px';

            if (gapi.client && gapi.client.getToken()) {
                ui.use.loadToGmailButton.classList.remove('hidden');
            }

            if (autoCopy && bodyText) {
                copyToClipboard(bodyText, "Body copied automatically!");
            }
        }
        
        function copyToClipboard(content, message) {
            if (!content) return;
            navigator.clipboard.writeText(content).then(() => showNotification(message));
        }

        function showNotification(message) {
            ui.notification.textContent = message;
            ui.notification.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => ui.notification.classList.add('opacity-0', 'translate-y-2'), 2000);
        }
        
        function handleBatchGenerate() {
            const templateId = ui.batch.templateSelect.value;
            const file = ui.batch.csvFileInput.files[0];
            if (!templateId || !file) return alert("Please select a template and a CSV file.");
            const templateFamily = allTemplates.find(t => t.id === templateId);
            if (!templateFamily) return;
            const latestVersion = [...templateFamily.versions].sort((a,b) => b.version - a.version)[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r\n?|\n/).filter(Boolean);
                if (lines.length < 2) return alert("CSV must have a header and at least one data row.");
                const headers = lines[0].split(',').map(h => h.trim());
                const dataRows = lines.slice(1).map(line => line.split(',').reduce((obj, val, i) => { obj[headers[i]] = val.trim(); return obj; }, {}));
                displayBatchResults(dataRows, latestVersion);
            };
            reader.readAsText(file);
        }
        
        function displayBatchResults(dataRows, version) {
            ui.batch.output.innerHTML = '';
            const process = (text, data) => {
                if (!text || typeof text !== 'string' || !data || typeof data !== 'object') return "";
                return text.replace(/{{\s*([^}]+?)\s*}}/g, (match, placeholderName) => (data.hasOwnProperty(placeholderName) ? data[placeholderName] : match));
            };
            dataRows.forEach((row, i) => {
                const subject = process(version.subject, row);
                const body = process(version.template, row);
                const entryDiv = document.createElement('div');
                entryDiv.className = "p-4 border border-[var(--border-color)] rounded-lg";
                entryDiv.innerHTML = `<h4 class="font-semibold text-lg mb-2">Entry ${i + 1} (For: ${row.Name || 'N/A'})</h4>
                    ${subject ? `<div class="mb-2"><label class="block text-sm font-medium">Subject</label><input type="text" value="${subject}" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700" readonly></div>` : ''}
                    <div><label class="block text-sm font-medium">Body</label><div class="generated-html-body p-3 rounded-md whitespace-pre-wrap min-h-[5rem]">${body}</div></div>`;
                ui.batch.output.appendChild(entryDiv);
            });
            ui.batch.outputContainer.classList.remove('hidden');
        }

       async function handleSaveTemplate(event) {
    event.preventDefault();
    const name = ui.manage.nameInput.value.trim();
    const templateText = ui.manage.bodyTextarea.value;
    if (!name || !templateText) return alert("Template Name and Body cannot be empty.");
    
    const editId = ui.manage.editIdInput.value;
    
    const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('.field-row')).map(row => {
        const fieldType = row.querySelector('.field-type').value;
        const fieldData = {
            name: row.querySelector('.field-name').value.trim(),
            type: fieldType
        };
        if (fieldType === 'dropdown') {
            fieldData.options = row.querySelector('.field-options')?.value.trim() || '';
        } else {
            fieldData.desc = row.querySelector('.field-desc')?.value.trim() || '';
        }
        return fieldData;
    }).filter(f => f.name);
    
    let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]').filter(t => !t.isDefault);
    const now = new Date().toISOString();

    // FIXED: Safe access using ternary operators in case inputs are missing from DOM
    const versionData = {
        subject: ui.manage.subjectInput ? ui.manage.subjectInput.value.trim() : '',
        description: ui.manage.descriptionInput ? ui.manage.descriptionInput.value.trim() : '', // Safe access
        target: ui.manage.targetInput ? ui.manage.targetInput.value.trim() : '', // Safe access
        purpose: ui.manage.purposeInput ? ui.manage.purposeInput.value.trim() : '', // Safe access
        fields, 
        template: templateText,
    };

    if (!editId) {
        if (userTemplates.some(t => t.name.toLowerCase() === name.toLowerCase() && !t.isArchived) && !confirm(`A template named "${name}" already exists. Save anyway?`)) return;
        const newTemplateFamily = {
            id: crypto.randomUUID(), name, folder: ui.manage.folderInput.value.trim(), isArchived: false, isDefault: false, createdAt: now, updatedAt: now,
            versions: [{ ...versionData, version: 1, createdAt: now, updatedAt: now }]
        };
        userTemplates.push(newTemplateFamily);
        showSaveStatus("New template saved successfully!");
    } else {
        const templateFamily = userTemplates.find(t => t.id === editId);
        if (!templateFamily) return;
        
        templateFamily.name = name;
        templateFamily.folder = ui.manage.folderInput.value.trim();
        templateFamily.updatedAt = now;

        const latestVersion = Math.max(0, ...templateFamily.versions.map(v => v.version));
        const newVersion = { ...versionData, version: latestVersion + 1, createdAt: now, updatedAt: now };
        templateFamily.versions.push(newVersion);
        showSaveStatus(`Saved as new Version ${newVersion.version}!`);
    }
    cancelEdit(); 
    await saveAndSyncTemplates(userTemplates);
}

// --- MANAGE TAB LAYOUT CONTROLS ---
            // --- MANAGE TAB LAYOUT CONTROLS ---
            const gridContainer = document.getElementById('manage-grid-container');
            const sidebar = document.getElementById('manage-sidebar');
            const expandBtn = document.getElementById('expand-sidebar-btn');
            const collapseBtn = document.getElementById('collapse-sidebar-btn');
            
            // Sidebar Toggle Logic
            const toggleSidebar = (show) => {
                if (show) {
                    gridContainer.classList.remove('sidebar-closed');
                    sidebar.classList.remove('opacity-0', 'pointer-events-none');
                    expandBtn.classList.add('hidden');
                    expandBtn.classList.remove('flex');
                } else {
                    gridContainer.classList.add('sidebar-closed');
                    sidebar.classList.add('opacity-0', 'pointer-events-none');
                    expandBtn.classList.remove('hidden');
                    expandBtn.classList.add('flex');
                }
            };
            
            if(collapseBtn) collapseBtn.addEventListener('click', () => toggleSidebar(false));
            if(expandBtn) expandBtn.addEventListener('click', () => toggleSidebar(true));

            // Preview Pane Toggle Logic
            const previewBtn = document.getElementById('toggle-preview-btn');
            const previewPane = document.getElementById('live-preview-pane');
            const editorPane = document.getElementById('editor-pane');
            
            if(previewBtn && previewPane) {
                previewBtn.addEventListener('click', () => {
                    const isHidden = previewPane.classList.contains('hidden');
                    if (isHidden) {
                        // Show Preview
                        previewPane.classList.remove('hidden');
                        previewPane.classList.add('lg:flex');
                        editorPane.classList.remove('w-full');
                        editorPane.classList.add('w-1/2');
                        previewBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> <span>Hide Preview</span>';
                        previewBtn.classList.remove('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
                    } else {
                        // Hide Preview
                        previewPane.classList.add('hidden');
                        previewPane.classList.remove('lg:flex');
                        editorPane.classList.remove('w-1/2');
                        editorPane.classList.add('w-full');
                        previewBtn.innerHTML = '<i class="fa-solid fa-eye"></i> <span>Show Preview</span>';
                        previewBtn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
                    }
                });
            }

        function addFieldInputRow(field = { name: '', desc: '', type: 'text', options: '' }) {
            const fieldRow = document.createElement('div');
            fieldRow.className = "flex items-center gap-2 field-row";
            fieldRow.draggable = true;
            const optionsInput = field.type === 'dropdown' ? 
                `<input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-options" placeholder="Options (comma-sep)" value="${field.options || ''}">` :
                `<input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-desc" placeholder="Helpful Description" value="${field.desc || ''}">`;
            fieldRow.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 cursor-grab drag-handle flex-shrink-0 text-gray-400"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v12.5a.75.75 0 01-1.5 0V3.75A.75.75 0 0110 3zM3.5 10a.75.75 0 01.75-.75h11.5a.75.75 0 010 1.5H4.25a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg><div class="flex-grow grid grid-cols-3 gap-2"><input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-name" placeholder="Placeholder Name" value="${field.name || ''}">${optionsInput}<select class="w-full px-3 py-2 border rounded-md shadow-sm field-type"><option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option><option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option></select></div><button type="button" class="text-sm text-red-600 hover:underline flex-shrink-0 remove-field-btn">Remove</button>`;
            fieldRow.querySelector('.remove-field-btn').addEventListener('click', () => { fieldRow.remove(); updateInteractivePlaceholders(); });
            fieldRow.querySelector('.field-type').addEventListener('change', (e) => {
                const newField = { name: fieldRow.querySelector('.field-name').value, desc: fieldRow.querySelector('.field-desc')?.value || '', type: e.target.value, options: fieldRow.querySelector('.field-options')?.value || '' };
                const newRow = addFieldInputRow(newField);
                fieldRow.replaceWith(newRow);
                updateInteractivePlaceholders();
            });
            fieldRow.querySelector('.field-name').addEventListener('input', updateInteractivePlaceholders);
            ui.manage.fieldsContainer.appendChild(fieldRow);
            if (field.name) updateInteractivePlaceholders();
            return fieldRow;
        }
        
        function setupDragAndDrop() {
            const container = ui.manage.fieldsContainer;
            let draggedItem = null;
            container.addEventListener('dragstart', e => { if (e.target.classList.contains('field-row')) { draggedItem = e.target; setTimeout(() => e.target.classList.add('opacity-50'), 0); } });
            container.addEventListener('dragend', e => { if (draggedItem) { draggedItem.classList.remove('opacity-50'); draggedItem = null; } });
            container.addEventListener('dragover', e => { e.preventDefault(); const afterElement = [...container.querySelectorAll('.field-row:not(.opacity-50)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; if (afterElement == null) container.appendChild(draggedItem); else container.insertBefore(draggedItem, afterElement); });
        }
        
        function updateInteractivePlaceholders() {
            ui.manage.placeholdersContainer.innerHTML = '';
            
            // 1. Add Standard Pronouns (Fixes missing pronouns issue)
            const pronouns = Object.keys(PRONOUN_PLACEHOLDERS);
            
            const createTag = (text, type) => {
                const tag = document.createElement('div');
                tag.textContent = text;
                // High contrast, readable colors
                const colors = type === 'pronoun' 
                    ? "bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/40 dark:text-purple-300 dark:border-purple-800"
                    : "bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:border-blue-800";
                
                tag.className = `placeholder-tag ${colors} text-xs font-mono font-semibold px-3 py-1 rounded cursor-grab border select-none transition-all hover:shadow-md hover:-translate-y-0.5`;
                tag.draggable = true;
                tag.title = "Double-click to insert";
                tag.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', `{{${text}}}`));
                tag.addEventListener('dblclick', () => insertPlaceholder(`{{${text}}}`));
                return tag;
            };

            // Add Pronouns
            pronouns.forEach(name => {
                ui.manage.placeholdersContainer.appendChild(createTag(name, 'pronoun'));
            });

            // Add Custom Fields
            const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('.field-name')).map(input => input.value.trim()).filter(Boolean);
            
            if (fields.length > 0) {
                 fields.forEach(name => {
                    ui.manage.placeholdersContainer.appendChild(createTag(name, 'field'));
                });
            }
            
            // Show wrapper if we have any placeholders
            if (fields.length > 0 || pronouns.length > 0) {
                ui.manage.placeholdersWrapper.classList.remove('hidden');
            } else {
                ui.manage.placeholdersWrapper.classList.add('hidden');
            }
        }

        function insertPlaceholder(textToInsert) {
            const textarea = ui.manage.bodyTextarea;
            const start = textarea.selectionStart; const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + textToInsert + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length;
            textarea.focus();
        }
        
        function handleDrop(e) { e.preventDefault(); if (e.target.id === 'template-subject') return; const textToInsert = e.dataTransfer.getData('text/plain'); if (/\{\{.+?\}\}/.test(textToInsert)) insertPlaceholder(textToInsert); }
        function showSaveStatus(message) { ui.manage.saveStatus.textContent = message; setTimeout(() => { ui.manage.saveStatus.textContent = ''; }, 3000); }
        
        function loadTemplateIntoEditor(config) {
    const { family, version, title, saveMode } = config;
    
    ui.manage.formTitle.textContent = title;
    ui.manage.nameInput.value = family.name;
    ui.manage.folderInput.value = family.folder || '';
    
    // Safe checks: Only set value if the input exists in the HTML
    if (ui.manage.subjectInput) ui.manage.subjectInput.value = version.subject || '';
    if (ui.manage.descriptionInput) ui.manage.descriptionInput.value = version.description || '';
    if (ui.manage.targetInput) ui.manage.targetInput.value = version.target || '';
    if (ui.manage.purposeInput) ui.manage.purposeInput.value = version.purpose || '';
    
    ui.manage.bodyTextarea.value = version.template || version.body || ''; 
    
    ui.manage.editIdInput.value = family.id || '';
    ui.manage.editVersionInput.value = version.version || '';
    ui.manage.saveModeInput.value = saveMode;
    
    ui.manage.fieldsContainer.innerHTML = '';
    (version.fields || []).forEach(field => addFieldInputRow(field));
    
    ui.manage.cancelEditButton.classList.remove('hidden');
    
    // Ensure tab content is visible and scroll to top
    document.getElementById('tab-content-manage-templates').classList.remove('hidden');
    document.querySelector('.manage-editor').scrollTop = 0;
    
    updateManagerPreview();
}

        function useLatestVersionForEdit(templateId) {
    const family = allTemplates.find(t => t.id === templateId);
    if (!family) return;
    
    // Get latest version
    const latestVersion = [...family.versions].sort((a,b) => b.version - a.version)[0];
    
    loadTemplateIntoEditor({
        family: family,
        version: latestVersion,
        title: `Editing ${family.name}`,
        saveMode: 'new_version' // Saving will create a new version
    });
}

        // Renamed 'editVersionInPlace' to 'viewOrRestoreVersion' for clarity
        function viewOrRestoreVersion(templateId, versionNumber) { 
            const family = allTemplates.find(t => t.id === templateId); 
            const version = family?.versions.find(v => v.version == versionNumber); 
            if (family && version) {
                // Set saveMode to 'new_version_from_old' - this signals that saving will create a new version based on this old one
                loadTemplateIntoEditor({ 
                    family, 
                    version, 
                    title: `Viewing/Restoring Version ${version.version} of "${family.name}"`, 
                    saveMode: 'new_version_from_old' 
                });
            }
        }
        function duplicateAsNewTemplate(templateId, versionNumber) { const family = allTemplates.find(t => t.id === templateId); const version = family?.versions.find(v => v.version == versionNumber); if (family && version) { const newFamily = { ...family, id: '', name: `Copy of ${family.name}` }; const newVersion = { ...version, version: '' }; loadTemplateIntoEditor({ family: newFamily, version: newVersion, title: `Creating New Template from "${family.name}" v${version.version}`, saveMode: 'new_template' }); } }
        function addBlankVersion(templateId) { const family = allTemplates.find(t => t.id === templateId); if (family) loadTemplateIntoEditor({ family, version: { fields: [] }, title: `Adding Blank New Version to "${family.name}"`, saveMode: 'new_version' }); }

        function cancelEdit() {
    ui.manage.formTitle.textContent = "Create New Template";
    ui.manage.form.reset();
    ui.manage.bodyTextarea.value = '';
    ui.manage.fieldsContainer.innerHTML = '';
    ui.manage.editIdInput.value = "";
    ui.manage.editVersionInput.value = "";
    ui.manage.saveModeInput.value = "";
    ui.manage.cancelEditButton.classList.add('hidden');
    
    // If you implemented the update from the previous step, keep this:
    updateInteractivePlaceholders(); 
}

// --- ADD THIS LINE HERE ---
window.cancelEdit = cancelEdit;

        async function toggleArchiveTemplate(templateId) { let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]'); const template = userTemplates.find(t => t.id === templateId); if (template) { template.isArchived = !template.isArchived; template.updatedAt = new Date().toISOString(); } await saveAndSyncTemplates(userTemplates); }
        async function deleteTemplate(templateId) { if (!confirm("Are you sure you want to permanently delete this template and all its versions?")) return; let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]'); userTemplates = userTemplates.filter(t => t.id !== templateId); await saveAndSyncTemplates(userTemplates); }
        
        function useVersion(templateId, versionNumber) { 
            switchTab('use-templates'); 
            const family = allTemplates.find(t => t.id === templateId);
            if (family) {
                selectedFolder = family.folder || 'Uncategorized';
                renderFolderList();
                renderTemplateList();
                handleTemplateSelection(templateId);
                setTimeout(() => { 
                    ui.use.versionSelect.value = versionNumber; 
                    ui.use.versionSelect.dispatchEvent(new Event('change')); 
                }, 100);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }
        
        function renderTemplateManager(searchTerm = '') {
    ui.manage.userTemplatesList.innerHTML = '';
    const term = searchTerm.toLowerCase().trim();
    
    // CHANGED: Filter based on search term AND default status
    const userTemplates = allTemplates.filter(t => {
        const isNotDefault = !t.isDefault;
        const matchesSearch = !term || t.name.toLowerCase().includes(term);
        return isNotDefault && matchesSearch;
    });

    const groupedByFolder = userTemplates.reduce((acc, template) => { 
        const folder = template.folder || 'Uncategorized'; 
        if (!acc[folder]) acc[folder] = []; 
        acc[folder].push(template); 
        return acc; 
    }, {});
    
    // Sort folders alphabetically
    Object.keys(groupedByFolder).sort().forEach(folder => {
        const folderContainer = document.createElement('details');
        folderContainer.className = 'folder-group mb-2'; 
        // If searching, always expand folders to show results
        folderContainer.open = !!term; 
        
        const folderSummary = document.createElement('summary');
        folderSummary.className = 'font-bold text-gray-500 uppercase text-xs cursor-pointer py-2 hover:text-[var(--primary)]';
        folderSummary.innerHTML = `${folder} <span class="ml-2 text-[10px] bg-gray-200 dark:bg-gray-700 px-1 rounded">${groupedByFolder[folder].length}</span>`;
        folderContainer.appendChild(folderSummary);
        
        const templateListDiv = document.createElement('div');
        templateListDiv.className = 'space-y-1 pl-2'; 
        
        const visibleTemplates = groupedByFolder[folder].filter(t => showArchived || !t.isArchived);
        
        if (visibleTemplates.length > 0) {
            visibleTemplates.forEach(template => {
                const item = document.createElement('div');
                const isActive = template.id === ui.manage.editIdInput.value;
                item.className = `p-2 rounded cursor-pointer border-l-4 transition hover:bg-gray-100 dark:hover:bg-gray-800 ${isActive ? 'bg-gray-100 dark:bg-gray-800 border-blue-500' : 'border-transparent'}`;
                
                item.innerHTML = `
                    <div class="font-bold text-sm truncate text-[var(--text)]">${template.name}</div>
                    <div class="text-[10px] text-gray-400 flex justify-between">
                        <span>v${Math.max(...template.versions.map(v=>v.version))}</span>
                        ${template.isArchived ? '<span class="text-yellow-600">Archived</span>' : ''}
                    </div>
                `;
                
                item.onclick = () => useLatestVersionForEdit(template.id);
                templateListDiv.appendChild(item);
            });
            folderContainer.appendChild(templateListDiv);
            ui.manage.userTemplatesList.appendChild(folderContainer);
        }
    });
    
    // Handle Empty State
    if (ui.manage.userTemplatesList.innerHTML === '') {
        ui.manage.userTemplatesList.innerHTML = term 
            ? `<p class="text-center text-gray-500 mt-4 text-sm">No matching templates found.</p>`
            : `<p class="text-center text-gray-500 mt-4 text-sm">${showArchived ? 'No archived templates.' : 'Create your first template!'}</p>`;
    }
}

        function exportTemplates() { const data = localStorage.getItem('userTemplates') || '[]'; const blob = new Blob([data], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `text_merge_templates_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href); }
        async function handleImportFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { let data = JSON.parse(e.target.result); data = migrateTemplates(data); if (!Array.isArray(data) || !data.every(t => t.id && t.name && t.versions)) throw new Error("Invalid template file."); const merge = confirm("Merge with existing templates? (Cancel to replace)"); const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : []; alert(`Imported ${data.length} templates.`); await saveAndSyncTemplates([...existing, ...data]); } catch (error) { alert(`Import failed: ${error.message}`); } }; reader.readAsText(file); ui.manage.importFileInput.value = ''; }

        function initializeFirebase() {
            try {
                firebaseApp = initializeApp(FIREBASE_CONFIG);
                firebaseAuth = getAuth(firebaseApp);
                firestoreDb = getFirestore(firebaseApp);
                onAuthStateChanged(firebaseAuth, async user => {
                    currentUser = user;
                    if (nav) nav.updateUser(user ? user.email : null);
                    updateFirebaseAuthStatus(!!user);
                    if (user) {
                        listenForThemeChanges();
                        await checkForCloudUpdates();
                        listenForTemplateChanges();
                    } else {
                        if (templatesUnsubscribe) templatesUnsubscribe();
                        if (themeUnsubscribe) themeUnsubscribe();
                        templatesUnsubscribe = null;
                        themeUnsubscribe = null;
                        loadTemplates();
                        setSyncState('unknown');
                        applyTheme(localStorage.getItem('theme') || 'light');
                    }
                });
            } catch (e) { console.error("Firebase initialization error: ", e); ui.sync.status.textContent = "Firebase is not configured correctly."; }
        }

        function handleFirebaseSignIn() { const email = ui.sync.emailInput.value, password = ui.sync.passwordInput.value; if (!email || !password) return alert("Please enter email and password."); signInWithEmailAndPassword(firebaseAuth, email, password).catch(error => alert(`Sign in failed: ${error.message}`)); }
        function handleFirebaseSignUp() { const email = ui.sync.emailInput.value, password = ui.sync.passwordInput.value; if (!email || !password) return alert("Please enter email and password."); createUserWithEmailAndPassword(firebaseAuth, email, password).catch(error => alert(`Sign up failed: ${error.message}`)); }
        function handleGoogleSignIn() { const provider = new GoogleAuthProvider(); signInWithPopup(firebaseAuth, provider).catch(error => alert(`Google sign in failed: ${error.message}`)); }
        function handleFirebaseSignOut() { signOut(firebaseAuth); }
        function updateFirebaseAuthStatus(isSignedIn) { ui.sync.authContainer.classList.toggle('hidden', isSignedIn); ui.sync.controls.classList.toggle('hidden', !isSignedIn); if (isSignedIn) ui.sync.authStatus.textContent = `Signed in as ${currentUser.email}`; }
        
        async function saveAndSyncTemplates(templates) { localStorage.setItem('userTemplates', JSON.stringify(templates)); loadTemplates(); if (currentUser) await saveTemplatesToFirebase(templates); else setSyncState('unsynced'); }
        async function saveTemplatesToFirebase(templatesToSave = null) {
            if (!currentUser) return;
            setSyncState('syncing');
            const templatesData = templatesToSave ? templatesToSave : JSON.parse(localStorage.getItem('userTemplates') || '[]').filter(t => !t.isDefault);
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            try {
                await setDoc(userDocRef, { templates: templatesData, updatedAt: new Date().toISOString() });
                setSyncState('synced');
            } catch (error) { setSyncState('error'); console.error("Firebase save error:", error); }
        }

        function listenForTemplateChanges() {
            if (templatesUnsubscribe) templatesUnsubscribe();
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            templatesUnsubscribe = onSnapshot(userDocRef, (docSnap) => { if (!docSnap.metadata.hasPendingWrites && docSnap.exists()) checkForCloudUpdates(docSnap.data()); });
        }
        
        function deterministicStringify(obj) { if (obj === null || typeof obj !== 'object') return JSON.stringify(obj); if (Array.isArray(obj)) return `[${obj.map(deterministicStringify).join(',')}]`; const keys = Object.keys(obj).sort(); const objectBody = keys.map(key => `${JSON.stringify(key)}:${deterministicStringify(obj[key])}`).join(','); return `{${objectBody}}`; }
        function createTemplateHash(template) { if (!template) return null; const clone = JSON.parse(JSON.stringify(template)); delete clone.createdAt; delete clone.updatedAt; if (clone.versions) { clone.versions.sort((a, b) => a.version - b.version); clone.versions.forEach(v => { delete v.createdAt; delete v.updatedAt; if (v.fields) v.fields.sort((a, b) => a.name.localeCompare(b.name)); }); } return deterministicStringify(clone); }

        async function checkForCloudUpdates(remoteData = null) {
            if (!currentUser) return;
            setSyncState('syncing');
            try {
                if (!remoteData) {
                    const docSnap = await getDoc(doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates"));
                    if (docSnap.exists()) remoteData = docSnap.data(); 
                    else { await saveTemplatesToFirebase(); return; }
                }
                const localTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]').filter(t => !t.isDefault);
                const remoteTemplates = migrateTemplates(remoteData?.templates || []);
                const localMap = new Map(localTemplates.map(t => [t.id, t]));
                const remoteMap = new Map(remoteTemplates.map(t => [t.id, t]));
                let needsSync = localTemplates.length !== remoteTemplates.length;
                const allIds = new Set([...localMap.keys(), ...remoteMap.keys()]);
                const conflicts = [];
                const mergedTemplates = [];
                for (const id of allIds) {
                    const local = localMap.get(id); const remote = remoteMap.get(id);
                    if (local && !remote) { mergedTemplates.push(local); needsSync = true; } 
                    else if (!local && remote) { mergedTemplates.push(remote); needsSync = true; } 
                    else if (local && remote) {
                        if (createTemplateHash(local) === createTemplateHash(remote)) mergedTemplates.push(local); 
                        else { conflicts.push({ id, local, remote }); needsSync = true; }
                    }
                }
                if (conflicts.length > 0) { setSyncState('unsynced'); displayConflicts(conflicts, mergedTemplates.filter(t => !conflicts.find(c => c.id === t.id))); } 
                else if (needsSync) { await saveAndSyncTemplates(mergedTemplates); } 
                else { setSyncState('synced'); }
            } catch (error) { setSyncState('error'); console.error("Error checking for cloud updates:", error); }
        }
        
        function displayConflicts(conflicts, nonConflictingTemplates) {
            ui.sync.conflictContainer.innerHTML = '';
            conflicts.forEach(conflict => {
                const conflictDiv = document.createElement('div');
                conflictDiv.className = 'border p-4 rounded-lg bg-gray-50 dark:bg-gray-700';
                conflictDiv.dataset.id = conflict.id;
                const localLatest = [...conflict.local.versions].sort((a,b)=>b.version-a.version)[0];
                const remoteLatest = [...conflict.remote.versions].sort((a,b)=>b.version-a.version)[0];
                conflictDiv.innerHTML = `<h4 class="text-lg font-bold">${conflict.local.name}</h4><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div class="p-3 border rounded-md bg-white dark:bg-gray-600"><label class="flex items-center space-x-3 cursor-pointer"><input type="radio" name="conflict_${conflict.id}" value="local" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500" checked><div class="font-semibold">Keep Local Version<span class="block text-sm font-normal text-gray-600 dark:text-gray-300">Latest: v${localLatest.version} (Updated: ${new Date(localLatest.updatedAt).toLocaleString()})</span></div></label></div><div class="p-3 border rounded-md bg-white dark:bg-gray-600"><label class="flex items-center space-x-3 cursor-pointer"><input type="radio" name="conflict_${conflict.id}" value="remote" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500"><div class="font-semibold">Keep Cloud Version<span class="block text-sm font-normal text-gray-600 dark:text-gray-300">Latest: v${remoteLatest.version} (Updated: ${new Date(remoteLatest.updatedAt).toLocaleString()})</span></div></label></div></div>`;
                ui.sync.conflictContainer.appendChild(conflictDiv);
            });
            ui.sync.conflictModal.classList.remove('hidden');
            const resolveHandler = async (e) => {
                const btn = e.currentTarget;
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin inline -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...`;
                const finalTemplates = [...nonConflictingTemplates];
                conflicts.forEach(conflict => { const choice = document.querySelector(`input[name="conflict_${conflict.id}"]:checked`).value; finalTemplates.push(choice === 'local' ? conflict.local : conflict.remote); });
                try { await saveAndSyncTemplates(finalTemplates); ui.sync.conflictModal.classList.add('hidden'); showNotification("Sync conflicts resolved!"); } catch (error) { console.error("Failed to resolve conflicts:", error); showNotification("Error: Could not resolve conflicts."); } finally { btn.disabled = false; btn.textContent = 'Apply Custom Resolutions & Sync'; }
            };
            let newBtn = ui.sync.resolveButton.cloneNode(true);
            ui.sync.resolveButton.parentNode.replaceChild(newBtn, ui.sync.resolveButton);
            ui.sync.resolveButton = newBtn;
            ui.sync.resolveButton.textContent = 'Apply Custom Resolutions & Sync';
            ui.sync.resolveButton.addEventListener('click', resolveHandler);
        }

        function setSyncState(newState) {
            syncState = newState;
            const indicator = ui.sync.indicator;
            indicator.className = 'text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2';
            let iconHtml = '';
            switch(newState) {
                case 'synced': indicator.textContent = 'Synced'; indicator.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/50', 'dark:text-green-300'); break;
                case 'unsynced': indicator.textContent = 'Unsynced Changes'; indicator.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/50', 'dark:text-yellow-300'); break;
                case 'syncing': iconHtml = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`; indicator.innerHTML = `${iconHtml} Syncing...`; indicator.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900/50', 'dark:text-blue-300'); break;
                case 'error': indicator.textContent = 'Sync Error'; indicator.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/50', 'dark:text-red-300'); break;
                default: indicator.classList.add('hidden');
            }
        }
        
        function gapiLoaded() { if(gapi && gapi.load) gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { if(gapi && gapi.client) await gapi.client.init({ apiKey: GMAIL_API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"], }); }
        function gisLoaded() { if(google && google.accounts && google.accounts.oauth2) tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GMAIL_CLIENT_ID, scope: GMAIL_SCOPES, callback: (tokenResponse) => { if (tokenResponse && tokenResponse.access_token) { gapi.client.setToken(tokenResponse); ui.sync.gmailAuthStatus.textContent = "Gmail access authorized successfully!"; ui.sync.authorizeGmailButton.disabled = true; ui.sync.authorizeGmailButton.textContent = "Gmail Authorized"; if (ui.use.generatedTextDiv.innerText) ui.use.loadToGmailButton.classList.remove('hidden'); } }, }); }
        function handleAuthGmailClick() { if (!tokenClient) return; if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); else tokenClient.requestAccessToken({prompt: ''}); }
        async function createGmailDraft() { const subject = ui.use.generatedSubjectInput.value; const body = ui.use.generatedTextDiv.innerText; const email = [`Subject: ${subject}`, 'Content-Type: text/plain; charset="UTF-8"', 'MIME-Version: 1.0', '', body].join('\n'); const base64EncodedEmail = btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_'); try { await gapi.client.gmail.users.drafts.create({ 'userId': 'me', 'resource': { 'message': { 'raw': base64EncodedEmail } } }); showNotification("Draft created in Gmail!"); } catch (err) { console.error("Gmail API Error:", err); alert(`Could not create Gmail draft. Your authorization may have expired.`); } }

        function applyTheme(theme) {
    document.documentElement.classList.toggle('dark', theme === 'dark');
    const newColorScheme = theme === 'dark' ? 'dark' : 'light';
    document.documentElement.style.colorScheme = newColorScheme;
}

        
        async function saveUserSettings(settings) {
            if (!currentUser) return;
            const settingsDocRef = doc(firestoreDb, `users/${currentUser.uid}/settings`, 'theme');
            try {
                await setDoc(settingsDocRef, settings, { merge: true });
            } catch (error) {
                console.error("Error saving user settings:", error);
            }
        }

        function listenForThemeChanges() {
            if (themeUnsubscribe) themeUnsubscribe();
            if (!currentUser) {
                applyTheme(localStorage.getItem('theme') || 'light');
                return;
            }

            const themeDocRef = doc(firestoreDb, `users/${currentUser.uid}/settings`, 'theme');
            themeUnsubscribe = onSnapshot(themeDocRef, (docSnap) => {
                const localTheme = localStorage.getItem('theme') || 'light';
                let theme = localTheme;

                if (docSnap.exists() && docSnap.data().theme) {
                    theme = docSnap.data().theme;
                } else {
                    saveUserSettings({ theme: localTheme });
                }
                
                applyTheme(theme);
                localStorage.setItem('theme', theme);
            }, (error) => {
                console.error("Error listening for theme changes:", error);
                applyTheme(localStorage.getItem('theme') || 'light');
            });
        }
        
        applyTheme(localStorage.getItem('theme') || 'light');

    </script>
</body>
</html>