<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text/Merge Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicons/file-lines.svg" type="image/svg+xml">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-card {
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        #generated-text-container.transition-height {
            transition: max-height 1s ease-in-out;
        }
        .template-list-item {
            transition: background-color 0.2s ease-in-out;
        }
        .template-list-item:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        .placeholder-tag {
            cursor: grab;
            user-select: none;
        }
        .generated-html-body {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem;
            min-height: 10rem;
            background-color: #f9fafb;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Text/Merge Generator</h1>
            <p class="text-gray-600 mt-2">Create, manage, and use your own comment templates with advanced features.</p>
        </header>
        <div class="flex justify-between items-center mb-6">
            <span id="version-display" class="text-sm font-semibold text-gray-500 dark:text-gray-400"></span>
            <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
        </div>

        <div class="mb-8 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="use-templates">
                    Use Templates
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="batch-generate">
                    Batch Generate
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="manage-templates">
                    Manage Templates
                </button>
                 <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2" data-tab="sync-settings">
                    Sync & Settings
                    <span id="sync-status-indicator" class="text-xs font-medium px-2 py-0.5 rounded-full hidden"></span>
                </button>
            </nav>
        </div>

        <div id="tab-content-use-templates">
            <div class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 1: Choose a Template</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Category</label>
                            <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="template-select" class="block text-sm font-medium text-gray-700 mb-1">Select a comment template</label>
                            <select id="template-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 2: Fill in the Details</h2>
                    <div id="fields-container" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <p class="text-gray-500 col-span-full">Please select a template first.</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 3: Generate & Copy Text</h2>
                    <div class="text-center">
                         <button id="generate-button" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Generate Text
                        </button>
                    </div>
                   
                    <div id="generated-text-container" class="mt-6 max-h-0 overflow-hidden transition-height space-y-4">
                        <div id="generated-subject-wrapper" class="hidden">
                            <div class="flex justify-between items-center mb-2">
                                <label for="generated-subject" class="block text-sm font-medium text-gray-700">Generated Subject:</label>
                                <button type="button" id="copy-subject-button" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                    Copy Subject
                                </button>
                            </div>
                            <input type="text" id="generated-subject" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Generated Body:</label>
                                <button id="copy-body-button" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                    Copy Body
                                </button>
                            </div>
                            <div id="generated-text" class="generated-html-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-content-batch-generate" class="hidden">
             <div class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Batch Generate from CSV</h2>
                    <p class="text-gray-600 mb-4">Upload a CSV file where the column headers match the placeholders of your chosen template (e.g., a column named 'Name' for the {{Name}} placeholder).</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="batch-template-select" class="block text-sm font-medium text-gray-700 mb-1">1. Select Template to Use</label>
                            <select id="batch-template-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="csv-file-input" class="block text-sm font-medium text-gray-700 mb-1">2. Upload CSV File</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="batch-generate-button" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out text-lg">
                            Generate All
                        </button>
                    </div>
                </div>
                 <div id="batch-output-container" class="hidden bg-white p-6 rounded-lg shadow-md step-card">
                     <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Generated Output</h2>
                     <div id="batch-output" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <div id="tab-content-manage-templates" class="hidden">
            <div id="template-manager" class="bg-white p-6 rounded-lg shadow-md step-card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Template Management</h2>
                
                <div class="bg-gray-50 p-6 rounded-lg border mb-6">
                    <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-800">Create New Template</h3>
                    <form id="template-form" class="space-y-4">
                        <input type="hidden" id="template-edit-index">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                <label for="template-name" class="block text-sm font-medium text-gray-700">Template Name</label>
                                <input type="text" id="template-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive Progress Review" required>
                            </div>
                            <div>
                                <label for="template-category" class="block text-sm font-medium text-gray-700">Category (Optional)</label>
                                <input type="text" id="template-category" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive Feedback, Attendance">
                            </div>
                        </div>
                        <div>
                            <label for="template-subject" class="block text-sm font-medium text-gray-700">Template Subject (Optional)</label>
                            <input type="text" id="template-subject" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Update on {{Name}}'s Progress">
                        </div>
                         <div>
                            <label for="template-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <input type="text" id="template-description" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="A brief description of this template">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="template-target" class="block text-sm font-medium text-gray-700">Target Audience</label>
                                <input type="text" id="template-target" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Parents, Students">
                            </div>
                            <div>
                                <label for="template-purpose" class="block text-sm font-medium text-gray-700">Purpose</label>
                                <input type="text" id="template-purpose" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive reinforcement">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Define Template Placeholders</label>
                            <div id="dynamic-fields-container" class="space-y-2 mt-1"></div>
                            <button type="button" id="add-field-button" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors py-1 px-2 rounded-md bg-blue-100 hover:bg-blue-200">
                                + Add Placeholder
                            </button>
                        </div>
                        <div id="interactive-placeholders-wrapper" class="hidden">
                             <label class="block text-sm font-medium text-gray-700">Available Placeholders</label>
                             <div id="interactive-placeholders-container" class="mt-1 p-2 bg-gray-200 rounded-md flex flex-wrap gap-2"></div>
                             <p class="text-xs text-gray-500 mt-1">Drag & drop or double-click a placeholder to insert it into the editor.</p>
                        </div>
                        <div>
                            <label for="template-body" class="block text-sm font-medium text-gray-700">Template Text</label>
                            <textarea id="template-body" rows="8" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Write your template text here, using placeholders like {{Student_Name}}."></textarea>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="submit" id="save-template-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save Template</button>
                            <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 hidden">Cancel Edit</button>
                        </div>
                    </form>
                     <p id="save-status" class="text-sm mt-3 text-green-600"></p>
                </div>

                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                         <h3 class="text-xl font-semibold text-gray-800">Your Saved Templates</h3>
                         <div class="flex items-center gap-2">
                            <button id="import-button" class="text-sm font-semibold text-gray-700 hover:text-gray-900 transition-colors py-1 px-3 rounded-md bg-gray-200 hover:bg-gray-300">Import from File</button>
                            <button id="export-button" class="text-sm font-semibold text-white hover:text-white transition-colors py-1 px-3 rounded-md bg-blue-600 hover:bg-blue-700">Export to File</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                         </div>
                    </div>
                    <div id="user-templates-list" class="space-y-4">
                        <p class="text-gray-500">You haven't created any templates yet.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-content-sync-settings" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md step-card mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Sync with Firebase</h2>
                <div id="firebase-auth-container">
                    <p class="text-gray-600 mb-4">Sign in to sync your templates across devices.</p>
                    <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                        <div class="flex-grow">
                            <label for="firebase-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="firebase-email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="your@email.com">
                        </div>
                        <div class="flex-grow">
                            <label for="firebase-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="firebase-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                        </div>
                        <div class="flex gap-2">
                            <button id="firebase-signin-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Sign In</button>
                            <button id="firebase-signup-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Sign Up</button>
                        </div>
                    </div>
                </div>
                <div id="firebase-sync-controls" class="hidden mt-6 space-y-4">
                    <p id="firebase-auth-status" class="text-sm text-green-600"></p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="firebase-save-button" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Save to Firebase</button>
                        <button id="firebase-load-button" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Load from Firebase</button>
                    </div>
                    <button id="firebase-signout-button" class="text-sm text-red-600 hover:underline">Sign Out</button>
                </div>
                <p id="firebase-status" class="text-sm mt-4 text-gray-600"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { changelogData } from '/changelog-data.js';
        
        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3",
        };

        const defaultTemplates = [
            {
                name: "Positive Progress Review",
                category: "Education",
                subject: "An update on {{Name}}'s progress in {{Subject}}",
                description: "A standard positive review for a student making good progress.",
                target: "Parents/Guardians",
                purpose: "To inform and praise.",
                fields: ["Name", "Pronoun_HeShe", "Pronoun_hisher", "Subject", "Tutor"],
                template: "This is a review of {{Name}}'s progress in {{Subject}}.\n\nI am pleased to report that {{Name}} is making excellent progress. {{Pronoun_HeShe}} consistently demonstrates a strong understanding of the core concepts and actively participates in class discussions.\n\n{{Pronoun_hisher}} work is always completed to a high standard, and {{Pronoun_HeShe}} shows great enthusiasm for the subject. It is a pleasure to have {{Name}} in my class.\n\nRegards,\n{{Tutor}}",
                createdAt: new Date('2023-01-01T10:00:00Z').toISOString(),
                updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(),
                isDefault: true
            },
            {
                name: "Needs Improvement Review",
                category: "Education",
                subject: "Update regarding {{Name}} in {{Subject}}",
                description: "Highlights an area of concern and suggests next steps.",
                target: "Parents/Guardians",
                purpose: "To inform and seek support.",
                fields: ["Name", "Pronoun_HeShe", "Pronoun_hisher", "Subject", "Year_Group", "Tutor", "Specific_Area"],
                template: "This is an update regarding {{Name}} in Year {{Year_Group}} {{Subject}}.\n\nWhile {{Name}} has a foundational understanding of the subject, there are areas that require more focus. Specifically, {{Pronoun_HeShe}} is finding {{Specific_Area}} challenging and would benefit from additional practice.\n\nI encourage {{Name}} to ask more questions in class and attend support sessions to improve {{Pronoun_hisher}} confidence and skills in this area. We will continue to provide support in school.\n\nRegards,\n{{Tutor}}",
                createdAt: new Date('2023-01-01T10:00:00Z').toISOString(),
                updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(),
                isDefault: true
            }
        ];
        
        let allTemplates = [];
        let syncState = 'unknown'; // States: unknown, synced, unsynced, syncing, error
        let firebaseApp, firebaseAuth, firestoreDb;
        let currentUser = null;

        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = {
            'use-templates': document.getElementById('tab-content-use-templates'),
            'batch-generate': document.getElementById('tab-content-batch-generate'),
            'manage-templates': document.getElementById('tab-content-manage-templates'),
            'sync-settings': document.getElementById('tab-content-sync-settings')
        };
        const templateSelect = document.getElementById('template-select');
        const categoryFilter = document.getElementById('category-filter');
        const fieldsContainer = document.getElementById('fields-container');
        const generateButton = document.getElementById('generate-button');
        const generatedTextContainer = document.getElementById('generated-text-container');
        const generatedSubjectWrapper = document.getElementById('generated-subject-wrapper');
        const generatedSubjectInput = document.getElementById('generated-subject');
        const generatedTextDiv = document.getElementById('generated-text');
        const copySubjectButton = document.getElementById('copy-subject-button');
        const copyBodyButton = document.getElementById('copy-body-button');
        const templateForm = document.getElementById('template-form');
        const formTitle = document.getElementById('form-title');
        const templateNameInput = document.getElementById('template-name');
        const templateCategoryInput = document.getElementById('template-category');
        const templateSubjectInput = document.getElementById('template-subject');
        const templateDescriptionInput = document.getElementById('template-description');
        const templateTargetInput = document.getElementById('template-target');
        const templatePurposeInput = document.getElementById('template-purpose');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        const addFieldButton = document.getElementById('add-field-button');
        const interactivePlaceholdersWrapper = document.getElementById('interactive-placeholders-wrapper');
        const interactivePlaceholdersContainer = document.getElementById('interactive-placeholders-container');
        const templateBodyTextarea = document.getElementById('template-body');
        const templateEditIndexInput = document.getElementById('template-edit-index');
        const userTemplatesList = document.getElementById('user-templates-list');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const saveStatus = document.getElementById('save-status');
        const exportButton = document.getElementById('export-button');
        const importButton = document.getElementById('import-button');
        const importFileInput = document.getElementById('import-file-input');
        const batchTemplateSelect = document.getElementById('batch-template-select');
        const csvFileInput = document.getElementById('csv-file-input');
        const batchGenerateButton = document.getElementById('batch-generate-button');
        const batchOutputContainer = document.getElementById('batch-output-container');
        const batchOutput = document.getElementById('batch-output');
        const syncStatusIndicator = document.getElementById('sync-status-indicator');
        const firebaseAuthContainer = document.getElementById('firebase-auth-container');
        const firebaseSyncControls = document.getElementById('firebase-sync-controls');
        const firebaseEmailInput = document.getElementById('firebase-email');
        const firebasePasswordInput = document.getElementById('firebase-password');
        const firebaseSigninButton = document.getElementById('firebase-signin-button');
        const firebaseSignupButton = document.getElementById('firebase-signup-button');
        const firebaseSignoutButton = document.getElementById('firebase-signout-button');
        const firebaseAuthStatus = document.getElementById('firebase-auth-status');
        const firebaseSaveButton = document.getElementById('firebase-save-button');
        const firebaseLoadButton = document.getElementById('firebase-load-button');
        const firebaseStatus = document.getElementById('firebase-status');
        const versionDisplay = document.getElementById('version-display');


        // --- INITIALIZATION ---
        window.onload = function() {
            loadTemplates();
            setupTabs();
            
            // Event Listeners
            categoryFilter.addEventListener('change', () => populateTemplateSelector());
            templateSelect.addEventListener('change', handleTemplateChange);
            generateButton.addEventListener('click', generateText);
            copyBodyButton.addEventListener('click', () => copyToClipboard(generatedTextDiv, copyBodyButton, "Copy Body", true));
            copySubjectButton.addEventListener('click', () => copyToClipboard(generatedSubjectInput, copySubjectButton, "Copy Subject"));
            templateForm.addEventListener('submit', handleSaveTemplate);
            cancelEditButton.addEventListener('click', cancelEdit);
            addFieldButton.addEventListener('click', () => addFieldInputRow());
            exportButton.addEventListener('click', exportTemplates);
            importButton.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', handleImportFile);
            batchGenerateButton.addEventListener('click', handleBatchGenerate);
            
            // Settings Listeners
            firebaseSigninButton.addEventListener('click', handleFirebaseSignIn);
            firebaseSignupButton.addEventListener('click', handleFirebaseSignUp);
            firebaseSignoutButton.addEventListener('click', handleFirebaseSignOut);
            firebaseSaveButton.addEventListener('click', saveToFirebase);
            firebaseLoadButton.addEventListener('click', loadFromFirebase);

            
            templateBodyTextarea.addEventListener('dragover', e => e.preventDefault());
            templateBodyTextarea.addEventListener('drop', handleDrop);

            initializeFirebase();
            versionDisplay.textContent = changelogData[0].version;
        };

        function initializeFirebase() {
            try {
                firebaseApp = initializeApp(FIREBASE_CONFIG);
                firebaseAuth = getAuth(firebaseApp);
                firestoreDb = getFirestore(firebaseApp);

                onAuthStateChanged(firebaseAuth, user => {
                    currentUser = user;
                    updateFirebaseAuthStatus(!!user);
                });
            } catch (e) {
                console.error("Firebase initialization error: ", e);
                firebaseStatus.textContent = "Firebase is not configured correctly.";
            }
        }
        
        // --- TABS & UI ---
        function setupTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
            });
            switchTab('use-templates');
        }

        function switchTab(activeTab) {
            tabButtons.forEach(button => button.classList.toggle('active', button.dataset.tab === activeTab));
            Object.values(tabContents).forEach(content => content.classList.add('hidden'));
            tabContents[activeTab].classList.remove('hidden');
        }
        
        // --- TEMPLATE LOADING & HANDLING ---
        function loadTemplates() {
            let userTemplates = [];
            try {
                userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            } catch (e) { console.error("Error parsing user templates:", e); }
            
            allTemplates = [...defaultTemplates, ...userTemplates];
            populateCategoryFilter();
            populateTemplateSelector();
            populateBatchTemplateSelector();
            renderTemplateManager();
            handleTemplateChange(); 
        }

        function populateCategoryFilter() {
            const categories = [...new Set(allTemplates.map(t => t.category).filter(Boolean))];
            const selectedValue = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = selectedValue;
        }
        
        function populateTemplateSelector() {
            const selectedValue = templateSelect.value;
            templateSelect.innerHTML = '<option value="-1">Select a template...</option>';
            const selectedCategory = categoryFilter.value;
            const filtered = selectedCategory ? allTemplates.filter(t => t.category === selectedCategory) : allTemplates;
            filtered.forEach(template => {
                const index = allTemplates.indexOf(template);
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                templateSelect.appendChild(option);
            });
            templateSelect.value = selectedValue || "-1";
        }
        
        function populateBatchTemplateSelector() {
            batchTemplateSelect.innerHTML = '<option value="-1">Select a template...</option>';
            allTemplates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                batchTemplateSelect.appendChild(option);
            });
        }

        function handleTemplateChange() {
            const selectedIndex = parseInt(templateSelect.value, 10);
            fieldsContainer.innerHTML = '';
            generatedTextDiv.innerHTML = '';
            generatedSubjectInput.value = '';
            generatedTextContainer.style.maxHeight = '0px';

            if (selectedIndex === -1) {
                fieldsContainer.innerHTML = '<p class="text-gray-500 col-span-full">Please select a template first.</p>';
                generateButton.disabled = true;
                return;
            }
            const template = allTemplates[selectedIndex];
            if (template.fields.length === 0) {
                fieldsContainer.innerHTML = '<p class="text-gray-500 col-span-full">This template has no placeholders.</p>';
            } else {
                template.fields.forEach(fieldName => {
                    if (!fieldName) return;
                    const fieldWrapper = document.createElement('div');
                    fieldWrapper.innerHTML = `
                        <label for="field-${fieldName}" class="block text-sm font-medium text-gray-700 mb-1">${fieldName.replace(/_/g, ' ')}</label>
                        <input type="text" id="field-${fieldName}" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter ${fieldName.replace(/_/g, ' ')}...">
                    `;
                    fieldsContainer.appendChild(fieldWrapper);
                });
            }
            generateButton.disabled = false;
        }
        
        // --- TEXT GENERATION ---
        function generateText() {
            const selectedIndex = templateSelect.value;
            const template = allTemplates[selectedIndex];
            if (!template) return;

            const fieldData = {};
            template.fields.forEach(fieldName => {
                if (!fieldName) return;
                const input = document.getElementById(`field-${fieldName}`);
                fieldData[fieldName] = input ? input.value : '';
            });

            const process = (str) => str ? Object.entries(fieldData).reduce((acc, [key, val]) => acc.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), val), str) : "";

            generatedSubjectInput.value = process(template.subject);
            generatedTextDiv.innerText = process(template.template);
            generatedSubjectWrapper.classList.toggle('hidden', !template.subject);
            generatedTextContainer.style.maxHeight = '500px';
        }
        
        // --- BATCH CSV GENERATION ---
        function handleBatchGenerate() {
            const templateIndex = batchTemplateSelect.value;
            const file = csvFileInput.files[0];
            if (templateIndex === "-1" || !file) return alert("Please select a template and a CSV file.");
            
            const template = allTemplates[templateIndex];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r\n?|\n/).filter(Boolean);
                if (lines.length < 2) return alert("CSV must have a header and at least one data row.");
                
                const headers = lines[0].split(',').map(h => h.trim());
                const dataRows = lines.slice(1).map(line => line.split(',').reduce((obj, val, i) => {
                    obj[headers[i]] = val.trim();
                    return obj;
                }, {}));
                
                displayBatchResults(dataRows, template);
            };
            reader.readAsText(file);
        }
        
        function displayBatchResults(dataRows, template) {
            batchOutput.innerHTML = '';
            const process = (str, data) => str ? Object.entries(data).reduce((acc, [key, val]) => acc.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), val), str) : "";

            dataRows.forEach((row, i) => {
                const subject = process(template.subject, row);
                const body = process(template.template, row);
                const entryDiv = document.createElement('div');
                entryDiv.className = "p-4 border rounded-lg";
                entryDiv.innerHTML = `
                    <h4 class="font-semibold text-lg text-gray-800 mb-2">Entry ${i + 1} (For: ${row.Name || 'N/A'})</h4>
                    ${subject ? `<div class="mb-2">
                        <label class="block text-sm font-medium text-gray-600">Subject</label>
                        <input type="text" value="${subject}" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                    </div>` : ''}
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Body</label>
                        <div class="generated-html-body">${body}</div>
                    </div>`;
                batchOutput.appendChild(entryDiv);
            });
            batchOutputContainer.classList.remove('hidden');
        }

        // --- CLIPBOARD & HELPERS ---
        function copyToClipboard(element, button, originalText, isDiv = false) {
            const content = isDiv ? element.innerText : element.value;
            if (!content) return;
            navigator.clipboard.writeText(content).then(() => showCopyFeedback(button, originalText));
        }
        
        function showCopyFeedback(button, originalText) {
            button.textContent = 'Copied!';
            button.classList.add('bg-green-500', 'text-white');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-500', 'text-white');
            }, 2000);
        }
        
        // --- TEMPLATE MANAGEMENT (CRUD) ---
        function showSaveStatus(message) {
             saveStatus.textContent = message;
             setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        }
        
        function addFieldInputRow(value = '') {
            const fieldRow = document.createElement('div');
            fieldRow.className = "flex items-center gap-2";
            fieldRow.innerHTML = `
                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Placeholder name (e.g., Student_Name)" value="${value}">
                <button type="button" class="text-sm text-red-600 hover:underline flex-shrink-0 remove-field-btn">Remove</button>
            `;
            fieldRow.querySelector('input').addEventListener('input', updateInteractivePlaceholders);
            fieldRow.querySelector('.remove-field-btn').addEventListener('click', () => {
                fieldRow.remove();
                updateInteractivePlaceholders();
            });
            dynamicFieldsContainer.appendChild(fieldRow);
            updateInteractivePlaceholders();
        }

        function updateInteractivePlaceholders() {
            interactivePlaceholdersContainer.innerHTML = '';
            const fields = Array.from(dynamicFieldsContainer.querySelectorAll('input')).map(input => input.value.trim().replace(/\s+/g, '_')).filter(Boolean);
            if (fields.length > 0) {
                fields.forEach(name => {
                    const tag = document.createElement('div');
                    tag.textContent = name;
                    tag.className = "placeholder-tag bg-blue-100 text-blue-800 text-sm font-semibold px-2.5 py-1 rounded-full";
                    tag.draggable = true;
                    const placeholder = `{{${name}}}`;
                    tag.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', placeholder));
                    tag.addEventListener('dblclick', () => insertPlaceholder(placeholder));
                    interactivePlaceholdersContainer.appendChild(tag);
                });
                interactivePlaceholdersWrapper.classList.remove('hidden');
            } else {
                interactivePlaceholdersWrapper.classList.add('hidden');
            }
        }
        
        function insertPlaceholder(textToInsert) {
            const textarea = templateBodyTextarea;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + textToInsert + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length;
            textarea.focus();
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const textToInsert = e.dataTransfer.getData('text/plain');
            if (textToInsert.startsWith('{{') && textToInsert.endsWith('}}')) {
                 insertPlaceholder(textToInsert);
            }
        }

        function handleSaveTemplate(event) {
            event.preventDefault();
            const name = templateNameInput.value.trim();
            const template = templateBodyTextarea.value;
            if (!name || !template) return alert("Template Name and Body cannot be empty.");
            
            const editIndex = templateEditIndexInput.value;
            const fields = Array.from(dynamicFieldsContainer.querySelectorAll('input')).map(input => input.value.trim().replace(/\s+/g, '_')).filter(Boolean);
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const now = new Date().toISOString();

            const newTemplateData = {
                name,
                category: templateCategoryInput.value.trim(),
                subject: templateSubjectInput.value.trim(),
                description: templateDescriptionInput.value.trim(),
                target: templateTargetInput.value.trim(),
                purpose: templatePurposeInput.value.trim(),
                fields,
                template
            };

            if (editIndex !== "") {
                const original = userTemplates[parseInt(editIndex, 10)];
                userTemplates[parseInt(editIndex, 10)] = { ...original, ...newTemplateData, updatedAt: now };
                showSaveStatus("Template updated successfully!");
            } else {
                userTemplates.push({ ...newTemplateData, createdAt: now, updatedAt: now, isDefault: false });
                showSaveStatus("Template saved successfully!");
            }
            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            setSyncState('unsynced');
            cancelEdit(); 
            loadTemplates();
        }

        function editTemplate(userTemplateIndex) {
            const template = JSON.parse(localStorage.getItem('userTemplates') || '[]')[userTemplateIndex];
            formTitle.textContent = "Edit Template";
            templateNameInput.value = template.name;
            templateCategoryInput.value = template.category || '';
            templateSubjectInput.value = template.subject || '';
            templateDescriptionInput.value = template.description || '';
            templateTargetInput.value = template.target || '';
            templatePurposeInput.value = template.purpose || '';
            templateBodyTextarea.value = template.template;
            templateEditIndexInput.value = userTemplateIndex;
            dynamicFieldsContainer.innerHTML = '';
            template.fields.forEach(field => addFieldInputRow(field));
            cancelEditButton.classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('template-manager').offsetTop, behavior: 'smooth' });
        }

        function cancelEdit() {
            formTitle.textContent = "Create New Template";
            templateForm.reset();
            templateBodyTextarea.value = '';
            dynamicFieldsContainer.innerHTML = '';
            templateEditIndexInput.value = "";
            cancelEditButton.classList.add('hidden');
            updateInteractivePlaceholders();
        }

        function deleteTemplate(userTemplateIndex) {
            if (!confirm("Are you sure?")) return;
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            userTemplates.splice(userTemplateIndex, 1);
            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            setSyncState('unsynced');
            loadTemplates();
        }
        
        function renderTemplateManager() {
            userTemplatesList.innerHTML = '';
            const userTemplates = allTemplates.filter(t => !t.isDefault);
            if (userTemplates.length === 0) {
                userTemplatesList.innerHTML = '<p class="text-gray-500">You haven\'t created any templates yet.</p>';
                return;
            }
            userTemplates.forEach((template, index) => {
                const item = document.createElement('div');
                item.className = "template-list-item block p-4 border rounded-lg";
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-lg text-gray-800">${template.name}</h4>
                            ${template.category ? `<span class="text-xs font-medium bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${template.category}</span>` : ''}
                        </div>
                        <div class="space-x-3 flex-shrink-0 ml-4">
                            <button class="text-sm text-blue-600 hover:underline edit-btn" data-index="${index}">Edit</button>
                            <button class="text-sm text-red-600 hover:underline delete-btn" data-index="${index}">Delete</button>
                        </div>
                    </div>
                    <div class="mt-2 space-y-2 text-sm">
                        ${template.description ? `<p class="text-gray-600"><span class="font-medium text-gray-700">Description:</span> ${template.description}</p>` : ''}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                            ${template.target ? `<p class="text-gray-600"><span class="font-medium text-gray-700">Target:</span> ${template.target}</p>` : ''}
                            ${template.purpose ? `<p class="text-gray-600"><span class="font-medium text-gray-700">Purpose:</span> ${template.purpose}</p>` : ''}
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 border-t pt-2 mt-2">
                            <p class="text-gray-500"><span class="font-medium">Created:</span> ${new Date(template.createdAt).toLocaleString()}</p>
                            <p class="text-gray-500"><span class="font-medium">Updated:</span> ${new Date(template.updatedAt).toLocaleString()}</p>
                        </div>
                    </div>`;
                userTemplatesList.appendChild(item);
            });
            userTemplatesList.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => editTemplate(e.target.dataset.index)));
            userTemplatesList.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTemplate(e.target.dataset.index)));
        }

        // --- IMPORT/EXPORT/SETTINGS ---
        function exportTemplates() {
            const data = localStorage.getItem('userTemplates') || '[]';
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `text_merge_templates_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data) || !data.every(t => t.name && t.template)) throw new Error("Invalid template file.");
                    const merge = confirm("Merge with existing templates? (Cancel to replace)");
                    const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : [];
                    localStorage.setItem('userTemplates', JSON.stringify([...existing, ...data]));
                    setSyncState('unsynced');
                    alert(`Imported ${data.length} templates.`);
                    loadTemplates();
                } catch (error) { alert(`Import failed: ${error.message}`); }
            };
            reader.readAsText(file);
            importFileInput.value = '';
        }
        
        // --- FIREBASE SYNC ---
        function handleFirebaseSignIn() {
            const email = firebaseEmailInput.value;
            const password = firebasePasswordInput.value;
            if (!email || !password) return alert("Please enter email and password.");
            signInWithEmailAndPassword(firebaseAuth, email, password)
                .catch(error => alert(`Sign in failed: ${error.message}`));
        }
        
        function handleFirebaseSignUp() {
            const email = firebaseEmailInput.value;
            const password = firebasePasswordInput.value;
            if (!email || !password) return alert("Please enter email and password.");
            createUserWithEmailAndPassword(firebaseAuth, email, password)
                .catch(error => alert(`Sign up failed: ${error.message}`));
        }
        
        function handleFirebaseSignOut() {
            signOut(firebaseAuth);
        }

        function updateFirebaseAuthStatus(isSignedIn) {
            firebaseAuthContainer.classList.toggle('hidden', isSignedIn);
            firebaseSyncControls.classList.toggle('hidden', !isSignedIn);
            if (isSignedIn) {
                firebaseAuthStatus.textContent = `Signed in as ${currentUser.email}`;
            }
        }

        async function saveToFirebase() {
            if (!currentUser) return alert("You must be signed in to save to Firebase.");
            firebaseStatus.textContent = "Saving...";
            const userTemplates = localStorage.getItem('userTemplates') || '[]';
            const userDocRef = doc(firestoreDb, "userTemplates", currentUser.uid);
            try {
                await setDoc(userDocRef, { templates: JSON.parse(userTemplates), updatedAt: new Date() });
                firebaseStatus.textContent = `Saved to Firebase at ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                firebaseStatus.textContent = "Error saving to Firebase.";
                console.error("Firebase save error:", error);
            }
        }

        async function loadFromFirebase() {
            if (!currentUser) return alert("You must be signed in to load from Firebase.");
            firebaseStatus.textContent = "Loading...";
            const userDocRef = doc(firestoreDb, "userTemplates", currentUser.uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const templates = data.templates || [];
                    const merge = confirm("Merge with local templates? (Cancel to replace)");
                    const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : [];
                    localStorage.setItem('userTemplates', JSON.stringify([...existing, ...templates]));
                    loadTemplates();
                    firebaseStatus.textContent = `Loaded ${templates.length} templates.`;
                } else {
                    firebaseStatus.textContent = "No templates found in Firebase for your account.";
                }
            } catch (error) {
                firebaseStatus.textContent = "Error loading from Firebase.";
                console.error("Firebase load error:", error);
            }
        }
        
        function setSyncState(newState) {
            syncState = newState;
        }

    </script>
</body>
</html>