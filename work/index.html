<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Template Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&family=Lora&family=Merriweather&family=Playfair+Display&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicons/pen-to-square.svg" type="image/svg+xml">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-card {
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        #generated-text-container.transition-height {
            transition: max-height 1s ease-in-out;
        }
        .template-list-item {
            transition: background-color 0.2s ease-in-out;
        }
        .template-list-item:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        .placeholder-tag {
            cursor: grab;
            user-select: none;
        }
        .generated-html-body {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem;
            min-height: 10rem;
            background-color: #f9fafb;
            white-space: pre-wrap;
        }
        summary {
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Email Template Generator</h1>
            <p class="text-gray-600 mt-2">Create, manage, and use your own email templates with advanced features.</p>
        </header>
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <div id="sync-status-indicator" class="text-sm font-medium px-3 py-1 rounded-full hidden flex items-center gap-2"></div>
                <span id="version-display" class="text-sm font-semibold text-gray-500"></span>
            </div>
            <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
        </div>

        <div class="mb-8 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="use-templates">
                    Use Templates
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="batch-generate">
                    Batch Generate
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="manage-templates">
                    Manage Templates
                </button>
                 <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2" data-tab="sync-settings">
                    Sync & Settings
                </button>
            </nav>
        </div>

        <div id="tab-content-use-templates">
            <div class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 1: Choose a Template</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="folder-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Folder</label>
                            <select id="folder-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="template-select" class="block text-sm font-medium text-gray-700 mb-1">Select an email template</label>
                            <select id="template-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                     <div id="version-select-container" class="hidden mt-4">
                        <label for="version-select" class="block text-sm font-medium text-gray-700 mb-1">Select a version</label>
                        <select id="version-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 2: Fill in the Details</h2>
                    <div id="fields-container" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <p class="text-gray-500 col-span-full">Please select a template first.</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 3: Generate & Copy Email</h2>
                    <div class="text-center">
                         <button id="generate-button" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Generate Email
                        </button>
                    </div>
                    
                    <div id="generated-text-container" class="mt-6 max-h-0 overflow-hidden transition-height space-y-4">
                        <div id="generated-subject-wrapper" class="hidden">
                            <div class="flex justify-between items-center mb-2">
                                <label for="generated-subject" class="block text-sm font-medium text-gray-700">Generated Subject:</label>
                                <button type="button" id="copy-subject-button" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                    Copy Subject
                                </button>
                            </div>
                            <input type="text" id="generated-subject" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Generated Body:</label>
                                <button id="copy-body-button" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                    Copy Body
                                </button>
                            </div>
                            <div id="generated-text" class="generated-html-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-content-batch-generate" class="hidden">
             <div class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md step-card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Batch Generate from CSV</h2>
                    <p class="text-gray-600 mb-4">Upload a CSV file where the column headers match the placeholders of your chosen template (e.g., a column named 'Name' for the {{Name}} placeholder).</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="batch-template-select" class="block text-sm font-medium text-gray-700 mb-1">1. Select Template to Use</label>
                            <select id="batch-template-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="csv-file-input" class="block text-sm font-medium text-gray-700 mb-1">2. Upload CSV File</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="batch-generate-button" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out text-lg">
                            Generate All
                        </button>
                    </div>
                </div>
                 <div id="batch-output-container" class="hidden bg-white p-6 rounded-lg shadow-md step-card">
                     <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Generated Output</h2>
                     <div id="batch-output" class="space-y-6"></div>
                 </div>
            </div>
        </div>

        <div id="tab-content-manage-templates" class="hidden">
            <details class="bg-white p-6 rounded-lg shadow-md step-card mb-8">
                <summary class="text-2xl font-semibold cursor-pointer flex justify-between items-center">
                    Create New Template
                    <span class="text-lg font-normal text-gray-500 group-open:hidden">Click to expand</span>
                </summary>
                <div id="template-manager" class="mt-4 pt-4 border-t">
                    <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-800">Create New Template</h3>
                    <form id="template-form" class="space-y-4">
                        <input type="hidden" id="template-edit-id">
                        <input type="hidden" id="template-edit-version">
                        <input type="hidden" id="template-save-mode">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                <label for="template-name" class="block text-sm font-medium text-gray-700">Template Name</label>
                                <input type="text" id="template-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive Progress Review" required>
                            </div>
                            <div>
                                <label for="template-folder" class="block text-sm font-medium text-gray-700">Folder (Optional)</label>
                                <input type="text" id="template-folder" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive Feedback, Attendance" list="folder-suggestions">
                                <datalist id="folder-suggestions"></datalist>
                            </div>
                        </div>
                        <div>
                            <label for="template-subject" class="block text-sm font-medium text-gray-700">Template Subject (Optional)</label>
                            <input type="text" id="template-subject" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Update on {{Name}}'s Progress">
                        </div>
                         <div>
                            <label for="template-description" class="block text-sm font-medium text-gray-700">Description (for this version)</label>
                            <input type="text" id="template-description" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="A brief description of this template version">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="template-target" class="block text-sm font-medium text-gray-700">Target Audience</label>
                                <input type="text" id="template-target" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Parents, Students">
                            </div>
                            <div>
                                <label for="template-purpose" class="block text-sm font-medium text-gray-700">Purpose</label>
                                <input type="text" id="template-purpose" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive reinforcement">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Define Template Placeholders
                                <span class="text-gray-500 text-xs" title="These are the dynamic parts of your email. e.g., Student Name, Date (DD-MM-YYYY)"> (Hover for help)</span>
                            </label>
                            <div id="dynamic-fields-container" class="space-y-2 mt-1"></div>
                            <button type="button" id="add-field-button" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors py-1 px-2 rounded-md bg-blue-100 hover:bg-blue-200">
                                + Add Placeholder
                            </button>
                        </div>
                        <div id="interactive-placeholders-wrapper" class="hidden">
                             <label class="block text-sm font-medium text-gray-700">Available Placeholders</label>
                             <div id="interactive-placeholders-container" class="mt-1 p-2 bg-gray-200 rounded-md flex flex-wrap gap-2"></div>
                             <p class="text-xs text-gray-500 mt-1">Drag & drop or double-click a placeholder to insert it into the editor.</p>
                        </div>
                        <div>
                            <label for="template-body" class="block text-sm font-medium text-gray-700">Template Text
                                <span class="text-gray-500 text-xs" title="Use your placeholders in the text like this: {{Placeholder Name}}. You can use () and [] inside the placeholders, e.g., ({{Student Name}})."> (Hover for help)</span>
                            </label>
                            <textarea id="template-body" rows="8" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Write your template text here..."></textarea>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="submit" id="save-template-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save Template</button>
                            <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 hidden">Cancel Edit</button>
                        </div>
                    </form>
                     <p id="save-status" class="text-sm mt-3 text-green-600"></p>
                </div>
            </details>

            <details class="bg-white p-6 rounded-lg shadow-md step-card" open>
                <summary class="text-2xl font-semibold cursor-pointer flex justify-between items-center">
                    Your Saved Templates
                    <span class="text-lg font-normal text-gray-500 group-open:hidden">Click to expand</span>
                </summary>
                <div class="mt-4 pt-4 border-t">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                         <h3 class="text-xl font-semibold text-gray-800">Your Saved Templates</h3>
                         <div class="flex items-center gap-2">
                            <label for="show-archived-toggle" class="text-sm font-medium text-gray-700">Show Archived</label>
                            <input type="checkbox" id="show-archived-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                         </div>
                         <div class="flex items-center gap-2">
                            <button id="import-button" class="text-sm font-semibold text-gray-700 hover:text-gray-900 transition-colors py-1 px-3 rounded-md bg-gray-200 hover:bg-gray-300">Import from File</button>
                            <button id="export-button" class="text-sm font-semibold text-white hover:text-white transition-colors py-1 px-3 rounded-md bg-blue-600 hover:bg-blue-700">Export to File</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                         </div>
                    </div>
                    <div id="user-templates-list" class="space-y-4">
                        <p class="text-gray-500">You haven't created any templates yet.</p>
                    </div>
                </div>
            </details>
        </div>
        
        <div id="tab-content-sync-settings" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md step-card mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Sync with Firebase</h2>
                <div id="firebase-auth-container">
                    <p class="text-gray-600 mb-4">Sign in to sync your templates across devices.</p>
                    <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                        <div class="flex-grow">
                            <label for="firebase-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="firebase-email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="your@email.com">
                        </div>
                        <div class="flex-grow">
                            <label for="firebase-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="firebase-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                        </div>
                        <div class="flex gap-2">
                            <button id="firebase-signin-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Sign In</button>
                            <button id="firebase-signup-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Sign Up</button>
                        </div>
                    </div>
                </div>
                <div id="firebase-sync-controls" class="hidden mt-6 space-y-4">
                    <p id="firebase-auth-status" class="text-sm text-green-600"></p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="firebase-save-button" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Save to Firebase</button>
                        <button id="firebase-load-button" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Load from Firebase</button>
                    </div>
                    <button id="firebase-signout-button" class="text-sm text-red-600 hover:underline">Sign Out</button>
                </div>
                <p id="firebase-status" class="text-sm mt-4 text-gray-600"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { changelogData } from '/changelog-data.js';
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3",
        };

        const defaultTemplates = [
             {
                id: "default-positive-review",
                name: "Positive Progress Review",
                folder: "Education",
                isArchived: false,
                isDefault: true,
                versions: [{
                    version: 1,
                    createdAt: new Date('2023-01-01T10:00:00Z').toISOString(),
                    subject: "An update on {{Name}}'s progress in {{Subject}}",
                    description: "A standard positive review for a student making good progress.",
                    target: "Parents/Guardians",
                    purpose: "To inform and praise.",
                    fields: ["Name", "Pronoun_HeShe", "Pronoun_hisher", "Subject", "Tutor"],
                    template: "This is a review of {{Name}}'s progress in {{Subject}}.\n\nI am pleased to report that {{Name}} is making excellent progress. {{Pronoun_HeShe}} consistently demonstrates a strong understanding of the core concepts and actively participates in class discussions.\n\n{{Pronoun_hisher}} work is always completed to a high standard, and {{Pronoun_HeShe}} shows great enthusiasm for the subject. It is a pleasure to have {{Name}} in my class.\n\nRegards,\n{{Tutor}}"
                }]
            },
            {
                id: "default-needs-improvement",
                name: "Needs Improvement Review",
                folder: "Education",
                isArchived: false,
                isDefault: true,
                versions: [{
                    version: 1,
                    createdAt: new Date('2023-01-01T10:00:00Z').toISOString(),
                    subject: "Update regarding {{Name}} in {{Subject}}",
                    description: "Highlights an area of concern and suggests next steps.",
                    target: "Parents/Guardians",
                    purpose: "To inform and seek support.",
                    fields: ["Name", "Pronoun_HeShe", "Pronoun_hisher", "Subject", "Year_Group", "Tutor", "Specific_Area"],
                    template: "This is an update regarding {{Name}} in Year {{Year_Group}} {{Subject}}.\n\nWhile {{Name}} has a foundational understanding of the subject, there are areas that require more focus. Specifically, {{Pronoun_HeShe}} is finding {{Specific_Area}} challenging and would benefit from additional practice.\n\nI encourage {{Name}} to ask more questions in class and attend support sessions to improve {{Pronoun_hisher}} confidence and skills in this area. We will continue to provide support in school.\n\nRegards,\n{{Tutor}}"
                }]
            }
        ];
        
        let allTemplates = [];
        let currentTemplateVersion = null; // Holds the currently selected version object
        let syncState = 'unknown'; // States: unknown, synced, unsynced, syncing, error
        let firebaseApp, firebaseAuth, firestoreDb;
        let currentUser = null;
        let templatesUnsubscribe = null;
        let showArchived = false;

        const ui = {
            tabs: {
                buttons: document.querySelectorAll('.tab-button'),
                contents: {
                    'use-templates': document.getElementById('tab-content-use-templates'),
                    'batch-generate': document.getElementById('tab-content-batch-generate'),
                    'manage-templates': document.getElementById('tab-content-manage-templates'),
                    'sync-settings': document.getElementById('tab-content-sync-settings')
                }
            },
            use: {
                templateSelect: document.getElementById('template-select'),
                folderFilter: document.getElementById('folder-filter'),
                versionSelectContainer: document.getElementById('version-select-container'),
                versionSelect: document.getElementById('version-select'),
                fieldsContainer: document.getElementById('fields-container'),
                generateButton: document.getElementById('generate-button'),
                generatedTextContainer: document.getElementById('generated-text-container'),
                generatedSubjectWrapper: document.getElementById('generated-subject-wrapper'),
                generatedSubjectInput: document.getElementById('generated-subject'),
                generatedTextDiv: document.getElementById('generated-text'),
                copySubjectButton: document.getElementById('copy-subject-button'),
                copyBodyButton: document.getElementById('copy-body-button')
            },
            manage: {
                form: document.getElementById('template-form'),
                formTitle: document.getElementById('form-title'),
                nameInput: document.getElementById('template-name'),
                folderInput: document.getElementById('template-folder'),
                folderSuggestions: document.getElementById('folder-suggestions'),
                subjectInput: document.getElementById('template-subject'),
                descriptionInput: document.getElementById('template-description'),
                targetInput: document.getElementById('template-target'),
                purposeInput: document.getElementById('template-purpose'),
                fieldsContainer: document.getElementById('dynamic-fields-container'),
                addFieldButton: document.getElementById('add-field-button'),
                placeholdersWrapper: document.getElementById('interactive-placeholders-wrapper'),
                placeholdersContainer: document.getElementById('interactive-placeholders-container'),
                bodyTextarea: document.getElementById('template-body'),
                editIdInput: document.getElementById('template-edit-id'),
                editVersionInput: document.getElementById('template-edit-version'),
                saveModeInput: document.getElementById('template-save-mode'),
                userTemplatesList: document.getElementById('user-templates-list'),
                cancelEditButton: document.getElementById('cancel-edit-button'),
                saveStatus: document.getElementById('save-status'),
                exportButton: document.getElementById('export-button'),
                importButton: document.getElementById('import-button'),
                importFileInput: document.getElementById('import-file-input'),
                showArchivedToggle: document.getElementById('show-archived-toggle')
            },
            batch: {
                templateSelect: document.getElementById('batch-template-select'),
                csvFileInput: document.getElementById('csv-file-input'),
                generateButton: document.getElementById('batch-generate-button'),
                outputContainer: document.getElementById('batch-output-container'),
                output: document.getElementById('batch-output')
            },
            sync: {
                indicator: document.getElementById('sync-status-indicator'),
                authContainer: document.getElementById('firebase-auth-container'),
                controls: document.getElementById('firebase-sync-controls'),
                emailInput: document.getElementById('firebase-email'),
                passwordInput: document.getElementById('firebase-password'),
                signinButton: document.getElementById('firebase-signin-button'),
                signupButton: document.getElementById('firebase-signup-button'),
                signoutButton: document.getElementById('firebase-signout-button'),
                authStatus: document.getElementById('firebase-auth-status'),
                saveButton: document.getElementById('firebase-save-button'),
                loadButton: document.getElementById('firebase-load-button'),
                status: document.getElementById('firebase-status')
            },
            versionDisplay: document.getElementById('version-display')
        };
        
        window.onload = function() {
            loadTemplates();
            setupTabs();
            
            ui.use.folderFilter.addEventListener('change', () => populateTemplateSelector());
            ui.use.templateSelect.addEventListener('change', handleTemplateChange);
            ui.use.versionSelect.addEventListener('change', loadSelectedVersion);
            ui.use.generateButton.addEventListener('click', generateText);
            ui.use.copyBodyButton.addEventListener('click', () => copyToClipboard(ui.use.generatedTextDiv, ui.use.copyBodyButton, "Copy Body", true));
            ui.use.copySubjectButton.addEventListener('click', () => copyToClipboard(ui.use.generatedSubjectInput, ui.use.copySubjectButton, "Copy Subject"));
            ui.manage.form.addEventListener('submit', handleSaveTemplate);
            ui.manage.cancelEditButton.addEventListener('click', cancelEdit);
            ui.manage.addFieldButton.addEventListener('click', () => addFieldInputRow());
            ui.manage.exportButton.addEventListener('click', exportTemplates);
            ui.manage.importButton.addEventListener('click', () => ui.manage.importFileInput.click());
            ui.manage.importFileInput.addEventListener('change', handleImportFile);
            ui.manage.showArchivedToggle.addEventListener('change', (e) => {
                showArchived = e.target.checked;
                renderTemplateManager();
            });
            ui.batch.generateButton.addEventListener('click', handleBatchGenerate);
            
            ui.sync.signinButton.addEventListener('click', handleFirebaseSignIn);
            ui.sync.signupButton.addEventListener('click', handleFirebaseSignUp);
            ui.sync.signoutButton.addEventListener('click', handleFirebaseSignOut);
            ui.sync.saveButton.addEventListener('click', saveToFirebase);
            ui.sync.loadButton.addEventListener('click', loadFromFirebase);

            ui.manage.bodyTextarea.addEventListener('dragover', e => e.preventDefault());
            ui.manage.bodyTextarea.addEventListener('drop', handleDrop);

            initializeFirebase();
            if (ui.versionDisplay) {
                ui.versionDisplay.textContent = changelogData[0].version;
            }
        };

        function sanitizeForId(text) {
            if (typeof text !== 'string') return '';
            // Replaces any character that is not a letter, number, hyphen, or underscore with an underscore.
            return text.replace(/[^a-zA-Z0-9\-_]/g, '_');
        }
        
        function setupTabs() {
            ui.tabs.buttons.forEach(button => {
                button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
            });
            switchTab('use-templates');
        }

        function switchTab(activeTab) {
            ui.tabs.buttons.forEach(button => button.classList.toggle('active', button.dataset.tab === activeTab));
            Object.values(ui.tabs.contents).forEach(content => content.classList.add('hidden'));
            ui.tabs.contents[activeTab].classList.remove('hidden');
        }
        
        function migrateTemplates(templates) {
            if (!Array.isArray(templates)) return [];
            return templates.map(t => {
                if (t.versions) return t;
                const { name, folder, subject, description, target, purpose, fields, template, createdAt, updatedAt, isDefault, isArchived } = t;
                return {
                    id: crypto.randomUUID(), name: name || "Untitled Template", folder: folder || "", isArchived: isArchived || false, isDefault: isDefault || false, createdAt: createdAt || new Date().toISOString(), updatedAt: updatedAt || new Date().toISOString(),
                    versions: [{ version: 1, createdAt: createdAt || new Date().toISOString(), subject, description, target, purpose, fields, template }]
                };
            });
        }
        
        function loadTemplates() {
            let userTemplates = [];
            try { 
                const rawData = localStorage.getItem('userTemplates') || '[]';
                userTemplates = migrateTemplates(JSON.parse(rawData));
                localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            } catch (e) { console.error("Error parsing or migrating user templates:", e); }
            
            allTemplates = [...defaultTemplates, ...userTemplates];
            populateFolderFilter();
            populateTemplateSelector();
            populateBatchTemplateSelector();
            renderTemplateManager();
            handleTemplateChange(); 
        }

        function populateFolderFilter() {
            const folders = [...new Set(allTemplates.map(t => t.folder || 'Uncategorized').filter(Boolean))];
            const selectedValue = ui.use.folderFilter.value;
            ui.use.folderFilter.innerHTML = '<option value="">All Folders</option>';
            folders.sort().forEach(folder => {
                const option = document.createElement('option');
                option.value = folder; option.textContent = folder;
                ui.use.folderFilter.appendChild(option);
            });
            ui.use.folderFilter.value = selectedValue;
        }
        
        function populateTemplateSelector() {
            const selectedValue = ui.use.templateSelect.value;
            ui.use.templateSelect.innerHTML = '<option value="">Select a template...</option>';
            const selectedFolder = ui.use.folderFilter.value;
            const filtered = allTemplates.filter(t => !t.isArchived && (!selectedFolder || (t.folder || 'Uncategorized') === selectedFolder));
            
            filtered.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                ui.use.templateSelect.appendChild(option);
            });
            ui.use.templateSelect.value = selectedValue || "";
        }
        
        function populateBatchTemplateSelector() {
            ui.batch.templateSelect.innerHTML = '<option value="">Select a template...</option>';
            allTemplates.filter(t => !t.isArchived).forEach((template) => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                ui.batch.templateSelect.appendChild(option);
            });
        }
        
        function handleTemplateChange() {
            const selectedId = ui.use.templateSelect.value;
            ui.use.versionSelectContainer.classList.add('hidden');
            ui.use.fieldsContainer.innerHTML = '<p class="text-gray-500 col-span-full">Please select a template first.</p>';
            ui.use.generateButton.disabled = true;
            currentTemplateVersion = null;

            if (!selectedId) return;

            const templateFamily = allTemplates.find(t => t.id === selectedId);
            if (!templateFamily || !templateFamily.versions || templateFamily.versions.length === 0) return;

            ui.use.versionSelect.innerHTML = '';
            [...templateFamily.versions].sort((a, b) => b.version - a.version).forEach((v, index) => {
                const option = document.createElement('option');
                option.value = v.version;
                const date = new Date(v.createdAt).toLocaleString();
                option.textContent = `Version ${v.version}${index === 0 ? ' (Latest)' : ''} - Created on ${date}`;
                ui.use.versionSelect.appendChild(option);
            });

            ui.use.versionSelectContainer.classList.remove('hidden');
            loadSelectedVersion();
        }

        function loadSelectedVersion() {
            const selectedId = ui.use.templateSelect.value;
            const selectedVersionNum = parseInt(ui.use.versionSelect.value, 10);
            if (!selectedId || isNaN(selectedVersionNum)) return;

            const templateFamily = allTemplates.find(t => t.id === selectedId);
            const version = templateFamily?.versions.find(v => v.version === selectedVersionNum);

            if (!version) return;

            currentTemplateVersion = version;
            ui.use.fieldsContainer.innerHTML = '';
            
            if (!version.fields || version.fields.length === 0) {
                ui.use.fieldsContainer.innerHTML = '<p class="text-gray-500 col-span-full">This template version has no placeholders.</p>';
            } else {
                version.fields.forEach(fieldName => {
                    if (!fieldName) return;
                    const sanitizedId = `field-${sanitizeForId(fieldName)}`;
                    const fieldWrapper = document.createElement('div');
                    const label = document.createElement('label');
                    label.setAttribute('for', sanitizedId);
                    label.className = "block text-sm font-medium text-gray-700 mb-1";
                    label.textContent = fieldName;
                    const input = document.createElement('input');
                    input.type = 'text'; input.id = sanitizedId;
                    input.className = "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dynamic-field";
                    input.setAttribute('data-original-name', fieldName);
                    input.placeholder = `Enter ${fieldName}...`;
                    fieldWrapper.appendChild(label); fieldWrapper.appendChild(input);
                    ui.use.fieldsContainer.appendChild(fieldWrapper);
                });
            }
            ui.use.generateButton.disabled = false;
        }
        
        function generateText() {
            if (!currentTemplateVersion) return;
            const fieldData = {};
            document.querySelectorAll('#fields-container .dynamic-field').forEach(input => {
                const originalName = input.getAttribute('data-original-name');
                if (originalName) {
                    fieldData[originalName] = input.value;
                }
            });
            const process = (text) => {
                if (!text) return "";
                return text.replace(/\{\{(.+?)\}\}/g, (match, placeholderName) => {
                    if (Object.prototype.hasOwnProperty.call(fieldData, placeholderName)) {
                        return fieldData[placeholderName];
                    }
                    return match;
                });
            };
            ui.use.generatedSubjectInput.value = process(currentTemplateVersion.subject);
            ui.use.generatedTextDiv.innerText = process(currentTemplateVersion.template);
            ui.use.generatedSubjectWrapper.classList.toggle('hidden', !currentTemplateVersion.subject);
            ui.use.generatedTextContainer.style.maxHeight = '500px';
        }
        
        function copyToClipboard(element, button, originalText, isDiv = false) {
            const content = isDiv ? element.innerText : element.value;
            if (!content) return;
            navigator.clipboard.writeText(content).then(() => showCopyFeedback(button, originalText));
        }
        
        function showCopyFeedback(button, originalText) {
            button.textContent = 'Copied!';
            button.classList.add('bg-green-500', 'text-white');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-500', 'text-white');
            }, 2000);
        }
        
        function handleBatchGenerate() {
            const templateId = ui.batch.templateSelect.value;
            const file = ui.batch.csvFileInput.files[0];
            if (!templateId || !file) return alert("Please select a template and a CSV file.");
            
            const templateFamily = allTemplates.find(t => t.id === templateId);
            if (!templateFamily) return;
            
            const latestVersion = [...templateFamily.versions].sort((a,b) => b.version - a.version)[0];

            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r\n?|\n/).filter(Boolean);
                if (lines.length < 2) return alert("CSV must have a header and at least one data row.");
                const headers = lines[0].split(',').map(h => h.trim());
                const dataRows = lines.slice(1).map(line => line.split(',').reduce((obj, val, i) => {
                    obj[headers[i]] = val.trim();
                    return obj;
                }, {}));
                displayBatchResults(dataRows, latestVersion);
            };
            reader.readAsText(file);
        }
        
        function displayBatchResults(dataRows, version) {
            ui.batch.output.innerHTML = '';
            const process = (text, data) => {
                if (!text || typeof text !== 'string' || !data || typeof data !== 'object') return "";
                return text.replace(/\{\{(.+?)\}\}/g, (match, placeholderName) => {
                    if (Object.prototype.hasOwnProperty.call(data, placeholderName)) {
                        return data[placeholderName];
                    }
                    return match;
                });
            };
            dataRows.forEach((row, i) => {
                const subject = process(version.subject, row);
                const body = process(version.template, row);
                const entryDiv = document.createElement('div');
                entryDiv.className = "p-4 border rounded-lg";
                entryDiv.innerHTML = `<h4 class="font-semibold text-lg text-gray-800 mb-2">Entry ${i + 1} (For: ${row.Name || 'N/A'})</h4>
                    ${subject ? `<div class="mb-2"><label class="block text-sm font-medium text-gray-600">Subject</label><input type="text" value="${subject}" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" readonly></div>` : ''}
                    <div><label class="block text-sm font-medium text-gray-600">Body</label><div class="generated-html-body">${body}</div></div>`;
                ui.batch.output.appendChild(entryDiv);
            });
            ui.batch.outputContainer.classList.remove('hidden');
        }

        function handleSaveTemplate(event) {
            event.preventDefault();
            const name = ui.manage.nameInput.value.trim();
            const templateText = ui.manage.bodyTextarea.value;
            if (!name || !templateText) return alert("Template Name and Body cannot be empty.");
            
            const editId = ui.manage.editIdInput.value;
            const editVersionNum = parseInt(ui.manage.editVersionInput.value, 10);
            const saveMode = ui.manage.saveModeInput.value;
            
            const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('input')).map(input => input.value.trim()).filter(Boolean);
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const now = new Date().toISOString();

            const versionData = {
                subject: ui.manage.subjectInput.value.trim(),
                description: ui.manage.descriptionInput.value.trim(),
                target: ui.manage.targetInput.value.trim(),
                purpose: ui.manage.purposeInput.value.trim(),
                fields,
                template: templateText,
            };

            if (!editId) { // Creating a brand new template
                const newTemplateFamily = {
                    id: crypto.randomUUID(), name, folder: ui.manage.folderInput.value.trim(), isArchived: false, isDefault: false, createdAt: now, updatedAt: now,
                    versions: [{ ...versionData, version: 1, createdAt: now }]
                };
                userTemplates.push(newTemplateFamily);
                showSaveStatus("New template saved successfully!");
            } else { // Modifying an existing template family
                const templateFamily = userTemplates.find(t => t.id === editId);
                if (!templateFamily) return;

                templateFamily.name = name;
                templateFamily.folder = ui.manage.folderInput.value.trim();
                templateFamily.updatedAt = now;

                if (saveMode === 'overwrite_version' && editVersionNum) {
                    if (!confirm(`Are you sure you want to permanently overwrite Version ${editVersionNum}? This action cannot be undone.`)) return;
                    const versionIndex = templateFamily.versions.findIndex(v => v.version === editVersionNum);
                    if (versionIndex > -1) {
                        const originalCreatedAt = templateFamily.versions[versionIndex].createdAt;
                        templateFamily.versions[versionIndex] = { ...versionData, version: editVersionNum, createdAt: originalCreatedAt };
                        showSaveStatus(`Version ${editVersionNum} has been overwritten.`);
                    }
                } else { // Default action is to create a new version
                    const latestVersion = Math.max(0, ...templateFamily.versions.map(v => v.version));
                    const newVersion = { ...versionData, version: latestVersion + 1, createdAt: now };
                    templateFamily.versions.push(newVersion);
                    showSaveStatus(`Saved as new Version ${newVersion.version}!`);
                }
            }

            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            setSyncState('unsynced');
            cancelEdit(); 
            loadTemplates();
        }

        function addFieldInputRow(value = '') {
            const fieldRow = document.createElement('div');
            fieldRow.className = "flex items-center gap-2";
            fieldRow.innerHTML = `<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Student Name" value="${value}">
                <button type="button" class="text-sm text-red-600 hover:underline flex-shrink-0 remove-field-btn">Remove</button>`;
            fieldRow.querySelector('input').addEventListener('input', updateInteractivePlaceholders);
            fieldRow.querySelector('.remove-field-btn').addEventListener('click', () => {
                fieldRow.remove();
                updateInteractivePlaceholders();
            });
            ui.manage.fieldsContainer.appendChild(fieldRow);
            updateInteractivePlaceholders();
        }
        
        function updateInteractivePlaceholders() {
            ui.manage.placeholdersContainer.innerHTML = '';
            const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('input')).map(input => input.value.trim()).filter(Boolean);
            if (fields.length > 0) {
                fields.forEach(name => {
                    const tag = document.createElement('div');
                    tag.textContent = name;
                    tag.className = "placeholder-tag bg-blue-100 text-blue-800 text-sm font-semibold px-2.5 py-1 rounded-full";
                    tag.draggable = true;
                    const placeholder = `{{${name}}}`;
                    tag.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', placeholder));
                    tag.addEventListener('dblclick', () => insertPlaceholder(placeholder));
                    ui.manage.placeholdersContainer.appendChild(tag);
                });
                ui.manage.placeholdersWrapper.classList.remove('hidden');
            } else {
                ui.manage.placeholdersWrapper.classList.add('hidden');
            }
        }

        function insertPlaceholder(textToInsert) {
            const textarea = ui.manage.bodyTextarea;
            const start = textarea.selectionStart; const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + textToInsert + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length;
            textarea.focus();
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const textToInsert = e.dataTransfer.getData('text/plain');
            if (/\{\{.+?\}\}/.test(textToInsert)) {
                 insertPlaceholder(textToInsert);
            }
        }
        
        function showSaveStatus(message) {
             ui.manage.saveStatus.textContent = message;
             setTimeout(() => { ui.manage.saveStatus.textContent = ''; }, 3000);
        }
        
        function loadTemplateIntoEditor(config) {
            const { family, version, title, saveMode } = config;
            ui.manage.formTitle.textContent = title;
            ui.manage.nameInput.value = family.name;
            ui.manage.folderInput.value = family.folder || '';
            ui.manage.subjectInput.value = version.subject || '';
            ui.manage.descriptionInput.value = version.description || '';
            ui.manage.targetInput.value = version.target || '';
            ui.manage.purposeInput.value = version.purpose || '';
            ui.manage.bodyTextarea.value = version.template || '';
            ui.manage.editIdInput.value = family.id || '';
            ui.manage.editVersionInput.value = version.version || '';
            ui.manage.saveModeInput.value = saveMode;
            ui.manage.fieldsContainer.innerHTML = '';
            (version.fields || []).forEach(field => addFieldInputRow(field));
            ui.manage.cancelEditButton.classList.remove('hidden');
            document.querySelector('#tab-content-manage-templates details').open = true;
            window.scrollTo({ top: document.getElementById('template-manager').offsetTop, behavior: 'smooth' });
        }

        function editVersionInPlace(templateId, versionNumber) {
            const family = allTemplates.find(t => t.id === templateId);
            const version = family?.versions.find(v => v.version == versionNumber);
            if (!family || !version) return;
            loadTemplateIntoEditor({
                family, version,
                title: `Editing Version ${version.version} of "${family.name}"`,
                saveMode: 'overwrite_version'
            });
        }

        function duplicateAsNewVersion(templateId, versionNumber) {
            const family = allTemplates.find(t => t.id === templateId);
            const version = family?.versions.find(v => v.version == versionNumber);
            if (!family || !version) return;
            loadTemplateIntoEditor({
                family, version,
                title: `Creating New Version from v${version.version} of "${family.name}"`,
                saveMode: 'new_version'
            });
        }
        
        function duplicateAsNewTemplate(templateId, versionNumber) {
            const family = allTemplates.find(t => t.id === templateId);
            const version = family?.versions.find(v => v.version == versionNumber);
            if (!family || !version) return;
            // Clear IDs to signal creation of a new template family
            const newFamily = { ...family, id: '', name: `Copy of ${family.name}` };
            const newVersion = { ...version, version: '' };
            loadTemplateIntoEditor({
                family: newFamily, version: newVersion,
                title: `Creating New Template from "${family.name}" v${version.version}`,
                saveMode: 'new_template' // This will be handled by the empty ID
            });
        }

        function addBlankVersion(templateId) {
            const family = allTemplates.find(t => t.id === templateId);
            if (!family) return;
            const blankVersion = { fields: [], template: '' };
            loadTemplateIntoEditor({
                family, version: blankVersion,
                title: `Adding Blank New Version to "${family.name}"`,
                saveMode: 'new_version'
            });
        }

        function cancelEdit() {
            ui.manage.formTitle.textContent = "Create New Template";
            ui.manage.form.reset();
            ui.manage.bodyTextarea.value = '';
            ui.manage.fieldsContainer.innerHTML = '';
            ui.manage.editIdInput.value = "";
            ui.manage.editVersionInput.value = "";
            ui.manage.saveModeInput.value = "";
            ui.manage.cancelEditButton.classList.add('hidden');
            updateInteractivePlaceholders();
        }

        function toggleArchiveTemplate(templateId) {
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const template = userTemplates.find(t => t.id === templateId);
            if (template) template.isArchived = !template.isArchived;
            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            setSyncState('unsynced');
            loadTemplates();
        }

        function deleteTemplate(templateId) {
            if (!confirm("Are you sure you want to permanently delete this template and all its versions?")) return;
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            userTemplates = userTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            setSyncState('unsynced');
            loadTemplates();
        }
        
        function useVersion(templateId, versionNumber) {
            switchTab('use-templates');
            ui.use.templateSelect.value = templateId;
            ui.use.templateSelect.dispatchEvent(new Event('change'));
            ui.use.versionSelect.value = versionNumber;
            ui.use.versionSelect.dispatchEvent(new Event('change'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function renderTemplateManager() {
            ui.manage.userTemplatesList.innerHTML = '';
            const userTemplates = allTemplates.filter(t => !t.isDefault);
            const visibleTemplates = userTemplates.filter(t => showArchived || !t.isArchived);

            if (visibleTemplates.length === 0) {
                ui.manage.userTemplatesList.innerHTML = `<p class="text-gray-500">${showArchived ? 'No archived templates.' : 'You haven\'t created any templates yet.'}</p>`;
                return;
            }

            visibleTemplates.forEach(template => {
                const latestVersion = [...template.versions].sort((a,b) => b.version - a.version)[0];
                const item = document.createElement('div');
                item.className = `template-list-item block p-4 border rounded-lg ${template.isArchived ? 'opacity-60 bg-gray-100' : ''}`;
                
                let versionsHtml = [...template.versions].sort((a,b) => b.version - a.version).map(v => `
                    <li class="p-3 border-t">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold">Version ${v.version} <span class="font-normal text-gray-500">- Created: ${new Date(v.createdAt).toLocaleString()}</span></p>
                                <p class="text-gray-600 italic mt-1 text-sm">"${v.description || 'No description'}"</p>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-200 space-x-4 text-sm">
                            <button class="font-semibold text-blue-600 hover:underline use-version-btn" data-id="${template.id}" data-version="${v.version}">Use</button>
                            <button class="font-semibold text-gray-700 hover:underline edit-version-btn" data-id="${template.id}" data-version="${v.version}">Edit</button>
                            <button class="font-semibold text-gray-700 hover:underline duplicate-new-version-btn" data-id="${template.id}" data-version="${v.version}">Duplicate as New Version</button>
                            <button class="font-semibold text-gray-700 hover:underline duplicate-new-template-btn" data-id="${template.id}" data-version="${v.version}">Duplicate as New Template</button>
                        </div>
                    </li>
                `).join('');

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-lg text-gray-800">${template.name}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs font-medium bg-gray-200 text-gray-800 px-2 py-0.5 rounded-full">Latest: v${latestVersion.version}</span>
                                ${template.folder ? `<span class="text-xs font-medium bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${template.folder}</span>` : ''}
                                ${template.isArchived ? `<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Archived</span>` : ''}
                            </div>
                        </div>
                        <div class="space-x-3 flex-shrink-0 ml-4">
                            <button class="text-sm text-green-600 hover:underline duplicate-template-btn" data-id="${template.id}">Duplicate Template</button>
                            <button class="text-sm text-yellow-600 hover:underline archive-btn" data-id="${template.id}">${template.isArchived ? 'Unarchive' : 'Archive'}</button>
                            <button class="text-sm text-red-600 hover:underline delete-btn" data-id="${template.id}">Delete</button>
                        </div>
                    </div>
                    <details class="mt-4">
                        <summary class="cursor-pointer text-sm font-semibold text-gray-600 hover:underline">View ${template.versions.length} Version(s)</summary>
                        <div class="p-2 border-t mt-2">
                             <button class="text-sm font-semibold text-green-700 hover:underline add-blank-version-btn" data-id="${template.id}">+ Add Blank New Version</button>
                        </div>
                        <ul class="bg-gray-50 rounded-md border">${versionsHtml}</ul>
                    </details>`;
                ui.manage.userTemplatesList.appendChild(item);
            });

            ui.manage.userTemplatesList.querySelectorAll('.archive-btn').forEach(btn => btn.addEventListener('click', (e) => toggleArchiveTemplate(e.target.dataset.id)));
            ui.manage.userTemplatesList.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTemplate(e.target.dataset.id)));
            ui.manage.userTemplatesList.querySelectorAll('.duplicate-template-btn').forEach(btn => btn.addEventListener('click', (e) => duplicateTemplate(e.target.dataset.id)));
            ui.manage.userTemplatesList.querySelectorAll('.use-version-btn').forEach(btn => btn.addEventListener('click', (e) => useVersion(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.edit-version-btn').forEach(btn => btn.addEventListener('click', (e) => editVersionInPlace(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.duplicate-new-version-btn').forEach(btn => btn.addEventListener('click', (e) => duplicateAsNewVersion(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.duplicate-new-template-btn').forEach(btn => btn.addEventListener('click', (e) => duplicateAsNewTemplate(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.add-blank-version-btn').forEach(btn => btn.addEventListener('click', (e) => addBlankVersion(e.target.dataset.id)));
        }

        function duplicateTemplate(templateId) {
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const originalTemplate = userTemplates.find(t => t.id === templateId);
            if (!originalTemplate) return;
            const newTemplate = JSON.parse(JSON.stringify(originalTemplate));
            newTemplate.id = crypto.randomUUID();
            newTemplate.name = `Copy of ${originalTemplate.name}`;
            newTemplate.isDefault = false;
            newTemplate.createdAt = new Date().toISOString();
            newTemplate.updatedAt = new Date().toISOString();
            userTemplates.push(newTemplate);
            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            setSyncState('unsynced');
            loadTemplates();
        }

        function exportTemplates() {
            const data = localStorage.getItem('userTemplates') || '[]';
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `text_merge_templates_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let data = JSON.parse(e.target.result);
                    data = migrateTemplates(data);
                    if (!Array.isArray(data) || !data.every(t => t.id && t.name && t.versions)) throw new Error("Invalid template file.");
                    const merge = confirm("Merge with existing templates? (Cancel to replace)");
                    const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : [];
                    localStorage.setItem('userTemplates', JSON.stringify([...existing, ...data]));
                    setSyncState('unsynced');
                    alert(`Imported ${data.length} templates.`);
                    loadTemplates();
                } catch (error) { alert(`Import failed: ${error.message}`); }
            };
            reader.readAsText(file);
            ui.manage.importFileInput.value = '';
        }

        function initializeFirebase() {
            try {
                firebaseApp = initializeApp(FIREBASE_CONFIG);
                firebaseAuth = getAuth(firebaseApp);
                firestoreDb = getFirestore(firebaseApp);
                onAuthStateChanged(firebaseAuth, user => {
                    currentUser = user;
                    updateFirebaseAuthStatus(!!user);
                    if(user) listenForTemplateChanges();
                    else if (templatesUnsubscribe) { templatesUnsubscribe(); templatesUnsubscribe = null; loadTemplates(); }
                });
            } catch (e) {
                console.error("Firebase initialization error: ", e);
                ui.sync.status.textContent = "Firebase is not configured correctly.";
            }
        }

        function handleFirebaseSignIn() {
            const email = ui.sync.emailInput.value;
            const password = ui.sync.passwordInput.value;
            if (!email || !password) return alert("Please enter email and password.");
            signInWithEmailAndPassword(firebaseAuth, email, password)
                .catch(error => alert(`Sign in failed: ${error.message}`));
        }
        
        function handleFirebaseSignUp() {
            const email = ui.sync.emailInput.value;
            const password = ui.sync.passwordInput.value;
            if (!email || !password) return alert("Please enter email and password.");
            createUserWithEmailAndPassword(firebaseAuth, email, password)
                .catch(error => alert(`Sign up failed: ${error.message}`));
        }
        
        function handleFirebaseSignOut() { signOut(firebaseAuth); }

        function updateFirebaseAuthStatus(isSignedIn) {
            ui.sync.authContainer.classList.toggle('hidden', isSignedIn);
            ui.sync.controls.classList.toggle('hidden', !isSignedIn);
            if (isSignedIn) ui.sync.authStatus.textContent = `Signed in as ${currentUser.email}`;
        }

        async function saveToFirebase() {
            if (!currentUser) return alert("You must be signed in to save to Firebase.");
            setSyncState('syncing');
            const userTemplates = localStorage.getItem('userTemplates') || '[]';
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            try {
                await setDoc(userDocRef, { templates: JSON.parse(userTemplates), updatedAt: new Date() });
                setSyncState('synced');
            } catch (error) {
                setSyncState('error');
                console.error("Firebase save error:", error);
            }
        }

        function listenForTemplateChanges() {
            if (templatesUnsubscribe) templatesUnsubscribe();
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            templatesUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.templates) {
                        const migrated = migrateTemplates(data.templates);
                        localStorage.setItem('userTemplates', JSON.stringify(migrated));
                        loadTemplates();
                        setSyncState('synced');
                    }
                } else {
                    saveToFirebase(); // First time sync
                }
            });
        }
        
        async function loadFromFirebase() {
            if (!currentUser) return alert("You must be signed in to load from Firebase.");
            setSyncState('syncing');
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const templates = migrateTemplates(data.templates || []);
                    const merge = confirm("Merge with local templates? (Cancel to replace)");
                    const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : [];
                    localStorage.setItem('userTemplates', JSON.stringify([...existing, ...templates]));
                    loadTemplates();
                    setSyncState('synced');
                } else {
                    setSyncState('synced');
                }
            } catch (error) {
                setSyncState('error');
                console.error("Firebase load error:", error);
            }
        }

        function setSyncState(newState) {
            syncState = newState;
            ui.sync.indicator.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800');
            switch(newState) {
                case 'synced': ui.sync.indicator.textContent = 'Synced'; ui.sync.indicator.classList.add('bg-green-100', 'text-green-800'); break;
                case 'unsynced': ui.sync.indicator.textContent = 'Unsynced Changes'; ui.sync.indicator.classList.add('bg-yellow-100', 'text-yellow-800'); break;
                case 'syncing': ui.sync.indicator.textContent = 'Syncing...'; ui.sync.indicator.classList.add('bg-blue-100', 'text-blue-800'); break;
                case 'error': ui.sync.indicator.textContent = 'Sync Error'; ui.sync.indicator.classList.add('bg-red-100', 'text-red-800'); break;
                default: ui.sync.indicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>