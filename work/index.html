<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Template Generator</title>
    <link rel="icon" href="/favicons/envelope-open-text.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&family=Lora&family=Merriweather&family=Playfair+Display&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg-color: white;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }
        .dark {
            --bg-color: #1f2937;
            --card-bg-color: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        .step-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
        }
        #generated-text-container.transition-height {
            transition: max-height 1s ease-in-out;
        }
        .template-list-item {
            transition: background-color 0.2s ease-in-out;
        }
        .template-list-item:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .dark .template-list-item:hover {
            background-color: #4b5563;
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        .dark .tab-button.active {
            background-color: #4338ca;
            color: #e0e7ff;
        }
        .placeholder-tag {
            cursor: grab;
            user-select: none;
        }
        .generated-html-body {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            min-height: 10rem;
            background-color: #f9fafb;
            white-space: pre-wrap;
        }
        .dark .generated-html-body {
            background-color: #4b5563;
        }
        summary {
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        .field-row.dragging {
            opacity: 0.5;
            background: #eef2ff;
        }
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        .theme-switcher {
            background-color: var(--card-bg-color);
            border: 1px solid var(--text-secondary);
        }
        .dark .sun-icon { display: block; }
        .dark .moon-icon { display: none; }
        .sun-icon { display: none; }
        .moon-icon { display: block; }
        .details-arrow {
            transition: transform 0.2s;
        }
        details[open] .details-arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        Copied to clipboard!
    </div>
    
    <div id="sync-conflict-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-2xl leading-6 font-medium text-gray-900 text-center">Sync Conflict Detected</h3>
                <div class="mt-4 px-2 py-3">
                    <p class="text-sm text-gray-600 mb-6 text-center">
                        Your local templates differ from the ones stored in the cloud. For each item below, please choose which version you'd like to keep.
                    </p>
                    <div id="conflict-resolution-container" class="space-y-4 text-left max-h-[60vh] overflow-y-auto pr-2">
                        </div>
                </div>
                <div class="items-center px-4 py-3 mt-4">
                    <button id="resolve-conflicts-button" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-75 disabled:cursor-wait">
                        Apply Resolutions & Sync
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold">Email Template Generator</h1>
            <p class="mt-2">Create, manage, and use your own email templates with advanced features.</p>
        </header>
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <div id="sync-status-indicator" class="text-sm font-medium px-3 py-1 rounded-full hidden flex items-center gap-2"></div>
                <span id="version-display" class="text-sm font-semibold"></span>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="theme-switcher rounded-full p-2" title="Toggle dark mode">
                    <i class="fas fa-moon"></i>
                </button>
                <a href="/" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Back to Hub</a>
            </div>
        </div>

        <div class="mb-8 border-b border-gray-200 dark:border-gray-700">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="use-templates">
                    Use Templates
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="batch-generate">
                    Batch Generate
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="manage-templates">
                    Manage Templates
                </button>
                 <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center gap-2" data-tab="sync-settings">
                    Sync & Settings
                </button>
            </nav>
        </div>

        <div id="tab-content-use-templates">
            <div class="space-y-8">
                <div class="step-card p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 1: Choose a Template & Presets</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="folder-filter" class="block text-sm font-medium mb-1">Filter by Folder</label>
                            <select id="folder-filter" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="template-select" class="block text-sm font-medium mb-1">Select an email template</label>
                            <select id="template-select" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                     <div id="version-select-container" class="hidden mt-4">
                        <label for="version-select" class="block text-sm font-medium mb-1">Select a version</label>
                        <select id="version-select" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <label for="pronoun-preset" class="block text-sm font-medium mb-1">Pronoun Presets</label>
                        <select id="pronoun-preset" class="w-full md:w-1/2 px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">None</option>
                            <option value="male">Male (he/him/his/himself)</option>
                            <option value="female">Female (she/her/hers/herself)</option>
                            <option value="neutral">Neutral (they/them/theirs/themself)</option>
                        </select>
                    </div>
                </div>

                <div class="step-card p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 2: Fill in the Details</h2>
                    <div id="fields-container" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <p class="col-span-full">Please select a template first.</p>
                    </div>
                </div>
                
                <div class="step-card p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 3: Generate & Copy Email</h2>
                    <div class="text-center">
                         <button id="generate-button" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Generate Email
                        </button>
                    </div>
                    
                    <div id="generated-text-container" class="mt-6 max-h-0 overflow-hidden transition-height space-y-4">
                        <div id="generated-subject-wrapper" class="hidden">
                            <div class="flex justify-between items-center mb-2">
                                <label for="generated-subject" class="block text-sm font-medium">Generated Subject:</label>
                                <div>
                                    <button type="button" id="copy-subject-button" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                        Copy Subject
                                    </button>
                                </div>
                            </div>
                            <input type="text" id="generated-subject" class="w-full p-2 border rounded-md shadow-sm bg-gray-50" readonly>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium">Generated Body:</label>
                                <div class="flex items-center gap-2">
                                    <button id="copy-body-button" class="bg-gray-200 text-gray-700 font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                                        Copy Body
                                    </button>
                                    <button id="load-to-gmail-button" class="bg-red-500 text-white font-semibold py-1 px-3 text-sm rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 hidden">
                                        Load to Gmail
                                    </button>
                                </div>
                            </div>
                            <div id="generated-text" class="generated-html-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-content-batch-generate" class="hidden">
             <div class="space-y-8">
                <div class="step-card p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Batch Generate from CSV</h2>
                    <p class="mb-4">Upload a CSV file where the column headers match the placeholders of your chosen template (e.g., a column named 'Name' for the {{Name}} placeholder).</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="batch-template-select" class="block text-sm font-medium mb-1">1. Select Template to Use</label>
                            <select id="batch-template-select" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="csv-file-input" class="block text-sm font-medium mb-1">2. Upload CSV File</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="batch-generate-button" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out text-lg">
                            Generate All
                        </button>
                    </div>
                </div>
                 <div id="batch-output-container" class="hidden step-card p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Generated Output</h2>
                     <div id="batch-output" class="space-y-6"></div>
                 </div>
            </div>
        </div>

        <div id="tab-content-manage-templates" class="hidden">
            <details class="step-card p-6 rounded-lg shadow-md mb-8">
                <summary class="text-2xl font-semibold cursor-pointer flex justify-between items-center">
                    <span>Create New Template</span>
                    <svg class="w-5 h-5 details-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </summary>
                <div id="template-manager" class="mt-4 pt-4 border-t">
                    <h3 id="form-title" class="text-xl font-semibold mb-4">Create New Template</h3>
                    <form id="template-form" class="space-y-4">
                        <input type="hidden" id="template-edit-id">
                        <input type="hidden" id="template-edit-version">
                        <input type="hidden" id="template-save-mode">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                <label for="template-name" class="block text-sm font-medium">Template Name</label>
                                <input type="text" id="template-name" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive Progress Review" required>
                            </div>
                            <div>
                                <label for="template-folder" class="block text-sm font-medium">Folder (Optional)</label>
                                <input type="text" id="template-folder" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive Feedback, Attendance" list="folder-suggestions">
                                <datalist id="folder-suggestions"></datalist>
                            </div>
                        </div>
                        <div>
                            <label for="template-subject" class="block text-sm font-medium">Template Subject (Optional)</label>
                            <input type="text" id="template-subject" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Update on {{Name}}'s Progress">
                        </div>
                         <div>
                            <label for="template-description" class="block text-sm font-medium">Description (for this version)</label>
                            <input type="text" id="template-description" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="A brief description of this template version">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="template-target" class="block text-sm font-medium">Target Audience</label>
                                <input type="text" id="template-target" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Parents, Students">
                            </div>
                            <div>
                                <label for="template-purpose" class="block text-sm font-medium">Purpose</label>
                                <input type="text" id="template-purpose" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Positive reinforcement">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Define Template Placeholders</label>
                            <details class="mt-1 mb-2 text-sm">
                                <summary class="cursor-pointer font-semibold text-indigo-600 hover:underline">View Pronoun Preset Guide</summary>
                                <div class="mt-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-md border">
                                    <p class="text-gray-800 dark:text-gray-200">To make your templates compatible with the pronoun preset feature, use the following exact placeholder names:</p>
                                    <ul class="list-disc list-inside mt-2 space-y-1 font-mono text-xs text-gray-700 dark:text-gray-300">
                                        <li><b>Pronoun_he/she/they</b>: For subjective pronouns (e.g., "he went to the store").</li>
                                        <li><b>Pronoun_him/her/them</b>: For objective pronouns (e.g., "I gave the book to him").</li>
                                        <li><b>Pronoun_his/her/their</b>: For possessive pronouns (e.g., "That is his book").</li>
                                        <li><b>Pronoun_himself/herself/themself</b>: For reflexive pronouns (e.g., "He did it himself").</li>
                                    </ul>
                                </div>
                            </details>
                            <div id="dynamic-fields-container" class="space-y-2 mt-1"></div>
                            <button type="button" id="add-field-button" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors py-1 px-2 rounded-md bg-blue-100 hover:bg-blue-200">
                                + Add Placeholder
                            </button>
                        </div>
                        <div id="interactive-placeholders-wrapper" class="hidden">
                             <label class="block text-sm font-medium">Available Placeholders</label>
                             <div id="interactive-placeholders-container" class="mt-1 p-2 bg-gray-200 rounded-md flex flex-wrap gap-2"></div>
                             <p class="text-xs mt-1">Drag & drop or double-click a placeholder to insert it into the editor.</p>
                        </div>
                        <div>
                            <label for="template-body" class="block text-sm font-medium">Template Text
                                <span class="text-xs" title="Use your placeholders in the text like this: {{Placeholder Name}}. You can use () and [] inside the placeholders, e.g., ({{Student Name}})."> (Hover for help)</span>
                            </label>
                            <textarea id="template-body" rows="8" class="mt-1 w-full p-3 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Write your template text here..."></textarea>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="submit" id="save-template-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save Template</button>
                            <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 hidden">Cancel Edit</button>
                        </div>
                    </form>
                     <p id="save-status" class="text-sm mt-3 text-green-600"></p>
                </div>
            </details>

            <details class="step-card p-6 rounded-lg shadow-md" open>
                <summary class="text-2xl font-semibold cursor-pointer flex justify-between items-center">
                    <span>Your Saved Templates</span>
                    <svg class="w-5 h-5 details-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </summary>
                <div class="mt-4 pt-4 border-t">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                         <h3 class="text-xl font-semibold">Your Saved Templates</h3>
                         <div class="flex items-center gap-2">
                            <label for="show-archived-toggle" class="text-sm font-medium">Show Archived</label>
                            <input type="checkbox" id="show-archived-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        </div>
                         <div class="flex items-center gap-2">
                            <button id="import-button" class="text-sm font-semibold hover:text-gray-900 transition-colors py-1 px-3 rounded-md bg-gray-200 hover:bg-gray-300">Import from File</button>
                            <button id="export-button" class="text-sm font-semibold text-white hover:text-white transition-colors py-1 px-3 rounded-md bg-blue-600 hover:bg-blue-700">Export to File</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </div>
                    <div id="user-templates-list" class="space-y-4">
                        <p>You haven't created any templates yet.</p>
                    </div>
                </div>
            </details>
        </div>
        
        <div id="tab-content-sync-settings" class="hidden space-y-8">
            <div class="step-card p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Sync with Firebase</h2>
                <div id="firebase-auth-container">
                    <p class="mb-4">Sign in to sync your templates across devices.</p>
                    <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                        <div class="flex-grow">
                            <label for="firebase-email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="firebase-email" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="your@email.com">
                        </div>
                        <div class="flex-grow">
                            <label for="firebase-password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="firebase-password" class="w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                        </div>
                        <div class="flex gap-2">
                            <button id="firebase-signin-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Sign In</button>
                            <button id="firebase-signup-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Sign Up</button>
                        </div>
                    </div>
                     <div class="mt-4">
                        <button id="google-signin-button" class="bg-white border text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 w-full">Sign in with Google</button>
                    </div>
                </div>
                <div id="firebase-sync-controls" class="hidden mt-6 space-y-4">
                    <p id="firebase-auth-status" class="text-sm text-green-600"></p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="firebase-sync-button" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Check for Cloud Updates</button>
                    </div>
                    <button id="firebase-signout-button" class="text-sm text-red-600 hover:underline">Sign Out</button>
                </div>
                <p id="firebase-status" class="text-sm mt-4"></p>
            </div>

            <div class="step-card p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Gmail Integration</h2>
                <p class="mb-4">Authorize this application to create drafts in your Gmail account.</p>
                <button id="authorize-gmail-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Authorize Gmail Access
                </button>
                <p id="gmail-auth-status" class="text-sm mt-3 text-green-600"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { changelogData } from '/changelog-data.js';
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3",
        };
        
        // =======================================================================
        // IMPORTANT: GMAIL API SETUP
        // =======================================================================
        // To enable the "Load to Gmail" feature, you must:
        // 1. Go to the Google Cloud Console: https://console.cloud.google.com/
        // 2. Create a new project.
        // 3. Enable the "Gmail API" for your project.
        // 4. Go to "Credentials".
        // 5. Create an "API key" and paste it below.
        // 6. Create an "OAuth 2.0 Client ID" for a "Web application".
        //    - Add your website's URL (e.g., http://localhost, https://your-site.com)
        //      to the "Authorized JavaScript origins".
        // 7. Paste the "Client ID" below.
        // =======================================================================
        const GMAIL_API_KEY = 'AIzaSyBFiRohb20wg2EogjMrsFOgsgyKXo3495E';     // <--- PASTE YOUR API KEY HERE
        const GMAIL_CLIENT_ID = '963185683535-gsbqbtndjpl7ka43j9dlte3h1fgor4sm.apps.googleusercontent.com'; // <--- PASTE YOUR CLIENT ID HERE
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.compose';

        let tokenClient;

        const defaultTemplates = [
             {
                id: "default-positive-review", name: "Positive Progress Review", folder: "Education", isArchived: false, isDefault: true,
                versions: [{ version: 1, createdAt: new Date('2023-01-01T10:00:00Z').toISOString(), updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(), subject: "An update on {{Name}}'s progress in {{Subject}}", description: "A standard positive review for a student making good progress.", target: "Parents/Guardians", purpose: "To inform and praise.", fields: [{name: "Name", desc: "Student's full name", type: "text"}, {name: "Pronoun_he/she/they", desc: "Subjective pronoun", type: "text"}, {name: "Pronoun_him/her/them", desc: "Objective pronoun", type: "text"}, {name: "Pronoun_his/her/their", desc: "Possessive pronoun", type: "text"}, {name: "Pronoun_himself/herself/themself", desc: "Reflexive pronoun", type: "text"}, {name: "Subject", desc: "The academic subject", type: "text"}, {name: "Tutor", desc: "Tutor's name", type: "text"}], template: "This is a review of {{Name}}'s progress in {{Subject}}.\n\nI am pleased to report that {{Name}} is making excellent progress. {{Pronoun_he/she/they}} consistently demonstrates a strong understanding of the core concepts and actively participates in class discussions.\n\n{{Pronoun_his/her/their}} work is always completed to a high standard, and {{Pronoun_he/she/they}} shows great enthusiasm for the subject. It is a pleasure to have {{Name}} in my class.\n\nRegards,\n{{Tutor}}"}]
            },
            {
                id: "default-needs-improvement", name: "Needs Improvement Review", folder: "Education", isArchived: false, isDefault: true,
                versions: [{ version: 1, createdAt: new Date('2023-01-01T10:00:00Z').toISOString(), updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(), subject: "Update regarding {{Name}} in {{Subject}}", description: "Highlights an area of concern and suggests next steps.", target: "Parents/Guardians", purpose: "To inform and seek support.", fields: [{name: "Name", desc: "", type: "text"}, {name: "Pronoun_he/she/they", desc: "", type: "text"}, {name: "Pronoun_him/her/them", desc: "", type: "text"}, {name: "Pronoun_his/her/their", desc: "", type: "text"}, {name: "Pronoun_himself/herself/themself", desc: "", type: "text"}, {name: "Subject", desc: "", type: "text"}, {name: "Year_Group", desc: "", type: "text"}, {name: "Tutor", desc: "", type: "text"}, {name: "Specific_Area", desc: "e.g., Algebra, Punctuation", type: "text"}], template: "This is an update regarding {{Name}} in Year {{Year_Group}} {{Subject}}.\n\nWhile {{Name}} has a foundational understanding of the subject, there are areas that require more focus. Specifically, {{Pronoun_he/she/they}} is finding {{Specific_Area}} challenging and would benefit from additional practice.\n\nI encourage {{Name}} to ask more questions in class and attend support sessions to improve {{Pronoun_his/her/their}} confidence and skills in this area. We will continue to provide support in school.\n\nRegards,\n{{Tutor}}"}]
            }
        ];
        
        let allTemplates = [];
        let currentTemplateVersion = null;
        let syncState = 'unknown'; 
        let firebaseApp, firebaseAuth, firestoreDb;
        let currentUser = null;
        let templatesUnsubscribe = null;
        let showArchived = false;

        const ui = {
            tabs: { buttons: document.querySelectorAll('.tab-button'), contents: { 'use-templates': document.getElementById('tab-content-use-templates'), 'batch-generate': document.getElementById('tab-content-batch-generate'), 'manage-templates': document.getElementById('tab-content-manage-templates'), 'sync-settings': document.getElementById('tab-content-sync-settings') }},
            use: { pronounPreset: document.getElementById('pronoun-preset'), templateSelect: document.getElementById('template-select'), folderFilter: document.getElementById('folder-filter'), versionSelectContainer: document.getElementById('version-select-container'), versionSelect: document.getElementById('version-select'), fieldsContainer: document.getElementById('fields-container'), generateButton: document.getElementById('generate-button'), generatedTextContainer: document.getElementById('generated-text-container'), generatedSubjectWrapper: document.getElementById('generated-subject-wrapper'), generatedSubjectInput: document.getElementById('generated-subject'), generatedTextDiv: document.getElementById('generated-text'), copySubjectButton: document.getElementById('copy-subject-button'), copyBodyButton: document.getElementById('copy-body-button'), loadToGmailButton: document.getElementById('load-to-gmail-button') },
            manage: { form: document.getElementById('template-form'), formTitle: document.getElementById('form-title'), nameInput: document.getElementById('template-name'), folderInput: document.getElementById('template-folder'), folderSuggestions: document.getElementById('folder-suggestions'), subjectInput: document.getElementById('template-subject'), descriptionInput: document.getElementById('template-description'), targetInput: document.getElementById('template-target'), purposeInput: document.getElementById('template-purpose'), fieldsContainer: document.getElementById('dynamic-fields-container'), addFieldButton: document.getElementById('add-field-button'), placeholdersWrapper: document.getElementById('interactive-placeholders-wrapper'), placeholdersContainer: document.getElementById('interactive-placeholders-container'), bodyTextarea: document.getElementById('template-body'), editIdInput: document.getElementById('template-edit-id'), editVersionInput: document.getElementById('template-edit-version'), saveModeInput: document.getElementById('template-save-mode'), userTemplatesList: document.getElementById('user-templates-list'), cancelEditButton: document.getElementById('cancel-edit-button'), saveStatus: document.getElementById('save-status'), exportButton: document.getElementById('export-button'), importButton: document.getElementById('import-button'), importFileInput: document.getElementById('import-file-input'), showArchivedToggle: document.getElementById('show-archived-toggle') },
            batch: { templateSelect: document.getElementById('batch-template-select'), csvFileInput: document.getElementById('csv-file-input'), generateButton: document.getElementById('batch-generate-button'), outputContainer: document.getElementById('batch-output-container'), output: document.getElementById('batch-output') },
            sync: { 
                indicator: document.getElementById('sync-status-indicator'), 
                authContainer: document.getElementById('firebase-auth-container'), 
                controls: document.getElementById('firebase-sync-controls'), 
                emailInput: document.getElementById('firebase-email'), 
                passwordInput: document.getElementById('firebase-password'), 
                signinButton: document.getElementById('firebase-signin-button'), 
                signupButton: document.getElementById('firebase-signup-button'), 
                googleSigninButton: document.getElementById('google-signin-button'),
                signoutButton: document.getElementById('firebase-signout-button'), 
                authStatus: document.getElementById('firebase-auth-status'), 
                syncButton: document.getElementById('firebase-sync-button'), 
                status: document.getElementById('firebase-status'),
                conflictModal: document.getElementById('sync-conflict-modal'),
                conflictContainer: document.getElementById('conflict-resolution-container'),
                resolveButton: document.getElementById('resolve-conflicts-button'),
                authorizeGmailButton: document.getElementById('authorize-gmail-button'),
                gmailAuthStatus: document.getElementById('gmail-auth-status')
            },
            versionDisplay: document.getElementById('version-display'),
            notification: document.getElementById('notification'),
            themeToggle: document.getElementById('theme-toggle')
        };
        
        window.onload = function() {
            loadTemplates();
            setupTabs();
            
            ui.use.pronounPreset.addEventListener('change', applyPronounPreset);
            ui.use.folderFilter.addEventListener('change', () => populateTemplateSelector());
            ui.use.templateSelect.addEventListener('change', handleTemplateChange);
            ui.use.versionSelect.addEventListener('change', loadSelectedVersion);
            ui.use.generateButton.addEventListener('click', generateText);
            ui.use.copyBodyButton.addEventListener('click', () => copyToClipboard(ui.use.generatedTextDiv.innerText, "Body copied!"));
            ui.use.copySubjectButton.addEventListener('click', () => copyToClipboard(ui.use.generatedSubjectInput.value, "Subject copied!"));
            ui.use.loadToGmailButton.addEventListener('click', createGmailDraft);
            ui.manage.form.addEventListener('submit', handleSaveTemplate);
            ui.manage.cancelEditButton.addEventListener('click', cancelEdit);
            ui.manage.addFieldButton.addEventListener('click', () => addFieldInputRow({name: '', desc: '', type: 'text', options: ''}));
            ui.manage.exportButton.addEventListener('click', exportTemplates);
            ui.manage.importButton.addEventListener('click', () => ui.manage.importFileInput.click());
            ui.manage.importFileInput.addEventListener('change', handleImportFile);
            ui.manage.showArchivedToggle.addEventListener('change', (e) => {
                showArchived = e.target.checked; renderTemplateManager();
            });
            ui.batch.generateButton.addEventListener('click', handleBatchGenerate);
            
            ui.sync.signinButton.addEventListener('click', handleFirebaseSignIn);
            ui.sync.signupButton.addEventListener('click', handleFirebaseSignUp);
            ui.sync.googleSigninButton.addEventListener('click', handleGoogleSignIn);
            ui.sync.signoutButton.addEventListener('click', handleFirebaseSignOut);
            ui.sync.syncButton.addEventListener('click', checkForCloudUpdates);
            ui.sync.authorizeGmailButton.addEventListener('click', handleAuthGmailClick);

            ui.manage.bodyTextarea.addEventListener('dragover', e => e.preventDefault());
            ui.manage.bodyTextarea.addEventListener('drop', handleDrop);
            
            setupDragAndDrop();

            initializeFirebase();
            if (ui.versionDisplay) {
                ui.versionDisplay.textContent = changelogData[0].version;
            }
            gapiLoaded();
            gisLoaded();
        };

        function sanitizeForId(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/[^a-zA-Z0-9\-_]/g, '_');
        }
        
        function setupTabs() {
            ui.tabs.buttons.forEach(button => button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab)));
            switchTab('use-templates');
        }

        function switchTab(activeTab) {
            ui.tabs.buttons.forEach(button => button.classList.toggle('active', button.dataset.tab === activeTab));
            Object.values(ui.tabs.contents).forEach(content => content.classList.add('hidden'));
            ui.tabs.contents[activeTab].classList.remove('hidden');
        }
        
        function migrateTemplates(templates) {
            if (!Array.isArray(templates)) return [];
            return templates.map(t => {
                if (t.versions && t.versions[0].fields && typeof t.versions[0].fields[0] === 'object' && 'type' in t.versions[0].fields[0]) return t;
                const { name, folder, subject, description, target, purpose, fields, template, createdAt, updatedAt, isDefault, isArchived } = t;
                const newVersions = (t.versions || [{ subject, description, target, purpose, fields, template, createdAt }]).map(v => ({
                    ...v,
                    fields: Array.isArray(v.fields) ? v.fields.map(f => typeof f === 'string' ? { name: f, desc: '', type: 'text' } : {...f, type: f.type || 'text'}) : []
                }));
                return { id: t.id || crypto.randomUUID(), name: name || "Untitled Template", folder: folder || "", isArchived: isArchived || false, isDefault: isDefault || false, createdAt: createdAt || new Date().toISOString(), updatedAt: updatedAt || new Date().toISOString(), versions: newVersions };
            });
        }
        
        function loadTemplates() {
            let userTemplates = [];
            try { 
                const rawData = localStorage.getItem('userTemplates') || '[]';
                userTemplates = migrateTemplates(JSON.parse(rawData));
                // Resave migrated data
                localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            } catch (e) { console.error("Error parsing or migrating user templates:", e); }
            
            allTemplates = [...defaultTemplates.map(t => ({...t, versions: migrateTemplates([t])[0].versions })), ...userTemplates];
            populateFolderFilter();
            populateTemplateSelector();
            populateBatchTemplateSelector();
            renderTemplateManager();
            handleTemplateChange(); 
        }
        
        // --- UI Population Functions ---
        function populateFolderFilter() {
            const folders = [...new Set(allTemplates.map(t => t.folder || 'Uncategorized').filter(Boolean))];
            const selectedValue = ui.use.folderFilter.value;
            ui.use.folderFilter.innerHTML = '<option value="">All Folders</option>';
            folders.sort().forEach(folder => {
                const option = document.createElement('option');
                option.value = folder; option.textContent = folder;
                ui.use.folderFilter.appendChild(option);
            });
            ui.use.folderFilter.value = selectedValue;

            ui.manage.folderSuggestions.innerHTML = '';
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder;
                ui.manage.folderSuggestions.appendChild(option);
            });
        }
        
        function populateTemplateSelector() {
            const selectedValue = ui.use.templateSelect.value;
            ui.use.templateSelect.innerHTML = '<option value="">Select a template...</option>';
            const selectedFolder = ui.use.folderFilter.value;
            const filtered = allTemplates.filter(t => !t.isArchived && (!selectedFolder || (t.folder || 'Uncategorized') === selectedFolder));
            filtered.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                ui.use.templateSelect.appendChild(option);
            });
            ui.use.templateSelect.value = selectedValue || "";
        }
        
        function populateBatchTemplateSelector() {
            ui.batch.templateSelect.innerHTML = '<option value="">Select a template...</option>';
            allTemplates.filter(t => !t.isArchived).forEach((template) => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                ui.batch.templateSelect.appendChild(option);
            });
        }
        
        // --- Core "Use Template" Logic ---
        function handleTemplateChange() {
            const selectedId = ui.use.templateSelect.value;
            ui.use.versionSelectContainer.classList.add('hidden');
            ui.use.fieldsContainer.innerHTML = '<p class="col-span-full">Please select a template first.</p>';
            ui.use.generateButton.disabled = true;
            currentTemplateVersion = null;
            if (!selectedId) return;
            const templateFamily = allTemplates.find(t => t.id === selectedId);
            if (!templateFamily || !templateFamily.versions || templateFamily.versions.length === 0) return;
            ui.use.versionSelect.innerHTML = '';
            [...templateFamily.versions].sort((a, b) => b.version - a.version).forEach((v, index) => {
                const option = document.createElement('option');
                option.value = v.version;
                option.textContent = `Version ${v.version}${index === 0 ? ' (Latest)' : ''} - Created on ${new Date(v.createdAt).toLocaleString()}`;
                ui.use.versionSelect.appendChild(option);
            });
            ui.use.versionSelectContainer.classList.remove('hidden');
            loadSelectedVersion();
        }

        function loadSelectedVersion() {
            const selectedId = ui.use.templateSelect.value;
            const selectedVersionNum = parseInt(ui.use.versionSelect.value, 10);
            if (!selectedId || isNaN(selectedVersionNum)) return;
            const templateFamily = allTemplates.find(t => t.id === selectedId);
            const version = templateFamily?.versions.find(v => v.version === selectedVersionNum);
            if (!version) return;
            currentTemplateVersion = version;
            ui.use.fieldsContainer.innerHTML = '';
            
            if (!version.fields || version.fields.length === 0) {
                ui.use.fieldsContainer.innerHTML = '<p class="col-span-full">This template version has no placeholders.</p>';
            } else {
                version.fields.forEach(field => {
                    if (!field.name) return;
                    const sanitizedId = `field-${sanitizeForId(field.name)}`;
                    const fieldWrapper = document.createElement('div');
                    const label = document.createElement('label');
                    label.setAttribute('for', sanitizedId);
                    label.className = "block text-sm font-medium";
                    label.textContent = field.name;
                    fieldWrapper.appendChild(label);
                    if (field.desc) {
                        const descEl = document.createElement('p');
                        descEl.className = "text-xs mb-1";
                        descEl.textContent = field.desc;
                        fieldWrapper.appendChild(descEl);
                    }
                    let inputElement;
                    if (field.type === 'dropdown') {
                        inputElement = document.createElement('select');
                        const options = field.options.split(',').map(opt => opt.trim());
                        options.forEach(opt => {
                            const optionEl = document.createElement('option');
                            optionEl.value = opt;
                            optionEl.textContent = opt;
                            inputElement.appendChild(optionEl);
                        });
                    } else {
                        inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.placeholder = `Enter ${field.name}...`;
                    }
                    inputElement.id = sanitizedId;
                    inputElement.className = "w-full px-3 py-2 border rounded-md shadow-sm dynamic-field";
                    inputElement.setAttribute('data-original-name', field.name);
                    fieldWrapper.appendChild(inputElement);
                    ui.use.fieldsContainer.appendChild(fieldWrapper);
                });
            }
            ui.use.generateButton.disabled = false;
            applyPronounPreset();
        }
        
        function applyPronounPreset() {
            const preset = ui.use.pronounPreset.value;
            if (!preset) return;

            const pronouns = {
                male: {
                    'Pronoun_he/she/they': 'he',
                    'Pronoun_him/her/them': 'him',
                    'Pronoun_his/her/their': 'his',
                    'Pronoun_himself/herself/themself': 'himself'
                },
                female: {
                    'Pronoun_he/she/they': 'she',
                    'Pronoun_him/her/them': 'her',
                    'Pronoun_his/her/their': 'her',
                    'Pronoun_himself/herself/themself': 'herself'
                },
                neutral: {
                    'Pronoun_he/she/they': 'they',
                    'Pronoun_him/her/them': 'them',
                    'Pronoun_his/her/their': 'their',
                    'Pronoun_himself/herself/themself': 'themself'
                }
            };

            const selectedPronouns = pronouns[preset];
            if (!selectedPronouns) return;

            Object.keys(selectedPronouns).forEach(fieldName => {
                const sanitizedId = `field-${sanitizeForId(fieldName)}`;
                const inputElement = document.getElementById(sanitizedId);
                if (inputElement) {
                    inputElement.value = selectedPronouns[fieldName];
                }
            });
        }
        
        function generateText() {
            if (!currentTemplateVersion) return;
            const fieldData = {};
            document.querySelectorAll('#fields-container .dynamic-field').forEach(input => {
                const originalName = input.getAttribute('data-original-name');
                if (originalName) fieldData[originalName] = input.value;
            });
            const process = (text) => {
                if (!text) return "";
                return text.replace(/\{\{(.+?)\}\}/g, (match, placeholderName) => (Object.prototype.hasOwnProperty.call(fieldData, placeholderName) ? fieldData[placeholderName] : match));
            };
            ui.use.generatedSubjectInput.value = process(currentTemplateVersion.subject);
            const bodyText = process(currentTemplateVersion.template);
            ui.use.generatedTextDiv.innerText = bodyText;
            ui.use.generatedSubjectWrapper.classList.toggle('hidden', !currentTemplateVersion.subject);
            ui.use.generatedTextContainer.style.maxHeight = '500px';

            if (gapi.client.getToken()) {
                ui.use.loadToGmailButton.classList.remove('hidden');
            }

            if (bodyText) {
                copyToClipboard(bodyText, "Body copied automatically!");
            }
        }
        
        // --- Utility Functions ---
        function copyToClipboard(content, message) {
            if (!content) return;
            navigator.clipboard.writeText(content).then(() => showNotification(message));
        }

        function showNotification(message) {
            ui.notification.textContent = message;
            ui.notification.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                ui.notification.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }
        
        // --- Batch Generation Logic ---
        function handleBatchGenerate() {
            const templateId = ui.batch.templateSelect.value;
            const file = ui.batch.csvFileInput.files[0];
            if (!templateId || !file) return alert("Please select a template and a CSV file.");
            const templateFamily = allTemplates.find(t => t.id === templateId);
            if (!templateFamily) return;
            const latestVersion = [...templateFamily.versions].sort((a,b) => b.version - a.version)[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r\n?|\n/).filter(Boolean);
                if (lines.length < 2) return alert("CSV must have a header and at least one data row.");
                const headers = lines[0].split(',').map(h => h.trim());
                const dataRows = lines.slice(1).map(line => line.split(',').reduce((obj, val, i) => { obj[headers[i]] = val.trim(); return obj; }, {}));
                displayBatchResults(dataRows, latestVersion);
            };
            reader.readAsText(file);
        }
        
        function displayBatchResults(dataRows, version) {
            ui.batch.output.innerHTML = '';
            const process = (text, data) => {
                if (!text || typeof text !== 'string' || !data || typeof data !== 'object') return "";
                return text.replace(/\{\{(.+?)\}\}/g, (match, placeholderName) => (Object.prototype.hasOwnProperty.call(data, placeholderName) ? data[placeholderName] : match));
            };
            dataRows.forEach((row, i) => {
                const subject = process(version.subject, row);
                const body = process(version.template, row);
                const entryDiv = document.createElement('div');
                entryDiv.className = "p-4 border rounded-lg";
                entryDiv.innerHTML = `<h4 class="font-semibold text-lg mb-2">Entry ${i + 1} (For: ${row.Name || 'N/A'})</h4>
                    ${subject ? `<div class="mb-2"><label class="block text-sm font-medium">Subject</label><input type="text" value="${subject}" class="w-full p-2 border rounded-md bg-gray-50" readonly></div>` : ''}
                    <div><label class="block text-sm font-medium">Body</label><div class="generated-html-body">${body}</div></div>`;
                ui.batch.output.appendChild(entryDiv);
            });
            ui.batch.outputContainer.classList.remove('hidden');
        }

        // --- Template Management Logic ---
        async function handleSaveTemplate(event) {
            event.preventDefault();
            const name = ui.manage.nameInput.value.trim();
            const templateText = ui.manage.bodyTextarea.value;
            if (!name || !templateText) return alert("Template Name and Body cannot be empty.");
            
            const editId = ui.manage.editIdInput.value;
            const editVersionNum = parseInt(ui.manage.editVersionInput.value, 10);
            const saveMode = ui.manage.saveModeInput.value;
            
            const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('.field-row')).map(row => {
                const fieldType = row.querySelector('.field-type').value;
                const fieldData = {
                    name: row.querySelector('.field-name').value.trim(),
                    type: fieldType
                };
                if (fieldType === 'dropdown') {
                    fieldData.options = row.querySelector('.field-options')?.value.trim() || '';
                } else {
                    fieldData.desc = row.querySelector('.field-desc')?.value.trim() || '';
                }
                return fieldData;
            }).filter(f => f.name);
            
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const now = new Date().toISOString();

            const versionData = {
                subject: ui.manage.subjectInput.value.trim(), description: ui.manage.descriptionInput.value.trim(),
                target: ui.manage.targetInput.value.trim(), purpose: ui.manage.purposeInput.value.trim(),
                fields, template: templateText,
            };

            if (!editId) { // Creating a brand new template
                const isDuplicate = userTemplates.some(t => t.name.toLowerCase() === name.toLowerCase() && !t.isArchived);
                if (isDuplicate) {
                    if (!confirm(`A template named "${name}" already exists. Do you want to save it anyway?`)) {
                        return;
                    }
                }
                const newTemplateFamily = {
                    id: crypto.randomUUID(), name, folder: ui.manage.folderInput.value.trim(), isArchived: false, isDefault: false, createdAt: now, updatedAt: now,
                    versions: [{ ...versionData, version: 1, createdAt: now, updatedAt: now }]
                };
                userTemplates.push(newTemplateFamily);
                showSaveStatus("New template saved successfully!");
            } else { // Modifying an existing template family
                const templateFamily = userTemplates.find(t => t.id === editId);
                if (!templateFamily) return;
                templateFamily.name = name;
                templateFamily.folder = ui.manage.folderInput.value.trim();
                templateFamily.updatedAt = now;
                if (saveMode === 'overwrite_version' && editVersionNum) {
                    if (!confirm(`Are you sure you want to permanently overwrite Version ${editVersionNum}? This action cannot be undone.`)) return;
                    const versionIndex = templateFamily.versions.findIndex(v => v.version === editVersionNum);
                    if (versionIndex > -1) {
                        const originalCreatedAt = templateFamily.versions[versionIndex].createdAt;
                        templateFamily.versions[versionIndex] = { ...versionData, version: editVersionNum, createdAt: originalCreatedAt, updatedAt: now };
                        showSaveStatus(`Version ${editVersionNum} has been overwritten.`);
                    }
                } else { // Default action is to create a new version
                    const latestVersion = Math.max(0, ...templateFamily.versions.map(v => v.version));
                    const newVersion = { ...versionData, version: latestVersion + 1, createdAt: now, updatedAt: now };
                    templateFamily.versions.push(newVersion);
                    showSaveStatus(`Saved as new Version ${newVersion.version}!`);
                }
            }

            cancelEdit(); 
            await saveAndSyncTemplates(userTemplates);
        }

        function addFieldInputRow(field = { name: '', desc: '', type: 'text', options: '' }) {
            const fieldRow = document.createElement('div');
            fieldRow.className = "flex items-center gap-2 field-row";
            fieldRow.draggable = true;
            const optionsInput = field.type === 'dropdown' ? 
                `<input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-options" placeholder="Options (comma-sep)" value="${field.options || ''}">` :
                `<input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-desc" placeholder="Helpful Description" value="${field.desc || ''}">`;

            fieldRow.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 cursor-grab drag-handle flex-shrink-0"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v12.5a.75.75 0 01-1.5 0V3.75A.75.75 0 0110 3zM3.5 10a.75.75 0 01.75-.75h11.5a.75.75 0 010 1.5H4.25a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                <div class="flex-grow grid grid-cols-3 gap-2">
                    <input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-name" placeholder="Placeholder Name" value="${field.name || ''}">
                    ${optionsInput}
                    <select class="w-full px-3 py-2 border rounded-md shadow-sm field-type">
                        <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                    </select>
                </div>
                <button type="button" class="text-sm text-red-600 hover:underline flex-shrink-0 remove-field-btn">Remove</button>`;
            fieldRow.querySelector('.remove-field-btn').addEventListener('click', () => { fieldRow.remove(); updateInteractivePlaceholders(); });
            fieldRow.querySelector('.field-type').addEventListener('change', (e) => {
                const newField = { 
                    name: fieldRow.querySelector('.field-name').value, 
                    desc: fieldRow.querySelector('.field-desc')?.value || '', 
                    type: e.target.value,
                    options: fieldRow.querySelector('.field-options')?.value || ''
                };
                const newRow = addFieldInputRow(newField);
                fieldRow.replaceWith(newRow);
                updateInteractivePlaceholders();
            });
            fieldRow.querySelector('.field-name').addEventListener('input', updateInteractivePlaceholders);
            ui.manage.fieldsContainer.appendChild(fieldRow);
            if (field.name) {
                updateInteractivePlaceholders();
            }
            return fieldRow;
        }
        
        function setupDragAndDrop() {
            const container = ui.manage.fieldsContainer;
            let draggedItem = null;
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('field-row')) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            container.addEventListener('dragend', e => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = [...container.querySelectorAll('.field-row:not(.dragging)')].reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });
        }
        
        function updateInteractivePlaceholders() {
            ui.manage.placeholdersContainer.innerHTML = '';
            const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('.field-name')).map(input => input.value.trim()).filter(Boolean);
            if (fields.length > 0) {
                fields.forEach(name => {
                    const tag = document.createElement('div');
                    tag.textContent = name;
                    tag.className = "placeholder-tag bg-blue-100 text-blue-800 text-sm font-semibold px-2.5 py-1 rounded-full";
                    tag.draggable = true;
                    tag.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', `{{${name}}}`));
                    tag.addEventListener('dblclick', () => insertPlaceholder(`{{${name}}}`));
                    ui.manage.placeholdersContainer.appendChild(tag);
                });
                ui.manage.placeholdersWrapper.classList.remove('hidden');
            } else {
                ui.manage.placeholdersWrapper.classList.add('hidden');
            }
        }

        function insertPlaceholder(textToInsert) {
            const textarea = ui.manage.bodyTextarea;
            const start = textarea.selectionStart; const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + textToInsert + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length;
            textarea.focus();
        }
        
        function handleDrop(e) { e.preventDefault(); const textToInsert = e.dataTransfer.getData('text/plain'); if (/\{\{.+?\}\}/.test(textToInsert)) insertPlaceholder(textToInsert); }
        function showSaveStatus(message) { ui.manage.saveStatus.textContent = message; setTimeout(() => { ui.manage.saveStatus.textContent = ''; }, 3000); }
        
        // --- Template Editor Actions ---
        function loadTemplateIntoEditor(config) {
            const { family, version, title, saveMode } = config;
            ui.manage.formTitle.textContent = title;
            ui.manage.nameInput.value = family.name;
            ui.manage.folderInput.value = family.folder || '';
            ui.manage.subjectInput.value = version.subject || '';
            ui.manage.descriptionInput.value = version.description || '';
            ui.manage.targetInput.value = version.target || '';
            ui.manage.purposeInput.value = version.purpose || '';
            ui.manage.bodyTextarea.value = version.template || '';
            ui.manage.editIdInput.value = family.id || '';
            ui.manage.editVersionInput.value = version.version || '';
            ui.manage.saveModeInput.value = saveMode;
            ui.manage.fieldsContainer.innerHTML = '';
            (version.fields || []).forEach(field => addFieldInputRow(field));
            ui.manage.cancelEditButton.classList.remove('hidden');
            document.querySelector('#tab-content-manage-templates details').open = true;
            window.scrollTo({ top: document.getElementById('template-manager').offsetTop, behavior: 'smooth' });
        }

        function editVersionInPlace(templateId, versionNumber) {
            const family = allTemplates.find(t => t.id === templateId);
            const version = family?.versions.find(v => v.version == versionNumber);
            if (!family || !version) return;
            loadTemplateIntoEditor({ family, version, title: `Editing Version ${version.version} of "${family.name}"`, saveMode: 'overwrite_version' });
        }

        function duplicateAsNewVersion(templateId, versionNumber) {
            const family = allTemplates.find(t => t.id === templateId);
            const version = family?.versions.find(v => v.version == versionNumber);
            if (!family || !version) return;
            loadTemplateIntoEditor({ family, version, title: `Creating New Version from v${version.version} of "${family.name}"`, saveMode: 'new_version' });
        }
        
        function duplicateAsNewTemplate(templateId, versionNumber) {
            const family = allTemplates.find(t => t.id === templateId);
            const version = family?.versions.find(v => v.version == versionNumber);
            if (!family || !version) return;
            const newFamily = { ...family, id: '', name: `Copy of ${family.name}` };
            const newVersion = { ...version, version: '' };
            loadTemplateIntoEditor({ family: newFamily, version: newVersion, title: `Creating New Template from "${family.name}" v${version.version}`, saveMode: 'new_template' });
        }

        function addBlankVersion(templateId) {
            const family = allTemplates.find(t => t.id === templateId);
            if (!family) return;
            loadTemplateIntoEditor({ family, version: { fields: [] }, title: `Adding Blank New Version to "${family.name}"`, saveMode: 'new_version' });
        }

        function cancelEdit() {
            ui.manage.formTitle.textContent = "Create New Template";
            ui.manage.form.reset();
            ui.manage.bodyTextarea.value = '';
            ui.manage.fieldsContainer.innerHTML = '';
            ui.manage.editIdInput.value = "";
            ui.manage.editVersionInput.value = "";
            ui.manage.saveModeInput.value = "";
            ui.manage.cancelEditButton.classList.add('hidden');
            updateInteractivePlaceholders();
        }

        async function toggleArchiveTemplate(templateId) {
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const template = userTemplates.find(t => t.id === templateId);
            if (template) {
                template.isArchived = !template.isArchived;
                template.updatedAt = new Date().toISOString();
            }
            await saveAndSyncTemplates(userTemplates);
        }

        async function deleteTemplate(templateId) {
            if (!confirm("Are you sure you want to permanently delete this template and all its versions?")) return;
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            userTemplates = userTemplates.filter(t => t.id !== templateId);
            await saveAndSyncTemplates(userTemplates);
        }
        
        function useVersion(templateId, versionNumber) {
            switchTab('use-templates');
            ui.use.templateSelect.value = templateId;
            ui.use.templateSelect.dispatchEvent(new Event('change'));
            ui.use.versionSelect.value = versionNumber;
            ui.use.versionSelect.dispatchEvent(new Event('change'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // --- Template Manager UI Rendering ---
        function renderTemplateManager() {
            ui.manage.userTemplatesList.innerHTML = '';
            const userTemplates = allTemplates.filter(t => !t.isDefault);
            const groupedByFolder = userTemplates.reduce((acc, template) => {
                const folder = template.folder || 'Uncategorized';
                if (!acc[folder]) {
                    acc[folder] = [];
                }
                acc[folder].push(template);
                return acc;
            }, {});

            const sortedFolders = Object.keys(groupedByFolder).sort();

            sortedFolders.forEach(folder => {
                const folderContainer = document.createElement('div');
                folderContainer.innerHTML = `<h3 class="text-xl font-semibold mb-2">${folder}</h3>`;
                const templatesInFolder = groupedByFolder[folder];
                const visibleTemplates = templatesInFolder.filter(t => showArchived || !t.isArchived);
                
                if (visibleTemplates.length > 0) {
                    visibleTemplates.forEach(template => {
                        const latestVersion = [...template.versions].sort((a, b) => b.version - a.version)[0];
                        const item = document.createElement('div');
                        item.className = `template-list-item block p-4 border rounded-lg ${template.isArchived ? 'opacity-60 bg-gray-100' : ''}`;
                        let versionsHtml = [...template.versions].sort((a,b) => b.version - a.version).map(v => `
                            <li class="p-3 border-t">
                                <div class="flex justify-between items-start"><div><p class="font-semibold">Version ${v.version} <span class="font-normal">- Created: ${new Date(v.createdAt).toLocaleString()}, Updated: ${new Date(v.updatedAt).toLocaleString()}</span></p><p class="italic mt-1 text-sm">"${v.description || 'No description'}"</p></div></div>
                                <div class="mt-2 pt-2 border-t border-gray-200 space-x-4 text-sm">
                                    <button class="font-semibold text-blue-600 hover:underline use-version-btn" data-id="${template.id}" data-version="${v.version}">Use</button>
                                    <button class="font-semibold hover:underline edit-version-btn" data-id="${template.id}" data-version="${v.version}">Edit</button>
                                    <button class="font-semibold hover:underline duplicate-new-version-btn" data-id="${template.id}" data-version="${v.version}">Duplicate as New Version</button>
                                    <button class="font-semibold hover:underline duplicate-new-template-btn" data-id="${template.id}" data-version="${v.version}">Duplicate as New Template</button>
                                </div>
                            </li>`).join('');
                        item.innerHTML = `
                            <div class="flex justify-between items-start"><div><h4 class="font-semibold text-lg">${template.name}</h4><div class="flex items-center gap-2 mt-1"><span class="text-xs font-medium bg-gray-200 px-2 py-0.5 rounded-full">Latest: v${latestVersion.version}</span>${template.folder ? `<span class="text-xs font-medium bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${template.folder}</span>` : ''}${template.isArchived ? `<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Archived</span>` : ''}</div></div><div class="space-x-3 flex-shrink-0 ml-4"><button class="text-sm text-green-600 hover:underline use-latest-btn" data-id="${template.id}" data-version="${latestVersion.version}">Use Latest</button><button class="text-sm text-green-600 hover:underline duplicate-template-btn" data-id="${template.id}">Duplicate Template</button><button class="text-sm text-yellow-600 hover:underline archive-btn" data-id="${template.id}">${template.isArchived ? 'Unarchive' : 'Archive'}</button><button class="text-sm text-red-600 hover:underline delete-btn" data-id="${template.id}">Delete</button></div></div>
                            <details class="mt-4"><summary class="cursor-pointer text-sm font-semibold hover:underline flex items-center gap-1">View ${template.versions.length} Version(s) <svg class="w-4 h-4 details-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></summary><div class="p-2 border-t mt-2"><button class="text-sm font-semibold text-green-700 hover:underline add-blank-version-btn" data-id="${template.id}">+ Add Blank New Version</button></div><ul class="bg-gray-50 rounded-md border">${versionsHtml}</ul></details>`;
                        folderContainer.appendChild(item);
                    });
                }
                ui.manage.userTemplatesList.appendChild(folderContainer);
            });
            
            if (ui.manage.userTemplatesList.innerHTML === '') {
                ui.manage.userTemplatesList.innerHTML = `<p>${showArchived ? 'No archived templates.' : 'You haven\'t created any templates yet.'}</p>`;
            }

            ui.manage.userTemplatesList.querySelectorAll('.archive-btn').forEach(btn => btn.addEventListener('click', (e) => toggleArchiveTemplate(e.target.dataset.id)));
            ui.manage.userTemplatesList.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTemplate(e.target.dataset.id)));
            ui.manage.userTemplatesList.querySelectorAll('.duplicate-template-btn').forEach(btn => btn.addEventListener('click', (e) => duplicateTemplate(e.target.dataset.id)));
            ui.manage.userTemplatesList.querySelectorAll('.use-version-btn').forEach(btn => btn.addEventListener('click', (e) => useVersion(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.use-latest-btn').forEach(btn => btn.addEventListener('click', (e) => useVersion(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.edit-version-btn').forEach(btn => btn.addEventListener('click', (e) => editVersionInPlace(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.duplicate-new-version-btn').forEach(btn => btn.addEventListener('click', (e) => duplicateAsNewVersion(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.duplicate-new-template-btn').forEach(btn => btn.addEventListener('click', (e) => duplicateAsNewTemplate(e.target.dataset.id, e.target.dataset.version)));
            ui.manage.userTemplatesList.querySelectorAll('.add-blank-version-btn').forEach(btn => btn.addEventListener('click', (e) => addBlankVersion(e.target.dataset.id)));
        }

        async function duplicateTemplate(templateId) {
            let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const originalTemplate = userTemplates.find(t => t.id === templateId);
            if (!originalTemplate) return;
            const newTemplate = JSON.parse(JSON.stringify(originalTemplate));
            newTemplate.id = crypto.randomUUID();
            newTemplate.name = `Copy of ${originalTemplate.name}`;
            newTemplate.isDefault = false;
            newTemplate.createdAt = newTemplate.updatedAt = new Date().toISOString();
            userTemplates.push(newTemplate);
            await saveAndSyncTemplates(userTemplates);
        }

        // --- Import/Export ---
        function exportTemplates() {
            const data = localStorage.getItem('userTemplates') || '[]';
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `text_merge_templates_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let data = JSON.parse(e.target.result);
                    data = migrateTemplates(data);
                    if (!Array.isArray(data) || !data.every(t => t.id && t.name && t.versions)) throw new Error("Invalid template file.");
                    const merge = confirm("Merge with existing templates? (Cancel to replace)");
                    const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : [];
                    alert(`Imported ${data.length} templates.`);
                    await saveAndSyncTemplates([...existing, ...data]);
                } catch (error) { alert(`Import failed: ${error.message}`); }
            };
            reader.readAsText(file);
            ui.manage.importFileInput.value = '';
        }

        // --- Firebase Sync Logic ---
        function initializeFirebase() {
            try {
                firebaseApp = initializeApp(FIREBASE_CONFIG);
                firebaseAuth = getAuth(firebaseApp);
                firestoreDb = getFirestore(firebaseApp);
                onAuthStateChanged(firebaseAuth, async user => {
                    currentUser = user;
                    updateFirebaseAuthStatus(!!user);
                    if (user) {
                        await checkForCloudUpdates();
                        listenForTemplateChanges();
                    } else if (templatesUnsubscribe) {
                        templatesUnsubscribe();
                        templatesUnsubscribe = null;
                        loadTemplates();
                        setSyncState('unknown');
                    }
                });
            } catch (e) {
                console.error("Firebase initialization error: ", e);
                ui.sync.status.textContent = "Firebase is not configured correctly.";
            }
        }

        function handleFirebaseSignIn() { const email = ui.sync.emailInput.value, password = ui.sync.passwordInput.value; if (!email || !password) return alert("Please enter email and password."); signInWithEmailAndPassword(firebaseAuth, email, password).catch(error => alert(`Sign in failed: ${error.message}`)); }
        function handleFirebaseSignUp() { const email = ui.sync.emailInput.value, password = ui.sync.passwordInput.value; if (!email || !password) return alert("Please enter email and password."); createUserWithEmailAndPassword(firebaseAuth, email, password).catch(error => alert(`Sign up failed: ${error.message}`)); }
        function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(firebaseAuth, provider).catch(error => alert(`Google sign in failed: ${error.message}`));
        }
        function handleFirebaseSignOut() { signOut(firebaseAuth); }
        function updateFirebaseAuthStatus(isSignedIn) { ui.sync.authContainer.classList.toggle('hidden', isSignedIn); ui.sync.controls.classList.toggle('hidden', !isSignedIn); if (isSignedIn) ui.sync.authStatus.textContent = `Signed in as ${currentUser.email}`; }
        
        async function saveAndSyncTemplates(templates) {
            localStorage.setItem('userTemplates', JSON.stringify(templates));
            loadTemplates(); // Refresh UI immediately
            if (currentUser) {
                await saveToFirebase(templates);
            } else {
                setSyncState('unsynced');
            }
        }

        async function saveToFirebase(templatesToSave = null) {
            if (!currentUser) return;
            setSyncState('syncing');
            const templatesData = templatesToSave ? templatesToSave : JSON.parse(localStorage.getItem('userTemplates') || '[]');
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            try {
                await setDoc(userDocRef, { templates: templatesData, updatedAt: new Date().toISOString() });
                setSyncState('synced');
            } catch (error) {
                setSyncState('error'); console.error("Firebase save error:", error);
            }
        }

        function listenForTemplateChanges() {
            if (templatesUnsubscribe) templatesUnsubscribe();
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            templatesUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.metadata.hasPendingWrites) {
                    return;
                }
                if (docSnap.exists()) {
                    console.log("Remote data changed, checking for conflicts...");
                    checkForCloudUpdates(docSnap.data());
                }
            });
        }
        
        /**
         * Creates a deterministic (stable) string from a JavaScript object by sorting all keys recursively.
         * This is the key to preventing false-positive sync conflicts.
         */
        function deterministicStringify(obj) {
            if (obj === null || typeof obj !== 'object') {
                return JSON.stringify(obj);
            }

            if (Array.isArray(obj)) {
                const arrayBody = obj.map(deterministicStringify).join(',');
                return `[${arrayBody}]`;
            }

            const keys = Object.keys(obj).sort();
            const objectBody = keys.map(key => {
                const value = deterministicStringify(obj[key]);
                return `${JSON.stringify(key)}:${value}`;
            }).join(',');

            return `{${objectBody}}`;
        }

        /**
         * Creates a consistent hash for a template object for reliable comparison.
         */
        function createTemplateHash(template) {
            if (!template) return null;
            
            const clone = JSON.parse(JSON.stringify(template));
            
            delete clone.createdAt;
            delete clone.updatedAt;

            if (clone.versions) {
                clone.versions.sort((a, b) => a.version - b.version);
                clone.versions.forEach(v => {
                    delete v.createdAt;
                    if (v.fields) {
                        v.fields.sort((a, b) => a.name.localeCompare(b.name));
                    }
                });
            }
            
            return deterministicStringify(clone);
        }


        async function checkForCloudUpdates(remoteData = null) {
            if (!currentUser) return;
            setSyncState('syncing');
        
            try {
                if (!remoteData) {
                    const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        remoteData = docSnap.data();
                    } else {
                        console.log("No remote data found. Saving local templates to cloud.");
                        await saveToFirebase();
                        return;
                    }
                }
        
                const localTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
                const remoteTemplates = migrateTemplates(remoteData?.templates || []);
        
                const localMap = new Map(localTemplates.map(t => [t.id, t]));
                const remoteMap = new Map(remoteTemplates.map(t => [t.id, t]));
                
                let needsSync = false;
                if (localTemplates.length !== remoteTemplates.length) {
                    needsSync = true;
                }
        
                const allIds = new Set([...localMap.keys(), ...remoteMap.keys()]);
                const conflicts = [];
                const mergedTemplates = [];
        
                for (const id of allIds) {
                    const local = localMap.get(id);
                    const remote = remoteMap.get(id);
                    
                    if (local && !remote) {
                        mergedTemplates.push(local);
                        needsSync = true;
                    } else if (!local && remote) {
                        mergedTemplates.push(remote);
                        needsSync = true;
                    } else if (local && remote) {
                        if (createTemplateHash(local) === createTemplateHash(remote)) {
                            mergedTemplates.push(local);
                        } else {
                            conflicts.push({ id, local, remote });
                            needsSync = true; // A conflict also means a sync is needed after resolution
                        }
                    }
                }
        
                if (conflicts.length > 0) {
                    setSyncState('unsynced');
                    displayConflicts(conflicts, mergedTemplates.filter(t => !conflicts.find(c => c.id === t.id)));
                } else if (needsSync) {
                    await saveAndSyncTemplates(mergedTemplates);
                    console.log("No conflicts found. Local and remote data merged and synced.");
                } else {
                    console.log("Local and remote data are already in sync.");
                    setSyncState('synced');
                }
        
            } catch (error) {
                setSyncState('error');
                console.error("Error checking for cloud updates:", error);
            }
        }
        
        function displayConflicts(conflicts, nonConflictingTemplates) {
            ui.sync.conflictContainer.innerHTML = '';
            conflicts.forEach(conflict => {
                const conflictDiv = document.createElement('div');
                conflictDiv.className = 'border p-4 rounded-lg bg-gray-50';
                conflictDiv.dataset.id = conflict.id;

                const localLatestVersion = [...conflict.local.versions].sort((a,b)=>b.version-a.version)[0];
                const remoteLatestVersion = [...conflict.remote.versions].sort((a,b)=>b.version-a.version)[0];

                conflictDiv.innerHTML = `
                    <h4 class="text-lg font-bold">${conflict.local.name}</h4>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-3 border rounded-md bg-white">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="conflict_${conflict.id}" value="local" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500" checked>
                                <div class="font-semibold">
                                    Keep Local Version
                                    <span class="block text-sm font-normal">
                                        ${conflict.local.versions.length} versions. Latest is v${localLatestVersion.version}.
                                    </span>
                                </div>
                            </label>
                        </div>
                        <div class="p-3 border rounded-md bg-white">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="conflict_${conflict.id}" value="remote" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500">
                                <div class="font-semibold">
                                    Keep Cloud Version
                                     <span class="block text-sm font-normal">
                                        ${conflict.remote.versions.length} versions. Latest is v${remoteLatestVersion.version}.
                                    </span>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
                ui.sync.conflictContainer.appendChild(conflictDiv);
            });

            ui.sync.conflictModal.classList.remove('hidden');

            const resolveHandler = async (event) => {
                const button = event.currentTarget;
                button.disabled = true;
                button.innerHTML = `<svg class="animate-spin inline -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...`;
                
                const finalTemplates = [...nonConflictingTemplates];
                conflicts.forEach(conflict => {
                    const choice = document.querySelector(`input[name="conflict_${conflict.id}"]:checked`).value;
                    if (choice === 'local') {
                        finalTemplates.push(conflict.local);
                    } else {
                        finalTemplates.push(conflict.remote);
                    }
                });
                
                try {
                    await saveAndSyncTemplates(finalTemplates);
                    ui.sync.conflictModal.classList.add('hidden');
                    showNotification("Sync conflicts resolved!");
                } catch (error) {
                    console.error("Failed to resolve conflicts:", error);
                    showNotification("Error: Could not resolve conflicts. Check console.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Apply Resolutions & Sync';
                }
            };
            
            let newButton = ui.sync.resolveButton.cloneNode(true);
            ui.sync.resolveButton.parentNode.replaceChild(newButton, ui.sync.resolveButton);
            ui.sync.resolveButton = newButton;
            ui.sync.resolveButton.addEventListener('click', resolveHandler);
        }


        function setSyncState(newState) {
            syncState = newState;
            const indicator = ui.sync.indicator;
            indicator.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800');
            
            let iconHtml = '';
            switch(newState) {
                case 'synced':
                    indicator.textContent = 'Synced';
                    indicator.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'unsynced':
                    indicator.textContent = 'Unsynced Changes';
                    indicator.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'syncing':
                    iconHtml = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    indicator.innerHTML = `${iconHtml} Syncing...`;
                    indicator.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'error':
                    indicator.textContent = 'Sync Error';
                    indicator.classList.add('bg-red-100', 'text-red-800');
                    break;
                default:
                    indicator.classList.add('hidden');
            }
        }
        
        // --- Gmail Integration Logic ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: GMAIL_API_KEY,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
            });
        }
        
        function gisLoaded() {
             if (!GMAIL_CLIENT_ID || GMAIL_CLIENT_ID === 'YOUR_GMAIL_CLIENT_ID') {
                console.warn("Gmail Client ID is not set. Gmail integration will be disabled.");
                ui.sync.authorizeGmailButton.disabled = true;
                ui.sync.authorizeGmailButton.textContent = "Gmail Not Configured";
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GMAIL_CLIENT_ID,
                scope: GMAIL_SCOPES,
                callback: (tokenResponse) => {
                     if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        ui.sync.gmailAuthStatus.textContent = "Gmail access authorized successfully!";
                        ui.sync.authorizeGmailButton.disabled = true;
                        ui.sync.authorizeGmailButton.textContent = "Gmail Authorized";
                        if (ui.use.generatedTextDiv.innerText) {
                            ui.use.loadToGmailButton.classList.remove('hidden');
                        }
                    }
                },
            });
        }

        function handleAuthGmailClick() {
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function createGmailDraft() {
            const subject = ui.use.generatedSubjectInput.value;
            const body = ui.use.generatedTextDiv.innerText;

            const email = [
                `Subject: ${subject}`,
                'Content-Type: text/plain; charset="UTF-8"',
                'MIME-Version: 1.0',
                '',
                body
            ].join('\n');

            const base64EncodedEmail = btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_');

            const request = {
                'message': {
                    'raw': base64EncodedEmail
                }
            };
            
            try {
                await gapi.client.gmail.users.drafts.create({
                    'userId': 'me',
                    'resource': request
                });
                showNotification("Draft created in Gmail!");
            } catch (err) {
                console.error("Gmail API Error:", err);
                alert(`Could not create Gmail draft (Error: ${err.result.error.message}). Your authorization may have expired. Please try re-authorizing in the Sync & Settings tab.`);
            }
        }

        // --- Dark Mode Logic ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                ui.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                ui.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        };
        ui.themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
        applyTheme(localStorage.getItem('theme') || 'light');
    </script>
</body>
</html>