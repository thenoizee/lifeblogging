<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Generator</title>
    <link rel="icon" href="/favicons/envelope-open-text.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
    /* --- THEME VARIABLES --- */
    :root {
    --primary: #D946EF;
    --primary-hover: #4338ca;
    --secondary: #475569; /* Darkened from Slate-500 to Slate-600 for better readability */
    
    --bg-light: #f8fafc;
    --card-light: #ffffff;
    --text-light: #0f172a;
    
    /* CHANGED: Darkened border color for clear definition */
    --border-light: #cbd5e1; /* Slate-300 (was Slate-200) */
    --input-bg-light: #ffffff;
    
    --bg-dark: #0f172a;
    --card-dark: #1e293b;
    --text-dark: #f8fafc;
    --border-dark: #334155;
    --input-bg-dark: #0f172a;

    --bg: var(--bg-light);
    --card: var(--card-light);
    --text: var(--text-light);
    --border-color: var(--border-light);
    --input-bg: var(--input-bg-light);
    
    --moon-display: block; --sun-display: none;
}

    html.dark {
        --bg: var(--bg-dark);
        --card: var(--card-dark);
        --text: var(--text-dark);
        --border-color: var(--border-dark);
        --input-bg: var(--input-bg-dark);
        --moon-display: none; --sun-display: block;
        color-scheme: dark;
    }

    body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
    
    /* --- GENERAL UI COMPONENTS --- */
    .card, .step-card { 
        background-color: var(--card); 
        border: 1px solid var(--border-color); 
        border-radius: 0.75rem; 
        transition: all 0.2s ease-in-out; 
    }
    .btn-primary { 
        background-color: var(--primary); color: white; 
        padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; 
        transition: 0.2s; 
    }
    .btn-primary:hover { background-color: var(--primary-hover); }

    input, select, textarea {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        color: var(--text);
        border-radius: 0.5rem;
        transition: ring 0.2s, border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); /* Indigo glow */
    }

    /* --- NAVIGATION --- */
    .nav-tab {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        color: var(--secondary);
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }
    .nav-tab:hover { background-color: rgba(0,0,0,0.05); color: var(--text); }
    .dark .nav-tab:hover { background-color: rgba(255,255,255,0.05); }
    
    /* DISTINCT ACTIVE TAB */
    .nav-tab.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }

    /* --- TEMPLATE GRID (STEP 1) --- */
    #template-list-container {
    display: grid;
    /* Reduced min-width from 280px to 240px to fit smaller phones */
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
    gap: 1rem;
}
    .template-item {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        background-color: var(--card);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        height: 100%;
    }
    .template-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
    }
    .template-item.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--primary);
    }

    /* --- EMAIL CLIENT SIMULATION (STEP 3) --- */
    .email-client-window {
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    overflow: hidden; /* Clips content */
    background-color: var(--input-bg);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    max-width: 100%; /* Ensure it never exceeds parent */
    width: 100%;
}
    .email-header-bar {
        background-color: var(--bg-light);
        border-bottom: 1px solid var(--border-color);
        padding: 0.75rem 1.25rem;
    }
    .dark .email-header-bar { background-color: #1e293b; }
    .email-content-area {
    padding: 1.5rem;
    min-height: 200px;
    white-space: pre-wrap; /* Maintain formatting */
    word-break: break-word; /* CRITICAL: Forces long words to wrap */
    overflow-wrap: break-word; /* Modern browser support */
    color: var(--text);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; /* Monospace feels more 'draft' like */
}

    /* --- MANAGE TAB LAYOUT --- */
    .manage-grid { 
        display: grid; 
        grid-template-columns: 280px 1fr; 
        gap: 1.5rem; 
        height: calc(100vh - 180px); /* Fixed height for scrolling */
    }
    .manage-sidebar, .manage-editor { 
        overflow-y: auto; 
        height: 100%;
    }
    
    /* Mobile Responsive Manage Tab */
    @media (max-width: 1024px) { 
    .manage-grid { 
        display: block; /* Stack them */
        height: auto; 
    }
    .manage-sidebar { 
        display: none; /* Hidden by default on mobile */
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        max-height: 400px;
    }
    .manage-sidebar.mobile-visible {
        display: block;
    }
    /* Toggle Button Style */
    #mobile-sidebar-toggle {
        display: flex; /* Visible on mobile */
    }
}
@media (min-width: 1025px) {
    #mobile-sidebar-toggle {
        display: none !important; /* Hidden on desktop */
    }
}

/* Sticky footer for Email Preview on Mobile */
@media (max-width: 640px) {
    .email-client-window {
        display: flex;
        flex-direction: column;
        max-height: 80vh; /* Prevent it from being taller than screen */
    }
    .email-content-area {
        overflow-y: auto; /* Allow internal scrolling */
        flex-grow: 1;
    }
    .email-client-window .bg-gray-50.border-t {
        position: sticky;
        bottom: 0;
        z-index: 10;
        background-color: var(--card); /* Ensure background isn't transparent */
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
    }
}

    /* --- DRAGGABLE PLACEHOLDERS --- */
    .placeholder-tag {
        cursor: grab;
        user-select: none;
        transition: transform 0.1s;
    }
    .placeholder-tag:active { cursor: grabbing; transform: scale(0.95); }

    /* --- UTILS --- */
    summary { list-style: none; cursor: pointer; }
    summary::-webkit-details-marker { display: none; }
    .details-arrow { transition: transform 0.2s; }
    details[open] > summary .details-arrow { transform: rotate(90deg); }
    
    /* Scrollbar Polish */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--secondary); }
</style>
</head>
<body>

    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        Copied to clipboard!
    </div>
    
    <div id="sync-conflict-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-[var(--card-bg-color)]">
            <div class="mt-3">
                <h3 class="text-2xl leading-6 font-medium text-center">Sync Conflict Detected</h3>
                <div class="mt-4 px-2 py-3">
                    <p class="text-sm text-[var(--text-secondary)] mb-6 text-center">
                        Your local templates differ from the ones stored in the cloud. For each item below, please choose which version you'd like to keep.
                    </p>
                    <div id="conflict-resolution-container" class="space-y-4 text-left max-h-[60vh] overflow-y-auto pr-2">
                        </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 space-y-2">
                    <button id="keep-all-cloud-button" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Keep All Cloud Versions
                    </button>
                    <button id="resolve-conflicts-button" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-75 disabled:cursor-wait">
                        Apply Custom Resolutions & Sync
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto max-w-5xl">
        <header class="sticky top-0 bg-[var(--card)] shadow-lg z-30 mb-6">
    <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <a href="/" class="btn-primary text-xs flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Hub
                </a>
                <a href="#" class="flex items-center space-x-2 text-xl font-bold text-[var(--primary)]">
                    <i class="fa-solid fa-envelope-open-text"></i>
                    <span class="tracking-tight">Text Generator</span>
                </a>
                
                <nav class="hidden md:flex space-x-1 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                    <button class="nav-tab active text-sm" data-tab="use-templates"><i class="fa-solid fa-play mr-1"></i> Use</button>
                    <button class="nav-tab text-sm" data-tab="batch-generate"><i class="fa-solid fa-layer-group mr-1"></i> Batch</button>
                    <button class="nav-tab text-sm" data-tab="manage-templates"><i class="fa-solid fa-pen-to-square mr-1"></i> Manage</button>
                    <button class="nav-tab text-sm" data-tab="sync-settings"><i class="fa-solid fa-gear mr-1"></i> Settings</button>
                </nav>
            </div>

            <div class="flex items-center gap-3">
                <div id="sync-status-indicator" class="text-xs font-bold hidden items-center gap-1"></div>
                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400">
                    <i class="fa-solid fa-moon" style="display: var(--moon-display)"></i>
                    <i class="fa-solid fa-sun" style="display: var(--sun-display)"></i>
                </button>
            </div>
        </div>
        <nav class="flex md:hidden mt-3 space-x-2 overflow-x-auto pb-2">
             <button class="nav-tab active whitespace-nowrap text-xs" data-tab="use-templates">Use</button>
             <button class="nav-tab whitespace-nowrap text-xs" data-tab="batch-generate">Batch</button>
             <button class="nav-tab whitespace-nowrap text-xs" data-tab="manage-templates">Manage</button>
             <button class="nav-tab whitespace-nowrap text-xs" data-tab="sync-settings">Settings</button>
        </nav>
    </div>
</header>

        

        <div id="tab-content-use-templates">
            <div class="space-y-4">
                <details id="step-1-details" class="step-card rounded-lg shadow-md" open>
                    <summary class="text-2xl font-semibold cursor-pointer p-6 flex justify-between items-center">
                        <span>Step 1: Choose a Template</span>
                        <svg class="w-6 h-6 details-arrow text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="p-6 pt-0 border-t border-[var(--border-color)]">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <h3 class="text-lg font-medium mb-2">Folders</h3>
                                <div id="folder-list-container" class="space-y-1"></div>
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-medium">Templates</h3>
                                    <input type="search" id="template-search-input" placeholder="Search templates..." class="px-3 py-1.5 text-sm w-1/2">
                                </div>
                                <div id="template-list-container" class="space-y-2 max-h-72 overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                        <div id="version-select-container" class="hidden mt-4 pt-4 border-t border-[var(--border-color)]">
                            <label for="version-select" class="block text-sm font-medium mb-1">Select a version</label>
                            <select id="version-select" class="w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div class="mt-4 pt-4 border-t border-[var(--border-color)] grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="pronoun-preset" class="block text-sm font-medium mb-1">Pronoun Presets</label>
                                <select id="pronoun-preset" class="w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">None</option>
                                    <option value="male">Male (he/him/his/himself)</option>
                                    <option value="female">Female (she/her/hers/herself)</option>
                                    <option value="neutral">Neutral (they/them/theirs/themself)</option>
                                </select>
                            </div>
                            <div>
                                <label for="scheduled-time" class="block text-sm font-medium mb-1">Scheduled Time (for Greeting)</label>
                                <input type="time" id="scheduled-time" class="w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>
                </details>

                <details id="step-2-details" class="step-card rounded-lg shadow-md">
                     <summary class="text-2xl font-semibold cursor-pointer p-6 flex justify-between items-center">
                        <span>Step 2: Fill in the Details</span>
                         <svg class="w-6 h-6 details-arrow text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="p-6 pt-0 border-t border-[var(--border-color)]">
                        <div id="fields-container" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                            <p class="col-span-full text-[var(--text-secondary)]">Please select a template first.</p>
                        </div>
                    </div>
                </details>
                
                <details id="step-3-details" class="step-card rounded-lg shadow-md">
    <summary class="text-2xl font-semibold cursor-pointer p-6 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-t-lg transition">
        <span>Step 3: Preview & Copy</span>
        <svg class="w-6 h-6 details-arrow text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
    </summary>
    
    <div class="p-6 pt-0 border-t border-[var(--border-color)]">
        <div class="py-6 flex justify-center">
            <button id="generate-button" class="group relative w-full sm:w-auto bg-indigo-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-indigo-700 shadow-lg hover:shadow-indigo-500/30 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-200 text-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none" disabled>
                <span class="flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Email
                </span>
            </button>
        </div>

        <div id="generated-text-container" class="space-y-6 opacity-50 transition-opacity duration-500">
            <div class="email-client-window border-2 border-[var(--border-color)] rounded-xl overflow-hidden shadow-sm">
                <div class="bg-gray-100 dark:bg-slate-800 px-4 py-2 border-b border-[var(--border-color)] flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400 border border-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400 border border-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400 border border-green-500"></div>
                </div>

                <div id="generated-subject-wrapper" class="hidden email-header-bar flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-slate-900 border-b border-[var(--border-color)]">
                    <div class="w-full">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Subject</span>
                        <input type="text" id="generated-subject" class="w-full bg-transparent border-none text-lg font-semibold text-[var(--text)] focus:ring-0 p-0" readonly placeholder="(No Subject)">
                    </div>
                    <button type="button" id="copy-subject-button" class="shrink-0 text-sm font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1.5 rounded-md transition border border-indigo-200 dark:border-indigo-800">
                        <i class="fa-regular fa-copy mr-1"></i> Copy
                    </button>
                </div>

                <div class="relative bg-[var(--input-bg)]">
                     <div id="generated-text" class="email-content-area p-6 min-h-[200px] whitespace-pre-wrap" contenteditable="true"></div>
                </div>
                
                <div class="bg-gray-50 dark:bg-slate-800/50 p-4 border-t border-[var(--border-color)] flex flex-col sm:flex-row justify-end gap-3">
                    <button id="copy-body-button" class="w-full sm:w-auto bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold py-2.5 px-6 rounded-lg hover:opacity-90 transition shadow-md flex items-center justify-center gap-2">
                        <i class="fa-regular fa-copy"></i> Copy Body
                    </button>
                    <button id="load-to-gmail-button" class="hidden w-full sm:w-auto bg-red-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-red-700 transition shadow-md flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i> Gmail
                    </button>
                </div>
            </div>
        </div>
    </div>
</details>
            </div>
        </div>
        
        <div id="tab-content-batch-generate" class="hidden">
             <div class="space-y-8">
                <div class="step-card p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Batch Generate from CSV</h2>
                    <p class="mb-4 text-[var(--text-secondary)]">Upload a CSV file where the column headers match the placeholders of your chosen template (e.g., a column named 'Name' for the {{Name}} placeholder).</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="batch-template-select" class="block text-sm font-medium mb-1">1. Select Template to Use</label>
                            <select id="batch-template-select" class="w-full px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="csv-file-input" class="block text-sm font-medium mb-1">2. Upload CSV File</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="batch-generate-button" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out text-lg">
                            Generate All
                        </button>
                    </div>
                </div>
                 <div id="batch-output-container" class="hidden step-card p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Generated Output</h2>
                     <div id="batch-output" class="space-y-6"></div>
                 </div>
            </div>
        </div>

<div id="tab-content-manage-templates" class="hidden">
    <div class="mb-4 lg:hidden">
        <button id="mobile-sidebar-toggle" class="w-full flex justify-between items-center bg-[var(--card)] border border-[var(--border-color)] px-4 py-3 rounded-lg font-semibold shadow-sm">
            <span><i class="fa-solid fa-list mr-2"></i> Show Template List</span>
            <i class="fa-solid fa-chevron-down transition-transform" id="sidebar-chevron"></i>
        </button>
    </div>

    <div class="manage-grid">
        <div id="manage-sidebar" class="manage-sidebar card p-4 flex flex-col h-full">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">Templates</h3>
        <button onclick="document.getElementById('template-form').reset(); window.cancelEdit();" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
            <i class="fa-solid fa-plus"></i> New
        </button>
    </div>
    
    <div class="flex items-center gap-2 mb-3">
         <div class="relative flex-grow">
            <i class="fa-solid fa-search absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
            <input type="text" id="manager-search" placeholder="Filter..." class="w-full text-sm pl-7 pr-2 py-1.5 rounded border border-[var(--border-color)] bg-[var(--input-bg)] focus:ring-1 focus:ring-indigo-500">
         </div>
         <label class="flex items-center justify-center w-8 h-8 rounded border border-[var(--border-color)] bg-[var(--card)] cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition" title="Show Archived Templates">
            <input type="checkbox" id="show-archived-toggle" class="hidden peer">
            <i class="fa-solid fa-box-archive text-gray-400 peer-checked:text-indigo-600"></i>
         </label>
    </div>

    <div id="user-templates-list" class="space-y-2 flex-grow overflow-y-auto pr-1"></div>
    
    <div class="mt-4 pt-4 border-t border-[var(--border-color)] flex gap-2 justify-center">
         <button id="import-button" class="text-xs bg-gray-200 dark:bg-gray-700 dark:text-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 transition">Import</button>
         <button id="export-button" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition">Export</button>
         <input type="file" id="import-file-input" class="hidden" accept=".json">
    </div>
</div>

        <div class="manage-editor card p-6 h-full overflow-y-auto">
             <div class="flex flex-col h-full">
                <div class="flex justify-between items-center mb-4 border-b border-[var(--border-color)] pb-2">
                    <h2 id="form-title" class="text-xl font-bold">Create New Template</h2>
                    <div class="flex gap-2">
                         <button type="button" id="cancel-edit-button" class="hidden px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Cancel</button>
                         <button type="submit" form="template-form" id="save-template-button" class="px-4 py-1 text-sm bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow-md">Save</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow">
                    <form id="template-form" class="space-y-4">
                        <input type="hidden" id="template-edit-id">
                        <input type="hidden" id="template-edit-version">
                        <input type="hidden" id="template-save-mode">
                        
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Name & Folder</label>
                            <div class="flex gap-2">
                                <input type="text" id="template-name" class="w-full p-2 text-sm" placeholder="e.g. Monthly Report" required>
                                <input type="text" id="template-folder" class="w-1/2 p-2 text-sm" placeholder="Folder" list="folder-suggestions">
                                <datalist id="folder-suggestions"></datalist>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Subject Line</label>
                            <input type="text" id="template-subject" class="w-full p-2 text-sm" placeholder="e.g. Update for {{Name}}">
                        </div>

                        <div id="interactive-placeholders-wrapper" class="hidden my-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-md border border-blue-100 dark:border-blue-800 transition-all">
                            <p class="text-[10px] font-bold text-blue-600 dark:text-blue-400 mb-2 uppercase tracking-wider">
                                <i class="fa-solid fa-tags mr-1"></i> Available Placeholders (Drag or Double-Click)
                            </p>
                            <div id="interactive-placeholders-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Body Content</label>
                            <textarea id="template-body" rows="12" class="w-full p-3 text-sm font-mono leading-relaxed bg-[var(--input-bg)] text-[var(--text)] border border-[var(--border-color)] rounded" placeholder="Hi {{Name}}..." required></textarea>
                            <div class="text-xs text-gray-400 mt-1 flex justify-between">
                                <span>Use {{Placeholders}}</span>
                                <button type="button" id="add-field-button" class="text-blue-500 hover:underline font-bold">+ Define Field</button>
                            </div>
                        </div>
                        
                        <div id="dynamic-fields-container" class="space-y-2 pl-2 border-l-2 border-gray-200 dark:border-gray-700"></div>
                    </form>

                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-[var(--border-color)] p-4 flex flex-col h-full mt-6 lg:mt-0">
                        <h4 class="text-xs font-bold uppercase text-gray-500 mb-3"><i class="fa-solid fa-eye"></i> Live Preview</h4>
                        <div class="space-y-3 flex-grow">
                            <div class="bg-[var(--card)] border border-[var(--border-color)] p-2 rounded text-sm font-medium text-gray-700 dark:text-gray-300">
                                <span class="text-gray-400 text-xs mr-2">Subject:</span> <span id="preview-subject">...</span>
                            </div>
                            <div id="preview-body" class="bg-[var(--card)] border border-[var(--border-color)] p-4 rounded text-sm whitespace-pre-wrap h-64 lg:h-[calc(100%-60px)] overflow-y-auto font-mono">
                                Start typing to see preview...
                            </div>
                        </div>
                    </div>
                </div>
                <p id="save-status" class="text-sm mt-2 text-green-600 font-bold text-center"></p>
             </div>
        </div>
    </div>
</div>            
        
        
        <div id="tab-content-sync-settings" class="hidden space-y-8">
            <div class="step-card p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Sync with Firebase</h2>
                <div id="firebase-auth-container">
                    <p class="mb-4 text-[var(--text-secondary)]">Sign in to sync your templates across devices.</p>
                    <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                        <div class="flex-grow"><label for="firebase-email" class="block text-sm font-medium mb-1">Email</label><input type="email" id="firebase-email" class="w-full px-3 py-2 shadow-sm" placeholder="your@email.com"></div>
                        <div class="flex-grow"><label for="firebase-password" class="block text-sm font-medium mb-1">Password</label><input type="password" id="firebase-password" class="w-full px-3 py-2 shadow-sm" placeholder="••••••••"></div>
                        <div class="flex gap-2"><button id="firebase-signin-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Sign In</button><button id="firebase-signup-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Sign Up</button></div>
                    </div>
                     <div class="mt-4"><button id="google-signin-button" class="bg-white border text-gray-700 dark:bg-gray-200 dark:text-gray-900 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 dark:hover:bg-gray-300 w-full">Sign in with Google</button></div>
                </div>
                <div id="firebase-sync-controls" class="hidden mt-6 space-y-4">
                    <p id="firebase-auth-status" class="text-sm text-green-600"></p>
                    <div class="flex flex-col sm:flex-row gap-4"><button id="firebase-sync-button" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Check for Cloud Updates</button></div>
                    <button id="firebase-signout-button" class="text-sm text-red-600 hover:underline">Sign Out</button>
                </div>
                <p id="firebase-status" class="text-sm mt-4"></p>
            </div>

            <div class="step-card p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b border-[var(--border-color)] pb-3">Gmail Integration</h2>
                <p class="mb-4 text-[var(--text-secondary)]">Authorize this application to create drafts in your Gmail account.</p>
                <button id="authorize-gmail-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Authorize Gmail Access</button>
                <p id="gmail-auth-status" class="text-sm mt-3 text-green-600"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { changelogData } from '/changelog-data.js';
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3",
        };
        
        const GMAIL_API_KEY = 'YOUR_GMAIL_API_KEY';
        const GMAIL_CLIENT_ID = 'YOUR_GMAIL_CLIENT_ID';
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.compose';

        let tokenClient;

        const defaultTemplates = [
             {
                id: "default-positive-review", name: "Positive Progress Review", folder: "Education", isArchived: false, isDefault: true,
                versions: [{ version: 1, createdAt: new Date('2023-01-01T10:00:00Z').toISOString(), updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(), subject: "An update on {{Name}}'s progress in {{Subject}}", description: "A standard positive review for a student making good progress.", target: "Parents/Guardians", purpose: "To inform and praise.", fields: [{name: "Name", desc: "Student's full name", type: "text"}, {name: "Subject", desc: "The academic subject", type: "text"}, {name: "Tutor", desc: "Tutor's name", type: "text"}], template: "{{Greeting}},\n\nThis is a review of {{Name}}'s progress in {{Subject}}.\n\nI am pleased to report that {{Name}} is making excellent progress. {{Pronoun_he_she_they}} consistently demonstrates a strong understanding of the core concepts and actively participates in class discussions.\n\n{{Pronoun_his_her_their}} work is always completed to a high standard, and {{Pronoun_he_she_they}} shows great enthusiasm for the subject. It is a pleasure to have {{Name}} in my class.\n\nRegards,\n{{Tutor}}"}]
            },
            {
                id: "default-needs-improvement", name: "Needs Improvement Review", folder: "Education", isArchived: false, isDefault: true,
                versions: [{ version: 1, createdAt: new Date('2023-01-01T10:00:00Z').toISOString(), updatedAt: new Date('2023-01-01T10:00:00Z').toISOString(), subject: "Update regarding {{Name}} in {{Subject}}", description: "Highlights an area of concern and suggests next steps.", target: "Parents/Guardians", purpose: "To inform and seek support.", fields: [{name: "Name", desc: "", type: "text"}, {name: "Subject", desc: "", type: "text"}, {name: "Year_Group", desc: "", type: "text"}, {name: "Tutor", desc: "", type: "text"}, {name: "Specific_Area", desc: "e.g., Algebra, Punctuation", type: "text"}], template: "{{Greeting}},\n\nThis is an update regarding {{Name}} in Year {{Year_Group}} {{Subject}}.\n\nWhile {{Name}} has a foundational understanding of the subject, there are areas that require more focus. Specifically, {{Pronoun_he_she_they}} is finding {{Specific_Area}} challenging and would benefit from additional practice.\n\nI encourage {{Name}} to ask more questions in class and attend support sessions to improve {{Pronoun_his_her_their}} confidence and skills in this area. We will continue to provide support in school.\n\nRegards,\n{{Tutor}}"}]
            }
        ];
        
        const PRONOUN_PLACEHOLDERS = {
            'Pronoun_he_she_they': 'Subjective pronoun (e.g., he, she, they)',
            'Pronoun_him_her_them': 'Objective pronoun (e.g., him, her, them)',
            'Pronoun_his_her_their': 'Possessive pronoun (e.g., his, her, their)',
            'Pronoun_himself_herself_themself': 'Reflexive pronoun (e.g., himself, herself, themself)'
        };

        let allTemplates = [];
        let currentTemplateVersion = null;
        let syncState = 'unknown'; 
        let firebaseApp, firebaseAuth, firestoreDb;
        let currentUser = null;
        let templatesUnsubscribe = null;
        let themeUnsubscribe = null;
        let showArchived = false;

        let selectedFolder = 'All';
        let selectedTemplateId = null;

        const ui = {
            tabs: { buttons: document.querySelectorAll('.nav-tab'), contents: { 'use-templates': document.getElementById('tab-content-use-templates'), 'batch-generate': document.getElementById('tab-content-batch-generate'), 'manage-templates': document.getElementById('tab-content-manage-templates'), 'sync-settings': document.getElementById('tab-content-sync-settings') }},
            use: { 
                step1Details: document.getElementById('step-1-details'),
                step2Details: document.getElementById('step-2-details'),
                step3Details: document.getElementById('step-3-details'),
                pronounPreset: document.getElementById('pronoun-preset'), 
                scheduledTimeInput: document.getElementById('scheduled-time'), 
                folderListContainer: document.getElementById('folder-list-container'),
                templateListContainer: document.getElementById('template-list-container'),
                templateSearchInput: document.getElementById('template-search-input'),
                versionSelectContainer: document.getElementById('version-select-container'), 
                versionSelect: document.getElementById('version-select'), 
                fieldsContainer: document.getElementById('fields-container'), 
                generateButton: document.getElementById('generate-button'), 
                generatedTextContainer: document.getElementById('generated-text-container'), 
                generatedSubjectWrapper: document.getElementById('generated-subject-wrapper'), 
                generatedSubjectInput: document.getElementById('generated-subject'), 
                generatedTextDiv: document.getElementById('generated-text'), 
                copySubjectButton: document.getElementById('copy-subject-button'), 
                copyBodyButton: document.getElementById('copy-body-button'), 
                loadToGmailButton: document.getElementById('load-to-gmail-button') 
            },
            manage: { form: document.getElementById('template-form'), formTitle: document.getElementById('form-title'), nameInput: document.getElementById('template-name'), folderInput: document.getElementById('template-folder'), folderSuggestions: document.getElementById('folder-suggestions'), subjectInput: document.getElementById('template-subject'), descriptionInput: document.getElementById('template-description'), targetInput: document.getElementById('template-target'), purposeInput: document.getElementById('template-purpose'), fieldsContainer: document.getElementById('dynamic-fields-container'), addFieldButton: document.getElementById('add-field-button'), placeholdersWrapper: document.getElementById('interactive-placeholders-wrapper'), placeholdersContainer: document.getElementById('interactive-placeholders-container'), bodyTextarea: document.getElementById('template-body'), editIdInput: document.getElementById('template-edit-id'), editVersionInput: document.getElementById('template-edit-version'), saveModeInput: document.getElementById('template-save-mode'), userTemplatesList: document.getElementById('user-templates-list'), cancelEditButton: document.getElementById('cancel-edit-button'), saveStatus: document.getElementById('save-status'), exportButton: document.getElementById('export-button'), importButton: document.getElementById('import-button'), importFileInput: document.getElementById('import-file-input'), showArchivedToggle: document.getElementById('show-archived-toggle') },
            batch: { templateSelect: document.getElementById('batch-template-select'), csvFileInput: document.getElementById('csv-file-input'), generateButton: document.getElementById('batch-generate-button'), outputContainer: document.getElementById('batch-output-container'), output: document.getElementById('batch-output') },
            sync: { 
                indicator: document.getElementById('sync-status-indicator'), 
                authContainer: document.getElementById('firebase-auth-container'), 
                controls: document.getElementById('firebase-sync-controls'), 
                emailInput: document.getElementById('firebase-email'), 
                passwordInput: document.getElementById('firebase-password'), 
                signinButton: document.getElementById('firebase-signin-button'), 
                signupButton: document.getElementById('firebase-signup-button'), 
                googleSigninButton: document.getElementById('google-signin-button'),
                signoutButton: document.getElementById('firebase-signout-button'), 
                authStatus: document.getElementById('firebase-auth-status'), 
                syncButton: document.getElementById('firebase-sync-button'), 
                status: document.getElementById('firebase-status'),
                conflictModal: document.getElementById('sync-conflict-modal'),
                conflictContainer: document.getElementById('conflict-resolution-container'),
                resolveButton: document.getElementById('resolve-conflicts-button'),
                keepAllCloudButton: document.getElementById('keep-all-cloud-button'),
                authorizeGmailButton: document.getElementById('authorize-gmail-button'),
                gmailAuthStatus: document.getElementById('gmail-auth-status')
            },
            versionDisplay: document.getElementById('version-display'),
            notification: document.getElementById('notification'),
            themeToggle: document.getElementById('theme-toggle')
        };

                    // Add listener to update preview immediately
const updateManagerPreview = () => {
    const subject = ui.manage.subjectInput.value || '';
    const body = ui.manage.bodyTextarea.value || '';
    
    // Simple placeholder highlighting for preview
    const highlight = (text) => text.replace(/{{(.*?)}}/g, '<span class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-1 rounded">{{$1}}</span>');
    
    document.getElementById('preview-subject').innerHTML = highlight(subject);
    document.getElementById('preview-body').innerHTML = highlight(body) || '<span class="text-gray-400 italic">Start typing...</span>';
};
        
        window.onload = function() {
            loadTemplates();
            setupTabs();

// Mobile Sidebar Toggle Logic
const toggleBtn = document.getElementById('mobile-sidebar-toggle');
const sidebar = document.getElementById('manage-sidebar');
const chevron = document.getElementById('sidebar-chevron');

if (toggleBtn && sidebar) {
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-visible');
        // Rotate chevron
        if (sidebar.classList.contains('mobile-visible')) {
            chevron.style.transform = 'rotate(180deg)';
            toggleBtn.querySelector('span').innerHTML = '<i class="fa-solid fa-list mr-2"></i> Hide Template List';
        } else {
            chevron.style.transform = 'rotate(0deg)';
            toggleBtn.querySelector('span').innerHTML = '<i class="fa-solid fa-list mr-2"></i> Show Template List';
        }
    });
}



ui.manage.subjectInput.addEventListener('input', updateManagerPreview);
ui.manage.bodyTextarea.addEventListener('input', updateManagerPreview);
            
            ui.use.pronounPreset.addEventListener('change', () => {
                applyPronounPreset();
                liveGenerateText();
            });
            ui.use.scheduledTimeInput.addEventListener('input', () => {
                handleScheduledTimeChange();
                liveGenerateText();
            });
            ui.use.templateSearchInput.addEventListener('input', () => renderTemplateList(ui.use.templateSearchInput.value));
            ui.use.versionSelect.addEventListener('change', loadSelectedVersion);
            ui.use.generateButton.addEventListener('click', generateText);
            ui.use.copyBodyButton.addEventListener('click', () => copyToClipboard(ui.use.generatedTextDiv.innerText, "Body copied!"));
            ui.use.copySubjectButton.addEventListener('click', () => copyToClipboard(ui.use.generatedSubjectInput.value, "Subject copied!"));
            ui.use.loadToGmailButton.addEventListener('click', createGmailDraft);
            
            // Add live update listener
            ui.use.fieldsContainer.addEventListener('input', liveGenerateText);
            
            ui.manage.form.addEventListener('submit', handleSaveTemplate);
            ui.manage.cancelEditButton.addEventListener('click', cancelEdit);
            ui.manage.addFieldButton.addEventListener('click', () => addFieldInputRow({name: '', desc: '', type: 'text', options: ''}));
            ui.manage.exportButton.addEventListener('click', exportTemplates);
            ui.manage.importButton.addEventListener('click', () => ui.manage.importFileInput.click());
            ui.manage.importFileInput.addEventListener('change', handleImportFile);
            // FIXED: Check if element exists before adding listener
if (ui.manage.showArchivedToggle) {
    ui.manage.showArchivedToggle.addEventListener('change', (e) => {
        showArchived = e.target.checked; renderTemplateManager();
    });
}

// Ensure the manager search listener is also safe
const managerSearch = document.getElementById('manager-search');
if (managerSearch) {
    managerSearch.addEventListener('input', (e) => {
        // CHANGED: Now passes the input value to the render function
        renderTemplateManager(e.target.value); 
    });
}
            ui.batch.generateButton.addEventListener('click', handleBatchGenerate);
            
            ui.sync.signinButton.addEventListener('click', handleFirebaseSignIn);
            ui.sync.signupButton.addEventListener('click', handleFirebaseSignUp);
            ui.sync.googleSigninButton.addEventListener('click', handleGoogleSignIn);
            ui.sync.signoutButton.addEventListener('click', handleFirebaseSignOut);
            ui.sync.syncButton.addEventListener('click', checkForCloudUpdates);
            ui.sync.authorizeGmailButton.addEventListener('click', handleAuthGmailClick);
            ui.sync.keepAllCloudButton.addEventListener('click', () => {
                document.querySelectorAll('#sync-conflict-modal input[name^="conflict_"][value="remote"]').forEach(radio => {
                    radio.checked = true;
                });
                ui.sync.resolveButton.click();
            });

            ui.manage.bodyTextarea.addEventListener('dragover', e => e.preventDefault());
            ui.manage.bodyTextarea.addEventListener('drop', handleDrop);
            
            setupDragAndDrop();

            initializeFirebase();
            if (ui.versionDisplay) {
                const latestChangelog = changelogData[0];
                const lastUpdatedDate = new Date(latestChangelog.date);
                const formattedDate = lastUpdatedDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                ui.versionDisplay.textContent = `Version ${latestChangelog.version} | Last Updated: ${formattedDate}`;
                ui.versionDisplay.classList.add('text-gray-500', 'dark:text-gray-400');
            }

            if (GMAIL_API_KEY === 'YOUR_GMAIL_API_KEY') {
                ui.sync.authorizeGmailButton.disabled = true;
                ui.sync.authorizeGmailButton.textContent = "Gmail Integration Disabled";
            } else {
                gapiLoaded();
                gisLoaded();
            }
        };

        function sanitizeForId(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/[^a-zA-Z0-9\-_]/g, '_');
        }
        
        function setupTabs() {
            ui.tabs.buttons.forEach(button => button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab)));
            switchTab('use-templates');
        }

        function switchTab(activeTab) {
    // 1. Hide all tab content
    Object.values(ui.tabs.contents).forEach(content => {
        if (content) content.classList.add('hidden');
    });

    // 2. Show the selected tab content
    if (ui.tabs.contents[activeTab]) {
        ui.tabs.contents[activeTab].classList.remove('hidden');
    }

    // 3. Update the visual "active" state on the buttons
    // We re-query here to ensure we catch both mobile and desktop buttons
    document.querySelectorAll('.nav-tab').forEach(button => {
        if (button.dataset.tab === activeTab) {
            button.classList.add('active');
            // Optional: Add specific active styling class if 'active' class isn't enough
             button.classList.add('text-indigo-600', 'bg-indigo-50', 'dark:bg-indigo-900/20', 'dark:text-indigo-300');
        } else {
            button.classList.remove('active');
            button.classList.remove('text-indigo-600', 'bg-indigo-50', 'dark:bg-indigo-900/20', 'dark:text-indigo-300');
        }
    });
}
        
        function migrateTemplates(templates) {
            if (!Array.isArray(templates)) return [];
            return templates.map(t => {
                if (t.versions && t.versions[0].fields && typeof t.versions[0].fields[0] === 'object' && 'type' in t.versions[0].fields[0]) return t;
                const { name, folder, subject, description, target, purpose, fields, template, createdAt, updatedAt, isDefault, isArchived } = t;
                const newVersions = (t.versions || [{ subject, description, target, purpose, fields, template, createdAt }]).map(v => ({
                    ...v,
                    fields: Array.isArray(v.fields) ? v.fields.map(f => typeof f === 'string' ? { name: f, desc: '', type: 'text' } : {...f, type: f.type || 'text'}) : []
                }));
                return { id: t.id || crypto.randomUUID(), name: name || "Untitled Template", folder: folder || "", isArchived: isArchived || false, isDefault: isDefault || false, createdAt: createdAt || new Date().toISOString(), updatedAt: updatedAt || new Date().toISOString(), versions: newVersions };
            });
        }
        
        function loadTemplates() {
            let userTemplates = [];
            try { 
                const rawData = localStorage.getItem('userTemplates') || '[]';
                userTemplates = migrateTemplates(JSON.parse(rawData));
                localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            } catch (e) { console.error("Error parsing or migrating user templates:", e); }
            
            allTemplates = [...defaultTemplates.map(t => ({...t, versions: migrateTemplates([t])[0].versions })), ...userTemplates];
            
            renderFolderList();
            renderTemplateList();
            populateBatchTemplateSelector();
            renderTemplateManager();
        }
        
        function renderFolderList() {
            const folders = ['All', ...new Set(allTemplates.filter(t => !t.isArchived).map(t => t.folder || 'Uncategorized').filter(Boolean))];
            ui.use.folderListContainer.innerHTML = '';
            folders.sort().forEach(folder => {
                const item = document.createElement('div');
                item.className = `folder-item cursor-pointer p-2 rounded-md transition-colors ${selectedFolder === folder ? 'active' : ''}`;
                item.textContent = folder;
                item.dataset.folder = folder;
                item.addEventListener('click', () => {
                    selectedFolder = folder;
                    selectedTemplateId = null;
                    resetSelectionUI();
                    renderFolderList();
                    renderTemplateList();
                });
                ui.use.folderListContainer.appendChild(item);
            });

            ui.manage.folderSuggestions.innerHTML = '';
            folders.filter(f => f !== 'All').forEach(folder => {
                const option = document.createElement('option');
                option.value = folder;
                ui.manage.folderSuggestions.appendChild(option);
            });
        }

        function renderTemplateList(searchTerm = '') {
    const container = ui.use.templateListContainer;
    container.innerHTML = '';
    const filtered = allTemplates.filter(t => {
        const folderMatch = selectedFolder === 'All' || (t.folder || 'Uncategorized') === selectedFolder;
        const searchMatch = !searchTerm || t.name.toLowerCase().includes(searchTerm.toLowerCase());
        return !t.isArchived && folderMatch && searchMatch;
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="col-span-full text-center py-10 text-[var(--secondary)]"><i class="fa-solid fa-folder-open text-4xl mb-3 opacity-50"></i><p>No templates found.</p></div>`;
        return;
    }

    filtered.forEach(template => {
        const item = document.createElement('div');
        item.className = `template-item group relative ${selectedTemplateId === template.id ? 'active' : ''}`;
        item.dataset.id = template.id;
        
        const latestVersion = template.versions.sort((a,b) => b.version - a.version)[0];
        
        // Improved Labels: Darker text for readability
        let targetTag = '';
        if (latestVersion.target) {
            const colors = [
                'bg-blue-100 text-blue-900 border-blue-200', 
                'bg-green-100 text-green-900 border-green-200', 
                'bg-purple-100 text-purple-900 border-purple-200', 
                'bg-orange-100 text-orange-900 border-orange-200'
            ];
            const colorClass = colors[template.name.length % colors.length];
            targetTag = `<span class="text-[10px] font-bold uppercase tracking-wider ${colorClass} border px-2 py-1 rounded-full whitespace-nowrap">${latestVersion.target}</span>`;
        }

        item.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 pr-2">
                        <h4 class="font-bold text-lg leading-tight text-[var(--text)] group-hover:text-indigo-600 transition-colors">${template.name}</h4>
                    </div>
                    ${template.isDefault ? '<i class="fa-solid fa-star text-yellow-400" title="Default"></i>' : ''}
                </div>
                <p class="text-sm text-[var(--secondary)] line-clamp-2 mb-4">${latestVersion.description || 'No description available.'}</p>
            </div>
            <div class="flex flex-wrap justify-between items-center mt-auto pt-3 border-t border-[var(--border-color)] gap-2">
                <span class="text-xs text-[var(--secondary)] font-mono bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded">v${latestVersion.version}</span>
                ${targetTag}
            </div>
        `;
        item.addEventListener('click', () => {
            handleTemplateSelection(template.id);
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('active'));
            item.classList.add('active');
        });
        container.appendChild(item);
    });
}

        function handleTemplateSelection(templateId) {
    selectedTemplateId = templateId;
    
    // We don't re-render the whole list here to avoid losing scroll position/focus animation
    // Instead we just handle the data loading
    
    const templateFamily = allTemplates.find(t => t.id === templateId);
    if (!templateFamily || !templateFamily.versions || templateFamily.versions.length === 0) return;

    // Populate Version Select
    ui.use.versionSelect.innerHTML = '';
    [...templateFamily.versions].sort((a, b) => b.version - a.version).forEach((v, index) => {
        const option = document.createElement('option');
        option.value = v.version;
        option.textContent = `Version ${v.version}${index === 0 ? ' (Latest)' : ''}`;
        ui.use.versionSelect.appendChild(option);
    });
    ui.use.versionSelectContainer.classList.remove('hidden');
    
    // Load Data
    loadSelectedVersion();
    
    // UI Transitions
    ui.use.step2Details.open = true;
    
    // Smooth Scroll to Step 2
    setTimeout(() => {
        ui.use.step2Details.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Highlight Step 2 header briefly
        ui.use.step2Details.querySelector('summary').classList.add('bg-indigo-50', 'dark:bg-indigo-900/20');
        setTimeout(() => ui.use.step2Details.querySelector('summary').classList.remove('bg-indigo-50', 'dark:bg-indigo-900/20'), 1000);
    }, 100);
}

        function resetSelectionUI() {
            ui.use.versionSelectContainer.classList.add('hidden');
            ui.use.fieldsContainer.innerHTML = '<p class="col-span-full text-[var(--text-secondary)]">Please select a template first.</p>';
            ui.use.generateButton.disabled = true;
            ui.use.generatedTextDiv.innerText = '';
            ui.use.generatedSubjectInput.value = '';
            ui.use.generatedSubjectWrapper.classList.add('hidden');
            currentTemplateVersion = null;
        }

        function populateBatchTemplateSelector() {
            ui.batch.templateSelect.innerHTML = '<option value="">Select a template...</option>';
            allTemplates.filter(t => !t.isArchived).forEach((template) => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name}${template.isDefault ? " (Default)" : ""}`;
                ui.batch.templateSelect.appendChild(option);
            });
        }
        
        function createFieldInput(field) {
            const sanitizedId = `field-${sanitizeForId(field.name)}`;
            const fieldWrapper = document.createElement('div');
            
            const label = document.createElement('label');
            label.setAttribute('for', sanitizedId);
            label.className = "block text-sm font-medium";
            label.textContent = field.name;
            fieldWrapper.appendChild(label);

            if (field.desc) {
                const descEl = document.createElement('p');
                descEl.className = "text-xs text-[var(--text-secondary)] mb-1";
                descEl.textContent = field.desc;
                fieldWrapper.appendChild(descEl);
            }

            let inputElement;
            if (field.type === 'dropdown') {
                inputElement = document.createElement('select');
                const options = (field.options || '').split(',').map(opt => opt.trim());
                options.forEach(opt => {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = opt;
                    inputElement.appendChild(optionEl);
                });
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.placeholder = `Enter ${field.name}...`;
            }
            
            inputElement.id = sanitizedId;
            inputElement.className = "w-full px-3 py-2 border rounded-md shadow-sm dynamic-field";
            inputElement.setAttribute('data-original-name', field.name);
            fieldWrapper.appendChild(inputElement);
            
            return fieldWrapper;
        }

        function loadSelectedVersion() {
            const selectedVersionNum = parseInt(ui.use.versionSelect.value, 10);
            if (!selectedTemplateId || isNaN(selectedVersionNum)) return;

            const templateFamily = allTemplates.find(t => t.id === selectedTemplateId);
            const version = templateFamily?.versions.find(v => v.version === selectedVersionNum);
            if (!version) return;

            currentTemplateVersion = version;
            ui.use.fieldsContainer.innerHTML = '';

            const definedFieldNames = new Set((version.fields || []).map(f => f.name));
            const templateText = version.template || "";

            if (version.fields && version.fields.length > 0) {
                version.fields.forEach(field => { if (field.name) ui.use.fieldsContainer.appendChild(createFieldInput(field)) });
            }

            Object.keys(PRONOUN_PLACEHOLDERS).forEach(pronoun => {
                if (templateText.includes(`{{${pronoun}}}`) && !definedFieldNames.has(pronoun)) {
                    ui.use.fieldsContainer.appendChild(createFieldInput({ name: pronoun, desc: PRONOUN_PLACEHOLDERS[pronoun], type: 'text' }));
                }
            });
            
            if (templateText.includes('{{Greeting}}') && !definedFieldNames.has('Greeting')) {
                ui.use.fieldsContainer.appendChild(createFieldInput({ name: 'Greeting', desc: 'Auto-populated by scheduled time', type: 'text' }));
            }

            if (ui.use.fieldsContainer.children.length === 0) {
                 ui.use.fieldsContainer.innerHTML = '<p class="col-span-full text-[var(--text-secondary)]">This template version has no placeholders.</p>';
            }

            ui.use.generateButton.disabled = false;
            applyPronounPreset();
            handleScheduledTimeChange();
            liveGenerateText(); // Run once on load
        }
        
        function applyPronounPreset() {
            const preset = ui.use.pronounPreset.value;

            if (preset) {
                Object.keys(PRONOUN_PLACEHOLDERS).forEach(fieldName => {
                    const inputElement = document.getElementById(`field-${sanitizeForId(fieldName)}`);
                    if (inputElement) {
                        inputElement.value = "";
                        inputElement.readOnly = true;
                    }
                });
            }

            const pronouns = {
                male: { 'Pronoun_he_she_they': 'he', 'Pronoun_him_her_them': 'him', 'Pronoun_his_her_their': 'his', 'Pronoun_himself_herself_themself': 'himself' },
                female: { 'Pronoun_he_she_they': 'she', 'Pronoun_him_her_them': 'her', 'Pronoun_his_her_their': 'her', 'Pronoun_himself_herself_themself': 'herself' },
                neutral: { 'Pronoun_he_she_they': 'they', 'Pronoun_him_her_them': 'them', 'Pronoun_his_her_their': 'their', 'Pronoun_himself_herself_themself': 'themself' }
            };

            const selectedPronouns = pronouns[preset];
            if (!selectedPronouns) {
                 Object.keys(PRONOUN_PLACEHOLDERS).forEach(fieldName => {
                    const inputElement = document.getElementById(`field-${sanitizeForId(fieldName)}`);
                    if (inputElement) {
                        inputElement.readOnly = false;
                    }
                });
                return;
            }

            Object.entries(selectedPronouns).forEach(([fieldName, value]) => {
                const inputElement = document.getElementById(`field-${sanitizeForId(fieldName)}`);
                if (inputElement) {
                    inputElement.value = value;
                    inputElement.readOnly = true;
                }
            });
        }
        
        function handleScheduledTimeChange() {
            const timeValue = ui.use.scheduledTimeInput.value;
            const greetingField = document.getElementById('field-Greeting');
            if (!greetingField) return;

            if (timeValue) {
                const hour = parseInt(timeValue.split(':')[0], 10);
                let greeting = "Good morning";
                if (hour >= 12 && hour < 17) {
                    greeting = "Good afternoon";
                } else if (hour >= 17 || hour < 5) { 
                    greeting = "Good evening";
                }
                greetingField.value = greeting;
                greetingField.readOnly = true;
            } else {
                 greetingField.value = "";
                 greetingField.readOnly = false;
            }
        }
        
        function generateText() {
    const btn = ui.use.generateButton;
    const originalText = btn.innerHTML;
    
    // 1. Show Loading State
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Generating...`;
    
    // 2. Perform Generation (Simulated delay for effect, or instant)
    setTimeout(() => {
        liveGenerateText(false); 
        ui.use.step3Details.open = true;
        
        // Reveal animation
        const container = document.getElementById('generated-text-container');
        container.classList.remove('opacity-50');
        container.classList.add('opacity-100');

        // Scroll to result
        ui.use.step3Details.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Restore Button
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        // Visual Success Flash
        const previewWindow = document.querySelector('.email-client-window');
        previewWindow.classList.add('ring-2', 'ring-indigo-400');
        setTimeout(() => previewWindow.classList.remove('ring-2', 'ring-indigo-400'), 500);
        
    }, 400); // Short delay makes it feel like "work" is being done
}
        // This is the new function for live updates
        function liveGenerateText(autoCopy = false) {
            if (!currentTemplateVersion) return;
            const fieldData = {};
            document.querySelectorAll('#fields-container .dynamic-field').forEach(input => {
                const originalName = input.getAttribute('data-original-name');
                if (originalName) fieldData[originalName] = input.value;
            });

            const process = (text) => {
                if (!text) return "";
                return text.replace(/{{\s*([^}]+?)\s*}}/g, (match, placeholderName) => {
                    return fieldData.hasOwnProperty(placeholderName) ? fieldData[placeholderName] : match;
                });
            };

            ui.use.generatedSubjectInput.value = process(currentTemplateVersion.subject);
            const bodyText = process(currentTemplateVersion.template);
            ui.use.generatedTextDiv.innerText = bodyText;

            // Show the containers if they have content
            ui.use.generatedSubjectWrapper.classList.toggle('hidden', !currentTemplateVersion.subject);
            ui.use.generatedTextContainer.style.maxHeight = '500px';

            if (gapi.client && gapi.client.getToken()) {
                ui.use.loadToGmailButton.classList.remove('hidden');
            }

            if (autoCopy && bodyText) {
                copyToClipboard(bodyText, "Body copied automatically!");
            }
        }
        
        function copyToClipboard(content, message) {
            if (!content) return;
            navigator.clipboard.writeText(content).then(() => showNotification(message));
        }

        function showNotification(message) {
            ui.notification.textContent = message;
            ui.notification.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => ui.notification.classList.add('opacity-0', 'translate-y-2'), 2000);
        }
        
        function handleBatchGenerate() {
            const templateId = ui.batch.templateSelect.value;
            const file = ui.batch.csvFileInput.files[0];
            if (!templateId || !file) return alert("Please select a template and a CSV file.");
            const templateFamily = allTemplates.find(t => t.id === templateId);
            if (!templateFamily) return;
            const latestVersion = [...templateFamily.versions].sort((a,b) => b.version - a.version)[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r\n?|\n/).filter(Boolean);
                if (lines.length < 2) return alert("CSV must have a header and at least one data row.");
                const headers = lines[0].split(',').map(h => h.trim());
                const dataRows = lines.slice(1).map(line => line.split(',').reduce((obj, val, i) => { obj[headers[i]] = val.trim(); return obj; }, {}));
                displayBatchResults(dataRows, latestVersion);
            };
            reader.readAsText(file);
        }
        
        function displayBatchResults(dataRows, version) {
            ui.batch.output.innerHTML = '';
            const process = (text, data) => {
                if (!text || typeof text !== 'string' || !data || typeof data !== 'object') return "";
                return text.replace(/{{\s*([^}]+?)\s*}}/g, (match, placeholderName) => (data.hasOwnProperty(placeholderName) ? data[placeholderName] : match));
            };
            dataRows.forEach((row, i) => {
                const subject = process(version.subject, row);
                const body = process(version.template, row);
                const entryDiv = document.createElement('div');
                entryDiv.className = "p-4 border border-[var(--border-color)] rounded-lg";
                entryDiv.innerHTML = `<h4 class="font-semibold text-lg mb-2">Entry ${i + 1} (For: ${row.Name || 'N/A'})</h4>
                    ${subject ? `<div class="mb-2"><label class="block text-sm font-medium">Subject</label><input type="text" value="${subject}" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700" readonly></div>` : ''}
                    <div><label class="block text-sm font-medium">Body</label><div class="generated-html-body p-3 rounded-md whitespace-pre-wrap min-h-[5rem]">${body}</div></div>`;
                ui.batch.output.appendChild(entryDiv);
            });
            ui.batch.outputContainer.classList.remove('hidden');
        }

       async function handleSaveTemplate(event) {
    event.preventDefault();
    const name = ui.manage.nameInput.value.trim();
    const templateText = ui.manage.bodyTextarea.value;
    if (!name || !templateText) return alert("Template Name and Body cannot be empty.");
    
    const editId = ui.manage.editIdInput.value;
    
    const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('.field-row')).map(row => {
        const fieldType = row.querySelector('.field-type').value;
        const fieldData = {
            name: row.querySelector('.field-name').value.trim(),
            type: fieldType
        };
        if (fieldType === 'dropdown') {
            fieldData.options = row.querySelector('.field-options')?.value.trim() || '';
        } else {
            fieldData.desc = row.querySelector('.field-desc')?.value.trim() || '';
        }
        return fieldData;
    }).filter(f => f.name);
    
    let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]').filter(t => !t.isDefault);
    const now = new Date().toISOString();

    // FIXED: Safe access using ternary operators in case inputs are missing from DOM
    const versionData = {
        subject: ui.manage.subjectInput ? ui.manage.subjectInput.value.trim() : '',
        description: ui.manage.descriptionInput ? ui.manage.descriptionInput.value.trim() : '', // Safe access
        target: ui.manage.targetInput ? ui.manage.targetInput.value.trim() : '', // Safe access
        purpose: ui.manage.purposeInput ? ui.manage.purposeInput.value.trim() : '', // Safe access
        fields, 
        template: templateText,
    };

    if (!editId) {
        if (userTemplates.some(t => t.name.toLowerCase() === name.toLowerCase() && !t.isArchived) && !confirm(`A template named "${name}" already exists. Save anyway?`)) return;
        const newTemplateFamily = {
            id: crypto.randomUUID(), name, folder: ui.manage.folderInput.value.trim(), isArchived: false, isDefault: false, createdAt: now, updatedAt: now,
            versions: [{ ...versionData, version: 1, createdAt: now, updatedAt: now }]
        };
        userTemplates.push(newTemplateFamily);
        showSaveStatus("New template saved successfully!");
    } else {
        const templateFamily = userTemplates.find(t => t.id === editId);
        if (!templateFamily) return;
        
        templateFamily.name = name;
        templateFamily.folder = ui.manage.folderInput.value.trim();
        templateFamily.updatedAt = now;

        const latestVersion = Math.max(0, ...templateFamily.versions.map(v => v.version));
        const newVersion = { ...versionData, version: latestVersion + 1, createdAt: now, updatedAt: now };
        templateFamily.versions.push(newVersion);
        showSaveStatus(`Saved as new Version ${newVersion.version}!`);
    }
    cancelEdit(); 
    await saveAndSyncTemplates(userTemplates);
}

        function addFieldInputRow(field = { name: '', desc: '', type: 'text', options: '' }) {
            const fieldRow = document.createElement('div');
            fieldRow.className = "flex items-center gap-2 field-row";
            fieldRow.draggable = true;
            const optionsInput = field.type === 'dropdown' ? 
                `<input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-options" placeholder="Options (comma-sep)" value="${field.options || ''}">` :
                `<input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-desc" placeholder="Helpful Description" value="${field.desc || ''}">`;
            fieldRow.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 cursor-grab drag-handle flex-shrink-0 text-gray-400"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v12.5a.75.75 0 01-1.5 0V3.75A.75.75 0 0110 3zM3.5 10a.75.75 0 01.75-.75h11.5a.75.75 0 010 1.5H4.25a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg><div class="flex-grow grid grid-cols-3 gap-2"><input type="text" class="w-full px-3 py-2 border rounded-md shadow-sm field-name" placeholder="Placeholder Name" value="${field.name || ''}">${optionsInput}<select class="w-full px-3 py-2 border rounded-md shadow-sm field-type"><option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option><option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option></select></div><button type="button" class="text-sm text-red-600 hover:underline flex-shrink-0 remove-field-btn">Remove</button>`;
            fieldRow.querySelector('.remove-field-btn').addEventListener('click', () => { fieldRow.remove(); updateInteractivePlaceholders(); });
            fieldRow.querySelector('.field-type').addEventListener('change', (e) => {
                const newField = { name: fieldRow.querySelector('.field-name').value, desc: fieldRow.querySelector('.field-desc')?.value || '', type: e.target.value, options: fieldRow.querySelector('.field-options')?.value || '' };
                const newRow = addFieldInputRow(newField);
                fieldRow.replaceWith(newRow);
                updateInteractivePlaceholders();
            });
            fieldRow.querySelector('.field-name').addEventListener('input', updateInteractivePlaceholders);
            ui.manage.fieldsContainer.appendChild(fieldRow);
            if (field.name) updateInteractivePlaceholders();
            return fieldRow;
        }
        
        function setupDragAndDrop() {
            const container = ui.manage.fieldsContainer;
            let draggedItem = null;
            container.addEventListener('dragstart', e => { if (e.target.classList.contains('field-row')) { draggedItem = e.target; setTimeout(() => e.target.classList.add('opacity-50'), 0); } });
            container.addEventListener('dragend', e => { if (draggedItem) { draggedItem.classList.remove('opacity-50'); draggedItem = null; } });
            container.addEventListener('dragover', e => { e.preventDefault(); const afterElement = [...container.querySelectorAll('.field-row:not(.opacity-50)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; if (afterElement == null) container.appendChild(draggedItem); else container.insertBefore(draggedItem, afterElement); });
        }
        
        function updateInteractivePlaceholders() {
            ui.manage.placeholdersContainer.innerHTML = '';
            const fields = Array.from(ui.manage.fieldsContainer.querySelectorAll('.field-name')).map(input => input.value.trim()).filter(Boolean);
            if (fields.length > 0) {
                fields.forEach(name => {
                    const tag = document.createElement('div');
                    tag.textContent = name;
                    tag.className = "placeholder-tag bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 text-sm font-semibold px-2.5 py-1 rounded-full cursor-pointer";
                    tag.draggable = true;
                    tag.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', `{{${name}}}`));
                    tag.addEventListener('dblclick', () => insertPlaceholder(`{{${name}}}`));
                    ui.manage.placeholdersContainer.appendChild(tag);
                });
                ui.manage.placeholdersWrapper.classList.remove('hidden');
            } else {
                ui.manage.placeholdersWrapper.classList.add('hidden');
            }
        }

        function insertPlaceholder(textToInsert) {
            const textarea = ui.manage.bodyTextarea;
            const start = textarea.selectionStart; const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + textToInsert + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length;
            textarea.focus();
        }
        
        function handleDrop(e) { e.preventDefault(); if (e.target.id === 'template-subject') return; const textToInsert = e.dataTransfer.getData('text/plain'); if (/\{\{.+?\}\}/.test(textToInsert)) insertPlaceholder(textToInsert); }
        function showSaveStatus(message) { ui.manage.saveStatus.textContent = message; setTimeout(() => { ui.manage.saveStatus.textContent = ''; }, 3000); }
        
        function loadTemplateIntoEditor(config) {
    const { family, version, title, saveMode } = config;
    
    ui.manage.formTitle.textContent = title;
    ui.manage.nameInput.value = family.name;
    ui.manage.folderInput.value = family.folder || '';
    
    // Safe checks: Only set value if the input exists in the HTML
    if (ui.manage.subjectInput) ui.manage.subjectInput.value = version.subject || '';
    if (ui.manage.descriptionInput) ui.manage.descriptionInput.value = version.description || '';
    if (ui.manage.targetInput) ui.manage.targetInput.value = version.target || '';
    if (ui.manage.purposeInput) ui.manage.purposeInput.value = version.purpose || '';
    
    ui.manage.bodyTextarea.value = version.template || version.body || ''; 
    
    ui.manage.editIdInput.value = family.id || '';
    ui.manage.editVersionInput.value = version.version || '';
    ui.manage.saveModeInput.value = saveMode;
    
    ui.manage.fieldsContainer.innerHTML = '';
    (version.fields || []).forEach(field => addFieldInputRow(field));
    
    ui.manage.cancelEditButton.classList.remove('hidden');
    
    // Ensure tab content is visible and scroll to top
    document.getElementById('tab-content-manage-templates').classList.remove('hidden');
    document.querySelector('.manage-editor').scrollTop = 0;
    
    updateManagerPreview();
}

        function useLatestVersionForEdit(templateId) {
    const family = allTemplates.find(t => t.id === templateId);
    if (!family) return;
    
    // Get latest version
    const latestVersion = [...family.versions].sort((a,b) => b.version - a.version)[0];
    
    loadTemplateIntoEditor({
        family: family,
        version: latestVersion,
        title: `Editing ${family.name}`,
        saveMode: 'new_version' // Saving will create a new version
    });
}

        // Renamed 'editVersionInPlace' to 'viewOrRestoreVersion' for clarity
        function viewOrRestoreVersion(templateId, versionNumber) { 
            const family = allTemplates.find(t => t.id === templateId); 
            const version = family?.versions.find(v => v.version == versionNumber); 
            if (family && version) {
                // Set saveMode to 'new_version_from_old' - this signals that saving will create a new version based on this old one
                loadTemplateIntoEditor({ 
                    family, 
                    version, 
                    title: `Viewing/Restoring Version ${version.version} of "${family.name}"`, 
                    saveMode: 'new_version_from_old' 
                });
            }
        }
        function duplicateAsNewTemplate(templateId, versionNumber) { const family = allTemplates.find(t => t.id === templateId); const version = family?.versions.find(v => v.version == versionNumber); if (family && version) { const newFamily = { ...family, id: '', name: `Copy of ${family.name}` }; const newVersion = { ...version, version: '' }; loadTemplateIntoEditor({ family: newFamily, version: newVersion, title: `Creating New Template from "${family.name}" v${version.version}`, saveMode: 'new_template' }); } }
        function addBlankVersion(templateId) { const family = allTemplates.find(t => t.id === templateId); if (family) loadTemplateIntoEditor({ family, version: { fields: [] }, title: `Adding Blank New Version to "${family.name}"`, saveMode: 'new_version' }); }

        function cancelEdit() {
            ui.manage.formTitle.textContent = "Create New Template";
            ui.manage.form.reset();
            ui.manage.bodyTextarea.value = '';
            ui.manage.fieldsContainer.innerHTML = '';
            ui.manage.editIdInput.value = "";
            ui.manage.editVersionInput.value = "";
            ui.manage.saveModeInput.value = "";
            ui.manage.cancelEditButton.classList.add('hidden');
            updateInteractivePlaceholders();
        }

        async function toggleArchiveTemplate(templateId) { let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]'); const template = userTemplates.find(t => t.id === templateId); if (template) { template.isArchived = !template.isArchived; template.updatedAt = new Date().toISOString(); } await saveAndSyncTemplates(userTemplates); }
        async function deleteTemplate(templateId) { if (!confirm("Are you sure you want to permanently delete this template and all its versions?")) return; let userTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]'); userTemplates = userTemplates.filter(t => t.id !== templateId); await saveAndSyncTemplates(userTemplates); }
        
        function useVersion(templateId, versionNumber) { 
            switchTab('use-templates'); 
            const family = allTemplates.find(t => t.id === templateId);
            if (family) {
                selectedFolder = family.folder || 'Uncategorized';
                renderFolderList();
                renderTemplateList();
                handleTemplateSelection(templateId);
                setTimeout(() => { 
                    ui.use.versionSelect.value = versionNumber; 
                    ui.use.versionSelect.dispatchEvent(new Event('change')); 
                }, 100);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }
        
        function renderTemplateManager(searchTerm = '') {
    ui.manage.userTemplatesList.innerHTML = '';
    const term = searchTerm.toLowerCase().trim();
    
    // CHANGED: Filter based on search term AND default status
    const userTemplates = allTemplates.filter(t => {
        const isNotDefault = !t.isDefault;
        const matchesSearch = !term || t.name.toLowerCase().includes(term);
        return isNotDefault && matchesSearch;
    });

    const groupedByFolder = userTemplates.reduce((acc, template) => { 
        const folder = template.folder || 'Uncategorized'; 
        if (!acc[folder]) acc[folder] = []; 
        acc[folder].push(template); 
        return acc; 
    }, {});
    
    // Sort folders alphabetically
    Object.keys(groupedByFolder).sort().forEach(folder => {
        const folderContainer = document.createElement('details');
        folderContainer.className = 'folder-group mb-2'; 
        // If searching, always expand folders to show results
        folderContainer.open = !!term; 
        
        const folderSummary = document.createElement('summary');
        folderSummary.className = 'font-bold text-gray-500 uppercase text-xs cursor-pointer py-2 hover:text-[var(--primary)]';
        folderSummary.innerHTML = `${folder} <span class="ml-2 text-[10px] bg-gray-200 dark:bg-gray-700 px-1 rounded">${groupedByFolder[folder].length}</span>`;
        folderContainer.appendChild(folderSummary);
        
        const templateListDiv = document.createElement('div');
        templateListDiv.className = 'space-y-1 pl-2'; 
        
        const visibleTemplates = groupedByFolder[folder].filter(t => showArchived || !t.isArchived);
        
        if (visibleTemplates.length > 0) {
            visibleTemplates.forEach(template => {
                const item = document.createElement('div');
                const isActive = template.id === ui.manage.editIdInput.value;
                item.className = `p-2 rounded cursor-pointer border-l-4 transition hover:bg-gray-100 dark:hover:bg-gray-800 ${isActive ? 'bg-gray-100 dark:bg-gray-800 border-blue-500' : 'border-transparent'}`;
                
                item.innerHTML = `
                    <div class="font-bold text-sm truncate text-[var(--text)]">${template.name}</div>
                    <div class="text-[10px] text-gray-400 flex justify-between">
                        <span>v${Math.max(...template.versions.map(v=>v.version))}</span>
                        ${template.isArchived ? '<span class="text-yellow-600">Archived</span>' : ''}
                    </div>
                `;
                
                item.onclick = () => useLatestVersionForEdit(template.id);
                templateListDiv.appendChild(item);
            });
            folderContainer.appendChild(templateListDiv);
            ui.manage.userTemplatesList.appendChild(folderContainer);
        }
    });
    
    // Handle Empty State
    if (ui.manage.userTemplatesList.innerHTML === '') {
        ui.manage.userTemplatesList.innerHTML = term 
            ? `<p class="text-center text-gray-500 mt-4 text-sm">No matching templates found.</p>`
            : `<p class="text-center text-gray-500 mt-4 text-sm">${showArchived ? 'No archived templates.' : 'Create your first template!'}</p>`;
    }
}

        function exportTemplates() { const data = localStorage.getItem('userTemplates') || '[]'; const blob = new Blob([data], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `text_merge_templates_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href); }
        async function handleImportFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { let data = JSON.parse(e.target.result); data = migrateTemplates(data); if (!Array.isArray(data) || !data.every(t => t.id && t.name && t.versions)) throw new Error("Invalid template file."); const merge = confirm("Merge with existing templates? (Cancel to replace)"); const existing = merge ? JSON.parse(localStorage.getItem('userTemplates') || '[]') : []; alert(`Imported ${data.length} templates.`); await saveAndSyncTemplates([...existing, ...data]); } catch (error) { alert(`Import failed: ${error.message}`); } }; reader.readAsText(file); ui.manage.importFileInput.value = ''; }

        function initializeFirebase() {
            try {
                firebaseApp = initializeApp(FIREBASE_CONFIG);
                firebaseAuth = getAuth(firebaseApp);
                firestoreDb = getFirestore(firebaseApp);
                onAuthStateChanged(firebaseAuth, async user => {
                    currentUser = user;
                    updateFirebaseAuthStatus(!!user);
                    if (user) {
                        listenForThemeChanges();
                        await checkForCloudUpdates();
                        listenForTemplateChanges();
                    } else {
                        if (templatesUnsubscribe) templatesUnsubscribe();
                        if (themeUnsubscribe) themeUnsubscribe();
                        templatesUnsubscribe = null;
                        themeUnsubscribe = null;
                        loadTemplates();
                        setSyncState('unknown');
                        applyTheme(localStorage.getItem('theme') || 'light');
                    }
                });
            } catch (e) { console.error("Firebase initialization error: ", e); ui.sync.status.textContent = "Firebase is not configured correctly."; }
        }

        function handleFirebaseSignIn() { const email = ui.sync.emailInput.value, password = ui.sync.passwordInput.value; if (!email || !password) return alert("Please enter email and password."); signInWithEmailAndPassword(firebaseAuth, email, password).catch(error => alert(`Sign in failed: ${error.message}`)); }
        function handleFirebaseSignUp() { const email = ui.sync.emailInput.value, password = ui.sync.passwordInput.value; if (!email || !password) return alert("Please enter email and password."); createUserWithEmailAndPassword(firebaseAuth, email, password).catch(error => alert(`Sign up failed: ${error.message}`)); }
        function handleGoogleSignIn() { const provider = new GoogleAuthProvider(); signInWithPopup(firebaseAuth, provider).catch(error => alert(`Google sign in failed: ${error.message}`)); }
        function handleFirebaseSignOut() { signOut(firebaseAuth); }
        function updateFirebaseAuthStatus(isSignedIn) { ui.sync.authContainer.classList.toggle('hidden', isSignedIn); ui.sync.controls.classList.toggle('hidden', !isSignedIn); if (isSignedIn) ui.sync.authStatus.textContent = `Signed in as ${currentUser.email}`; }
        
        async function saveAndSyncTemplates(templates) { localStorage.setItem('userTemplates', JSON.stringify(templates)); loadTemplates(); if (currentUser) await saveTemplatesToFirebase(templates); else setSyncState('unsynced'); }
        async function saveTemplatesToFirebase(templatesToSave = null) {
            if (!currentUser) return;
            setSyncState('syncing');
            const templatesData = templatesToSave ? templatesToSave : JSON.parse(localStorage.getItem('userTemplates') || '[]').filter(t => !t.isDefault);
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            try {
                await setDoc(userDocRef, { templates: templatesData, updatedAt: new Date().toISOString() });
                setSyncState('synced');
            } catch (error) { setSyncState('error'); console.error("Firebase save error:", error); }
        }

        function listenForTemplateChanges() {
            if (templatesUnsubscribe) templatesUnsubscribe();
            const userDocRef = doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates");
            templatesUnsubscribe = onSnapshot(userDocRef, (docSnap) => { if (!docSnap.metadata.hasPendingWrites && docSnap.exists()) checkForCloudUpdates(docSnap.data()); });
        }
        
        function deterministicStringify(obj) { if (obj === null || typeof obj !== 'object') return JSON.stringify(obj); if (Array.isArray(obj)) return `[${obj.map(deterministicStringify).join(',')}]`; const keys = Object.keys(obj).sort(); const objectBody = keys.map(key => `${JSON.stringify(key)}:${deterministicStringify(obj[key])}`).join(','); return `{${objectBody}}`; }
        function createTemplateHash(template) { if (!template) return null; const clone = JSON.parse(JSON.stringify(template)); delete clone.createdAt; delete clone.updatedAt; if (clone.versions) { clone.versions.sort((a, b) => a.version - b.version); clone.versions.forEach(v => { delete v.createdAt; delete v.updatedAt; if (v.fields) v.fields.sort((a, b) => a.name.localeCompare(b.name)); }); } return deterministicStringify(clone); }

        async function checkForCloudUpdates(remoteData = null) {
            if (!currentUser) return;
            setSyncState('syncing');
            try {
                if (!remoteData) {
                    const docSnap = await getDoc(doc(firestoreDb, `users/${currentUser.uid}/sources/text-merge-templates/data`, "templates"));
                    if (docSnap.exists()) remoteData = docSnap.data(); 
                    else { await saveTemplatesToFirebase(); return; }
                }
                const localTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]').filter(t => !t.isDefault);
                const remoteTemplates = migrateTemplates(remoteData?.templates || []);
                const localMap = new Map(localTemplates.map(t => [t.id, t]));
                const remoteMap = new Map(remoteTemplates.map(t => [t.id, t]));
                let needsSync = localTemplates.length !== remoteTemplates.length;
                const allIds = new Set([...localMap.keys(), ...remoteMap.keys()]);
                const conflicts = [];
                const mergedTemplates = [];
                for (const id of allIds) {
                    const local = localMap.get(id); const remote = remoteMap.get(id);
                    if (local && !remote) { mergedTemplates.push(local); needsSync = true; } 
                    else if (!local && remote) { mergedTemplates.push(remote); needsSync = true; } 
                    else if (local && remote) {
                        if (createTemplateHash(local) === createTemplateHash(remote)) mergedTemplates.push(local); 
                        else { conflicts.push({ id, local, remote }); needsSync = true; }
                    }
                }
                if (conflicts.length > 0) { setSyncState('unsynced'); displayConflicts(conflicts, mergedTemplates.filter(t => !conflicts.find(c => c.id === t.id))); } 
                else if (needsSync) { await saveAndSyncTemplates(mergedTemplates); } 
                else { setSyncState('synced'); }
            } catch (error) { setSyncState('error'); console.error("Error checking for cloud updates:", error); }
        }
        
        function displayConflicts(conflicts, nonConflictingTemplates) {
            ui.sync.conflictContainer.innerHTML = '';
            conflicts.forEach(conflict => {
                const conflictDiv = document.createElement('div');
                conflictDiv.className = 'border p-4 rounded-lg bg-gray-50 dark:bg-gray-700';
                conflictDiv.dataset.id = conflict.id;
                const localLatest = [...conflict.local.versions].sort((a,b)=>b.version-a.version)[0];
                const remoteLatest = [...conflict.remote.versions].sort((a,b)=>b.version-a.version)[0];
                conflictDiv.innerHTML = `<h4 class="text-lg font-bold">${conflict.local.name}</h4><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div class="p-3 border rounded-md bg-white dark:bg-gray-600"><label class="flex items-center space-x-3 cursor-pointer"><input type="radio" name="conflict_${conflict.id}" value="local" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500" checked><div class="font-semibold">Keep Local Version<span class="block text-sm font-normal text-gray-600 dark:text-gray-300">Latest: v${localLatest.version} (Updated: ${new Date(localLatest.updatedAt).toLocaleString()})</span></div></label></div><div class="p-3 border rounded-md bg-white dark:bg-gray-600"><label class="flex items-center space-x-3 cursor-pointer"><input type="radio" name="conflict_${conflict.id}" value="remote" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500"><div class="font-semibold">Keep Cloud Version<span class="block text-sm font-normal text-gray-600 dark:text-gray-300">Latest: v${remoteLatest.version} (Updated: ${new Date(remoteLatest.updatedAt).toLocaleString()})</span></div></label></div></div>`;
                ui.sync.conflictContainer.appendChild(conflictDiv);
            });
            ui.sync.conflictModal.classList.remove('hidden');
            const resolveHandler = async (e) => {
                const btn = e.currentTarget;
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin inline -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...`;
                const finalTemplates = [...nonConflictingTemplates];
                conflicts.forEach(conflict => { const choice = document.querySelector(`input[name="conflict_${conflict.id}"]:checked`).value; finalTemplates.push(choice === 'local' ? conflict.local : conflict.remote); });
                try { await saveAndSyncTemplates(finalTemplates); ui.sync.conflictModal.classList.add('hidden'); showNotification("Sync conflicts resolved!"); } catch (error) { console.error("Failed to resolve conflicts:", error); showNotification("Error: Could not resolve conflicts."); } finally { btn.disabled = false; btn.textContent = 'Apply Custom Resolutions & Sync'; }
            };
            let newBtn = ui.sync.resolveButton.cloneNode(true);
            ui.sync.resolveButton.parentNode.replaceChild(newBtn, ui.sync.resolveButton);
            ui.sync.resolveButton = newBtn;
            ui.sync.resolveButton.textContent = 'Apply Custom Resolutions & Sync';
            ui.sync.resolveButton.addEventListener('click', resolveHandler);
        }

        function setSyncState(newState) {
            syncState = newState;
            const indicator = ui.sync.indicator;
            indicator.className = 'text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2';
            let iconHtml = '';
            switch(newState) {
                case 'synced': indicator.textContent = 'Synced'; indicator.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/50', 'dark:text-green-300'); break;
                case 'unsynced': indicator.textContent = 'Unsynced Changes'; indicator.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/50', 'dark:text-yellow-300'); break;
                case 'syncing': iconHtml = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`; indicator.innerHTML = `${iconHtml} Syncing...`; indicator.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900/50', 'dark:text-blue-300'); break;
                case 'error': indicator.textContent = 'Sync Error'; indicator.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/50', 'dark:text-red-300'); break;
                default: indicator.classList.add('hidden');
            }
        }
        
        function gapiLoaded() { if(gapi && gapi.load) gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { if(gapi && gapi.client) await gapi.client.init({ apiKey: GMAIL_API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"], }); }
        function gisLoaded() { if(google && google.accounts && google.accounts.oauth2) tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GMAIL_CLIENT_ID, scope: GMAIL_SCOPES, callback: (tokenResponse) => { if (tokenResponse && tokenResponse.access_token) { gapi.client.setToken(tokenResponse); ui.sync.gmailAuthStatus.textContent = "Gmail access authorized successfully!"; ui.sync.authorizeGmailButton.disabled = true; ui.sync.authorizeGmailButton.textContent = "Gmail Authorized"; if (ui.use.generatedTextDiv.innerText) ui.use.loadToGmailButton.classList.remove('hidden'); } }, }); }
        function handleAuthGmailClick() { if (!tokenClient) return; if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); else tokenClient.requestAccessToken({prompt: ''}); }
        async function createGmailDraft() { const subject = ui.use.generatedSubjectInput.value; const body = ui.use.generatedTextDiv.innerText; const email = [`Subject: ${subject}`, 'Content-Type: text/plain; charset="UTF-8"', 'MIME-Version: 1.0', '', body].join('\n'); const base64EncodedEmail = btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_'); try { await gapi.client.gmail.users.drafts.create({ 'userId': 'me', 'resource': { 'message': { 'raw': base64EncodedEmail } } }); showNotification("Draft created in Gmail!"); } catch (err) { console.error("Gmail API Error:", err); alert(`Could not create Gmail draft. Your authorization may have expired.`); } }

        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            const newColorScheme = theme === 'dark' ? 'dark' : 'light';
            document.documentElement.style.colorScheme = newColorScheme;
        };

        ui.themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
            saveUserSettings({ theme: newTheme });
        });
        
        async function saveUserSettings(settings) {
            if (!currentUser) return;
            const settingsDocRef = doc(firestoreDb, `users/${currentUser.uid}/settings`, 'theme');
            try {
                await setDoc(settingsDocRef, settings, { merge: true });
            } catch (error) {
                console.error("Error saving user settings:", error);
            }
        }

        function listenForThemeChanges() {
            if (themeUnsubscribe) themeUnsubscribe();
            if (!currentUser) {
                applyTheme(localStorage.getItem('theme') || 'light');
                return;
            }

            const themeDocRef = doc(firestoreDb, `users/${currentUser.uid}/settings`, 'theme');
            themeUnsubscribe = onSnapshot(themeDocRef, (docSnap) => {
                const localTheme = localStorage.getItem('theme') || 'light';
                let theme = localTheme;

                if (docSnap.exists() && docSnap.data().theme) {
                    theme = docSnap.data().theme;
                } else {
                    saveUserSettings({ theme: localTheme });
                }
                
                applyTheme(theme);
                localStorage.setItem('theme', theme);
            }, (error) => {
                console.error("Error listening for theme changes:", error);
                applyTheme(localStorage.getItem('theme') || 'light');
            });
        }
        
        applyTheme(localStorage.getItem('theme') || 'light');

    </script>
</body>
</html>