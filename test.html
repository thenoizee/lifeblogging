<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BookTrackr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512' fill='%23f59e0b'%3E%3Cpath d='M96 0C43 0 0 43 0 96V416c0 53 43 96 96 96H384h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V384c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H384 96zm0 384H352v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16H336c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48H336c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#f59e0b', // Amber-500
                        'primary-hover': '#d97706', // Amber-600
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --primary: #f59e0b;
            --bg-light: #f3f4f6;
            --bg-dark: #111827;
            --card-light: #ffffff;
            --card-dark: #1f2937;
        }

        body { transition: background-color 0.3s, color 0.3s; }
        
        /* Standard App Wrapper */
        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto !important;
            width: 100%;
            padding-bottom: 80px; 
        }

        /* Tab Content Logic */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }

        /* Book Card Styles */
        .book-card { transition: transform 0.2s, box-shadow 0.2s; }
        .book-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* Stats Box */
        .stats-box { @apply p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl text-center hidden">
        <div class="mb-6 inline-block p-4 rounded-full bg-amber-100 dark:bg-amber-900/30">
            <i class="fa-solid fa-book-open text-5xl text-amber-500"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2 text-amber-600 dark:text-amber-500">BookTrackr</h1>
        <p class="text-gray-500 dark:text-gray-400 mb-8">Your personal reading library.</p>
        <form id="auth-form" class="space-y-4">
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:border-amber-500 outline-none transition">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:border-amber-500 outline-none transition">
            <div class="flex gap-3">
                <button type="button" id="login-btn" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition">Login</button>
                <button type="button" id="signup-btn" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-bold py-3 rounded-lg transition">Sign Up</button>
            </div>
        </form>
    </div>

    <div id="main-app-container" class="hidden">
        <main>
            <div id="tab-content-dashboard" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="stats-box flex items-center justify-between border-l-4 border-l-green-500">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 font-bold uppercase">Books Read</p>
                            <p id="stat-read-count" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fa-solid fa-check-circle text-3xl text-green-500/20"></i>
                    </div>
                    <div class="stats-box flex items-center justify-between border-l-4 border-l-amber-500">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 font-bold uppercase">Reading Now</p>
                            <p id="stat-reading-count" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fa-solid fa-book-open-reader text-3xl text-amber-500/20"></i>
                    </div>
                    <div class="stats-box flex items-center justify-between border-l-4 border-l-blue-500">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 font-bold uppercase">To Read</p>
                            <p id="stat-tbr-count" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fa-solid fa-list-ul text-3xl text-blue-500/20"></i>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-glasses text-amber-500"></i> Currently Reading</h2>
                    <div id="reading-now-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-gray-500"></i> Recent Activity</h2>
                    <div id="recent-activity-list" class="space-y-2 text-sm text-gray-500"></div>
                </div>
            </div>

            <div id="tab-content-library" class="tab-content">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="relative w-full md:w-auto flex-grow max-w-md">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="library-search" placeholder="Filter library..." class="w-full pl-10 p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                    <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1">
                        <button class="filter-btn active px-4 py-2 rounded-full text-xs font-bold bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-200 whitespace-nowrap" data-filter="all">All</button>
                        <button class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700 whitespace-nowrap" data-filter="reading">Reading</button>
                        <button class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700 whitespace-nowrap" data-filter="completed">Read</button>
                        <button class="filter-btn px-4 py-2 rounded-full text-xs font-bold bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700 whitespace-nowrap" data-filter="tbr">TBR</button>
                    </div>
                </div>
                <div id="library-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                    </div>
            </div>

            <div id="tab-content-import" class="tab-content">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 border border-gray-200 dark:border-gray-700">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-file-import text-blue-500"></i> Import Library
                        </h2>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-200 p-4 rounded-lg text-sm mb-6 flex gap-3 items-start">
                            <i class="fa-solid fa-circle-info mt-1"></i>
                            <div>
                                <p class="font-bold">Supports StoryGraph CSV exports.</p>
                                <p>Go to StoryGraph > Manage Account > Export Library to get your file.</p>
                            </div>
                        </div>

                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-10 text-center hover:border-amber-500 transition cursor-pointer bg-gray-50 dark:bg-gray-900/50" id="drop-zone" onclick="document.getElementById('csv-input').click()">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 mb-2"></i>
                            <p class="font-medium">Click to upload CSV</p>
                            <input type="file" id="csv-input" accept=".csv" class="hidden">
                        </div>

                        <div id="import-log" class="mt-4 text-xs font-mono max-h-40 overflow-y-auto bg-black/10 dark:bg-black/30 p-2 rounded hidden"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="book-detail-modal" class="fixed inset-0 bg-white dark:bg-gray-900 z-[60] hidden overflow-y-auto">
        <div class="max-w-4xl mx-auto p-4 md:p-8">
            <button onclick="closeBookModal()" class="mb-4 text-gray-500 hover:text-amber-500 flex items-center gap-2 font-bold transition">
                <i class="fa-solid fa-arrow-left"></i> Back to Library
            </button>
            
            <div id="book-detail-content" class="flex flex-col md:flex-row gap-8 animate-fade">
                </div>
        </div>
    </div>

    <div id="log-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-200 dark:border-gray-700 animate-fade transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Log Progress</h3>
                <button onclick="document.getElementById('log-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <p id="modal-book-title" class="text-sm text-gray-500 dark:text-gray-400 mb-6 truncate font-medium"></p>
            
            <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-xl mb-6">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Pages Read</label>
                    <span id="page-count-display" class="text-3xl font-bold text-amber-600">0</span>
                </div>
                <input type="range" id="page-slider" min="0" max="1000" value="0" class="w-full h-2 bg-gray-300 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-amber-600">
                <div class="flex justify-between mt-2 text-xs text-gray-400">
                    <span>0</span>
                    <span id="modal-total-pages">Max</span>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-6">
                <button onclick="setModalStatus('reading')" class="status-btn py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-xs font-bold uppercase hover:border-amber-500 transition" data-status="reading">Reading</button>
                <button onclick="setModalStatus('completed')" class="status-btn py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-xs font-bold uppercase hover:border-amber-500 transition" data-status="completed">Finish</button>
                <button onclick="setModalStatus('dnf')" class="status-btn py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-xs font-bold uppercase hover:border-amber-500 transition" data-status="dnf">DNF</button>
            </div>

            <button id="confirm-log" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-amber-500/20 transition transform active:scale-95">Save Progress</button>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-20 md:bottom-5 right-5 z-[100] flex flex-col gap-2"></div>

    <script type="module">
        import { AppNavigation } from './shared-nav.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const app = initializeApp({
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.firebasestorage.app",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const PLACEHOLDER_IMG = 'https://placehold.co/400x600/1f2937/FFF?text=No+Cover';
        
        let currentUser = null;
        let booksCache = [];
        let currentFilter = 'all';
        let currentModalContext = null;
        let selectedStatus = 'reading';

        // --- Init Navigation ---
        const nav = new AppNavigation({
            appName: 'BookTrackr',
            appIcon: 'fa-book-open',
            themeColor: 'amber',
            tabs: [
                { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-line' },
                { id: 'library', label: 'Library', icon: 'fa-book' },
                { id: 'import', label: 'Import', icon: 'fa-file-import' }
            ],
            activeTab: 'dashboard',
            search: { id: 'nav-search', placeholder: 'Search books...' }
        });

        // --- Global Helpers ---
        const showToast = (msg, type = 'success') => {
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `${bg} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 animate-fade min-w-[300px]`;
            toast.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check':'fa-exclamation-circle'}"></i> <span class="font-bold text-sm">${msg}</span>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        const getCoverUrl = (id) => id ? `https://covers.openlibrary.org/b/id/${id}-L.jpg` : PLACEHOLDER_IMG;

        // --- Auth & Lifecycle ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('main-app-container').classList.remove('hidden');
                nav.updateUser(user.email);
                await loadBooks();
                renderDashboard();
                handleHash(); // Check if direct link to book
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('main-app-container').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').onclick = () => handleAuth('login');
        document.getElementById('signup-btn').onclick = () => handleAuth('signup');

        async function handleAuth(action) {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            try {
                if(action === 'signup') await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) { showToast(e.message, 'error'); }
        }

        // --- Core Logic ---
        window.addEventListener('tab-changed', (e) => {
            const tabId = e.detail.tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-content-${tabId}`).classList.add('active');
            if(tabId === 'dashboard') renderDashboard();
            if(tabId === 'library') renderLibrary();
        });

        async function loadBooks() {
            if (!currentUser) return;
            const snap = await getDocs(collection(db, `users/${currentUser.uid}/books`));
            booksCache = snap.docs.map(d => d.data());
        }

        function renderDashboard() {
            // Stats
            const read = booksCache.filter(b => b.status === 'completed').length;
            const reading = booksCache.filter(b => b.status === 'reading');
            const tbr = booksCache.filter(b => b.status === 'tbr').length;

            document.getElementById('stat-read-count').innerText = read;
            document.getElementById('stat-reading-count').innerText = reading.length;
            document.getElementById('stat-tbr-count').innerText = tbr;

            // Reading Now Cards
            const container = document.getElementById('reading-now-container');
            container.innerHTML = '';
            if (reading.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic col-span-full">Not reading anything currently. Start a book from your library!</p>`;
                return;
            }

            reading.forEach(book => {
                const percent = book.totalPages ? Math.round((book.pagesRead / book.totalPages) * 100) : 0;
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex gap-4 cursor-pointer hover:border-amber-500 transition';
                card.onclick = () => window.location.hash = `#book/${book.key}`;
                card.innerHTML = `
                    <img src="${book.cover || PLACEHOLDER_IMG}" class="w-20 h-28 object-cover rounded shadow-md">
                    <div class="flex-1 flex flex-col justify-center">
                        <h3 class="font-bold text-lg leading-tight mb-1 truncate">${book.title || 'Untitled'}</h3>
                        <p class="text-sm text-gray-500 mb-3">${book.author || 'Unknown Author'}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden mb-1">
                            <div class="bg-amber-500 h-full transition-all duration-500" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 font-bold">
                            <span>${book.pagesRead} / ${book.totalPages || '?'}</span>
                            <span>${percent}%</span>
                        </div>
                    </div>
                    <button class="self-center bg-gray-100 dark:bg-gray-700 p-3 rounded-full hover:bg-amber-500 hover:text-white transition" onclick="event.stopPropagation(); openLogModal('${book.key}')">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderLibrary() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            
            // --- FIX: Add safety check for value ---
            const searchInput = document.getElementById('library-search');
            const search = searchInput ? searchInput.value.toLowerCase() : '';

            let filtered = booksCache.filter(b => {
                // --- FIX: Add safety check for undefined properties ---
                const title = (b.title || '').toLowerCase();
                const author = (b.author || '').toLowerCase();
                
                const matchSearch = title.includes(search) || author.includes(search);
                const matchFilter = currentFilter === 'all' || b.status === currentFilter;
                return matchSearch && matchFilter;
            });

            if(filtered.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-gray-500 mt-10">No books found.</p>`;
                return;
            }

            filtered.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-card bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-sm border border-gray-200 dark:border-gray-700 cursor-pointer relative group';
                div.onclick = () => window.location.hash = `#book/${book.key}`;
                
                // Status Badge
                let badgeColor = 'bg-gray-500';
                if(book.status === 'reading') badgeColor = 'bg-amber-500';
                if(book.status === 'completed') badgeColor = 'bg-green-500';
                
                div.innerHTML = `
                    <div class="aspect-[2/3] relative">
                        <img src="${book.cover || PLACEHOLDER_IMG}" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2 ${badgeColor} text-white text-[10px] font-bold px-2 py-1 rounded shadow uppercase">${book.status || 'TBR'}</div>
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                            <span class="text-white font-bold border border-white px-4 py-2 rounded-full">View</span>
                        </div>
                    </div>
                    <div class="p-3">
                        <h4 class="font-bold text-sm truncate" title="${book.title}">${book.title || 'Untitled'}</h4>
                        <p class="text-xs text-gray-500 truncate">${book.author || 'Unknown'}</p>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // --- Library Filtering ---
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-amber-100', 'text-amber-700', 'dark:bg-amber-900', 'dark:text-amber-200');
                    b.classList.add('bg-gray-200', 'text-gray-600', 'dark:bg-gray-800', 'dark:text-gray-400');
                });
                e.target.classList.remove('bg-gray-200', 'text-gray-600', 'dark:bg-gray-800', 'dark:text-gray-400');
                e.target.classList.add('bg-amber-100', 'text-amber-700', 'dark:bg-amber-900', 'dark:text-amber-200');
                currentFilter = e.target.dataset.filter;
                renderLibrary();
            });
        });
        document.getElementById('library-search').addEventListener('input', renderLibrary);

        // --- Book Detail & Hash Routing ---
        window.addEventListener('hashchange', handleHash);
        
        async function handleHash() {
            const hash = window.location.hash;
            const modal = document.getElementById('book-detail-modal');
            
            if (hash.startsWith('#book/')) {
                const key = hash.split('/')[1];
                await renderBookDetail(key);
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Lock scroll
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        window.closeBookModal = () => {
            window.location.hash = ''; // Clear hash closes modal via listener
        };

        async function renderBookDetail(key) {
            const content = document.getElementById('book-detail-content');
            content.innerHTML = '<div class="w-full text-center py-20"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-amber-500"></i></div>';
            
            // Try local first
            let book = booksCache.find(b => b.key === key);
            let description = "No description available.";
            
            // If not local or need more details, fetch OL
            if (!book || !book.description) {
                try {
                    // If it's an imported book (custom key), we can't fetch OL details easily unless we stored OL ID.
                    // Assuming for now if it has 'OL' in key it's OpenLibrary
                    if (!key.startsWith('imp_')) {
                        const res = await fetch(`https://openlibrary.org/works/${key}.json`);
                        if (res.ok) {
                            const data = await res.json();
                            description = typeof data.description === 'object' ? data.description.value : data.description;
                            if(!book) {
                                // Just a view, not in library yet? (Future feature: Search OL)
                                // For now assume library books only
                            }
                        }
                    }
                } catch(e) { console.log("OL Fetch failed", e); }
            }

            if (!book) {
                content.innerHTML = `<div class="text-center text-red-500">Book not found in your library.</div>`;
                return;
            }

            const cover = book.cover || PLACEHOLDER_IMG;
            
            content.innerHTML = `
                <div class="w-full md:w-1/3 flex-shrink-0">
                    <img src="${cover}" class="w-full rounded-xl shadow-2xl mb-6">
                    
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="text-center mb-4">
                            <span class="block text-xs uppercase text-gray-500 font-bold mb-1">Status</span>
                            <span class="inline-block px-3 py-1 rounded text-sm font-bold uppercase
                                ${book.status === 'completed' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 
                                  book.status === 'reading' ? 'bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300' : 
                                  'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}">
                                ${book.status}
                            </span>
                        </div>
                        <button onclick="openLogModal('${book.key}')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg mb-3 transition">
                            Update Progress
                        </button>
                        <div class="text-center text-xs text-gray-500">
                            ${book.pagesRead} / ${book.totalPages} pages read
                        </div>
                    </div>
                </div>
                
                <div class="flex-grow">
                    <h1 class="text-3xl md:text-5xl font-bold mb-2 font-serif">${book.title}</h1>
                    <h2 class="text-xl text-gray-500 dark:text-gray-400 mb-8 font-medium">by ${book.author}</h2>
                    
                    <div class="prose dark:prose-invert max-w-none">
                        <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest mb-2 border-b border-gray-200 dark:border-gray-700 pb-1">About this book</h3>
                        <p class="text-gray-600 dark:text-gray-300 leading-relaxed whitespace-pre-line">${description || book.description || 'No description available.'}</p>
                    </div>

                    <div class="mt-8 flex gap-4">
                        <button onclick="deleteBook('${book.key}')" class="text-red-500 hover:text-red-600 text-sm font-bold flex items-center gap-2">
                            <i class="fa-solid fa-trash"></i> Remove from Library
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Modal Logic ---
        window.openLogModal = (key) => {
            const book = booksCache.find(b => b.key === key);
            if(!book) return;
            
            currentModalContext = book;
            document.getElementById('modal-book-title').innerText = book.title;
            document.getElementById('page-count-display').innerText = book.pagesRead;
            
            const slider = document.getElementById('page-slider');
            slider.max = book.totalPages || 500;
            slider.value = book.pagesRead;
            document.getElementById('modal-total-pages').innerText = `Max: ${book.totalPages || '?'}`;
            
            setModalStatus(book.status);
            document.getElementById('log-modal').classList.remove('hidden');
        };

        window.setModalStatus = (status) => {
            selectedStatus = status;
            document.querySelectorAll('.status-btn').forEach(btn => {
                if(btn.dataset.status === status) {
                    btn.classList.add('bg-amber-600', 'text-white', 'border-transparent');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('bg-amber-600', 'text-white', 'border-transparent');
                    btn.classList.add('text-gray-500');
                }
            });
        };

        document.getElementById('page-slider').oninput = (e) => {
            document.getElementById('page-count-display').innerText = e.target.value;
        };

        document.getElementById('confirm-log').onclick = async () => {
            if(!currentModalContext) return;
            const newPages = parseInt(document.getElementById('page-slider').value);
            
            try {
                await setDoc(doc(db, `users/${currentUser.uid}/books`, currentModalContext.key), {
                    pagesRead: newPages,
                    status: selectedStatus,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                showToast(`Updated ${currentModalContext.title}`);
                document.getElementById('log-modal').classList.add('hidden');
                await loadBooks();
                
                // Refresh views
                if(document.getElementById('tab-content-dashboard').classList.contains('active')) renderDashboard();
                if(document.getElementById('tab-content-library').classList.contains('active')) renderLibrary();
                if(!document.getElementById('book-detail-modal').classList.contains('hidden')) renderBookDetail(currentModalContext.key);

            } catch(e) { console.error(e); showToast('Error saving', 'error'); }
        };

        window.deleteBook = async (key) => {
            if(!confirm("Are you sure you want to delete this book?")) return;
            // Implementation left as exercise or simple firestore delete
            // await deleteDoc(...) 
            showToast("Book deleted (simulation)", "info");
        };

        // --- Import Logic (Simplified for brevity) ---
        document.getElementById('csv-input').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            Papa.parse(file, {
                header: true,
                complete: async (results) => {
                    // Similar logic to previous, but using `booksCache` refresh
                    let count = 0;
                    const log = document.getElementById('import-log');
                    log.classList.remove('hidden');
                    log.innerHTML = 'Starting import...<br>';
                    
                    for(const row of results.data) {
                        if(!row.Title) continue;
                        const key = 'imp_' + btoa(unescape(encodeURIComponent(row.Title + row.Authors))).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                        const statusMap = { 'read': 'completed', 'currently-reading': 'reading', 'to-read': 'tbr' };
                        
                        await setDoc(doc(db, `users/${currentUser.uid}/books`, key), {
                            key,
                            title: row.Title,
                            author: row.Authors,
                            status: statusMap[row['Read Status']] || 'tbr',
                            cover: PLACEHOLDER_IMG,
                            pagesRead: 0,
                            totalPages: row['Number of Pages'] ? parseInt(row['Number of Pages']) : 300,
                            imported: true
                        }, { merge: true });
                        count++;
                    }
                    log.innerHTML += `<span class="text-green-500">Done! Imported ${count} books.</span>`;
                    await loadBooks();
                }
            });
        };

    </script>
</body>
</html>