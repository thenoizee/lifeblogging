<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Lifeblogging Hub</title>
    <link rel="icon" href="/favicons/house.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json" />
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: white;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --timeline-line: #e5e7eb;
        }
        .dark {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --timeline-line: #374151;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .dashboard-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        .card-header {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 20px; }
        
        /* Mood Animation */
        .mood-face-large {
            font-size: 5rem;
            transition: transform 0.2s;
        }
        .mood-face-large:hover { transform: scale(1.1) rotate(5deg); }

        /* Timeline Specifics */
        .timeline-item:first-child .line-left { display: none; }
        .timeline-item:last-child .line-right { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <span id="greeting-text">Dashboard</span>
                </h1>
                <p class="text-xs text-[var(--text-secondary)]" id="current-date">Loading...</p>
            </div>
            <div class="flex gap-2">
                <button id="refresh-btn" class="p-2 rounded-full bg-[var(--card-bg)] border border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 transition text-sm"><i class="fas fa-sync-alt"></i></button>
                <button id="theme-toggle" class="p-2 rounded-full bg-[var(--card-bg)] border border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 transition text-sm"><i class="fas fa-moon"></i></button>
                <div id="auth-container" class="hidden">
                    <a href="/account" class="p-2 px-3 rounded-lg bg-indigo-600 text-white font-bold text-xs hover:bg-indigo-700 transition">Account</a>
                </div>
            </div>
        </div>

        <div id="login-prompt" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold mb-4">Welcome Back</h2>
            <p class="mb-6 text-[var(--text-secondary)]">Please log in to view your personal dashboard.</p>
            <a href="/index.html" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Go to Login</a>
        </div>

        <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-4 gap-4 hidden">
            
            <div class="dashboard-card md:col-span-2">
                <div class="card-header">
                    <span>Daily Mood</span>
                    <a href="/log" class="text-xs text-indigo-500 hover:underline">Logger</a>
                </div>
                <div class="flex-grow flex items-center justify-center gap-6">
                    <div id="mood-display" class="mood-face-large text-gray-300"><i class="fas fa-meh"></i></div>
                    <div class="flex flex-col justify-center">
                        <p id="mood-text" class="font-bold text-3xl text-[var(--text-primary)]">No data</p>
                        <p id="mood-time" class="text-sm text-[var(--text-secondary)] mt-1 opacity-0">...</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1">
                <div class="card-header">
                    <span>Water</span>
                    <a href="/hydrationtrackr" class="text-xs text-blue-500 hover:underline">HydrationTrackr</a>
                </div>
                <div class="flex-grow flex flex-col items-center justify-center -mt-2">
                    <div class="relative w-24 h-24">
                        <canvas id="water-chart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="water-value" class="text-lg font-bold">0</span>
                            <span class="text-[10px] text-[var(--text-secondary)]">ml</span>
                        </div>
                    </div>
                    <p id="water-goal-text" class="text-[10px] text-[var(--text-secondary)] mt-2">Goal: 2000ml</p>
                </div>
            </div>

            <div class="dashboard-card col-span-1">
                <div class="card-header">
                    <span>Calories</span>
                    <a href="/foodtrackr" class="text-xs text-orange-500 hover:underline">FoodTrackr</a>
                </div>
                <div class="flex flex-col h-full justify-between">
                    <div class="text-center mb-2">
                        <span id="calories-val" class="text-3xl font-bold text-orange-500">0</span>
                        <span class="text-xs text-[var(--text-secondary)]">kcal</span>
                    </div>
                    <div class="space-y-1 text-[10px] text-[var(--text-secondary)]">
                        <div class="flex justify-between border-b border-[var(--border-color)] pb-1">
                            <span>Breakfast</span><span id="cal-breakfast" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                        <div class="flex justify-between border-b border-[var(--border-color)] pb-1">
                            <span>Lunch</span><span id="cal-lunch" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                        <div class="flex justify-between border-b border-[var(--border-color)] pb-1">
                            <span>Dinner</span><span id="cal-dinner" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Snack</span><span id="cal-snacks" class="font-mono text-[var(--text-primary)]">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card col-span-1">
                <div class="card-header">
                    <span>Meds</span>
                    <a href="/medimanagr" class="text-xs text-pink-500 hover:underline">MediManagr</a>
                </div>
                <div id="meds-list" class="flex-grow custom-scroll overflow-y-auto space-y-2 pr-1 max-h-[140px]">
                    <p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">Loading schedule...</p>
                </div>
            </div>

            <div class="dashboard-card col-span-1">
                <div class="card-header">
                    <span>Listening</span>
                    <a href="/podtrackr" class="text-xs text-purple-500 hover:underline">PodTrackr</a>
                </div>
                <div id="podcast-container" class="flex flex-col items-center text-center h-full justify-center">
                    <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-md mb-2 animate-pulse"></div>
                    <div class="w-full">
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mx-auto mb-1 animate-pulse"></div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mx-auto animate-pulse"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                <div class="card-header">
                    <span>Last Watched</span>
                    <a href="/vidtrackr" class="text-xs text-red-500 hover:underline">VidTrackr</a>
                </div>
                <div id="video-container" class="flex items-center gap-4 h-full">
                    <div class="w-28 h-16 bg-gray-200 dark:bg-gray-700 rounded-md flex-shrink-0 animate-pulse"></div>
                    <div class="flex-grow min-w-0">
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2 animate-pulse"></div>
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2 animate-pulse"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                <div class="card-header">
                    <span>Recent Activity</span>
                    <a href="/log" class="text-xs text-green-500 hover:underline">Logger</a>
                </div>
                <div id="last-log-container" class="flex overflow-x-auto pb-4 custom-scroll items-center h-full px-2">
                    <p class="text-sm text-[var(--text-secondary)] italic w-full text-center">Loading logs...</p>
                </div>
            </div>

            <div class="dashboard-card md:col-span-2">
                <div class="card-header">
                    <span>Dailies Progress</span>
                    <span id="dailies-progress-text" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full dark:bg-green-900 dark:text-green-200">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 mb-4">
                    <div id="dailies-progress-bar" class="bg-green-600 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div id="dailies-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 custom-scroll overflow-y-auto max-h-[150px] pr-1">
                    </div>
            </div>

        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, onSnapshot, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants
        const TRAKT_CLIENT_ID = '46c509e2cef42228978ae6a69b138628a6399c0bf28b729b7883b19ab9b082eb';
        const TRAKT_API_URL = 'https://api.trakt.tv';

        const firebaseConfig = {
            apiKey: "AIzaSyBL_FesZhiD3JQH8ftmDgTS8HBdVPL1cj8",
            authDomain: "sammy-7298f.firebaseapp.com",
            projectId: "sammy-7298f",
            storageBucket: "sammy-7298f.appspot.com",
            messagingSenderId: "963185683535",
            appId: "1:963185683535:web:807df8941feba46c208e3a",
            measurementId: "G-JT1YF2ELN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let unsubscribers = [];

        // --- UI References ---
        const ui = {
            grid: document.getElementById('dashboard-grid'),
            loginPrompt: document.getElementById('login-prompt'),
            authContainer: document.getElementById('auth-container'),
            date: document.getElementById('current-date'),
            greeting: document.getElementById('greeting-text'),
            moodDisplay: document.getElementById('mood-display'),
            moodText: document.getElementById('mood-text'),
            moodTime: document.getElementById('mood-time'),
            podcastContainer: document.getElementById('podcast-container'),
            videoContainer: document.getElementById('video-container'),
            calVal: document.getElementById('calories-val'),
            calBreakdown: {
                breakfast: document.getElementById('cal-breakfast'),
                lunch: document.getElementById('cal-lunch'),
                dinner: document.getElementById('cal-dinner'),
                snacks: document.getElementById('cal-snacks')
            },
            medsList: document.getElementById('meds-list'),
            lastLogContainer: document.getElementById('last-log-container'),
            dailiesGrid: document.getElementById('dailies-grid'),
            dailiesProgText: document.getElementById('dailies-progress-text'),
            dailiesProgBar: document.getElementById('dailies-progress-bar'),
            waterVal: document.getElementById('water-value'),
            waterGoalText: document.getElementById('water-goal-text')
        };

        // --- Shared Data State ---
        let state = {
            dailyLogs: [],
            manualLogs: [],
            dailyPlan: [],
            todayDoses: [], // Changed from Set to Array to hold full dose objects
            medsSchedule: []
        };

        // --- Theme Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        };
        themeToggle.addEventListener('click', async () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            if (currentUser) {
                await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'theme'), { theme: newTheme }, { merge: true });
            } else {
                localStorage.setItem('theme', newTheme);
            }
        });

        // --- Render Functions ---

        const renderLogsAndMood = () => {
            const allLogs = [...state.dailyLogs, ...state.manualLogs];
            allLogs.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // 1. Timeline Render (Top 12)
            const topLogs = allLogs.slice(0, 12);
            ui.lastLogContainer.innerHTML = '';
            
            if (topLogs.length === 0) {
                ui.lastLogContainer.innerHTML = '<p class="text-sm text-[var(--text-secondary)] italic w-full text-center">Nothing logged yet.</p>';
            } else {
                topLogs.forEach((log, index) => {
                    const timeStr = new Date(log.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    let iconClass = 'fa-circle-dot'; 
                    let colorClass = 'text-gray-500 border-gray-300';
                    const name = log.attributeName.toLowerCase();
                    
                    if (name.includes('mood')) {
                        // NEW: Specific Mood Logic for Timeline
                        const val = parseInt(log.attributeValue);
                        if(val === 1) { iconClass = 'fa-angry'; colorClass = 'text-red-500 border-red-500'; }
                        else if(val === 2) { iconClass = 'fa-frown'; colorClass = 'text-orange-500 border-orange-500'; }
                        else if(val === 3) { iconClass = 'fa-meh'; colorClass = 'text-yellow-500 border-yellow-500'; }
                        else if(val === 4) { iconClass = 'fa-smile'; colorClass = 'text-green-500 border-green-500'; }
                        else if(val === 5) { iconClass = 'fa-laugh-beam'; colorClass = 'text-green-600 border-green-600'; }
                        else { iconClass = 'fa-face-smile'; colorClass = 'text-gray-400 border-gray-400'; } // Fallback
                    }
                    else if (name.includes('water')) { iconClass = 'fa-glass-water'; colorClass = 'text-blue-500 border-blue-500'; }
                    else if (name.includes('run') || name.includes('walk') || name.includes('steps')) { iconClass = 'fa-person-running'; colorClass = 'text-green-500 border-green-500'; }
                    else if (name.includes('code') || name.includes('dev')) { iconClass = 'fa-code'; colorClass = 'text-indigo-500 border-indigo-500'; }
                    else if (name.includes('read') || name.includes('book')) { iconClass = 'fa-book-open'; colorClass = 'text-purple-500 border-purple-500'; }
                    else if (name.includes('sleep')) { iconClass = 'fa-bed'; colorClass = 'text-blue-300 border-blue-300'; }
                    else if (name.includes('food') || name.includes('meal')) { iconClass = 'fa-utensils'; colorClass = 'text-orange-500 border-orange-500'; }
                    
                    const div = document.createElement('div');
                    div.className = 'timeline-item flex-shrink-0 flex flex-col items-center w-24 relative group';
                    div.innerHTML = `
                        <div class="line-left absolute top-[26px] left-0 w-1/2 h-0.5 bg-[var(--timeline-line)]"></div>
                        <div class="line-right absolute top-[26px] right-0 w-1/2 h-0.5 bg-[var(--timeline-line)]"></div>
                        
                        <span class="text-[10px] text-[var(--text-secondary)] mb-1 font-mono">${timeStr}</span>
                        
                        <div class="w-8 h-8 rounded-full bg-[var(--card-bg)] border-2 ${colorClass} z-10 flex items-center justify-center text-xs shadow-sm">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        
                        <div class="mt-2 text-center w-full px-1">
                            <p class="font-bold text-[10px] truncate w-full" title="${log.attributeName}">${log.attributeName}</p>
                            <p class="text-[9px] text-[var(--text-secondary)] truncate w-full opacity-80" title="${log.attributeValue}">${log.attributeValue}</p>
                        </div>
                    `;
                    ui.lastLogContainer.appendChild(div);
                });
            }

            // 2. Mood Render
            const todayStr = new Date().toISOString().split('T')[0];
            const todaysMoodLog = allLogs.find(d => d.attributeName.toLowerCase() === 'mood' && d.date.startsWith(todayStr));

            if (todaysMoodLog) {
                const val = parseInt(todaysMoodLog.attributeValue);
                const moods = {1: ['fa-angry', 'text-red-500', 'Awful'], 2: ['fa-frown', 'text-orange-500', 'Bad'], 3: ['fa-meh', 'text-yellow-500', 'Okay'], 4: ['fa-smile', 'text-green-500', 'Good'], 5: ['fa-laugh-beam', 'text-green-600', 'Great']};
                const m = moods[val] || ['fa-question', 'text-gray-400', 'Unknown'];
                ui.moodDisplay.innerHTML = `<i class="fas ${m[0]} ${m[1]}"></i>`;
                ui.moodText.textContent = m[2];
                ui.moodTime.textContent = new Date(todaysMoodLog.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                ui.moodTime.classList.remove('opacity-0');
            } else {
                 ui.moodDisplay.innerHTML = `<i class="fas fa-meh text-gray-300"></i>`;
                 ui.moodText.textContent = "No data";
                 ui.moodTime.classList.add('opacity-0');
            }
        };

        const renderDailies = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            const counts = {};
            state.dailyLogs.forEach(d => {
                if(d.date.startsWith(todayStr)) {
                    counts[d.attributeName] = (counts[d.attributeName] || 0) + 1;
                }
            });

            ui.dailiesGrid.innerHTML = '';
            let totalTasks = 0;
            let completedTasks = 0;

            state.dailyPlan.forEach(task => {
                totalTasks++;
                const current = counts[task.attributeName] || 0;
                const target = parseInt(task.count) || 1;
                const isDone = current >= target;
                if (isDone) completedTasks++;

                const div = document.createElement('div');
                div.className = `p-2 rounded-lg border flex flex-col justify-center ${isDone ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' : 'bg-[var(--bg-color)] border-transparent'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-[10px] truncate max-w-[80%]" title="${task.attributeName}">${task.attributeName}</span>
                        <i class="fas ${isDone ? 'fa-check-circle text-green-500 text-[10px]' : 'fa-circle text-gray-300 text-[10px]'}"></i>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1 dark:bg-gray-700">
                        <div class="bg-indigo-500 h-1 rounded-full transition-all duration-500" style="width: ${(Math.min(current, target)/target)*100}%"></div>
                    </div>
                `;
                ui.dailiesGrid.appendChild(div);
            });

            const prog = totalTasks > 0 ? Math.round((completedTasks/totalTasks)*100) : 0;
            ui.dailiesProgText.textContent = `${prog}%`;
            ui.dailiesProgBar.style.width = `${prog}%`;
        };

        // --- UPDATED MEDS RENDERER ---
        const renderMeds = () => {
            const dayName = new Date().toLocaleDateString('en-US', {weekday: 'long'});
            ui.medsList.innerHTML = '';
            
            // 1. Build list of all scheduled doses for today
            let scheduledDoses = [];
            
            state.medsSchedule.forEach(med => {
                if (med.isArchived) return;
                
                if (med.schedule && med.schedule.days.includes(dayName)) {
                    // Split times (e.g., "08:00, 14:00")
                    const times = med.schedule.times.split(',').map(t => t.trim()).filter(Boolean);
                    
                    times.forEach(time => {
                        scheduledDoses.push({
                            medId: med.id,
                            name: med.name,
                            icon: med.icon || 'fas fa-pills',
                            color: med.color || '#666',
                            time: time,
                            status: 'pending' // Default status
                        });
                    });
                }
            });

            // 2. Match logged doses to scheduled items
            // We use a copy of todayDoses so we can consume them
            let availableLogs = [...state.todayDoses];
            
            // Sort scheduled doses by time
            scheduledDoses.sort((a, b) => a.time.localeCompare(b.time));

            scheduledDoses.forEach(doseItem => {
                // Find a taken log for this med
                const logIndex = availableLogs.findIndex(log => log.medId === doseItem.medId && log.status === 'taken');
                
                if (logIndex !== -1) {
                    doseItem.status = 'taken';
                    availableLogs.splice(logIndex, 1); // Consume log so it doesn't count for next dose of same med
                }
            });

            // 3. Render
            if (scheduledDoses.length === 0) {
                ui.medsList.innerHTML = `<p class="text-xs text-[var(--text-secondary)] italic text-center mt-4">No meds scheduled for today.</p>`;
            } else {
                scheduledDoses.forEach(dose => {
                    const isTaken = dose.status === 'taken';
                    const div = document.createElement('div');
                    div.className = `flex justify-between items-center p-2 rounded-lg text-xs ${isTaken ? 'bg-green-50 dark:bg-green-900/20' : 'bg-gray-50 dark:bg-gray-800'}`;
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-[var(--text-secondary)] w-10 text-right">${dose.time}</span>
                            <div class="flex items-center gap-2">
                                <i class="${dose.icon}" style="color: ${dose.color}"></i>
                                <span class="${isTaken ? 'line-through opacity-60' : 'font-medium'} truncate max-w-[90px]">${dose.name}</span>
                            </div>
                        </div>
                        <i class="fas ${isTaken ? 'fa-check text-green-500' : 'fa-hourglass-half text-gray-300'}"></i>
                    `;
                    ui.medsList.appendChild(div);
                });
            }
        };

        // --- VidTrackr & PodTrackr ---
        async function fetchTraktHistory(accessToken) {
            try {
                const response = await fetch(`${TRAKT_API_URL}/sync/history?limit=1&extended=images`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'trakt-api-version': '2',
                        'trakt-api-key': TRAKT_CLIENT_ID,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                // NEW: Handle 401 specifically
                if (response.status === 401) {
                    ui.videoContainer.innerHTML = `
                        <div class="w-full text-center flex flex-col justify-center h-full">
                            <p class="text-xs text-red-500 font-bold mb-1">Session Expired</p>
                            <a href="/vidtrackr" class="text-[10px] text-[var(--text-secondary)] underline hover:text-[var(--text-primary)]">Reconnect VidTrackr</a>
                        </div>
                    `;
                    return;
                }
                
                if (!response.ok) throw new Error('Failed to fetch Trakt history');
                const data = await response.json();
                
                if (data.length > 0) {
                    const item = data[0];
                    const type = item.type;
                    const media = item[type];
                    
                    // --- REFINED IMAGE LOGIC (Matches VidTrackr Page) ---
                    const get = (path, obj) => path.split('.').reduce((acc, part) => acc && acc[part], obj);

                    let img = 'https://placehold.co/400x600/1f2937/FFF?text=No+Image';

                    if (type === 'episode') {
                         img = get('images.screenshot.medium', media) || 
                               get('images.screenshot.full', media) || 
                               get('images.fanart.medium', item.show) || 
                               get('images.fanart.full', item.show) || 
                               img;
                    } else if (type === 'movie') {
                         img = get('images.fanart.medium', media) || 
                               get('images.fanart.full', media) || 
                               img;
                    }
                    
                    if (img.includes('placehold.co') || !img) {
                         if (type === 'episode' && item.show) {
                            img = get('images.poster.medium', item.show) || get('images.poster.full', item.show) || img;
                         } else {
                            img = get('images.poster.medium', media) || get('images.poster.full', media) || img;
                         }
                    }

                    const title = type === 'episode' ? `${item.show.title}` : media.title;
                    const subtitle = type === 'episode' ? `S${item.episode.season}E${item.episode.number}: ${item.episode.title}` : (media.year || 'Movie');

                    ui.videoContainer.innerHTML = `
                        <img src="${img}" class="w-28 h-16 rounded-md object-cover shadow-sm bg-gray-800">
                        <div class="min-w-0 flex-grow">
                            <p class="font-bold truncate text-base">${title}</p>
                            <p class="text-xs text-[var(--text-secondary)] truncate">${subtitle}</p>
                            <p class="text-[10px] text-[var(--text-secondary)] mt-2 flex items-center gap-1">
                                <i class="fas fa-check text-green-500"></i> ${new Date(item.watched_at).toLocaleDateString()}
                            </p>
                        </div>
                    `;
                } else {
                    ui.videoContainer.innerHTML = `<div class="w-full text-center text-[var(--text-secondary)] italic text-sm">No watch history found.</div>`;
                }
            } catch (err) {
                console.error(err);
                ui.videoContainer.innerHTML = `<div class="w-full text-center text-red-400 italic text-xs">Failed to load.</div>`;
            }
        }

        // --- Real-time Listeners ---

        const setupListeners = (uid) => {
            const start = new Date(); start.setHours(0, 0, 0, 0);
            const end = new Date(); end.setHours(23, 59, 59, 999);
            const startTs = Timestamp.fromDate(start);
            const endTs = Timestamp.fromDate(end);
            const todayStr = start.toISOString().split('T')[0];

            // 1. Logs
            const dailiesQ = query(collection(db, `users/${uid}/sources/dailies/data`), orderBy('date', 'desc'), limit(20));
            unsubscribers.push(onSnapshot(dailiesQ, (snap) => {
                state.dailyLogs = snap.docs.map(d => d.data());
                renderLogsAndMood();
                renderDailies(); 
            }));

            const manualQ = query(collection(db, `users/${uid}/sources/manual/data`), orderBy('date', 'desc'), limit(20));
            unsubscribers.push(onSnapshot(manualQ, (snap) => {
                state.manualLogs = snap.docs.map(d => d.data());
                renderLogsAndMood();
            }));

            // 2. Hydration
            const hydroQ = query(collection(db, `users/${uid}/hydrationtrackr`), where('date', '>=', startTs), where('date', '<=', endTs));
            unsubscribers.push(onSnapshot(hydroQ, async (snap) => {
                let waterTotal = 0;
                snap.forEach(doc => waterTotal += parseInt(doc.data().attributeValue || doc.data().amount || 0));
                
                let waterGoal = 2000;
                const s = await getDoc(doc(db, `users/${uid}/settings/water`));
                if(s.exists()) waterGoal = s.data().dailyGoal || 2000;

                ui.waterVal.textContent = waterTotal;
                ui.waterGoalText.textContent = `Goal: ${waterGoal}ml`;
                updateWaterChart(waterTotal, waterGoal);
            }));

            // 3. Podcast
            const podQ = query(collection(db, `users/${uid}/history`), orderBy('listenedAt', 'desc'), limit(1));
            unsubscribers.push(onSnapshot(podQ, (snap) => {
                if (!snap.empty) {
                    const pod = snap.docs[0].data();
                    ui.podcastContainer.innerHTML = `
                        <img src="${pod.podcastArtwork}" class="w-12 h-12 rounded-md object-cover shadow-sm bg-gray-100 mb-2">
                        <p class="font-bold truncate w-full text-xs">${pod.episodeTitle}</p>
                        <p class="text-[10px] text-[var(--text-secondary)] truncate w-full">${pod.podcastTitle}</p>
                    `;
                }
            }));

            // 4. Food
            const foodQ = query(collection(db, `users/${uid}/foodLog`), orderBy('eatenAt', 'desc'));
            unsubscribers.push(onSnapshot(foodQ, (snap) => {
                let cals = { total: 0, breakfast: 0, lunch: 0, dinner: 0, other: 0 };
                snap.forEach(d => {
                    const data = d.data();
                    const date = data.eatenAt.toDate();
                    if (date >= start && date <= end) {
                        const val = data.calories || 0;
                        cals.total += val;
                        const sec = (data.section || '').toLowerCase();
                        if (sec.includes('breakfast') || sec.includes('brunch')) cals.breakfast += val;
                        else if (sec.includes('lunch')) cals.lunch += val;
                        else if (sec.includes('dinner')) cals.dinner += val;
                        else cals.other += val;
                    }
                });
                ui.calVal.textContent = Math.round(cals.total);
                ui.calBreakdown.breakfast.textContent = Math.round(cals.breakfast);
                ui.calBreakdown.lunch.textContent = Math.round(cals.lunch);
                ui.calBreakdown.dinner.textContent = Math.round(cals.dinner);
                ui.calBreakdown.snacks.textContent = Math.round(cals.other);
            }));

            // 5. Plans & Meds
            unsubscribers.push(onSnapshot(doc(db, `users/${uid}/settings/dailyPlan`), (snap) => {
                state.dailyPlan = snap.exists() ? (snap.data().dailyLogs || []) : [];
                renderDailies();
            }));

            unsubscribers.push(onSnapshot(collection(db, `users/${uid}/medications`), (snap) => {
                state.medsSchedule = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMeds();
            }));

            const dosesQ = query(collection(db, `users/${uid}/doses`), where('date', '>=', todayStr));
            unsubscribers.push(onSnapshot(dosesQ, (snap) => {
                state.todayDoses = []; // Reset array
                snap.forEach(d => {
                    const data = d.data();
                    if (data.date.startsWith(todayStr)) {
                        state.todayDoses.push({id: d.id, ...data});
                    }
                });
                renderMeds();
            }));
        };

        const cleanupListeners = () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        };

        let waterChartInstance = null;
        function updateWaterChart(current, goal) {
            const ctx = document.getElementById('water-chart').getContext('2d');
            if (waterChartInstance) waterChartInstance.destroy();
            
            waterChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Drank', 'Remaining'],
                    datasets: [{
                        data: [current, Math.max(0, goal - current)],
                        backgroundColor: ['#3b82f6', '#e5e7eb'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        const refreshBtn = document.getElementById('refresh-btn');
        if(refreshBtn) refreshBtn.style.display = 'none'; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                ui.loginPrompt.classList.add('hidden');
                ui.grid.classList.remove('hidden');
                ui.authContainer.classList.remove('hidden');
                ui.greeting.textContent = `Hello, ${user.email.split('@')[0]}!`;
                ui.date.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                getDoc(doc(db, 'users', user.uid, 'settings', 'theme')).then(snap => {
                    applyTheme(snap.exists() ? snap.data().theme : 'light');
                });

                getDoc(doc(db, 'users', user.uid, 'services', 'trakt')).then(snap => {
                    if (snap.exists() && snap.data().accessToken) {
                        fetchTraktHistory(snap.data().accessToken);
                    } else {
                        ui.videoContainer.innerHTML = `<div class="w-full text-center text-sm text-[var(--text-secondary)]">VidTrackr not connected.</div>`;
                    }
                });

                setupListeners(user.uid);
            } else {
                currentUser = null;
                cleanupListeners();
                ui.loginPrompt.classList.remove('hidden');
                ui.grid.classList.add('hidden');
                ui.authContainer.classList.add('hidden');
            }
        });
    </script>

</body>
</html>